<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
<script>
    (function() {
      var isFile = location.protocol === 'file:' || location.origin === 'null';
      if (!isFile) return;
      try {
        console.warn('ğŸš« æ£€æµ‹åˆ°file://åè®®ï¼Œå·²é˜»æ­¢');
      } catch (e) {}
      var html = '<!doctype html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>æ— æ³•ç¦»çº¿ä½¿ç”¨</title><style>body{margin:0;font-family:-apple-system,'Helvetica Neue','PingFang SC','Segoe UI',sans-serif;background:#f5f6f8;color:#111;} .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:32px;} .card{max-width:560px;background:#fff;border:1px solid #e6e8ec;border-radius:16px;box-shadow:0 20px 40px rgba(0,0,0,.08);padding:28px;} h1{font-size:20px;margin:0 0 12px;} p{margin:0 0 16px;color:#444;line-height:1.6;} a{display:inline-block;background:#1a8cff;color:#fff;text-decoration:none;padding:10px 16px;border-radius:10px;font-weight:600;}</style></head><body><div class="wrap"><div class="card"><h1>âš ï¸ æ— æ³•ç¦»çº¿ä½¿ç”¨</h1><p>ICè§†å¥å·¥å…·éœ€è¦åœ¨çº¿ä½¿ç”¨ä»¥éªŒè¯æˆæƒã€‚</p><p>è¯·è®¿é—®åœ¨çº¿ç‰ˆæœ¬ä»¥è·å¾—å®Œæ•´ä½“éªŒã€‚</p><a href="https://icstudio.club/tools/">è®¿é—®åœ¨çº¿ç‰ˆæœ¬ â†’</a></div></div></body></html>';
      document.open();
      document.write(html);
      document.close();
      throw new Error('file-protocol-blocked');
    })();
  </script>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    
    <link rel="icon" type="image/png" href="/tools/assets/icon/cognote.png?v=20260204">
    
    <link rel="shortcut icon" type="image/png" href="/tools/assets/icon/cognote.png?v=20260204">
<link rel="icon" type="image/svg+xml" href="/tools/assets/icon/cognote.svg?v=20260204">
    <link rel="apple-touch-icon" href="/tools/assets/icon/cognote.png?v=20260204">
<!-- Primary SEO Meta Tags -->
    <title>Chord Sight Reading Tool | Cognote - Harmony Training & Chord Recognition</title>
    <meta name="description" content="Professional chord sight reading and harmony training tool online. Practice chord recognition with triads, seventh chords, extended chords, and inversions. Features customizable range, multiple voicings, real-time piano audio playback, standard music notation. Free 20 trials. Perfect for pianists, guitarists, jazz musicians developing chord reading and harmony skills. | ä¸“ä¸šå’Œå¼¦è§†å¥ä¸å’Œå£°è®­ç»ƒå·¥å…·ï¼Œæ”¯æŒä¸‰å’Œå¼¦ã€ä¸ƒå’Œå¼¦ã€å»¶ä¼¸å’Œå¼¦ã€è½¬ä½ï¼Œè‡ªå®šä¹‰éŸ³åŸŸã€å¤šç§å’Œå¼¦é…ç½®ï¼Œå®æ—¶é’¢ç´éŸ³é¢‘ã€‚">
    <meta name="keywords" content="chord sight reading, chord recognition, harmony training, chord reading practice, jazz chords, chord inversions, seventh chords, extended chords, voicing practice, piano chords, guitar chords, music theory chords, chord identification, harmonic analysis, chord progression practice, free chord trainer, online chord tool, chord exercises, å’Œå¼¦è§†å¥, å’Œå¼¦è¯†åˆ«, å’Œå£°è®­ç»ƒ, ä¸ƒå’Œå¼¦, è½¬ä½å’Œå¼¦, çˆµå£«å’Œå¼¦, é’¢ç´å’Œå¼¦, å‰ä»–å’Œå¼¦, IC è§†å¥å·¥å…·, Cognote">
    <meta name="author" content="Igor Chen - Cognote">
    <link rel="canonical" href="https://icstudio.club/tools/chord-generator.html">

    <!-- Open Graph / Facebook / WeChat -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://icstudio.club/tools/chord-generator.html">
    <meta property="og:title" content="Chord Sight Reading Tool | Cognote">
    <meta property="og:description" content="Professional chord sight reading & harmony training tool. Practice chord recognition with triads, seventh chords, inversions. Piano audio playback. Free 20 trials. | ä¸“ä¸šå’Œå¼¦è§†å¥å·¥å…·ï¼Œä¸‰å’Œå¼¦ã€ä¸ƒå’Œå¼¦ã€è½¬ä½ï¼Œå®æ—¶éŸ³é¢‘ã€‚">
    <meta property="og:image" content="https://icstudio.club/images/ICLOGO.png">
    <meta property="og:image:alt" content="Cognote Chord Sight Reading Tool Interface">
    <meta property="og:site_name" content="Cognote">
    <meta property="og:locale" content="zh_CN">
    <meta property="og:locale:alternate" content="en_US">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://icstudio.club/tools/chord-generator.html">
    <meta name="twitter:title" content="Chord Sight Reading & Harmony Training Tool | Cognote">
    <meta name="twitter:description" content="Professional chord sight reading tool. Practice triads, seventh chords, inversions. Piano audio. Free 20 trials.">
    <meta name="twitter:image" content="https://icstudio.club/images/ICLOGO.png">

    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Cognote Chord Sight Reading Tool",
      "alternateName": ["IC è§†å¥å·¥å…·", "å’Œå¼¦è§†å¥å·¥å…·"],
      "description": "Professional online chord sight reading and harmony training tool for musicians. Practice chord recognition with triads, seventh chords, extended chords, and inversions. Features customizable pitch range, multiple voicings, real-time piano audio playback, and standard music notation rendering. Perfect for developing harmony reading skills.",
      "url": "https://icstudio.club/tools/chord-generator.html",
      "applicationCategory": "MusicApplication",
      "operatingSystem": "Web Browser",
      "browserRequirements": "Requires JavaScript. HTML5 compatible browser.",
      "offers": {
        "@type": "Offer",
        "price": "30",
        "priceCurrency": "EUR",
        "description": "Full version with unlimited access",
        "availability": "https://schema.org/InStock"
      },
      "featureList": [
        "Chord sight reading practice",
        "Triads (major, minor, augmented, diminished)",
        "Seventh chords (maj7, dom7, min7, half-dim, dim7)",
        "Extended chords (9th, 11th, 13th)",
        "Chord inversions (root position, 1st, 2nd, 3rd inversion)",
        "Customizable pitch range (C2-C7)",
        "Multiple voicing options",
        "Real-time piano audio playback",
        "Professional music notation rendering",
        "Grand staff notation",
        "Perfect for jazz harmony study",
        "Suitable for piano and guitar",
        "Free trial (20 uses)",
        "Downloadable chord sheets"
      ],
      "creator": {
        "@type": "Person",
        "name": "Igor Chen",
        "url": "https://icstudio.club"
      },
      "provider": {
        "@type": "Organization",
        "name": "Cognote",
        "url": "https://icstudio.club",
        "logo": "https://icstudio.club/images/ICLOGO.png",
        "sameAs": [
          "https://www.youtube.com/@ICStudio86",
          "https://space.bilibili.com/376362605"
        ]
      },
      "audience": {
        "@type": "EducationalAudience",
        "educationalRole": "music student, piano student, guitar student, jazz student, music theory student, music teacher, accompanist"
      },
      "inLanguage": ["zh-CN", "en-US"],
      "potentialAction": {
        "@type": "UseAction",
        "target": {
          "@type": "EntryPoint",
          "urlTemplate": "https://icstudio.club/tools/chord-generator.html"
        }
      }
    }
    </script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com/">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="">
    <link href="./IC å’Œå¼¦è§†å¥å·¥å…·_files/css2" rel="stylesheet">

    <!-- OpenSheetMusicDisplay -->
    <script src="./IC å’Œå¼¦è§†å¥å·¥å…·_files/opensheetmusicdisplay.min.js"></script>

    <!-- ğŸ¹ é’¢ç´éŸ³æ•°ç”Ÿæˆå¼•æ“ -->
    <script src="./IC å’Œå¼¦è§†å¥å·¥å…·_files/piano-note-count-engine.js"></script>

    <!-- åˆ é™¤SpessaSynth - æ”¹ç”¨æ›´ç®€å•çš„Web Audio APIæ–¹æ¡ˆ -->

    <link rel="stylesheet" href="./IC å’Œå¼¦è§†å¥å·¥å…·_files/apple-ui-styles-chord.css">
    <link rel="stylesheet" href="assets/css/midi-input.css">
    <script src="assets/js/sample-player.js?v=6"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function(){
        try {
          if (!window.__icSamplePlayer && window.ICSamplePlayer) {
            window.__icSamplePlayer = new ICSamplePlayer({ rootPath: 'assets/samples/piano-ogg-full' });
            window.__icSamplePlayer.load();
          }
        } catch(e) { console.warn('é‡‡æ ·å™¨åˆå§‹åŒ–å¤±è´¥:', e); }
      });
    </script>
    <script>
      document.addEventListener('DOMContentLoaded', function(){
        try {
          if (window.ReactGrab && typeof window.ReactGrab.init === 'function') {
            window.ReactGrab.init();
          }
          const api = window.ReactGrab && typeof window.ReactGrab.getGlobalApi === 'function'
            ? window.ReactGrab.getGlobalApi()
            : null;
          if (api) {
            window.addEventListener('keydown', function(event){
              if ((event.ctrlKey || event.metaKey) && event.shiftKey && (event.key === 'g' || event.key === 'G')) {
                api.toggle();
              }
            });
          }
        } catch(_) {}
      });
    </script>
    <link rel="stylesheet" href="./IC å’Œå¼¦è§†å¥å·¥å…·_files/chord-responsive-styles.css">

</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="header-text">
                    <h1 data-i18n="app.title">Cognote - å’Œå¼¦è§†å¥ç”Ÿæˆå™¨</h1>
                    <p data-i18n="app.subtitle">ä¸“ä¸šçº§ä¹è°±æ¸²æŸ“ä¸éŸ³ä¹ç†è®ºå·¥å…·</p>
                </div>
                <div class="header-controls">
                    <div class="function-selector">
                        <button class="function-btn" id="functionBtn" onclick="toggleFunctionSelector()">
                            ğŸ¹ <span id="currentFunction" data-i18n="app.chordMode">å’Œå¼¦è§†å¥</span>
                        </button>
                        <div class="function-menu" id="functionMenu">
                            <div class="function-option" onclick="switchFunction('melody')">
                                <span class="function-icon">ğŸµ</span>
                                <span data-i18n="app.melodyMode">æ—‹å¾‹è§†å¥</span>
                            </div>
                            <div class="function-option" onclick="switchFunction('jianpu')">
                                <span class="function-icon">ğŸ”¢</span>
                                <span data-i18n="app.jianpuMode">ç®€è°±è§†å¥</span>
                            </div>
                            <div class="function-option" onclick="switchFunction('interval')">
                                <span class="function-icon">ğŸ¼</span>
                                <span data-i18n="app.intervalMode">éŸ³ç¨‹è§†å¥</span>
                            </div>
                            <div class="function-option" onclick="switchFunction('chord')">
                                <span class="function-icon">ğŸ¹</span>
                                <span data-i18n="app.chordMode">å’Œå¼¦è§†å¥</span>
                            </div>
                            <div class="function-option" onclick="switchFunction('rhythm')">
                                <span class="function-icon">ğŸ¥</span>
                                <span data-i18n="app.rhythmMode">èŠ‚å¥è§†å¥</span>
                            </div>
                        </div>
                    </div>
                    <div class="settings-dropdown">
                        <button class="settings-btn" id="settingsBtn" onclick="toggleSettings()">
                            âš™ï¸ <span data-i18n="settings.title">è®¾ç½®</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="control-row">
                <div class="control-group">
                    <label data-i18n="controls.chordType">å’Œå¼¦ç±»å‹</label>
                    <button class="btn-secondary" onclick="openChordTypeSettings()" id="chordTypeSettingsBtn" data-i18n="controls.chordTypeSettings">å’Œå¼¦ç±»å‹è®¾ç½®</button>
                </div>

                <div class="control-group">
                    <label data-i18n="controls.harmonyMode">å’Œå£°æ¨¡å¼</label>
                    <div class="harmony-mode-toggle" style="display: flex; align-items: center; gap: 10px;">
                        <label class="switch" style="position: relative; display: inline-block; width: 60px; height: 34px;">
                            <input type="checkbox" id="functionalHarmonyToggle" onchange="toggleFunctionalHarmony()" style="opacity: 0; width: 0; height: 0;">
                            <span class="slider" style="position: absolute; cursor: pointer; inset: 0px; background-color: rgb(255, 149, 0); transition: 0.4s; border-radius: 34px;">
                                <span class="slider-button" style="position: absolute; content: &quot;&quot;; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: 0.4s; border-radius: 50%; transform: translateX(26px);"></span>
                            </span>
                        </label>
                        <span id="harmonyModeLabel" data-i18n="controls.randomMode" style="font-size: 14px; color: var(--text-color);">åŠŸèƒ½å’Œå£°</span>
                    </div>

                    <div class="instrument-mode-section" style="margin-top: 12px;">
                        <label data-i18n="controls.instrumentMode" style="display: block; margin-bottom: 6px; font-size: 14px; font-weight: 500;">ä¹å™¨æ¨¡å¼</label>
                        <div class="instrument-mode-toggle" style="display: flex; align-items: center; gap: 10px;">
                            <label class="switch" style="position: relative; display: inline-block; width: 60px; height: 34px;">
                                <input type="checkbox" id="instrumentModeToggle" onchange="toggleInstrumentMode()" style="opacity: 0; width: 0; height: 0;">
                                <span class="slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: 0.4s; border-radius: 34px;">
                                    <span class="slider-button" style="position: absolute; content: '' ; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: 0.4s; border-radius: 50%; transform: translateX(0px);"></span>
                                </span>
                            </label>
                            <span id="instrumentModeLabel" data-i18n="controls.guitarMode" style="font-size: 14px; color: var(--text-color);">å‰ä»–å’Œå£°</span>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <label data-i18n="controls.measures">å°èŠ‚æ•°</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="measures-2" name="measures" value="2">
                            <label for="measures-2" data-i18n="controls.measures2">2å°èŠ‚</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="measures-4" name="measures" value="4" checked="">
                            <label for="measures-4" data-i18n="controls.measures4">4å°èŠ‚</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="measures-8" name="measures" value="8">
                            <label for="measures-8" data-i18n="controls.measures8">8å°èŠ‚</label>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <label data-i18n="controls.key">è°ƒå·</label>
                    <button class="btn-secondary" onclick="openKeySignatureSettings()" id="keySettingsBtn" data-i18n="controls.KeySettings">è°ƒå·è®¾ç½®</button>
                </div>

                <div class="control-group" style="display: none;">
                    <label data-i18n="controls.time">æ‹å·</label>
                    <button class="btn-secondary" onclick="openTimeSignatureSettings()" id="timeSignatureSettingsBtn" data-i18n="controls.timeSettings">æ‹å·è®¾ç½®</button>
                </div>

                <!-- æ¨¡å¼åˆ‡æ¢ï¼ˆè‡ªç”±/æŒ‘æˆ˜ï¼‰ -->
                <div class="control-group">
                    <label data-i18n="controls.mode">æ¨¡å¼</label>
                    <div class="mode-toggle" style="display: flex; align-items: center; gap: 10px;">
                        <span id="modeLabelFree" data-i18n="mode.free" style="font-size: 14px; opacity: 0.8;">è‡ªç”±</span>
                        <label class="switch" style="position: relative; display: inline-block; width: 60px; height: 34px;">
                            <input type="checkbox" id="challengeModeToggle" style="opacity: 0; width: 0; height: 0;">
                            <span class="slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: 0.4s; border-radius: 34px;">
                                <span class="slider-button" style="position: absolute; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: 0.4s; border-radius: 50%; transform: translateX(0px);"></span>
                            </span>
                        </label>
                        <span id="modeLabelChallenge" data-i18n="mode.challenge" style="font-size: 14px; opacity: 0.8;">æŒ‘æˆ˜</span>
                    </div>
                </div>

                <!-- ğŸ”§ ç§»é™¤ (2025-10-02): é’¢ç´æ¨¡å¼ä¸éœ€è¦è°±å·è®¾ç½®æŒ‰é’®ï¼Œå›ºå®šä½¿ç”¨å¤§è°±è¡¨ -->
                <!-- <div class="control-group" id="clefControlGroup">
                    <label data-i18n="controls.clef">è°±å·</label>
                    <button class="btn-secondary" onclick="openClefSettings()" id="clefSettingsBtn" data-i18n="controls.clefSettings">
                        è°±å·è®¾ç½®
                    </button>
                </div> -->
            </div>

            <!-- æ–°å¢ï¼šéŸ³åŸŸè®¾ç½® -->
            <!-- ğŸ¸ å‰ä»–æ¨¡å¼éŸ³åŸŸè®¾ç½® -->
            <div id="guitarRangeSettings" style="display: block;">
            <div class="control-row">
                <div class="control-group">
                    <label for="rangeMin" data-i18n="controls.rangeMin">æœ€ä½éŸ³</label>
                    <select id="rangeMin">
                        <option value="33">A1</option>
                        <option value="35">B1</option>
                        <option value="36">C2</option>
                        <option value="38">D2</option>
                        <option value="40">E2</option>
                        <option value="41">F2</option>
                        <option value="43">G2</option>
                        <option value="45">A2</option>
                        <option value="47">B2</option>
                        <option value="48">C3</option>
                        <option value="50">D3</option>
                        <option value="52">E3</option>
                        <option value="53">F3</option>
                        <option value="55">G3</option>
                        <option value="57">A3</option>
                        <option value="59">B3</option>
                        <option value="60" selected="">C4</option>
                        <option value="62">D4</option>
                        <option value="64">E4</option>
                        <option value="65">F4</option>
                        <option value="67">G4</option>
                        <option value="69">A4</option>
                        <option value="71">B4</option>
                        <option value="72">C5</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="rangeMax" data-i18n="controls.rangeMax">æœ€é«˜éŸ³</label>
                    <select id="rangeMax">
                        <option value="48">C3</option>
                        <option value="50">D3</option>
                        <option value="52">E3</option>
                        <option value="53">F3</option>
                        <option value="55">G3</option>
                        <option value="57">A3</option>
                        <option value="59">B3</option>
                        <option value="60">C4</option>
                        <option value="62">D4</option>
                        <option value="64">E4</option>
                        <option value="65">F4</option>
                        <option value="67">G4</option>
                        <option value="69">A4</option>
                        <option value="71">B4</option>
                        <option value="72">C5</option>
                        <option value="74">D5</option>
                        <option value="76">E5</option>
                        <option value="77">F5</option>
                        <option value="79">G5</option>
                        <option value="81">A5</option>
                        <option value="82">B5</option>
                        <option value="83">C6</option>
                        <option value="84">D6</option>
                        <option value="88" selected="">E6</option>
                    </select>
                </div>

                <!-- ğŸ¼ æ˜¾ç¤ºæ§åˆ¶å¼€å…³ - ç´§å‡‘å¸ƒå±€ -->
                <!-- ğŸ¼ æ˜¾ç¤ºæ§åˆ¶å¼€å…³ - ç´§å‡‘å¸ƒå±€ï¼Œå‡å°‘é—´è· -->
                <div class="control-group" style="flex: none; width: 140px; margin-right: 4px;">
                    <label data-i18n="controls.staff">äº”çº¿è°±</label>
                    <div class="toggle-container">
                        <input type="checkbox" id="staffDisplayToggle" checked="" class="toggle-input">
                        <label for="staffDisplayToggle" class="toggle-slider">
                            <span class="toggle-button"></span>
                        </label>
                    </div>
                </div>

                <div class="control-group" style="flex: none; width: 140px; margin-right: 0px;">
                    <label data-i18n="controls.chordSymbols">å’Œå¼¦ä»£å·</label>
                    <div class="toggle-container">
                        <input type="checkbox" id="chordSymbolsToggle" checked="" class="toggle-input">
                        <label for="chordSymbolsToggle" class="toggle-slider">
                            <span class="toggle-button"></span>
                        </label>
                    </div>
                </div>

                <div class="control-group chord-jianpu-group" style="flex: none; width: 140px; margin-right: 0px; display: none;">
                    <label data-i18n="controls.jianpuChordSymbols">ç®€è°±ä»£å·</label>
                    <div class="toggle-container">
                        <input type="checkbox" id="chordJianpuToggle" class="toggle-input">
                        <label for="chordJianpuToggle" class="toggle-slider">
                            <span class="toggle-button"></span>
                        </label>
                    </div>
                </div>

                <div class="control-group metronome-group" style="flex: none; width: 160px;">
                    <div class="metronome-label-row">
                        <button class="metronome-settings-btn" id="metronomePatternBtn" onclick="openMetronomePatternSettings()" title="èŠ‚æ‹å™¨èŠ‚å¥è®¾ç½®" aria-label="èŠ‚æ‹å™¨èŠ‚å¥è®¾ç½®">
                            âš™ï¸
                        </button>
                        <label for="headerMetronomeBpm" data-i18n="controls.metronome">èŠ‚æ‹å™¨</label>
                    </div>
                    <div class="metronome-control">
                        <input type="number" id="headerMetronomeBpm" min="1" max="999" value="60" class="bpm-input-control">
                        <button class="metronome-play-btn" id="headerMetronomeBtn" onclick="toggleMetronome()" title="å¼€å§‹/åœæ­¢èŠ‚æ‹å™¨">
                            ğŸµ
                        </button>
                        <div class="metronome-beat-indicator" id="headerBeatIndicator"></div>
                    </div>
                </div>
            </div>
            </div>

            <!-- ğŸ¹ é’¢ç´æ¨¡å¼éŸ³åŸŸè®¾ç½® -->
            <div id="pianoRangeSettings" style="display: none;">
                <div class="control-row">
                    <div class="control-group">
                        <label data-i18n="piano.bassClefRange">ä½éŸ³è°±å·éŸ³åŸŸè®¾ç½®</label>
                        <button class="btn-secondary" onclick="openBassClefRangeModal()">
                            <span id="bassClefRangeDisplay">(E2-E4)</span>
                        </button>
                    </div>
                    <div class="control-group">
                        <label data-i18n="piano.trebleClefRange">é«˜éŸ³è°±å·éŸ³åŸŸè®¾ç½®</label>
                        <button class="btn-secondary" onclick="openTrebleClefRangeModal()">
                            <span id="trebleClefRangeDisplay">(C4-E6)</span>
                        </button>
                    </div>

                    <!-- ğŸ¼ æ˜¾ç¤ºæ§åˆ¶å¼€å…³ - ä¿æŒä¸å‰ä»–æ¨¡å¼ä¸€è‡´çš„å¸ƒå±€ -->
                    <div class="control-group" style="flex: none; width: 140px; margin-right: 4px;">
                        <label data-i18n="controls.staff">äº”çº¿è°±</label>
                        <div class="toggle-container">
                            <input type="checkbox" id="staffDisplayToggle" checked="" class="toggle-input">
                            <label for="staffDisplayToggle" class="toggle-slider">
                                <span class="toggle-button"></span>
                            </label>
                        </div>
                    </div>

                    <div class="control-group" style="flex: none; width: 140px; margin-right: 0px;">
                        <label data-i18n="controls.chordSymbols">å’Œå¼¦ä»£å·</label>
                        <div class="toggle-container">
                            <input type="checkbox" id="chordSymbolsToggle" checked="" class="toggle-input">
                            <label for="chordSymbolsToggle" class="toggle-slider">
                                <span class="toggle-button"></span>
                            </label>
                        </div>
                    </div>

                    <div class="control-group chord-jianpu-group" style="flex: none; width: 140px; margin-right: 0px; display: none;">
                        <label data-i18n="controls.jianpuChordSymbols">ç®€è°±ä»£å·</label>
                        <div class="toggle-container">
                            <input type="checkbox" id="chordJianpuToggle" class="toggle-input">
                            <label for="chordJianpuToggle" class="toggle-slider">
                                <span class="toggle-button"></span>
                            </label>
                        </div>
                    </div>

                    <div class="control-group metronome-group" style="flex: none; width: 160px;">
                        <div class="metronome-label-row">
                            <button class="metronome-settings-btn" id="metronomePatternBtn" onclick="openMetronomePatternSettings()" title="èŠ‚æ‹å™¨èŠ‚å¥è®¾ç½®" aria-label="èŠ‚æ‹å™¨èŠ‚å¥è®¾ç½®">
                                âš™ï¸
                            </button>
                            <label for="headerMetronomeBpm" data-i18n="controls.metronome">èŠ‚æ‹å™¨</label>
                        </div>
                        <div class="metronome-control">
                            <input type="number" id="headerMetronomeBpm" min="1" max="999" value="60" class="bpm-input-control">
                            <button class="metronome-play-btn" id="headerMetronomeBtn" onclick="toggleMetronome()" title="å¼€å§‹/åœæ­¢èŠ‚æ‹å™¨">
                                ğŸµ
                            </button>
                            <div class="metronome-beat-indicator" id="headerBeatIndicator"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="control-row">
                <div class="buttons">
                    <div id="challengeCountdownUI" style="display:none; align-items: center; gap:6px; margin-right:10px; padding:6px 10px; border:1px solid var(--border-color); border-radius:999px; background: var(--neutral-white); color: var(--text-color); font-size:14px; line-height:1;">
                        <span id="challengeCountdownLabel" data-i18n="challenge.preparingLabel" style="opacity:0.7;">å‡†å¤‡</span>
                        <strong id="challengeCountdownValue">10</strong>
                        <span data-i18n="challenge.seconds" style="opacity:0.7;">ç§’</span>
                    </div>
                    <button id="generateChordsBtn" class="btn-primary" data-i18n="controls.generate">ç”Ÿæˆå’Œå¼¦</button>
                    <div id="melody-counter-status"></div>
                    <div class="button-group">
                        <button class="btn-secondary" onclick="previousChords()" data-i18n="controls.previous">ä¸Šä¸€æ¡</button>
                        <button class="btn-secondary" onclick="nextChords()" data-i18n="controls.next">ä¸‹ä¸€æ¡</button>
                    </div>
                    <div class="button-group">
                        <button class="btn-secondary" id="playMelodyBtn" onclick="directPlayTest()" data-i18n="controls.play">æ’­æ”¾</button>
                        <button class="melody-visibility-btn" id="melodyVisibilityBtn" onclick="toggleMelodyVisibility()" title="éšè—/æ˜¾ç¤ºå’Œå¼¦">
                            ğŸ‘€
                        </button>
                        
                    </div>
                    <div class="button-group" style="display: none;">
                        <button class="btn-secondary" onclick="openRhythmSettings()" data-i18n="controls.rhythm">èŠ‚å¥è®¾ç½®</button>
                    </div>
                    <div class="practice-counter">
                        <label for="practiceCountValue" data-i18n="controls.practiceCounter">ç»ƒä¹ è®¡æ•°</label>
                        <div class="practice-counter-actions">
                            <span id="practiceCountValue">0</span>
                            <button class="btn-secondary" id="practiceCountBtn" onclick="incrementPracticeCount()" data-i18n="controls.practiceAdd">+</button>
                            <button class="btn-secondary" id="practiceResetBtn" onclick="decrementPracticeCount()" data-i18n="controls.practiceReset">-</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="score-container">
            <div id="score" title="ç‚¹å‡»ç”Ÿæˆæ–°å’Œå¼¦" style="cursor: pointer; position: relative;">
                <div class="empty-score-message">
                    <p data-i18n="score.empty">ç‚¹å‡»ç”Ÿæˆå’Œå¼¦å¼€å§‹ç»ƒä¹ </p>
                </div>
            </div>
        </div>

        <!-- åŠŸèƒ½åˆ†æé¢æ¿ -->
        <div class="analysis-panel" id="analysisPanel" style="display: none;">
            <div class="analysis-header">
                <h3>ğŸ¼ å’Œå¼¦åŠŸèƒ½åˆ†æ</h3>
                <button class="toggle-btn" onclick="toggleAnalysisPanel()">æ”¶èµ·</button>
            </div>
            <div class="analysis-content" id="analysisContent">
                <!-- åˆ†æå†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
            </div>
        </div>

        <!-- Copyright Information -->
        <div style="
            padding: 5px 0;
            text-align: center;
            font-size: 14px;
            color: var(--neutral-dark);
            opacity: 0.7;
            border-top: 1px solid var(--border-color);
            margin-top: 7.5px;
        ">
            <p style="margin: 0; line-height: 1.5;">
                <strong>Cognote</strong> - ä¸“ä¸šçº§å’Œå¼¦è§†å¥ç”Ÿæˆå™¨
            </p>
            <p style="margin: 8px 0 0 0; font-size: 13px; opacity: 0.8;">
                Copyright Â© 2025. All rights reserved. Igor Chen -
                <a href="https://icstudio.club/" target="_blank" style="color: var(--primary-orange); text-decoration: none;">icstudio.club</a>
            </p>
        </div>

    </div>

    <!-- å’Œå¼¦ç±»å‹è®¾ç½®å¼¹çª— -->
    <div id="settingsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="settings.title">è®¾ç½®</h3>
                <button class="close-btn" onclick="closeSettingsModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="settings-menu show" id="settingsMenu" style="position: static; opacity: 1; visibility: visible; transform: none; box-shadow: none; border: 0; min-width: 0; background: transparent;">
                    <!-- ä¸»é¢˜è®¾ç½® -->
                    <div class="settings-section">
                        <div class="settings-section-title" data-i18n="settings.theme">ä¸»é¢˜</div>
                        <div class="theme-options">
                            <div class="theme-option" onclick="setTheme('light')">
                                <span class="theme-icon">â˜€ï¸</span>
                                <span data-i18n="settings.lightMode">æµ…è‰²æ¨¡å¼</span>
                            </div>
                            <div class="theme-option" onclick="setTheme('dark')">
                                <span class="theme-icon">ğŸŒ™</span>
                                <span data-i18n="settings.darkMode">æ·±è‰²æ¨¡å¼</span>
                            </div>
                        </div>
                    </div>

                    <!-- è¯­è¨€è®¾ç½® -->
                    <div class="settings-section">
                        <div class="settings-section-title" data-i18n="settings.language">è¯­è¨€</div>
                        <div class="language-options">
                            <div class="language-option" onclick="switchLanguage('zh-CN')">
                                ç®€ä½“ä¸­æ–‡
                            </div>
                            <div class="language-option" onclick="switchLanguage('zh-TW')">
                                ç¹é«”ä¸­æ–‡
                            </div>
                            <div class="language-option" onclick="switchLanguage('en')">
                                English
                            </div>
                        </div>
                    </div>

                    <!-- MIDI è¾“å…¥ -->
                    <div class="settings-section" id="midiSettingsSection">
                        <div class="settings-section-title" data-i18n="settings.midi">MIDI è¾“å…¥</div>
                        <div class="midi-settings-row">
                            <span data-i18n="midi.enable">å¯ç”¨</span>
                            <label class="toggle-container">
                                <input type="checkbox" id="midiEnableToggle" class="toggle-input">
                                <span class="toggle-slider"><span class="toggle-button"></span></span>
                            </label>
                        </div>
                        <div class="midi-settings-row" style="flex-direction: column; align-items: stretch;">
                            <label for="midiDeviceSelect" data-i18n="midi.device">è®¾å¤‡</label>
                            <select id="midiDeviceSelect" class="midi-select" disabled>
                                <option value="">-</option>
                            </select>
                        </div>
                        <div class="midi-status" id="midiStatusText" data-i18n="midi.status.disabled">MIDI å·²å…³é—­</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="chordTypeModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="modal.chordType.title">å’Œå¼¦ç±»å‹è®¾ç½®</h3>
                <button class="close-btn" onclick="closeChordTypeSettings()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="chord-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="modal.chordType.triads">ä¸‰å’Œå¼¦</h4>
                        <button class="btn-select-all" onclick="selectAllBasicChords()" style="padding: 5px 10px; font-size: 12px; background: #FF9500; color: white; border: none; border-radius: 4px; cursor: pointer;" data-i18n="button.selectAll">å…¨é€‰</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="chord-major" value="major" checked="">
                            <span data-i18n="chord.major">å¤§ä¸‰å’Œå¼¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="chord-minor" value="minor" checked="">
                            <span data-i18n="chord.minor">å°ä¸‰å’Œå¼¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="chord-diminished" value="diminished">
                            <span data-i18n="chord.diminished">å‡ä¸‰å’Œå¼¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="chord-augmented" value="augmented">
                            <span data-i18n="chord.augmented">å¢ä¸‰å’Œå¼¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="chord-sus" value="sus">
                            <span data-i18n="chord.sus">æŒ‚å’Œå¼¦ (sus2/sus4)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="chord-triad-inversion" value="triad-inversion">
                            <span data-i18n="chord.triadInversion">åŒ…å«è½¬ä½</span>
                        </label>
                    </div>
                </div>

                <div class="chord-section" style="margin-top: 20px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="modal.chordType.seventhChords">ä¸ƒå’Œå¼¦</h4>
                        <button class="btn-select-all" onclick="selectAllSeventhChords()" style="padding: 5px 10px; font-size: 12px; background: #FF9500; color: white; border: none; border-radius: 4px; cursor: pointer;" data-i18n="button.selectAll">å…¨é€‰</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="chord-major7" value="major7">
                            <span data-i18n="chord.major7">å¤§ä¸ƒå’Œå¼¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="chord-minor7" value="minor7">
                            <span data-i18n="chord.minor7">å°ä¸ƒå’Œå¼¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="chord-dominant7" value="dominant7">
                            <span data-i18n="chord.dominant7">å±ä¸ƒå’Œå¼¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="chord-minor7b5" value="minor7b5">
                            <span data-i18n="chord.minor7b5">åŠå‡ä¸ƒå’Œå¼¦ (m7â™­5)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="chord-7sus" value="7sus">
                            <span data-i18n="chord.7sus">ä¸ƒæŒ‚å’Œå¼¦ (7sus2/7sus4)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="chord-seventh-inversion" value="seventh-inversion">
                            <span data-i18n="chord.seventhInversion">åŒ…å«è½¬ä½</span>
                        </label>
                    </div>
                </div>

                <!-- é«˜çº§è®¾ç½®åŒºåŸŸ -->
                <div id="chordAdvancedSettings" style="display: none; margin-top: 20px; padding: 20px; background: var(--info-bg); border-radius: 8px; border: 2px solid var(--info-border);">
                    <h4 style="margin-bottom: 15px; color: var(--heading-text);" data-i18n="modal.chordType.advancedSettings">é«˜çº§è®¾ç½®</h4>

                    <!-- ğŸ¸ å‰ä»–æ¨¡å¼é«˜çº§è®¾ç½® -->
                    <div id="guitarAdvancedSettings" style="display: block;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                            <h5 style="margin: 0; font-size: 14px; color: #666;" data-i18n="modal.chordType.voicingTypes">Voicing ç±»å‹é€‰æ‹©</h5>
                            <button class="btn-select-all" onclick="toggleSelectAllVoicings()" style="padding: 5px 10px; font-size: 12px; background: #FF9500; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                <span id="voicingSelectAllText" data-i18n="button.selectAll">å…¨é€‰</span>
                            </button>
                        </div>
                        <div class="checkbox-grid">
                            <label class="checkbox-item">
                                <input type="checkbox" id="voicing-close" value="close" checked="">
                                <span data-i18n="voicing.close">å¯†é›†æ’åˆ— (Close)</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="voicing-drop2" value="drop2">
                                <span data-i18n="voicing.drop2">Drop 2 Voicing</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="voicing-drop3" value="drop3">
                                <span data-i18n="voicing.drop3">Drop 3 Voicing</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="voicing-shell" value="shell">
                                <span data-i18n="voicing.shell">Shell Voicing</span>
                            </label>
                        </div>

                        <div class="voicing-info">
                            <h5 data-i18n="voicing.description.title">åŠŸèƒ½è¯´æ˜ï¼š</h5>
                            <ul>
                                <li><strong>Close Voicing:</strong> <span data-i18n="voicing.description.close">å’Œå¼¦å„éŸ³å°½é‡ç´§å¯†æ’åˆ—åœ¨ä¸€èµ·ã€éŸ³ç¨‹é—´è·è¾ƒå°çš„å’Œå£°é…ç½®ï¼ˆä¸‰éŸ³ï¼‰</span></li>
                                <li><strong>Drop 2:</strong> <span data-i18n="voicing.description.drop2">å°†å¯†é›†æ’åˆ—å’Œå£°çš„ç¬¬äºŒé«˜çš„éŸ³ç¬¦é™ä½ä¸€ä¸ªå…«åº¦ï¼ˆä¸‰éŸ³ï¼‰</span></li>
                                <li><strong>Drop 3:</strong> <span data-i18n="voicing.description.drop3">å°†å¯†é›†æ’åˆ—å’Œå£°çš„ç¬¬ä¸‰é«˜çš„éŸ³ç¬¦é™ä½ä¸€ä¸ªå…«åº¦ï¼ˆå››éŸ³ï¼‰</span></li>
                                <li><strong>Shell Voicing:</strong> <span data-i18n="voicing.description.shell">åªä¿ç•™å’Œå¼¦çš„ æ ¹éŸ³ã€ä¸‰åº¦ã€ä¸ƒåº¦ï¼ˆçœç•¥äº”åº¦ç­‰éŸ³ï¼‰çš„ç®€åŒ–å’Œå£°é…ç½®ï¼ˆä¸‰éŸ³ï¼‰</span></li>
                            </ul>
                        </div>
                    </div>

                    <!-- ğŸ¹ é’¢ç´æ¨¡å¼é«˜çº§è®¾ç½® -->
                    <div id="pianoAdvancedSettings" style="display: none;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                            <h5 style="margin: 0; font-size: 14px; color: #666;" data-i18n="modal.chordType.pianoNoteCount">å’Œå£°éŸ³æ•°é€‰æ‹©</h5>
                            <button class="btn-select-all" onclick="toggleSelectAllNoteCounts()" style="padding: 5px 10px; font-size: 12px; background: #FF9500; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                <span id="noteCountSelectAllText" data-i18n="button.selectAll">å…¨é€‰</span>
                            </button>
                        </div>
                        <!-- ğŸ”§ ä¿®å¤ (2025-10-01): ç§»é™¤2éŸ³ã€8éŸ³ã€9éŸ³ï¼Œåªä¿ç•™3-7éŸ³ -->
                        <div class="checkbox-grid">
                            <label class="checkbox-item">
                                <input type="checkbox" id="notecount-3" value="3">
                                <span data-i18n="piano.noteCount.3">3éŸ³</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="notecount-4" value="4" checked="">
                                <span data-i18n="piano.noteCount.4">4éŸ³</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="notecount-5" value="5">
                                <span data-i18n="piano.noteCount.5">5éŸ³</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="notecount-6" value="6">
                                <span data-i18n="piano.noteCount.6">6éŸ³</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="notecount-7" value="7">
                                <span data-i18n="piano.noteCount.7">7éŸ³</span>
                            </label>
                        </div>

                        <div class="voicing-info">
                            <h5 data-i18n="piano.noteCount.description.title">é’¢ç´æ¨¡å¼è¯´æ˜ï¼š</h5>
                            <ul>
                                <li data-i18n="piano.noteCount.description.bass">ä½éŸ³è°±å·ï¼šæœ€ä½éŸ³å§‹ç»ˆæ˜¯æ ¹éŸ³ï¼Œè½åœ¨ä½éŸ³è°±å·éŸ³åŸŸèŒƒå›´å†…</li>
                                <li data-i18n="piano.noteCount.description.treble">é«˜éŸ³è°±å·ï¼šå…¶ä½™éŸ³ç¬¦ï¼ˆè‡³å°‘2ä¸ªï¼‰æ”¾åœ¨é«˜éŸ³è°±å·éŸ³åŸŸï¼Œæ’åˆ—é¡ºåºéšæœº</li>
                                <li data-i18n="piano.noteCount.description.priority">ä¼˜å…ˆéŸ³ï¼šä¸‰éŸ³ã€ä¸ƒéŸ³ã€suséŸ³ã€tensionéŸ³ä¼˜å…ˆé€‰æ‹©ï¼ˆå°½é‡ä¸é‡å¤ï¼‰</li>
                                <li data-i18n="piano.noteCount.description.optional">å¯é€‰éŸ³ï¼šäº”éŸ³åœ¨éŸ³æ•°è¾ƒå¤šæ—¶åŠ å…¥ï¼Œæ ¹éŸ³å’Œäº”éŸ³å¯ä»¥é‡å¤</li>
                            </ul>
                        </div>

                        <!-- ğŸµ Tension Note å¼€å…³ (2025-10-01æ–°å¢) -->
                        <div style="margin-top: 15px;">
                            <label class="checkbox-item">
                                <input type="checkbox" id="tension-note-toggle" value="tension">
                                <span data-i18n="piano.tensionNote">ğŸµ Tension Note (åŠ è‰²éŸ³)</span>
                            </label>
                        </div>

                        <div class="voicing-info">
                            <p style="margin: 0; font-size: 12px; line-height: 1.5;">
                                åœ¨4-7éŸ³é…ç½®ä¸­æ™ºèƒ½æ·»åŠ 9thã€11thã€13thç­‰åŠ è‰²éŸ³<br>
                                <span style="opacity: 0.7;">åŸºäºçˆµå£«å’Œå£°ç†è®ºï¼Œé¿å…ç¦å¿ŒéŸ³/å†²çªéŸ³</span>
                            </p>
                        </div>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-secondary" onclick="toggleChordAdvancedSettings()" id="chordAdvancedBtn" data-i18n="button.advanced">é«˜çº§è®¾ç½®</button>
                    <button class="btn-primary" onclick="saveChordTypeSettings()" data-i18n="button.save">ä¿å­˜è®¾ç½®</button>
                    <button class="btn-secondary" onclick="closeChordTypeSettings()" data-i18n="button.cancel">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- èŠ‚å¥è®¾ç½®å¼¹çª— -->
    <div id="rhythmModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="modal.rhythm.title">èŠ‚å¥è®¾ç½®</h3>
                <button class="close-btn" onclick="closeRhythmSettings()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="modal.rhythm.basicUnit">åŸºæœ¬èŠ‚å¥å•ä½</h4>
                        <button class="btn-select-all" onclick="selectAllRhythms()" style="padding: 5px 10px; font-size: 12px; background: #FF9500; color: white; border: none; border-radius: 4px; cursor: pointer;" data-i18n="button.selectAll">å…¨é€‰</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="rhythm-whole" value="whole">
                            <span data-i18n="rhythm.whole">å…¨éŸ³ç¬¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="rhythm-half" value="half" checked="">
                            <span data-i18n="rhythm.half">äºŒåˆ†éŸ³ç¬¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="rhythm-quarter" value="quarter" checked="">
                            <span data-i18n="rhythm.quarter">å››åˆ†éŸ³ç¬¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="rhythm-eighth" value="eighth">
                            <span data-i18n="rhythm.eighth">å…«åˆ†éŸ³ç¬¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="rhythm-sixteenth" value="sixteenth">
                            <span data-i18n="rhythm.sixteenth">åå…­åˆ†éŸ³ç¬¦</span>
                        </label>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveRhythmSettings()" data-i18n="button.save">ä¿å­˜è®¾ç½®</button>
                    <button class="btn-secondary" onclick="closeRhythmSettings()" data-i18n="button.cancel">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>


    <!-- è°ƒå·è®¾ç½®å¼¹çª— -->
    <div id="keySignatureModal" class="modal" style="display: none;" onclick="if(event.target===this) saveKeySettings()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 data-i18n="modal.keySignature.title">è°ƒå·è®¾ç½®</h3>
                <button class="close-btn" onclick="closeKeySettings()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="key-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="modal.keySignature.major">å¤§è°ƒ (Major)</h4>
                        <button class="btn-select-all" onclick="selectAllMajorKeys()" style="padding: 5px 10px; font-size: 12px; background: #FF9500; color: white; border: none; border-radius: 4px; cursor: pointer;" data-i18n="button.selectAllMajor">å…¨é€‰</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-C-major" value="C-major" checked="">
                            <span data-i18n="key.C-major">C å¤§è°ƒ</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-G-major" value="G-major">
                            <span data-i18n="key.G-major">G å¤§è°ƒ (1#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-D-major" value="D-major">
                            <span data-i18n="key.D-major">D å¤§è°ƒ (2#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-A-major" value="A-major">
                            <span data-i18n="key.A-major">A å¤§è°ƒ (3#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-E-major" value="E-major">
                            <span data-i18n="key.E-major">E å¤§è°ƒ (4#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-B-major" value="B-major">
                            <span data-i18n="key.B-major">B å¤§è°ƒ (5#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Fs-major" value="F#-major">
                            <span data-i18n="key.Fs-major">F# å¤§è°ƒ (6#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-F-major" value="F-major">
                            <span data-i18n="key.F-major">F å¤§è°ƒ (1b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Bb-major" value="Bb-major">
                            <span data-i18n="key.Bb-major">Bb å¤§è°ƒ (2b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Eb-major" value="Eb-major">
                            <span data-i18n="key.Eb-major">Eb å¤§è°ƒ (3b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Ab-major" value="Ab-major">
                            <span data-i18n="key.Ab-major">Ab å¤§è°ƒ (4b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Db-major" value="Db-major">
                            <span data-i18n="key.Db-major">Db å¤§è°ƒ (5b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Gb-major" value="Gb-major">
                            <span data-i18n="key.Gb-major">Gb å¤§è°ƒ (6b)</span>
                        </label>
                    </div>
                </div>

                <div class="key-section" style="margin-top: 20px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="modal.keySignature.minor">å°è°ƒ (Minor)</h4>
                        <button class="btn-select-all" onclick="selectAllMinorKeys()" style="padding: 5px 10px; font-size: 12px; background: #FF9500; color: white; border: none; border-radius: 4px; cursor: pointer;" data-i18n="button.selectAllMinor">å…¨é€‰</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-a-minor" value="a-minor" checked="">
                            <span data-i18n="key.a-minor">A å°è°ƒ</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-e-minor" value="e-minor">
                            <span data-i18n="key.e-minor">E å°è°ƒ (1#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-b-minor" value="b-minor">
                            <span data-i18n="key.b-minor">B å°è°ƒ (2#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-fs-minor" value="f#-minor">
                            <span data-i18n="key.fs-minor">F# å°è°ƒ (3#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-cs-minor" value="c#-minor">
                            <span data-i18n="key.cs-minor">C# å°è°ƒ (4#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-gs-minor" value="g#-minor">
                            <span data-i18n="key.gs-minor">G# å°è°ƒ (5#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-ds-minor" value="d#-minor">
                            <span data-i18n="key.ds-minor">D# å°è°ƒ (6#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-d-minor" value="d-minor">
                            <span data-i18n="key.d-minor">D å°è°ƒ (1b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-g-minor" value="g-minor">
                            <span data-i18n="key.g-minor">G å°è°ƒ (2b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-c-minor" value="c-minor">
                            <span data-i18n="key.c-minor">C å°è°ƒ (3b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-f-minor" value="f-minor">
                            <span data-i18n="key.f-minor">F å°è°ƒ (4b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-bb-minor" value="bb-minor">
                            <span data-i18n="key.bb-minor">Bb å°è°ƒ (5b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-eb-minor" value="eb-minor">
                            <span data-i18n="key.eb-minor">Eb å°è°ƒ (6b)</span>
                        </label>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveKeySettings()" data-i18n="button.save">ä¿å­˜è®¾ç½®</button>
                    <button class="btn-secondary" onclick="closeKeySettings()" data-i18n="button.cancel">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ‹å·è®¾ç½®å¼¹çª— -->
    <div id="timeSignatureModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="modal.timeSignature.title">æ‹å·è®¾ç½®</h3>
                <button class="close-btn" onclick="closeTimeSignatureSettings()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="time-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="modal.timeSignature.selection">æ‹å·é€‰æ‹©</h4>
                        <button class="btn-select-all" onclick="selectAllTimeSignatures()" style="padding: 5px 10px; font-size: 12px; background: #FF9500; color: white; border: none; border-radius: 4px; cursor: pointer;" data-i18n="button.selectAll">å…¨é€‰</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="time-4-4" value="4/4" checked="">
                            <span>4/4</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="time-3-4" value="3/4">
                            <span>3/4</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="time-2-4" value="2/4">
                            <span>2/4</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="time-6-8" value="6/8">
                            <span>6/8</span>
                        </label>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveTimeSignatureSettings()" data-i18n="button.save">ä¿å­˜è®¾ç½®</button>
                    <button class="btn-secondary" onclick="closeTimeSignatureSettings()" data-i18n="button.cancel">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- è°±å·è®¾ç½®å¼¹çª— -->
    <div id="clefModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="modal.clef.title">è°±å·è®¾ç½®</h3>
                <button class="close-btn" onclick="closeClefSettings()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="clef-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="modal.clef.selection">è°±å·é€‰æ‹©</h4>
                        <button class="btn-select-all" onclick="selectAllClefs()" style="padding: 5px 10px; font-size: 12px; background: #FF9500; color: white; border: none; border-radius: 4px; cursor: pointer;" data-i18n="button.selectAll">å…¨é€‰</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="clef-grand_staff" value="grand_staff" checked="">
                            <span data-i18n="clef.grand_staff">å¤§è°±è¡¨</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="clef-treble" value="treble">
                            <span data-i18n="clef.treble">é«˜éŸ³è°±å·</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="clef-bass" value="bass">
                            <span data-i18n="clef.bass">ä½éŸ³è°±å·</span>
                        </label>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveClefSettings()" data-i18n="button.save">ä¿å­˜è®¾ç½®</button>
                    <button class="btn-secondary" onclick="closeClefSettings()" data-i18n="button.cancel">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ğŸ¹ ä½éŸ³è°±å·éŸ³åŸŸè®¾ç½®å¼¹çª— -->
    <div id="bassClefRangeModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="modal.bassClefRange.title">ä½éŸ³è°±å·éŸ³åŸŸè®¾ç½®</h3>
                <button class="close-btn" onclick="closeBassClefRangeModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="range-section">
                    <div class="control-group">
                        <label for="bassClefRangeMin" data-i18n="piano.bassClefMin">æœ€ä½éŸ³</label>
                        <select id="bassClefRangeMin">
                            <option value="28">E1</option>
                            <option value="33">A1</option>
                            <option value="35">B1</option>
                            <option value="36">C2</option>
                            <option value="38">D2</option>
                            <option value="40" selected="">E2</option>
                            <option value="41">F2</option>
                            <option value="43">G2</option>
                            <option value="45">A2</option>
                            <option value="47">B2</option>
                            <option value="48">C3</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="bassClefRangeMax" data-i18n="piano.bassClefMax">æœ€é«˜éŸ³</label>
                        <select id="bassClefRangeMax">
                            <option value="36">C2</option>
                            <option value="38">D2</option>
                            <option value="40">E2</option>
                            <option value="41">F2</option>
                            <option value="43">G2</option>
                            <option value="45">A2</option>
                            <option value="47">B2</option>
                            <option value="48">C3</option>
                            <option value="50">D3</option>
                            <option value="52">E3</option>
                            <option value="53">F3</option>
                            <option value="55">G3</option>
                            <option value="57">A3</option>
                            <option value="59">B3</option>
                            <option value="60">C4</option>
                            <option value="62">D4</option>
                            <option value="64" selected="">E4</option>
                        </select>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveBassClefRange()" data-i18n="button.save">ä¿å­˜è®¾ç½®</button>
                    <button class="btn-secondary" onclick="closeBassClefRangeModal()" data-i18n="button.cancel">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ğŸ¹ é«˜éŸ³è°±å·éŸ³åŸŸè®¾ç½®å¼¹çª— -->
    <div id="trebleClefRangeModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="modal.trebleClefRange.title">é«˜éŸ³è°±å·éŸ³åŸŸè®¾ç½®</h3>
                <button class="close-btn" onclick="closeTrebleClefRangeModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="range-section">
                    <div class="control-group">
                        <label for="trebleClefRangeMin" data-i18n="piano.trebleClefMin">æœ€ä½éŸ³</label>
                        <select id="trebleClefRangeMin">
                            <option value="55">G3</option>
                            <option value="57">A3</option>
                            <option value="59">B3</option>
                            <option value="60" selected="">C4</option>
                            <option value="62">D4</option>
                            <option value="64">E4</option>
                            <option value="65">F4</option>
                            <option value="67">G4</option>
                            <option value="69">A4</option>
                            <option value="71">B4</option>
                            <option value="72">C5</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="trebleClefRangeMax" data-i18n="piano.trebleClefMax">æœ€é«˜éŸ³</label>
                        <select id="trebleClefRangeMax">
                            <option value="72">C5</option>
                            <option value="74">D5</option>
                            <option value="76">E5</option>
                            <option value="77">F5</option>
                            <option value="79">G5</option>
                            <option value="81">A5</option>
                            <option value="83">B5</option>
                            <option value="84">C6</option>
                            <option value="86">D6</option>
                            <option value="88" selected="">E6</option>
                            <option value="89">F6</option>
                            <option value="91">G6</option>
                            <option value="93">A6</option>
                        </select>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveTrebleClefRange()" data-i18n="button.save">ä¿å­˜è®¾ç½®</button>
                    <button class="btn-secondary" onclick="closeTrebleClefRangeModal()" data-i18n="button.cancel">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æŒ‘æˆ˜æ¨¡å¼å¼¹çª— -->
    <div id="challengeModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="modal.challenge.title">æŒ‘æˆ˜æ¨¡å¼</h3>
                <button class="close-btn" onclick="closeChallengeModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="control-row">
                    <div class="control-group">
                        <label for="challengeModeToggleModal" data-i18n="challenge.modeToggle">æŒ‘æˆ˜æ¨¡å¼</label>
                        <label class="switch" style="position: relative; display: inline-block; width: 60px; height: 34px;">
                            <input type="checkbox" id="challengeModeToggleModal" style="opacity: 0; width: 0; height: 0;">
                            <span class="slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: 0.4s; border-radius: 34px;">
                                <span class="slider-button" style="position: absolute; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: 0.4s; border-radius: 50%; transform: translateX(0px);"></span>
                            </span>
                        </label>
                    </div>
                    <div class="control-group">
                        <label for="challengeCalibrationToggle" data-i18n="challenge.calibration">è¾“å…¥æ ¡å‡†</label>
                        <label class="switch" style="position: relative; display: inline-block; width: 60px; height: 34px;">
                            <input type="checkbox" id="challengeCalibrationToggle" style="opacity: 0; width: 0; height: 0;">
                            <span class="slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: 0.4s; border-radius: 34px;">
                                <span class="slider-button" style="position: absolute; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: 0.4s; border-radius: 50%; transform: translateX(0px);"></span>
                            </span>
                        </label>
                    </div>
                </div>
                <div class="control-row">
                    <div class="control-group">
                        <label for="challengePrepTime" data-i18n="challenge.prepTime">å‡†å¤‡æ—¶é—´ï¼ˆç§’ï¼‰</label>
                        <input type="number" id="challengePrepTime" min="0" max="60" step="1" value="10">
                    </div>
                    <div class="control-group">
                        <label for="challengeBPM" data-i18n="challenge.bpm">BPM</label>
                        <input type="number" id="challengeBPM" min="40" max="240" step="1" value="80">
                    </div>
                </div>

                <div class="control-row">
                    <div class="control-group">
                        <label for="challengeCursorToggle" data-i18n="challenge.cursor">å…‰æ ‡</label>
                        <label class="switch" style="position: relative; display: inline-block; width: 60px; height: 34px;">
                            <input type="checkbox" id="challengeCursorToggle" checked style="opacity: 0; width: 0; height: 0;">
                            <span class="slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: 0.4s; border-radius: 34px;">
                                <span class="slider-button" style="position: absolute; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: 0.4s; border-radius: 50%; transform: translateX(0px);"></span>
                            </span>
                        </label>
                    </div>
                    <div class="control-group">
                        <label for="challengeMetronomeToggle" data-i18n="challenge.metronome">èŠ‚æ‹å™¨</label>
                        <label class="switch" style="position: relative; display: inline-block; width: 60px; height: 34px;">
                            <input type="checkbox" id="challengeMetronomeToggle" checked style="opacity: 0; width: 0; height: 0;">
                            <span class="slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: 0.4s; border-radius: 34px;">
                                <span class="slider-button" style="position: absolute; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: 0.4s; border-radius: 50%; transform: translateX(0px);"></span>
                            </span>
                        </label>
                    </div>
                    <div class="control-group">
                        <label for="challengeHideToggle" data-i18n="challenge.hide">éšè—</label>
                        <label class="switch" style="position: relative; display: inline-block; width: 60px; height: 34px;">
                            <input type="checkbox" id="challengeHideToggle" checked style="opacity: 0; width: 0; height: 0;">
                            <span class="slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: 0.4s; border-radius: 34px;">
                                <span class="slider-button" style="position: absolute; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: 0.4s; border-radius: 50%; transform: translateX(0px);"></span>
                            </span>
                        </label>
                    </div>
                </div>

                <p class="modal-hint">
                    <span data-i18n="challenge.cursorHint">å…‰æ ‡å¼€å…³ï¼šå…‰æ ‡ç”¨äºæç¤ºå½“å‰åº”æ¼”å¥çš„ä½ç½®ï¼Œcount-inç»“æŸåå‡ºç°å¹¶éšæ—‹å¾‹è·³åŠ¨ã€‚</span>
                    <span data-i18n="challenge.hideHint" style="display: block; margin-top: 6px;">éšè—å¼€å…³ï¼šå¼€å¯åï¼Œç³»ç»Ÿåœ¨è¿›å…¥ä¸‹ä¸€å°èŠ‚æ—¶ä¼šè‡ªåŠ¨é®æŒ¡ä¸Šä¸€å°èŠ‚ï¼Œä»…ä¿ç•™å½“å‰é˜…è¯»åŒºã€‚</span>
                </p>

                <div class="modal-buttons">
                    <button class="btn-secondary" onclick="cancelChallengeSetup()" data-i18n="button.cancel">å–æ¶ˆ</button>
                    <button class="btn-primary" onclick="confirmChallengeSetup()" data-i18n="button.start">å¼€å§‹</button>
                </div>
            </div>
        </div>
    </div>

    <div id="metronomePatternModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="modal.metronomePattern.title">èŠ‚æ‹å™¨èŠ‚å¥å‹</h3>
                <button class="close-btn" onclick="closeMetronomePatternSettings()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="metronome-pattern-row">
                    <div class="control-group metronome-pattern-toggle-group" style="flex: 1; min-width: 160px;">
                        <div class="toggle-container">
                            <input type="checkbox" id="metronomePatternEnable" class="toggle-input">
                            <label for="metronomePatternEnable" class="toggle-slider">
                                <span class="toggle-button"></span>
                            </label>
                        </div>
                        <label for="metronomePatternEnable" data-i18n="metronomePattern.enable">å¯ç”¨è‡ªå®šä¹‰èŠ‚å¥</label>
                    </div>
                    <div class="control-group" style="flex: 1; min-width: 180px;">
                        <label data-i18n="metronomePattern.subdivision">ç»†åˆ†</label>
                        <select id="metronomePatternSubdivision" class="metronome-pattern-select">
                            <option value="1" data-i18n="metronomePattern.subdivision.beat">æ¯æ‹1ä¸‹</option>
                            <option value="2" data-i18n="metronomePattern.subdivision.eighth">æ¯æ‹2åˆ† (å…«åˆ†)</option>
                            <option value="3" data-i18n="metronomePattern.subdivision.triplet">æ¯æ‹3åˆ† (ä¸‰è¿)</option>
                            <option value="4" data-i18n="metronomePattern.subdivision.sixteenth">æ¯æ‹4åˆ† (åå…­åˆ†)</option>
                        </select>
                    </div>
                    <div class="control-group" style="flex: 1; min-width: 140px;">
                        <label data-i18n="metronomePattern.bars">å°èŠ‚æ•°</label>
                        <select id="metronomePatternBars" class="metronome-pattern-select">
                            <option value="1" data-i18n="metronomePattern.bars.1">1å°èŠ‚</option>
                            <option value="2" data-i18n="metronomePattern.bars.2">2å°èŠ‚</option>
                            <option value="4" data-i18n="metronomePattern.bars.4">4å°èŠ‚</option>
                        </select>
                    </div>
                    <div class="metronome-pattern-info">
                        <span data-i18n="metronomePattern.timeSig">å½“å‰æ‹å·</span>
                        <strong id="metronomePatternTimeSig">4/4</strong>
                    </div>
                </div>

                <div class="metronome-pattern-grid" id="metronomePatternGrid"></div>
                <p class="modal-hint" data-i18n="metronomePattern.hint">ç‚¹å‡»æ–¹æ ¼å¯ç”¨/é™éŸ³èŠ‚æ‹</p>

                <div class="modal-buttons">
                    <button class="btn-secondary" onclick="resetMetronomePattern()" data-i18n="metronomePattern.resetBeats">é‡ç½®ä¸ºæ¯æ‹</button>
                    <button class="btn-secondary" onclick="clearMetronomePattern()" data-i18n="metronomePattern.clear">å…¨éƒ¨é™éŸ³</button>
                    <button class="btn-primary" onclick="saveMetronomePatternSettingsAndClose()" data-i18n="button.saveOnly">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ğŸ¯ é€šç”¨å¼¹çª—å¤–éƒ¨ç‚¹å‡»å…³é—­åŠŸèƒ½ -->
    <script>
        // ============================================================
        // å¤šè¯­è¨€ç³»ç»Ÿ (Multi-language System)
        // ============================================================
        // âœ… translations å¯¹è±¡å·²åœ¨ chord-sight-reading.js ä¸­å®šä¹‰
        // ç§»é™¤æ­¤å¤„é‡å¤å£°æ˜ä»¥é¿å… SyntaxError: Identifier 'translations' has already been declared

        // ============================================================
        // UIæ§åˆ¶å‡½æ•° (UI Control Functions)
        // ============================================================

        // è®¾ç½®å¼¹çª—æ§åˆ¶
        function toggleSettings() {
            const modal = document.getElementById('settingsModal');
            const isVisible = modal && (modal.style.display === 'flex' || modal.style.display === 'block');

            if (isVisible) {
                closeSettingsModal();
            } else {
                openSettingsModal();
            }
        }

        function openSettingsModal() {
            const modal = document.getElementById('settingsModal');
            if (!modal) return;
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeSettingsModal() {
            const modal = document.getElementById('settingsModal');
            if (!modal) return;
            modal.style.display = 'none';
            document.body.style.overflow = '';
        }

        function closeSettings() {
            closeSettingsModal();
        }

        // åŠŸèƒ½é€‰æ‹©å™¨æ§åˆ¶
        function toggleFunctionSelector() {
            const functionMenu = document.getElementById('functionMenu');
            const isVisible = functionMenu.classList.contains('show');

            if (isVisible) {
                closeFunctionSelector();
            } else {
                openFunctionSelector();
            }
        }

        function openFunctionSelector() {
            const functionMenu = document.getElementById('functionMenu');
            functionMenu.classList.add('show');

            // æ·»åŠ ç‚¹å‡»å¤–éƒ¨åŒºåŸŸå…³é—­èœå•çš„ç›‘å¬å™¨
            setTimeout(() => {
                document.addEventListener('click', handleFunctionClickOutside);
            }, 10);
        }

        function closeFunctionSelector() {
            const functionMenu = document.getElementById('functionMenu');
            functionMenu.classList.remove('show');

            // ç§»é™¤ç‚¹å‡»å¤–éƒ¨åŒºåŸŸçš„ç›‘å¬å™¨
            document.removeEventListener('click', handleFunctionClickOutside);
        }

        // å¤„ç†ç‚¹å‡»å¤–éƒ¨åŒºåŸŸå…³é—­åŠŸèƒ½èœå•
        function handleFunctionClickOutside(event) {
            const functionSelector = document.querySelector('.function-selector');

            if (functionSelector && !functionSelector.contains(event.target)) {
                closeFunctionSelector();
            }
        }

        // åˆ‡æ¢åŠŸèƒ½
        function switchFunction(mode) {
            if (mode === 'melody') {
                // å¯¼èˆªåˆ°æ—‹å¾‹è§†å¥é¡µé¢
                window.location.href = 'melody-generator.html';
            } else if (mode === 'jianpu') {
                // å¯¼èˆªåˆ°ç®€è°±è§†å¥é¡µé¢
                window.location.href = 'jianpu-generator.html';
            } else if (mode === 'interval') {
                // å¯¼èˆªåˆ°éŸ³ç¨‹è§†å¥é¡µé¢
                window.location.href = 'interval-generator.html';
            } else if (mode === 'chord') {
                // å·²ç»åœ¨å’Œå¼¦è§†å¥é¡µé¢
                closeFunctionSelector();
                console.log('å·²åœ¨å’Œå¼¦è§†å¥æ¨¡å¼');
            } else if (mode === 'rhythm') {
                // å¯¼èˆªåˆ°èŠ‚å¥è§†å¥é¡µé¢
                window.location.href = 'rhythm.html';
            }
        }

        // å¤„ç†ç‚¹å‡»å¤–éƒ¨åŒºåŸŸå…³é—­è®¾ç½®èœå•ï¼ˆå·²æ”¹ä¸ºå¼¹çª—ï¼Œæ— éœ€ä¸‹æ‹‰å¤„ç†ï¼‰

        // ğŸ¯ é€šç”¨å¼¹çª—å¤–éƒ¨ç‚¹å‡»å…³é—­åŠŸèƒ½
        function initializeModalClickOutsideToClose() {
            const modalIds = [
                'settingsModal',
                'chordTypeModal',
                'rhythmModal',
                'keySignatureModal',
                'timeSignatureModal',
                'clefModal',
                'bassClefRangeModal',
                'trebleClefRangeModal',
                'challengeModal',
                'metronomePatternModal'
            ];

            modalIds.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.addEventListener('click', function(event) {
                        // åªæœ‰å½“ç‚¹å‡»çš„æ˜¯å¼¹çª—èƒŒæ™¯ï¼ˆmodalå®¹å™¨æœ¬èº«ï¼‰æ—¶æ‰å…³é—­
                        if (event.target === modal) {
                            console.log(`ğŸ¯ ç‚¹å‡»å¤–éƒ¨åŒºåŸŸå…³é—­å¼¹çª—: ${modalId}`);

                            // æ ¹æ®å¼¹çª—ç±»å‹è°ƒç”¨ç›¸åº”çš„å…³é—­å‡½æ•°
                            switch(modalId) {
                                case 'settingsModal':
                                    if (typeof closeSettingsModal === 'function') {
                                        closeSettingsModal();
                                    }
                                    break;
                                case 'chordTypeModal':
                                    if (typeof closeChordTypeSettings === 'function') {
                                        closeChordTypeSettings();
                                    }
                                    break;
                                case 'rhythmModal':
                                    if (typeof closeRhythmSettings === 'function') {
                                        closeRhythmSettings();
                                    }
                                    break;
                                case 'keySignatureModal':
                                    if (typeof saveKeySettings === 'function') {
                                        saveKeySettings(); // å¤–éƒ¨ç‚¹å‡»æ—¶ä¿å­˜è®¾ç½®å¹¶å…³é—­
                                    }
                                    break;
                                case 'timeSignatureModal':
                                    if (typeof closeTimeSignatureSettings === 'function') {
                                        closeTimeSignatureSettings();
                                    }
                                    break;
                                case 'clefModal':
                                    if (typeof closeClefSettings === 'function') {
                                        closeClefSettings();
                                    }
                                    break;
                                case 'bassClefRangeModal':
                                    if (typeof saveBassClefRange === 'function') {
                                        saveBassClefRange(); // å¤–éƒ¨ç‚¹å‡»æ—¶ä¿å­˜è®¾ç½®å¹¶å…³é—­
                                    }
                                    break;
                                case 'trebleClefRangeModal':
                                    if (typeof saveTrebleClefRange === 'function') {
                                        saveTrebleClefRange(); // å¤–éƒ¨ç‚¹å‡»æ—¶ä¿å­˜è®¾ç½®å¹¶å…³é—­
                                    }
                                    break;
                                case 'challengeModal':
                                    if (typeof cancelChallengeSetup === 'function') {
                                        cancelChallengeSetup();
                                    }
                                    break;
                                case 'metronomePatternModal':
                                    if (typeof closeMetronomePatternSettings === 'function') {
                                        closeMetronomePatternSettings();
                                    }
                                    break;
                                default:
                                    // é€šç”¨å…³é—­æ–¹æ³•
                                    modal.style.display = 'none';
                            }
                        }
                    });
                    console.log(`âœ… å·²ä¸º ${modalId} æ·»åŠ å¤–éƒ¨ç‚¹å‡»å…³é—­åŠŸèƒ½`);
                }
            });
        }

        // ğŸ¯ åŠŸèƒ½èœå•å’Œè®¾ç½®èœå•å¤–éƒ¨ç‚¹å‡»å…³é—­åŠŸèƒ½
        function initializeMenuClickOutsideToClose() {
            document.addEventListener('click', function(event) {
                // å¤„ç†åŠŸèƒ½é€‰æ‹©å™¨èœå•
                const functionMenu = document.getElementById('functionMenu');
                const functionBtn = document.getElementById('functionBtn');

                if (functionMenu && functionMenu.classList.contains('show')) {
                    // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯èœå•æœ¬èº«æˆ–è§¦å‘æŒ‰é’®ï¼Œåˆ™å…³é—­èœå•
                    if (!functionMenu.contains(event.target) && !functionBtn.contains(event.target)) {
                        functionMenu.classList.remove('show');
                        console.log('ğŸ¯ ç‚¹å‡»å¤–éƒ¨åŒºåŸŸå…³é—­åŠŸèƒ½èœå•');
                    }
                }

                // è®¾ç½®å·²æ”¹ä¸ºå¼¹çª—ï¼Œä¸åœ¨æ­¤å¤„å¤„ç†
            });
        }

        // åœ¨é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeModalClickOutsideToClose();
            initializeMenuClickOutsideToClose();
            console.log('ğŸ¯ å¼¹çª—å¤–éƒ¨ç‚¹å‡»å…³é—­åŠŸèƒ½å·²åˆå§‹åŒ–');
            console.log('ğŸ¯ èœå•å¤–éƒ¨ç‚¹å‡»å…³é—­åŠŸèƒ½å·²åˆå§‹åŒ–');
        });
    </script>

    <!-- å’Œå¼¦ç”Ÿæˆå™¨æ¨¡å— -->
    <script src="./IC å’Œå¼¦è§†å¥å·¥å…·_files/harmony-theory.js"></script>
    <script src="./IC å’Œå¼¦è§†å¥å·¥å…·_files/enhanced-harmony.js"></script>
    <script src="./IC å’Œå¼¦è§†å¥å·¥å…·_files/chord-progressions.js"></script>
    <script src="./IC å’Œå¼¦è§†å¥å·¥å…·_files/jazz-harmony.js"></script>
    <script src="./IC å’Œå¼¦è§†å¥å·¥å…·_files/voicing-engine.js"></script>
    <script src="./IC å’Œå¼¦è§†å¥å·¥å…·_files/drop-voicing-simple.js"></script> <!-- ğŸ¯ æç®€Drop2/Drop3å®ç° (2025-10-03) -->
    <script src="./IC å’Œå¼¦è§†å¥å·¥å…·_files/voice-leading.js"></script>

    <!-- ğŸµ ç‹¬ç«‹å°è°ƒæ‹¼å†™ç³»ç»Ÿ - å®Œå…¨ç‹¬ç«‹æ¨¡å—ï¼Œè§£å†³å…«åº¦å’Œå˜ä½“éŸ³é—®é¢˜ -->
    <script src="./IC å’Œå¼¦è§†å¥å·¥å…·_files/minor-key-spelling.js"></script>
    <script src="./IC å’Œå¼¦è§†å¥å·¥å…·_files/minor-scale-alterations.js"></script>

    <!-- ğŸŒ å›½é™…åŒ–ï¼ˆi18nï¼‰ç³»ç»Ÿ - å¤šè¯­è¨€æ”¯æŒ (2025-10-04) -->
    <script src="./IC å’Œå¼¦è§†å¥å·¥å…·_files/i18n.js"></script>

    <script src="./IC å’Œå¼¦è§†å¥å·¥å…·_files/chord-sight-reading.js"></script>

    <!-- é’¢ç´ç‹¬ç«‹ç”Ÿæˆç³»ç»Ÿ -->
    <script src="./IC å’Œå¼¦è§†å¥å·¥å…·_files/piano-settings-manager.js"></script>
    <script src="./IC å’Œå¼¦è§†å¥å·¥å…·_files/piano-harmony-engine.js"></script>
    <script src="./IC å’Œå¼¦è§†å¥å·¥å…·_files/piano-voicing-engine.js"></script>
    <script src="./IC å’Œå¼¦è§†å¥å·¥å…·_files/piano-chord-progression-generator.js"></script>
    <script src="./IC å’Œå¼¦è§†å¥å·¥å…·_files/piano-chord-generator.js"></script>

    <!-- å‰ä»–ç‹¬ç«‹è½¬ä½ç³»ç»Ÿ - å®‰å…¨æ¨¡å¼å®ç° -->
    <script src="./IC å’Œå¼¦è§†å¥å·¥å…·_files/enhanced-voicing-settings.js"></script>
    <!-- ä½¿ç”¨æ–°çš„å®‰å…¨ç‹¬ç«‹voicingæ§åˆ¶ï¼Œä¸ä¿®æ”¹åŸVoicingEngine -->
    <!-- <script src="chords-generator/safe-independent-voicing.js"></script> -->
    <!-- æ³¨ï¼šæ–‡ä»¶ä¸å­˜åœ¨ï¼Œé¿å…404é”™è¯¯ (2025-10-02æ¸…ç†) -->
    <!-- æ—§çš„æ‰©å±•ç³»ç»Ÿå·²ç¦ç”¨ï¼Œé¿å…è‡ªåŠ¨ä¿®æ”¹VoicingEngineåŸå‹ -->
    <!-- <script src="chords-generator/independent-voicing-extensions.js"></script> -->
    <!-- <script src="chords-generator/independent-voicing-generator.js"></script> -->
    <!-- <script src="chords-generator/independent-voicing-test.js"></script> -->

    <!-- Voicingä¿®å¤éªŒè¯è„šæœ¬ -->
    <script src="file:///Users/igorchen/Downloads/IC%20Studio/IC%20%E8%A7%86%E5%A5%8F%E5%B7%A5%E5%85%B7%20%E7%AC%AC%E4%B8%80%E7%89%88%20(%E5%B7%B2%E4%B8%8A%E6%9E%B6)%20%E9%9F%B3%E7%A8%8B%E4%BF%AE%E5%A4%8D%E4%B8%AD%202/chords-generator/voicing-fix-verification.js"></script>

    <!-- ä¾èµ–æ€§æµ‹è¯•è„šæœ¬ -->
    <script src="file:///Users/igorchen/Downloads/IC%20Studio/IC%20%E8%A7%86%E5%A5%8F%E5%B7%A5%E5%85%B7%20%E7%AC%AC%E4%B8%80%E7%89%88%20(%E5%B7%B2%E4%B8%8A%E6%9E%B6)%20%E9%9F%B3%E7%A8%8B%E4%BF%AE%E5%A4%8D%E4%B8%AD%202/chords-generator/dependency-test.js"></script>

    <!-- ç‹¬ç«‹è½¬ä½æ§åˆ¶ä½¿ç”¨æŒ‡å— -->
    <script src="file:///Users/igorchen/Downloads/IC%20Studio/IC%20%E8%A7%86%E5%A5%8F%E5%B7%A5%E5%85%B7%20%E7%AC%AC%E4%B8%80%E7%89%88%20(%E5%B7%B2%E4%B8%8A%E6%9E%B6)%20%E9%9F%B3%E7%A8%8B%E4%BF%AE%E5%A4%8D%E4%B8%AD%202/chords-generator/independent-voicing-guide.js"></script>

    <!-- å½“å‰ç³»ç»Ÿå½±å“æµ‹è¯• -->
    <script src="file:///Users/igorchen/Downloads/IC%20Studio/IC%20%E8%A7%86%E5%A5%8F%E5%B7%A5%E5%85%B7%20%E7%AC%AC%E4%B8%80%E7%89%88%20(%E5%B7%B2%E4%B8%8A%E6%9E%B6)%20%E9%9F%B3%E7%A8%8B%E4%BF%AE%E5%A4%8D%E4%B8%AD%202/chords-generator/current-system-impact-test.js"></script>

    <!-- åº•å±‚é€»è¾‘ä¿®æ”¹éªŒè¯æµ‹è¯• -->
    <script src="file:///Users/igorchen/Downloads/IC%20Studio/IC%20%E8%A7%86%E5%A5%8F%E5%B7%A5%E5%85%B7%20%E7%AC%AC%E4%B8%80%E7%89%88%20(%E5%B7%B2%E4%B8%8A%E6%9E%B6)%20%E9%9F%B3%E7%A8%8B%E4%BF%AE%E5%A4%8D%E4%B8%AD%202/chords-generator/bottom-logic-modification-test.js"></script>

    <!-- å¿«é€Ÿä¸ƒå’Œå¼¦æµ‹è¯• -->
    <script src="file:///Users/igorchen/Downloads/IC%20Studio/IC%20%E8%A7%86%E5%A5%8F%E5%B7%A5%E5%85%B7%20%E7%AC%AC%E4%B8%80%E7%89%88%20(%E5%B7%B2%E4%B8%8A%E6%9E%B6)%20%E9%9F%B3%E7%A8%8B%E4%BF%AE%E5%A4%8D%E4%B8%AD%202/chords-generator/quick-seventh-chord-test.js"></script>

    <!-- Drop2/Drop3åŸä½ä¿æŠ¤æµ‹è¯• (2025-10-02) -->
    <script src="./IC å’Œå¼¦è§†å¥å·¥å…·_files/test-drop-root-position.js"></script>

    <!-- Drop2/Drop3æ­£ç¡®å®ç° (2025-10-02ä¿®å¤) -->
    <script src="./IC å’Œå¼¦è§†å¥å·¥å…·_files/DROP-VOICING-FIX.js"></script>

    <!-- å’Œå¼¦ä»£å·è¯Šæ–­å·¥å…· (2025-10-02) -->
    <script src="./IC å’Œå¼¦è§†å¥å·¥å…·_files/chord-analysis-diagnosis.js"></script>

    <!-- å’Œå¼¦æ˜¾ç¤ºç›‘æ§å·¥å…· (2025-10-02) -->
    <script src="./IC å’Œå¼¦è§†å¥å·¥å…·_files/chord-display-monitor.js"></script>

    <!-- å¢å¼ºåŠŸèƒ½å’Œå£°ç³»ç»Ÿåˆå§‹åŒ– -->
    <script>
        // ============ ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½ ============
        let currentTheme = localStorage.getItem('preferredTheme') || 'light';

        // ä¸»é¢˜å›¾æ ‡æ˜ å°„
        const themeIcons = {
            'light': 'ğŸŒ™', // åœ¨lightæ¨¡å¼æ˜¾ç¤ºæœˆäº®å›¾æ ‡ï¼Œç‚¹å‡»åˆ‡æ¢åˆ°dark
            'dark': 'â˜€ï¸'   // åœ¨darkæ¨¡å¼æ˜¾ç¤ºå¤ªé˜³å›¾æ ‡ï¼Œç‚¹å‡»åˆ‡æ¢åˆ°light
        };

        // åˆ‡æ¢ä¸»é¢˜ (ä¿ç•™å‘åå…¼å®¹æ€§)
        function toggleTheme() {
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            setTheme(newTheme);
        }

        // è®¾ç½®ä¸»é¢˜ (æ–°ç‰ˆæœ¬ï¼Œç”¨äºè®¾ç½®èœå•)
        function setTheme(theme) {
            currentTheme = theme;
            localStorage.setItem('preferredTheme', theme);

            // è®¾ç½®HTMLçš„data-themeå±æ€§
            document.documentElement.setAttribute('data-theme', theme);

            // è§¦å‘ç»Ÿä¸€åŒæ­¥ç³»ç»Ÿ (åŒæ ‡ç­¾é¡µå†…å®æ—¶åŒæ­¥)
            if (window.ICStudioSync) {
                window.ICStudioSync.syncTheme(theme, 'chord-tool');
            }

            // å…³é—­è®¾ç½®å¼¹çª—
            if (typeof closeSettingsModal === 'function') {
                closeSettingsModal();
            } else if (typeof closeSettings === 'function') {
                closeSettings();
            }

            if (window.__icMidi && typeof window.__icMidi.refreshStatus === 'function') {
                window.__icMidi.refreshStatus();
            }

            console.log(`ğŸ¨ å’Œå¼¦è§†å¥å·¥å…·ä¸»é¢˜å·²è®¾ç½®ä¸º: ${theme}`);
        }

        // åˆå§‹åŒ–ä¸»é¢˜
        function initializeTheme() {
            document.documentElement.setAttribute('data-theme', currentTheme);
            console.log(`ğŸ¨ å’Œå¼¦è§†å¥å·¥å…·ä¸»é¢˜åˆå§‹åŒ–: ${currentTheme}`);
        }

        // ============ ç¿»è¯‘åŠŸèƒ½ ============
        // æ³¨æ„ï¼šä½¿ç”¨ chord-sight-reading.js ä¸­å®šä¹‰çš„ translations å˜é‡

        // è¯­è¨€åˆ‡æ¢ç›¸å…³å˜é‡
        let currentLanguage = localStorage.getItem('preferredLanguage') || 'en';

        // ç¿»è¯‘å‡½æ•°
        function applyTranslations() {
            // ğŸ”§ ä½¿ç”¨ I18n ç³»ç»Ÿ (2025-10-04)
            if (window.I18n && window.I18n.applyLanguage) {
                window.I18n.applyLanguage(currentLanguage);
            } else {
                console.warn('âš ï¸ I18nç³»ç»ŸæœªåŠ è½½ï¼Œæ— æ³•åº”ç”¨ç¿»è¯‘');
            }
        }

        // å…¨å±€ç¿»è¯‘å‡½æ•°ï¼ˆä¾›å¼¹çª—è°ƒç”¨ï¼‰
        window.translatePage = function() {
            applyTranslations();
        };

        // ç¿»è¯‘å‡½æ•° - è·å–æŒ‡å®šé”®çš„ç¿»è¯‘æ–‡æœ¬
        function translate(key) {
            // ğŸ”§ ä½¿ç”¨ I18n ç³»ç»Ÿ (2025-10-04)
            if (window.I18n && window.I18n.t) {
                return window.I18n.t(key, currentLanguage);
            }
            // å¦‚æœI18næœªåŠ è½½ï¼Œè¿”å›é”®åä½œä¸ºåå¤‡
            return key;
        }

        // æ›´æ–°åŠ¨æ€æ§ä»¶æ–‡æœ¬ç¿»è¯‘
        function updateDynamicControlsTranslation() {
            // æ›´æ–°å’Œå£°æ¨¡å¼æ ‡ç­¾
            const harmonyModeLabel = document.getElementById('harmonyModeLabel');
            if (harmonyModeLabel) {
                const toggle = document.getElementById('functionalHarmonyToggle');
                if (toggle && toggle.checked) {
                    harmonyModeLabel.textContent = translate('controls.functionalMode');
                } else {
                    harmonyModeLabel.textContent = translate('controls.randomMode');
                }
            }

            // æ›´æ–°ä¹å™¨æ¨¡å¼æ ‡ç­¾
            const instrumentModeLabel = document.getElementById('instrumentModeLabel');
            if (instrumentModeLabel) {
                const toggle = document.getElementById('instrumentModeToggle');
                if (toggle && toggle.checked) {
                    instrumentModeLabel.textContent = translate('controls.pianoMode');
                } else {
                    instrumentModeLabel.textContent = translate('controls.guitarMode');
                }
            }

            // æ›´æ–°é«˜çº§è®¾ç½®æŒ‰é’®æ–‡æœ¬
            const advancedBtn = document.getElementById('chordAdvancedBtn');
            const advancedDiv = document.getElementById('chordAdvancedSettings');
            if (advancedBtn && advancedDiv) {
                const isVisible = advancedDiv.style.display !== 'none';
                if (isVisible) {
                    advancedBtn.textContent = translate('button.hideAdvanced');
                } else {
                    advancedBtn.textContent = translate('button.showAdvanced');
                }
            }

            // æ›´æ–°å’Œå¼¦ä»£å·æŒ‰é’®æ ‡é¢˜
            const chordSymbolBtn = document.getElementById('chordSymbolBtn');
            if (chordSymbolBtn) {
                if (chordSymbolsVisible) {
                    chordSymbolBtn.title = translate('controls.chordSymbolsHide');
                } else {
                    chordSymbolBtn.title = translate('controls.chordSymbolsShow');
                }
            }
        }

        // é«˜çº§è®¾ç½®åˆ‡æ¢å‡½æ•°
        function toggleChordAdvancedSettings() {
            const advancedDiv = document.getElementById('chordAdvancedSettings');
            const btn = document.getElementById('chordAdvancedBtn');

            if (advancedDiv && btn) {
                const isVisible = advancedDiv.style.display !== 'none';

                if (isVisible) {
                    advancedDiv.style.display = 'none';
                    btn.textContent = translate('button.showAdvanced');
                } else {
                    advancedDiv.style.display = 'block';
                    btn.textContent = translate('button.hideAdvanced');
                }
            }
        }

        // è¯­è¨€åˆ‡æ¢å‡½æ•°
        function switchLanguage(language) {
            currentLanguage = language;
            localStorage.setItem('preferredLanguage', language);
            applyTranslations();

            // è§¦å‘ç»Ÿä¸€åŒæ­¥ç³»ç»Ÿ (åŒæ ‡ç­¾é¡µå†…å®æ—¶åŒæ­¥)
            if (window.ICStudioSync) {
                window.ICStudioSync.syncLanguage(language, 'chord-tool');
            }

            // å…³é—­è®¾ç½®èœå•
            if (typeof closeSettings === 'function') {
                closeSettings();
            }

            console.log(`ğŸŒ å’Œå¼¦è§†å¥å·¥å…·è¯­è¨€å·²åˆ‡æ¢ä¸º: ${language}`);
        }

        // è®¾ç½®èœå•æ§åˆ¶å·²æ”¹ä¸ºå¼¹çª—ï¼Œå¤ç”¨ä¸Šæ–¹å‡½æ•°

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–ä¸»é¢˜å’Œç¿»è¯‘
        document.addEventListener('DOMContentLoaded', function() {
            initializeTheme();
            applyTranslations();
            console.log('ğŸ¨ğŸŒ å’Œå¼¦è§†å¥å·¥å…·ä¸»é¢˜å’Œç¿»è¯‘åŠŸèƒ½å·²åˆå§‹åŒ–');

            // ============ è·¨å·¥å…·åŒæ­¥ç›‘å¬æœºåˆ¶ ============
            // ç›‘å¬å…¶ä»–å·¥å…·å¯¹localStorageçš„ä¿®æ”¹
            window.addEventListener('storage', function(e) {
                if (e.key === 'preferredTheme' && e.newValue !== currentTheme) {
                    console.log(`ğŸ”„ å’Œå¼¦è§†å¥å·¥å…·æ£€æµ‹åˆ°ä¸»é¢˜å˜åŒ–: ${currentTheme} â†’ ${e.newValue}`);
                    currentTheme = e.newValue;
                    document.documentElement.setAttribute('data-theme', currentTheme);
                    console.log(`ğŸ¨ å’Œå¼¦è§†å¥å·¥å…·ä¸»é¢˜å·²åŒæ­¥ä¸º: ${currentTheme}`);
                }

                if (e.key === 'preferredLanguage' && e.newValue !== currentLanguage) {
                    console.log(`ğŸ”„ å’Œå¼¦è§†å¥å·¥å…·æ£€æµ‹åˆ°è¯­è¨€å˜åŒ–: ${currentLanguage} â†’ ${e.newValue}`);
                    currentLanguage = e.newValue;
                    applyTranslations();
                    console.log(`ğŸŒ å’Œå¼¦è§†å¥å·¥å…·è¯­è¨€å·²åŒæ­¥ä¸º: ${currentLanguage}`);
                }
            });

            console.log('ğŸ”— å’Œå¼¦è§†å¥å·¥å…·localStorageè·¨å·¥å…·åŒæ­¥ç›‘å¬å·²å¯ç”¨');

            // ============ ç»Ÿä¸€åŒæ­¥ç³»ç»Ÿ ============
            // åˆ›å»ºå…¨å±€åŒæ­¥å‡½æ•°ï¼Œæ”¯æŒåŒæ ‡ç­¾é¡µå†…å®æ—¶åŒæ­¥
            window.ICStudioSync = window.ICStudioSync || {
                tools: new Set(),

                // æ³¨å†Œå·¥å…·
                registerTool: function(toolName, callbacks) {
                    this.tools.add({
                        name: toolName,
                        onThemeChange: callbacks.onThemeChange,
                        onLanguageChange: callbacks.onLanguageChange
                    });
                    console.log(`ğŸ”— ${toolName} å·²æ³¨å†Œåˆ°ç»Ÿä¸€åŒæ­¥ç³»ç»Ÿ`);
                },

                // åŒæ­¥ä¸»é¢˜åˆ°æ‰€æœ‰å·¥å…·
                syncTheme: function(newTheme, fromTool) {
                    console.log(`ğŸ”„ ç»Ÿä¸€åŒæ­¥ç³»ç»Ÿ: åŒæ­¥ä¸»é¢˜ ${newTheme} (æ¥æº: ${fromTool})`);
                    this.tools.forEach(tool => {
                        if (tool.name !== fromTool && tool.onThemeChange) {
                            try {
                                tool.onThemeChange(newTheme);
                            } catch (error) {
                                console.warn(`âš ï¸ ${tool.name} ä¸»é¢˜åŒæ­¥å¤±è´¥:`, error);
                            }
                        }
                    });
                },

                // åŒæ­¥è¯­è¨€åˆ°æ‰€æœ‰å·¥å…·
                syncLanguage: function(newLanguage, fromTool) {
                    console.log(`ğŸ”„ ç»Ÿä¸€åŒæ­¥ç³»ç»Ÿ: åŒæ­¥è¯­è¨€ ${newLanguage} (æ¥æº: ${fromTool})`);
                    this.tools.forEach(tool => {
                        if (tool.name !== fromTool && tool.onLanguageChange) {
                            try {
                                tool.onLanguageChange(newLanguage);
                            } catch (error) {
                                console.warn(`âš ï¸ ${tool.name} è¯­è¨€åŒæ­¥å¤±è´¥:`, error);
                            }
                        }
                    });
                }
            };

            // æ³¨å†Œå’Œå¼¦å·¥å…·åˆ°ç»Ÿä¸€åŒæ­¥ç³»ç»Ÿ
            window.ICStudioSync.registerTool('chord-tool', {
                onThemeChange: function(newTheme) {
                    if (currentTheme !== newTheme) {
                        console.log(`ğŸ¨ å’Œå¼¦å·¥å…·æ¥æ”¶ä¸»é¢˜åŒæ­¥: ${currentTheme} â†’ ${newTheme}`);
                        currentTheme = newTheme;
                        document.documentElement.setAttribute('data-theme', currentTheme);
                    }
                },
                onLanguageChange: function(newLanguage) {
                    if (currentLanguage !== newLanguage) {
                        console.log(`ğŸŒ å’Œå¼¦å·¥å…·æ¥æ”¶è¯­è¨€åŒæ­¥: ${currentLanguage} â†’ ${newLanguage}`);
                        currentLanguage = newLanguage;
                        applyTranslations();
                    }
                }
            });
        });

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–å¢å¼ºåŠŸèƒ½å’Œå£°ç³»ç»Ÿ
        // ====== èŠ‚æ‹å™¨åŠŸèƒ½ ======
        // èŠ‚æ‹å™¨ç›¸å…³å˜é‡ (æ£€æŸ¥æ˜¯å¦å·²å£°æ˜)
        if (typeof metronomeInterval === 'undefined') {
            var metronomeInterval = null;
        }
        let metronomeAudioContext = null;
        let isMetronomeRunning = false;
        let metronomeTempo = 60; // é»˜è®¤60 BPM
        let metronomeStepIndex = 0;

        const metronomePatternStorageKey = 'ic_chord_metronome_pattern';
        const metronomeSubdivisionOptions = [1, 2, 3, 4];
        const metronomeBarsOptions = [1, 2, 4];
        let metronomePattern = {
            enabled: false,
            subdivision: 1,
            bars: 1,
            steps: []
        };

        function normalizeMetronomeSubdivision(value) {
            const normalized = parseInt(value, 10);
            return metronomeSubdivisionOptions.includes(normalized) ? normalized : 1;
        }

        function normalizeMetronomeBars(value) {
            const normalized = parseInt(value, 10);
            return metronomeBarsOptions.includes(normalized) ? normalized : 1;
        }

        function buildDefaultMetronomePattern(stepsPerPattern, subdivision) {
            const steps = new Array(stepsPerPattern).fill(0);
            for (let i = 0; i < stepsPerPattern; i += subdivision) {
                steps[i] = 1;
            }
            return steps;
        }

        function ensureMetronomePatternSteps(stepsPerPattern, subdivision) {
            if (!Array.isArray(metronomePattern.steps) || metronomePattern.steps.length !== stepsPerPattern) {
                metronomePattern.steps = buildDefaultMetronomePattern(stepsPerPattern, subdivision);
                saveMetronomePatternSettings();
            }
            metronomePattern.steps = metronomePattern.steps.map(step => (step ? 1 : 0));
            return metronomePattern.steps;
        }

        function loadMetronomePatternSettings() {
            try {
                const raw = localStorage.getItem(metronomePatternStorageKey);
                if (!raw) return;
                const data = JSON.parse(raw);
                if (data && typeof data === 'object') {
                    metronomePattern.enabled = !!data.enabled;
                    metronomePattern.subdivision = normalizeMetronomeSubdivision(data.subdivision);
                    metronomePattern.bars = normalizeMetronomeBars(data.bars);
                    metronomePattern.steps = Array.isArray(data.steps) ? data.steps.map(step => (step ? 1 : 0)) : [];
                }
            } catch (error) {
                console.warn('âš ï¸ èŠ‚æ‹å™¨èŠ‚å¥å‹è¯»å–å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®', error);
            }
        }

        function saveMetronomePatternSettings() {
            try {
                const payload = {
                    enabled: !!metronomePattern.enabled,
                    subdivision: normalizeMetronomeSubdivision(metronomePattern.subdivision),
                    bars: normalizeMetronomeBars(metronomePattern.bars),
                    steps: Array.isArray(metronomePattern.steps) ? metronomePattern.steps.map(step => (step ? 1 : 0)) : []
                };
                localStorage.setItem(metronomePatternStorageKey, JSON.stringify(payload));
            } catch (error) {
                console.warn('âš ï¸ èŠ‚æ‹å™¨èŠ‚å¥å‹ä¿å­˜å¤±è´¥', error);
            }
        }

        function getMetronomeTimeSignatureInfo() {
            let beats = 4;
            let den = 4;
            try {
                if (typeof chordSettings !== 'undefined' && Array.isArray(chordSettings.timeSignatures) && chordSettings.timeSignatures.length === 1) {
                    const parts = String(chordSettings.timeSignatures[0]).split('/');
                    beats = parseInt(parts[0] || '4', 10) || beats;
                    den = parseInt(parts[1] || '4', 10) || den;
                    return { beats, den };
                }
            } catch (error) {
                console.warn('âš ï¸ æ— æ³•è¯»å–å½“å‰æ‹å·ï¼Œä½¿ç”¨é»˜è®¤4/4æ‹', error);
            }
            return { beats, den };
        }

        function getMetronomePatternInfo(tempoOverride) {
            const tempo = Math.max(1, tempoOverride || metronomeTempo);
            if (!metronomePattern.enabled) {
                return {
                    usePattern: false,
                    stepDuration: 60.0 / tempo
                };
            }

            const tsInfo = getMetronomeTimeSignatureInfo();
            const subdivision = normalizeMetronomeSubdivision(metronomePattern.subdivision);
            const bars = normalizeMetronomeBars(metronomePattern.bars);
            const beatDuration = (60.0 / tempo) * (4 / tsInfo.den);
            const stepDuration = beatDuration / subdivision;
            const stepsPerBar = tsInfo.beats * subdivision;
            const stepsPerPattern = stepsPerBar * bars;
            const steps = ensureMetronomePatternSteps(stepsPerPattern, subdivision);

            return {
                usePattern: true,
                stepDuration,
                stepsPerBar,
                stepsPerPattern,
                steps,
                subdivision,
                bars
            };
        }

        function restartMetronomeIfRunning() {
            if (isMetronomeRunning) {
                stopMetronome();
                startMetronome();
            }
        }

        function updateMetronomePatternTimeSig() {
            const label = document.getElementById('metronomePatternTimeSig');
            if (!label) return;
            const tsInfo = getMetronomeTimeSignatureInfo();
            label.textContent = `${tsInfo.beats}/${tsInfo.den}`;
        }

        function renderMetronomePatternGrid() {
            const grid = document.getElementById('metronomePatternGrid');
            if (!grid) return;
            const tsInfo = getMetronomeTimeSignatureInfo();
            const subdivision = normalizeMetronomeSubdivision(metronomePattern.subdivision);
            const bars = normalizeMetronomeBars(metronomePattern.bars);
            const stepsPerBar = tsInfo.beats * subdivision;
            const stepsPerPattern = stepsPerBar * bars;
            const steps = ensureMetronomePatternSteps(stepsPerPattern, subdivision);

            grid.classList.toggle('disabled', !metronomePattern.enabled);
            grid.style.gridTemplateColumns = `repeat(${stepsPerBar}, minmax(32px, 1fr))`;
            grid.style.gridAutoFlow = 'row';
            grid.innerHTML = '';

            for (let i = 0; i < stepsPerPattern; i++) {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'metronome-pattern-step';
                if (steps[i]) btn.classList.add('active');
                if (i % subdivision === 0) btn.classList.add('beat-start');
                if (i % stepsPerBar === 0) btn.classList.add('bar-start');
                btn.dataset.step = String(i);
                btn.setAttribute('aria-pressed', steps[i] ? 'true' : 'false');
                if (i % subdivision === 0) {
                    const beatNumber = (Math.floor(i / subdivision) % tsInfo.beats) + 1;
                    btn.textContent = String(beatNumber);
                } else {
                    btn.textContent = '';
                }
                grid.appendChild(btn);
            }
        }

        function updateMetronomePatternUI() {
            const enableToggle = document.getElementById('metronomePatternEnable');
            const subdivisionSelect = document.getElementById('metronomePatternSubdivision');
            const barsSelect = document.getElementById('metronomePatternBars');

            if (enableToggle) enableToggle.checked = !!metronomePattern.enabled;
            if (subdivisionSelect) subdivisionSelect.value = String(normalizeMetronomeSubdivision(metronomePattern.subdivision));
            if (barsSelect) barsSelect.value = String(normalizeMetronomeBars(metronomePattern.bars));

            updateMetronomePatternTimeSig();
            renderMetronomePatternGrid();
        }

        function openMetronomePatternSettings() {
            const modal = document.getElementById('metronomePatternModal');
            if (!modal) return;
            updateMetronomePatternUI();
            modal.style.display = 'flex';
        }

        function closeMetronomePatternSettings() {
            const modal = document.getElementById('metronomePatternModal');
            if (modal) modal.style.display = 'none';
        }

        function resetMetronomePattern() {
            const subdivision = normalizeMetronomeSubdivision(metronomePattern.subdivision);
            const bars = normalizeMetronomeBars(metronomePattern.bars);
            const tsInfo = getMetronomeTimeSignatureInfo();
            const stepsPerPattern = tsInfo.beats * subdivision * bars;
            metronomePattern.steps = buildDefaultMetronomePattern(stepsPerPattern, subdivision);
            renderMetronomePatternGrid();
            saveMetronomePatternSettings();
            restartMetronomeIfRunning();
        }

        function clearMetronomePattern() {
            const subdivision = normalizeMetronomeSubdivision(metronomePattern.subdivision);
            const bars = normalizeMetronomeBars(metronomePattern.bars);
            const tsInfo = getMetronomeTimeSignatureInfo();
            const stepsPerPattern = tsInfo.beats * subdivision * bars;
            metronomePattern.steps = new Array(stepsPerPattern).fill(0);
            renderMetronomePatternGrid();
            saveMetronomePatternSettings();
            restartMetronomeIfRunning();
        }

        function saveMetronomePatternSettingsAndClose() {
            saveMetronomePatternSettings();
            restartMetronomeIfRunning();
            closeMetronomePatternSettings();
        }

        function initializeMetronomePatternUI() {
            loadMetronomePatternSettings();
            const enableToggle = document.getElementById('metronomePatternEnable');
            const subdivisionSelect = document.getElementById('metronomePatternSubdivision');
            const barsSelect = document.getElementById('metronomePatternBars');
            const grid = document.getElementById('metronomePatternGrid');

            if (enableToggle) {
                enableToggle.checked = !!metronomePattern.enabled;
                enableToggle.addEventListener('change', function() {
                    metronomePattern.enabled = !!this.checked;
                    renderMetronomePatternGrid();
                    saveMetronomePatternSettings();
                    restartMetronomeIfRunning();
                });
            }

            if (subdivisionSelect) {
                subdivisionSelect.value = String(normalizeMetronomeSubdivision(metronomePattern.subdivision));
                subdivisionSelect.addEventListener('change', function() {
                    metronomePattern.subdivision = normalizeMetronomeSubdivision(this.value);
                    renderMetronomePatternGrid();
                    saveMetronomePatternSettings();
                    restartMetronomeIfRunning();
                });
            }

            if (barsSelect) {
                barsSelect.value = String(normalizeMetronomeBars(metronomePattern.bars));
                barsSelect.addEventListener('change', function() {
                    metronomePattern.bars = normalizeMetronomeBars(this.value);
                    renderMetronomePatternGrid();
                    saveMetronomePatternSettings();
                    restartMetronomeIfRunning();
                });
            }

            if (grid) {
                grid.addEventListener('click', function(event) {
                    const target = event.target;
                    if (!target || !target.classList.contains('metronome-pattern-step')) return;
                    const index = parseInt(target.dataset.step, 10);
                    if (isNaN(index)) return;
                    if (!metronomePattern.enabled) {
                        metronomePattern.enabled = true;
                        if (enableToggle) enableToggle.checked = true;
                        grid.classList.remove('disabled');
                    }
                    metronomePattern.steps[index] = metronomePattern.steps[index] ? 0 : 1;
                    target.classList.toggle('active', !!metronomePattern.steps[index]);
                    target.setAttribute('aria-pressed', metronomePattern.steps[index] ? 'true' : 'false');
                    saveMetronomePatternSettings();
                    restartMetronomeIfRunning();
                });
            }

            updateMetronomePatternUI();
        }

        // åˆå§‹åŒ–èŠ‚æ‹å™¨éŸ³é¢‘
        function initializeMetronomeAudio() {
            try {
                metronomeAudioContext = new (window.AudioContext || window.webkitAudioContext)();
                console.log('ğŸµ èŠ‚æ‹å™¨éŸ³é¢‘åˆå§‹åŒ–æˆåŠŸ');
                return true;
            } catch (error) {
                console.error('âŒ èŠ‚æ‹å™¨éŸ³é¢‘åˆå§‹åŒ–å¤±è´¥:', error);
                return false;
            }
        }

        // æ’­æ”¾èŠ‚æ‹å™¨å£°éŸ³
        function playMetronomeSound() {
            if (!metronomeAudioContext) {
                if (!initializeMetronomeAudio()) return;
            }

            try {
                // æ¢å¤éŸ³é¢‘ä¸Šä¸‹æ–‡ï¼ˆç”¨æˆ·äº¤äº’åï¼‰
                if (metronomeAudioContext.state === 'suspended') {
                    metronomeAudioContext.resume();
                }

                const oscillator = metronomeAudioContext.createOscillator();
                const gainNode = metronomeAudioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(metronomeAudioContext.destination);

                // ä½¿ç”¨æ–¹æ³¢å’Œè‡ªç„¶éŸ³é«˜ (å‚è€ƒNiceChordèŠ‚æ‹å™¨)
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(523.25, metronomeAudioContext.currentTime); // C5éŸ³é«˜

                // è®¾ç½®è‡ªç„¶çš„éŸ³é‡åŒ…ç»œ (æ›´å¥½çš„release time)
                gainNode.gain.setValueAtTime(0.5, metronomeAudioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, metronomeAudioContext.currentTime + 0.05);

                oscillator.start(metronomeAudioContext.currentTime);
                oscillator.stop(metronomeAudioContext.currentTime + 0.05);

                // è§†è§‰åé¦ˆ - æ›´æ–°headeræŒ‡ç¤ºå™¨
                const headerIndicator = document.getElementById('headerBeatIndicator');

                if (headerIndicator) {
                    headerIndicator.classList.add('beat');
                    setTimeout(() => {
                        headerIndicator.classList.remove('beat');
                    }, 150);
                }

            } catch (error) {
                console.error('âŒ èŠ‚æ‹å™¨å£°éŸ³æ’­æ”¾å¤±è´¥:', error);
            }
        }

        // å¼€å¯/åœæ­¢èŠ‚æ‹å™¨
        function toggleMetronome() {
            const btn = document.getElementById('headerMetronomeBtn');
            const bpmInput = document.getElementById('headerMetronomeBpm');

            if (isMetronomeRunning) {
                // åœæ­¢èŠ‚æ‹å™¨
                stopMetronome();
            } else {
                // å¯åŠ¨èŠ‚æ‹å™¨
                metronomeTempo = parseInt(bpmInput.value) || 60;
                startMetronome();
            }
        }

        // å¯åŠ¨èŠ‚æ‹å™¨
        function startMetronome() {
            if (isMetronomeRunning) return;

            const btn = document.getElementById('headerMetronomeBtn');
            loadMetronomePatternSettings();
            const patternInfo = getMetronomePatternInfo(metronomeTempo);
            const interval = (patternInfo.stepDuration || (60 / metronomeTempo)) * 1000; // è®¡ç®—é—´éš”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰

            isMetronomeRunning = true;
            btn.textContent = 'ğŸµ';
            btn.title = 'åœæ­¢èŠ‚æ‹å™¨';
            metronomeStepIndex = 0;

            function tick() {
                let shouldPlay = true;
                if (patternInfo.usePattern && patternInfo.stepsPerPattern) {
                    const stepIndex = metronomeStepIndex % patternInfo.stepsPerPattern;
                    shouldPlay = patternInfo.steps[stepIndex] === 1;
                }
                if (shouldPlay) {
                    playMetronomeSound();
                }
                metronomeStepIndex++;
            }

            // ç«‹å³æ’­æ”¾ç¬¬ä¸€å£°
            tick();

            // è®¾ç½®å®šæ—¶å™¨
            metronomeInterval = setInterval(() => {
                tick();
            }, interval);

            console.log(`ğŸµ èŠ‚æ‹å™¨å·²å¯åŠ¨: ${metronomeTempo} BPM`);
        }

        // åœæ­¢èŠ‚æ‹å™¨
        function stopMetronome() {
            if (!isMetronomeRunning) return;

            const btn = document.getElementById('headerMetronomeBtn');

            isMetronomeRunning = false;
            btn.textContent = 'ğŸµ';
            btn.title = 'å¼€å§‹èŠ‚æ‹å™¨';

            if (metronomeInterval) {
                clearInterval(metronomeInterval);
                metronomeInterval = null;
            }

            console.log('ğŸ”‡ èŠ‚æ‹å™¨å·²åœæ­¢');
        }

        // æ›´æ–°èŠ‚æ‹å™¨é€Ÿåº¦
        function updateMetronomeTempo() {
            const bpmInput = document.getElementById('headerMetronomeBpm');
            metronomeTempo = parseInt(bpmInput.value) || 60;

            if (isMetronomeRunning) {
                // å¦‚æœèŠ‚æ‹å™¨æ­£åœ¨è¿è¡Œï¼Œé‡æ–°å¯åŠ¨ä»¥åº”ç”¨æ–°é€Ÿåº¦
                stopMetronome();
                startMetronome();
            }
        }

        // åŠŸèƒ½å’Œå£°å¼€å…³åˆ‡æ¢
        function toggleFunctionalHarmony() {
            const toggle = document.getElementById('functionalHarmonyToggle');
            const label = document.getElementById('harmonyModeLabel');
            const slider = toggle.nextElementSibling;
            const sliderButton = slider.querySelector('.slider-button');
            const keySettingsBtn = document.getElementById('keySettingsBtn');
            const keySettingsGroup = keySettingsBtn ? keySettingsBtn.parentElement : null;
            const jianpuGroups = document.querySelectorAll('.chord-jianpu-group');
            const jianpuToggles = document.querySelectorAll('input[id="chordJianpuToggle"]');

            if (toggle.checked) {
                // å¯ç”¨åŠŸèƒ½å’Œå£°æ¨¡å¼
                chordSettings.useFunctionalHarmony = true;
                label.textContent = translate('controls.functionalMode');
                slider.style.backgroundColor = '#FF9500';
                if (sliderButton) {
                    sliderButton.style.transform = 'translateX(26px)';
                }

                // æ˜¾ç¤ºè°ƒå·è®¾ç½®
                if (keySettingsGroup) {
                    keySettingsGroup.style.removeProperty('display');
                }
                jianpuGroups.forEach((group) => {
                    group.style.removeProperty('display');
                });
                console.log('ğŸ¼ å·²å¯ç”¨åŠŸèƒ½å’Œå£°æ¨¡å¼');
            } else {
                // å¯ç”¨å®Œå…¨éšæœºæ¨¡å¼
                chordSettings.useFunctionalHarmony = false;
                label.textContent = translate('controls.pureRandomMode');
                slider.style.backgroundColor = '#ccc';
                if (sliderButton) {
                    sliderButton.style.transform = 'translateX(0px)';
                }

                // éšè—è°ƒå·è®¾ç½®ï¼Œæ˜¾ç¤ºå›ºå®šCå¤§è°ƒè¯´æ˜
                if (keySettingsGroup) {
                    keySettingsGroup.style.display = 'none';
                }
                jianpuGroups.forEach((group) => {
                    group.style.display = 'none';
                });
                jianpuToggles.forEach((jianpuToggle) => {
                    jianpuToggle.checked = false;
                });
                if (window.displaySettings) {
                    window.displaySettings.updateJianpuChordState(false);
                }
                console.log('ğŸ² å·²å¯ç”¨å®Œå…¨éšæœºæ¨¡å¼ï¼ˆå›ºå®šCå¤§è°ƒï¼‰');
            }

            if (typeof applyJianpuChordSymbols === 'function') {
                applyJianpuChordSymbols();
            }
        }

        // ä¹å™¨æ¨¡å¼åˆ‡æ¢
        function toggleInstrumentMode() {
            const toggle = document.getElementById('instrumentModeToggle');
            const label = document.getElementById('instrumentModeLabel');
            const slider = toggle.nextElementSibling;
            const sliderButton = slider.querySelector('.slider-button');

            if (toggle.checked) {
                // å¯ç”¨é’¢ç´æ¨¡å¼
                label.textContent = translate('controls.pianoMode');
                // ğŸ”§ ä¿®å¤ (2025-10-01): æ”¹ä¸ºæ©™è‰² #FF9500ï¼Œä¸é¡µé¢æ•´ä½“é£æ ¼ä¸€è‡´
                slider.style.backgroundColor = '#FF9500'; // æ©™è‰²è¡¨ç¤ºé’¢ç´
                if (sliderButton) {
                    sliderButton.style.transform = 'translateX(26px)';
                }
                console.log('ğŸ¹ é’¢ç´å’Œå£°æ¨¡å¼å·²é€‰æ‹©');

                // ğŸ¹ é’¢ç´æ¨¡å¼ï¼šåˆ‡æ¢é«˜çº§è®¾ç½®UIï¼ˆéŸ³æ•°é€‰æ‹©å™¨ï¼‰
                const pianoAdvancedSettings = document.getElementById('pianoAdvancedSettings');
                const guitarAdvancedSettings = document.getElementById('guitarAdvancedSettings');
                if (pianoAdvancedSettings && guitarAdvancedSettings) {
                    pianoAdvancedSettings.style.display = 'block';
                    guitarAdvancedSettings.style.display = 'none';
                    console.log('ğŸ¹ é’¢ç´æ¨¡å¼ï¼šåˆ‡æ¢åˆ°éŸ³æ•°é€‰æ‹©å™¨UI');

                    // ğŸ¯ åŒæ­¥é’¢ç´éŸ³æ•°checkboxçŠ¶æ€
                    setTimeout(() => {
                        const enabledCounts = window.pianoSettings?.enabledNoteCounts || [4];
                        console.log('ğŸ¯ åŒæ­¥é’¢ç´éŸ³æ•°checkbox (åˆ‡æ¢æ¨¡å¼æ—¶):', enabledCounts);

                        // ğŸ”§ ä¿®å¤ (2025-10-01): åªå¤„ç†3-7éŸ³
                        // å…ˆå–æ¶ˆæ‰€æœ‰å‹¾é€‰
                        for (let i = 3; i <= 7; i++) {
                            const checkbox = document.getElementById(`notecount-${i}`);
                            if (checkbox) checkbox.checked = false;
                        }

                        // ç„¶åå‹¾é€‰enabledNoteCountsä¸­çš„éŸ³æ•°
                        enabledCounts.forEach(count => {
                            const checkbox = document.getElementById(`notecount-${count}`);
                            if (checkbox) {
                                checkbox.checked = true;
                                console.log(`  âœ… å·²å‹¾é€‰${count}éŸ³`);
                            }
                        });
                    }, 50);
                }

                // ğŸ¹ é’¢ç´æ¨¡å¼ï¼šåˆ‡æ¢éŸ³åŸŸè®¾ç½®UIï¼ˆåŒè°±å·éŸ³åŸŸæŒ‰é’®ï¼‰
                const pianoRangeSettings = document.getElementById('pianoRangeSettings');
                const guitarRangeSettings = document.getElementById('guitarRangeSettings');
                if (pianoRangeSettings && guitarRangeSettings) {
                    pianoRangeSettings.style.display = 'block';
                    guitarRangeSettings.style.display = 'none';
                    console.log('ğŸ¹ é’¢ç´æ¨¡å¼ï¼šåˆ‡æ¢åˆ°åŒè°±å·éŸ³åŸŸè®¾ç½®UI');
                }

                // ğŸ¼ é’¢ç´æ¨¡å¼UIé€‚é…ï¼šæ˜¾ç¤ºè°±å·è®¾ç½®æ§ä»¶
                const clefControlGroup = document.getElementById('clefControlGroup');
                if (clefControlGroup) {
                    clefControlGroup.style.visibility = 'visible';
                    clefControlGroup.style.height = 'auto';
                    clefControlGroup.style.overflow = 'visible';
                    clefControlGroup.style.margin = '';
                    clefControlGroup.style.padding = '';
                    clefControlGroup.style.removeProperty('display'); // æ¢å¤CSSç±»çš„åŸå§‹flexå±æ€§
                    console.log('ğŸ¹ é’¢ç´æ¨¡å¼ï¼šæ˜¾ç¤ºè°±å·è®¾ç½®æ§ä»¶ï¼ˆåªæœ‰å¤§è°±è¡¨å’Œé«˜éŸ³è°±å·ï¼‰');
                } else {
                    console.log('ğŸ¹ é’¢ç´æ¨¡å¼ï¼šè°±å·è®¾ç½®æ§ä»¶æœªæ‰¾åˆ°');
                }

                // ğŸ¼ é’¢ç´æ¨¡å¼ï¼šæ™ºèƒ½é»˜è®¤è°±å·è®¾ç½®
                applyIntelligentClefDefaults('piano');

                // æ£€æŸ¥é’¢ç´ç”Ÿæˆå™¨æ˜¯å¦å¯ç”¨
                if (typeof pianoChordGenerator !== 'undefined' && pianoChordGenerator && pianoChordGenerator.isInitialized) {
                    console.log('ğŸ¹ é’¢ç´ç”Ÿæˆå™¨å·²å°±ç»ª');
                } else {
                    console.log('ğŸ¹ é’¢ç´ç”Ÿæˆå™¨æ­£åœ¨åˆå§‹åŒ–...');
                }
            } else {
                // å¯ç”¨å‰ä»–æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰
                label.textContent = translate('controls.guitarMode');
                slider.style.backgroundColor = '#ccc'; // ç°è‰²é»˜è®¤çŠ¶æ€ï¼Œä¸å’Œå£°æ¨¡å¼ä¸€è‡´
                if (sliderButton) {
                    sliderButton.style.transform = 'translateX(0px)';
                }
                console.log('ğŸ¸ å‰ä»–å’Œå£°æ¨¡å¼å·²é€‰æ‹©ï¼ˆé»˜è®¤ï¼‰');

                // ğŸ¸ å‰ä»–æ¨¡å¼ï¼šåˆ‡æ¢é«˜çº§è®¾ç½®UIï¼ˆvoicingé€‰æ‹©å™¨ï¼‰
                const pianoAdvancedSettings = document.getElementById('pianoAdvancedSettings');
                const guitarAdvancedSettings = document.getElementById('guitarAdvancedSettings');
                if (pianoAdvancedSettings && guitarAdvancedSettings) {
                    pianoAdvancedSettings.style.display = 'none';
                    guitarAdvancedSettings.style.display = 'block';
                    console.log('ğŸ¸ å‰ä»–æ¨¡å¼ï¼šåˆ‡æ¢åˆ°Voicingé€‰æ‹©å™¨UI');
                }

                // ğŸ¸ å‰ä»–æ¨¡å¼ï¼šåˆ‡æ¢éŸ³åŸŸè®¾ç½®UIï¼ˆç»Ÿä¸€éŸ³åŸŸé€‰æ‹©å™¨ï¼‰
                const pianoRangeSettings = document.getElementById('pianoRangeSettings');
                const guitarRangeSettings = document.getElementById('guitarRangeSettings');
                if (pianoRangeSettings && guitarRangeSettings) {
                    pianoRangeSettings.style.display = 'none';
                    guitarRangeSettings.style.display = 'block';
                    console.log('ğŸ¸ å‰ä»–æ¨¡å¼ï¼šåˆ‡æ¢åˆ°ç»Ÿä¸€éŸ³åŸŸè®¾ç½®UI');
                }

                // ğŸ¼ å‰ä»–æ¨¡å¼ï¼šéšè—è°±å·è®¾ç½®æ§ä»¶
                const clefControlGroup = document.getElementById('clefControlGroup');
                if (clefControlGroup) {
                    clefControlGroup.style.visibility = 'hidden';
                    clefControlGroup.style.height = '0';
                    clefControlGroup.style.overflow = 'hidden';
                    clefControlGroup.style.margin = '0';
                    clefControlGroup.style.padding = '0';
                    console.log('ğŸ¸ å‰ä»–æ¨¡å¼ï¼šéšè—è°±å·è®¾ç½®æ§ä»¶ï¼ˆå‰ä»–åªä½¿ç”¨é«˜éŸ³è°±å·ï¼‰');
                } else {
                    console.log('ğŸ¸ å‰ä»–æ¨¡å¼ï¼šè°±å·è®¾ç½®æ§ä»¶æœªæ‰¾åˆ°');
                }

                // ğŸ¼ å‰ä»–æ¨¡å¼ï¼šå¼ºåˆ¶ä½¿ç”¨é«˜éŸ³è°±å·
                if (window.chordSettings) {
                    window.chordSettings.clefs = ['treble'];
                    console.log('ğŸ¸ å‰ä»–æ¨¡å¼ï¼šå¼ºåˆ¶ä½¿ç”¨é«˜éŸ³è°±å·');
                }
            }
        }

        // ğŸ¼ æ™ºèƒ½é»˜è®¤è°±å·è®¾ç½®ç³»ç»Ÿ
        function applyIntelligentClefDefaults(mode) {
            if (!window.chordSettings) {
                console.warn('âš ï¸ chordSettings æœªåˆå§‹åŒ–ï¼Œæ— æ³•è®¾ç½®æ™ºèƒ½é»˜è®¤è°±å·');
                return;
            }

            console.log(`ğŸ¯ åº”ç”¨ ${mode} æ¨¡å¼çš„æ™ºèƒ½é»˜è®¤è°±å·è®¾ç½®`);

            // å®šä¹‰æ¨¡å¼ç‰¹å®šçš„é»˜è®¤è°±å·
            const modeDefaults = {
                piano: {
                    primary: ['grand_staff'],           // é’¢ç´é¦–é€‰ï¼šå¤§è°±è¡¨
                    secondary: ['treble'],              // å¤‡é€‰ï¼šé«˜éŸ³è°±å·ï¼ˆé’¢ç´æ¨¡å¼ä¸ä½¿ç”¨ä½éŸ³è°±å·ï¼‰
                    allowedClefs: ['grand_staff', 'treble'], // é’¢ç´æ¨¡å¼å…è®¸çš„è°±å·
                    description: 'é’¢ç´æ¨¡å¼ä¼˜é€‰å¤§è°±è¡¨ï¼Œä¹Ÿå¯é€‰æ‹©é«˜éŸ³è°±å·'
                },
                guitar: {
                    primary: ['treble'],                // å‰ä»–é¦–é€‰ï¼šé«˜éŸ³è°±å·
                    secondary: ['treble'],              // å‰ä»–æ¨¡å¼åªç”¨é«˜éŸ³è°±å·
                    allowedClefs: ['treble'],           // å‰ä»–æ¨¡å¼åªå…è®¸é«˜éŸ³è°±å·
                    description: 'å‰ä»–æ¨¡å¼å›ºå®šä½¿ç”¨é«˜éŸ³è°±å·'
                }
            };

            const defaults = modeDefaults[mode];
            if (!defaults) {
                console.warn(`âš ï¸ æœªçŸ¥æ¨¡å¼: ${mode}`);
                return;
            }

            // ğŸ¹ é’¢ç´æ¨¡å¼ï¼šæ€»æ˜¯ä¼˜å…ˆè®¾ç½®ä¸ºå¤§è°±è¡¨
            if (mode === 'piano') {
                window.chordSettings.clefs = ['grand_staff'];
                console.log(`ğŸ¹ é’¢ç´æ¨¡å¼ï¼šè‡ªåŠ¨è®¾ç½®ä¸ºå¤§è°±è¡¨`);
                console.log(`ğŸ“ è¯´æ˜: ${defaults.description}`);
                // æ›´æ–°UIæ˜¾ç¤º
                updateClefSettingsDisplay();
            } else {
                // å…¶ä»–æ¨¡å¼ï¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²æœ‰è°±å·è®¾ç½®
                const hasUserClefs = window.chordSettings.clefs &&
                                    window.chordSettings.clefs.length > 0;

                if (!hasUserClefs) {
                    // ğŸ¯ é¦–æ¬¡ä½¿ç”¨ï¼šåº”ç”¨æ¨¡å¼é»˜è®¤è®¾ç½®
                    window.chordSettings.clefs = [...defaults.primary];
                    console.log(`ğŸ¼ ${mode}æ¨¡å¼é¦–æ¬¡ä½¿ç”¨ï¼Œè®¾ç½®é»˜è®¤è°±å·: ${defaults.primary.join(', ')}`);
                    console.log(`ğŸ“ è¯´æ˜: ${defaults.description}`);

                    // æ›´æ–°UIæ˜¾ç¤º
                    updateClefSettingsDisplay();
                } else {
                    // ğŸ”„ å·²æœ‰è®¾ç½®ï¼šéªŒè¯å¹¶è¿‡æ»¤ä¸å…¼å®¹çš„è°±å·
                    const currentClefs = window.chordSettings.clefs;
                    const allowedClefs = defaults.allowedClefs;

                    // è¿‡æ»¤å‡ºå½“å‰æ¨¡å¼å…è®¸çš„è°±å·
                    const filteredClefs = currentClefs.filter(clef => allowedClefs.includes(clef));

                    if (filteredClefs.length === 0) {
                        // å¦‚æœæ²¡æœ‰å…¼å®¹çš„è°±å·ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®
                        window.chordSettings.clefs = [...defaults.primary];
                        console.log(`ğŸ”§ ${mode}æ¨¡å¼ï¼šæ— å…¼å®¹è°±å·ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®: ${defaults.primary.join(', ')}`);
                        updateClefSettingsDisplay();
                    } else if (filteredClefs.length !== currentClefs.length) {
                        // å¦‚æœæœ‰ä¸å…¼å®¹çš„è°±å·è¢«è¿‡æ»¤æ‰
                        const removedClefs = currentClefs.filter(clef => !allowedClefs.includes(clef));
                        window.chordSettings.clefs = filteredClefs;
                        console.log(`ğŸ”§ ${mode}æ¨¡å¼ï¼šç§»é™¤ä¸å…¼å®¹è°±å· [${removedClefs.join(', ')}]ï¼Œä¿ç•™ [${filteredClefs.join(', ')}]`);
                        updateClefSettingsDisplay();
                    } else {
                        // æ‰€æœ‰è°±å·éƒ½å…¼å®¹
                        console.log(`âœ… ${mode}æ¨¡å¼ï¼šä¿æŒç”¨æˆ·è®¾ç½® ${currentClefs.join(', ')}`);
                    }
                }
            }

            // ä¿å­˜æ¨¡å¼åå¥½ï¼ˆç”¨äºä¸‹æ¬¡å¯åŠ¨ï¼‰
            if (!window.chordSettings.modePreferences) {
                window.chordSettings.modePreferences = {};
            }
            window.chordSettings.modePreferences[mode] = {
                lastUsedClefs: [...(window.chordSettings.clefs || [])],
                timestamp: new Date().toISOString()
            };

            console.log(`ğŸ¯ ${mode}æ¨¡å¼æ™ºèƒ½é»˜è®¤è®¾ç½®å®Œæˆ`);
        }

        // ğŸ¹ é’¢ç´æ¨¡å¼ï¼šéŸ³æ•°é€‰æ‹©å…¨é€‰/å–æ¶ˆå…¨é€‰
        function toggleSelectAllNoteCounts() {
            const checkboxes = document.querySelectorAll('#pianoAdvancedSettings input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            const text = document.getElementById('noteCountSelectAllText');

            checkboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
            });

            if (text) {
                text.textContent = allChecked ? translate('button.selectAll') : translate('button.unselectAll');
            }

            console.log(`ğŸ¹ éŸ³æ•°é€‰æ‹©: ${allChecked ? 'å–æ¶ˆå…¨é€‰' : 'å…¨é€‰'}`);
        }

        // ğŸ¸ å‰ä»–æ¨¡å¼ï¼švoicingé€‰æ‹©å…¨é€‰/å–æ¶ˆå…¨é€‰
        function toggleSelectAllVoicings() {
            const checkboxes = document.querySelectorAll('#guitarAdvancedSettings input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            const text = document.getElementById('voicingSelectAllText');

            checkboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
            });

            if (text) {
                text.textContent = allChecked ? translate('button.selectAll') : translate('button.unselectAll');
            }

            console.log(`ğŸ¸ Voicingé€‰æ‹©: ${allChecked ? 'å–æ¶ˆå…¨é€‰' : 'å…¨é€‰'}`);
        }

        // ğŸ¼ æ›´æ–°è°±å·è®¾ç½®æ˜¾ç¤ºï¼ˆè¾…åŠ©å‡½æ•°ï¼‰
        function updateClefSettingsDisplay() {
            // å¦‚æœè°±å·è®¾ç½®å¼¹çª—å½“å‰å¯è§ï¼Œæ›´æ–°å¤é€‰æ¡†çŠ¶æ€
            const clefModal = document.getElementById('clefModal');
            if (clefModal && clefModal.style.display !== 'none') {
                const checkboxes = clefModal.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    const clefType = checkbox.value;
                    checkbox.checked = window.chordSettings.clefs &&
                                     window.chordSettings.clefs.includes(clefType);
                });
                console.log('ğŸ¼ å·²æ›´æ–°è°±å·è®¾ç½®å¼¹çª—æ˜¾ç¤ºçŠ¶æ€');
            }
        }

        // ğŸ¼ äº”çº¿è°±æ˜¾ç¤º/éšè—æ§åˆ¶
        function toggleStaffDisplay() {
            applyStaffDisplayState();
        }

        // åº”ç”¨äº”çº¿è°±æ˜¾ç¤ºçŠ¶æ€ - ç®€åŒ–ç›´æ¥çš„æ–¹æ³•
        function applyStaffDisplayState() {
            // ğŸ”§ ä¿®å¤ (2025-10-01): ä½¿ç”¨querySelectorè·å–ç¬¬ä¸€ä¸ªtoggleï¼ˆæ”¯æŒå¤šä¸ªtoggleï¼‰
            const toggle = document.querySelector('input[id="staffDisplayToggle"]');
            const scoreContainer = document.getElementById('score'); // ä¿®å¤ï¼šæ­£ç¡®çš„IDæ˜¯'score'

            if (toggle && scoreContainer) {
                const svg = scoreContainer.querySelector('svg');
                if (svg) {
                    console.log(`ğŸ¼ åº”ç”¨äº”çº¿è°±æ˜¾ç¤ºçŠ¶æ€: ${toggle.checked ? 'æ˜¾ç¤º' : 'éšè—'}`);

                    if (toggle.checked) {
                        // æ˜¾ç¤ºäº”çº¿è°± - æ¢å¤æ‰€æœ‰äº”çº¿è°±å…ƒç´ å’Œå°èŠ‚æ•°
                        const staffElements = svg.querySelectorAll([
                            '.vf-clef',           // è°±å·
                            '.vf-timesignature',  // æ‹å·
                            '.vf-stavenote',      // éŸ³ç¬¦
                            '.vf-note',           // éŸ³ç¬¦
                            '.vf-notehead',       // éŸ³ç¬¦å¤´
                            '.vf-stem',           // ç¬¦æ†
                            '.vf-flag',           // ç¬¦å°¾
                            '.vf-beam',           // è¿éŸ³çº¿
                            'path',               // äº”çº¿è°±çº¿æ¡
                            'line',               // è°±çº¿
                            'rect'                // å°èŠ‚çº¿
                        ].join(', '));

                        // æ˜¾ç¤ºäº”çº¿è°±å…ƒç´ 
                        staffElements.forEach(el => {
                            el.style.display = '';
                            el.style.visibility = 'visible';
                            el.style.opacity = '1';
                        });

                        // æ¢å¤æ–‡æœ¬å…ƒç´ ï¼ˆå°èŠ‚æ•°æ€»æ˜¯æ˜¾ç¤ºï¼Œå’Œå¼¦ä»£å·æ ¹æ®å¼€å…³çŠ¶æ€ï¼‰
                        const allTextElements = svg.querySelectorAll('text');
                        let restoredMeasureNumbers = 0;
                        let restoredChordSymbols = 0;

                        allTextElements.forEach(textEl => {
                            if (isChordSymbolElement(textEl)) {
                                // å’Œå¼¦ä»£å·ï¼šæ ¹æ®å’Œå¼¦ä»£å·å¼€å…³çŠ¶æ€å†³å®šæ˜¯å¦æ˜¾ç¤º
                                if (window.displaySettings.chordSymbolsVisible) {
                                    textEl.style.display = '';
                                    textEl.style.visibility = 'visible';
                                    textEl.style.opacity = '1';
                                    restoredChordSymbols++;
                                } else {
                                    // å’Œå¼¦ä»£å·å¼€å…³å…³é—­æ—¶ï¼Œä¿æŒéšè—
                                    textEl.style.display = 'none';
                                    textEl.style.visibility = 'hidden';
                                    textEl.style.opacity = '0';
                                }
                            } else {
                                // å°èŠ‚æ•°å’Œå…¶ä»–æ–‡æœ¬ï¼šæ€»æ˜¯æ˜¾ç¤º
                                textEl.style.display = '';
                                textEl.style.visibility = 'visible';
                                textEl.style.opacity = '1';
                                restoredMeasureNumbers++;
                            }
                        });

                        console.log(`ğŸ¼ âœ… æ˜¾ç¤ºäº†äº”çº¿è°± (${staffElements.length}ä¸ªå…ƒç´ ) å’Œå°èŠ‚æ•° (${restoredMeasureNumbers}ä¸ª)ï¼Œå’Œå¼¦ä»£å· (${restoredChordSymbols}ä¸ªï¼Œæ ¹æ®å¼€å…³çŠ¶æ€)`);
                    } else {
                        // éšè—äº”çº¿è°±å’Œå°èŠ‚æ•°ï¼Œä½†ä¿ç•™å’Œå¼¦ä»£å·
                        const staffElements = svg.querySelectorAll([
                            '.vf-clef',           // è°±å·
                            '.vf-timesignature',  // æ‹å·
                            '.vf-stavenote',      // éŸ³ç¬¦
                            '.vf-note',           // éŸ³ç¬¦
                            '.vf-notehead',       // éŸ³ç¬¦å¤´
                            '.vf-stem',           // ç¬¦æ†
                            '.vf-flag',           // ç¬¦å°¾
                            '.vf-beam',           // è¿éŸ³çº¿
                            'path',               // äº”çº¿è°±çº¿æ¡
                            'line',               // è°±çº¿
                            'rect'                // å°èŠ‚çº¿
                        ].join(', '));

                        // éšè—äº”çº¿è°±å…ƒç´ 
                        staffElements.forEach(el => {
                            el.style.display = 'none';
                            el.style.visibility = 'hidden';
                            el.style.opacity = '0';
                        });

                        // éšè—å°èŠ‚æ•°ä½†ä¿ç•™å’Œå¼¦ä»£å·
                        const allTextElements = svg.querySelectorAll('text');
                        let hiddenMeasureNumbers = 0;
                        let preservedChordSymbols = 0;

                        allTextElements.forEach(textEl => {
                            if (isChordSymbolElement(textEl)) {
                                // å’Œå¼¦ä»£å·ï¼šæ ¹æ®å’Œå¼¦ä»£å·å¼€å…³çŠ¶æ€å†³å®šæ˜¯å¦æ˜¾ç¤º
                                if (window.displaySettings.chordSymbolsVisible) {
                                    textEl.style.display = '';
                                    textEl.style.visibility = 'visible';
                                    textEl.style.opacity = '1';
                                    preservedChordSymbols++;
                                } else {
                                    // å’Œå¼¦ä»£å·å¼€å…³å…³é—­æ—¶ï¼Œä¿æŒéšè—
                                    textEl.style.display = 'none';
                                    textEl.style.visibility = 'hidden';
                                    textEl.style.opacity = '0';
                                }
                            } else {
                                // éšè—å…¶ä»–æ–‡æœ¬å…ƒç´ ï¼ˆåŒ…æ‹¬å°èŠ‚æ•°ï¼‰
                                textEl.style.display = 'none';
                                textEl.style.visibility = 'hidden';
                                textEl.style.opacity = '0';
                                hiddenMeasureNumbers++;
                            }
                        });

                        console.log(`ğŸ¼ âœ… éšè—äº†äº”çº¿è°± (${staffElements.length}ä¸ªå…ƒç´ ) å’Œå°èŠ‚æ•° (${hiddenMeasureNumbers}ä¸ª)ï¼Œä¿ç•™å’Œå¼¦ä»£å· (${preservedChordSymbols}ä¸ª)`);
                    }
                } else {
                    console.warn('âš ï¸ æœªæ‰¾åˆ°SVGå…ƒç´ ï¼Œæ— æ³•åº”ç”¨äº”çº¿è°±æ˜¾ç¤ºæ§åˆ¶');
                }
            } else {
                console.warn('âš ï¸ æœªæ‰¾åˆ°toggleæˆ–scoreContainerå…ƒç´ ');
                console.log('toggle:', toggle);
                console.log('scoreContainer:', scoreContainer);
            }
        }

        // æ£€æŸ¥å…ƒç´ æ˜¯å¦æ˜¯å’Œå¼¦ä»£å· - åŸºäºä½ çš„æ™ºèƒ½è¯†åˆ«ç³»ç»Ÿè®¾è®¡
        function isChordSymbolElement(element) {
            if (element.tagName !== 'text') return false;

            const content = element.textContent?.trim();
            if (!content) return false;

            // æ™ºèƒ½å’Œå¼¦ä»£å·è¯†åˆ«ç³»ç»Ÿï¼ˆå‚ç…§ä½ çš„è®¾è®¡ï¼‰
            const isChordSymbol = (
                content.match(/^[A-G][#b]?/) ||           // æ ¹éŸ³ (A-Gå¼€å¤´)
                content.includes('maj') ||                // å’Œå¼¦ç±»å‹å…³é”®è¯
                content.includes('min') ||
                content.includes('dim') ||
                content.includes('aug') ||
                content.includes('sus') ||
                content.match(/\b[79](sus)?[24]?\b/) ||   // æ•°å­—å’Œå¼¦æ ‡è®°
                content.match(/\b(11|13)\b/) ||
                content.match(/\badd[69]\b/) ||
                content.includes('Â°') ||                  // ç‰¹æ®Šç¬¦å·
                content.includes('Ã¸') ||
                content.includes('+') ||
                content.includes('Î”') ||
                content.includes('/') && content.match(/[A-G].*\/.*[A-G]/) || // åˆ†æ•°å’Œå¼¦
                content.match(/^(maj|min|dim|aug)\d*$/) ||
                content.match(/^[IVX]+[Â°+]?$/)           // ç½—é©¬æ•°å­—å’Œå¼¦æ ‡è®°
            );

            // æ’é™¤æœºåˆ¶ï¼ˆå‚ç…§ä½ çš„è®¾è®¡ï¼‰
            const isNotChordSymbol = (
                content.match(/^\d+$/) ||        // çº¯æ•°å­—ï¼ˆå°èŠ‚å·ï¼‰
                content.match(/^[pmf]+$/) ||     // åŠ›åº¦è®°å·
                content.length > 10 ||           // è¿‡é•¿æ–‡æœ¬
                content.includes('measure') ||   // å°èŠ‚ç›¸å…³
                content.includes('staff') ||     // è°±çº¿ç›¸å…³
                content.includes('key') ||       // è°ƒå·ç›¸å…³
                content.includes('time')         // æ‹å·ç›¸å…³
            );

            return isChordSymbol && !isNotChordSymbol;
        }

        // ğŸŒ å…¨å±€çŠ¶æ€è®°å½• - ç”¨äºé˜²é—ªçƒå’ŒæŒä¹…åŒ–éšè—
        window.displaySettings = {
            staffVisible: true,     // é»˜è®¤æ˜¾ç¤ºäº”çº¿è°±
            chordSymbolsVisible: true,  // é»˜è®¤æ˜¾ç¤ºå’Œå¼¦ä»£å·
            jianpuChordSymbols: false,  // åŠŸèƒ½å’Œå£°ç®€è°±ä»£å·

            // æ›´æ–°çŠ¶æ€çš„æ–¹æ³•
            updateStaffState: function(visible) {
                this.staffVisible = visible;
                console.log(`ğŸŒ å…¨å±€çŠ¶æ€æ›´æ–°: äº”çº¿è°±=${visible ? 'æ˜¾ç¤º' : 'éšè—'}`);
            },
            updateChordState: function(visible) {
                this.chordSymbolsVisible = visible;
                console.log(`ğŸŒ å…¨å±€çŠ¶æ€æ›´æ–°: å’Œå¼¦ä»£å·=${visible ? 'æ˜¾ç¤º' : 'éšè—'}`);
            },
            updateJianpuChordState: function(enabled) {
                this.jianpuChordSymbols = enabled;
                console.log(`ğŸŒ å…¨å±€çŠ¶æ€æ›´æ–°: ç®€è°±ä»£å·=${enabled ? 'å¯ç”¨' : 'å…³é—­'}`);
            }
        };

        // å°†å‡½æ•°æ·»åŠ åˆ°å…¨å±€windowå¯¹è±¡ï¼Œä¾¿äºå…¶ä»–æ¨¡å—è°ƒç”¨
        window.applyStaffDisplayState = applyStaffDisplayState;
        window.applyChordSymbolsState = applyChordSymbolsState;
        window.applyJianpuChordSymbols = applyJianpuChordSymbols;
        window.isChordSymbolElement = isChordSymbolElement;

        // ğŸ§ª æ‰‹åŠ¨æµ‹è¯•å‡½æ•° - ç”¨æˆ·å¯ä»¥åœ¨æ§åˆ¶å°ä¸­ç›´æ¥è°ƒç”¨
        window.testStaffToggle = function() {
            console.log('ğŸ§ª æ‰‹åŠ¨æµ‹è¯•äº”çº¿è°±å¼€å…³');
            const toggle = document.getElementById('staffDisplayToggle');
            const svg = document.querySelector('#score svg'); // ä¿®å¤ï¼šæ­£ç¡®çš„å®¹å™¨ID
            console.log('å¼€å…³å…ƒç´ :', toggle);
            console.log('SVGå…ƒç´ :', svg);
            console.log('å¼€å…³çŠ¶æ€:', toggle ? toggle.checked : 'null');
            if (toggle && svg) {
                applyStaffDisplayState();
            } else {
                console.error('âŒ æµ‹è¯•å¤±è´¥ï¼šæ‰¾ä¸åˆ°å¿…è¦å…ƒç´ ');
            }
        };

        window.testChordToggle = function() {
            console.log('ğŸ§ª æ‰‹åŠ¨æµ‹è¯•å’Œå¼¦ä»£å·å¼€å…³');
            const toggle = document.getElementById('chordSymbolsToggle');
            const svg = document.querySelector('#score svg'); // ä¿®å¤ï¼šæ­£ç¡®çš„å®¹å™¨ID
            console.log('å¼€å…³å…ƒç´ :', toggle);
            console.log('SVGå…ƒç´ :', svg);
            console.log('å¼€å…³çŠ¶æ€:', toggle ? toggle.checked : 'null');
            if (toggle && svg) {
                applyChordSymbolsState();
            } else {
                console.error('âŒ æµ‹è¯•å¤±è´¥ï¼šæ‰¾ä¸åˆ°å¿…è¦å…ƒç´ ');
            }
        };

        // ğŸ¼ å’Œå¼¦ä»£å·æ˜¾ç¤º/éšè—æ§åˆ¶
        function toggleChordSymbols() {
            applyChordSymbolsState();
        }

        // åº”ç”¨å’Œå¼¦ä»£å·æ˜¾ç¤ºçŠ¶æ€ - ç®€åŒ–æµ‹è¯•æ–¹æ³•
        function applyChordSymbolsState() {
            // ğŸ”§ ä¿®å¤ (2025-10-01): ä½¿ç”¨querySelectorè·å–ç¬¬ä¸€ä¸ªtoggleï¼ˆæ”¯æŒå¤šä¸ªtoggleï¼‰
            const toggle = document.querySelector('input[id="chordSymbolsToggle"]');
            const scoreContainer = document.getElementById('score'); // ä¿®å¤ï¼šæ­£ç¡®çš„IDæ˜¯'score'
            const jianpuEnabled = !!(window.displaySettings && window.displaySettings.jianpuChordSymbols);

            if (toggle && scoreContainer) {
                const svg = scoreContainer.querySelector('svg');
                if (svg) {
                    console.log(`ğŸµ åº”ç”¨å’Œå¼¦ä»£å·æ˜¾ç¤ºçŠ¶æ€: ${toggle.checked ? 'æ˜¾ç¤º' : 'éšè—'}`);

                    // æ™ºèƒ½è¯†åˆ«å’Œå¼¦ä»£å·æ–‡æœ¬ï¼Œæ’é™¤å°èŠ‚æ•°
                    const allTextElements = svg.querySelectorAll('text, .vf-text');
                    let chordCount = 0;
                    let measureCount = 0;
                    let debugInfo = [];

                    allTextElements.forEach((text, index) => {
                        const content = text.textContent?.trim();
                        // ä¿®å¤ï¼šæ­£ç¡®è·å–SVGå…ƒç´ çš„classå±æ€§
                        const className = (text.className && text.className.baseVal) || text.getAttribute('class') || '';

                        const isJianpuTarget = text.dataset && text.dataset.jianpuTarget === 'true';
                        // æ£€æŸ¥æ˜¯å¦æ˜¯å°èŠ‚å·ï¼ˆçº¯æ•°å­—ï¼‰
                        const isMeasureNumber = content.match(/^\d+$/);

                        if (isJianpuTarget) {
                            // ç®€è°±ä»£å·éœ€è¦å‚ä¸æ˜¾éšæ§åˆ¶
                            chordCount++;
                            debugInfo.push(`${index+1}: "${content}" [ç®€è°±ä»£å·-å¤„ç†] (class: "${className}")`);

                            if (jianpuEnabled) {
                                text.style.display = '';
                                text.style.visibility = 'visible';
                                text.style.opacity = '1';
                            } else {
                                text.style.display = 'none';
                                text.style.visibility = 'hidden';
                                text.style.opacity = '0';
                            }
                        } else if (isMeasureNumber) {
                            // ä¿ç•™å°èŠ‚å·ï¼Œä¸éšè—
                            measureCount++;
                            debugInfo.push(`${index+1}: "${content}" [å°èŠ‚å·-ä¿ç•™]`);
                        } else if (isChordSymbolElement(text) || (className && className.includes && className.includes('vf-text'))) {
                            // å¤„ç†å’Œå¼¦ä»£å·
                            chordCount++;
                            debugInfo.push(`${index+1}: "${content}" [å’Œå¼¦ä»£å·-å¤„ç†] (class: "${className}")`);

                            if (toggle.checked || jianpuEnabled) {
                                text.style.display = '';
                                text.style.visibility = 'visible';
                                text.style.opacity = '1';
                            } else {
                                text.style.display = 'none';
                                text.style.visibility = 'hidden';
                                text.style.opacity = '0';
                            }
                        } else {
                            // å…¶ä»–æ–‡æœ¬å…ƒç´ ï¼Œä¿ç•™ä¸å¤„ç†
                            debugInfo.push(`${index+1}: "${content}" [å…¶ä»–æ–‡æœ¬-ä¿ç•™] (class: "${className}")`);
                        }
                    });

                    console.log(`ğŸµ âœ… å¤„ç†äº†${chordCount}ä¸ªå’Œå¼¦ä»£å·ï¼Œä¿ç•™äº†${measureCount}ä¸ªå°èŠ‚å·`);
                    console.log(`ğŸµ ğŸ“‹ è¯¦ç»†ä¿¡æ¯:`, debugInfo.slice(0, 10)); // åªæ˜¾ç¤ºå‰10ä¸ªé¿å…æ—¥å¿—è¿‡é•¿

                    if (chordCount === 0) {
                        console.log(`ğŸµ âš ï¸ æœªæ‰¾åˆ°å’Œå¼¦ä»£å·ï¼Œæ€»å…±æœ‰${allTextElements.length}ä¸ªæ–‡æœ¬å…ƒç´ `);
                    }
                } else {
                    console.warn('âš ï¸ æœªæ‰¾åˆ°SVGå…ƒç´ ï¼Œæ— æ³•åº”ç”¨å’Œå¼¦ä»£å·æ˜¾ç¤ºæ§åˆ¶');
                }
            } else {
                console.warn('âš ï¸ æœªæ‰¾åˆ°toggleæˆ–scoreContainerå…ƒç´ ');
                console.log('toggle:', toggle);
                console.log('scoreContainer:', scoreContainer);
            }
        }

        function getChordTextElements(svg) {
            const selectors = [
                'text[id*="chord"]',
                'text[id*="Chord"]',
                'text[id*="harmony"]',
                'text[id*="Harmony"]',
                'g[id*="chord"] text',
                'g[id*="Chord"] text',
                'g[id*="harmony"] text',
                'g[id*="Harmony"] text'
            ];
            const elements = Array.from(svg.querySelectorAll(selectors.join(', ')));
            const marked = Array.from(svg.querySelectorAll('text[data-jianpu-target="true"]'));
            if (elements.length > 0) {
                return Array.from(new Set([...elements, ...marked]));
            }
            const fallback = Array.from(svg.querySelectorAll('text')).filter((el) => isChordSymbolElement(el));
            return Array.from(new Set([...fallback, ...marked]));
        }

        function applyJianpuChordSymbols() {
            const toggle = document.querySelector('input[id="chordJianpuToggle"]');
            const scoreContainer = document.getElementById('score');
            if (!scoreContainer) return;
            const svg = scoreContainer.querySelector('svg');
            if (!svg) return;

            const chords = window.currentChords;
            if (!chords || !Array.isArray(chords.progression)) return;

            const useJianpu = !!(toggle && toggle.checked);
            const symbolToggle = document.querySelector('input[id="chordSymbolsToggle"]');
            const showChordSymbols = !symbolToggle || symbolToggle.checked;
            const showSymbols = useJianpu || showChordSymbols;
            const chordTextElements = getChordTextElements(svg);

            chordTextElements.forEach((element, index) => {
                if (index >= chords.progression.length) return;
                const chord = chords.progression[index];
                if (!chord) return;

                const currentText = (element.textContent || '').trim();
                const slashIndex = currentText.indexOf('/');
                const inversionPart = slashIndex !== -1 ? currentText.slice(slashIndex) : '';

                if (useJianpu && typeof getJianpuChordSymbol === 'function') {
                    if (element.dataset && element.dataset.origChordHtml === undefined) {
                        element.dataset.origChordHtml = element.innerHTML;
                    }
                    const expected = getJianpuChordSymbol(chord, chords.key);
                    if (expected) {
                        element.textContent = expected + inversionPart;
                        if (element.dataset) element.dataset.jianpuApplied = 'true';
                    }
                    if (element.dataset) element.dataset.jianpuTarget = 'true';
                } else if (element.dataset && element.dataset.jianpuApplied === 'true') {
                    if (element.dataset.origChordHtml !== undefined) {
                        element.innerHTML = element.dataset.origChordHtml;
                    }
                    delete element.dataset.jianpuApplied;
                    delete element.dataset.origChordHtml;
                }

                if (!useJianpu && element.dataset) {
                    delete element.dataset.jianpuTarget;
                }

                if (!showSymbols) {
                    element.style.display = 'none';
                    element.style.visibility = 'hidden';
                    element.style.opacity = '0';
                } else {
                    element.style.display = '';
                    element.style.visibility = 'visible';
                    element.style.opacity = '1';
                }
            });
        }

        // åˆå§‹åŒ–åŠŸèƒ½å’Œå£°å¼€å…³
        function initializeFunctionalHarmonyToggle(retryCount = 0) {
            const maxRetries = 50; // æœ€å¤šé‡è¯•50æ¬¡ï¼ˆ5ç§’ï¼‰

            // æ£€æŸ¥chordSettingsæ˜¯å¦å·²å®šä¹‰
            if (typeof chordSettings === 'undefined') {
                if (retryCount < maxRetries) {
                    console.warn(`âš ï¸ chordSettingsæœªå®šä¹‰ï¼Œå»¶è¿Ÿåˆå§‹åŒ–åŠŸèƒ½å’Œå£°å¼€å…³ (${retryCount + 1}/${maxRetries})`);
                    setTimeout(() => initializeFunctionalHarmonyToggle(retryCount + 1), 100);
                } else {
                    console.error('âŒ åŠŸèƒ½å’Œå£°å¼€å…³åˆå§‹åŒ–å¤±è´¥ï¼šchordSettingsåœ¨5ç§’å†…æœªå®šä¹‰ï¼Œåœæ­¢é‡è¯•');
                }
                return;
            }

            const toggle = document.getElementById('functionalHarmonyToggle');
            const label = document.getElementById('harmonyModeLabel');

            // è®¾ç½®åˆå§‹çŠ¶æ€ - é»˜è®¤å¯ç”¨åŠŸèƒ½å’Œå£°æ¨¡å¼
            chordSettings.useFunctionalHarmony = chordSettings.useFunctionalHarmony !== undefined ? chordSettings.useFunctionalHarmony : true;
            toggle.checked = chordSettings.useFunctionalHarmony;

            // åˆå§‹åŒ–æ˜¾ç¤ºçŠ¶æ€
            const slider = toggle.nextElementSibling;
            const sliderButton = slider ? slider.querySelector('.slider-button') : null;

            if (chordSettings.useFunctionalHarmony) {
                label.textContent = translate('controls.functionalMode');
                if (slider) slider.style.backgroundColor = '#FF9500';
                if (sliderButton) sliderButton.style.transform = 'translateX(26px)';
            } else {
                label.textContent = translate('controls.randomMode');
                if (slider) slider.style.backgroundColor = '#ccc';
                if (sliderButton) sliderButton.style.transform = 'translateX(0px)';
            }

            // åˆå§‹åŒ–æ—¶åº”ç”¨å½“å‰çŠ¶æ€çš„UIè®¾ç½®
            toggleFunctionalHarmony();

            console.log('ğŸ¯ åŠŸèƒ½å’Œå£°å¼€å…³å·²åˆå§‹åŒ–ï¼Œé»˜è®¤çŠ¶æ€ï¼š', chordSettings.useFunctionalHarmony ? 'åŠŸèƒ½å’Œå£°æ¨¡å¼' : 'å®Œå…¨éšæœºæ¨¡å¼');
        }

        // åˆå§‹åŒ–ä¹å™¨æ¨¡å¼å¼€å…³
        function initializeInstrumentModeToggle(retryCount = 0, forceReset = false) {
            const maxRetries = 50; // æœ€å¤šé‡è¯•50æ¬¡ï¼ˆ5ç§’ï¼‰

            // æ£€æŸ¥chordSettingsæ˜¯å¦å·²å®šä¹‰
            if (typeof chordSettings === 'undefined') {
                if (retryCount < maxRetries) {
                    console.warn(`âš ï¸ chordSettingsæœªå®šä¹‰ï¼Œå»¶è¿Ÿåˆå§‹åŒ–ä¹å™¨æ¨¡å¼å¼€å…³ (${retryCount + 1}/${maxRetries})`);
                    setTimeout(() => initializeInstrumentModeToggle(retryCount + 1, forceReset), 100);
                } else {
                    console.error('âŒ ä¹å™¨æ¨¡å¼å¼€å…³åˆå§‹åŒ–å¤±è´¥ï¼šchordSettingsåœ¨5ç§’å†…æœªå®šä¹‰ï¼Œåœæ­¢é‡è¯•');
                }
                return;
            }

            const toggle = document.getElementById('instrumentModeToggle');
            const label = document.getElementById('instrumentModeLabel');
            const slider = toggle.nextElementSibling;
            const sliderButton = slider.querySelector('.slider-button');
            const clefControlGroup = document.getElementById('clefControlGroup');

            // ğŸ¯ æ™ºèƒ½åˆå§‹åŒ–ï¼šåªåœ¨é¦–æ¬¡åˆå§‹åŒ–æˆ–å¼ºåˆ¶é‡ç½®æ—¶è®¾ç½®é»˜è®¤çŠ¶æ€
            const currentState = toggle.checked;
            const isFirstInit = (currentState === null || currentState === undefined || retryCount === 0);

            if (forceReset || isFirstInit) {
                // é¦–æ¬¡åˆå§‹åŒ–æˆ–å¼ºåˆ¶é‡ç½®ï¼šè®¾ç½®ä¸ºé»˜è®¤çŠ¶æ€ï¼ˆå‰ä»–æ¨¡å¼ï¼‰
                toggle.checked = false;
                label.textContent = 'å‰ä»–å’Œå£°';
                slider.style.backgroundColor = '#ccc';
                if (sliderButton) {
                    sliderButton.style.transform = 'translateX(0px)';
                }
                console.log('ğŸ¯ ä¹å™¨æ¨¡å¼å¼€å…³åˆå§‹åŒ–ä¸ºé»˜è®¤çŠ¶æ€ï¼ˆå‰ä»–æ¨¡å¼ï¼‰');
            } else {
                // å·²æœ‰çŠ¶æ€ï¼šä¿æŒç°æœ‰çŠ¶æ€
                console.log(`ğŸ›¡ï¸ ä¹å™¨æ¨¡å¼å¼€å…³ä¿æŒç°æœ‰çŠ¶æ€: ${toggle.checked ? 'é’¢ç´æ¨¡å¼' : 'å‰ä»–æ¨¡å¼'}`);
                // ç¡®ä¿UIä¸çŠ¶æ€åŒæ­¥
                if (toggle.checked) {
                    label.textContent = 'é’¢ç´å’Œå£°';
                    // ğŸ”§ ä¿®å¤ (2025-10-01): æ”¹ä¸ºæ©™è‰² #FF9500
                    slider.style.backgroundColor = '#FF9500';
                    if (sliderButton) {
                        sliderButton.style.transform = 'translateX(26px)';
                    }
                } else {
                    label.textContent = 'å‰ä»–å’Œå£°';
                    slider.style.backgroundColor = '#ccc';
                    if (sliderButton) {
                        sliderButton.style.transform = 'translateX(0px)';
                    }
                }
            }

            // ğŸ¸ å‰ä»–æ¨¡å¼ï¼šéšè—è°±å·é€‰æ‹©æ§ä»¶ï¼ˆä»…é’¢ç´æ¨¡å¼éœ€è¦ï¼‰
            if (clefControlGroup) {
                clefControlGroup.style.visibility = 'hidden';
                clefControlGroup.style.height = '0';
                clefControlGroup.style.overflow = 'hidden';
                clefControlGroup.style.margin = '0';
                clefControlGroup.style.padding = '0';
            }

            console.log('ğŸ¯ ä¹å™¨æ¨¡å¼å¼€å…³å·²åˆå§‹åŒ–ï¼ˆå‰ä»–æ¨¡å¼ï¼‰ - è°±å·é€‰æ‹©å·²éšè—');
        }

        // ç›‘å¬BPMè¾“å…¥å˜åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            const bpmInput = document.getElementById('headerMetronomeBpm');
            if (bpmInput) {
                bpmInput.addEventListener('change', updateMetronomeTempo);
                bpmInput.addEventListener('input', updateMetronomeTempo);
            }
            initializeMetronomePatternUI();

            // ç›‘å¬ä¸´æ—¶è®°å·æ»‘å—å˜åŒ–
            const accidentalSlider = document.getElementById('accidentalRate');
            const accidentalValue = document.getElementById('accidentalRateValue');

            if (accidentalSlider && accidentalValue) {
                accidentalSlider.addEventListener('input', function() {
                    accidentalValue.textContent = this.value + '%';
                });
            }

            // ğŸ¼ åˆå§‹åŒ–äº”çº¿è°±æ˜¾ç¤º/éšè—å¼€å…³ - ä¿®å¤ï¼šæ”¯æŒå¤šä¸ªtoggleï¼ˆå‰ä»–+é’¢ç´æ¨¡å¼ï¼‰
            // ğŸ”§ ä¿®å¤ (2025-10-01): ä½¿ç”¨querySelectorAllé€‰æ‹©æ‰€æœ‰IDä¸ºstaffDisplayToggleçš„å…ƒç´ 
            // åŸå› ï¼šå‰ä»–æ¨¡å¼å’Œé’¢ç´æ¨¡å¼å„æœ‰ä¸€ç»„toggleï¼Œéœ€è¦ä¸ºå®ƒä»¬éƒ½ç»‘å®šäº‹ä»¶
            const staffDisplayToggles = document.querySelectorAll('input[id="staffDisplayToggle"]');
            if (staffDisplayToggles.length > 0) {
                console.log(`ğŸ” æ‰¾åˆ°${staffDisplayToggles.length}ä¸ªäº”çº¿è°±å¼€å…³å…ƒç´ `);
                staffDisplayToggles.forEach((toggle, index) => {
                    toggle.addEventListener('change', function() {
                        console.log(`ğŸ¼ äº”çº¿è°±å¼€å…³${index + 1}å˜åŒ–: ${this.checked ? 'æ˜¾ç¤º' : 'éšè—'}`);
                        console.log('ğŸ” ç«‹å³è°ƒç”¨ applyStaffDisplayState()');

                        // æ›´æ–°å…¨å±€çŠ¶æ€
                        window.displaySettings.updateStaffState(this.checked);

                        // åŒæ­¥æ‰€æœ‰toggleçš„çŠ¶æ€
                        staffDisplayToggles.forEach(t => {
                            if (t !== this) t.checked = this.checked;
                        });

                        applyStaffDisplayState();
                    });
                    console.log(`âœ… äº”çº¿è°±å¼€å…³${index + 1}äº‹ä»¶ç›‘å¬å™¨å·²ç»‘å®š`);
                });

                // ç«‹å³æµ‹è¯•å½“å‰çŠ¶æ€å¹¶åˆå§‹åŒ–å…¨å±€çŠ¶æ€ï¼ˆä½¿ç”¨ç¬¬ä¸€ä¸ªtoggleçš„çŠ¶æ€ï¼‰
                console.log('ğŸ” å½“å‰äº”çº¿è°±å¼€å…³çŠ¶æ€:', staffDisplayToggles[0].checked);
                window.displaySettings.updateStaffState(staffDisplayToggles[0].checked);
            } else {
                console.error('âŒ æœªæ‰¾åˆ°äº”çº¿è°±å¼€å…³å…ƒç´  staffDisplayToggle');
            }

            // ğŸµ åˆå§‹åŒ–å’Œå¼¦ä»£å·æ˜¾ç¤º/éšè—å¼€å…³ - ä¿®å¤ï¼šæ”¯æŒå¤šä¸ªtoggleï¼ˆå‰ä»–+é’¢ç´æ¨¡å¼ï¼‰
            // ğŸ”§ ä¿®å¤ (2025-10-01): ä½¿ç”¨querySelectorAllé€‰æ‹©æ‰€æœ‰IDä¸ºchordSymbolsToggleçš„å…ƒç´ 
            const chordSymbolsToggles = document.querySelectorAll('input[id="chordSymbolsToggle"]');
            if (chordSymbolsToggles.length > 0) {
                console.log(`ğŸ” æ‰¾åˆ°${chordSymbolsToggles.length}ä¸ªå’Œå¼¦ä»£å·å¼€å…³å…ƒç´ `);
                chordSymbolsToggles.forEach((toggle, index) => {
                    toggle.addEventListener('change', function() {
                        console.log(`ğŸµ å’Œå¼¦ä»£å·å¼€å…³${index + 1}å˜åŒ–: ${this.checked ? 'æ˜¾ç¤º' : 'éšè—'}`);
                        console.log('ğŸ” ç«‹å³è°ƒç”¨ applyChordSymbolsState()');

                        // æ›´æ–°å…¨å±€çŠ¶æ€
                        window.displaySettings.updateChordState(this.checked);

                        // åŒæ­¥æ‰€æœ‰toggleçš„çŠ¶æ€
                        chordSymbolsToggles.forEach(t => {
                            if (t !== this) t.checked = this.checked;
                        });

                        applyChordSymbolsState();
                    });
                    console.log(`âœ… å’Œå¼¦ä»£å·å¼€å…³${index + 1}äº‹ä»¶ç›‘å¬å™¨å·²ç»‘å®š`);
                });

                // ç«‹å³æµ‹è¯•å½“å‰çŠ¶æ€å¹¶åˆå§‹åŒ–å…¨å±€çŠ¶æ€ï¼ˆä½¿ç”¨ç¬¬ä¸€ä¸ªtoggleçš„çŠ¶æ€ï¼‰
                console.log('ğŸ” å½“å‰å’Œå¼¦ä»£å·å¼€å…³çŠ¶æ€:', chordSymbolsToggles[0].checked);
                window.displaySettings.updateChordState(chordSymbolsToggles[0].checked);
            } else {
                console.error('âŒ æœªæ‰¾åˆ°å’Œå¼¦ä»£å·å¼€å…³å…ƒç´  chordSymbolsToggle');
            }

            // ğŸ¼ åˆå§‹åŒ–ç®€è°±å’Œå¼¦ä»£å·å¼€å…³ - ä»…åŠŸèƒ½å’Œå£°æ¨¡å¼å¯ç”¨
            const chordJianpuToggles = document.querySelectorAll('input[id="chordJianpuToggle"]');
            if (chordJianpuToggles.length > 0) {
                console.log(`ğŸ” æ‰¾åˆ°${chordJianpuToggles.length}ä¸ªç®€è°±ä»£å·å¼€å…³å…ƒç´ `);
                chordJianpuToggles.forEach((toggle, index) => {
                    toggle.addEventListener('change', function() {
                        console.log(`ğŸ¼ ç®€è°±ä»£å·å¼€å…³${index + 1}å˜åŒ–: ${this.checked ? 'å¯ç”¨' : 'å…³é—­'}`);

                        if (window.displaySettings) {
                            window.displaySettings.updateJianpuChordState(this.checked);
                        }

                        // åŒæ­¥æ‰€æœ‰toggleçš„çŠ¶æ€
                        chordJianpuToggles.forEach(t => {
                            if (t !== this) t.checked = this.checked;
                        });

                        const chordSymbolsToggle = document.querySelector('input[id="chordSymbolsToggle"]');
                        const symbolsVisible = !chordSymbolsToggle || chordSymbolsToggle.checked;
                        if (!symbolsVisible && window.currentChords && window.currentChords.progression && typeof displayChords === 'function') {
                            displayChords(window.currentChords);
                        } else if (typeof applyJianpuChordSymbols === 'function') {
                            applyJianpuChordSymbols();
                        }
                    });
                    console.log(`âœ… ç®€è°±ä»£å·å¼€å…³${index + 1}äº‹ä»¶ç›‘å¬å™¨å·²ç»‘å®š`);
                });

                if (window.displaySettings) {
                    console.log('ğŸ” å½“å‰ç®€è°±ä»£å·å¼€å…³çŠ¶æ€:', chordJianpuToggles[0].checked);
                    window.displaySettings.updateJianpuChordState(chordJianpuToggles[0].checked);
                }
            } else {
                console.error('âŒ æœªæ‰¾åˆ°ç®€è°±ä»£å·å¼€å…³å…ƒç´  chordJianpuToggle');
            }

            // æ”¹è¿›çš„æ¨¡å—åŠ è½½å’Œåˆå§‹åŒ–ç­–ç•¥
            function initializeSystem() {
                console.log('ğŸ”„ å¼€å§‹HTMLç³»ç»Ÿåˆå§‹åŒ–æ£€æŸ¥...');

                // æ£€æŸ¥å…³é”®ç±»æ˜¯å¦å¯ç”¨
                const requiredClasses = ['HarmonyTheory', 'ChordProgressionGenerator'];
                const missingClasses = requiredClasses.filter(className => typeof window[className] === 'undefined');

                if (missingClasses.length > 0) {
                    console.warn('âš ï¸ ç­‰å¾…æ¨¡å—åŠ è½½:', missingClasses.join(', '));
                    return false;
                }

                try {
                    // æ£€æŸ¥JSæ¨¡å—æ˜¯å¦å·²ç»å®Œæˆåˆå§‹åŒ–
                    const jsInitialized = (
                        typeof window.harmonyTheory !== 'undefined' &&
                        window.harmonyTheory !== null &&
                        typeof window.chordProgressionGenerator !== 'undefined' &&
                        window.chordProgressionGenerator !== null
                    );

                    if (jsInitialized) {
                        console.log('âœ… æ£€æµ‹åˆ°JSæ¨¡å—å·²åˆå§‹åŒ–ï¼Œè·³è¿‡é‡å¤åˆå§‹åŒ–');
                    } else {
                        console.log('ğŸ”§ JSæ¨¡å—æœªå®Œæ•´åˆå§‹åŒ–ï¼Œè¿›è¡ŒHTMLè¡¥å……åˆå§‹åŒ–');

                        // ç¡®ä¿chordSettingså­˜åœ¨
                        if (typeof chordSettings === 'undefined' || !chordSettings) {
                            window.chordSettings = {
                                chordTypes: ['major', 'minor'],
                                keys: ['C-major', 'a-minor'],
                                timeSignatures: ['4/4'],
                                clefs: ['treble'],
                                rhythms: ['half', 'quarter'],
                                includeTriadInversions: false,
                                includeSeventhInversions: false,
                                complexity: 'medium',
                                voicingTypes: ['close'],
                                useFunctionalHarmony: true  // ğŸ”§ ä¿®å¤ï¼šé»˜è®¤ä¸ºåŠŸèƒ½å’Œå£°æ¨¡å¼ï¼Œè€Œééšæœºæ¨¡å¼
                            };
                            console.log('âœ… chordSettingså·²åˆå§‹åŒ–ï¼ˆé»˜è®¤åŠŸèƒ½å’Œå£°æ¨¡å¼ï¼‰');
                        } else {
                            // ğŸ”§ å¦‚æœchordSettingså·²å­˜åœ¨ï¼Œåªå¡«å……ç¼ºå¤±çš„å±æ€§ï¼Œä¸è¦†ç›–å·²æœ‰è®¾ç½®
                            const defaults = {
                                chordTypes: ['major', 'minor'],
                                keys: ['C-major', 'a-minor'],
                                timeSignatures: ['4/4'],
                                clefs: ['treble'],
                                rhythms: ['half', 'quarter'],
                                includeTriadInversions: false,
                                includeSeventhInversions: false,
                                complexity: 'medium',
                                voicingTypes: ['close'],
                                useFunctionalHarmony: true
                            };
                            Object.keys(defaults).forEach(key => {
                                if (window.chordSettings[key] === undefined) {
                                    window.chordSettings[key] = defaults[key];
                                }
                            });
                            console.log('âœ… chordSettingså·²è¡¥å…¨ç¼ºå¤±å±æ€§ï¼ˆä¿ç•™ç°æœ‰è®¾ç½®ï¼‰');
                        }

                        // ğŸ¹ åˆå§‹åŒ–é’¢ç´ä¸“ç”¨è®¾ç½®å¯¹è±¡
                        if (typeof pianoSettings === 'undefined' || !pianoSettings) {
                            window.pianoSettings = {
                                // éŸ³æ•°é€‰æ‹©ï¼ˆ2-9ä¸ªéŸ³ç¬¦ï¼‰
                                enabledNoteCounts: [4],  // é»˜è®¤é€‰ä¸­4éŸ³

                                // ä½éŸ³è°±å·éŸ³åŸŸè®¾ç½®ï¼ˆé»˜è®¤E2-E4ï¼‰
                                bassClefRangeMin: 40,  // E2 (MIDI 40)
                                bassClefRangeMax: 64,  // E4 (MIDI 64)

                                // é«˜éŸ³è°±å·éŸ³åŸŸè®¾ç½®ï¼ˆé»˜è®¤C4-E6ï¼‰
                                trebleClefRangeMin: 60,  // C4 (MIDI 60)
                                trebleClefRangeMax: 88,  // E6 (MIDI 88)

                                // éŸ³ç¬¦åˆ†é…è§„åˆ™
                                noteDistribution: {
                                    // ä½éŸ³è°±å·ï¼šæœ€ä½éŸ³æ€»æ˜¯æ ¹éŸ³
                                    bassClefAlwaysRoot: true,

                                    // é«˜éŸ³è°±å·ï¼šå‰©ä½™éŸ³ç¬¦ï¼ˆæœ€å°‘2ä¸ªï¼‰
                                    trebleClefMinNotes: 2,

                                    // éŸ³ç¬¦ä¼˜å…ˆçº§ç³»ç»Ÿ
                                    priorityNotes: ['third', 'seventh', 'sus', 'tension'],  // ä¼˜å…ˆéŸ³
                                    optionalNotes: ['fifth'],  // å¯é€‰éŸ³
                                    duplicableNotes: ['root', 'fifth'],  // å¯é‡å¤éŸ³

                                    // ä¼˜å…ˆéŸ³ä¸å¼ºåˆ¶å¿…é¡»åŒ…å«
                                    priorityNotesRequired: false
                                },

                                // éŸ³ç¬¦éšæœºæ’åˆ—ï¼ˆé«˜éŸ³è°±å·å†…ï¼‰
                                randomArrangement: true,

                                // éŸ³ç¬¦æ‹¼å†™è§„åˆ™ï¼ˆç»§æ‰¿è°ƒæ€§ï¼‰
                                inheritKeySignatureSpelling: true
                            };
                            console.log('âœ… pianoSettingså·²åˆå§‹åŒ–ï¼ˆé’¢ç´ä¸“ç”¨è®¾ç½®å¯¹è±¡ï¼‰');

                            // ğŸ¯ åŒæ­¥UI checkboxçŠ¶æ€ï¼ˆç¡®ä¿4éŸ³è¢«å‹¾é€‰ï¼‰
                            setTimeout(() => {
                                const enabledCounts = window.pianoSettings.enabledNoteCounts || [4];
                                console.log('ğŸ¯ åŒæ­¥é’¢ç´éŸ³æ•°checkboxçŠ¶æ€:', enabledCounts);

                                // ğŸ”§ ä¿®å¤ (2025-10-01): åªå¤„ç†3-7éŸ³
                                // å…ˆå–æ¶ˆæ‰€æœ‰å‹¾é€‰
                                for (let i = 3; i <= 7; i++) {
                                    const checkbox = document.getElementById(`notecount-${i}`);
                                    if (checkbox) {
                                        checkbox.checked = false;
                                    }
                                }

                                // ç„¶åå‹¾é€‰enabledNoteCountsä¸­çš„éŸ³æ•°
                                enabledCounts.forEach(count => {
                                    const checkbox = document.getElementById(`notecount-${count}`);
                                    if (checkbox) {
                                        checkbox.checked = true;
                                        console.log(`  âœ… å·²å‹¾é€‰${count}éŸ³`);
                                    }
                                });
                            }, 100);
                        }

                        // å¦‚æœè¿˜æ²¡æœ‰åˆå§‹åŒ– harmonyTheoryï¼Œåœ¨è¿™é‡Œåˆå§‹åŒ–
                        if (typeof harmonyTheory === 'undefined' || !harmonyTheory) {
                            window.harmonyTheory = new HarmonyTheory();
                            console.log('âœ… harmonyTheoryå·²åˆå§‹åŒ–ï¼ˆHTMLè¡¥å……ï¼‰');
                        }

                        // åˆå§‹åŒ–å¢å¼ºåŠŸèƒ½å’Œå£°ç³»ç»Ÿï¼ˆå¦‚æœå¯ç”¨ï¼‰
                        if (typeof EnhancedHarmony !== 'undefined' && (typeof enhancedHarmony === 'undefined' || !enhancedHarmony)) {
                            window.enhancedHarmony = new EnhancedHarmony(window.harmonyTheory || harmonyTheory);
                            console.log('âœ… å¢å¼ºåŠŸèƒ½å’Œå£°ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼ˆHTMLè¡¥å……ï¼‰');
                        }

                        // åˆå§‹åŒ–å’Œå¼¦è¿›è¡Œç”Ÿæˆå™¨ï¼ˆå…³é”®æ­¥éª¤ï¼‰
                        if (typeof ChordProgressionGenerator !== 'undefined' && (typeof chordProgressionGenerator === 'undefined' || !chordProgressionGenerator)) {
                            window.chordProgressionGenerator = new ChordProgressionGenerator(window.harmonyTheory || harmonyTheory);
                            console.log('âœ… å’Œå¼¦è¿›è¡Œç”Ÿæˆå™¨å·²åˆå§‹åŒ–ï¼ˆHTMLè¡¥å……ï¼‰');
                        }
                    }

                    // æ€»æ˜¯åˆå§‹åŒ–UIå¼€å…³ï¼ˆç¡®ä¿ chordSettings å·²å®šä¹‰ï¼‰
                    initializeFunctionalHarmonyToggle();
                    initializeInstrumentModeToggle();

                    // æ€»æ˜¯å¼ºåˆ¶ç»‘å®šç”Ÿæˆå’Œå¼¦æŒ‰é’®çš„äº‹ä»¶ç›‘å¬å™¨
                    bindGenerateButtonEvent();

                    // ç¡®ä¿é¡µé¢ç¿»è¯‘æ­£ç¡®åº”ç”¨
                    applyTranslations();
                    updateDynamicControlsTranslation(); // åˆå§‹åŒ–åŠ¨æ€æ§ä»¶ç¿»è¯‘
                    console.log('âœ… é¡µé¢ç¿»è¯‘å·²åˆå§‹åŒ–');

                    // åˆå§‹åŒ–è°ƒå·æ˜¾ç¤ºçŠ¶æ€
                    if (window.chordSettings && window.chordSettings.keys) {
                        updateKeySettingsDisplay(window.chordSettings.keys);
                    }

                    return true;
                } catch (error) {
                    console.error('âŒ ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:', error);
                    return false;
                }
            }

            // ç®€åŒ–çš„æŒ‰é’®äº‹ä»¶ç»‘å®š
            function bindGenerateButtonEvent() {
                const generateBtn = document.getElementById('generateChordsBtn');
                if (!generateBtn) {
                    console.error('âŒ ç”Ÿæˆå’Œå¼¦æŒ‰é’®ä¸å­˜åœ¨');
                    return false;
                }

                console.log('ğŸ” å¼€å§‹ç»‘å®šç”Ÿæˆå’Œå¼¦æŒ‰é’®äº‹ä»¶...');

                // ç§»é™¤å¯èƒ½å·²å­˜åœ¨çš„äº‹ä»¶ç›‘å¬å™¨
                const newBtn = generateBtn.cloneNode(true);
                generateBtn.parentNode.replaceChild(newBtn, generateBtn);

                // é‡æ–°è·å–æŒ‰é’®å¼•ç”¨
                const btn = document.getElementById('generateChordsBtn');

                // ç›´æ¥ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼Œåœ¨äº‹ä»¶å†…éƒ¨æ£€æŸ¥å‡½æ•°å¯ç”¨æ€§
                btn.addEventListener('click', function(event) {
                    console.log('ğŸ¯ ç”Ÿæˆå’Œå¼¦æŒ‰é’®è¢«ç‚¹å‡»');
                    event.preventDefault();
                    event.stopPropagation();

                    try {
                        // ğŸ¹ æ£€æµ‹é’¢ç´æ¨¡å¼
                        const instrumentToggle = document.getElementById('instrumentModeToggle');
                        const isPianoMode = instrumentToggle && instrumentToggle.checked;

                        if (isPianoMode) {
                            // ğŸ¹ é’¢ç´æ¨¡å¼ï¼šä½¿ç”¨PianoNoteCountEngine
                            console.log('ğŸ¹ é’¢ç´æ¨¡å¼ï¼šä½¿ç”¨éŸ³æ•°ç”Ÿæˆå¼•æ“');

                            if (typeof generatePianoChords === 'function') {
                                generatePianoChords();
                                console.log('âœ… é’¢ç´å’Œå¼¦ç”Ÿæˆå®Œæˆ');
                            } else {
                                console.error('âŒ generatePianoChords å‡½æ•°ä¸å¯ç”¨');
                                alert('é’¢ç´ç”Ÿæˆå™¨æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                            }
                            return;
                        }

                        // ğŸ¸ å‰ä»–æ¨¡å¼ï¼šä½¿ç”¨ä¼ ç»ŸVoicingEngine
                        // åœ¨ç‚¹å‡»æ—¶æ£€æŸ¥å‡½æ•°æ˜¯å¦å¯ç”¨
                        if (typeof generateChords === 'function') {
                            console.log('ğŸ¸ è°ƒç”¨ generateChords å‡½æ•°');
                            generateChords();
                            console.log('âœ… generateChords å‡½æ•°è°ƒç”¨å®Œæˆ');
                        } else if (typeof window.generateChords === 'function') {
                            console.log('ğŸ¸ è°ƒç”¨ window.generateChords å‡½æ•°');
                            window.generateChords();
                            console.log('âœ… window.generateChords å‡½æ•°è°ƒç”¨å®Œæˆ');
                        } else {
                            // å¦‚æœå‡½æ•°ä¸å¯ç”¨ï¼Œå°è¯•æ‰‹åŠ¨è§¦å‘åˆå§‹åŒ–
                            console.warn('âš ï¸ generateChords å‡½æ•°ä¸å¯ç”¨ï¼Œå°è¯•æ‰‹åŠ¨åˆå§‹åŒ–');
                            if (typeof initializeMusicTheory === 'function') {
                                initializeMusicTheory();
                                setTimeout(() => {
                                    if (typeof generateChords === 'function') {
                                        generateChords();
                                    } else {
                                        alert('ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                                    }
                                }, 500);
                            } else {
                                alert('å’Œå¼¦ç”Ÿæˆå™¨æœªæ­£ç¡®åŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                            }
                        }
                    } catch (error) {
                        console.error('âŒ ç”Ÿæˆå’Œå¼¦æ—¶å‡ºé”™:', error);
                        alert('ç”Ÿæˆå’Œå¼¦æ—¶å‡ºé”™: ' + error.message);
                    }
                });

                console.log('âœ… ç”Ÿæˆå’Œå¼¦æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨å·²ç»‘å®š');
                return true;
            }

            // é‡è¯•æœºåˆ¶
            let initRetryCount = 0;
            const maxInitRetries = 20; // æœ€å¤šé‡è¯•20æ¬¡ï¼ˆ2ç§’ï¼‰

            function attemptInitialization() {
                if (initializeSystem()) {
                    console.log('âœ… ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸ');
                    return;
                }

                initRetryCount++;
                if (initRetryCount < maxInitRetries) {
                    console.log(`ğŸ”„ é‡è¯•ç³»ç»Ÿåˆå§‹åŒ– (${initRetryCount}/${maxInitRetries})`);
                    setTimeout(attemptInitialization, 100);
                } else {
                    console.error('âŒ ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°');
                    // å³ä½¿å¤±è´¥ä¹Ÿè¦ç»‘å®šæŒ‰é’®ï¼Œä»¥é˜²ä¸‡ä¸€
                    bindGenerateButtonEvent();
                }
            }

            // ç«‹å³å¼€å§‹åˆå§‹åŒ–
            attemptInitialization();

            // ğŸ” è°ƒè¯•ç›‘æ§ï¼šè¿½è¸ªToggleçŠ¶æ€å˜åŒ–
            console.log('ğŸ” å¯åŠ¨ToggleçŠ¶æ€ç›‘æ§ç³»ç»Ÿ...');

            // ç›‘æ§instrumentModeToggleçŠ¶æ€å˜åŒ–
            const instrumentToggle = document.getElementById('instrumentModeToggle');
            if (instrumentToggle) {
                let lastInstrumentState = instrumentToggle.checked;
                console.log(`ğŸ” åˆå§‹instrumentToggleçŠ¶æ€: ${lastInstrumentState ? 'é’¢ç´æ¨¡å¼' : 'å‰ä»–æ¨¡å¼'}`);

                setInterval(() => {
                    if (instrumentToggle.checked !== lastInstrumentState) {
                        console.warn(`ğŸ”„ æ£€æµ‹åˆ°instrumentToggleçŠ¶æ€å˜åŒ–: ${lastInstrumentState ? 'é’¢ç´' : 'å‰ä»–'} â†’ ${instrumentToggle.checked ? 'é’¢ç´' : 'å‰ä»–'}`);
                        console.trace('ğŸ“ çŠ¶æ€å˜åŒ–è°ƒç”¨æ ˆ');
                        lastInstrumentState = instrumentToggle.checked;
                    }
                }, 100);
            } else {
                console.error('âŒ ç›‘æ§å¤±è´¥: æœªæ‰¾åˆ°instrumentModeToggleå…ƒç´ ');
            }

            // ç›‘æ§functionalHarmonyToggleçŠ¶æ€å˜åŒ–
            const functionalToggle = document.getElementById('functionalHarmonyToggle');
            if (functionalToggle) {
                let lastFunctionalState = functionalToggle.checked;
                console.log(`ğŸ” åˆå§‹functionalHarmonyToggleçŠ¶æ€: ${lastFunctionalState ? 'åŠŸèƒ½å’Œå£°æ¨¡å¼' : 'éšæœºæ¨¡å¼'}`);

                setInterval(() => {
                    if (functionalToggle.checked !== lastFunctionalState) {
                        console.warn(`ğŸ”„ æ£€æµ‹åˆ°functionalHarmonyToggleçŠ¶æ€å˜åŒ–: ${lastFunctionalState ? 'åŠŸèƒ½å’Œå£°' : 'éšæœº'} â†’ ${functionalToggle.checked ? 'åŠŸèƒ½å’Œå£°' : 'éšæœº'}`);
                        console.trace('ğŸ“ çŠ¶æ€å˜åŒ–è°ƒç”¨æ ˆ');
                        lastFunctionalState = functionalToggle.checked;
                    }
                }, 100);
            } else {
                console.error('âŒ ç›‘æ§å¤±è´¥: æœªæ‰¾åˆ°functionalHarmonyToggleå…ƒç´ ');
            }

            console.log('âœ… ToggleçŠ¶æ€ç›‘æ§ç³»ç»Ÿå·²å¯åŠ¨ï¼ˆæ¯100msæ£€æŸ¥ä¸€æ¬¡ï¼‰');
        });

        // ============ å¼¹çª—ç®¡ç†å‡½æ•° ============

        // æ‰“å¼€å’Œå¼¦ç±»å‹è®¾ç½®å¼¹çª—


        // æ‰“å¼€èŠ‚å¥è®¾ç½®å¼¹çª—
        function openRhythmSettings() {
            const modal = document.getElementById('rhythmModal');
            if (modal) {
                modal.style.display = 'block';
                // åº”ç”¨ç¿»è¯‘åˆ°å¼¹çª—å†…å®¹
                applyTranslations();
                console.log('âœ… èŠ‚å¥è®¾ç½®å¼¹çª—å·²æ‰“å¼€å¹¶åº”ç”¨ç¿»è¯‘');
            }
        }

        // å…³é—­èŠ‚å¥è®¾ç½®å¼¹çª—
        function closeRhythmSettings() {
            const modal = document.getElementById('rhythmModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // æ‰“å¼€è°ƒå·è®¾ç½®å¼¹çª—
        function openKeySignatureSettings() {
            const modal = document.getElementById('keySignatureModal');
            if (modal) {
                modal.style.display = 'block';
                // åŠ è½½å½“å‰è°ƒå·è®¾ç½®åˆ°UI
                loadCurrentKeySettings();
                // åº”ç”¨ç¿»è¯‘åˆ°å¼¹çª—å†…å®¹
                applyTranslations();
                console.log('âœ… è°ƒå·è®¾ç½®å¼¹çª—å·²æ‰“å¼€å¹¶åº”ç”¨ç¿»è¯‘');
            }
        }

        // åŠ è½½å½“å‰è°ƒå·è®¾ç½®åˆ°UI
        function loadCurrentKeySettings() {
            // é¦–å…ˆæ¸…é™¤æ‰€æœ‰checkboxçš„é€‰ä¸­çŠ¶æ€
            const allCheckboxes = document.querySelectorAll('#keySignatureModal input[type="checkbox"]');
            allCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });

            // å¦‚æœæœ‰ä¿å­˜çš„è°ƒå·è®¾ç½®ï¼Œåˆ™é€‰ä¸­å¯¹åº”çš„checkbox
            if (window.chordSettings && window.chordSettings.keys) {
                window.chordSettings.keys.forEach(key => {
                    const checkbox = document.querySelector(`#keySignatureModal input[value="${key}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        console.log(`ğŸ¯ å·²é€‰ä¸­è°ƒå·: ${key}`);
                    }
                });
            } else {
                // å¦‚æœæ²¡æœ‰ä¿å­˜çš„è®¾ç½®ï¼Œé»˜è®¤é€‰ä¸­Cå¤§è°ƒ
                const defaultCheckbox = document.querySelector('#keySignatureModal input[value="C-major"]');
                if (defaultCheckbox) {
                    defaultCheckbox.checked = true;
                    console.log('ğŸ¯ é»˜è®¤é€‰ä¸­Cå¤§è°ƒ');
                }
            }
        }

        // å…³é—­è°ƒå·è®¾ç½®å¼¹çª—
        function closeKeySignatureSettings() {
            const modal = document.getElementById('keySignatureModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // ä¸ºäº†å…¼å®¹HTMLä¸­çš„å‡½æ•°è°ƒç”¨ï¼Œæ·»åŠ åˆ«åå‡½æ•°
        function closeKeySettings() {
            closeKeySignatureSettings();
        }

        // æ‰“å¼€æ‹å·è®¾ç½®å¼¹çª—
        function openTimeSignatureSettings() {
            const modal = document.getElementById('timeSignatureModal');
            if (modal) {
                modal.style.display = 'block';
                // åº”ç”¨ç¿»è¯‘åˆ°å¼¹çª—å†…å®¹
                applyTranslations();
                console.log('âœ… æ‹å·è®¾ç½®å¼¹çª—å·²æ‰“å¼€å¹¶åº”ç”¨ç¿»è¯‘');
            }
        }

        // å…³é—­æ‹å·è®¾ç½®å¼¹çª—
        function closeTimeSignatureSettings() {
            const modal = document.getElementById('timeSignatureModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // æ‰“å¼€è°±å·è®¾ç½®å¼¹çª—
        function openClefSettings() {
            const modal = document.getElementById('clefModal');
            if (modal) {
                modal.style.display = 'block';

                // ğŸ¼ æ ¹æ®å½“å‰æ¨¡å¼è°ƒæ•´å¯ç”¨é€‰é¡¹
                const instrumentToggle = document.getElementById('instrumentModeToggle');
                const isPianoMode = instrumentToggle && instrumentToggle.checked;

                // è·å–ä½éŸ³è°±å·é€‰é¡¹
                const bassClefInput = modal.querySelector('input[value="bass"]');
                const bassClefItem = bassClefInput ? bassClefInput.closest('label.checkbox-item') : null;

                if (isPianoMode) {
                    // é’¢ç´æ¨¡å¼ï¼šéšè—ä½éŸ³è°±å·é€‰é¡¹
                    if (bassClefItem) {
                        bassClefItem.style.display = 'none';
                        console.log('ğŸ¹ é’¢ç´æ¨¡å¼ï¼šéšè—ä½éŸ³è°±å·é€‰é¡¹ï¼ˆåªæ˜¾ç¤ºå¤§è°±è¡¨å’Œé«˜éŸ³è°±å·ï¼‰');
                    }
                } else {
                    // å‰ä»–æ¨¡å¼ï¼šè¿™ä¸ªå‡½æ•°æœ¬æ¥å°±ä¸åº”è¯¥è¢«è°ƒç”¨ï¼Œä½†ä¸ºäº†å®‰å…¨èµ·è§
                    console.log('ğŸ¸ å‰ä»–æ¨¡å¼ï¼šè°±å·è®¾ç½®ä¸åº”è¯¥åœ¨å‰ä»–æ¨¡å¼ä¸‹æ‰“å¼€');
                    modal.style.display = 'none';
                    return;
                }

                // åº”ç”¨ç¿»è¯‘åˆ°å¼¹çª—å†…å®¹
                applyTranslations();
                console.log('âœ… è°±å·è®¾ç½®å¼¹çª—å·²æ‰“å¼€å¹¶åº”ç”¨ç¿»è¯‘');
            }
        }

        // å…³é—­è°±å·è®¾ç½®å¼¹çª—
        function closeClefSettings() {
            const modal = document.getElementById('clefModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // ğŸ¹ æ‰“å¼€ä½éŸ³è°±å·éŸ³åŸŸè®¾ç½®å¼¹çª—
        function openBassClefRangeModal() {
            const modal = document.getElementById('bassClefRangeModal');
            if (modal) {
                // ä»ç³»ç»Ÿè®¾ç½®ä¸­è¯»å–å½“å‰å€¼å¹¶åŒæ­¥åˆ°UI
                if (window.pianoSettings) {
                    const minSelect = document.getElementById('bassClefRangeMin');
                    const maxSelect = document.getElementById('bassClefRangeMax');

                    if (minSelect) minSelect.value = window.pianoSettings.bassClefRangeMin || 43;
                    if (maxSelect) maxSelect.value = window.pianoSettings.bassClefRangeMax || 64;

                    console.log(`ğŸ¹ å·²åŒæ­¥ä½éŸ³è°±å·éŸ³åŸŸåˆ°UI: ${window.pianoSettings.bassClefRangeMin}-${window.pianoSettings.bassClefRangeMax}`);
                }

                modal.style.display = 'block';
                applyTranslations();
                console.log('ğŸ¹ ä½éŸ³è°±å·éŸ³åŸŸè®¾ç½®å¼¹çª—å·²æ‰“å¼€');
            }
        }

        // ğŸ¹ å…³é—­ä½éŸ³è°±å·éŸ³åŸŸè®¾ç½®å¼¹çª—
        function closeBassClefRangeModal() {
            const modal = document.getElementById('bassClefRangeModal');
            if (modal) {
                modal.style.display = 'none';
                console.log('ğŸ¹ ä½éŸ³è°±å·éŸ³åŸŸè®¾ç½®å¼¹çª—å·²å…³é—­');
            }
        }

        // ğŸ¹ ä¿å­˜ä½éŸ³è°±å·éŸ³åŸŸè®¾ç½®
        function saveBassClefRange() {
            const rangeMin = document.getElementById('bassClefRangeMin').value;
            const rangeMax = document.getElementById('bassClefRangeMax').value;

            // ä¿å­˜åˆ°å…¨å±€è®¾ç½®å¯¹è±¡ï¼ˆå°†åœ¨åç»­é˜¶æ®µå®ç°ï¼‰
            if (!window.pianoSettings) {
                window.pianoSettings = {};
            }
            window.pianoSettings.bassClefRangeMin = parseInt(rangeMin);
            window.pianoSettings.bassClefRangeMax = parseInt(rangeMax);

            // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
            const midiToNoteName = (midi) => {
                const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                const octave = Math.floor(midi / 12) - 1;
                const noteName = notes[midi % 12];
                return `${noteName}${octave}`;
            };

            const displayText = `(${midiToNoteName(rangeMin)}-${midiToNoteName(rangeMax)})`;
            document.getElementById('bassClefRangeDisplay').textContent = displayText;

            console.log(`ğŸ¹ ä½éŸ³è°±å·éŸ³åŸŸå·²ä¿å­˜: ${displayText}`);
            closeBassClefRangeModal();
        }

        // ğŸ¹ æ‰“å¼€é«˜éŸ³è°±å·éŸ³åŸŸè®¾ç½®å¼¹çª—
        function openTrebleClefRangeModal() {
            const modal = document.getElementById('trebleClefRangeModal');
            if (modal) {
                // ä»ç³»ç»Ÿè®¾ç½®ä¸­è¯»å–å½“å‰å€¼å¹¶åŒæ­¥åˆ°UI
                if (window.pianoSettings) {
                    const minSelect = document.getElementById('trebleClefRangeMin');
                    const maxSelect = document.getElementById('trebleClefRangeMax');

                    if (minSelect) minSelect.value = window.pianoSettings.trebleClefRangeMin || 55;
                    if (maxSelect) maxSelect.value = window.pianoSettings.trebleClefRangeMax || 88;

                    console.log(`ğŸ¹ å·²åŒæ­¥é«˜éŸ³è°±å·éŸ³åŸŸåˆ°UI: ${window.pianoSettings.trebleClefRangeMin}-${window.pianoSettings.trebleClefRangeMax}`);
                }

                modal.style.display = 'block';
                applyTranslations();
                console.log('ğŸ¹ é«˜éŸ³è°±å·éŸ³åŸŸè®¾ç½®å¼¹çª—å·²æ‰“å¼€');
            }
        }

        // ğŸ¹ å…³é—­é«˜éŸ³è°±å·éŸ³åŸŸè®¾ç½®å¼¹çª—
        function closeTrebleClefRangeModal() {
            const modal = document.getElementById('trebleClefRangeModal');
            if (modal) {
                modal.style.display = 'none';
                console.log('ğŸ¹ é«˜éŸ³è°±å·éŸ³åŸŸè®¾ç½®å¼¹çª—å·²å…³é—­');
            }
        }

        // ğŸ¹ ä¿å­˜é«˜éŸ³è°±å·éŸ³åŸŸè®¾ç½®
        function saveTrebleClefRange() {
            const rangeMin = document.getElementById('trebleClefRangeMin').value;
            const rangeMax = document.getElementById('trebleClefRangeMax').value;

            // ä¿å­˜åˆ°å…¨å±€è®¾ç½®å¯¹è±¡ï¼ˆå°†åœ¨åç»­é˜¶æ®µå®ç°ï¼‰
            if (!window.pianoSettings) {
                window.pianoSettings = {};
            }
            window.pianoSettings.trebleClefRangeMin = parseInt(rangeMin);
            window.pianoSettings.trebleClefRangeMax = parseInt(rangeMax);

            // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
            const midiToNoteName = (midi) => {
                const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                const octave = Math.floor(midi / 12) - 1;
                const noteName = notes[midi % 12];
                return `${noteName}${octave}`;
            };

            const displayText = `(${midiToNoteName(rangeMin)}-${midiToNoteName(rangeMax)})`;
            document.getElementById('trebleClefRangeDisplay').textContent = displayText;

            console.log(`ğŸ¹ é«˜éŸ³è°±å·éŸ³åŸŸå·²ä¿å­˜: ${displayText}`);
            closeTrebleClefRangeModal();
        }

        // ğŸ¹ é’¢ç´è®¾ç½®ç®¡ç†å‡½æ•°

        /**
         * ä»UIè¯»å–é’¢ç´éŸ³æ•°é€‰æ‹©
         * @returns {Array<number>} é€‰ä¸­çš„éŸ³æ•°æ•°ç»„
         */
        function getPianoNoteCountsFromUI() {
            const noteCounts = [];
            console.log('ğŸ” å¼€å§‹è¯»å–é’¢ç´éŸ³æ•°checkboxçŠ¶æ€:');
            // ğŸ”§ ä¿®å¤ (2025-10-01): åªå¤„ç†3-7éŸ³
            for (let i = 3; i <= 7; i++) {
                const checkbox = document.getElementById(`notecount-${i}`);
                if (checkbox) {
                    console.log(`  notecount-${i}: ${checkbox.checked ? 'âœ… å·²å‹¾é€‰' : 'â˜ æœªå‹¾é€‰'}`);
                    if (checkbox.checked) {
                        noteCounts.push(i);
                    }
                } else {
                    console.log(`  notecount-${i}: âŒ å…ƒç´ æœªæ‰¾åˆ°`);
                }
            }
            console.log(`ğŸ” æœ€ç»ˆè¯»å–åˆ°çš„éŸ³æ•°: [${noteCounts.join(', ')}]`);
            return noteCounts;
        }

        /**
         * æ›´æ–°pianoSettingsä»UI
         */
        function updatePianoSettingsFromUI() {
            if (!window.pianoSettings) {
                console.warn('âš ï¸ pianoSettingsæœªåˆå§‹åŒ–');
                return;
            }

            // ğŸ” è¯Šæ–­ï¼šæ˜¾ç¤ºæ›´æ–°å‰çš„éŸ³æ•°è®¾ç½®ï¼ˆ2025-10-01ï¼‰
            console.log('ğŸ” [updatePianoSettingsFromUI] æ›´æ–°å‰ window.pianoSettings.enabledNoteCounts:',
                        JSON.stringify(window.pianoSettings.enabledNoteCounts));

            // æ›´æ–°éŸ³æ•°é€‰æ‹©
            const noteCountsFromUI = getPianoNoteCountsFromUI();
            console.log('ğŸ” [updatePianoSettingsFromUI] ä»UIè¯»å–çš„éŸ³æ•°:', JSON.stringify(noteCountsFromUI));

            window.pianoSettings.enabledNoteCounts = noteCountsFromUI;

            console.log('ğŸ” [updatePianoSettingsFromUI] æ›´æ–°å window.pianoSettings.enabledNoteCounts:',
                        JSON.stringify(window.pianoSettings.enabledNoteCounts));

            // ğŸ¹ ä»UIæ§ä»¶è¯»å–éŸ³åŸŸè®¾ç½®ï¼ˆ2025-10-01ä¿®å¤ï¼‰
            // ç¡®ä¿ä½¿ç”¨æœ€æ–°çš„éŸ³åŸŸè®¾ç½®å€¼
            const bassMinSelect = document.getElementById('bassClefRangeMin');
            const bassMaxSelect = document.getElementById('bassClefRangeMax');
            const trebleMinSelect = document.getElementById('trebleClefRangeMin');
            const trebleMaxSelect = document.getElementById('trebleClefRangeMax');

            if (bassMinSelect && bassMinSelect.value) {
                window.pianoSettings.bassClefRangeMin = parseInt(bassMinSelect.value);
            }
            if (bassMaxSelect && bassMaxSelect.value) {
                window.pianoSettings.bassClefRangeMax = parseInt(bassMaxSelect.value);
            }
            if (trebleMinSelect && trebleMinSelect.value) {
                window.pianoSettings.trebleClefRangeMin = parseInt(trebleMinSelect.value);
            }
            if (trebleMaxSelect && trebleMaxSelect.value) {
                window.pianoSettings.trebleClefRangeMax = parseInt(trebleMaxSelect.value);
            }

            console.log('ğŸ¹ é’¢ç´è®¾ç½®å·²æ›´æ–°:', {
                enabledNoteCounts: window.pianoSettings.enabledNoteCounts,
                bassClefRange: `${window.pianoSettings.bassClefRangeMin}-${window.pianoSettings.bassClefRangeMax}`,
                trebleClefRange: `${window.pianoSettings.trebleClefRangeMin}-${window.pianoSettings.trebleClefRangeMax}`
            });
        }

        /**
         * éªŒè¯é’¢ç´è®¾ç½®æœ‰æ•ˆæ€§
         * @returns {Object} {valid: boolean, errors: Array<string>}
         */
        function validatePianoSettings() {
            const errors = [];

            if (!window.pianoSettings) {
                errors.push('pianoSettingsæœªåˆå§‹åŒ–');
                return { valid: false, errors };
            }

            // éªŒè¯éŸ³æ•°é€‰æ‹©
            if (!window.pianoSettings.enabledNoteCounts || window.pianoSettings.enabledNoteCounts.length === 0) {
                errors.push('æœªé€‰æ‹©ä»»ä½•éŸ³æ•°');
            }

            // éªŒè¯ä½éŸ³è°±å·éŸ³åŸŸ
            if (window.pianoSettings.bassClefRangeMin >= window.pianoSettings.bassClefRangeMax) {
                errors.push('ä½éŸ³è°±å·éŸ³åŸŸèŒƒå›´æ— æ•ˆ');
            }

            // éªŒè¯é«˜éŸ³è°±å·éŸ³åŸŸ
            if (window.pianoSettings.trebleClefRangeMin >= window.pianoSettings.trebleClefRangeMax) {
                errors.push('é«˜éŸ³è°±å·éŸ³åŸŸèŒƒå›´æ— æ•ˆ');
            }

            // éªŒè¯éŸ³æ•°ä¸éŸ³åŸŸçš„å…¼å®¹æ€§
            const maxNoteCount = Math.max(...window.pianoSettings.enabledNoteCounts);
            const trebleClefMinNotes = window.pianoSettings.noteDistribution.trebleClefMinNotes;

            if (maxNoteCount < trebleClefMinNotes + 1) {  // +1 for bass clef root note
                errors.push(`æœ€å¤§éŸ³æ•°(${maxNoteCount})å°äºæœ€å°è¦æ±‚(${trebleClefMinNotes + 1})`);
            }

            return {
                valid: errors.length === 0,
                errors
            };
        }

        /**
         * è·å–é’¢ç´å½“å‰è®¾ç½®æ‘˜è¦
         * @returns {string} è®¾ç½®æ‘˜è¦å­—ç¬¦ä¸²
         */
        function getPianoSettingsSummary() {
            if (!window.pianoSettings) {
                return 'é’¢ç´è®¾ç½®æœªåˆå§‹åŒ–';
            }

            const midiToNoteName = (midi) => {
                const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                const octave = Math.floor(midi / 12) - 1;
                const noteName = notes[midi % 12];
                return `${noteName}${octave}`;
            };

            return `
ğŸ¹ é’¢ç´å’Œå£°ç”Ÿæˆè®¾ç½®:
  éŸ³æ•°é€‰æ‹©: ${window.pianoSettings.enabledNoteCounts.join(', ')}éŸ³
  ä½éŸ³è°±å·: ${midiToNoteName(window.pianoSettings.bassClefRangeMin)}-${midiToNoteName(window.pianoSettings.bassClefRangeMax)}
  é«˜éŸ³è°±å·: ${midiToNoteName(window.pianoSettings.trebleClefRangeMin)}-${midiToNoteName(window.pianoSettings.trebleClefRangeMax)}
  éŸ³ç¬¦åˆ†é…: ä½éŸ³è°±å·(æ ¹éŸ³) + é«˜éŸ³è°±å·(â‰¥${window.pianoSettings.noteDistribution.trebleClefMinNotes}éŸ³)
  ä¼˜å…ˆéŸ³ç¬¦: ${window.pianoSettings.noteDistribution.priorityNotes.join(', ')}
            `.trim();
        }

        /**
         * ğŸ¹ é’¢ç´å’Œå¼¦ç”Ÿæˆä¸»å‡½æ•°
         * ä½¿ç”¨PianoNoteCountEngineç”ŸæˆåŸºäºéŸ³æ•°é€‰æ‹©çš„é’¢ç´å’Œå£°
         */
        function generatePianoChords() {
            console.log('ğŸ¹ ========== å¼€å§‹ç”Ÿæˆé’¢ç´å’Œå¼¦ ==========');

            try {
                // ğŸ”§ 2025-10-01 ä¿®å¤ï¼šç§»é™¤updatePianoSettingsFromUI()è°ƒç”¨
                // é—®é¢˜ï¼šç”¨æˆ·åœ¨å¼¹çª—ä¸­ä¿å­˜è®¾ç½®åï¼Œæ­¤å¤„é‡æ–°ä»UIè¯»å–ä¼šè¦†ç›–å·²ä¿å­˜çš„è®¾ç½®
                // åŸå› ï¼šå¼¹çª—å…³é—­åUI checkboxçŠ¶æ€å¯èƒ½ä¸ä¿å­˜çš„è®¾ç½®ä¸åŒæ­¥
                // è§£å†³ï¼šä¾èµ–å¼¹çª—ä¿å­˜çš„window.pianoSettingsï¼Œä¸åœ¨ç”Ÿæˆæ—¶é‡æ–°è¯»å–UI
                // æ—§ä»£ç ï¼šupdatePianoSettingsFromUI();

                // ğŸ” è¯Šæ–­ï¼šæ˜¾ç¤ºå½“å‰ä½¿ç”¨çš„éŸ³æ•°è®¾ç½®
                console.log('ğŸ¹ å½“å‰ window.pianoSettings.enabledNoteCounts:',
                           JSON.stringify(window.pianoSettings?.enabledNoteCounts));

                // 2. éªŒè¯è®¾ç½®
                const validation = validatePianoSettings();
                if (!validation.valid) {
                    console.error('âŒ é’¢ç´è®¾ç½®éªŒè¯å¤±è´¥:', validation.errors);
                    alert('è®¾ç½®é”™è¯¯ï¼š\n' + validation.errors.join('\n'));
                    return;
                }

                console.log(getPianoSettingsSummary());

                // 3. åˆå§‹åŒ–é’¢ç´å¼•æ“
                if (typeof PianoNoteCountEngine === 'undefined') {
                    throw new Error('PianoNoteCountEngine æœªåŠ è½½');
                }

                if (!window.harmonyTheory) {
                    throw new Error('HarmonyTheory æœªåˆå§‹åŒ–');
                }

                const pianoEngine = new PianoNoteCountEngine(window.harmonyTheory);
                console.log('âœ… é’¢ç´å¼•æ“åˆå§‹åŒ–æˆåŠŸ');

                // 4. è¯»å–ç”¨æˆ·è®¾ç½®
                const measures = parseInt(document.querySelector('input[name="measures"]:checked')?.value || '4');

                // æ£€æŸ¥æ˜¯å¦å¯ç”¨åŠŸèƒ½å’Œå£°æ¨¡å¼ï¼ˆæå‰æ£€æŸ¥ï¼Œç”¨äºè°ƒå·é€‰æ‹©ï¼‰
                const functionalHarmonyToggle = document.getElementById('functionalHarmonyToggle');
                const useFunctionalHarmony = functionalHarmonyToggle ? functionalHarmonyToggle.checked : false;

                // ğŸ¯ æ™ºèƒ½è°ƒå·é€‰æ‹©ï¼šåŠŸèƒ½å’Œå£°æ¨¡å¼ä½¿ç”¨ç¬¬ä¸€ä¸ªè°ƒå·ï¼Œéšæœºæ¨¡å¼éšæœºé€‰æ‹©
                let key = 'C-major'; // é»˜è®¤è°ƒå·
                if (window.chordSettings && window.chordSettings.keys && window.chordSettings.keys.length > 0) {
                    if (useFunctionalHarmony) {
                        // åŠŸèƒ½å’Œå£°æ¨¡å¼ï¼šä½¿ç”¨ç¬¬ä¸€ä¸ªé€‰ä¸­çš„è°ƒå·ï¼ˆç”¨æˆ·æ˜ç¡®é€‰æ‹©çš„è°ƒæ€§ï¼‰
                        key = window.chordSettings.keys[0];
                        console.log(`ğŸ¼ åŠŸèƒ½å’Œå£°æ¨¡å¼ - ä½¿ç”¨ç¬¬ä¸€ä¸ªé€‰ä¸­è°ƒå·: ${key}`);
                    } else {
                        // éšæœºæ¨¡å¼ï¼šä»å¯ç”¨è°ƒå·ä¸­éšæœºé€‰æ‹©
                        const randomIndex = Math.floor(Math.random() * window.chordSettings.keys.length);
                        key = window.chordSettings.keys[randomIndex];
                        console.log(`ğŸ² éšæœºæ¨¡å¼ - éšæœºé€‰æ‹©è°ƒå·: ${key} (ä»${window.chordSettings.keys.length}ä¸ªå¯ç”¨è°ƒå·ä¸­é€‰æ‹©)`);
                    }
                } else {
                    console.log(`ğŸ¹ ä½¿ç”¨é»˜è®¤è°ƒå·: ${key}`);
                }

                console.log(`ğŸ¹ å°èŠ‚æ•°: ${measures}, è°ƒæ€§: ${key}`);

                // 5. ğŸµ é›†æˆå’Œå¼¦è¿›è¡Œç”Ÿæˆç³»ç»Ÿ - æ”¯æŒéšæœºæ¨¡å¼å’ŒåŠŸèƒ½å’Œå£°æ¨¡å¼
                console.log('ğŸµ å¼€å§‹ç”Ÿæˆå’Œå¼¦è¿›è¡Œ...');

                // ğŸ” è¯Šæ–­ï¼šæ£€æŸ¥å’Œå¼¦ç±»å‹è®¾ç½®
                console.log('\nğŸ” ========== é’¢ç´æ¨¡å¼å®Œæ•´è®¾ç½®è¯Šæ–­ ==========');
                console.log('ğŸ¯ window.chordSettings.chordTypes:', window.chordSettings.chordTypes);
                console.log('ğŸ¯ æ˜¯å¦ä¸ºæ•°ç»„:', Array.isArray(window.chordSettings.chordTypes));
                console.log('ğŸ¯ æ•°ç»„é•¿åº¦:', window.chordSettings.chordTypes ? window.chordSettings.chordTypes.length : 'undefined');
                console.log('ğŸ¯ åŒ…å«7å’Œå¼¦:', window.chordSettings.chordTypes ? window.chordSettings.chordTypes.filter(t => t.includes('7')).length : 0);
                console.log('ğŸ¯ åŒ…å«3å’Œå¼¦:', window.chordSettings.chordTypes ? window.chordSettings.chordTypes.filter(t => ['major', 'minor', 'diminished', 'augmented'].includes(t)).length : 0);
                console.log('ğŸ¯ å®Œæ•´çš„chordSettings:', JSON.stringify(window.chordSettings, null, 2));
                console.log('\nğŸ¹ window.pianoSettings.enabledNoteCounts:', window.pianoSettings?.enabledNoteCounts);
                console.log('ğŸ¹ æ˜¯å¦ä¸ºæ•°ç»„:', Array.isArray(window.pianoSettings?.enabledNoteCounts));
                console.log('ğŸ¹ æ•°ç»„é•¿åº¦:', window.pianoSettings?.enabledNoteCounts ? window.pianoSettings.enabledNoteCounts.length : 'undefined');
                console.log('ğŸ¹ å®Œæ•´çš„pianoSettings:', JSON.stringify(window.pianoSettings, null, 2));
                console.log('========== è¯Šæ–­ç»“æŸ ==========\n');

                // è°ƒç”¨å¯¹åº”çš„å’Œå¼¦è¿›è¡Œç”Ÿæˆå‡½æ•°
                let chordProgression;
                if (useFunctionalHarmony) {
                    console.log('ğŸ¼ ä½¿ç”¨åŠŸèƒ½å’Œå£°æ¨¡å¼ç”Ÿæˆå’Œå¼¦è¿›è¡Œ');
                    chordProgression = window.generateFunctionalProgression(key, measures);
                } else {
                    console.log('ğŸ² ä½¿ç”¨éšæœºæ¨¡å¼ç”Ÿæˆå’Œå¼¦è¿›è¡Œ');
                    chordProgression = window.generateDiverseProgression(key, measures);
                }

                if (!chordProgression || chordProgression.length === 0) {
                    throw new Error('å’Œå¼¦è¿›è¡Œç”Ÿæˆå¤±è´¥');
                }

                console.log(`âœ… ç”Ÿæˆäº†${chordProgression.length}ä¸ªå’Œå¼¦:`, chordProgression.map(c => `${c.root}${c.type}`).join(', '));

                // ğŸ” è¯Šæ–­ï¼šæ£€æŸ¥åŠŸèƒ½å’Œå£°è½¬ä½ä¿¡æ¯æ˜¯å¦å­˜åœ¨
                console.log('\nğŸ” ========== åŠŸèƒ½å’Œå£°è½¬ä½è¯Šæ–­ ==========');
                console.log(`åŠŸèƒ½å’Œå£°æ¨¡å¼: ${useFunctionalHarmony ? 'å¼€å¯' : 'å…³é—­'}`);
                chordProgression.forEach((chord, i) => {
                    console.log(`ç¬¬${i+1}å°èŠ‚: ${chord.root}${chord.type}`);
                    console.log(`  - inversion: ${chord.inversion !== undefined ? chord.inversion : 'æœªå®šä¹‰'}`);
                    console.log(`  - inversionReason: ${chord.inversionReason || 'æ— '}`);
                    console.log(`  - forcedBassNote: ${chord.forcedBassNote || 'æ— '}`);
                });
                console.log('========================================\n');

                // 6. ğŸ¹ ä¸ºæ¯ä¸ªå’Œå¼¦ç”Ÿæˆé’¢ç´voicingï¼ˆå¯ç”¨Voice Leadingï¼‰
                // ğŸ”§ ä¿®å¤ (2025-10-02 å°è¯•5): æ”¹ç”¨whileå¾ªç¯ï¼Œç¡®ä¿ç”Ÿæˆè¶³å¤Ÿçš„å°èŠ‚æ•°
                // ğŸ”§ ä¿®å¤ (2025-10-06): æ·»åŠ å¤–å±‚å¤šæ ·æ€§æ£€æŸ¥å¾ªç¯

                const generatedChords = [];
                let prevBassMidi = null;  // è®°å½•å‰ä¸€ä¸ªå’Œå¼¦çš„ä½éŸ³MIDIå€¼
                let chordIndex = 0;  // å½“å‰å°è¯•çš„å’Œå¼¦è¿›è¡Œç´¢å¼•
                let successfulCount = 0;  // æˆåŠŸç”Ÿæˆçš„å’Œå¼¦æ•°é‡

                // ğŸ”§ æ–°å¢ (2025-10-06): å’Œå¼¦å¤šæ ·æ€§æ£€æµ‹ - ä»…é’¢ç´æ¨¡å¼6/7éŸ³é…ç½®
                const userWantsSingleNoteCount = window.pianoSettings.enabledNoteCounts.length === 1;
                const singleNoteCountValue = userWantsSingleNoteCount ? window.pianoSettings.enabledNoteCounts[0] : null;
                const needsDiversityCheck = userWantsSingleNoteCount && (singleNoteCountValue === 6 || singleNoteCountValue === 7);

                let generatedChordNames = [];  // è®°å½•å·²ç”Ÿæˆçš„å’Œå¼¦åç§°
                let attemptsSinceLastSuccess = 0;  // è‡ªä¸Šæ¬¡æˆåŠŸåçš„å°è¯•æ¬¡æ•°
                let progressionRegenerationCount = 0;  // å’Œå¼¦è¿›è¡Œé‡æ–°ç”Ÿæˆæ¬¡æ•°
                const maxProgressionRegenerations = 3;  // æœ€å¤šé‡æ–°ç”Ÿæˆ3æ¬¡
                const maxAttemptsBeforeRegeneration = chordProgression.length * 3;  // æœ€å¤§å°è¯•æ¬¡æ•°

                // ğŸ”§ æ–°å¢ (2025-10-06): å¤–å±‚å¤šæ ·æ€§æ£€æŸ¥
                let diversityRetryCount = 0;
                const maxDiversityRetries = 3;
                let finalGeneratedChords = [];

                if (needsDiversityCheck) {
                    console.log(`ğŸ¯ å¯ç”¨å’Œå¼¦å¤šæ ·æ€§æ£€æµ‹ (${singleNoteCountValue}éŸ³é…ç½®)`);
                    console.log(`  - ç­–ç•¥: ç”Ÿæˆå®Œæˆåæ£€æŸ¥å¤šæ ·æ€§`);
                    console.log(`  - å¦‚æœé‡å¤å¤ªå¤šï¼Œæœ€å¤šé‡æ–°ç”Ÿæˆ${maxDiversityRetries}æ¬¡`);
                }

                // å¤–å±‚å¾ªç¯ï¼šå¤šæ ·æ€§æ£€æŸ¥
                while (diversityRetryCount <= maxDiversityRetries) {
                    // é‡ç½®å†…å±‚å¾ªç¯çš„çŠ¶æ€
                    generatedChords.length = 0;
                    generatedChordNames.length = 0;
                    successfulCount = 0;
                    chordIndex = 0;
                    prevBassMidi = null;
                    attemptsSinceLastSuccess = 0;
                    progressionRegenerationCount = 0;

                    // ğŸ”§ ä¿®å¤ (2025-10-06): å°†å˜é‡å£°æ˜ç§»åˆ°å¾ªç¯å¤–ï¼Œé˜²æ­¢ä½œç”¨åŸŸé”™è¯¯
                    // è¿™äº›å˜é‡éœ€è¦åœ¨å¡ä½æ£€æµ‹ä»£ç ä¸­è®¿é—®ï¼Œæ‰€ä»¥å¿…é¡»åœ¨tryå—å¤–å®šä¹‰
                    const originalNoteCounts = [...window.pianoSettings.enabledNoteCounts];
                    const userWantsSingleNoteCount = originalNoteCounts.length === 1;
                    const singleNoteCountValue = userWantsSingleNoteCount ? originalNoteCounts[0] : null;

                    // å†…å±‚å¾ªç¯ï¼šç”Ÿæˆå’Œå¼¦
                    while (successfulCount < measures) {
                    // ğŸ”§ ä¿®å¤ (2025-10-06): æ£€æµ‹æ˜¯å¦å¡ä½ï¼ˆå°è¯•å¤ªå¤šæ¬¡ä»æ— è¿›å±•ï¼‰
                    // ğŸ”§ ä¿®å¤ (2025-10-06): ç§»é™¤needsDiversityCheckæ¡ä»¶ï¼Œé˜²æ­¢å¤šéŸ³æ•°é…ç½®å¡æ­»
                    if (attemptsSinceLastSuccess > maxAttemptsBeforeRegeneration) {
                        console.warn(`âš ï¸ æ£€æµ‹åˆ°ç”Ÿæˆå¡ä½: å°è¯•äº†${attemptsSinceLastSuccess}æ¬¡ï¼Œä»æœªç”Ÿæˆæ–°å’Œå¼¦`);

                        if (progressionRegenerationCount >= maxProgressionRegenerations) {
                            console.error(`âŒ å·²é‡æ–°ç”Ÿæˆ${maxProgressionRegenerations}æ¬¡å’Œå¼¦è¿›è¡Œï¼Œä»ç„¶å¡ä½`);

                            // ğŸ”§ ä¿®å¤ (2025-10-06): åŠ¨æ€ç”Ÿæˆé”™è¯¯ä¿¡æ¯ï¼Œé€‚ç”¨äºå•ä¸€å’Œå¤šéŸ³æ•°æ¨¡å¼
                            const noteCountDesc = userWantsSingleNoteCount
                                ? `${singleNoteCountValue}éŸ³é…ç½®`
                                : `å¤šéŸ³æ•°é…ç½® [${originalNoteCounts.join(', ')}]`;

                            throw new Error(`æ— æ³•ç”Ÿæˆè¶³å¤Ÿçš„å’Œå¼¦ï¼ˆ${noteCountDesc}ï¼‰ï¼Œè¯·å°è¯•ï¼š\n1. æ‰©å¤§éŸ³åŸŸèŒƒå›´\n2. é€‰æ‹©æ›´å¤šå’Œå¼¦ç±»å‹\n3. å‡å°‘ç”Ÿæˆçš„å°èŠ‚æ•°`);
                        }

                        console.warn(`ğŸ”„ é‡æ–°ç”Ÿæˆå’Œå¼¦è¿›è¡Œï¼ˆç¬¬${progressionRegenerationCount + 1}æ¬¡ï¼‰`);

                        // é‡æ–°ç”Ÿæˆå’Œå¼¦è¿›è¡Œ
                        if (useFunctionalHarmony) {
                            chordProgression = window.generateFunctionalProgression(key, measures);
                        } else {
                            chordProgression = window.generateDiverseProgression(key, measures);
                        }

                        console.log(`âœ… æ–°å’Œå¼¦è¿›è¡Œ: ${chordProgression.map(c => `${c.root}${c.type}`).join(', ')}`);

                        // é‡ç½®çŠ¶æ€ï¼Œä½†ä¿ç•™å·²ç”Ÿæˆçš„å’Œå¼¦ï¼ˆä¸ä»å¤´å¼€å§‹ï¼‰
                        chordIndex = 0;
                        attemptsSinceLastSuccess = 0;
                        progressionRegenerationCount++;
                        continue;  // è·³è¿‡æœ¬æ¬¡å¾ªç¯ï¼Œä½¿ç”¨æ–°çš„å’Œå¼¦è¿›è¡Œ
                    }

                    attemptsSinceLastSuccess++;  // è®°å½•å°è¯•æ¬¡æ•°

                    // ä»å’Œå¼¦è¿›è¡Œä¸­å¾ªç¯é€‰æ‹©å’Œå¼¦ï¼ˆå¦‚æœåˆ°è¾¾æœ«å°¾ï¼Œä»å¤´å¼€å§‹ï¼‰
                    const chord = chordProgression[chordIndex % chordProgression.length];
                    chordIndex++;

                    console.log(`ğŸ¹ ç”Ÿæˆç¬¬${successfulCount + 1}/${measures}å°èŠ‚ (å°è¯•å’Œå¼¦: ${chord.root}${chord.type})`);

                    try {
                        let result = null;
                        let generatedSuccessfully = false;

                        // ğŸ”§ ä¿®å¤ (2025-10-02 å°è¯•5): æ™ºèƒ½é™çº§ç­–ç•¥
                        // é—®é¢˜ï¼šç”¨æˆ·åªå‹¾é€‰7éŸ³æ—¶ï¼Œç³»ç»Ÿè‡ªåŠ¨é™çº§åˆ°6éŸ³/5éŸ³ï¼Œè¿èƒŒç”¨æˆ·æ„å›¾
                        // è§£å†³ï¼šæ£€æµ‹ç”¨æˆ·æ˜¯å¦åªå‹¾é€‰äº†ä¸€ä¸ªéŸ³æ•°ï¼Œå¦‚æœæ˜¯åˆ™ä¸é™çº§ï¼Œå¤±è´¥æ—¶è·³è¿‡è¯¥å’Œå¼¦
                        // ğŸ”§ ä¿®å¤ (2025-10-06): originalNoteCountså’ŒuserWantsSingleNoteCountå·²åœ¨å¾ªç¯å¤–å®šä¹‰
                        const fallbackSequence = [];

                        // ğŸ” è¯Šæ–­ï¼šæ˜¾ç¤ºç”¨æˆ·å®é™…å‹¾é€‰çš„éŸ³æ•°
                        console.log(`ğŸ” ç”¨æˆ·å‹¾é€‰çš„éŸ³æ•°é…ç½®: [${originalNoteCounts.join(', ')}] (æ•°é‡: ${originalNoteCounts.length})`);
                        console.log(`ğŸ” æ˜¯å¦å•ä¸€éŸ³æ•°æ¨¡å¼: ${userWantsSingleNoteCount}`);

                        // æ„å»ºfallbackåºåˆ—ï¼š
                        // - ç”¨æˆ·åªå‹¾é€‰ä¸€ä¸ªéŸ³æ•°ï¼šåªå°è¯•è¯¥éŸ³æ•°ï¼Œä¸é™çº§
                        // - ç”¨æˆ·å‹¾é€‰å¤šä¸ªéŸ³æ•°ï¼šéšæœºé€‰æ‹©ä¸€ä¸ªä½œä¸ºé¦–é€‰ï¼Œå…¶ä»–ä½œä¸ºfallback
                        if (userWantsSingleNoteCount) {
                            // ğŸ¯ å•ä¸€éŸ³æ•°æ¨¡å¼ï¼šä¸é™çº§ï¼Œå¤±è´¥æ—¶è·³è¿‡
                            fallbackSequence.push(originalNoteCounts[0]);
                            console.log(`ğŸ¯ å•ä¸€éŸ³æ•°æ¨¡å¼ï¼šåªå°è¯• ${originalNoteCounts[0]}éŸ³ï¼Œå¤±è´¥æ—¶è·³è¿‡å’Œå¼¦`);
                        } else {
                            // ğŸ”„ å¤šéŸ³æ•°æ¨¡å¼ï¼šéšæœºé€‰æ‹© + fallback
                            // ğŸ”§ ä¿®å¤ (2025-10-06): ä½¿ç”¨ç”¨æˆ·å‹¾é€‰çš„éŸ³æ•°ï¼Œéšæœºé€‰æ‹©é¦–é€‰é¡¹

                            // 1. éšæœºæ‰“ä¹±ç”¨æˆ·å‹¾é€‰çš„éŸ³æ•°
                            const shuffledNoteCounts = [...originalNoteCounts].sort(() => Math.random() - 0.5);

                            // 2. å°†æ‰“ä¹±åçš„éŸ³æ•°ä½œä¸ºfallbackåºåˆ—
                            fallbackSequence.push(...shuffledNoteCounts);

                            console.log(`ğŸ”„ å¤šéŸ³æ•°æ¨¡å¼ï¼šéšæœºé€‰æ‹©é¦–é€‰éŸ³æ•°ï¼Œfallback = [${fallbackSequence.join(' â†’ ')}]`);
                            console.log(`   ç”¨æˆ·å‹¾é€‰: [${originalNoteCounts.join(', ')}]`);
                        }

                        // å°è¯•æ¯ä¸ªéŸ³æ•°é…ç½®
                        for (let attemptIndex = 0; attemptIndex < fallbackSequence.length; attemptIndex++) {
                            const attemptNoteCount = fallbackSequence[attemptIndex];

                            // ä¸´æ—¶ä¿®æ”¹settingsï¼Œåªå…è®¸å½“å‰å°è¯•çš„éŸ³æ•°
                            const attemptSettings = {
                                ...window.pianoSettings,
                                enabledNoteCounts: [attemptNoteCount]
                            };

                            console.log(`\nğŸ”„ å°è¯• ${attemptIndex + 1}/${fallbackSequence.length}: ${attemptNoteCount}éŸ³é…ç½®`);

                            try {
                                // ğŸ”§ ä¿®å¤ (2025-10-02): åŠŸèƒ½å’Œå£°æ¨¡å¼ä¸‹ä¸ä¼ é€’éšæœºè½¬ä½è®¾ç½®
                                // åŸå› ï¼šåŠŸèƒ½å’Œå£°æ¨¡å¼ä¸‹ï¼Œchord.inversion å·²ç”± applyFunctionalInversions() è®¾ç½®
                                // ä¼ é€’éšæœºè½¬ä½è®¾ç½®ä¼šå¼•èµ·å†²çªï¼Œé’¢ç´å¼•æ“åº”è¯¥åªä½¿ç”¨ chord.inversion
                                const inversionSettings = useFunctionalHarmony ? null : {
                                    includeTriadInversions: window.chordSettings.includeTriadInversions || false,
                                    includeSeventhInversions: window.chordSettings.includeSeventhInversions || false
                                };

                                // ğŸ”§ æ–°å¢ (2025-10-06): æ£€æµ‹è¿ç»­é‡å¤ï¼Œå¼ºåˆ¶ä½¿ç”¨è½¬ä½æ¥å¢åŠ å˜åŒ–
                                if (needsDiversityCheck && !useFunctionalHarmony && inversionSettings && successfulCount > 0) {
                                    const prevChordName = generatedChordNames[generatedChordNames.length - 1];
                                    const currentChordName = `${chord.root}${chord.type}`;

                                    if (prevChordName === currentChordName) {
                                        // è¿ç»­é‡å¤ï¼å¼ºåˆ¶ä½¿ç”¨è½¬ä½
                                        const hasInversionsEnabled = inversionSettings.includeTriadInversions || inversionSettings.includeSeventhInversions;

                                        if (hasInversionsEnabled) {
                                            inversionSettings.forceInversion = true;
                                            inversionSettings.minInversion = 1;  // è‡³å°‘ç¬¬ä¸€è½¬ä½
                                            console.log(`ğŸ¯ æ£€æµ‹åˆ°è¿ç»­é‡å¤: ${prevChordName} â†’ ${currentChordName}`);
                                            console.log(`   å¼ºåˆ¶ä½¿ç”¨è½¬ä½æ¥å¢åŠ å˜åŒ–ï¼ˆminInversion=1ï¼‰`);
                                        } else {
                                            console.log(`âš ï¸ æ£€æµ‹åˆ°è¿ç»­é‡å¤ä½†è½¬ä½æœªå¯ç”¨: ${currentChordName}`);
                                        }
                                    }
                                }

                                // ğŸ” è¯Šæ–­ï¼šæ˜¾ç¤ºè½¬ä½è®¾ç½®æ¥æº
                                if (useFunctionalHarmony) {
                                    console.log(`ğŸ¼ åŠŸèƒ½å’Œå£°æ¨¡å¼ï¼šinversionSettings = nullï¼ˆä½¿ç”¨ chord.inversionï¼‰`);
                                } else {
                                    console.log(`ğŸ² éšæœºæ¨¡å¼ï¼šinversionSettings =`, inversionSettings);
                                }

                                // ğŸ¯ ç¬¬ä¸‰è½¬ä½çº¦æŸæ£€æŸ¥ï¼ˆä»…éšæœºæ¨¡å¼ï¼‰
                                // ğŸ”§ ä¿®å¤ (2025-10-02): åªåœ¨éšæœºæ¨¡å¼ä¸‹æ‰§è¡Œï¼ˆinversionSettings ä¸ä¸º nullï¼‰
                                // éŸ³ä¹ç†è®ºï¼š"Third inversion will sound ambiguous if it is not preceded by a root-position voicing of the same chord"
                                if (!useFunctionalHarmony && inversionSettings) {
                                    const hasTensions = chord.is69Voicing || chord.failed69Conversion;
                                    const isSeventhChord = chord.type.includes('7') ||
                                                          chord.type.includes('9') ||
                                                          chord.type.includes('11') ||
                                                          chord.type.includes('13');
                                    const needsThirdInversionCheck = isSeventhChord || hasTensions;

                                    if (needsThirdInversionCheck && successfulCount > 0) {
                                        const prevChord = generatedChords[successfulCount - 1];
                                        const isSameChord = prevChord.chordInfo.root === chord.root &&
                                                            prevChord.chordInfo.type === chord.type;
                                        const prevWasRootPosition = !prevChord.inversionIndex || prevChord.inversionIndex === 0;

                                        if (!isSameChord || !prevWasRootPosition) {
                                            // ç¦æ­¢ç¬¬ä¸‰è½¬ä½ï¼šæœ€å¤§è½¬ä½è®¾ç½®ä¸º2
                                            inversionSettings.maxInversion = 2;
                                            console.log(`ğŸ¯ ç¬¬ä¸‰è½¬ä½çº¦æŸ: ${chord.root}${chord.type} æœ€å¤§è½¬ä½=2 (ä¸ƒå’Œå¼¦/tensionï¼Œå‰ä¸€å’Œå¼¦ä¸ç¬¦åˆæ¡ä»¶)`);
                                        }
                                    }
                                } else if (useFunctionalHarmony) {
                                    console.log(`ğŸ¼ åŠŸèƒ½å’Œå£°æ¨¡å¼ï¼šç¬¬ä¸‰è½¬ä½çº¦æŸç”± applySeventhChordThirdInversion() å¤„ç†`);
                                }

                                result = pianoEngine.generatePianoChord(
                                    chord,
                                    attemptSettings,
                                    key,
                                    null,
                                    prevBassMidi,
                                    inversionSettings  // ğŸ”§ æ–°å¢å‚æ•° (2025-10-02)
                                );

                                // éªŒè¯ç»“æœ
                                const resultValidation = pianoEngine.validateResult(result, attemptSettings);
                                if (resultValidation.valid) {
                                    generatedSuccessfully = true;
                                    if (attemptIndex > 0) {
                                        // ğŸ”§ ä¿®å¤ (2025-10-06): ç§»é™¤å¯¹maxNoteCountçš„å¼•ç”¨ï¼ˆå˜é‡ä¸å­˜åœ¨ï¼‰
                                        console.warn(`âœ… FallbackæˆåŠŸ: ${chord.root}${chord.type} ä½¿ç”¨${attemptNoteCount}éŸ³é…ç½®ï¼ˆå°è¯•${attemptIndex + 1}/${fallbackSequence.length}ï¼‰`);
                                    } else {
                                        // ğŸ”§ ä¿®å¤ (2025-10-06): ä½¿ç”¨successfulCountæ›¿ä»£iï¼ˆå˜é‡ä¸å­˜åœ¨ï¼‰
                                        console.log(`âœ… å’Œå¼¦ ${successfulCount + 1} ç”ŸæˆæˆåŠŸ: ${attemptNoteCount}éŸ³é…ç½®`);
                                    }
                                    break;  // æˆåŠŸï¼Œè·³å‡ºå°è¯•å¾ªç¯
                                } else {
                                    console.warn(`âš ï¸ ${attemptNoteCount}éŸ³é…ç½®éªŒè¯å¤±è´¥:`, resultValidation.errors);
                                }
                            } catch (attemptError) {
                                console.warn(`âš ï¸ ${attemptNoteCount}éŸ³é…ç½®ç”Ÿæˆå¤±è´¥: ${attemptError.message}`);
                                if (attemptIndex === fallbackSequence.length - 1) {
                                    // ğŸ”§ ä¿®å¤ (2025-10-02 å°è¯•5): å•ä¸€éŸ³æ•°æ¨¡å¼ä¸‹è·³è¿‡å’Œå¼¦ï¼Œä¸æŠ›å‡ºé”™è¯¯
                                    if (userWantsSingleNoteCount) {
                                        console.warn(`â­ï¸ è·³è¿‡å’Œå¼¦ ${chord.root}${chord.type}ï¼ˆç”¨æˆ·åªå‹¾é€‰äº†${originalNoteCounts[0]}éŸ³ï¼Œæ— æ³•æ»¡è¶³çº¦æŸï¼‰`);
                                        // ä¸æŠ›å‡ºé”™è¯¯ï¼Œç»§ç»­ä¸‹ä¸€ä¸ªå’Œå¼¦
                                        break;  // è·³å‡ºå°è¯•å¾ªç¯ï¼Œè¿›å…¥ä¸‹ä¸€ä¸ªå’Œå¼¦
                                    } else {
                                        // å¤šéŸ³æ•°æ¨¡å¼ï¼šæ‰€æœ‰é™çº§å°è¯•éƒ½å¤±è´¥äº†ï¼ŒæŠ›å‡ºé”™è¯¯
                                        throw new Error(`æ‰€æœ‰é™çº§å°è¯•å¤±è´¥: ${chord.root}${chord.type}`);
                                    }
                                }
                                // ç»§ç»­å°è¯•ä¸‹ä¸€ä¸ªéŸ³æ•°
                            }
                        }

                        if (generatedSuccessfully && result) {
                            generatedChords.push(result);
                            successfulCount++;  // ğŸ”§ ä¿®å¤ (2025-10-02 å°è¯•5): æˆåŠŸç”Ÿæˆåå¢åŠ è®¡æ•°

                            // ğŸ”§ æ–°å¢ (2025-10-06): æˆåŠŸæ—¶é‡ç½®å°è¯•è®¡æ•°å™¨
                            if (needsDiversityCheck) {
                                attemptsSinceLastSuccess = 0;  // é‡ç½®
                                const chordName = `${chord.root}${chord.type}`;
                                generatedChordNames.push(chordName);
                                console.log(`ğŸ“ æˆåŠŸç”Ÿæˆ: ${chordName} (æ€»å…±${generatedChordNames.length}ä¸ªï¼Œé‡ç½®å°è¯•è®¡æ•°å™¨)`);
                            }

                            // ğŸ” è¯¦ç»†è¯Šæ–­ç³»ç»Ÿï¼ˆ2025-10-01æ–°å¢ï¼‰
                            console.log(`\nğŸ” ========== å°èŠ‚${successfulCount}è¯¦ç»†è¯Šæ–­ ==========`);
                            console.log(`ğŸµ å’Œå¼¦åç§°: ${chord.root}${chord.type}`);
                            console.log(`ğŸ¹ æ€»éŸ³ç¬¦æ•°: ${result.noteCount}éŸ³`);

                            // ä½éŸ³è°±å·è¯Šæ–­
                            console.log(`\nğŸ“ ä½éŸ³è°±å· (Bass Clef):`);
                            console.log(`  éŸ³ç¬¦æ•°é‡: ${result.bassClefNotes.length}éŸ³`);
                            if (result.bassClefNotes && result.bassClefNotes.length > 0) {
                                const bassNoteNames = result.bassClefNotes.map(midi => {
                                    const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                                    const octave = Math.floor(midi / 12) - 1;
                                    const noteIndex = midi % 12;
                                    return `${noteNames[noteIndex]}${octave}`;
                                });
                                const bassSpan = Math.max(...result.bassClefNotes) - Math.min(...result.bassClefNotes);
                                console.log(`  éŸ³ç¬¦: ${bassNoteNames.join(', ')}`);
                                console.log(`  MIDI: ${result.bassClefNotes.join(', ')}`);
                                console.log(`  è·¨åº¦: ${bassSpan}åŠéŸ³ (${Math.min(...result.bassClefNotes)} â†’ ${Math.max(...result.bassClefNotes)})`);
                            }

                            // é«˜éŸ³è°±å·è¯Šæ–­
                            console.log(`\nğŸ“ é«˜éŸ³è°±å· (Treble Clef):`);
                            console.log(`  éŸ³ç¬¦æ•°é‡: ${result.trebleClefNotes.length}éŸ³`);
                            if (result.trebleClefNotes && result.trebleClefNotes.length > 0) {
                                const trebleNoteNames = result.trebleClefNotes.map(midi => {
                                    const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                                    const octave = Math.floor(midi / 12) - 1;
                                    const noteIndex = midi % 12;
                                    return `${noteNames[noteIndex]}${octave}`;
                                });
                                const trebleSpan = Math.max(...result.trebleClefNotes) - Math.min(...result.trebleClefNotes);
                                const sortedTreble = [...result.trebleClefNotes].sort((a, b) => a - b);

                                // è®¡ç®—ç›¸é‚»éŸ³ç¬¦é—´è·
                                const intervals = [];
                                for (let j = 1; j < sortedTreble.length; j++) {
                                    intervals.push(sortedTreble[j] - sortedTreble[j-1]);
                                }
                                const maxInterval = intervals.length > 0 ? Math.max(...intervals) : 0;
                                const avgInterval = intervals.length > 0 ? (intervals.reduce((a,b) => a+b, 0) / intervals.length).toFixed(1) : 0;

                                console.log(`  éŸ³ç¬¦: ${trebleNoteNames.join(', ')}`);
                                console.log(`  MIDI: ${result.trebleClefNotes.join(', ')}`);
                                console.log(`  è·¨åº¦: ${trebleSpan}åŠéŸ³ (${Math.min(...result.trebleClefNotes)} â†’ ${Math.max(...result.trebleClefNotes)})`);
                                console.log(`  æœ€å¤§é—´è·: ${maxInterval}åŠéŸ³`);
                                console.log(`  å¹³å‡é—´è·: ${avgInterval}åŠéŸ³`);

                                // Close Voicingåˆ¤æ–­
                                if (trebleSpan <= 12) {
                                    console.log(`  âœ… Close Voicing (æ‰€æœ‰éŸ³ç¬¦åœ¨ä¸€ä¸ªå…«åº¦å†…)`);
                                } else {
                                    console.log(`  âš ï¸ éClose Voicing (è·¨åº¦è¶…è¿‡ä¸€ä¸ªå…«åº¦)`);
                                }
                            }

                            // å…¨å±€ç»Ÿè®¡
                            console.log(`\nğŸ“Š æ•´ä½“ç»Ÿè®¡:`);
                            const allNotes = [...result.bassClefNotes, ...result.trebleClefNotes];
                            const globalSpan = Math.max(...allNotes) - Math.min(...allNotes);
                            console.log(`  å…¨å±€è·¨åº¦: ${globalSpan}åŠéŸ³`);
                            console.log(`  éŸ³åŸŸèŒƒå›´: MIDI ${Math.min(...allNotes)} (${(() => {
                                const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                                const midi = Math.min(...allNotes);
                                const octave = Math.floor(midi / 12) - 1;
                                const noteIndex = midi % 12;
                                return `${noteNames[noteIndex]}${octave}`;
                            })()}) â†’ MIDI ${Math.max(...allNotes)} (${(() => {
                                const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                                const midi = Math.max(...allNotes);
                                const octave = Math.floor(midi / 12) - 1;
                                const noteIndex = midi % 12;
                                return `${noteNames[noteIndex]}${octave}`;
                            })()})`);
                            console.log(`========== è¯Šæ–­ç»“æŸ ==========\n`);

                            // ğŸ¼ æ›´æ–°prevBassMidiä¸ºå½“å‰å’Œå¼¦çš„æœ€ä½éŸ³ï¼ˆç”¨äºä¸‹ä¸€ä¸ªå’Œå¼¦çš„Voice Leadingï¼‰
                            if (result.bassClefNotes && result.bassClefNotes.length > 0) {
                                prevBassMidi = Math.min(...result.bassClefNotes);
                                console.log(`ğŸ¼ æ›´æ–°ä½éŸ³å‚è€ƒ: MIDI ${prevBassMidi}`);
                            }
                        }
                    } catch (error) {
                        // ğŸ”§ ä¿®å¤ (2025-10-02): é™çº§ç­–ç•¥å¤±è´¥åçš„å¼‚å¸¸å¤„ç†
                        console.error(`âŒ å’Œå¼¦ (${chord.root}${chord.type}) æ‰€æœ‰é™çº§å°è¯•å¤±è´¥`);
                        console.error(`   åŸå› : ${error.message}`);
                        console.error(`   ğŸ’¡ æ­¤å’Œå¼¦åœ¨æ‰€æœ‰éŸ³æ•°é…ç½®ä¸‹éƒ½æ— æ³•æ»¡è¶³12åŠéŸ³çº¦æŸï¼Œå·²è·³è¿‡`);
                        // ğŸ”§ ä¿®å¤ (2025-10-02 å°è¯•5): ä¸å¢åŠ successfulCountï¼Œç»§ç»­å°è¯•ä¸‹ä¸€ä¸ªå’Œå¼¦
                        // whileå¾ªç¯ä¼šè‡ªåŠ¨é€‰æ‹©ä¸‹ä¸€ä¸ªå’Œå¼¦ï¼Œç›´åˆ°æˆåŠŸç”Ÿæˆè¶³å¤Ÿæ•°é‡
                    }
                }
                    // å†…å±‚å¾ªç¯ç»“æŸ

                    // ğŸ”§ æ–°å¢ (2025-10-06): æ£€æŸ¥ç”Ÿæˆçš„å’Œå¼¦å¤šæ ·æ€§
                    if (needsDiversityCheck && generatedChordNames.length > 0) {
                        const uniqueChords = new Set(generatedChordNames);
                        const diversityRatio = uniqueChords.size / generatedChordNames.length;

                        console.log(`\nğŸ” ========== å’Œå¼¦å¤šæ ·æ€§æ£€æŸ¥ ==========`);
                        console.log(`  ç”Ÿæˆçš„å’Œå¼¦: [${generatedChordNames.join(', ')}]`);
                        console.log(`  å”¯ä¸€å’Œå¼¦æ•°: ${uniqueChords.size}`);
                        console.log(`  æ€»å’Œå¼¦æ•°: ${generatedChordNames.length}`);
                        console.log(`  å¤šæ ·æ€§æ¯”ä¾‹: ${(diversityRatio * 100).toFixed(1)}%`);

                        // åˆ¤æ–­æ ‡å‡†ï¼šè‡³å°‘50%çš„å’Œå¼¦æ˜¯ä¸åŒçš„
                        const isDiverse = uniqueChords.size >= 2 && diversityRatio >= 0.5;

                        if (isDiverse || diversityRetryCount >= maxDiversityRetries) {
                            console.log(`âœ… å¤šæ ·æ€§æ£€æŸ¥é€šè¿‡ (é‡è¯•${diversityRetryCount}æ¬¡)`);
                            finalGeneratedChords = generatedChords;
                            break;  // é€€å‡ºå¤–å±‚å¾ªç¯
                        } else {
                            console.warn(`âš ï¸ å¤šæ ·æ€§ä¸è¶³ï¼ˆç¬¬${diversityRetryCount + 1}æ¬¡å°è¯•ï¼‰`);
                            console.warn(`   å”¯ä¸€å’Œå¼¦åªæœ‰${uniqueChords.size}ç§: ${Array.from(uniqueChords).join(', ')}`);

                            // é‡æ–°ç”Ÿæˆå’Œå¼¦è¿›è¡Œ
                            if (useFunctionalHarmony) {
                                chordProgression = window.generateFunctionalProgression(key, measures);
                            } else {
                                chordProgression = window.generateDiverseProgression(key, measures);
                            }

                            console.log(`ğŸ”„ é‡æ–°ç”Ÿæˆå’Œå¼¦è¿›è¡Œ: ${chordProgression.map(c => `${c.root}${c.type}`).join(', ')}`);
                            diversityRetryCount++;
                            continue;  // ç»§ç»­å¤–å±‚å¾ªç¯
                        }
                    } else {
                        // ä¸éœ€è¦å¤šæ ·æ€§æ£€æŸ¥ï¼Œç›´æ¥ä½¿ç”¨ç»“æœ
                        finalGeneratedChords = generatedChords;
                        break;
                    }
                }
                // å¤–å±‚å¾ªç¯ç»“æŸ

                console.log(`\nâœ… ========== å’Œå¼¦ç”Ÿæˆå®Œæˆ ==========`);
                console.log(`  ç›®æ ‡å°èŠ‚æ•°: ${measures}`);
                console.log(`  æˆåŠŸç”Ÿæˆ: ${successfulCount}å°èŠ‚`);
                console.log(`  å°è¯•å’Œå¼¦æ€»æ•°: ${chordIndex}`);
                console.log(`========================================\n`);

                console.log('ğŸ¹ é’¢ç´å’Œå¼¦è¿›è¡Œç”Ÿæˆå®Œæˆ:', finalGeneratedChords);

                // 6. ğŸµ Phase 4: æ¸²æŸ“MusicXMLå¤§è°±è¡¨
                console.log('\nğŸ¼ ========== Phase 4: å¼€å§‹æ¸²æŸ“å¤§è°±è¡¨MusicXML ==========');

                // 6.1 å°†é’¢ç´å¼•æ“è¾“å‡ºè½¬æ¢ä¸ºæ ‡å‡†å’Œå¼¦å¯¹è±¡æ ¼å¼
                const pianoChordProgression = finalGeneratedChords.map((result, index) => {
                    console.log(`ğŸ¹ è½¬æ¢ç¬¬${index + 1}å°èŠ‚ä¸ºæ ‡å‡†æ ¼å¼:`, result);

                    // ğŸ” è¯Šæ–­æ—¥å¿— (2025-10-02): è¯¦ç»†æ˜¾ç¤ºå’Œå¼¦ä¿¡æ¯
                    console.log(`ğŸ” å’Œå¼¦è¯Šæ–­ä¿¡æ¯:`);
                    console.log(`  - chordInfo.type: ${result.chordInfo.type}`);
                    console.log(`  - chordInfo.is69Voicing: ${result.chordInfo.is69Voicing}`);
                    console.log(`  - tensionsæ•°ç»„: ${JSON.stringify(result.tensions)}`);
                    console.log(`  - tensionsé•¿åº¦: ${result.tensions ? result.tensions.length : 'undefined'}`);

                    // ğŸµ æ£€æµ‹tensionså¹¶æ›´æ–°å’Œå¼¦ç±»å‹ï¼ˆ2025-10-02æ–°å¢ï¼šæ”¯æŒadd2/6/6/9å’Œå¼¦ä»£å·æ˜¾ç¤ºï¼‰
                    let displayType = result.chordInfo.type;

                    // ğŸµ ä¼˜å…ˆæ£€æŸ¥6/9å’Œå¼¦ï¼ˆ2025-10-02æ–°å¢ï¼‰
                    if (result.chordInfo.is69Voicing) {
                        displayType = '6/9';
                        console.log(`ğŸµ æ£€æµ‹åˆ°6/9å’Œå¼¦æ ‡è®°: ${result.chordInfo.root}maj7 â†’ ${result.chordInfo.root}6/9`);
                    } else if (result.tensions && result.tensions.length > 0) {
                        const tensions = result.tensions;
                        console.log(`ğŸµ æ£€æµ‹åˆ°tensions: ${tensions.join(', ')}`);

                        // åˆ¤æ–­æ˜¯ä¸‰å’Œå¼¦è¿˜æ˜¯ä¸ƒå’Œå¼¦
                        const isTriad = !result.chordInfo.type.includes('7') &&
                                       !result.chordInfo.type.includes('9') &&
                                       !result.chordInfo.type.includes('11') &&
                                       !result.chordInfo.type.includes('13');

                        if (isTriad) {
                            // ä¸‰å’Œå¼¦ï¼šæ·»åŠ add2æˆ–6åç¼€
                            if (tensions.includes('13')) {
                                // 6å’Œå¼¦ï¼ˆ13th = å¤§å…­åº¦ï¼‰
                                if (result.chordInfo.type === 'major') {
                                    displayType = '6';
                                } else if (result.chordInfo.type === 'minor') {
                                    displayType = 'm6';
                                } else {
                                    displayType = result.chordInfo.type + '6';
                                }
                                console.log(`  âœ… ä¸‰å’Œå¼¦+13éŸ³ â†’ 6å’Œå¼¦: ${displayType}`);
                            } else if (tensions.includes('9')) {
                                // add2å’Œå¼¦ï¼ˆ9th = å¤§äºŒåº¦ï¼‰
                                if (result.chordInfo.type === 'major') {
                                    displayType = 'add2';
                                } else if (result.chordInfo.type === 'minor') {
                                    displayType = 'madd2';
                                } else {
                                    displayType = result.chordInfo.type + 'add2';
                                }
                                console.log(`  âœ… ä¸‰å’Œå¼¦+9éŸ³ â†’ add2å’Œå¼¦: ${displayType}`);
                            }
                        } else {
                            // ğŸ”§ ä¿®å¤ (2025-10-02): ä¸ƒå’Œå¼¦éœ€è¦åŒºåˆ†æ­£å¸¸tensionå’Œ6/9è½¬æ¢å¤±è´¥
                            // major7å’Œå¼¦æ·»åŠ tensionåï¼Œä»ç„¶æ˜¾ç¤ºä¸ºmaj7ï¼ˆä¸æ˜¾ç¤ºä¸ºmaj9ç­‰ï¼‰
                            // ä½†6/9è½¬æ¢å¤±è´¥æ—¶ï¼ˆä¸ƒéŸ³è¢«è·³è¿‡ï¼‰ï¼Œåº”è¯¥æ˜¾ç¤ºä¸ºadd2/6
                            if (result.chordInfo.type === 'major7' || result.chordInfo.type === 'maj7') {
                                // æ£€æŸ¥æ˜¯å¦ä¸º6/9è½¬æ¢å¤±è´¥ï¼ˆä¸ƒéŸ³å·²è¢«è·³è¿‡ï¼‰
                                if (result.chordInfo.failed69Conversion) {
                                    // 6/9è½¬æ¢å¤±è´¥ï¼šä¸ƒéŸ³å·²è¢«è·³è¿‡ï¼Œåªæœ‰tensions
                                    if (tensions.includes('9') && tensions.includes('13')) {
                                        // åŒæ—¶æœ‰9å’Œ13ä½†éªŒè¯å¤±è´¥ â†’ å¯èƒ½æ˜¯6add9
                                        displayType = '6add9';
                                        console.log(`  âš ï¸ 6/9è½¬æ¢å¤±è´¥ä½†æœ‰9+13 â†’ 6add9å’Œå¼¦: ${displayType}`);
                                    } else if (tensions.includes('13') && !tensions.includes('9')) {
                                        // åªæœ‰13th â†’ 6å’Œå¼¦
                                        displayType = '6';
                                        console.log(`  âš ï¸ 6/9è½¬æ¢å¤±è´¥+ä»…13éŸ³ â†’ 6å’Œå¼¦: ${displayType}`);
                                    } else if (tensions.includes('9') && !tensions.includes('13')) {
                                        // åªæœ‰9th â†’ add2å’Œå¼¦
                                        displayType = 'add2';
                                        console.log(`  âš ï¸ 6/9è½¬æ¢å¤±è´¥+ä»…9éŸ³ â†’ add2å’Œå¼¦: ${displayType}`);
                                    }
                                } else {
                                    // æ­£å¸¸çš„major7å’Œå¼¦ + tensions â†’ ä¿æŒä¸ºmaj7
                                    console.log(`  âœ… major7å’Œå¼¦æ·»åŠ tensionsåä¿æŒæ˜¾ç¤ºä¸ºmaj7`);
                                    // displayTypeå·²ç»æ˜¯'major7'ï¼Œä¸éœ€è¦ä¿®æ”¹
                                }
                            } else {
                                // å…¶ä»–ä¸ƒå’Œå¼¦ï¼štensionså·²ç»åŒ…å«åœ¨åŸtypeä¸­ï¼ˆå¦‚maj9, m11ç­‰ï¼‰
                                console.log(`  â„¹ï¸ ä¸ƒå’Œå¼¦tensionsä¿æŒåŸtype: ${displayType}`);
                            }
                        }
                    }

                    // ğŸ¼ åˆ›å»ºå…¼å®¹ç°æœ‰MusicXMLç³»ç»Ÿçš„å’Œå¼¦å¯¹è±¡
                    const formattedChord = {
                        root: result.chordInfo.root,
                        type: displayType,  // ğŸ”§ ä¿®æ”¹ï¼šä½¿ç”¨æ›´æ–°åçš„displayType
                        quality: result.chordInfo.quality,
                        // ğŸ¹ é’¢ç´ä¸“ç”¨æ ‡è®°ï¼šåŒ…å«åŒè°±è¡¨MIDIæ•°æ®
                        isPianoMode: true,
                        pianoData: {
                            bassClefMidi: result.bassClefNotes,
                            trebleClefMidi: result.trebleClefNotes,
                            noteCount: result.noteCount
                        },
                        // åˆ›å»ºå…¼å®¹voicingå¯¹è±¡ä¾›MusicXMLç³»ç»Ÿä½¿ç”¨
                        voicing: {
                            type: `piano-${result.noteCount}notes`,
                            midiNotes: result.allNotes, // æ‰€æœ‰éŸ³ç¬¦æŒ‰éŸ³é«˜æ’åº
                            notes: result.allNotes.map(midi => {
                                // ç®€å•çš„MIDIåˆ°éŸ³ç¬¦åç§°è½¬æ¢ï¼ˆåç»­ç”±midiToPitchInfoç²¾ç¡®å¤„ç†ï¼‰
                                const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                                const octave = Math.floor(midi / 12) - 1;
                                const noteIndex = midi % 12;
                                return noteNames[noteIndex] + octave;
                            })
                        }
                    };

                    console.log(`âœ… ç¬¬${index + 1}å°èŠ‚è½¬æ¢å®Œæˆ:`, formattedChord);
                    return formattedChord;
                });

                // 6.2 æ„å»ºå®Œæ•´çš„å’Œå¼¦å¯¹è±¡ä¾›displayChordsä½¿ç”¨

                // ğŸ¯ å®‰å…¨åœ°æ„é€ keyInfoå¯¹è±¡ï¼ˆå¢å¼ºæ–¹æ¡ˆï¼šç›´æ¥æ„é€ ï¼Œä¸ä¾èµ–æŸ¥æ‰¾ï¼‰
                // ğŸ”§ ä¿®å¤ (2025-10-01): é’¢ç´æ¨¡å¼æ‹¼å†™é—®é¢˜ - ç¡®ä¿keyInfoæ­£ç¡®ä¼ é€’
                let keyInfo;

                // å°è¯•ä»harmonyTheory.keysæŸ¥æ‰¾
                if (window.harmonyTheory && window.harmonyTheory.keys && window.harmonyTheory.keys[key]) {
                    keyInfo = window.harmonyTheory.keys[key];
                    console.log(`âœ… ä»harmonyTheory.keysæŸ¥æ‰¾åˆ°keyInfo:`, keyInfo);
                } else {
                    // æŸ¥æ‰¾å¤±è´¥ï¼Œæ‰‹åŠ¨æ„é€ keyInfoå¯¹è±¡
                    console.warn(`âš ï¸ harmonyTheory.keys[${key}]æŸ¥æ‰¾å¤±è´¥ï¼Œæ‰‹åŠ¨æ„é€ keyInfo`);

                    // è§£ækeyå­—ç¬¦ä¸²ï¼ˆå¦‚ "C-major", "a-minor", "Eb-major"ï¼‰
                    const [tonicStr, modeStr] = key.split('-');
                    const mode = modeStr || 'major';

                    // æ‰‹åŠ¨æ„é€ keyInfoï¼ˆå‚è€ƒharmony-theory.jsçš„keyså¯¹è±¡ç»“æ„ï¼‰
                    const sharpKeys = {
                        'G': 1, 'D': 2, 'A': 3, 'E': 4, 'B': 5, 'F#': 6, 'C#': 7
                    };
                    const flatKeys = {
                        'F': 1, 'Bb': 2, 'Eb': 3, 'Ab': 4, 'Db': 5, 'Gb': 6, 'Cb': 7
                    };

                    let sharps = 0;
                    let flats = 0;
                    let tonic = tonicStr;

                    if (mode === 'major') {
                        if (sharpKeys[tonicStr]) {
                            sharps = sharpKeys[tonicStr];
                        } else if (flatKeys[tonicStr]) {
                            flats = flatKeys[tonicStr];
                        }
                    } else if (mode === 'minor') {
                        // å°è°ƒçš„å‡é™å·æ•°é‡ï¼ˆç›¸å¯¹å¤§è°ƒ-3ä¸ªå‡å·æˆ–+3ä¸ªé™å·ï¼‰
                        const minorSharpKeys = {
                            'e': 1, 'b': 2, 'f#': 3, 'c#': 4, 'g#': 5, 'd#': 6, 'a#': 7
                        };
                        const minorFlatKeys = {
                            'd': 1, 'g': 2, 'c': 3, 'f': 4, 'bb': 5, 'eb': 6, 'ab': 7
                        };

                        const tonicLower = tonicStr.toLowerCase();
                        if (minorSharpKeys[tonicLower]) {
                            sharps = minorSharpKeys[tonicLower];
                        } else if (minorFlatKeys[tonicLower]) {
                            flats = minorFlatKeys[tonicLower];
                        }

                        // è°ƒæ•´tonicä¸ºé¦–å­—æ¯å°å†™ï¼ˆå°è°ƒæƒ¯ä¾‹ï¼‰
                        tonic = tonicStr.charAt(0).toLowerCase() + tonicStr.slice(1);
                    }

                    keyInfo = {
                        tonic: tonic,
                        mode: mode,
                        sharps: sharps,
                        flats: flats
                    };

                    console.log(`ğŸ”§ æ‰‹åŠ¨æ„é€ keyInfo:`, keyInfo);
                }

                console.log(`ğŸ¯ æœ€ç»ˆä½¿ç”¨çš„keyInfo:`, keyInfo, `(åŸºäºè°ƒå·: ${key})`);

                // ğŸ” è¯Šæ–­ï¼šéªŒè¯Fb/Cbè§„åˆ™æ˜¯å¦åº”è¯¥è§¦å‘
                if (keyInfo.flats >= 6) {
                    console.log(`ğŸµ è¯Šæ–­ï¼šè°ƒå·æœ‰${keyInfo.flats}ä¸ªé™å·ï¼Œåº”è¯¥ä½¿ç”¨Fbå’ŒCb`);
                } else if (keyInfo.mode === 'minor' && keyInfo.tonic === 'Db') {
                    console.log(`ğŸµ è¯Šæ–­ï¼šdbå°è°ƒç‰¹æ®Šæƒ…å†µï¼Œåº”è¯¥ä½¿ç”¨Fb`);
                } else {
                    console.log(`ğŸµ è¯Šæ–­ï¼šè°ƒå·${keyInfo.tonic}-${keyInfo.mode}æœ‰${keyInfo.flats}ä¸ªé™å·/${keyInfo.sharps}ä¸ªå‡å·ï¼Œåº”è¯¥ä½¿ç”¨Eå’ŒB`);
                }

                const chordsObject = {
                    progression: pianoChordProgression,
                    measures: pianoChordProgression.length,
                    key: 'C-major', // ä¿æŒå®‰å…¨çš„é»˜è®¤å€¼
                    keyInfo: keyInfo, // ğŸ¯ æ–°å¢ï¼šç›´æ¥ä¼ é€’æ„é€ å¥½çš„keyInfoå¯¹è±¡
                    timestamp: Date.now(),
                    isPianoMode: true // ğŸ¹ æ ‡è®°ä¸ºé’¢ç´æ¨¡å¼
                };

                console.log('ğŸ¹ é’¢ç´å’Œå¼¦å¯¹è±¡:', chordsObject);
                console.log('ğŸ” è¯Šæ–­ï¼šchordsObject.keyInfoç¡®è®¤:', chordsObject.keyInfo);

                // ğŸ”§ ä¿®å¤ (2025-10-01): æ·»åŠ åˆ°å†å²è®°å½•ï¼ˆä½¿ä¸Šä¸€æ¡/ä¸‹ä¸€æ¡åŠŸèƒ½æ­£å¸¸å·¥ä½œï¼‰
                if (typeof window.currentChords !== 'undefined') {
                    window.currentChords = chordsObject;
                }
                if (typeof window.chordsHistory !== 'undefined' && typeof window.currentChordsIndex !== 'undefined') {
                    window.chordsHistory.push(chordsObject);
                    window.currentChordsIndex = window.chordsHistory.length - 1;
                    console.log(`ğŸ“‹ å·²æ·»åŠ åˆ°å†å²è®°å½• (ç´¢å¼•: ${window.currentChordsIndex}, æ€»æ•°: ${window.chordsHistory.length})`);
                }

                // 6.3 è°ƒç”¨displayChordsæ¸²æŸ“åˆ°äº”çº¿è°±
                // displayChordsä¼šè‡ªåŠ¨æ£€æµ‹é’¢ç´æ¨¡å¼å¹¶ä½¿ç”¨å¤§è°±è¡¨æ¸²æŸ“
                console.log('ğŸ¼ è°ƒç”¨displayChordsæ¸²æŸ“å¤§è°±è¡¨...');
                displayChords(chordsObject);

                console.log('âœ… é’¢ç´å¤§è°±è¡¨æ¸²æŸ“å®Œæˆ');

            } catch (error) {
                console.error('âŒ é’¢ç´å’Œå¼¦ç”Ÿæˆå¤±è´¥:', error);
                alert(`ç”Ÿæˆå¤±è´¥ï¼š${error.message}\nè¯·æŸ¥çœ‹æ§åˆ¶å°äº†è§£è¯¦æƒ…`);
            }

            console.log('ğŸ¹ ========== é’¢ç´å’Œå¼¦ç”Ÿæˆç»“æŸ ==========');
        }

        // ä¿å­˜è®¾ç½®çš„å‡½æ•°ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰

        function saveRhythmSettings() {
            console.log('ğŸ’¾ ä¿å­˜èŠ‚å¥è®¾ç½®...');
            // è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„ä¿å­˜é€»è¾‘

            // ğŸ”§ 2025-10-01 ä¿®å¤ï¼šæ›´æ–°åŠ¨æ€æ§ä»¶ç¿»è¯‘
            updateDynamicControlsTranslation();
            console.log('ğŸ”„ å·²æ›´æ–°åŠ¨æ€æ§ä»¶ç¿»è¯‘');

            closeRhythmSettings();
            console.log('âœ… èŠ‚å¥è®¾ç½®å·²ä¿å­˜ï¼Œå¼¹çª—å·²å…³é—­');
        }

        function saveKeySettings() {
            console.log('ğŸ’¾ ä¿å­˜è°ƒå·è®¾ç½®...');

            // ğŸ” è¯Šæ–­ï¼šè®°å½•ä¿å­˜å‰çš„åŠŸèƒ½å’Œå£°çŠ¶æ€
            const functionalToggleBefore = document.getElementById('functionalHarmonyToggle');
            const stateBefore = {
                toggleExists: !!functionalToggleBefore,
                toggleChecked: functionalToggleBefore ? functionalToggleBefore.checked : null,
                chordSettingsExists: typeof window.chordSettings !== 'undefined',
                useFunctionalHarmony: window.chordSettings ? window.chordSettings.useFunctionalHarmony : null
            };
            console.log('ğŸ” ä¿å­˜å‰çŠ¶æ€:', stateBefore);

            // è·å–æ‰€æœ‰é€‰ä¸­çš„è°ƒå·
            const selectedKeys = [];
            const keyCheckboxes = document.querySelectorAll('#keySignatureModal input[type="checkbox"]:checked');

            console.log(`ğŸ” æ‰¾åˆ°${keyCheckboxes.length}ä¸ªé€‰ä¸­çš„è°ƒå·checkbox`);
            keyCheckboxes.forEach(checkbox => {
                selectedKeys.push(checkbox.value);
                console.log(`  âœ… é€‰ä¸­è°ƒå·: ${checkbox.value}`);
            });

            console.log(`ğŸ¯ æ€»å…±æ”¶é›†äº†${selectedKeys.length}ä¸ªè°ƒå·:`, selectedKeys);

            // ä¿å­˜åˆ°å…¨å±€è®¾ç½® (ä½¿ç”¨æ­£ç¡®çš„keyså­—æ®µ)
            if (typeof window.chordSettings !== 'undefined') {
                // ğŸ”§ 2025-09-30 ä¿®å¤ï¼šä¿å­˜è°ƒå·è®¾ç½®æ—¶ä¿ç•™åŠŸèƒ½å’Œå£°æ¨¡å¼çŠ¶æ€
                // é—®é¢˜ï¼šåªæ›´æ–°keyså¯èƒ½ä¸ä¼šä¿ç•™å…¶ä»–è®¾ç½®
                // è§£å†³ï¼šæ˜ç¡®ä¿ç•™ useFunctionalHarmony çš„å½“å‰å€¼
                const currentFunctionalState = window.chordSettings.useFunctionalHarmony;
                window.chordSettings.keys = selectedKeys;
                // ç¡®ä¿åŠŸèƒ½å’Œå£°çŠ¶æ€ä¸è¢«æ”¹å˜
                window.chordSettings.useFunctionalHarmony = currentFunctionalState;
                console.log('ğŸ¯ å·²ä¿å­˜è°ƒå·è®¾ç½®åˆ° chordSettings.keys:', selectedKeys);
                console.log('ğŸ”’ åŠŸèƒ½å’Œå£°çŠ¶æ€ä¿æŒä¸å˜:', currentFunctionalState);
            } else {
                // ğŸ”§ ä¿®å¤ï¼šå¦‚æœchordSettingsä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ªå¸¦é»˜è®¤å€¼çš„å¯¹è±¡
                // é‡è¦ï¼šä¸è¦è¦†ç›–å·²å­˜åœ¨çš„chordSettingsï¼
                if (!window.chordSettings) {
                    window.chordSettings = {
                        keys: selectedKeys,
                        useFunctionalHarmony: true  // ä¿ç•™é»˜è®¤çš„åŠŸèƒ½å’Œå£°æ¨¡å¼çŠ¶æ€
                    };
                } else {
                    window.chordSettings.keys = selectedKeys;
                }
                console.log('ğŸ¯ å·²åˆ›å»ºå¹¶ä¿å­˜è°ƒå·è®¾ç½®åˆ° chordSettings.keys:', selectedKeys);
            }

            // æ›´æ–°æ˜¾ç¤ºçŠ¶æ€
            updateKeySettingsDisplay(selectedKeys);

            closeKeySignatureSettings();

            // ğŸ” è¯Šæ–­ï¼šè®°å½•ä¿å­˜åçš„åŠŸèƒ½å’Œå£°çŠ¶æ€
            const functionalToggleAfter = document.getElementById('functionalHarmonyToggle');
            const stateAfter = {
                toggleExists: !!functionalToggleAfter,
                toggleChecked: functionalToggleAfter ? functionalToggleAfter.checked : null,
                chordSettingsExists: typeof window.chordSettings !== 'undefined',
                useFunctionalHarmony: window.chordSettings ? window.chordSettings.useFunctionalHarmony : null
            };
            console.log('ğŸ” ä¿å­˜åçŠ¶æ€:', stateAfter);

            // ğŸš¨ æ£€æµ‹çŠ¶æ€å˜åŒ–
            if (stateBefore.toggleChecked !== stateAfter.toggleChecked) {
                console.warn('ğŸš¨ è­¦å‘Šï¼šåŠŸèƒ½å’Œå£°toggleçŠ¶æ€å‘ç”Ÿäº†å˜åŒ–ï¼');
                console.warn(`   - å˜åŒ–å‰: ${stateBefore.toggleChecked}`);
                console.warn(`   - å˜åŒ–å: ${stateAfter.toggleChecked}`);
            }
            if (stateBefore.useFunctionalHarmony !== stateAfter.useFunctionalHarmony) {
                console.warn('ğŸš¨ è­¦å‘Šï¼šchordSettings.useFunctionalHarmonyå‘ç”Ÿäº†å˜åŒ–ï¼');
                console.warn(`   - å˜åŒ–å‰: ${stateBefore.useFunctionalHarmony}`);
                console.warn(`   - å˜åŒ–å: ${stateAfter.useFunctionalHarmony}`);
            }

            // ğŸ”§ 2025-09-30 ä¿®å¤ï¼šæ›´æ–°åŠ¨æ€æ§ä»¶ç¿»è¯‘ï¼Œç¡®ä¿labelæ–‡å­—ä¸toggleçŠ¶æ€åŒæ­¥
            // é—®é¢˜ï¼šapplyTranslations()ä¼šå°†harmonyModeLabelé‡ç½®ä¸ºdata-i18nçš„é»˜è®¤å€¼"éšæœºæ¨¡å¼"
            // è§£å†³ï¼šè°ƒç”¨updateDynamicControlsTranslation()æ ¹æ®toggleå®é™…çŠ¶æ€æ›´æ–°æ–‡å­—
            updateDynamicControlsTranslation();
            console.log('ğŸ”„ å·²æ›´æ–°åŠ¨æ€æ§ä»¶ç¿»è¯‘ï¼Œç¡®ä¿åŠŸèƒ½å’Œå£°labelæ–‡å­—æ­£ç¡®');

            console.log('âœ… è°ƒå·è®¾ç½®å·²ä¿å­˜ï¼Œå¼¹çª—å·²å…³é—­');
        }

        function updateKeySettingsDisplay(selectedKeys) {
            const keyBtn = document.getElementById('keySettingsBtn');
            if (keyBtn) {
                // å§‹ç»ˆæ˜¾ç¤ºå›ºå®šçš„"è°ƒå·è®¾ç½®"æ–‡æœ¬ï¼Œä¸æ˜¾ç¤ºå…·ä½“æ•°é‡
                keyBtn.textContent = translate('controls.KeySettings');
                console.log(`ğŸ¯ è°ƒå·æŒ‰é’®ä¿æŒå›ºå®šæ˜¾ç¤º: ${translate('controls.KeySettings')} (å·²é€‰æ‹©${selectedKeys ? selectedKeys.length : 0}ä¸ªè°ƒå·)`);
            }
        }

        function saveTimeSignatureSettings() {
            console.log('ğŸ’¾ ä¿å­˜æ‹å·è®¾ç½®...');
            // è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„ä¿å­˜é€»è¾‘

            // ğŸ”§ 2025-10-01 ä¿®å¤ï¼šæ›´æ–°åŠ¨æ€æ§ä»¶ç¿»è¯‘
            updateDynamicControlsTranslation();
            console.log('ğŸ”„ å·²æ›´æ–°åŠ¨æ€æ§ä»¶ç¿»è¯‘');

            closeTimeSignatureSettings();
            console.log('âœ… æ‹å·è®¾ç½®å·²ä¿å­˜ï¼Œå¼¹çª—å·²å…³é—­');
        }

        function saveClefSettings() {
            console.log('ğŸ’¾ ä¿å­˜è°±å·è®¾ç½®...');
            // è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„ä¿å­˜é€»è¾‘

            // ğŸ”§ 2025-10-01 ä¿®å¤ï¼šæ›´æ–°åŠ¨æ€æ§ä»¶ç¿»è¯‘
            updateDynamicControlsTranslation();
            console.log('ğŸ”„ å·²æ›´æ–°åŠ¨æ€æ§ä»¶ç¿»è¯‘');

            closeClefSettings();
            console.log('âœ… è°±å·è®¾ç½®å·²ä¿å­˜ï¼Œå¼¹çª—å·²å…³é—­');
        }

        // å¢å¼ºç¿»è¯‘åº”ç”¨åŠŸèƒ½
        function applyTranslationsToModals() {
            // ğŸ”§ ä½¿ç”¨ I18n ç³»ç»Ÿ (2025-10-04)
            // å¼ºåˆ¶é‡æ–°åº”ç”¨ç¿»è¯‘åˆ°æ‰€æœ‰æ¨¡æ€æ¡†
            if (window.I18n && window.I18n.applyLanguage) {
                window.I18n.applyLanguage(currentLanguage);
                console.log('ğŸŒ æ¨¡æ€æ¡†ç¿»è¯‘å·²é€šè¿‡I18nç³»ç»Ÿé‡æ–°åº”ç”¨');
            } else {
                console.warn('âš ï¸ I18nç³»ç»ŸæœªåŠ è½½ï¼Œæ— æ³•åº”ç”¨æ¨¡æ€æ¡†ç¿»è¯‘');
            }
        }

        // é‡å†™è¯­è¨€åˆ‡æ¢å‡½æ•°ä»¥ç¡®ä¿æ¨¡æ€æ¡†ç¿»è¯‘
        function switchLanguage(language) {
            currentLanguage = language;
            localStorage.setItem('preferredLanguage', language);
            applyTranslations();
            applyTranslationsToModals(); // é¢å¤–åº”ç”¨æ¨¡æ€æ¡†ç¿»è¯‘
            updateDynamicControlsTranslation(); // æ›´æ–°åŠ¨æ€æ§ä»¶ç¿»è¯‘

            // è§¦å‘ç»Ÿä¸€åŒæ­¥ç³»ç»Ÿ (åŒæ ‡ç­¾é¡µå†…å®æ—¶åŒæ­¥)
            if (window.ICStudioSync) {
                window.ICStudioSync.syncLanguage(language, 'chord-tool');
            }

            // å…³é—­è®¾ç½®èœå•
            if (typeof closeSettings === 'function') {
                closeSettings();
            }

            console.log(`ğŸŒ å’Œå¼¦è§†å¥å·¥å…·è¯­è¨€å·²åˆ‡æ¢ä¸º: ${language}ï¼Œæ¨¡æ€æ¡†ç¿»è¯‘å·²æ›´æ–°`);
        }

        // âŒ¨ï¸ å…¨å±€é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(e) {
            // å¦‚æœåœ¨è¾“å…¥æ¡†ã€æ–‡æœ¬æ¡†æˆ–æ¨¡æ€æ¡†è¾“å…¥ä¸­ï¼Œä¸è§¦å‘å¿«æ·é”®
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                return;
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰æ¨¡æ€æ¡†æ‰“å¼€ï¼ˆé¿å…åœ¨è®¾ç½®ä¸­è§¦å‘ï¼‰
            const hasOpenModal = document.querySelector('.modal:not([style*="display: none"])');
            if (hasOpenModal) {
                return;
            }

            const key = e.key.toLowerCase();

            switch(key) {
                case 'p':
                    // æ’­æ”¾/æš‚åœæ’­æ”¾
                    e.preventDefault();
                    if (typeof directPlayTest === 'function') {
                        directPlayTest();
                        console.log('âŒ¨ï¸ å¿«æ·é”®: P - æ’­æ”¾/æš‚åœ');
                    }
                    break;

                case 'arrowleft':
                    // ä¸Šä¸€æ¡
                    e.preventDefault();
                    if (typeof previousChords === 'function') {
                        previousChords();
                        console.log('âŒ¨ï¸ å¿«æ·é”®: â† - ä¸Šä¸€æ¡');
                    }
                    break;

                case 'arrowright':
                    // ä¸‹ä¸€æ¡
                    e.preventDefault();
                    if (typeof nextChords === 'function') {
                        nextChords();
                        console.log('âŒ¨ï¸ å¿«æ·é”®: â†’ - ä¸‹ä¸€æ¡');
                    }
                    break;

                case ' ':
                    // ç”Ÿæˆï¼ˆç©ºæ ¼é”®ï¼‰
                    e.preventDefault();
                    const generateBtn = document.getElementById('generateChordsBtn');
                    if (generateBtn) {
                        generateBtn.click();
                        console.log('âŒ¨ï¸ å¿«æ·é”®: Space - ç”Ÿæˆå’Œå¼¦');
                    }
                    break;

                case 'h':
                    // éšè—/æ˜¾ç¤º
                    e.preventDefault();
                    if (typeof toggleMelodyVisibility === 'function') {
                        toggleMelodyVisibility();
                        console.log('âŒ¨ï¸ å¿«æ·é”®: H - éšè—/æ˜¾ç¤º');
                    }
                    break;

                case 'c':
                    // èŠ‚æ‹å™¨å¼€å…³
                    e.preventDefault();
                    if (typeof toggleMetronome === 'function') {
                        toggleMetronome();
                        console.log('âŒ¨ï¸ å¿«æ·é”®: C - èŠ‚æ‹å™¨å¼€å…³');
                    }
                    break;
            }
        });

        console.log('âŒ¨ï¸ å’Œå¼¦è§†å¥å·¥å…·å¿«æ·é”®å·²å¯ç”¨: P=æ’­æ”¾ â†â†’=å¯¼èˆª Space=ç”Ÿæˆ H=éšè— C=èŠ‚æ‹å™¨');

    </script>

    <script>
        // ç»ƒä¹ è®¡æ•°å™¨ï¼ˆä¼šè¯å†…è®¡æ•°ï¼Œåˆ·æ–°æ¸…é›¶ï¼‰
        function loadPracticeCount(){
            const el = document.getElementById('practiceCountValue');
            if (!el) return 0;
            const v = parseInt(el.textContent || '0', 10);
            return isFinite(v) ? Math.max(0, v) : 0;
        }

        function updatePracticeCountDisplay(val){
            const el = document.getElementById('practiceCountValue');
            if (el) el.textContent = String(Math.max(0, val));
        }

        window.incrementPracticeCount = function(){
            const next = loadPracticeCount() + 1;
            updatePracticeCountDisplay(next);
        };

        window.decrementPracticeCount = function(){
            const next = Math.max(0, loadPracticeCount() - 1);
            updatePracticeCountDisplay(next);
        };

        document.addEventListener('DOMContentLoaded', function(){
            updatePracticeCountDisplay(0);
        });
    </script>

    <script>
        window.IC_MIDI_CONFIG = {
            getAudioContext: () => {
                if (typeof window.getChordAudioContext === 'function') {
                    const ctx = window.getChordAudioContext();
                    if (ctx) return ctx;
                }
                if (!window.__chordMidiAudioCtx) {
                    window.__chordMidiAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (window.__chordMidiAudioCtx && window.__chordMidiAudioCtx.state === 'suspended') {
                    window.__chordMidiAudioCtx.resume().catch(()=>{});
                }
                return window.__chordMidiAudioCtx;
            },
            sampleRoot: 'assets/samples/piano-ogg-full',
            useSamplePlayer: true,
            translations: (typeof I18n !== 'undefined' ? I18n.translations : null),
            getLanguage: () => {
                try { return localStorage.getItem('preferredLanguage') || 'zh-CN'; } catch(_) { return 'zh-CN'; }
            }
        };
    </script>
    <script src="assets/js/midi-input.js?v=1"></script>

    <!-- æŒ‘æˆ˜æ¨¡å¼é€»è¾‘ -->
    <script src="./IC å’Œå¼¦è§†å¥å·¥å…·_files/challenge-mode.js"></script>

    <script>
        // è®©è¯•ç”¨ç³»ç»Ÿå¤ç”¨ generateMelody å…¥å£
        if (typeof window.generateChords === 'function') {
            const originalGenerateChords = window.generateChords;
            if (typeof window.generateMelody !== 'function') {
                window.generateMelody = function(...args) {
                    return originalGenerateChords.apply(this, args);
                };
            }
            window.generateChords = function(...args) {
                if (typeof window.generateMelody === 'function' && window.generateMelody !== window.generateChords) {
                    return window.generateMelody(...args);
                }
                return originalGenerateChords.apply(this, args);
            };
        }
    </script>

    <!-- ğŸ›¡ï¸ è¯•ç”¨ä¿æŠ¤ç³»ç»Ÿè„šæœ¬ -->
    <script defer src="/js/tool-access-loader.js?v=1.0.2"></script>
</body></html>
