<!DOCTYPE html>
<!-- saved from url=(0269)file:///Users/igorchen/Downloads/IC%20Studio/IC%20%E8%A7%86%E5%A5%8F%E5%B7%A5%E5%85%B7%20%E7%AC%AC%E4%B8%80%E7%89%88%20(%E5%B7%B2%E4%B8%8A%E6%9E%B6)%20%E9%9F%B3%E7%A8%8B%E4%BF%AE%E5%A4%8D%E4%B8%AD%202/%E5%92%8C%E5%BC%A6%E8%A7%86%E5%A5%8F%E7%94%9F%E6%88%90%E5%99%A8.html -->
<html lang="zh-CN" data-theme="light"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IC ËßÜÂ•èÂ∑•ÂÖ∑</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com/">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="">
    <link href="./IC ÂíåÂº¶ËßÜÂ•èÂ∑•ÂÖ∑_files/css2" rel="stylesheet">

    <!-- OpenSheetMusicDisplay -->
    <script src="./IC ÂíåÂº¶ËßÜÂ•èÂ∑•ÂÖ∑_files/opensheetmusicdisplay.min.js"></script>

    <!-- üéπ Èí¢Áê¥Èü≥Êï∞ÁîüÊàêÂºïÊìé -->
    <script src="./IC ÂíåÂº¶ËßÜÂ•èÂ∑•ÂÖ∑_files/piano-note-count-engine.js"></script>

    <!-- Âà†Èô§SpessaSynth - ÊîπÁî®Êõ¥ÁÆÄÂçïÁöÑWeb Audio APIÊñπÊ°à -->

    <link rel="stylesheet" href="./IC ÂíåÂº¶ËßÜÂ•èÂ∑•ÂÖ∑_files/apple-ui-styles-chord.css">
    <link rel="stylesheet" href="./IC ÂíåÂº¶ËßÜÂ•èÂ∑•ÂÖ∑_files/chord-responsive-styles.css">

    <!-- Icon -->    

    <link rel="icon" type="image/png" href="/ICLOGO.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/ICLOGO.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/ICLOGO.png">
    <link rel="icon" type="image/png" sizes="64x64" href="/ICLOGO.png">
    <meta name="msapplication-TileImage" content="/ICLOGO.png">
    <meta name="theme-color" content="#ffffff">

    <!-- Umami Analytics -->
    <script defer src="https://cloud.umami.is/script.js" data-website-id="24f8b47e-5590-49d6-a19e-4c34929d6741"></script> 

</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="header-text">
                    <h1 data-i18n="app.title">IC Studio - ÂíåÂº¶ËßÜÂ•èÁîüÊàêÂô®</h1>
                    <p data-i18n="app.subtitle">‰∏ì‰∏öÁ∫ß‰πêË∞±Ê∏≤Êüì‰∏éÈü≥‰πêÁêÜËÆ∫Â∑•ÂÖ∑</p>
                </div>
                <div class="header-controls">
                    <div class="function-selector">
                        <button class="function-btn" id="functionBtn" onclick="toggleFunctionSelector()">
                            üéπ <span id="currentFunction" data-i18n="app.chordMode">ÂíåÂº¶ËßÜÂ•è</span>
                        </button>
                        <div class="function-menu" id="functionMenu">
                            <div class="function-option" onclick="switchFunction('melody')">
                                <span class="function-icon">üéµ</span>
                                <span data-i18n="app.melodyMode">ÊóãÂæãËßÜÂ•è</span>
                            </div>
                            <div class="function-option" onclick="switchFunction('interval')">
                                <span class="function-icon">üéº</span>
                                <span data-i18n="app.intervalMode">Èü≥Á®ãËßÜÂ•è</span>
                            </div>
                            <div class="function-option" onclick="switchFunction('chord')">
                                <span class="function-icon">üéπ</span>
                                <span data-i18n="app.chordMode">ÂíåÂº¶ËßÜÂ•è</span>
                            </div>
                        </div>
                    </div>
                    <div class="settings-dropdown">
                        <button class="settings-btn" id="settingsBtn" onclick="toggleSettings()">
                            ‚öôÔ∏è <span data-i18n="settings.title">ËÆæÁΩÆ</span>
                        </button>
                        <div class="settings-menu" id="settingsMenu">
                            <!-- ‰∏ªÈ¢òËÆæÁΩÆ -->
                            <div class="settings-section">
                                <div class="settings-section-title" data-i18n="settings.theme">‰∏ªÈ¢ò</div>
                                <div class="theme-options">
                                    <div class="theme-option" onclick="setTheme('light&')">
                                        <span class="theme-icon">‚òÄÔ∏è</span>
                                        <span data-i18n="settings.lightMode">ÊµÖËâ≤Ê®°Âºè</span>
                                    </div>
                                    <div class="theme-option" onclick="setTheme('dark')">
                                        <span class="theme-icon">üåô</span>
                                        <span data-i18n="settings.darkMode">Ê∑±Ëâ≤Ê®°Âºè</span>
                                    </div>
                                </div>
                            </div>

                            <!-- ËØ≠Ë®ÄËÆæÁΩÆ -->
                            <div class="settings-section">
                                <div class="settings-section-title" data-i18n="settings.language">ËØ≠Ë®Ä</div>
                                <div class="language-options">
                                    <div class="language-option" onclick="switchLanguage('zh-CN')">
                                        ÁÆÄ‰Ωì‰∏≠Êñá
                                    </div>
                                    <div class="language-option" onclick="switchLanguage('zh-TW')">
                                        ÁπÅÈ´î‰∏≠Êñá
                                    </div>
                                    <div class="language-option" onclick="switchLanguage('en')">
                                        English
                                    </div>
                                </div>
                            </div>


                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="control-row">
                <div class="control-group">
                    <label data-i18n="controls.chordType">ÂíåÂº¶Á±ªÂûã</label>
                    <button class="btn-secondary" onclick="openChordTypeSettings()" id="chordTypeSettingsBtn" data-i18n="controls.chordTypeSettings">ÂíåÂº¶Á±ªÂûãËÆæÁΩÆ</button>
                </div>

                <div class="control-group">
                    <label data-i18n="controls.harmonyMode">ÂíåÂ£∞Ê®°Âºè</label>
                    <div class="harmony-mode-toggle" style="display: flex; align-items: center; gap: 10px;">
                        <label class="switch" style="position: relative; display: inline-block; width: 60px; height: 34px;">
                            <input type="checkbox" id="functionalHarmonyToggle" onchange="toggleFunctionalHarmony()" style="opacity: 0; width: 0; height: 0;">
                            <span class="slider" style="position: absolute; cursor: pointer; inset: 0px; background-color: rgb(255, 149, 0); transition: 0.4s; border-radius: 34px;">
                                <span class="slider-button" style="position: absolute; content: &quot;&quot;; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: 0.4s; border-radius: 50%; transform: translateX(26px);"></span>
                            </span>
                        </label>
                        <span id="harmonyModeLabel" data-i18n="controls.randomMode" style="font-size: 14px; color: var(--text-color);">ÂäüËÉΩÂíåÂ£∞</span>
                    </div>

                    <div class="instrument-mode-section" style="margin-top: 12px;">
                        <label data-i18n="controls.instrumentMode" style="display: block; margin-bottom: 6px; font-size: 14px; font-weight: 500;">‰πêÂô®Ê®°Âºè</label>
                        <div class="instrument-mode-toggle" style="display: flex; align-items: center; gap: 10px;">
                            <label class="switch" style="position: relative; display: inline-block; width: 60px; height: 34px;">
                                <input type="checkbox" id="instrumentModeToggle" onchange="toggleInstrumentMode()" style="opacity: 0; width: 0; height: 0;">
                                <span class="slider" style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:0.4s;border-radius:34px;">
                                    <span class="slider-button" style="position:absolute;height:26px;width:26px;left:4px;bottom:4px;background-color:white;transition:0.4s;border-radius:50%;transform:translateX(0px);"></span>
                                </span>     
                            </label>
                            <span id="instrumentModeLabel" data-i18n="controls.guitarMode" style="font-size: 14px; color: var(--text-color);">Âêâ‰ªñÂíåÂ£∞</span>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <label data-i18n="controls.measures">Â∞èËäÇÊï∞</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="measures-2" name="measures" value="2">
                            <label for="measures-2" data-i18n="controls.measures2">2Â∞èËäÇ</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="measures-4" name="measures" value="4" checked="">
                            <label for="measures-4" data-i18n="controls.measures4">4Â∞èËäÇ</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="measures-8" name="measures" value="8">
                            <label for="measures-8" data-i18n="controls.measures8">8Â∞èËäÇ</label>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <label data-i18n="controls.key">Ë∞ÉÂè∑</label>
                    <button class="btn-secondary" onclick="openKeySignatureSettings()" id="keySettingsBtn" data-i18n="controls.KeySettings">Ë∞ÉÂè∑ËÆæÁΩÆ</button>
                </div>

                <div class="control-group" style="display: none;">
                    <label data-i18n="controls.time">ÊãçÂè∑</label>
                    <button class="btn-secondary" onclick="openTimeSignatureSettings()" id="timeSignatureSettingsBtn" data-i18n="controls.timeSettings">ÊãçÂè∑ËÆæÁΩÆ</button>
                </div>

                <!-- üîß ÁßªÈô§ (2025-10-02): Èí¢Áê¥Ê®°Âºè‰∏çÈúÄË¶ÅË∞±Âè∑ËÆæÁΩÆÊåâÈíÆÔºåÂõ∫ÂÆö‰ΩøÁî®Â§ßË∞±Ë°® -->
                <!-- <div class="control-group" id="clefControlGroup">
                    <label data-i18n="controls.clef">Ë∞±Âè∑</label>
                    <button class="btn-secondary" onclick="openClefSettings()" id="clefSettingsBtn" data-i18n="controls.clefSettings">
                        Ë∞±Âè∑ËÆæÁΩÆ
                    </button>
                </div> -->
            </div>

            <!-- Êñ∞Â¢ûÔºöÈü≥ÂüüËÆæÁΩÆ -->
            <!-- üé∏ Âêâ‰ªñÊ®°ÂºèÈü≥ÂüüËÆæÁΩÆ -->
            <div id="guitarRangeSettings" style="display: block;">
            <div class="control-row">
                <div class="control-group">
                    <label for="rangeMin" data-i18n="controls.rangeMin">ÊúÄ‰ΩéÈü≥</label>
                    <select id="rangeMin">
                        <option value="33">A1</option>
                        <option value="35">B1</option>
                        <option value="36">C2</option>
                        <option value="38">D2</option>
                        <option value="40">E2</option>
                        <option value="41">F2</option>
                        <option value="43">G2</option>
                        <option value="45">A2</option>
                        <option value="47">B2</option>
                        <option value="48">C3</option>
                        <option value="50">D3</option>
                        <option value="52">E3</option>
                        <option value="53">F3</option>
                        <option value="55">G3</option>
                        <option value="57">A3</option>
                        <option value="59">B3</option>
                        <option value="60" selected="">C4</option>
                        <option value="62">D4</option>
                        <option value="64">E4</option>
                        <option value="65">F4</option>
                        <option value="67">G4</option>
                        <option value="69">A4</option>
                        <option value="71">B4</option>
                        <option value="72">C5</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="rangeMax" data-i18n="controls.rangeMax">ÊúÄÈ´òÈü≥</label>
                    <select id="rangeMax">
                        <option value="48">C3</option>
                        <option value="50">D3</option>
                        <option value="52">E3</option>
                        <option value="53">F3</option>
                        <option value="55">G3</option>
                        <option value="57">A3</option>
                        <option value="59">B3</option>
                        <option value="60">C4</option>
                        <option value="62">D4</option>
                        <option value="64">E4</option>
                        <option value="65">F4</option>
                        <option value="67">G4</option>
                        <option value="69">A4</option>
                        <option value="71">B4</option>
                        <option value="72">C5</option>
                        <option value="74">D5</option>
                        <option value="76">E5</option>
                        <option value="77">F5</option>
                        <option value="79">G5</option>
                        <option value="81">A5</option>
                        <option value="82">B5</option>
                        <option value="83">C6</option>
                        <option value="84">D6</option>
                        <option value="88" selected="">E6</option>
                    </select>
                </div>

                <!-- üéº ÊòæÁ§∫ÊéßÂà∂ÂºÄÂÖ≥ - Á¥ßÂáëÂ∏ÉÂ±Ä -->
                <!-- üéº ÊòæÁ§∫ÊéßÂà∂ÂºÄÂÖ≥ - Á¥ßÂáëÂ∏ÉÂ±ÄÔºåÂáèÂ∞ëÈó¥Ë∑ù -->
                <div class="control-group" style="flex: none; width: 140px; margin-right: 4px;">
                    <label data-i18n="controls.staff">‰∫îÁ∫øË∞±</label>
                    <div class="toggle-container">
                        <input type="checkbox" id="staffDisplayToggle" checked="" class="toggle-input">
                        <label for="staffDisplayToggle" class="toggle-slider">
                            <span class="toggle-button"></span>
                        </label>
                    </div>
                </div>

                <div class="control-group" style="flex: none; width: 140px; margin-right: 0px;">
                    <label data-i18n="controls.chordSymbols">ÂíåÂº¶‰ª£Âè∑</label>
                    <div class="toggle-container">
                        <input type="checkbox" id="chordSymbolsToggle" checked="" class="toggle-input">
                        <label for="chordSymbolsToggle" class="toggle-slider">
                            <span class="toggle-button"></span>
                        </label>
                    </div>
                </div>

                <div class="control-group metronome-group" style="flex: none; width: 160px;">
                    <label for="headerMetronomeBpm" data-i18n="controls.metronome">ËäÇÊãçÂô®</label>
                    <div class="metronome-control">
                        <input type="number" id="headerMetronomeBpm" min="1" max="999" value="60" class="bpm-input-control">
                        <button class="metronome-play-btn" id="headerMetronomeBtn" onclick="toggleMetronome()" title="ÂºÄÂßã/ÂÅúÊ≠¢ËäÇÊãçÂô®">
                            üéµ
                        </button>
                        <div class="metronome-beat-indicator" id="headerBeatIndicator"></div>
                    </div>
                </div>
            </div>
            </div>

            <!-- üéπ Èí¢Áê¥Ê®°ÂºèÈü≥ÂüüËÆæÁΩÆ -->
            <div id="pianoRangeSettings" style="display: none;">
                <div class="control-row">
                    <div class="control-group">
                        <label data-i18n="piano.bassClefRange">‰ΩéÈü≥Ë∞±Âè∑Èü≥ÂüüËÆæÁΩÆ</label>
                        <button class="btn-secondary" onclick="openBassClefRangeModal()">
                            <span id="bassClefRangeDisplay">(E2-E4)</span>
                        </button>
                    </div>
                    <div class="control-group">
                        <label data-i18n="piano.trebleClefRange">È´òÈü≥Ë∞±Âè∑Èü≥ÂüüËÆæÁΩÆ</label>
                        <button class="btn-secondary" onclick="openTrebleClefRangeModal()">
                            <span id="trebleClefRangeDisplay">(C4-E6)</span>
                        </button>
                    </div>

                    <!-- üéº ÊòæÁ§∫ÊéßÂà∂ÂºÄÂÖ≥ - ‰øùÊåÅ‰∏éÂêâ‰ªñÊ®°Âºè‰∏ÄËá¥ÁöÑÂ∏ÉÂ±Ä -->
                    <div class="control-group" style="flex: none; width: 140px; margin-right: 4px;">
                        <label data-i18n="controls.staff">‰∫îÁ∫øË∞±</label>
                        <div class="toggle-container">
                            <input type="checkbox" id="staffDisplayToggle" checked="" class="toggle-input">
                            <label for="staffDisplayToggle" class="toggle-slider">
                                <span class="toggle-button"></span>
                            </label>
                        </div>
                    </div>

                    <div class="control-group" style="flex: none; width: 140px; margin-right: 0px;">
                        <label data-i18n="controls.chordSymbols">ÂíåÂº¶‰ª£Âè∑</label>
                        <div class="toggle-container">
                            <input type="checkbox" id="chordSymbolsToggle" checked="" class="toggle-input">
                            <label for="chordSymbolsToggle" class="toggle-slider">
                                <span class="toggle-button"></span>
                            </label>
                        </div>
                    </div>

                    <div class="control-group metronome-group" style="flex: none; width: 160px;">
                        <label for="headerMetronomeBpm" data-i18n="controls.metronome">ËäÇÊãçÂô®</label>
                        <div class="metronome-control">
                            <input type="number" id="headerMetronomeBpm" min="1" max="999" value="60" class="bpm-input-control">
                            <button class="metronome-play-btn" id="headerMetronomeBtn" onclick="toggleMetronome()" title="ÂºÄÂßã/ÂÅúÊ≠¢ËäÇÊãçÂô®">
                                üéµ
                            </button>
                            <div class="metronome-beat-indicator" id="headerBeatIndicator"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="control-row">
                <div class="buttons">
                    <button id="generateChordsBtn" class="btn-primary" data-i18n="controls.generate">ÁîüÊàêÂíåÂº¶</button>
                    <div class="button-group">
                        <button class="btn-secondary" onclick="previousChords()" data-i18n="controls.previous">‰∏ä‰∏ÄÊù°</button>
                        <button class="btn-secondary" onclick="nextChords()" data-i18n="controls.next">‰∏ã‰∏ÄÊù°</button>
                    </div>
                    <div class="button-group">
                        <button class="btn-secondary" id="playMelodyBtn" onclick="directPlayTest()" data-i18n="controls.play">Êí≠Êîæ</button>
                        <button class="melody-visibility-btn" id="melodyVisibilityBtn" onclick="toggleMelodyVisibility()" title="ÈöêËóè/ÊòæÁ§∫ÂíåÂº¶">
                            üëÄ
                        </button>
                    </div>
                    <div class="button-group" style="display: none;">
                        <button class="btn-secondary" onclick="openRhythmSettings()" data-i18n="controls.rhythm">ËäÇÂ•èËÆæÁΩÆ</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="score-container">
            <div id="score" title="ÁÇπÂáªÁîüÊàêÊñ∞ÂíåÂº¶" style="cursor: pointer;">
                <div class="empty-score-message">
                    <p data-i18n="score.empty">ÁÇπÂáªÁîüÊàêÂíåÂº¶ÂºÄÂßãÁªÉ‰π†</p>
                </div>
            </div>
        </div>

        <!-- ÂäüËÉΩÂàÜÊûêÈù¢Êùø -->
        <div class="analysis-panel" id="analysisPanel" style="display: none;">
            <div class="analysis-header">
                <h3>üéº ÂíåÂº¶ÂäüËÉΩÂàÜÊûê</h3>
                <button class="toggle-btn" onclick="toggleAnalysisPanel()">Êî∂Ëµ∑</button>
            </div>
            <div class="analysis-content" id="analysisContent">
                <!-- ÂàÜÊûêÂÜÖÂÆπÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÊ∑ªÂä† -->
            </div>
        </div>

        <!-- Copyright Information -->
        <div style="
            padding: 5px 0;
            text-align: center;
            font-size: 14px;
            color: var(--neutral-dark);
            opacity: 0.7;
            border-top: 1px solid var(--border-color);
            margin-top: 7.5px;
        ">
            <p style="margin: 0; line-height: 1.5;">
                <strong>IC Studio ËßÜÂ•èÂ∑•ÂÖ∑</strong> - ‰∏ì‰∏öÁ∫ßÂíåÂº¶ËßÜÂ•èÁîüÊàêÂô®
            </p>
            <p style="margin: 8px 0 0 0; font-size: 13px; opacity: 0.8;">
                Copyright ¬© 2025. All rights reserved. Igor Chen -
                <a href="https://icstudio.club/" target="_blank" style="color: var(--primary-orange); text-decoration: none;">icstudio.club</a>
            </p>
        </div>

    </div>

    <!-- ÂíåÂº¶Á±ªÂûãËÆæÁΩÆÂºπÁ™ó -->
    <div id="chordTypeModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="modal.chordType.title">ÂíåÂº¶Á±ªÂûãËÆæÁΩÆ</h3>
                <button class="close-btn" onclick="closeChordTypeSettings()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="chord-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="modal.chordType.triads">‰∏âÂíåÂº¶</h4>
                        <button class="btn-select-all" onclick="selectAllBasicChords()" style="padding: 5px 10px; font-size: 12px; background: #FF9500; color: white; border: none; border-radius: 4px; cursor: pointer;" data-i18n="button.selectAll">ÂÖ®ÈÄâ</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="chord-major" value="major" checked="">
                            <span data-i18n="chord.major">Â§ß‰∏âÂíåÂº¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="chord-minor" value="minor" checked="">
                            <span data-i18n="chord.minor">Â∞è‰∏âÂíåÂº¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="chord-diminished" value="diminished">
                            <span data-i18n="chord.diminished">Âáè‰∏âÂíåÂº¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="chord-augmented" value="augmented">
                            <span data-i18n="chord.augmented">Â¢û‰∏âÂíåÂº¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="chord-sus" value="sus">
                            <span data-i18n="chord.sus">ÊåÇÂíåÂº¶ (sus2/sus4)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="chord-triad-inversion" value="triad-inversion">
                            <span data-i18n="chord.triadInversion">ÂåÖÂê´ËΩ¨‰Ωç</span>
                        </label>
                    </div>
                </div>

                <div class="chord-section" style="margin-top: 20px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="modal.chordType.seventhChords">‰∏ÉÂíåÂº¶</h4>
                        <button class="btn-select-all" onclick="selectAllSeventhChords()" style="padding: 5px 10px; font-size: 12px; background: #FF9500; color: white; border: none; border-radius: 4px; cursor: pointer;" data-i18n="button.selectAll">ÂÖ®ÈÄâ</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="chord-major7" value="major7">
                            <span data-i18n="chord.major7">Â§ß‰∏ÉÂíåÂº¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="chord-minor7" value="minor7">
                            <span data-i18n="chord.minor7">Â∞è‰∏ÉÂíåÂº¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="chord-dominant7" value="dominant7">
                            <span data-i18n="chord.dominant7">Â±û‰∏ÉÂíåÂº¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="chord-minor7b5" value="minor7b5">
                            <span data-i18n="chord.minor7b5">ÂçäÂáè‰∏ÉÂíåÂº¶ (m7‚ô≠5)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="chord-7sus" value="7sus">
                            <span data-i18n="chord.7sus">‰∏ÉÊåÇÂíåÂº¶ (7sus2/7sus4)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="chord-seventh-inversion" value="seventh-inversion">
                            <span data-i18n="chord.seventhInversion">ÂåÖÂê´ËΩ¨‰Ωç</span>
                        </label>
                    </div>
                </div>

                <!-- È´òÁ∫ßËÆæÁΩÆÂå∫Âüü -->
                <div id="chordAdvancedSettings" style="display: none; margin-top: 20px; padding: 20px; background: var(--info-bg); border-radius: 8px; border: 2px solid var(--info-border);">
                    <h4 style="margin-bottom: 15px; color: var(--heading-text);" data-i18n="modal.chordType.advancedSettings">È´òÁ∫ßËÆæÁΩÆ</h4>

                    <!-- üé∏ Âêâ‰ªñÊ®°ÂºèÈ´òÁ∫ßËÆæÁΩÆ -->
                    <div id="guitarAdvancedSettings" style="display: block;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                            <h5 style="margin: 0; font-size: 14px; color: #666;" data-i18n="modal.chordType.voicingTypes">Voicing Á±ªÂûãÈÄâÊã©</h5>
                            <button class="btn-select-all" onclick="toggleSelectAllVoicings()" style="padding: 5px 10px; font-size: 12px; background: #FF9500; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                <span id="voicingSelectAllText" data-i18n="button.selectAll">ÂÖ®ÈÄâ</span>
                            </button>
                        </div>
                        <div class="checkbox-grid">
                            <label class="checkbox-item">
                                <input type="checkbox" id="voicing-close" value="close" checked="">
                                <span data-i18n="voicing.close">ÂØÜÈõÜÊéíÂàó (Close)</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="voicing-drop2" value="drop2">
                                <span data-i18n="voicing.drop2">Drop 2 Voicing</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="voicing-drop3" value="drop3">
                                <span data-i18n="voicing.drop3">Drop 3 Voicing</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="voicing-shell" value="shell">
                                <span data-i18n="voicing.shell">Shell Voicing</span>
                            </label>
                        </div>

                        <div class="voicing-info">
                            <h5 data-i18n="voicing.description.title">ÂäüËÉΩËØ¥ÊòéÔºö</h5>
                            <ul>
                                <li><strong>Close Voicing:</strong> <span data-i18n="voicing.description.close">ÂíåÂº¶ÂêÑÈü≥Â∞ΩÈáèÁ¥ßÂØÜÊéíÂàóÂú®‰∏ÄËµ∑„ÄÅÈü≥Á®ãÈó¥Ë∑ùËæÉÂ∞èÁöÑÂíåÂ£∞ÈÖçÁΩÆÔºà‰∏âÈü≥Ôºâ</span></li>
                                <li><strong>Drop 2:</strong> <span data-i18n="voicing.description.drop2">Â∞ÜÂØÜÈõÜÊéíÂàóÂíåÂ£∞ÁöÑÁ¨¨‰∫åÈ´òÁöÑÈü≥Á¨¶Èôç‰Ωé‰∏Ä‰∏™ÂÖ´Â∫¶Ôºà‰∏âÈü≥Ôºâ</span></li>
                                <li><strong>Drop 3:</strong> <span data-i18n="voicing.description.drop3">Â∞ÜÂØÜÈõÜÊéíÂàóÂíåÂ£∞ÁöÑÁ¨¨‰∏âÈ´òÁöÑÈü≥Á¨¶Èôç‰Ωé‰∏Ä‰∏™ÂÖ´Â∫¶ÔºàÂõõÈü≥Ôºâ</span></li>
                                <li><strong>Shell Voicing:</strong> <span data-i18n="voicing.description.shell">Âè™‰øùÁïôÂíåÂº¶ÁöÑ Ê†πÈü≥„ÄÅ‰∏âÂ∫¶„ÄÅ‰∏ÉÂ∫¶ÔºàÁúÅÁï•‰∫îÂ∫¶Á≠âÈü≥ÔºâÁöÑÁÆÄÂåñÂíåÂ£∞ÈÖçÁΩÆÔºà‰∏âÈü≥Ôºâ</span></li>
                            </ul>
                        </div>
                    </div>

                    <!-- üéπ Èí¢Áê¥Ê®°ÂºèÈ´òÁ∫ßËÆæÁΩÆ -->
                    <div id="pianoAdvancedSettings" style="display: none;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                            <h5 style="margin: 0; font-size: 14px; color: #666;" data-i18n="modal.chordType.pianoNoteCount">ÂíåÂ£∞Èü≥Êï∞ÈÄâÊã©</h5>
                            <button class="btn-select-all" onclick="toggleSelectAllNoteCounts()" style="padding: 5px 10px; font-size: 12px; background: #FF9500; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                <span id="noteCountSelectAllText" data-i18n="button.selectAll">ÂÖ®ÈÄâ</span>
                            </button>
                        </div>
                        <!-- üîß ‰øÆÂ§ç (2025-10-01): ÁßªÈô§2Èü≥„ÄÅ8Èü≥„ÄÅ9Èü≥ÔºåÂè™‰øùÁïô3-7Èü≥ -->
                        <div class="checkbox-grid">
                            <label class="checkbox-item">
                                <input type="checkbox" id="notecount-3" value="3">
                                <span data-i18n="piano.noteCount.3">3Èü≥</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="notecount-4" value="4" checked="">
                                <span data-i18n="piano.noteCount.4">4Èü≥</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="notecount-5" value="5">
                                <span data-i18n="piano.noteCount.5">5Èü≥</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="notecount-6" value="6">
                                <span data-i18n="piano.noteCount.6">6Èü≥</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="notecount-7" value="7">
                                <span data-i18n="piano.noteCount.7">7Èü≥</span>
                            </label>
                        </div>

                        <div class="voicing-info">
                            <h5 data-i18n="piano.noteCount.description.title">Èí¢Áê¥Ê®°ÂºèËØ¥ÊòéÔºö</h5>
                            <ul>
                                <li data-i18n="piano.noteCount.description.bass">‰ΩéÈü≥Ë∞±Âè∑ÔºöÊúÄ‰ΩéÈü≥ÂßãÁªàÊòØÊ†πÈü≥ÔºåËêΩÂú®‰ΩéÈü≥Ë∞±Âè∑Èü≥ÂüüËåÉÂõ¥ÂÜÖ</li>
                                <li data-i18n="piano.noteCount.description.treble">È´òÈü≥Ë∞±Âè∑ÔºöÂÖ∂‰ΩôÈü≥Á¨¶ÔºàËá≥Â∞ë2‰∏™ÔºâÊîæÂú®È´òÈü≥Ë∞±Âè∑Èü≥ÂüüÔºåÊéíÂàóÈ°∫Â∫èÈöèÊú∫</li>
                                <li data-i18n="piano.noteCount.description.priority">‰ºòÂÖàÈü≥Ôºö‰∏âÈü≥„ÄÅ‰∏ÉÈü≥„ÄÅsusÈü≥„ÄÅtensionÈü≥‰ºòÂÖàÈÄâÊã©ÔºàÂ∞ΩÈáè‰∏çÈáçÂ§çÔºâ</li>
                                <li data-i18n="piano.noteCount.description.optional">ÂèØÈÄâÈü≥Ôºö‰∫îÈü≥Âú®Èü≥Êï∞ËæÉÂ§öÊó∂Âä†ÂÖ•ÔºåÊ†πÈü≥Âíå‰∫îÈü≥ÂèØ‰ª•ÈáçÂ§ç</li>
                            </ul>
                        </div>

                        <!-- üéµ Tension Note ÂºÄÂÖ≥ (2025-10-01Êñ∞Â¢û) -->
                        <div style="margin-top: 15px;">
                            <label class="checkbox-item">
                                <input type="checkbox" id="tension-note-toggle" value="tension">
                                <span data-i18n="piano.tensionNote">üéµ Tension Note (Âä†Ëâ≤Èü≥)</span>
                            </label>
                        </div>

                        <div class="voicing-info">
                            <p style="margin: 0; font-size: 12px; line-height: 1.5;">
                                Âú®4-7Èü≥ÈÖçÁΩÆ‰∏≠Êô∫ËÉΩÊ∑ªÂä†9th„ÄÅ11th„ÄÅ13thÁ≠âÂä†Ëâ≤Èü≥<br>
                                <span style="opacity: 0.7;">Âü∫‰∫éÁàµÂ£´ÂíåÂ£∞ÁêÜËÆ∫ÔºåÈÅøÂÖçÁ¶ÅÂøåÈü≥/ÂÜ≤Á™ÅÈü≥</span>
                            </p>
                        </div>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-secondary" onclick="toggleChordAdvancedSettings()" id="chordAdvancedBtn" data-i18n="button.advanced">È´òÁ∫ßËÆæÁΩÆ</button>
                    <button class="btn-primary" onclick="saveChordTypeSettings()" data-i18n="button.save">‰øùÂ≠òËÆæÁΩÆ</button>
                    <button class="btn-secondary" onclick="closeChordTypeSettings()" data-i18n="button.cancel">ÂèñÊ∂à</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ËäÇÂ•èËÆæÁΩÆÂºπÁ™ó -->
    <div id="rhythmModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="modal.rhythm.title">ËäÇÂ•èËÆæÁΩÆ</h3>
                <button class="close-btn" onclick="closeRhythmSettings()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="modal.rhythm.basicUnit">Âü∫Êú¨ËäÇÂ•èÂçï‰Ωç</h4>
                        <button class="btn-select-all" onclick="selectAllRhythms()" style="padding: 5px 10px; font-size: 12px; background: #FF9500; color: white; border: none; border-radius: 4px; cursor: pointer;" data-i18n="button.selectAll">ÂÖ®ÈÄâ</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="rhythm-whole" value="whole">
                            <span data-i18n="rhythm.whole">ÂÖ®Èü≥Á¨¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="rhythm-half" value="half" checked="">
                            <span data-i18n="rhythm.half">‰∫åÂàÜÈü≥Á¨¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="rhythm-quarter" value="quarter" checked="">
                            <span data-i18n="rhythm.quarter">ÂõõÂàÜÈü≥Á¨¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="rhythm-eighth" value="eighth">
                            <span data-i18n="rhythm.eighth">ÂÖ´ÂàÜÈü≥Á¨¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="rhythm-sixteenth" value="sixteenth">
                            <span data-i18n="rhythm.sixteenth">ÂçÅÂÖ≠ÂàÜÈü≥Á¨¶</span>
                        </label>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveRhythmSettings()" data-i18n="button.save">‰øùÂ≠òËÆæÁΩÆ</button>
                    <button class="btn-secondary" onclick="closeRhythmSettings()" data-i18n="button.cancel">ÂèñÊ∂à</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Ë∞ÉÂè∑ËÆæÁΩÆÂºπÁ™ó -->
    <div id="keySignatureModal" class="modal" style="display: none;" onclick="if(event.target===this) saveKeySettings()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 data-i18n="modal.keySignature.title">Ë∞ÉÂè∑ËÆæÁΩÆ</h3>
                <button class="close-btn" onclick="closeKeySettings()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="key-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="modal.keySignature.major">Â§ßË∞É (Major)</h4>
                        <button class="btn-select-all" onclick="selectAllMajorKeys()" style="padding: 5px 10px; font-size: 12px; background: #FF9500; color: white; border: none; border-radius: 4px; cursor: pointer;" data-i18n="button.selectAllMajor">ÂÖ®ÈÄâ</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-C-major" value="C-major" checked="">
                            <span data-i18n="key.C-major">C Â§ßË∞É</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-G-major" value="G-major">
                            <span data-i18n="key.G-major">G Â§ßË∞É (1#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-D-major" value="D-major">
                            <span data-i18n="key.D-major">D Â§ßË∞É (2#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-A-major" value="A-major">
                            <span data-i18n="key.A-major">A Â§ßË∞É (3#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-E-major" value="E-major">
                            <span data-i18n="key.E-major">E Â§ßË∞É (4#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-B-major" value="B-major">
                            <span data-i18n="key.B-major">B Â§ßË∞É (5#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Fs-major" value="F#-major">
                            <span data-i18n="key.Fs-major">F# Â§ßË∞É (6#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-F-major" value="F-major">
                            <span data-i18n="key.F-major">F Â§ßË∞É (1b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Bb-major" value="Bb-major">
                            <span data-i18n="key.Bb-major">Bb Â§ßË∞É (2b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Eb-major" value="Eb-major">
                            <span data-i18n="key.Eb-major">Eb Â§ßË∞É (3b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Ab-major" value="Ab-major">
                            <span data-i18n="key.Ab-major">Ab Â§ßË∞É (4b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Db-major" value="Db-major">
                            <span data-i18n="key.Db-major">Db Â§ßË∞É (5b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Gb-major" value="Gb-major">
                            <span data-i18n="key.Gb-major">Gb Â§ßË∞É (6b)</span>
                        </label>
                    </div>
                </div>

                <div class="key-section" style="margin-top: 20px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="modal.keySignature.minor">Â∞èË∞É (Minor)</h4>
                        <button class="btn-select-all" onclick="selectAllMinorKeys()" style="padding: 5px 10px; font-size: 12px; background: #FF9500; color: white; border: none; border-radius: 4px; cursor: pointer;" data-i18n="button.selectAllMinor">ÂÖ®ÈÄâ</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-a-minor" value="a-minor" checked="">
                            <span data-i18n="key.a-minor">A Â∞èË∞É</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-e-minor" value="e-minor">
                            <span data-i18n="key.e-minor">E Â∞èË∞É (1#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-b-minor" value="b-minor">
                            <span data-i18n="key.b-minor">B Â∞èË∞É (2#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-fs-minor" value="f#-minor">
                            <span data-i18n="key.fs-minor">F# Â∞èË∞É (3#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-cs-minor" value="c#-minor">
                            <span data-i18n="key.cs-minor">C# Â∞èË∞É (4#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-gs-minor" value="g#-minor">
                            <span data-i18n="key.gs-minor">G# Â∞èË∞É (5#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-ds-minor" value="d#-minor">
                            <span data-i18n="key.ds-minor">D# Â∞èË∞É (6#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-d-minor" value="d-minor">
                            <span data-i18n="key.d-minor">D Â∞èË∞É (1b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-g-minor" value="g-minor">
                            <span data-i18n="key.g-minor">G Â∞èË∞É (2b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-c-minor" value="c-minor">
                            <span data-i18n="key.c-minor">C Â∞èË∞É (3b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-f-minor" value="f-minor">
                            <span data-i18n="key.f-minor">F Â∞èË∞É (4b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-bb-minor" value="bb-minor">
                            <span data-i18n="key.bb-minor">Bb Â∞èË∞É (5b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-eb-minor" value="eb-minor">
                            <span data-i18n="key.eb-minor">Eb Â∞èË∞É (6b)</span>
                        </label>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveKeySettings()" data-i18n="button.save">‰øùÂ≠òËÆæÁΩÆ</button>
                    <button class="btn-secondary" onclick="closeKeySettings()" data-i18n="button.cancel">ÂèñÊ∂à</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ÊãçÂè∑ËÆæÁΩÆÂºπÁ™ó -->
    <div id="timeSignatureModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="modal.timeSignature.title">ÊãçÂè∑ËÆæÁΩÆ</h3>
                <button class="close-btn" onclick="closeTimeSignatureSettings()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="time-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="modal.timeSignature.selection">ÊãçÂè∑ÈÄâÊã©</h4>
                        <button class="btn-select-all" onclick="selectAllTimeSignatures()" style="padding: 5px 10px; font-size: 12px; background: #FF9500; color: white; border: none; border-radius: 4px; cursor: pointer;" data-i18n="button.selectAll">ÂÖ®ÈÄâ</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="time-4-4" value="4/4" checked="">
                            <span>4/4</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="time-3-4" value="3/4">
                            <span>3/4</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="time-2-4" value="2/4">
                            <span>2/4</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="time-6-8" value="6/8">
                            <span>6/8</span>
                        </label>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveTimeSignatureSettings()" data-i18n="button.save">‰øùÂ≠òËÆæÁΩÆ</button>
                    <button class="btn-secondary" onclick="closeTimeSignatureSettings()" data-i18n="button.cancel">ÂèñÊ∂à</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ë∞±Âè∑ËÆæÁΩÆÂºπÁ™ó -->
    <div id="clefModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="modal.clef.title">Ë∞±Âè∑ËÆæÁΩÆ</h3>
                <button class="close-btn" onclick="closeClefSettings()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="clef-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="modal.clef.selection">Ë∞±Âè∑ÈÄâÊã©</h4>
                        <button class="btn-select-all" onclick="selectAllClefs()" style="padding: 5px 10px; font-size: 12px; background: #FF9500; color: white; border: none; border-radius: 4px; cursor: pointer;" data-i18n="button.selectAll">ÂÖ®ÈÄâ</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="clef-grand_staff" value="grand_staff" checked="">
                            <span data-i18n="clef.grand_staff">Â§ßË∞±Ë°®</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="clef-treble" value="treble">
                            <span data-i18n="clef.treble">È´òÈü≥Ë∞±Âè∑</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="clef-bass" value="bass">
                            <span data-i18n="clef.bass">‰ΩéÈü≥Ë∞±Âè∑</span>
                        </label>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveClefSettings()" data-i18n="button.save">‰øùÂ≠òËÆæÁΩÆ</button>
                    <button class="btn-secondary" onclick="closeClefSettings()" data-i18n="button.cancel">ÂèñÊ∂à</button>
                </div>
            </div>
        </div>
    </div>

    <!-- üéπ ‰ΩéÈü≥Ë∞±Âè∑Èü≥ÂüüËÆæÁΩÆÂºπÁ™ó -->
    <div id="bassClefRangeModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="modal.bassClefRange.title">‰ΩéÈü≥Ë∞±Âè∑Èü≥ÂüüËÆæÁΩÆ</h3>
                <button class="close-btn" onclick="closeBassClefRangeModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="range-section">
                    <div class="control-group">
                        <label for="bassClefRangeMin" data-i18n="piano.bassClefMin">ÊúÄ‰ΩéÈü≥</label>
                        <select id="bassClefRangeMin">
                            <option value="28">E1</option>
                            <option value="33">A1</option>
                            <option value="35">B1</option>
                            <option value="36">C2</option>
                            <option value="38">D2</option>
                            <option value="40" selected="">E2</option>
                            <option value="41">F2</option>
                            <option value="43">G2</option>
                            <option value="45">A2</option>
                            <option value="47">B2</option>
                            <option value="48">C3</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="bassClefRangeMax" data-i18n="piano.bassClefMax">ÊúÄÈ´òÈü≥</label>
                        <select id="bassClefRangeMax">
                            <option value="36">C2</option>
                            <option value="38">D2</option>
                            <option value="40">E2</option>
                            <option value="41">F2</option>
                            <option value="43">G2</option>
                            <option value="45">A2</option>
                            <option value="47">B2</option>
                            <option value="48">C3</option>
                            <option value="50">D3</option>
                            <option value="52">E3</option>
                            <option value="53">F3</option>
                            <option value="55">G3</option>
                            <option value="57">A3</option>
                            <option value="59">B3</option>
                            <option value="60">C4</option>
                            <option value="62">D4</option>
                            <option value="64" selected="">E4</option>
                        </select>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveBassClefRange()" data-i18n="button.save">‰øùÂ≠òËÆæÁΩÆ</button>
                    <button class="btn-secondary" onclick="closeBassClefRangeModal()" data-i18n="button.cancel">ÂèñÊ∂à</button>
                </div>
            </div>
        </div>
    </div>

    <!-- üéπ È´òÈü≥Ë∞±Âè∑Èü≥ÂüüËÆæÁΩÆÂºπÁ™ó -->
    <div id="trebleClefRangeModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="modal.trebleClefRange.title">È´òÈü≥Ë∞±Âè∑Èü≥ÂüüËÆæÁΩÆ</h3>
                <button class="close-btn" onclick="closeTrebleClefRangeModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="range-section">
                    <div class="control-group">
                        <label for="trebleClefRangeMin" data-i18n="piano.trebleClefMin">ÊúÄ‰ΩéÈü≥</label>
                        <select id="trebleClefRangeMin">
                            <option value="55">G3</option>
                            <option value="57">A3</option>
                            <option value="59">B3</option>
                            <option value="60" selected="">C4</option>
                            <option value="62">D4</option>
                            <option value="64">E4</option>
                            <option value="65">F4</option>
                            <option value="67">G4</option>
                            <option value="69">A4</option>
                            <option value="71">B4</option>
                            <option value="72">C5</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="trebleClefRangeMax" data-i18n="piano.trebleClefMax">ÊúÄÈ´òÈü≥</label>
                        <select id="trebleClefRangeMax">
                            <option value="72">C5</option>
                            <option value="74">D5</option>
                            <option value="76">E5</option>
                            <option value="77">F5</option>
                            <option value="79">G5</option>
                            <option value="81">A5</option>
                            <option value="83">B5</option>
                            <option value="84">C6</option>
                            <option value="86">D6</option>
                            <option value="88" selected="">E6</option>
                            <option value="89">F6</option>
                            <option value="91">G6</option>
                            <option value="93">A6</option>
                        </select>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveTrebleClefRange()" data-i18n="button.save">‰øùÂ≠òËÆæÁΩÆ</button>
                    <button class="btn-secondary" onclick="closeTrebleClefRangeModal()" data-i18n="button.cancel">ÂèñÊ∂à</button>
                </div>
            </div>
        </div>
    </div>

    <!-- üéØ ÈÄöÁî®ÂºπÁ™óÂ§ñÈÉ®ÁÇπÂáªÂÖ≥Èó≠ÂäüËÉΩ -->
    <script>
        // ============================================================
        // Â§öËØ≠Ë®ÄÁ≥ªÁªü (Multi-language System)
        // ============================================================
        // ‚úÖ translations ÂØπË±°Â∑≤Âú® chord-sight-reading.js ‰∏≠ÂÆö‰πâ
        // ÁßªÈô§Ê≠§Â§ÑÈáçÂ§çÂ£∞Êòé‰ª•ÈÅøÂÖç SyntaxError: Identifier 'translations' has already been declared

        // ============================================================
        // UIÊéßÂà∂ÂáΩÊï∞ (UI Control Functions)
        // ============================================================

        // ËÆæÁΩÆËèúÂçïÊéßÂà∂
        function toggleSettings() {
            const settingsMenu = document.getElementById('settingsMenu');
            const isVisible = settingsMenu.classList.contains('show');

            if (isVisible) {
                closeSettings();
            } else {
                openSettings();
            }
        }

        function openSettings() {
            const settingsMenu = document.getElementById('settingsMenu');
            settingsMenu.classList.add('show');

            // Ê∑ªÂä†ÁÇπÂáªÂ§ñÈÉ®Âå∫ÂüüÂÖ≥Èó≠ËèúÂçïÁöÑÁõëÂê¨Âô®
            setTimeout(() => {
                document.addEventListener('click', handleClickOutside);
            }, 10);
        }

        function closeSettings() {
            const settingsMenu = document.getElementById('settingsMenu');
            settingsMenu.classList.remove('show');

            // ÁßªÈô§ÁÇπÂáªÂ§ñÈÉ®Âå∫ÂüüÁöÑÁõëÂê¨Âô®
            document.removeEventListener('click', handleClickOutside);
        }

        // ÂäüËÉΩÈÄâÊã©Âô®ÊéßÂà∂
        function toggleFunctionSelector() {
            const functionMenu = document.getElementById('functionMenu');
            const isVisible = functionMenu.classList.contains('show');

            if (isVisible) {
                closeFunctionSelector();
            } else {
                openFunctionSelector();
            }
        }

        function openFunctionSelector() {
            const functionMenu = document.getElementById('functionMenu');
            functionMenu.classList.add('show');

            // Ê∑ªÂä†ÁÇπÂáªÂ§ñÈÉ®Âå∫ÂüüÂÖ≥Èó≠ËèúÂçïÁöÑÁõëÂê¨Âô®
            setTimeout(() => {
                document.addEventListener('click', handleFunctionClickOutside);
            }, 10);
        }

        function closeFunctionSelector() {
            const functionMenu = document.getElementById('functionMenu');
            functionMenu.classList.remove('show');

            // ÁßªÈô§ÁÇπÂáªÂ§ñÈÉ®Âå∫ÂüüÁöÑÁõëÂê¨Âô®
            document.removeEventListener('click', handleFunctionClickOutside);
        }

        // Â§ÑÁêÜÁÇπÂáªÂ§ñÈÉ®Âå∫ÂüüÂÖ≥Èó≠ÂäüËÉΩËèúÂçï
        function handleFunctionClickOutside(event) {
            const functionSelector = document.querySelector('.function-selector');

            if (functionSelector && !functionSelector.contains(event.target)) {
                closeFunctionSelector();
            }
        }

        // ÂàáÊç¢ÂäüËÉΩ
        function switchFunction(mode) {
            if (mode === 'melody') {
                // ÂØºËà™Âà∞ÊóãÂæãËßÜÂ•èÈ°µÈù¢
                window.location.href = '/tools/melody.html';
            } else if (mode === 'interval') {
                // ÂØºËà™Âà∞Èü≥Á®ãËßÜÂ•èÈ°µÈù¢
                window.location.href = '/tools/interval-generator.html';
            } else if (mode === 'chord') {
                // Â∑≤ÁªèÂú®ÂíåÂº¶ËßÜÂ•èÈ°µÈù¢
                closeFunctionSelector();
                console.log('Â∑≤Âú®ÂíåÂº¶ËßÜÂ•èÊ®°Âºè');
            }
        }

        // Â§ÑÁêÜÁÇπÂáªÂ§ñÈÉ®Âå∫ÂüüÂÖ≥Èó≠ËÆæÁΩÆËèúÂçï
        function handleClickOutside(event) {
            const settingsDropdown = document.querySelector('.settings-dropdown');

            if (settingsDropdown && !settingsDropdown.contains(event.target)) {
                closeSettings();
            }
        }

        // üéØ ÈÄöÁî®ÂºπÁ™óÂ§ñÈÉ®ÁÇπÂáªÂÖ≥Èó≠ÂäüËÉΩ
        function initializeModalClickOutsideToClose() {
            const modalIds = [
                'chordTypeModal',
                'rhythmModal',
                'keySignatureModal',
                'timeSignatureModal',
                'clefModal',
                'bassClefRangeModal',
                'trebleClefRangeModal'
            ];

            modalIds.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.addEventListener('click', function(event) {
                        // Âè™ÊúâÂΩìÁÇπÂáªÁöÑÊòØÂºπÁ™óËÉåÊôØÔºàmodalÂÆπÂô®Êú¨Ë∫´ÔºâÊó∂ÊâçÂÖ≥Èó≠
                        if (event.target === modal) {
                            console.log(`üéØ ÁÇπÂáªÂ§ñÈÉ®Âå∫ÂüüÂÖ≥Èó≠ÂºπÁ™ó: ${modalId}`);

                            // Ê†πÊçÆÂºπÁ™óÁ±ªÂûãË∞ÉÁî®Áõ∏Â∫îÁöÑÂÖ≥Èó≠ÂáΩÊï∞
                            switch(modalId) {
                                case 'chordTypeModal':
                                    if (typeof closeChordTypeSettings === 'function') {
                                        closeChordTypeSettings();
                                    }
                                    break;
                                case 'rhythmModal':
                                    if (typeof closeRhythmSettings === 'function') {
                                        closeRhythmSettings();
                                    }
                                    break;
                                case 'keySignatureModal':
                                    if (typeof saveKeySettings === 'function') {
                                        saveKeySettings(); // Â§ñÈÉ®ÁÇπÂáªÊó∂‰øùÂ≠òËÆæÁΩÆÂπ∂ÂÖ≥Èó≠
                                    }
                                    break;
                                case 'timeSignatureModal':
                                    if (typeof closeTimeSignatureSettings === 'function') {
                                        closeTimeSignatureSettings();
                                    }
                                    break;
                                case 'clefModal':
                                    if (typeof closeClefSettings === 'function') {
                                        closeClefSettings();
                                    }
                                    break;
                                case 'bassClefRangeModal':
                                    if (typeof saveBassClefRange === 'function') {
                                        saveBassClefRange(); // Â§ñÈÉ®ÁÇπÂáªÊó∂‰øùÂ≠òËÆæÁΩÆÂπ∂ÂÖ≥Èó≠
                                    }
                                    break;
                                case 'trebleClefRangeModal':
                                    if (typeof saveTrebleClefRange === 'function') {
                                        saveTrebleClefRange(); // Â§ñÈÉ®ÁÇπÂáªÊó∂‰øùÂ≠òËÆæÁΩÆÂπ∂ÂÖ≥Èó≠
                                    }
                                    break;
                                default:
                                    // ÈÄöÁî®ÂÖ≥Èó≠ÊñπÊ≥ï
                                    modal.style.display = 'none';
                            }
                        }
                    });
                    console.log(`‚úÖ Â∑≤‰∏∫ ${modalId} Ê∑ªÂä†Â§ñÈÉ®ÁÇπÂáªÂÖ≥Èó≠ÂäüËÉΩ`);
                }
            });
        }

        // üéØ ÂäüËÉΩËèúÂçïÂíåËÆæÁΩÆËèúÂçïÂ§ñÈÉ®ÁÇπÂáªÂÖ≥Èó≠ÂäüËÉΩ
        function initializeMenuClickOutsideToClose() {
            document.addEventListener('click', function(event) {
                // Â§ÑÁêÜÂäüËÉΩÈÄâÊã©Âô®ËèúÂçï
                const functionMenu = document.getElementById('functionMenu');
                const functionBtn = document.getElementById('functionBtn');

                if (functionMenu && functionMenu.classList.contains('show')) {
                    // Â¶ÇÊûúÁÇπÂáªÁöÑ‰∏çÊòØËèúÂçïÊú¨Ë∫´ÊàñËß¶ÂèëÊåâÈíÆÔºåÂàôÂÖ≥Èó≠ËèúÂçï
                    if (!functionMenu.contains(event.target) && !functionBtn.contains(event.target)) {
                        functionMenu.classList.remove('show');
                        console.log('üéØ ÁÇπÂáªÂ§ñÈÉ®Âå∫ÂüüÂÖ≥Èó≠ÂäüËÉΩËèúÂçï');
                    }
                }

                // Â§ÑÁêÜËÆæÁΩÆËèúÂçï
                const settingsMenu = document.getElementById('settingsMenu');
                const settingsBtn = document.getElementById('settingsBtn');

                if (settingsMenu && settingsMenu.classList.contains('show')) {
                    // Â¶ÇÊûúÁÇπÂáªÁöÑ‰∏çÊòØËèúÂçïÊú¨Ë∫´ÊàñËß¶ÂèëÊåâÈíÆÔºåÂàôÂÖ≥Èó≠ËèúÂçï
                    if (!settingsMenu.contains(event.target) && !settingsBtn.contains(event.target)) {
                        settingsMenu.classList.remove('show');
                        console.log('üéØ ÁÇπÂáªÂ§ñÈÉ®Âå∫ÂüüÂÖ≥Èó≠ËÆæÁΩÆËèúÂçï');
                    }
                }
            });
        }

        // Âú®È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            // üÜï ‰∫ßÂìÅÁ±ªÂûãËÆøÈóÆÊéßÂà∂
            (function initAccessControl() {
              const productData = JSON.parse(localStorage.getItem('ic-product-data') || '{}');
              const productType = productData.productType || 'all';
              const features = productData.features || [];

              const currentTool = 'chord'; // ÂΩìÂâçÂ∑•ÂÖ∑ÔºöÂíåÂº¶ËßÜÂ•è

              console.log(`üîí ËÆøÈóÆÊéßÂà∂Ê£ÄÊü• - ÂΩìÂâçÂ∑•ÂÖ∑: ${currentTool}, ‰∫ßÂìÅÁ±ªÂûã: ${productType}`);

              // Â¶ÇÊûú‰∏çÊòØ‰∏âÂêà‰∏ÄÁî®Êà∑ÔºåÊ£ÄÊü•ÊùÉÈôê
              if (productType !== 'all') {
                // Ê£ÄÊü•ÊòØÂê¶ÊúâÂΩìÂâçÂ∑•ÂÖ∑ÁöÑËÆøÈóÆÊùÉÈôê
                if (!features.includes(currentTool)) {
                  alert(`‚ö†Ô∏è ÊÇ®Ê≤°ÊúâÊùÉÈôêËÆøÈóÆÂíåÂº¶ËßÜÂ•èÂ∑•ÂÖ∑\n\nÊÇ®Ë¥≠‰π∞ÁöÑÊòØÔºö${productData.productDisplayName || 'Êú™Áü•‰∫ßÂìÅ'}\n\nÂ¶ÇÈúÄ‰ΩøÁî®ÂÖ∂‰ªñÂ∑•ÂÖ∑ÔºåËØ∑Ë¥≠‰π∞ÂØπÂ∫î‰∫ßÂìÅÊàñ‰∏âÂêà‰∏ÄÂ•óÈ§ê„ÄÇ`);
                  window.location.href = '/sight-reading-tool/';
                  return;
                }

                // ÈöêËóèÂäüËÉΩÂàáÊç¢Âô®ÔºàÂçï‰∏™‰∫ßÂìÅÁî®Êà∑‰∏çÈúÄË¶ÅÂàáÊç¢Ôºâ
                const functionSelector = document.querySelector('.function-selector');
                if (functionSelector) {
                  functionSelector.style.display = 'none';
                  console.log('üîí ÂäüËÉΩÂàáÊç¢Âô®Â∑≤ÈöêËóèÔºàÂçï‰∏™‰∫ßÂìÅÁî®Êà∑Ôºâ');
                }
              } else {
                // ‰∏âÂêà‰∏ÄÁî®Êà∑ÔºåÊòæÁ§∫ÂÆåÊï¥ÂäüËÉΩÂàáÊç¢Âô®
                console.log('‚úÖ ‰∏âÂêà‰∏ÄÁî®Êà∑Ôºå‰øùÊåÅÂÆåÊï¥ÂäüËÉΩÂàáÊç¢Âô®');
              }
            })();

            initializeModalClickOutsideToClose();
            initializeMenuClickOutsideToClose();
            console.log('üéØ ÂºπÁ™óÂ§ñÈÉ®ÁÇπÂáªÂÖ≥Èó≠ÂäüËÉΩÂ∑≤ÂàùÂßãÂåñ');
            console.log('üéØ ËèúÂçïÂ§ñÈÉ®ÁÇπÂáªÂÖ≥Èó≠ÂäüËÉΩÂ∑≤ÂàùÂßãÂåñ');
        });
    </script>

    <!-- ÂíåÂº¶ÁîüÊàêÂô®Ê®°Âùó -->
    <script src="./IC ÂíåÂº¶ËßÜÂ•èÂ∑•ÂÖ∑_files/harmony-theory.js"></script>
    <script src="./IC ÂíåÂº¶ËßÜÂ•èÂ∑•ÂÖ∑_files/enhanced-harmony.js"></script>
    <script src="./IC ÂíåÂº¶ËßÜÂ•èÂ∑•ÂÖ∑_files/chord-progressions.js"></script>
    <script src="./IC ÂíåÂº¶ËßÜÂ•èÂ∑•ÂÖ∑_files/jazz-harmony.js"></script>
    <script src="./IC ÂíåÂº¶ËßÜÂ•èÂ∑•ÂÖ∑_files/voicing-engine.js"></script>
    <script src="./IC ÂíåÂº¶ËßÜÂ•èÂ∑•ÂÖ∑_files/drop-voicing-simple.js"></script> <!-- üéØ ÊûÅÁÆÄDrop2/Drop3ÂÆûÁé∞ (2025-10-03) -->
    <script src="./IC ÂíåÂº¶ËßÜÂ•èÂ∑•ÂÖ∑_files/voice-leading.js"></script>

    <!-- üéµ Áã¨Á´ãÂ∞èË∞ÉÊãºÂÜôÁ≥ªÁªü - ÂÆåÂÖ®Áã¨Á´ãÊ®°ÂùóÔºåËß£ÂÜ≥ÂÖ´Â∫¶ÂíåÂèò‰ΩìÈü≥ÈóÆÈ¢ò -->
    <script src="./IC ÂíåÂº¶ËßÜÂ•èÂ∑•ÂÖ∑_files/minor-key-spelling.js"></script>
    <script src="./IC ÂíåÂº¶ËßÜÂ•èÂ∑•ÂÖ∑_files/minor-scale-alterations.js"></script>

    <!-- üåê ÂõΩÈôÖÂåñÔºài18nÔºâÁ≥ªÁªü - Â§öËØ≠Ë®ÄÊîØÊåÅ (2025-10-04) -->
    <script src="./IC ÂíåÂº¶ËßÜÂ•èÂ∑•ÂÖ∑_files/i18n.js"></script>

    <script src="./IC ÂíåÂº¶ËßÜÂ•èÂ∑•ÂÖ∑_files/chord-sight-reading.js?v=20251010"></script>

    <!-- Èí¢Áê¥Áã¨Á´ãÁîüÊàêÁ≥ªÁªü -->
    <script src="./IC ÂíåÂº¶ËßÜÂ•èÂ∑•ÂÖ∑_files/piano-settings-manager.js"></script>
    <script src="./IC ÂíåÂº¶ËßÜÂ•èÂ∑•ÂÖ∑_files/piano-harmony-engine.js"></script>
    <script src="./IC ÂíåÂº¶ËßÜÂ•èÂ∑•ÂÖ∑_files/piano-voicing-engine.js"></script>
    <script src="./IC ÂíåÂº¶ËßÜÂ•èÂ∑•ÂÖ∑_files/piano-chord-progression-generator.js"></script>
    <script src="./IC ÂíåÂº¶ËßÜÂ•èÂ∑•ÂÖ∑_files/piano-chord-generator.js"></script>

    <!-- Âêâ‰ªñÁã¨Á´ãËΩ¨‰ΩçÁ≥ªÁªü - ÂÆâÂÖ®Ê®°ÂºèÂÆûÁé∞ -->
    <script src="./IC ÂíåÂº¶ËßÜÂ•èÂ∑•ÂÖ∑_files/enhanced-voicing-settings.js"></script>
    <!-- ‰ΩøÁî®Êñ∞ÁöÑÂÆâÂÖ®Áã¨Á´ãvoicingÊéßÂà∂Ôºå‰∏ç‰øÆÊîπÂéüVoicingEngine -->
    <!-- <script src="chords-generator/safe-independent-voicing.js"></script> -->
    <!-- Ê≥®ÔºöÊñá‰ª∂‰∏çÂ≠òÂú®ÔºåÈÅøÂÖç404ÈîôËØØ (2025-10-02Ê∏ÖÁêÜ) -->
    <!-- ÊóßÁöÑÊâ©Â±ïÁ≥ªÁªüÂ∑≤Á¶ÅÁî®ÔºåÈÅøÂÖçËá™Âä®‰øÆÊîπVoicingEngineÂéüÂûã -->
    <!-- <script src="chords-generator/independent-voicing-extensions.js"></script> -->
    <!-- <script src="chords-generator/independent-voicing-generator.js"></script> -->
    <!-- <script src="chords-generator/independent-voicing-test.js"></script> -->

    <!-- Voicing‰øÆÂ§çÈ™åËØÅËÑöÊú¨ -->
    <script src="file:///Users/igorchen/Downloads/IC%20Studio/IC%20%E8%A7%86%E5%A5%8F%E5%B7%A5%E5%85%B7%20%E7%AC%AC%E4%B8%80%E7%89%88%20(%E5%B7%B2%E4%B8%8A%E6%9E%B6)%20%E9%9F%B3%E7%A8%8B%E4%BF%AE%E5%A4%8D%E4%B8%AD%202/chords-generator/voicing-fix-verification.js"></script>

    <!-- ‰æùËµñÊÄßÊµãËØïËÑöÊú¨ -->
    <script src="file:///Users/igorchen/Downloads/IC%20Studio/IC%20%E8%A7%86%E5%A5%8F%E5%B7%A5%E5%85%B7%20%E7%AC%AC%E4%B8%80%E7%89%88%20(%E5%B7%B2%E4%B8%8A%E6%9E%B6)%20%E9%9F%B3%E7%A8%8B%E4%BF%AE%E5%A4%8D%E4%B8%AD%202/chords-generator/dependency-test.js"></script>

    <!-- Áã¨Á´ãËΩ¨‰ΩçÊéßÂà∂‰ΩøÁî®ÊåáÂçó -->
    <script src="file:///Users/igorchen/Downloads/IC%20Studio/IC%20%E8%A7%86%E5%A5%8F%E5%B7%A5%E5%85%B7%20%E7%AC%AC%E4%B8%80%E7%89%88%20(%E5%B7%B2%E4%B8%8A%E6%9E%B6)%20%E9%9F%B3%E7%A8%8B%E4%BF%AE%E5%A4%8D%E4%B8%AD%202/chords-generator/independent-voicing-guide.js"></script>

    <!-- ÂΩìÂâçÁ≥ªÁªüÂΩ±ÂìçÊµãËØï -->
    <script src="file:///Users/igorchen/Downloads/IC%20Studio/IC%20%E8%A7%86%E5%A5%8F%E5%B7%A5%E5%85%B7%20%E7%AC%AC%E4%B8%80%E7%89%88%20(%E5%B7%B2%E4%B8%8A%E6%9E%B6)%20%E9%9F%B3%E7%A8%8B%E4%BF%AE%E5%A4%8D%E4%B8%AD%202/chords-generator/current-system-impact-test.js"></script>

    <!-- Â∫ïÂ±ÇÈÄªËæë‰øÆÊîπÈ™åËØÅÊµãËØï -->
    <script src="file:///Users/igorchen/Downloads/IC%20Studio/IC%20%E8%A7%86%E5%A5%8F%E5%B7%A5%E5%85%B7%20%E7%AC%AC%E4%B8%80%E7%89%88%20(%E5%B7%B2%E4%B8%8A%E6%9E%B6)%20%E9%9F%B3%E7%A8%8B%E4%BF%AE%E5%A4%8D%E4%B8%AD%202/chords-generator/bottom-logic-modification-test.js"></script>

    <!-- Âø´ÈÄü‰∏ÉÂíåÂº¶ÊµãËØï -->
    <script src="file:///Users/igorchen/Downloads/IC%20Studio/IC%20%E8%A7%86%E5%A5%8F%E5%B7%A5%E5%85%B7%20%E7%AC%AC%E4%B8%80%E7%89%88%20(%E5%B7%B2%E4%B8%8A%E6%9E%B6)%20%E9%9F%B3%E7%A8%8B%E4%BF%AE%E5%A4%8D%E4%B8%AD%202/chords-generator/quick-seventh-chord-test.js"></script>

    <!-- Drop2/Drop3Âéü‰Ωç‰øùÊä§ÊµãËØï (2025-10-02) -->
    <script src="./IC ÂíåÂº¶ËßÜÂ•èÂ∑•ÂÖ∑_files/test-drop-root-position.js"></script>

    <!-- Drop2/Drop3Ê≠£Á°ÆÂÆûÁé∞ (2025-10-02‰øÆÂ§ç) -->
    <script src="./IC ÂíåÂº¶ËßÜÂ•èÂ∑•ÂÖ∑_files/DROP-VOICING-FIX.js"></script>

    <!-- ÂíåÂº¶‰ª£Âè∑ËØäÊñ≠Â∑•ÂÖ∑ (2025-10-02) -->
    <script src="./IC ÂíåÂº¶ËßÜÂ•èÂ∑•ÂÖ∑_files/chord-analysis-diagnosis.js"></script>

    <!-- ÂíåÂº¶ÊòæÁ§∫ÁõëÊéßÂ∑•ÂÖ∑ (2025-10-02) -->
    <script src="./IC ÂíåÂº¶ËßÜÂ•èÂ∑•ÂÖ∑_files/chord-display-monitor.js"></script>

    <!-- Â¢ûÂº∫ÂäüËÉΩÂíåÂ£∞Á≥ªÁªüÂàùÂßãÂåñ -->
    <script>
        // ============ ‰∏ªÈ¢òÂàáÊç¢ÂäüËÉΩ ============
        let currentTheme = localStorage.getItem('preferredTheme') || 'light';

        // ‰∏ªÈ¢òÂõæÊ†áÊò†Â∞Ñ
        const themeIcons = {
            'light': 'üåô', // Âú®lightÊ®°ÂºèÊòæÁ§∫Êúà‰∫ÆÂõæÊ†áÔºåÁÇπÂáªÂàáÊç¢Âà∞dark
            'dark': '‚òÄÔ∏è'   // Âú®darkÊ®°ÂºèÊòæÁ§∫Â§™Èò≥ÂõæÊ†áÔºåÁÇπÂáªÂàáÊç¢Âà∞light
        };

        // ÂàáÊç¢‰∏ªÈ¢ò (‰øùÁïôÂêëÂêéÂÖºÂÆπÊÄß)
        function toggleTheme() {
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            setTheme(newTheme);
        }

        // ËÆæÁΩÆ‰∏ªÈ¢ò (Êñ∞ÁâàÊú¨ÔºåÁî®‰∫éËÆæÁΩÆËèúÂçï)
        function setTheme(theme) {
            currentTheme = theme;
            localStorage.setItem('preferredTheme', theme);

            // ËÆæÁΩÆHTMLÁöÑdata-themeÂ±ûÊÄß
            document.documentElement.setAttribute('data-theme', theme);

            // Ëß¶ÂèëÁªü‰∏ÄÂêåÊ≠•Á≥ªÁªü (ÂêåÊ†áÁ≠æÈ°µÂÜÖÂÆûÊó∂ÂêåÊ≠•)
            if (window.ICStudioSync) {
                window.ICStudioSync.syncTheme(theme, 'chord-tool');
            }

            // ÂÖ≥Èó≠ËÆæÁΩÆËèúÂçï
            if (typeof closeSettings === 'function') {
                closeSettings();
            }

            console.log(`üé® ÂíåÂº¶ËßÜÂ•èÂ∑•ÂÖ∑‰∏ªÈ¢òÂ∑≤ËÆæÁΩÆ‰∏∫: ${theme}`);
        }

        // ÂàùÂßãÂåñ‰∏ªÈ¢ò
        function initializeTheme() {
            document.documentElement.setAttribute('data-theme', currentTheme);
            console.log(`üé® ÂíåÂº¶ËßÜÂ•èÂ∑•ÂÖ∑‰∏ªÈ¢òÂàùÂßãÂåñ: ${currentTheme}`);
        }

        // ============ ÁøªËØëÂäüËÉΩ ============
        // Ê≥®ÊÑèÔºö‰ΩøÁî® chord-sight-reading.js ‰∏≠ÂÆö‰πâÁöÑ translations ÂèòÈáè

        // ËØ≠Ë®ÄÂàáÊç¢Áõ∏ÂÖ≥ÂèòÈáè
        let currentLanguage = localStorage.getItem('preferredLanguage') || 'zh-CN';

        // Â¶ÇÊûúÈ¶ñÊ¨°ËÆøÈóÆÔºå‰øùÂ≠òÈªòËÆ§ËØ≠Ë®ÄÂà∞ localStorage
        if (!localStorage.getItem('preferredLanguage')) {
            localStorage.setItem('preferredLanguage', 'zh-CN');
            console.log('üåê È¶ñÊ¨°ËÆøÈóÆÔºåÂ∑≤ËÆæÁΩÆÈªòËÆ§ËØ≠Ë®Ä‰∏∫‰∏≠Êñá');
        }

        // ÁøªËØëÂáΩÊï∞
        function applyTranslations() {
            // üîß ‰ΩøÁî® I18n Á≥ªÁªü (2025-10-04)
            if (window.I18n && window.I18n.applyLanguage) {
                window.I18n.applyLanguage(currentLanguage);
            } else {
                console.warn('‚ö†Ô∏è I18nÁ≥ªÁªüÊú™Âä†ËΩΩÔºåÊó†Ê≥ïÂ∫îÁî®ÁøªËØë');
            }
        }

        // ÂÖ®Â±ÄÁøªËØëÂáΩÊï∞Ôºà‰æõÂºπÁ™óË∞ÉÁî®Ôºâ
        window.translatePage = function() {
            applyTranslations();
        };

        // ÁøªËØëÂáΩÊï∞ - Ëé∑ÂèñÊåáÂÆöÈîÆÁöÑÁøªËØëÊñáÊú¨
        function translate(key) {
            // üîß ‰ΩøÁî® I18n Á≥ªÁªü (2025-10-04)
            if (window.I18n && window.I18n.t) {
                return window.I18n.t(key, currentLanguage);
            }
            // Â¶ÇÊûúI18nÊú™Âä†ËΩΩÔºåËøîÂõûÈîÆÂêç‰Ωú‰∏∫ÂêéÂ§á
            return key;
        }

        // Êõ¥Êñ∞Âä®ÊÄÅÊéß‰ª∂ÊñáÊú¨ÁøªËØë
        function updateDynamicControlsTranslation() {
            // Êõ¥Êñ∞ÂíåÂ£∞Ê®°ÂºèÊ†áÁ≠æ
            const harmonyModeLabel = document.getElementById('harmonyModeLabel');
            if (harmonyModeLabel) {
                const toggle = document.getElementById('functionalHarmonyToggle');
                if (toggle && toggle.checked) {
                    harmonyModeLabel.textContent = translate('controls.functionalMode');
                } else {
                    harmonyModeLabel.textContent = translate('controls.randomMode');
                }
            }

            // Êõ¥Êñ∞‰πêÂô®Ê®°ÂºèÊ†áÁ≠æ
            const instrumentModeLabel = document.getElementById('instrumentModeLabel');
            if (instrumentModeLabel) {
                const toggle = document.getElementById('instrumentModeToggle');
                if (toggle && toggle.checked) {
                    instrumentModeLabel.textContent = translate('controls.pianoMode');
                } else {
                    instrumentModeLabel.textContent = translate('controls.guitarMode');
                }
            }

            // Êõ¥Êñ∞È´òÁ∫ßËÆæÁΩÆÊåâÈíÆÊñáÊú¨
            const advancedBtn = document.getElementById('chordAdvancedBtn');
            const advancedDiv = document.getElementById('chordAdvancedSettings');
            if (advancedBtn && advancedDiv) {
                const isVisible = advancedDiv.style.display !== 'none';
                if (isVisible) {
                    advancedBtn.textContent = translate('button.hideAdvanced');
                } else {
                    advancedBtn.textContent = translate('button.showAdvanced');
                }
            }

            // Êõ¥Êñ∞ÂíåÂº¶‰ª£Âè∑ÊåâÈíÆÊ†áÈ¢ò
            const chordSymbolBtn = document.getElementById('chordSymbolBtn');
            if (chordSymbolBtn) {
                if (chordSymbolsVisible) {
                    chordSymbolBtn.title = translate('controls.chordSymbolsHide');
                } else {
                    chordSymbolBtn.title = translate('controls.chordSymbolsShow');
                }
            }
        }

        // È´òÁ∫ßËÆæÁΩÆÂàáÊç¢ÂáΩÊï∞
        function toggleChordAdvancedSettings() {
            const advancedDiv = document.getElementById('chordAdvancedSettings');
            const btn = document.getElementById('chordAdvancedBtn');

            if (advancedDiv && btn) {
                const isVisible = advancedDiv.style.display !== 'none';

                if (isVisible) {
                    advancedDiv.style.display = 'none';
                    btn.textContent = translate('button.showAdvanced');
                } else {
                    advancedDiv.style.display = 'block';
                    btn.textContent = translate('button.hideAdvanced');
                }
            }
        }

        // ËØ≠Ë®ÄÂàáÊç¢ÂáΩÊï∞
        function switchLanguage(language) {
            currentLanguage = language;
            localStorage.setItem('preferredLanguage', language);
            applyTranslations();

            // Ëß¶ÂèëÁªü‰∏ÄÂêåÊ≠•Á≥ªÁªü (ÂêåÊ†áÁ≠æÈ°µÂÜÖÂÆûÊó∂ÂêåÊ≠•)
            if (window.ICStudioSync) {
                window.ICStudioSync.syncLanguage(language, 'chord-tool');
            }

            // ÂÖ≥Èó≠ËÆæÁΩÆËèúÂçï
            if (typeof closeSettings === 'function') {
                closeSettings();
            }

            console.log(`üåê ÂíåÂº¶ËßÜÂ•èÂ∑•ÂÖ∑ËØ≠Ë®ÄÂ∑≤ÂàáÊç¢‰∏∫: ${language}`);
        }

        // ËÆæÁΩÆËèúÂçïÊéßÂà∂Á≥ªÁªü - Áªü‰∏ÄÂÆûÁé∞
        function toggleSettings() {
            const settingsMenu = document.getElementById('settingsMenu');
            const isVisible = settingsMenu.classList.contains('show');

            if (isVisible) {
                closeSettings();
            } else {
                openSettings();
            }
        }

        function openSettings() {
            const settingsMenu = document.getElementById('settingsMenu');
            settingsMenu.classList.add('show');

            // Ê∑ªÂä†ÁÇπÂáªÂ§ñÈÉ®Âå∫ÂüüÂÖ≥Èó≠ËèúÂçïÁöÑÁõëÂê¨Âô®
            setTimeout(() => {
                document.addEventListener('click', handleClickOutside);
            }, 10);
        }

        function closeSettings() {
            const settingsMenu = document.getElementById('settingsMenu');
            settingsMenu.classList.remove('show');

            // ÁßªÈô§ÁÇπÂáªÂ§ñÈÉ®Âå∫ÂüüÁöÑÁõëÂê¨Âô®
            document.removeEventListener('click', handleClickOutside);
        }

        // Â§ÑÁêÜÁÇπÂáªÂ§ñÈÉ®Âå∫ÂüüÂÖ≥Èó≠ËÆæÁΩÆËèúÂçï
        function handleClickOutside(event) {
            const settingsDropdown = document.querySelector('.settings-dropdown');

            if (settingsDropdown && !settingsDropdown.contains(event.target)) {
                closeSettings();
            }
        }

        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ‰∏ªÈ¢òÂíåÁøªËØë
        document.addEventListener('DOMContentLoaded', function() {
            initializeTheme();
            applyTranslations();
            console.log('üé®üåê ÂíåÂº¶ËßÜÂ•èÂ∑•ÂÖ∑‰∏ªÈ¢òÂíåÁøªËØëÂäüËÉΩÂ∑≤ÂàùÂßãÂåñ');

            // ============ Ë∑®Â∑•ÂÖ∑ÂêåÊ≠•ÁõëÂê¨Êú∫Âà∂ ============
            // ÁõëÂê¨ÂÖ∂‰ªñÂ∑•ÂÖ∑ÂØπlocalStorageÁöÑ‰øÆÊîπ
            window.addEventListener('storage', function(e) {
                if (e.key === 'preferredTheme' && e.newValue !== currentTheme) {
                    console.log(`üîÑ ÂíåÂº¶ËßÜÂ•èÂ∑•ÂÖ∑Ê£ÄÊµãÂà∞‰∏ªÈ¢òÂèòÂåñ: ${currentTheme} ‚Üí ${e.newValue}`);
                    currentTheme = e.newValue;
                    document.documentElement.setAttribute('data-theme', currentTheme);
                    console.log(`üé® ÂíåÂº¶ËßÜÂ•èÂ∑•ÂÖ∑‰∏ªÈ¢òÂ∑≤ÂêåÊ≠•‰∏∫: ${currentTheme}`);
                }

                if (e.key === 'preferredLanguage' && e.newValue !== currentLanguage) {
                    console.log(`üîÑ ÂíåÂº¶ËßÜÂ•èÂ∑•ÂÖ∑Ê£ÄÊµãÂà∞ËØ≠Ë®ÄÂèòÂåñ: ${currentLanguage} ‚Üí ${e.newValue}`);
                    currentLanguage = e.newValue;
                    applyTranslations();
                    console.log(`üåê ÂíåÂº¶ËßÜÂ•èÂ∑•ÂÖ∑ËØ≠Ë®ÄÂ∑≤ÂêåÊ≠•‰∏∫: ${currentLanguage}`);
                }
            });

            console.log('üîó ÂíåÂº¶ËßÜÂ•èÂ∑•ÂÖ∑localStorageË∑®Â∑•ÂÖ∑ÂêåÊ≠•ÁõëÂê¨Â∑≤ÂêØÁî®');

            // ============ Áªü‰∏ÄÂêåÊ≠•Á≥ªÁªü ============
            // ÂàõÂª∫ÂÖ®Â±ÄÂêåÊ≠•ÂáΩÊï∞ÔºåÊîØÊåÅÂêåÊ†áÁ≠æÈ°µÂÜÖÂÆûÊó∂ÂêåÊ≠•
            window.ICStudioSync = window.ICStudioSync || {
                tools: new Set(),

                // Ê≥®ÂÜåÂ∑•ÂÖ∑
                registerTool: function(toolName, callbacks) {
                    this.tools.add({
                        name: toolName,
                        onThemeChange: callbacks.onThemeChange,
                        onLanguageChange: callbacks.onLanguageChange
                    });
                    console.log(`üîó ${toolName} Â∑≤Ê≥®ÂÜåÂà∞Áªü‰∏ÄÂêåÊ≠•Á≥ªÁªü`);
                },

                // ÂêåÊ≠•‰∏ªÈ¢òÂà∞ÊâÄÊúâÂ∑•ÂÖ∑
                syncTheme: function(newTheme, fromTool) {
                    console.log(`üîÑ Áªü‰∏ÄÂêåÊ≠•Á≥ªÁªü: ÂêåÊ≠•‰∏ªÈ¢ò ${newTheme} (Êù•Ê∫ê: ${fromTool})`);
                    this.tools.forEach(tool => {
                        if (tool.name !== fromTool && tool.onThemeChange) {
                            try {
                                tool.onThemeChange(newTheme);
                            } catch (error) {
                                console.warn(`‚ö†Ô∏è ${tool.name} ‰∏ªÈ¢òÂêåÊ≠•Â§±Ë¥•:`, error);
                            }
                        }
                    });
                },

                // ÂêåÊ≠•ËØ≠Ë®ÄÂà∞ÊâÄÊúâÂ∑•ÂÖ∑
                syncLanguage: function(newLanguage, fromTool) {
                    console.log(`üîÑ Áªü‰∏ÄÂêåÊ≠•Á≥ªÁªü: ÂêåÊ≠•ËØ≠Ë®Ä ${newLanguage} (Êù•Ê∫ê: ${fromTool})`);
                    this.tools.forEach(tool => {
                        if (tool.name !== fromTool && tool.onLanguageChange) {
                            try {
                                tool.onLanguageChange(newLanguage);
                            } catch (error) {
                                console.warn(`‚ö†Ô∏è ${tool.name} ËØ≠Ë®ÄÂêåÊ≠•Â§±Ë¥•:`, error);
                            }
                        }
                    });
                }
            };

            // Ê≥®ÂÜåÂíåÂº¶Â∑•ÂÖ∑Âà∞Áªü‰∏ÄÂêåÊ≠•Á≥ªÁªü
            window.ICStudioSync.registerTool('chord-tool', {
                onThemeChange: function(newTheme) {
                    if (currentTheme !== newTheme) {
                        console.log(`üé® ÂíåÂº¶Â∑•ÂÖ∑Êé•Êî∂‰∏ªÈ¢òÂêåÊ≠•: ${currentTheme} ‚Üí ${newTheme}`);
                        currentTheme = newTheme;
                        document.documentElement.setAttribute('data-theme', currentTheme);
                    }
                },
                onLanguageChange: function(newLanguage) {
                    if (currentLanguage !== newLanguage) {
                        console.log(`üåê ÂíåÂº¶Â∑•ÂÖ∑Êé•Êî∂ËØ≠Ë®ÄÂêåÊ≠•: ${currentLanguage} ‚Üí ${newLanguage}`);
                        currentLanguage = newLanguage;
                        applyTranslations();
                    }
                }
            });
        });

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñÂ¢ûÂº∫ÂäüËÉΩÂíåÂ£∞Á≥ªÁªü
        // ====== ËäÇÊãçÂô®ÂäüËÉΩ ======
        // ËäÇÊãçÂô®Áõ∏ÂÖ≥ÂèòÈáè (Ê£ÄÊü•ÊòØÂê¶Â∑≤Â£∞Êòé)
        if (typeof metronomeInterval === 'undefined') {
            var metronomeInterval = null;
        }
        let metronomeAudioContext = null;
        let isMetronomeRunning = false;
        let metronomeTempo = 60; // ÈªòËÆ§60 BPM

        // ÂàùÂßãÂåñËäÇÊãçÂô®Èü≥È¢ë
        function initializeMetronomeAudio() {
            try {
                metronomeAudioContext = new (window.AudioContext || window.webkitAudioContext)();
                console.log('üéµ ËäÇÊãçÂô®Èü≥È¢ëÂàùÂßãÂåñÊàêÂäü');
                return true;
            } catch (error) {
                console.error('‚ùå ËäÇÊãçÂô®Èü≥È¢ëÂàùÂßãÂåñÂ§±Ë¥•:', error);
                return false;
            }
        }

        // Êí≠ÊîæËäÇÊãçÂô®Â£∞Èü≥
        function playMetronomeSound() {
            if (!metronomeAudioContext) {
                if (!initializeMetronomeAudio()) return;
            }

            try {
                // ÊÅ¢Â§çÈü≥È¢ë‰∏ä‰∏ãÊñáÔºàÁî®Êà∑‰∫§‰∫íÂêéÔºâ
                if (metronomeAudioContext.state === 'suspended') {
                    metronomeAudioContext.resume();
                }

                const oscillator = metronomeAudioContext.createOscillator();
                const gainNode = metronomeAudioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(metronomeAudioContext.destination);

                // ‰ΩøÁî®ÊñπÊ≥¢ÂíåËá™ÁÑ∂Èü≥È´ò (ÂèÇËÄÉNiceChordËäÇÊãçÂô®)
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(523.25, metronomeAudioContext.currentTime); // C5Èü≥È´ò

                // ËÆæÁΩÆËá™ÁÑ∂ÁöÑÈü≥ÈáèÂåÖÁªú (Êõ¥Â•ΩÁöÑrelease time)
                gainNode.gain.setValueAtTime(0.25, metronomeAudioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, metronomeAudioContext.currentTime + 0.05);

                oscillator.start(metronomeAudioContext.currentTime);
                oscillator.stop(metronomeAudioContext.currentTime + 0.05);

                // ËßÜËßâÂèçÈ¶à - Êõ¥Êñ∞headerÊåáÁ§∫Âô®
                const headerIndicator = document.getElementById('headerBeatIndicator');

                if (headerIndicator) {
                    headerIndicator.classList.add('beat');
                    setTimeout(() => {
                        headerIndicator.classList.remove('beat');
                    }, 150);
                }

            } catch (error) {
                console.error('‚ùå ËäÇÊãçÂô®Â£∞Èü≥Êí≠ÊîæÂ§±Ë¥•:', error);
            }
        }

        // ÂºÄÂêØ/ÂÅúÊ≠¢ËäÇÊãçÂô®
        function toggleMetronome() {
            const btn = document.getElementById('headerMetronomeBtn');
            const bpmInput = document.getElementById('headerMetronomeBpm');

            if (isMetronomeRunning) {
                // ÂÅúÊ≠¢ËäÇÊãçÂô®
                stopMetronome();
            } else {
                // ÂêØÂä®ËäÇÊãçÂô®
                metronomeTempo = parseInt(bpmInput.value) || 60;
                startMetronome();
            }
        }

        // ÂêØÂä®ËäÇÊãçÂô®
        function startMetronome() {
            if (isMetronomeRunning) return;

            const btn = document.getElementById('headerMetronomeBtn');
            const interval = 60000 / metronomeTempo; // ËÆ°ÁÆóÈó¥ÈöîÊó∂Èó¥ÔºàÊØ´ÁßíÔºâ

            isMetronomeRunning = true;
            btn.textContent = '‚è∏Ô∏è';
            btn.title = 'ÂÅúÊ≠¢ËäÇÊãçÂô®';

            // Á´ãÂç≥Êí≠ÊîæÁ¨¨‰∏ÄÂ£∞
            playMetronomeSound();

            // ËÆæÁΩÆÂÆöÊó∂Âô®
            metronomeInterval = setInterval(() => {
                playMetronomeSound();
            }, interval);

            console.log(`üéµ ËäÇÊãçÂô®Â∑≤ÂêØÂä®: ${metronomeTempo} BPM`);
        }

        // ÂÅúÊ≠¢ËäÇÊãçÂô®
        function stopMetronome() {
            if (!isMetronomeRunning) return;

            const btn = document.getElementById('headerMetronomeBtn');

            isMetronomeRunning = false;
            btn.textContent = 'üéµ';
            btn.title = 'ÂºÄÂßãËäÇÊãçÂô®';

            if (metronomeInterval) {
                clearInterval(metronomeInterval);
                metronomeInterval = null;
            }

            console.log('üîá ËäÇÊãçÂô®Â∑≤ÂÅúÊ≠¢');
        }

        // Êõ¥Êñ∞ËäÇÊãçÂô®ÈÄüÂ∫¶
        function updateMetronomeTempo() {
            const bpmInput = document.getElementById('headerMetronomeBpm');
            metronomeTempo = parseInt(bpmInput.value) || 60;

            if (isMetronomeRunning) {
                // Â¶ÇÊûúËäÇÊãçÂô®Ê≠£Âú®ËøêË°åÔºåÈáçÊñ∞ÂêØÂä®‰ª•Â∫îÁî®Êñ∞ÈÄüÂ∫¶
                stopMetronome();
                startMetronome();
            }
        }

        // ÂäüËÉΩÂíåÂ£∞ÂºÄÂÖ≥ÂàáÊç¢
        function toggleFunctionalHarmony() {
            const toggle = document.getElementById('functionalHarmonyToggle');
            const label = document.getElementById('harmonyModeLabel');
            const slider = toggle.nextElementSibling;
            const sliderButton = slider.querySelector('.slider-button');
            const keySettingsBtn = document.getElementById('keySettingsBtn');
            const keySettingsGroup = keySettingsBtn ? keySettingsBtn.parentElement : null;

            if (toggle.checked) {
                // ÂêØÁî®ÂäüËÉΩÂíåÂ£∞Ê®°Âºè
                chordSettings.useFunctionalHarmony = true;
                label.textContent = translate('controls.functionalMode');
                slider.style.backgroundColor = '#FF9500';
                if (sliderButton) {
                    sliderButton.style.transform = 'translateX(26px)';
                }

                // ÊòæÁ§∫Ë∞ÉÂè∑ËÆæÁΩÆ
                if (keySettingsGroup) {
                    keySettingsGroup.style.removeProperty('display');
                }
                console.log('üéº Â∑≤ÂêØÁî®ÂäüËÉΩÂíåÂ£∞Ê®°Âºè');
            } else {
                // ÂêØÁî®ÂÆåÂÖ®ÈöèÊú∫Ê®°Âºè
                chordSettings.useFunctionalHarmony = false;
                label.textContent = translate('controls.pureRandomMode');
                slider.style.backgroundColor = '#ccc';
                if (sliderButton) {
                    sliderButton.style.transform = 'translateX(0px)';
                }

                // ÈöêËóèË∞ÉÂè∑ËÆæÁΩÆÔºåÊòæÁ§∫Âõ∫ÂÆöCÂ§ßË∞ÉËØ¥Êòé
                if (keySettingsGroup) {
                    keySettingsGroup.style.display = 'none';
                }
                console.log('üé≤ Â∑≤ÂêØÁî®ÂÆåÂÖ®ÈöèÊú∫Ê®°ÂºèÔºàÂõ∫ÂÆöCÂ§ßË∞ÉÔºâ');
            }
        }

        // ‰πêÂô®Ê®°ÂºèÂàáÊç¢
        function toggleInstrumentMode() {
            const toggle = document.getElementById('instrumentModeToggle');
            const label = document.getElementById('instrumentModeLabel');
            const slider = toggle.nextElementSibling;
            const sliderButton = slider.querySelector('.slider-button');

            if (toggle.checked) {
                // ÂêØÁî®Èí¢Áê¥Ê®°Âºè
                label.textContent = translate('controls.pianoMode');
                // üîß ‰øÆÂ§ç (2025-10-01): Êîπ‰∏∫Ê©ôËâ≤ #FF9500Ôºå‰∏éÈ°µÈù¢Êï¥‰ΩìÈ£éÊ†º‰∏ÄËá¥
                slider.style.backgroundColor = '#FF9500'; // Ê©ôËâ≤Ë°®Á§∫Èí¢Áê¥
                if (sliderButton) {
                    sliderButton.style.transform = 'translateX(26px)';
                }
                console.log('üéπ Èí¢Áê¥ÂíåÂ£∞Ê®°ÂºèÂ∑≤ÈÄâÊã©');

                // üéπ Èí¢Áê¥Ê®°ÂºèÔºöÂàáÊç¢È´òÁ∫ßËÆæÁΩÆUIÔºàÈü≥Êï∞ÈÄâÊã©Âô®Ôºâ
                const pianoAdvancedSettings = document.getElementById('pianoAdvancedSettings');
                const guitarAdvancedSettings = document.getElementById('guitarAdvancedSettings');
                if (pianoAdvancedSettings && guitarAdvancedSettings) {
                    pianoAdvancedSettings.style.display = 'block';
                    guitarAdvancedSettings.style.display = 'none';
                    console.log('üéπ Èí¢Áê¥Ê®°ÂºèÔºöÂàáÊç¢Âà∞Èü≥Êï∞ÈÄâÊã©Âô®UI');

                    // üéØ ÂêåÊ≠•Èí¢Áê¥Èü≥Êï∞checkboxÁä∂ÊÄÅ
                    setTimeout(() => {
                        const enabledCounts = window.pianoSettings?.enabledNoteCounts || [4];
                        console.log('üéØ ÂêåÊ≠•Èí¢Áê¥Èü≥Êï∞checkbox (ÂàáÊç¢Ê®°ÂºèÊó∂):', enabledCounts);

                        // üîß ‰øÆÂ§ç (2025-10-01): Âè™Â§ÑÁêÜ3-7Èü≥
                        // ÂÖàÂèñÊ∂àÊâÄÊúâÂãæÈÄâ
                        for (let i = 3; i <= 7; i++) {
                            const checkbox = document.getElementById(`notecount-${i}`);
                            if (checkbox) checkbox.checked = false;
                        }

                        // ÁÑ∂ÂêéÂãæÈÄâenabledNoteCounts‰∏≠ÁöÑÈü≥Êï∞
                        enabledCounts.forEach(count => {
                            const checkbox = document.getElementById(`notecount-${count}`);
                            if (checkbox) {
                                checkbox.checked = true;
                                console.log(`  ‚úÖ Â∑≤ÂãæÈÄâ${count}Èü≥`);
                            }
                        });
                    }, 50);
                }

                // üéπ Èí¢Áê¥Ê®°ÂºèÔºöÂàáÊç¢Èü≥ÂüüËÆæÁΩÆUIÔºàÂèåË∞±Âè∑Èü≥ÂüüÊåâÈíÆÔºâ
                const pianoRangeSettings = document.getElementById('pianoRangeSettings');
                const guitarRangeSettings = document.getElementById('guitarRangeSettings');
                if (pianoRangeSettings && guitarRangeSettings) {
                    pianoRangeSettings.style.display = 'block';
                    guitarRangeSettings.style.display = 'none';
                    console.log('üéπ Èí¢Áê¥Ê®°ÂºèÔºöÂàáÊç¢Âà∞ÂèåË∞±Âè∑Èü≥ÂüüËÆæÁΩÆUI');
                }

                // üéº Èí¢Áê¥Ê®°ÂºèUIÈÄÇÈÖçÔºöÊòæÁ§∫Ë∞±Âè∑ËÆæÁΩÆÊéß‰ª∂
                const clefControlGroup = document.getElementById('clefControlGroup');
                if (clefControlGroup) {
                    clefControlGroup.style.visibility = 'visible';
                    clefControlGroup.style.height = 'auto';
                    clefControlGroup.style.overflow = 'visible';
                    clefControlGroup.style.margin = '';
                    clefControlGroup.style.padding = '';
                    clefControlGroup.style.removeProperty('display'); // ÊÅ¢Â§çCSSÁ±ªÁöÑÂéüÂßãflexÂ±ûÊÄß
                    console.log('üéπ Èí¢Áê¥Ê®°ÂºèÔºöÊòæÁ§∫Ë∞±Âè∑ËÆæÁΩÆÊéß‰ª∂ÔºàÂè™ÊúâÂ§ßË∞±Ë°®ÂíåÈ´òÈü≥Ë∞±Âè∑Ôºâ');
                } else {
                    console.log('üéπ Èí¢Áê¥Ê®°ÂºèÔºöË∞±Âè∑ËÆæÁΩÆÊéß‰ª∂Êú™ÊâæÂà∞');
                }

                // üéº Èí¢Áê¥Ê®°ÂºèÔºöÊô∫ËÉΩÈªòËÆ§Ë∞±Âè∑ËÆæÁΩÆ
                applyIntelligentClefDefaults('piano');

                // Ê£ÄÊü•Èí¢Áê¥ÁîüÊàêÂô®ÊòØÂê¶ÂèØÁî®
                if (typeof pianoChordGenerator !== 'undefined' && pianoChordGenerator && pianoChordGenerator.isInitialized) {
                    console.log('üéπ Èí¢Áê¥ÁîüÊàêÂô®Â∑≤Â∞±Áª™');
                } else {
                    console.log('üéπ Èí¢Áê¥ÁîüÊàêÂô®Ê≠£Âú®ÂàùÂßãÂåñ...');
                }
            } else {
                // ÂêØÁî®Âêâ‰ªñÊ®°ÂºèÔºàÈªòËÆ§Ôºâ
                label.textContent = translate('controls.guitarMode');
                slider.style.backgroundColor = '#ccc'; // ÁÅ∞Ëâ≤ÈªòËÆ§Áä∂ÊÄÅÔºå‰∏éÂíåÂ£∞Ê®°Âºè‰∏ÄËá¥
                if (sliderButton) {
                    sliderButton.style.transform = 'translateX(0px)';
                }
                console.log('üé∏ Âêâ‰ªñÂíåÂ£∞Ê®°ÂºèÂ∑≤ÈÄâÊã©ÔºàÈªòËÆ§Ôºâ');

                // üé∏ Âêâ‰ªñÊ®°ÂºèÔºöÂàáÊç¢È´òÁ∫ßËÆæÁΩÆUIÔºàvoicingÈÄâÊã©Âô®Ôºâ
                const pianoAdvancedSettings = document.getElementById('pianoAdvancedSettings');
                const guitarAdvancedSettings = document.getElementById('guitarAdvancedSettings');
                if (pianoAdvancedSettings && guitarAdvancedSettings) {
                    pianoAdvancedSettings.style.display = 'none';
                    guitarAdvancedSettings.style.display = 'block';
                    console.log('üé∏ Âêâ‰ªñÊ®°ÂºèÔºöÂàáÊç¢Âà∞VoicingÈÄâÊã©Âô®UI');
                }

                // üé∏ Âêâ‰ªñÊ®°ÂºèÔºöÂàáÊç¢Èü≥ÂüüËÆæÁΩÆUIÔºàÁªü‰∏ÄÈü≥ÂüüÈÄâÊã©Âô®Ôºâ
                const pianoRangeSettings = document.getElementById('pianoRangeSettings');
                const guitarRangeSettings = document.getElementById('guitarRangeSettings');
                if (pianoRangeSettings && guitarRangeSettings) {
                    pianoRangeSettings.style.display = 'none';
                    guitarRangeSettings.style.display = 'block';
                    console.log('üé∏ Âêâ‰ªñÊ®°ÂºèÔºöÂàáÊç¢Âà∞Áªü‰∏ÄÈü≥ÂüüËÆæÁΩÆUI');
                }

                // üéº Âêâ‰ªñÊ®°ÂºèÔºöÈöêËóèË∞±Âè∑ËÆæÁΩÆÊéß‰ª∂
                const clefControlGroup = document.getElementById('clefControlGroup');
                if (clefControlGroup) {
                    clefControlGroup.style.visibility = 'hidden';
                    clefControlGroup.style.height = '0';
                    clefControlGroup.style.overflow = 'hidden';
                    clefControlGroup.style.margin = '0';
                    clefControlGroup.style.padding = '0';
                    console.log('üé∏ Âêâ‰ªñÊ®°ÂºèÔºöÈöêËóèË∞±Âè∑ËÆæÁΩÆÊéß‰ª∂ÔºàÂêâ‰ªñÂè™‰ΩøÁî®È´òÈü≥Ë∞±Âè∑Ôºâ');
                } else {
                    console.log('üé∏ Âêâ‰ªñÊ®°ÂºèÔºöË∞±Âè∑ËÆæÁΩÆÊéß‰ª∂Êú™ÊâæÂà∞');
                }

                // üéº Âêâ‰ªñÊ®°ÂºèÔºöÂº∫Âà∂‰ΩøÁî®È´òÈü≥Ë∞±Âè∑
                if (window.chordSettings) {
                    window.chordSettings.clefs = ['treble'];
                    console.log('üé∏ Âêâ‰ªñÊ®°ÂºèÔºöÂº∫Âà∂‰ΩøÁî®È´òÈü≥Ë∞±Âè∑');
                }
            }
        }

        // üéº Êô∫ËÉΩÈªòËÆ§Ë∞±Âè∑ËÆæÁΩÆÁ≥ªÁªü
        function applyIntelligentClefDefaults(mode) {
            if (!window.chordSettings) {
                console.warn('‚ö†Ô∏è chordSettings Êú™ÂàùÂßãÂåñÔºåÊó†Ê≥ïËÆæÁΩÆÊô∫ËÉΩÈªòËÆ§Ë∞±Âè∑');
                return;
            }

            console.log(`üéØ Â∫îÁî® ${mode} Ê®°ÂºèÁöÑÊô∫ËÉΩÈªòËÆ§Ë∞±Âè∑ËÆæÁΩÆ`);

            // ÂÆö‰πâÊ®°ÂºèÁâπÂÆöÁöÑÈªòËÆ§Ë∞±Âè∑
            const modeDefaults = {
                piano: {
                    primary: ['grand_staff'],           // Èí¢Áê¥È¶ñÈÄâÔºöÂ§ßË∞±Ë°®
                    secondary: ['treble'],              // Â§áÈÄâÔºöÈ´òÈü≥Ë∞±Âè∑ÔºàÈí¢Áê¥Ê®°Âºè‰∏ç‰ΩøÁî®‰ΩéÈü≥Ë∞±Âè∑Ôºâ
                    allowedClefs: ['grand_staff', 'treble'], // Èí¢Áê¥Ê®°ÂºèÂÖÅËÆ∏ÁöÑË∞±Âè∑
                    description: 'Èí¢Áê¥Ê®°Âºè‰ºòÈÄâÂ§ßË∞±Ë°®Ôºå‰πüÂèØÈÄâÊã©È´òÈü≥Ë∞±Âè∑'
                },
                guitar: {
                    primary: ['treble'],                // Âêâ‰ªñÈ¶ñÈÄâÔºöÈ´òÈü≥Ë∞±Âè∑
                    secondary: ['treble'],              // Âêâ‰ªñÊ®°ÂºèÂè™Áî®È´òÈü≥Ë∞±Âè∑
                    allowedClefs: ['treble'],           // Âêâ‰ªñÊ®°ÂºèÂè™ÂÖÅËÆ∏È´òÈü≥Ë∞±Âè∑
                    description: 'Âêâ‰ªñÊ®°ÂºèÂõ∫ÂÆö‰ΩøÁî®È´òÈü≥Ë∞±Âè∑'
                }
            };

            const defaults = modeDefaults[mode];
            if (!defaults) {
                console.warn(`‚ö†Ô∏è Êú™Áü•Ê®°Âºè: ${mode}`);
                return;
            }

            // üéπ Èí¢Áê¥Ê®°ÂºèÔºöÊÄªÊòØ‰ºòÂÖàËÆæÁΩÆ‰∏∫Â§ßË∞±Ë°®
            if (mode === 'piano') {
                window.chordSettings.clefs = ['grand_staff'];
                console.log(`üéπ Èí¢Áê¥Ê®°ÂºèÔºöËá™Âä®ËÆæÁΩÆ‰∏∫Â§ßË∞±Ë°®`);
                console.log(`üìù ËØ¥Êòé: ${defaults.description}`);
                // Êõ¥Êñ∞UIÊòæÁ§∫
                updateClefSettingsDisplay();
            } else {
                // ÂÖ∂‰ªñÊ®°ÂºèÔºöÊ£ÄÊü•Áî®Êà∑ÊòØÂê¶Â∑≤ÊúâË∞±Âè∑ËÆæÁΩÆ
                const hasUserClefs = window.chordSettings.clefs &&
                                    window.chordSettings.clefs.length > 0;

                if (!hasUserClefs) {
                    // üéØ È¶ñÊ¨°‰ΩøÁî®ÔºöÂ∫îÁî®Ê®°ÂºèÈªòËÆ§ËÆæÁΩÆ
                    window.chordSettings.clefs = [...defaults.primary];
                    console.log(`üéº ${mode}Ê®°ÂºèÈ¶ñÊ¨°‰ΩøÁî®ÔºåËÆæÁΩÆÈªòËÆ§Ë∞±Âè∑: ${defaults.primary.join(', ')}`);
                    console.log(`üìù ËØ¥Êòé: ${defaults.description}`);

                    // Êõ¥Êñ∞UIÊòæÁ§∫
                    updateClefSettingsDisplay();
                } else {
                    // üîÑ Â∑≤ÊúâËÆæÁΩÆÔºöÈ™åËØÅÂπ∂ËøáÊª§‰∏çÂÖºÂÆπÁöÑË∞±Âè∑
                    const currentClefs = window.chordSettings.clefs;
                    const allowedClefs = defaults.allowedClefs;

                    // ËøáÊª§Âá∫ÂΩìÂâçÊ®°ÂºèÂÖÅËÆ∏ÁöÑË∞±Âè∑
                    const filteredClefs = currentClefs.filter(clef => allowedClefs.includes(clef));

                    if (filteredClefs.length === 0) {
                        // Â¶ÇÊûúÊ≤°ÊúâÂÖºÂÆπÁöÑË∞±Âè∑Ôºå‰ΩøÁî®ÈªòËÆ§ËÆæÁΩÆ
                        window.chordSettings.clefs = [...defaults.primary];
                        console.log(`üîß ${mode}Ê®°ÂºèÔºöÊó†ÂÖºÂÆπË∞±Âè∑Ôºå‰ΩøÁî®ÈªòËÆ§ËÆæÁΩÆ: ${defaults.primary.join(', ')}`);
                        updateClefSettingsDisplay();
                    } else if (filteredClefs.length !== currentClefs.length) {
                        // Â¶ÇÊûúÊúâ‰∏çÂÖºÂÆπÁöÑË∞±Âè∑Ë¢´ËøáÊª§Êéâ
                        const removedClefs = currentClefs.filter(clef => !allowedClefs.includes(clef));
                        window.chordSettings.clefs = filteredClefs;
                        console.log(`üîß ${mode}Ê®°ÂºèÔºöÁßªÈô§‰∏çÂÖºÂÆπË∞±Âè∑ [${removedClefs.join(', ')}]Ôºå‰øùÁïô [${filteredClefs.join(', ')}]`);
                        updateClefSettingsDisplay();
                    } else {
                        // ÊâÄÊúâË∞±Âè∑ÈÉΩÂÖºÂÆπ
                        console.log(`‚úÖ ${mode}Ê®°ÂºèÔºö‰øùÊåÅÁî®Êà∑ËÆæÁΩÆ ${currentClefs.join(', ')}`);
                    }
                }
            }

            // ‰øùÂ≠òÊ®°ÂºèÂÅèÂ•ΩÔºàÁî®‰∫é‰∏ãÊ¨°ÂêØÂä®Ôºâ
            if (!window.chordSettings.modePreferences) {
                window.chordSettings.modePreferences = {};
            }
            window.chordSettings.modePreferences[mode] = {
                lastUsedClefs: [...(window.chordSettings.clefs || [])],
                timestamp: new Date().toISOString()
            };

            console.log(`üéØ ${mode}Ê®°ÂºèÊô∫ËÉΩÈªòËÆ§ËÆæÁΩÆÂÆåÊàê`);
        }

        // üéπ Èí¢Áê¥Ê®°ÂºèÔºöÈü≥Êï∞ÈÄâÊã©ÂÖ®ÈÄâ/ÂèñÊ∂àÂÖ®ÈÄâ
        function toggleSelectAllNoteCounts() {
            const checkboxes = document.querySelectorAll('#pianoAdvancedSettings input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            const text = document.getElementById('noteCountSelectAllText');

            checkboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
            });

            if (text) {
                text.textContent = allChecked ? translate('button.selectAll') : translate('button.unselectAll');
            }

            console.log(`üéπ Èü≥Êï∞ÈÄâÊã©: ${allChecked ? 'ÂèñÊ∂àÂÖ®ÈÄâ' : 'ÂÖ®ÈÄâ'}`);
        }

        // üé∏ Âêâ‰ªñÊ®°ÂºèÔºövoicingÈÄâÊã©ÂÖ®ÈÄâ/ÂèñÊ∂àÂÖ®ÈÄâ
        function toggleSelectAllVoicings() {
            const checkboxes = document.querySelectorAll('#guitarAdvancedSettings input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            const text = document.getElementById('voicingSelectAllText');

            checkboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
            });

            if (text) {
                text.textContent = allChecked ? translate('button.selectAll') : translate('button.unselectAll');
            }

            console.log(`üé∏ VoicingÈÄâÊã©: ${allChecked ? 'ÂèñÊ∂àÂÖ®ÈÄâ' : 'ÂÖ®ÈÄâ'}`);
        }

        // üéº Êõ¥Êñ∞Ë∞±Âè∑ËÆæÁΩÆÊòæÁ§∫ÔºàËæÖÂä©ÂáΩÊï∞Ôºâ
        function updateClefSettingsDisplay() {
            // Â¶ÇÊûúË∞±Âè∑ËÆæÁΩÆÂºπÁ™óÂΩìÂâçÂèØËßÅÔºåÊõ¥Êñ∞Â§çÈÄâÊ°ÜÁä∂ÊÄÅ
            const clefModal = document.getElementById('clefModal');
            if (clefModal && clefModal.style.display !== 'none') {
                const checkboxes = clefModal.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    const clefType = checkbox.value;
                    checkbox.checked = window.chordSettings.clefs &&
                                     window.chordSettings.clefs.includes(clefType);
                });
                console.log('üéº Â∑≤Êõ¥Êñ∞Ë∞±Âè∑ËÆæÁΩÆÂºπÁ™óÊòæÁ§∫Áä∂ÊÄÅ');
            }
        }

        // üéº ‰∫îÁ∫øË∞±ÊòæÁ§∫/ÈöêËóèÊéßÂà∂
        function toggleStaffDisplay() {
            applyStaffDisplayState();
        }

        // Â∫îÁî®‰∫îÁ∫øË∞±ÊòæÁ§∫Áä∂ÊÄÅ - ÁÆÄÂåñÁõ¥Êé•ÁöÑÊñπÊ≥ï
        function applyStaffDisplayState() {
            // üîß ‰øÆÂ§ç (2025-10-01): ‰ΩøÁî®querySelectorËé∑ÂèñÁ¨¨‰∏Ä‰∏™toggleÔºàÊîØÊåÅÂ§ö‰∏™toggleÔºâ
            const toggle = document.querySelector('input[id="staffDisplayToggle"]');
            const scoreContainer = document.getElementById('score'); // ‰øÆÂ§çÔºöÊ≠£Á°ÆÁöÑIDÊòØ'score'

            if (toggle && scoreContainer) {
                const svg = scoreContainer.querySelector('svg');
                if (svg) {
                    console.log(`üéº Â∫îÁî®‰∫îÁ∫øË∞±ÊòæÁ§∫Áä∂ÊÄÅ: ${toggle.checked ? 'ÊòæÁ§∫' : 'ÈöêËóè'}`);

                    if (toggle.checked) {
                        // ÊòæÁ§∫‰∫îÁ∫øË∞± - ÊÅ¢Â§çÊâÄÊúâ‰∫îÁ∫øË∞±ÂÖÉÁ¥†ÂíåÂ∞èËäÇÊï∞
                        const staffElements = svg.querySelectorAll([
                            '.vf-clef',           // Ë∞±Âè∑
                            '.vf-timesignature',  // ÊãçÂè∑
                            '.vf-stavenote',      // Èü≥Á¨¶
                            '.vf-note',           // Èü≥Á¨¶
                            '.vf-notehead',       // Èü≥Á¨¶Â§¥
                            '.vf-stem',           // Á¨¶ÊùÜ
                            '.vf-flag',           // Á¨¶Â∞æ
                            '.vf-beam',           // ËøûÈü≥Á∫ø
                            'path',               // ‰∫îÁ∫øË∞±Á∫øÊù°
                            'line',               // Ë∞±Á∫ø
                            'rect'                // Â∞èËäÇÁ∫ø
                        ].join(', '));

                        // ÊòæÁ§∫‰∫îÁ∫øË∞±ÂÖÉÁ¥†
                        staffElements.forEach(el => {
                            el.style.display = '';
                            el.style.visibility = 'visible';
                            el.style.opacity = '1';
                        });

                        // ÊÅ¢Â§çÊñáÊú¨ÂÖÉÁ¥†ÔºàÂ∞èËäÇÊï∞ÊÄªÊòØÊòæÁ§∫ÔºåÂíåÂº¶‰ª£Âè∑Ê†πÊçÆÂºÄÂÖ≥Áä∂ÊÄÅÔºâ
                        const allTextElements = svg.querySelectorAll('text');
                        let restoredMeasureNumbers = 0;
                        let restoredChordSymbols = 0;

                        allTextElements.forEach(textEl => {
                            if (isChordSymbolElement(textEl)) {
                                // ÂíåÂº¶‰ª£Âè∑ÔºöÊ†πÊçÆÂíåÂº¶‰ª£Âè∑ÂºÄÂÖ≥Áä∂ÊÄÅÂÜ≥ÂÆöÊòØÂê¶ÊòæÁ§∫
                                if (window.displaySettings.chordSymbolsVisible) {
                                    textEl.style.display = '';
                                    textEl.style.visibility = 'visible';
                                    textEl.style.opacity = '1';
                                    restoredChordSymbols++;
                                } else {
                                    // ÂíåÂº¶‰ª£Âè∑ÂºÄÂÖ≥ÂÖ≥Èó≠Êó∂Ôºå‰øùÊåÅÈöêËóè
                                    textEl.style.display = 'none';
                                    textEl.style.visibility = 'hidden';
                                    textEl.style.opacity = '0';
                                }
                            } else {
                                // Â∞èËäÇÊï∞ÂíåÂÖ∂‰ªñÊñáÊú¨ÔºöÊÄªÊòØÊòæÁ§∫
                                textEl.style.display = '';
                                textEl.style.visibility = 'visible';
                                textEl.style.opacity = '1';
                                restoredMeasureNumbers++;
                            }
                        });

                        console.log(`üéº ‚úÖ ÊòæÁ§∫‰∫Ü‰∫îÁ∫øË∞± (${staffElements.length}‰∏™ÂÖÉÁ¥†) ÂíåÂ∞èËäÇÊï∞ (${restoredMeasureNumbers}‰∏™)ÔºåÂíåÂº¶‰ª£Âè∑ (${restoredChordSymbols}‰∏™ÔºåÊ†πÊçÆÂºÄÂÖ≥Áä∂ÊÄÅ)`);
                    } else {
                        // ÈöêËóè‰∫îÁ∫øË∞±ÂíåÂ∞èËäÇÊï∞Ôºå‰ΩÜ‰øùÁïôÂíåÂº¶‰ª£Âè∑
                        const staffElements = svg.querySelectorAll([
                            '.vf-clef',           // Ë∞±Âè∑
                            '.vf-timesignature',  // ÊãçÂè∑
                            '.vf-stavenote',      // Èü≥Á¨¶
                            '.vf-note',           // Èü≥Á¨¶
                            '.vf-notehead',       // Èü≥Á¨¶Â§¥
                            '.vf-stem',           // Á¨¶ÊùÜ
                            '.vf-flag',           // Á¨¶Â∞æ
                            '.vf-beam',           // ËøûÈü≥Á∫ø
                            'path',               // ‰∫îÁ∫øË∞±Á∫øÊù°
                            'line',               // Ë∞±Á∫ø
                            'rect'                // Â∞èËäÇÁ∫ø
                        ].join(', '));

                        // ÈöêËóè‰∫îÁ∫øË∞±ÂÖÉÁ¥†
                        staffElements.forEach(el => {
                            el.style.display = 'none';
                            el.style.visibility = 'hidden';
                            el.style.opacity = '0';
                        });

                        // ÈöêËóèÂ∞èËäÇÊï∞‰ΩÜ‰øùÁïôÂíåÂº¶‰ª£Âè∑
                        const allTextElements = svg.querySelectorAll('text');
                        let hiddenMeasureNumbers = 0;
                        let preservedChordSymbols = 0;

                        allTextElements.forEach(textEl => {
                            if (isChordSymbolElement(textEl)) {
                                // ÂíåÂº¶‰ª£Âè∑ÔºöÊ†πÊçÆÂíåÂº¶‰ª£Âè∑ÂºÄÂÖ≥Áä∂ÊÄÅÂÜ≥ÂÆöÊòØÂê¶ÊòæÁ§∫
                                if (window.displaySettings.chordSymbolsVisible) {
                                    textEl.style.display = '';
                                    textEl.style.visibility = 'visible';
                                    textEl.style.opacity = '1';
                                    preservedChordSymbols++;
                                } else {
                                    // ÂíåÂº¶‰ª£Âè∑ÂºÄÂÖ≥ÂÖ≥Èó≠Êó∂Ôºå‰øùÊåÅÈöêËóè
                                    textEl.style.display = 'none';
                                    textEl.style.visibility = 'hidden';
                                    textEl.style.opacity = '0';
                                }
                            } else {
                                // ÈöêËóèÂÖ∂‰ªñÊñáÊú¨ÂÖÉÁ¥†ÔºàÂåÖÊã¨Â∞èËäÇÊï∞Ôºâ
                                textEl.style.display = 'none';
                                textEl.style.visibility = 'hidden';
                                textEl.style.opacity = '0';
                                hiddenMeasureNumbers++;
                            }
                        });

                        console.log(`üéº ‚úÖ ÈöêËóè‰∫Ü‰∫îÁ∫øË∞± (${staffElements.length}‰∏™ÂÖÉÁ¥†) ÂíåÂ∞èËäÇÊï∞ (${hiddenMeasureNumbers}‰∏™)Ôºå‰øùÁïôÂíåÂº¶‰ª£Âè∑ (${preservedChordSymbols}‰∏™)`);
                    }
                } else {
                    console.warn('‚ö†Ô∏è Êú™ÊâæÂà∞SVGÂÖÉÁ¥†ÔºåÊó†Ê≥ïÂ∫îÁî®‰∫îÁ∫øË∞±ÊòæÁ§∫ÊéßÂà∂');
                }
            } else {
                console.warn('‚ö†Ô∏è Êú™ÊâæÂà∞toggleÊàñscoreContainerÂÖÉÁ¥†');
                console.log('toggle:', toggle);
                console.log('scoreContainer:', scoreContainer);
            }
        }

        // Ê£ÄÊü•ÂÖÉÁ¥†ÊòØÂê¶ÊòØÂíåÂº¶‰ª£Âè∑ - Âü∫‰∫é‰Ω†ÁöÑÊô∫ËÉΩËØÜÂà´Á≥ªÁªüËÆæËÆ°
        function isChordSymbolElement(element) {
            if (element.tagName !== 'text') return false;

            const content = element.textContent?.trim();
            if (!content) return false;

            // Êô∫ËÉΩÂíåÂº¶‰ª£Âè∑ËØÜÂà´Á≥ªÁªüÔºàÂèÇÁÖß‰Ω†ÁöÑËÆæËÆ°Ôºâ
            const isChordSymbol = (
                content.match(/^[A-G][#b]?/) ||           // Ê†πÈü≥ (A-GÂºÄÂ§¥)
                content.includes('maj') ||                // ÂíåÂº¶Á±ªÂûãÂÖ≥ÈîÆËØç
                content.includes('min') ||
                content.includes('dim') ||
                content.includes('aug') ||
                content.includes('sus') ||
                content.match(/\b[79](sus)?[24]?\b/) ||   // Êï∞Â≠óÂíåÂº¶Ê†áËÆ∞
                content.match(/\b(11|13)\b/) ||
                content.match(/\badd[69]\b/) ||
                content.includes('¬∞') ||                  // ÁâπÊÆäÁ¨¶Âè∑
                content.includes('√∏') ||
                content.includes('+') ||
                content.includes('Œî') ||
                content.includes('/') && content.match(/[A-G].*\/.*[A-G]/) || // ÂàÜÊï∞ÂíåÂº¶
                content.match(/^(maj|min|dim|aug)\d*$/) ||
                content.match(/^[IVX]+[¬∞+]?$/)           // ÁΩóÈ©¨Êï∞Â≠óÂíåÂº¶Ê†áËÆ∞
            );

            // ÊéíÈô§Êú∫Âà∂ÔºàÂèÇÁÖß‰Ω†ÁöÑËÆæËÆ°Ôºâ
            const isNotChordSymbol = (
                content.match(/^\d+$/) ||        // Á∫ØÊï∞Â≠óÔºàÂ∞èËäÇÂè∑Ôºâ
                content.match(/^[pmf]+$/) ||     // ÂäõÂ∫¶ËÆ∞Âè∑
                content.length > 10 ||           // ËøáÈïøÊñáÊú¨
                content.includes('measure') ||   // Â∞èËäÇÁõ∏ÂÖ≥
                content.includes('staff') ||     // Ë∞±Á∫øÁõ∏ÂÖ≥
                content.includes('key') ||       // Ë∞ÉÂè∑Áõ∏ÂÖ≥
                content.includes('time')         // ÊãçÂè∑Áõ∏ÂÖ≥
            );

            return isChordSymbol && !isNotChordSymbol;
        }

        // üåç ÂÖ®Â±ÄÁä∂ÊÄÅËÆ∞ÂΩï - Áî®‰∫éÈò≤Èó™ÁÉÅÂíåÊåÅ‰πÖÂåñÈöêËóè
        window.displaySettings = {
            staffVisible: true,     // ÈªòËÆ§ÊòæÁ§∫‰∫îÁ∫øË∞±
            chordSymbolsVisible: true,  // ÈªòËÆ§ÊòæÁ§∫ÂíåÂº¶‰ª£Âè∑

            // Êõ¥Êñ∞Áä∂ÊÄÅÁöÑÊñπÊ≥ï
            updateStaffState: function(visible) {
                this.staffVisible = visible;
                console.log(`üåç ÂÖ®Â±ÄÁä∂ÊÄÅÊõ¥Êñ∞: ‰∫îÁ∫øË∞±=${visible ? 'ÊòæÁ§∫' : 'ÈöêËóè'}`);
            },
            updateChordState: function(visible) {
                this.chordSymbolsVisible = visible;
                console.log(`üåç ÂÖ®Â±ÄÁä∂ÊÄÅÊõ¥Êñ∞: ÂíåÂº¶‰ª£Âè∑=${visible ? 'ÊòæÁ§∫' : 'ÈöêËóè'}`);
            }
        };

        // Â∞ÜÂáΩÊï∞Ê∑ªÂä†Âà∞ÂÖ®Â±ÄwindowÂØπË±°Ôºå‰æø‰∫éÂÖ∂‰ªñÊ®°ÂùóË∞ÉÁî®
        window.applyStaffDisplayState = applyStaffDisplayState;
        window.applyChordSymbolsState = applyChordSymbolsState;
        window.isChordSymbolElement = isChordSymbolElement;

        // üß™ ÊâãÂä®ÊµãËØïÂáΩÊï∞ - Áî®Êà∑ÂèØ‰ª•Âú®ÊéßÂà∂Âè∞‰∏≠Áõ¥Êé•Ë∞ÉÁî®
        window.testStaffToggle = function() {
            console.log('üß™ ÊâãÂä®ÊµãËØï‰∫îÁ∫øË∞±ÂºÄÂÖ≥');
            const toggle = document.getElementById('staffDisplayToggle');
            const svg = document.querySelector('#score svg'); // ‰øÆÂ§çÔºöÊ≠£Á°ÆÁöÑÂÆπÂô®ID
            console.log('ÂºÄÂÖ≥ÂÖÉÁ¥†:', toggle);
            console.log('SVGÂÖÉÁ¥†:', svg);
            console.log('ÂºÄÂÖ≥Áä∂ÊÄÅ:', toggle ? toggle.checked : 'null');
            if (toggle && svg) {
                applyStaffDisplayState();
            } else {
                console.error('‚ùå ÊµãËØïÂ§±Ë¥•ÔºöÊâæ‰∏çÂà∞ÂøÖË¶ÅÂÖÉÁ¥†');
            }
        };

        window.testChordToggle = function() {
            console.log('üß™ ÊâãÂä®ÊµãËØïÂíåÂº¶‰ª£Âè∑ÂºÄÂÖ≥');
            const toggle = document.getElementById('chordSymbolsToggle');
            const svg = document.querySelector('#score svg'); // ‰øÆÂ§çÔºöÊ≠£Á°ÆÁöÑÂÆπÂô®ID
            console.log('ÂºÄÂÖ≥ÂÖÉÁ¥†:', toggle);
            console.log('SVGÂÖÉÁ¥†:', svg);
            console.log('ÂºÄÂÖ≥Áä∂ÊÄÅ:', toggle ? toggle.checked : 'null');
            if (toggle && svg) {
                applyChordSymbolsState();
            } else {
                console.error('‚ùå ÊµãËØïÂ§±Ë¥•ÔºöÊâæ‰∏çÂà∞ÂøÖË¶ÅÂÖÉÁ¥†');
            }
        };

        // üéº ÂíåÂº¶‰ª£Âè∑ÊòæÁ§∫/ÈöêËóèÊéßÂà∂
        function toggleChordSymbols() {
            applyChordSymbolsState();
        }

        // Â∫îÁî®ÂíåÂº¶‰ª£Âè∑ÊòæÁ§∫Áä∂ÊÄÅ - ÁÆÄÂåñÊµãËØïÊñπÊ≥ï
        function applyChordSymbolsState() {
            // üîß ‰øÆÂ§ç (2025-10-01): ‰ΩøÁî®querySelectorËé∑ÂèñÁ¨¨‰∏Ä‰∏™toggleÔºàÊîØÊåÅÂ§ö‰∏™toggleÔºâ
            const toggle = document.querySelector('input[id="chordSymbolsToggle"]');
            const scoreContainer = document.getElementById('score'); // ‰øÆÂ§çÔºöÊ≠£Á°ÆÁöÑIDÊòØ'score'

            if (toggle && scoreContainer) {
                const svg = scoreContainer.querySelector('svg');
                if (svg) {
                    console.log(`üéµ Â∫îÁî®ÂíåÂº¶‰ª£Âè∑ÊòæÁ§∫Áä∂ÊÄÅ: ${toggle.checked ? 'ÊòæÁ§∫' : 'ÈöêËóè'}`);

                    // Êô∫ËÉΩËØÜÂà´ÂíåÂº¶‰ª£Âè∑ÊñáÊú¨ÔºåÊéíÈô§Â∞èËäÇÊï∞
                    const allTextElements = svg.querySelectorAll('text, .vf-text');
                    let chordCount = 0;
                    let measureCount = 0;
                    let debugInfo = [];

                    allTextElements.forEach((text, index) => {
                        const content = text.textContent?.trim();
                        // ‰øÆÂ§çÔºöÊ≠£Á°ÆËé∑ÂèñSVGÂÖÉÁ¥†ÁöÑclassÂ±ûÊÄß
                        const className = (text.className && text.className.baseVal) || text.getAttribute('class') || '';

                        // Ê£ÄÊü•ÊòØÂê¶ÊòØÂ∞èËäÇÂè∑ÔºàÁ∫ØÊï∞Â≠óÔºâ
                        const isMeasureNumber = content.match(/^\d+$/);

                        if (isMeasureNumber) {
                            // ‰øùÁïôÂ∞èËäÇÂè∑Ôºå‰∏çÈöêËóè
                            measureCount++;
                            debugInfo.push(`${index+1}: "${content}" [Â∞èËäÇÂè∑-‰øùÁïô]`);
                        } else if (isChordSymbolElement(text) || (className && className.includes && className.includes('vf-text'))) {
                            // Â§ÑÁêÜÂíåÂº¶‰ª£Âè∑
                            chordCount++;
                            debugInfo.push(`${index+1}: "${content}" [ÂíåÂº¶‰ª£Âè∑-Â§ÑÁêÜ] (class: "${className}")`);

                            if (toggle.checked) {
                                text.style.display = '';
                                text.style.visibility = 'visible';
                                text.style.opacity = '1';
                            } else {
                                text.style.display = 'none';
                                text.style.visibility = 'hidden';
                                text.style.opacity = '0';
                            }
                        } else {
                            // ÂÖ∂‰ªñÊñáÊú¨ÂÖÉÁ¥†Ôºå‰øùÁïô‰∏çÂ§ÑÁêÜ
                            debugInfo.push(`${index+1}: "${content}" [ÂÖ∂‰ªñÊñáÊú¨-‰øùÁïô] (class: "${className}")`);
                        }
                    });

                    console.log(`üéµ ‚úÖ Â§ÑÁêÜ‰∫Ü${chordCount}‰∏™ÂíåÂº¶‰ª£Âè∑Ôºå‰øùÁïô‰∫Ü${measureCount}‰∏™Â∞èËäÇÂè∑`);
                    console.log(`üéµ üìã ËØ¶ÁªÜ‰ø°ÊÅØ:`, debugInfo.slice(0, 10)); // Âè™ÊòæÁ§∫Ââç10‰∏™ÈÅøÂÖçÊó•ÂøóËøáÈïø

                    if (chordCount === 0) {
                        console.log(`üéµ ‚ö†Ô∏è Êú™ÊâæÂà∞ÂíåÂº¶‰ª£Âè∑ÔºåÊÄªÂÖ±Êúâ${allTextElements.length}‰∏™ÊñáÊú¨ÂÖÉÁ¥†`);
                    }
                } else {
                    console.warn('‚ö†Ô∏è Êú™ÊâæÂà∞SVGÂÖÉÁ¥†ÔºåÊó†Ê≥ïÂ∫îÁî®ÂíåÂº¶‰ª£Âè∑ÊòæÁ§∫ÊéßÂà∂');
                }
            } else {
                console.warn('‚ö†Ô∏è Êú™ÊâæÂà∞toggleÊàñscoreContainerÂÖÉÁ¥†');
                console.log('toggle:', toggle);
                console.log('scoreContainer:', scoreContainer);
            }
        }

        // ÂàùÂßãÂåñÂäüËÉΩÂíåÂ£∞ÂºÄÂÖ≥
        function initializeFunctionalHarmonyToggle(retryCount = 0) {
            const maxRetries = 50; // ÊúÄÂ§öÈáçËØï50Ê¨°Ôºà5ÁßíÔºâ

            // Ê£ÄÊü•chordSettingsÊòØÂê¶Â∑≤ÂÆö‰πâ
            if (typeof chordSettings === 'undefined') {
                if (retryCount < maxRetries) {
                    console.warn(`‚ö†Ô∏è chordSettingsÊú™ÂÆö‰πâÔºåÂª∂ËøüÂàùÂßãÂåñÂäüËÉΩÂíåÂ£∞ÂºÄÂÖ≥ (${retryCount + 1}/${maxRetries})`);
                    setTimeout(() => initializeFunctionalHarmonyToggle(retryCount + 1), 100);
                } else {
                    console.error('‚ùå ÂäüËÉΩÂíåÂ£∞ÂºÄÂÖ≥ÂàùÂßãÂåñÂ§±Ë¥•ÔºöchordSettingsÂú®5ÁßíÂÜÖÊú™ÂÆö‰πâÔºåÂÅúÊ≠¢ÈáçËØï');
                }
                return;
            }

            const toggle = document.getElementById('functionalHarmonyToggle');
            const label = document.getElementById('harmonyModeLabel');

            // ËÆæÁΩÆÂàùÂßãÁä∂ÊÄÅ - ÈªòËÆ§ÂêØÁî®ÂäüËÉΩÂíåÂ£∞Ê®°Âºè
            chordSettings.useFunctionalHarmony = chordSettings.useFunctionalHarmony !== undefined ? chordSettings.useFunctionalHarmony : true;
            toggle.checked = chordSettings.useFunctionalHarmony;

            // ÂàùÂßãÂåñÊòæÁ§∫Áä∂ÊÄÅ
            const slider = toggle.nextElementSibling;
            const sliderButton = slider ? slider.querySelector('.slider-button') : null;

            if (chordSettings.useFunctionalHarmony) {
                label.textContent = translate('controls.functionalMode');
                if (slider) slider.style.backgroundColor = '#FF9500';
                if (sliderButton) sliderButton.style.transform = 'translateX(26px)';
            } else {
                label.textContent = translate('controls.randomMode');
                if (slider) slider.style.backgroundColor = '#ccc';
                if (sliderButton) sliderButton.style.transform = 'translateX(0px)';
            }

            // ÂàùÂßãÂåñÊó∂Â∫îÁî®ÂΩìÂâçÁä∂ÊÄÅÁöÑUIËÆæÁΩÆ
            toggleFunctionalHarmony();

            console.log('üéØ ÂäüËÉΩÂíåÂ£∞ÂºÄÂÖ≥Â∑≤ÂàùÂßãÂåñÔºåÈªòËÆ§Áä∂ÊÄÅÔºö', chordSettings.useFunctionalHarmony ? 'ÂäüËÉΩÂíåÂ£∞Ê®°Âºè' : 'ÂÆåÂÖ®ÈöèÊú∫Ê®°Âºè');
        }

        // ÂàùÂßãÂåñ‰πêÂô®Ê®°ÂºèÂºÄÂÖ≥
        function initializeInstrumentModeToggle(retryCount = 0, forceReset = false) {
            const maxRetries = 50; // ÊúÄÂ§öÈáçËØï50Ê¨°Ôºà5ÁßíÔºâ

            // Ê£ÄÊü•chordSettingsÊòØÂê¶Â∑≤ÂÆö‰πâ
            if (typeof chordSettings === 'undefined') {
                if (retryCount < maxRetries) {
                    console.warn(`‚ö†Ô∏è chordSettingsÊú™ÂÆö‰πâÔºåÂª∂ËøüÂàùÂßãÂåñ‰πêÂô®Ê®°ÂºèÂºÄÂÖ≥ (${retryCount + 1}/${maxRetries})`);
                    setTimeout(() => initializeInstrumentModeToggle(retryCount + 1, forceReset), 100);
                } else {
                    console.error('‚ùå ‰πêÂô®Ê®°ÂºèÂºÄÂÖ≥ÂàùÂßãÂåñÂ§±Ë¥•ÔºöchordSettingsÂú®5ÁßíÂÜÖÊú™ÂÆö‰πâÔºåÂÅúÊ≠¢ÈáçËØï');
                }
                return;
            }

            const toggle = document.getElementById('instrumentModeToggle');
            const label = document.getElementById('instrumentModeLabel');
            const slider = toggle.nextElementSibling;
            const sliderButton = slider.querySelector('.slider-button');
            const clefControlGroup = document.getElementById('clefControlGroup');

            // üéØ Êô∫ËÉΩÂàùÂßãÂåñÔºöÂè™Âú®È¶ñÊ¨°ÂàùÂßãÂåñÊàñÂº∫Âà∂ÈáçÁΩÆÊó∂ËÆæÁΩÆÈªòËÆ§Áä∂ÊÄÅ
            const currentState = toggle.checked;
            const isFirstInit = (currentState === null || currentState === undefined || retryCount === 0);

            if (forceReset || isFirstInit) {
                // È¶ñÊ¨°ÂàùÂßãÂåñÊàñÂº∫Âà∂ÈáçÁΩÆÔºöËÆæÁΩÆ‰∏∫ÈªòËÆ§Áä∂ÊÄÅÔºàÂêâ‰ªñÊ®°ÂºèÔºâ
                toggle.checked = false;
                label.textContent = 'Âêâ‰ªñÂíåÂ£∞';
                slider.style.backgroundColor = '#ccc';
                if (sliderButton) {
                    sliderButton.style.transform = 'translateX(0px)';
                }
                console.log('üéØ ‰πêÂô®Ê®°ÂºèÂºÄÂÖ≥ÂàùÂßãÂåñ‰∏∫ÈªòËÆ§Áä∂ÊÄÅÔºàÂêâ‰ªñÊ®°ÂºèÔºâ');
            } else {
                // Â∑≤ÊúâÁä∂ÊÄÅÔºö‰øùÊåÅÁé∞ÊúâÁä∂ÊÄÅ
                console.log(`üõ°Ô∏è ‰πêÂô®Ê®°ÂºèÂºÄÂÖ≥‰øùÊåÅÁé∞ÊúâÁä∂ÊÄÅ: ${toggle.checked ? 'Èí¢Áê¥Ê®°Âºè' : 'Âêâ‰ªñÊ®°Âºè'}`);
                // Á°Æ‰øùUI‰∏éÁä∂ÊÄÅÂêåÊ≠•
                if (toggle.checked) {
                    label.textContent = 'Èí¢Áê¥ÂíåÂ£∞';
                    // üîß ‰øÆÂ§ç (2025-10-01): Êîπ‰∏∫Ê©ôËâ≤ #FF9500
                    slider.style.backgroundColor = '#FF9500';
                    if (sliderButton) {
                        sliderButton.style.transform = 'translateX(26px)';
                    }
                } else {
                    label.textContent = 'Âêâ‰ªñÂíåÂ£∞';
                    slider.style.backgroundColor = '#ccc';
                    if (sliderButton) {
                        sliderButton.style.transform = 'translateX(0px)';
                    }
                }
            }

            // üé∏ Âêâ‰ªñÊ®°ÂºèÔºöÈöêËóèË∞±Âè∑ÈÄâÊã©Êéß‰ª∂Ôºà‰ªÖÈí¢Áê¥Ê®°ÂºèÈúÄË¶ÅÔºâ
            if (clefControlGroup) {
                clefControlGroup.style.visibility = 'hidden';
                clefControlGroup.style.height = '0';
                clefControlGroup.style.overflow = 'hidden';
                clefControlGroup.style.margin = '0';
                clefControlGroup.style.padding = '0';
            }

            console.log('üéØ ‰πêÂô®Ê®°ÂºèÂºÄÂÖ≥Â∑≤ÂàùÂßãÂåñÔºàÂêâ‰ªñÊ®°ÂºèÔºâ - Ë∞±Âè∑ÈÄâÊã©Â∑≤ÈöêËóè');
        }

        // ÁõëÂê¨BPMËæìÂÖ•ÂèòÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            const bpmInput = document.getElementById('headerMetronomeBpm');
            if (bpmInput) {
                bpmInput.addEventListener('change', updateMetronomeTempo);
                bpmInput.addEventListener('input', updateMetronomeTempo);
            }

            // ÁõëÂê¨‰∏¥Êó∂ËÆ∞Âè∑ÊªëÂùóÂèòÂåñ
            const accidentalSlider = document.getElementById('accidentalRate');
            const accidentalValue = document.getElementById('accidentalRateValue');

            if (accidentalSlider && accidentalValue) {
                accidentalSlider.addEventListener('input', function() {
                    accidentalValue.textContent = this.value + '%';
                });
            }

            // üéº ÂàùÂßãÂåñ‰∫îÁ∫øË∞±ÊòæÁ§∫/ÈöêËóèÂºÄÂÖ≥ - ‰øÆÂ§çÔºöÊîØÊåÅÂ§ö‰∏™toggleÔºàÂêâ‰ªñ+Èí¢Áê¥Ê®°ÂºèÔºâ
            // üîß ‰øÆÂ§ç (2025-10-01): ‰ΩøÁî®querySelectorAllÈÄâÊã©ÊâÄÊúâID‰∏∫staffDisplayToggleÁöÑÂÖÉÁ¥†
            // ÂéüÂõ†ÔºöÂêâ‰ªñÊ®°ÂºèÂíåÈí¢Áê¥Ê®°ÂºèÂêÑÊúâ‰∏ÄÁªÑtoggleÔºåÈúÄË¶Å‰∏∫ÂÆÉ‰ª¨ÈÉΩÁªëÂÆö‰∫ã‰ª∂
            const staffDisplayToggles = document.querySelectorAll('input[id="staffDisplayToggle"]');
            if (staffDisplayToggles.length > 0) {
                console.log(`üîç ÊâæÂà∞${staffDisplayToggles.length}‰∏™‰∫îÁ∫øË∞±ÂºÄÂÖ≥ÂÖÉÁ¥†`);
                staffDisplayToggles.forEach((toggle, index) => {
                    toggle.addEventListener('change', function() {
                        console.log(`üéº ‰∫îÁ∫øË∞±ÂºÄÂÖ≥${index + 1}ÂèòÂåñ: ${this.checked ? 'ÊòæÁ§∫' : 'ÈöêËóè'}`);
                        console.log('üîç Á´ãÂç≥Ë∞ÉÁî® applyStaffDisplayState()');

                        // Êõ¥Êñ∞ÂÖ®Â±ÄÁä∂ÊÄÅ
                        window.displaySettings.updateStaffState(this.checked);

                        // ÂêåÊ≠•ÊâÄÊúâtoggleÁöÑÁä∂ÊÄÅ
                        staffDisplayToggles.forEach(t => {
                            if (t !== this) t.checked = this.checked;
                        });

                        applyStaffDisplayState();
                    });
                    console.log(`‚úÖ ‰∫îÁ∫øË∞±ÂºÄÂÖ≥${index + 1}‰∫ã‰ª∂ÁõëÂê¨Âô®Â∑≤ÁªëÂÆö`);
                });

                // Á´ãÂç≥ÊµãËØïÂΩìÂâçÁä∂ÊÄÅÂπ∂ÂàùÂßãÂåñÂÖ®Â±ÄÁä∂ÊÄÅÔºà‰ΩøÁî®Á¨¨‰∏Ä‰∏™toggleÁöÑÁä∂ÊÄÅÔºâ
                console.log('üîç ÂΩìÂâç‰∫îÁ∫øË∞±ÂºÄÂÖ≥Áä∂ÊÄÅ:', staffDisplayToggles[0].checked);
                window.displaySettings.updateStaffState(staffDisplayToggles[0].checked);
            } else {
                console.error('‚ùå Êú™ÊâæÂà∞‰∫îÁ∫øË∞±ÂºÄÂÖ≥ÂÖÉÁ¥† staffDisplayToggle');
            }

            // üéµ ÂàùÂßãÂåñÂíåÂº¶‰ª£Âè∑ÊòæÁ§∫/ÈöêËóèÂºÄÂÖ≥ - ‰øÆÂ§çÔºöÊîØÊåÅÂ§ö‰∏™toggleÔºàÂêâ‰ªñ+Èí¢Áê¥Ê®°ÂºèÔºâ
            // üîß ‰øÆÂ§ç (2025-10-01): ‰ΩøÁî®querySelectorAllÈÄâÊã©ÊâÄÊúâID‰∏∫chordSymbolsToggleÁöÑÂÖÉÁ¥†
            const chordSymbolsToggles = document.querySelectorAll('input[id="chordSymbolsToggle"]');
            if (chordSymbolsToggles.length > 0) {
                console.log(`üîç ÊâæÂà∞${chordSymbolsToggles.length}‰∏™ÂíåÂº¶‰ª£Âè∑ÂºÄÂÖ≥ÂÖÉÁ¥†`);
                chordSymbolsToggles.forEach((toggle, index) => {
                    toggle.addEventListener('change', function() {
                        console.log(`üéµ ÂíåÂº¶‰ª£Âè∑ÂºÄÂÖ≥${index + 1}ÂèòÂåñ: ${this.checked ? 'ÊòæÁ§∫' : 'ÈöêËóè'}`);
                        console.log('üîç Á´ãÂç≥Ë∞ÉÁî® applyChordSymbolsState()');

                        // Êõ¥Êñ∞ÂÖ®Â±ÄÁä∂ÊÄÅ
                        window.displaySettings.updateChordState(this.checked);

                        // ÂêåÊ≠•ÊâÄÊúâtoggleÁöÑÁä∂ÊÄÅ
                        chordSymbolsToggles.forEach(t => {
                            if (t !== this) t.checked = this.checked;
                        });

                        applyChordSymbolsState();
                    });
                    console.log(`‚úÖ ÂíåÂº¶‰ª£Âè∑ÂºÄÂÖ≥${index + 1}‰∫ã‰ª∂ÁõëÂê¨Âô®Â∑≤ÁªëÂÆö`);
                });

                // Á´ãÂç≥ÊµãËØïÂΩìÂâçÁä∂ÊÄÅÂπ∂ÂàùÂßãÂåñÂÖ®Â±ÄÁä∂ÊÄÅÔºà‰ΩøÁî®Á¨¨‰∏Ä‰∏™toggleÁöÑÁä∂ÊÄÅÔºâ
                console.log('üîç ÂΩìÂâçÂíåÂº¶‰ª£Âè∑ÂºÄÂÖ≥Áä∂ÊÄÅ:', chordSymbolsToggles[0].checked);
                window.displaySettings.updateChordState(chordSymbolsToggles[0].checked);
            } else {
                console.error('‚ùå Êú™ÊâæÂà∞ÂíåÂº¶‰ª£Âè∑ÂºÄÂÖ≥ÂÖÉÁ¥† chordSymbolsToggle');
            }

            // ÊîπËøõÁöÑÊ®°ÂùóÂä†ËΩΩÂíåÂàùÂßãÂåñÁ≠ñÁï•
            function initializeSystem() {
                console.log('üîÑ ÂºÄÂßãHTMLÁ≥ªÁªüÂàùÂßãÂåñÊ£ÄÊü•...');

                // Ê£ÄÊü•ÂÖ≥ÈîÆÁ±ªÊòØÂê¶ÂèØÁî®
                const requiredClasses = ['HarmonyTheory', 'ChordProgressionGenerator'];
                const missingClasses = requiredClasses.filter(className => typeof window[className] === 'undefined');

                if (missingClasses.length > 0) {
                    console.warn('‚ö†Ô∏è Á≠âÂæÖÊ®°ÂùóÂä†ËΩΩ:', missingClasses.join(', '));
                    return false;
                }

                try {
                    // Ê£ÄÊü•JSÊ®°ÂùóÊòØÂê¶Â∑≤ÁªèÂÆåÊàêÂàùÂßãÂåñ
                    const jsInitialized = (
                        typeof window.harmonyTheory !== 'undefined' &&
                        window.harmonyTheory !== null &&
                        typeof window.chordProgressionGenerator !== 'undefined' &&
                        window.chordProgressionGenerator !== null
                    );

                    if (jsInitialized) {
                        console.log('‚úÖ Ê£ÄÊµãÂà∞JSÊ®°ÂùóÂ∑≤ÂàùÂßãÂåñÔºåË∑≥ËøáÈáçÂ§çÂàùÂßãÂåñ');
                    } else {
                        console.log('üîß JSÊ®°ÂùóÊú™ÂÆåÊï¥ÂàùÂßãÂåñÔºåËøõË°åHTMLË°•ÂÖÖÂàùÂßãÂåñ');

                        // Á°Æ‰øùchordSettingsÂ≠òÂú®
                        if (typeof chordSettings === 'undefined' || !chordSettings) {
                            window.chordSettings = {
                                chordTypes: ['major', 'minor'],
                                keys: ['C-major', 'a-minor'],
                                timeSignatures: ['4/4'],
                                clefs: ['treble'],
                                rhythms: ['half', 'quarter'],
                                includeTriadInversions: false,
                                includeSeventhInversions: false,
                                complexity: 'medium',
                                voicingTypes: ['close'],
                                useFunctionalHarmony: true  // üîß ‰øÆÂ§çÔºöÈªòËÆ§‰∏∫ÂäüËÉΩÂíåÂ£∞Ê®°ÂºèÔºåËÄåÈùûÈöèÊú∫Ê®°Âºè
                            };
                            console.log('‚úÖ chordSettingsÂ∑≤ÂàùÂßãÂåñÔºàÈªòËÆ§ÂäüËÉΩÂíåÂ£∞Ê®°ÂºèÔºâ');
                        } else {
                            // üîß Â¶ÇÊûúchordSettingsÂ∑≤Â≠òÂú®ÔºåÂè™Â°´ÂÖÖÁº∫Â§±ÁöÑÂ±ûÊÄßÔºå‰∏çË¶ÜÁõñÂ∑≤ÊúâËÆæÁΩÆ
                            const defaults = {
                                chordTypes: ['major', 'minor'],
                                keys: ['C-major', 'a-minor'],
                                timeSignatures: ['4/4'],
                                clefs: ['treble'],
                                rhythms: ['half', 'quarter'],
                                includeTriadInversions: false,
                                includeSeventhInversions: false,
                                complexity: 'medium',
                                voicingTypes: ['close'],
                                useFunctionalHarmony: true
                            };
                            Object.keys(defaults).forEach(key => {
                                if (window.chordSettings[key] === undefined) {
                                    window.chordSettings[key] = defaults[key];
                                }
                            });
                            console.log('‚úÖ chordSettingsÂ∑≤Ë°•ÂÖ®Áº∫Â§±Â±ûÊÄßÔºà‰øùÁïôÁé∞ÊúâËÆæÁΩÆÔºâ');
                        }

                        // üéπ ÂàùÂßãÂåñÈí¢Áê¥‰∏ìÁî®ËÆæÁΩÆÂØπË±°
                        if (typeof pianoSettings === 'undefined' || !pianoSettings) {
                            window.pianoSettings = {
                                // Èü≥Êï∞ÈÄâÊã©Ôºà2-9‰∏™Èü≥Á¨¶Ôºâ
                                enabledNoteCounts: [4],  // ÈªòËÆ§ÈÄâ‰∏≠4Èü≥

                                // ‰ΩéÈü≥Ë∞±Âè∑Èü≥ÂüüËÆæÁΩÆÔºàÈªòËÆ§E2-E4Ôºâ
                                bassClefRangeMin: 40,  // E2 (MIDI 40)
                                bassClefRangeMax: 64,  // E4 (MIDI 64)

                                // È´òÈü≥Ë∞±Âè∑Èü≥ÂüüËÆæÁΩÆÔºàÈªòËÆ§C4-E6Ôºâ
                                trebleClefRangeMin: 60,  // C4 (MIDI 60)
                                trebleClefRangeMax: 88,  // E6 (MIDI 88)

                                // Èü≥Á¨¶ÂàÜÈÖçËßÑÂàô
                                noteDistribution: {
                                    // ‰ΩéÈü≥Ë∞±Âè∑ÔºöÊúÄ‰ΩéÈü≥ÊÄªÊòØÊ†πÈü≥
                                    bassClefAlwaysRoot: true,

                                    // È´òÈü≥Ë∞±Âè∑ÔºöÂâ©‰ΩôÈü≥Á¨¶ÔºàÊúÄÂ∞ë2‰∏™Ôºâ
                                    trebleClefMinNotes: 2,

                                    // Èü≥Á¨¶‰ºòÂÖàÁ∫ßÁ≥ªÁªü
                                    priorityNotes: ['third', 'seventh', 'sus', 'tension'],  // ‰ºòÂÖàÈü≥
                                    optionalNotes: ['fifth'],  // ÂèØÈÄâÈü≥
                                    duplicableNotes: ['root', 'fifth'],  // ÂèØÈáçÂ§çÈü≥

                                    // ‰ºòÂÖàÈü≥‰∏çÂº∫Âà∂ÂøÖÈ°ªÂåÖÂê´
                                    priorityNotesRequired: false
                                },

                                // Èü≥Á¨¶ÈöèÊú∫ÊéíÂàóÔºàÈ´òÈü≥Ë∞±Âè∑ÂÜÖÔºâ
                                randomArrangement: true,

                                // Èü≥Á¨¶ÊãºÂÜôËßÑÂàôÔºàÁªßÊâøË∞ÉÊÄßÔºâ
                                inheritKeySignatureSpelling: true
                            };
                            console.log('‚úÖ pianoSettingsÂ∑≤ÂàùÂßãÂåñÔºàÈí¢Áê¥‰∏ìÁî®ËÆæÁΩÆÂØπË±°Ôºâ');

                            // üéØ ÂêåÊ≠•UI checkboxÁä∂ÊÄÅÔºàÁ°Æ‰øù4Èü≥Ë¢´ÂãæÈÄâÔºâ
                            setTimeout(() => {
                                const enabledCounts = window.pianoSettings.enabledNoteCounts || [4];
                                console.log('üéØ ÂêåÊ≠•Èí¢Áê¥Èü≥Êï∞checkboxÁä∂ÊÄÅ:', enabledCounts);

                                // üîß ‰øÆÂ§ç (2025-10-01): Âè™Â§ÑÁêÜ3-7Èü≥
                                // ÂÖàÂèñÊ∂àÊâÄÊúâÂãæÈÄâ
                                for (let i = 3; i <= 7; i++) {
                                    const checkbox = document.getElementById(`notecount-${i}`);
                                    if (checkbox) {
                                        checkbox.checked = false;
                                    }
                                }

                                // ÁÑ∂ÂêéÂãæÈÄâenabledNoteCounts‰∏≠ÁöÑÈü≥Êï∞
                                enabledCounts.forEach(count => {
                                    const checkbox = document.getElementById(`notecount-${count}`);
                                    if (checkbox) {
                                        checkbox.checked = true;
                                        console.log(`  ‚úÖ Â∑≤ÂãæÈÄâ${count}Èü≥`);
                                    }
                                });
                            }, 100);
                        }

                        // Â¶ÇÊûúËøòÊ≤°ÊúâÂàùÂßãÂåñ harmonyTheoryÔºåÂú®ËøôÈáåÂàùÂßãÂåñ
                        if (typeof harmonyTheory === 'undefined' || !harmonyTheory) {
                            window.harmonyTheory = new HarmonyTheory();
                            console.log('‚úÖ harmonyTheoryÂ∑≤ÂàùÂßãÂåñÔºàHTMLË°•ÂÖÖÔºâ');
                        }

                        // ÂàùÂßãÂåñÂ¢ûÂº∫ÂäüËÉΩÂíåÂ£∞Á≥ªÁªüÔºàÂ¶ÇÊûúÂèØÁî®Ôºâ
                        if (typeof EnhancedHarmony !== 'undefined' && (typeof enhancedHarmony === 'undefined' || !enhancedHarmony)) {
                            window.enhancedHarmony = new EnhancedHarmony(window.harmonyTheory || harmonyTheory);
                            console.log('‚úÖ Â¢ûÂº∫ÂäüËÉΩÂíåÂ£∞Á≥ªÁªüÂàùÂßãÂåñÂÆåÊàêÔºàHTMLË°•ÂÖÖÔºâ');
                        }

                        // ÂàùÂßãÂåñÂíåÂº¶ËøõË°åÁîüÊàêÂô®ÔºàÂÖ≥ÈîÆÊ≠•È™§Ôºâ
                        if (typeof ChordProgressionGenerator !== 'undefined' && (typeof chordProgressionGenerator === 'undefined' || !chordProgressionGenerator)) {
                            window.chordProgressionGenerator = new ChordProgressionGenerator(window.harmonyTheory || harmonyTheory);
                            console.log('‚úÖ ÂíåÂº¶ËøõË°åÁîüÊàêÂô®Â∑≤ÂàùÂßãÂåñÔºàHTMLË°•ÂÖÖÔºâ');
                        }
                    }

                    // ÊÄªÊòØÂàùÂßãÂåñUIÂºÄÂÖ≥ÔºàÁ°Æ‰øù chordSettings Â∑≤ÂÆö‰πâÔºâ
                    initializeFunctionalHarmonyToggle();
                    initializeInstrumentModeToggle();

                    // ÊÄªÊòØÂº∫Âà∂ÁªëÂÆöÁîüÊàêÂíåÂº¶ÊåâÈíÆÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
                    bindGenerateButtonEvent();

                    // Á°Æ‰øùÈ°µÈù¢ÁøªËØëÊ≠£Á°ÆÂ∫îÁî®
                    applyTranslations();
                    updateDynamicControlsTranslation(); // ÂàùÂßãÂåñÂä®ÊÄÅÊéß‰ª∂ÁøªËØë
                    console.log('‚úÖ È°µÈù¢ÁøªËØëÂ∑≤ÂàùÂßãÂåñ');

                    // ÂàùÂßãÂåñË∞ÉÂè∑ÊòæÁ§∫Áä∂ÊÄÅ
                    if (window.chordSettings && window.chordSettings.keys) {
                        updateKeySettingsDisplay(window.chordSettings.keys);
                    }

                    return true;
                } catch (error) {
                    console.error('‚ùå Á≥ªÁªüÂàùÂßãÂåñÂ§±Ë¥•:', error);
                    return false;
                }
            }

            // ÁÆÄÂåñÁöÑÊåâÈíÆ‰∫ã‰ª∂ÁªëÂÆö
            function bindGenerateButtonEvent() {
                const generateBtn = document.getElementById('generateChordsBtn');
                if (!generateBtn) {
                    console.error('‚ùå ÁîüÊàêÂíåÂº¶ÊåâÈíÆ‰∏çÂ≠òÂú®');
                    return false;
                }

                console.log('üîç ÂºÄÂßãÁªëÂÆöÁîüÊàêÂíåÂº¶ÊåâÈíÆ‰∫ã‰ª∂...');

                // ÁßªÈô§ÂèØËÉΩÂ∑≤Â≠òÂú®ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
                const newBtn = generateBtn.cloneNode(true);
                generateBtn.parentNode.replaceChild(newBtn, generateBtn);

                // ÈáçÊñ∞Ëé∑ÂèñÊåâÈíÆÂºïÁî®
                const btn = document.getElementById('generateChordsBtn');

                // Áõ¥Êé•ÁªëÂÆöÁÇπÂáª‰∫ã‰ª∂ÔºåÂú®‰∫ã‰ª∂ÂÜÖÈÉ®Ê£ÄÊü•ÂáΩÊï∞ÂèØÁî®ÊÄß
                btn.addEventListener('click', function(event) {
                    console.log('üéØ ÁîüÊàêÂíåÂº¶ÊåâÈíÆË¢´ÁÇπÂáª');
                    event.preventDefault();
                    event.stopPropagation();

                    try {
                        // üéπ Ê£ÄÊµãÈí¢Áê¥Ê®°Âºè
                        const instrumentToggle = document.getElementById('instrumentModeToggle');
                        const isPianoMode = instrumentToggle && instrumentToggle.checked;

                        if (isPianoMode) {
                            // üéπ Èí¢Áê¥Ê®°ÂºèÔºö‰ΩøÁî®PianoNoteCountEngine
                            console.log('üéπ Èí¢Áê¥Ê®°ÂºèÔºö‰ΩøÁî®Èü≥Êï∞ÁîüÊàêÂºïÊìé');

                            if (typeof window.generatePianoChords === 'function') {
                                window.generatePianoChords();
                                console.log('‚úÖ Èí¢Áê¥ÂíåÂº¶ÁîüÊàêÂÆåÊàê');
                            } else {
                                console.error('‚ùå generatePianoChords ÂáΩÊï∞‰∏çÂèØÁî®');
                                alert('Èí¢Áê¥ÁîüÊàêÂô®Êú™Âä†ËΩΩÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
                            }
                            return;
                        }

                        // üé∏ Âêâ‰ªñÊ®°ÂºèÔºö‰ΩøÁî®‰º†ÁªüVoicingEngine
                        // Âú®ÁÇπÂáªÊó∂Ê£ÄÊü•ÂáΩÊï∞ÊòØÂê¶ÂèØÁî®
                        if (typeof generateChords === 'function') {
                            console.log('üé∏ Ë∞ÉÁî® generateChords ÂáΩÊï∞');
                            generateChords();
                            console.log('‚úÖ generateChords ÂáΩÊï∞Ë∞ÉÁî®ÂÆåÊàê');
                        } else if (typeof window.generateChords === 'function') {
                            console.log('üé∏ Ë∞ÉÁî® window.generateChords ÂáΩÊï∞');
                            window.generateChords();
                            console.log('‚úÖ window.generateChords ÂáΩÊï∞Ë∞ÉÁî®ÂÆåÊàê');
                        } else {
                            // Â¶ÇÊûúÂáΩÊï∞‰∏çÂèØÁî®ÔºåÂ∞ùËØïÊâãÂä®Ëß¶ÂèëÂàùÂßãÂåñ
                            console.warn('‚ö†Ô∏è generateChords ÂáΩÊï∞‰∏çÂèØÁî®ÔºåÂ∞ùËØïÊâãÂä®ÂàùÂßãÂåñ');
                            if (typeof initializeMusicTheory === 'function') {
                                initializeMusicTheory();
                                setTimeout(() => {
                                    if (typeof generateChords === 'function') {
                                        generateChords();
                                    } else {
                                        alert('Á≥ªÁªüÂàùÂßãÂåñÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
                                    }
                                }, 500);
                            } else {
                                alert('ÂíåÂº¶ÁîüÊàêÂô®Êú™Ê≠£Á°ÆÂä†ËΩΩÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
                            }
                        }
                    } catch (error) {
                        console.error('‚ùå ÁîüÊàêÂíåÂº¶Êó∂Âá∫Èîô:', error);
                        alert('ÁîüÊàêÂíåÂº¶Êó∂Âá∫Èîô: ' + error.message);
                    }
                });

                console.log('‚úÖ ÁîüÊàêÂíåÂº¶ÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨Âô®Â∑≤ÁªëÂÆö');
                return true;
            }

            // ÈáçËØïÊú∫Âà∂
            let initRetryCount = 0;
            const maxInitRetries = 20; // ÊúÄÂ§öÈáçËØï20Ê¨°Ôºà2ÁßíÔºâ

            function attemptInitialization() {
                if (initializeSystem()) {
                    console.log('‚úÖ Á≥ªÁªüÂàùÂßãÂåñÊàêÂäü');
                    return;
                }

                initRetryCount++;
                if (initRetryCount < maxInitRetries) {
                    console.log(`üîÑ ÈáçËØïÁ≥ªÁªüÂàùÂßãÂåñ (${initRetryCount}/${maxInitRetries})`);
                    setTimeout(attemptInitialization, 100);
                } else {
                    console.error('‚ùå Á≥ªÁªüÂàùÂßãÂåñÂ§±Ë¥•ÔºåÂ∑≤ËææÂà∞ÊúÄÂ§ßÈáçËØïÊ¨°Êï∞');
                    // Âç≥‰ΩøÂ§±Ë¥•‰πüË¶ÅÁªëÂÆöÊåâÈíÆÔºå‰ª•Èò≤‰∏á‰∏Ä
                    bindGenerateButtonEvent();
                }
            }

            // Á´ãÂç≥ÂºÄÂßãÂàùÂßãÂåñ
            attemptInitialization();

            // üîç Ë∞ÉËØïÁõëÊéßÔºöËøΩË∏™ToggleÁä∂ÊÄÅÂèòÂåñ
            console.log('üîç ÂêØÂä®ToggleÁä∂ÊÄÅÁõëÊéßÁ≥ªÁªü...');

            // ÁõëÊéßinstrumentModeToggleÁä∂ÊÄÅÂèòÂåñ
            const instrumentToggle = document.getElementById('instrumentModeToggle');
            if (instrumentToggle) {
                let lastInstrumentState = instrumentToggle.checked;
                console.log(`üîç ÂàùÂßãinstrumentToggleÁä∂ÊÄÅ: ${lastInstrumentState ? 'Èí¢Áê¥Ê®°Âºè' : 'Âêâ‰ªñÊ®°Âºè'}`);

                setInterval(() => {
                    if (instrumentToggle.checked !== lastInstrumentState) {
                        console.warn(`üîÑ Ê£ÄÊµãÂà∞instrumentToggleÁä∂ÊÄÅÂèòÂåñ: ${lastInstrumentState ? 'Èí¢Áê¥' : 'Âêâ‰ªñ'} ‚Üí ${instrumentToggle.checked ? 'Èí¢Áê¥' : 'Âêâ‰ªñ'}`);
                        console.trace('üìç Áä∂ÊÄÅÂèòÂåñË∞ÉÁî®Ê†à');
                        lastInstrumentState = instrumentToggle.checked;
                    }
                }, 100);
            } else {
                console.error('‚ùå ÁõëÊéßÂ§±Ë¥•: Êú™ÊâæÂà∞instrumentModeToggleÂÖÉÁ¥†');
            }

            // ÁõëÊéßfunctionalHarmonyToggleÁä∂ÊÄÅÂèòÂåñ
            const functionalToggle = document.getElementById('functionalHarmonyToggle');
            if (functionalToggle) {
                let lastFunctionalState = functionalToggle.checked;
                console.log(`üîç ÂàùÂßãfunctionalHarmonyToggleÁä∂ÊÄÅ: ${lastFunctionalState ? 'ÂäüËÉΩÂíåÂ£∞Ê®°Âºè' : 'ÈöèÊú∫Ê®°Âºè'}`);

                setInterval(() => {
                    if (functionalToggle.checked !== lastFunctionalState) {
                        console.warn(`üîÑ Ê£ÄÊµãÂà∞functionalHarmonyToggleÁä∂ÊÄÅÂèòÂåñ: ${lastFunctionalState ? 'ÂäüËÉΩÂíåÂ£∞' : 'ÈöèÊú∫'} ‚Üí ${functionalToggle.checked ? 'ÂäüËÉΩÂíåÂ£∞' : 'ÈöèÊú∫'}`);
                        console.trace('üìç Áä∂ÊÄÅÂèòÂåñË∞ÉÁî®Ê†à');
                        lastFunctionalState = functionalToggle.checked;
                    }
                }, 100);
            } else {
                console.error('‚ùå ÁõëÊéßÂ§±Ë¥•: Êú™ÊâæÂà∞functionalHarmonyToggleÂÖÉÁ¥†');
            }

            console.log('‚úÖ ToggleÁä∂ÊÄÅÁõëÊéßÁ≥ªÁªüÂ∑≤ÂêØÂä®ÔºàÊØè100msÊ£ÄÊü•‰∏ÄÊ¨°Ôºâ');
        });

        // ============ ÂºπÁ™óÁÆ°ÁêÜÂáΩÊï∞ ============

        // ÊâìÂºÄÂíåÂº¶Á±ªÂûãËÆæÁΩÆÂºπÁ™ó


        // ÊâìÂºÄËäÇÂ•èËÆæÁΩÆÂºπÁ™ó
        function openRhythmSettings() {
            const modal = document.getElementById('rhythmModal');
            if (modal) {
                modal.style.display = 'block';
                // Â∫îÁî®ÁøªËØëÂà∞ÂºπÁ™óÂÜÖÂÆπ
                applyTranslations();
                console.log('‚úÖ ËäÇÂ•èËÆæÁΩÆÂºπÁ™óÂ∑≤ÊâìÂºÄÂπ∂Â∫îÁî®ÁøªËØë');
            }
        }

        // ÂÖ≥Èó≠ËäÇÂ•èËÆæÁΩÆÂºπÁ™ó
        function closeRhythmSettings() {
            const modal = document.getElementById('rhythmModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // ÊâìÂºÄË∞ÉÂè∑ËÆæÁΩÆÂºπÁ™ó
        function openKeySignatureSettings() {
            const modal = document.getElementById('keySignatureModal');
            if (modal) {
                modal.style.display = 'block';
                // Âä†ËΩΩÂΩìÂâçË∞ÉÂè∑ËÆæÁΩÆÂà∞UI
                loadCurrentKeySettings();
                // Â∫îÁî®ÁøªËØëÂà∞ÂºπÁ™óÂÜÖÂÆπ
                applyTranslations();
                console.log('‚úÖ Ë∞ÉÂè∑ËÆæÁΩÆÂºπÁ™óÂ∑≤ÊâìÂºÄÂπ∂Â∫îÁî®ÁøªËØë');
            }
        }

        // Âä†ËΩΩÂΩìÂâçË∞ÉÂè∑ËÆæÁΩÆÂà∞UI
        function loadCurrentKeySettings() {
            // È¶ñÂÖàÊ∏ÖÈô§ÊâÄÊúâcheckboxÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
            const allCheckboxes = document.querySelectorAll('#keySignatureModal input[type="checkbox"]');
            allCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });

            // Â¶ÇÊûúÊúâ‰øùÂ≠òÁöÑË∞ÉÂè∑ËÆæÁΩÆÔºåÂàôÈÄâ‰∏≠ÂØπÂ∫îÁöÑcheckbox
            if (window.chordSettings && window.chordSettings.keys) {
                window.chordSettings.keys.forEach(key => {
                    const checkbox = document.querySelector(`#keySignatureModal input[value="${key}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        console.log(`üéØ Â∑≤ÈÄâ‰∏≠Ë∞ÉÂè∑: ${key}`);
                    }
                });
            } else {
                // Â¶ÇÊûúÊ≤°Êúâ‰øùÂ≠òÁöÑËÆæÁΩÆÔºåÈªòËÆ§ÈÄâ‰∏≠CÂ§ßË∞É
                const defaultCheckbox = document.querySelector('#keySignatureModal input[value="C-major"]');
                if (defaultCheckbox) {
                    defaultCheckbox.checked = true;
                    console.log('üéØ ÈªòËÆ§ÈÄâ‰∏≠CÂ§ßË∞É');
                }
            }
        }

        // ÂÖ≥Èó≠Ë∞ÉÂè∑ËÆæÁΩÆÂºπÁ™ó
        function closeKeySignatureSettings() {
            const modal = document.getElementById('keySignatureModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // ‰∏∫‰∫ÜÂÖºÂÆπHTML‰∏≠ÁöÑÂáΩÊï∞Ë∞ÉÁî®ÔºåÊ∑ªÂä†Âà´ÂêçÂáΩÊï∞
        function closeKeySettings() {
            closeKeySignatureSettings();
        }

        // ÊâìÂºÄÊãçÂè∑ËÆæÁΩÆÂºπÁ™ó
        function openTimeSignatureSettings() {
            const modal = document.getElementById('timeSignatureModal');
            if (modal) {
                modal.style.display = 'block';
                // Â∫îÁî®ÁøªËØëÂà∞ÂºπÁ™óÂÜÖÂÆπ
                applyTranslations();
                console.log('‚úÖ ÊãçÂè∑ËÆæÁΩÆÂºπÁ™óÂ∑≤ÊâìÂºÄÂπ∂Â∫îÁî®ÁøªËØë');
            }
        }

        // ÂÖ≥Èó≠ÊãçÂè∑ËÆæÁΩÆÂºπÁ™ó
        function closeTimeSignatureSettings() {
            const modal = document.getElementById('timeSignatureModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // ÊâìÂºÄË∞±Âè∑ËÆæÁΩÆÂºπÁ™ó
        function openClefSettings() {
            const modal = document.getElementById('clefModal');
            if (modal) {
                modal.style.display = 'block';

                // üéº Ê†πÊçÆÂΩìÂâçÊ®°ÂºèË∞ÉÊï¥ÂèØÁî®ÈÄâÈ°π
                const instrumentToggle = document.getElementById('instrumentModeToggle');
                const isPianoMode = instrumentToggle && instrumentToggle.checked;

                // Ëé∑Âèñ‰ΩéÈü≥Ë∞±Âè∑ÈÄâÈ°π
                const bassClefInput = modal.querySelector('input[value="bass"]');
                const bassClefItem = bassClefInput ? bassClefInput.closest('label.checkbox-item') : null;

                if (isPianoMode) {
                    // Èí¢Áê¥Ê®°ÂºèÔºöÈöêËóè‰ΩéÈü≥Ë∞±Âè∑ÈÄâÈ°π
                    if (bassClefItem) {
                        bassClefItem.style.display = 'none';
                        console.log('üéπ Èí¢Áê¥Ê®°ÂºèÔºöÈöêËóè‰ΩéÈü≥Ë∞±Âè∑ÈÄâÈ°πÔºàÂè™ÊòæÁ§∫Â§ßË∞±Ë°®ÂíåÈ´òÈü≥Ë∞±Âè∑Ôºâ');
                    }
                } else {
                    // Âêâ‰ªñÊ®°ÂºèÔºöËøô‰∏™ÂáΩÊï∞Êú¨Êù•Â∞±‰∏çÂ∫îËØ•Ë¢´Ë∞ÉÁî®Ôºå‰ΩÜ‰∏∫‰∫ÜÂÆâÂÖ®Ëµ∑ËßÅ
                    console.log('üé∏ Âêâ‰ªñÊ®°ÂºèÔºöË∞±Âè∑ËÆæÁΩÆ‰∏çÂ∫îËØ•Âú®Âêâ‰ªñÊ®°Âºè‰∏ãÊâìÂºÄ');
                    modal.style.display = 'none';
                    return;
                }

                // Â∫îÁî®ÁøªËØëÂà∞ÂºπÁ™óÂÜÖÂÆπ
                applyTranslations();
                console.log('‚úÖ Ë∞±Âè∑ËÆæÁΩÆÂºπÁ™óÂ∑≤ÊâìÂºÄÂπ∂Â∫îÁî®ÁøªËØë');
            }
        }

        // ÂÖ≥Èó≠Ë∞±Âè∑ËÆæÁΩÆÂºπÁ™ó
        function closeClefSettings() {
            const modal = document.getElementById('clefModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // üéπ ÊâìÂºÄ‰ΩéÈü≥Ë∞±Âè∑Èü≥ÂüüËÆæÁΩÆÂºπÁ™ó
        function openBassClefRangeModal() {
            const modal = document.getElementById('bassClefRangeModal');
            if (modal) {
                // ‰ªéÁ≥ªÁªüËÆæÁΩÆ‰∏≠ËØªÂèñÂΩìÂâçÂÄºÂπ∂ÂêåÊ≠•Âà∞UI
                if (window.pianoSettings) {
                    const minSelect = document.getElementById('bassClefRangeMin');
                    const maxSelect = document.getElementById('bassClefRangeMax');

                    if (minSelect) minSelect.value = window.pianoSettings.bassClefRangeMin || 43;
                    if (maxSelect) maxSelect.value = window.pianoSettings.bassClefRangeMax || 64;

                    console.log(`üéπ Â∑≤ÂêåÊ≠•‰ΩéÈü≥Ë∞±Âè∑Èü≥ÂüüÂà∞UI: ${window.pianoSettings.bassClefRangeMin}-${window.pianoSettings.bassClefRangeMax}`);
                }

                modal.style.display = 'block';
                applyTranslations();
                console.log('üéπ ‰ΩéÈü≥Ë∞±Âè∑Èü≥ÂüüËÆæÁΩÆÂºπÁ™óÂ∑≤ÊâìÂºÄ');
            }
        }

        // üéπ ÂÖ≥Èó≠‰ΩéÈü≥Ë∞±Âè∑Èü≥ÂüüËÆæÁΩÆÂºπÁ™ó
        function closeBassClefRangeModal() {
            const modal = document.getElementById('bassClefRangeModal');
            if (modal) {
                modal.style.display = 'none';
                console.log('üéπ ‰ΩéÈü≥Ë∞±Âè∑Èü≥ÂüüËÆæÁΩÆÂºπÁ™óÂ∑≤ÂÖ≥Èó≠');
            }
        }

        // üéπ ‰øùÂ≠ò‰ΩéÈü≥Ë∞±Âè∑Èü≥ÂüüËÆæÁΩÆ
        function saveBassClefRange() {
            const rangeMin = document.getElementById('bassClefRangeMin').value;
            const rangeMax = document.getElementById('bassClefRangeMax').value;

            // ‰øùÂ≠òÂà∞ÂÖ®Â±ÄËÆæÁΩÆÂØπË±°ÔºàÂ∞ÜÂú®ÂêéÁª≠Èò∂ÊÆµÂÆûÁé∞Ôºâ
            if (!window.pianoSettings) {
                window.pianoSettings = {};
            }
            window.pianoSettings.bassClefRangeMin = parseInt(rangeMin);
            window.pianoSettings.bassClefRangeMax = parseInt(rangeMax);

            // Êõ¥Êñ∞ÊåâÈíÆÊòæÁ§∫
            const midiToNoteName = (midi) => {
                const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                const octave = Math.floor(midi / 12) - 1;
                const noteName = notes[midi % 12];
                return `${noteName}${octave}`;
            };

            const displayText = `(${midiToNoteName(rangeMin)}-${midiToNoteName(rangeMax)})`;
            document.getElementById('bassClefRangeDisplay').textContent = displayText;

            console.log(`üéπ ‰ΩéÈü≥Ë∞±Âè∑Èü≥ÂüüÂ∑≤‰øùÂ≠ò: ${displayText}`);
            closeBassClefRangeModal();
        }

        // üéπ ÊâìÂºÄÈ´òÈü≥Ë∞±Âè∑Èü≥ÂüüËÆæÁΩÆÂºπÁ™ó
        function openTrebleClefRangeModal() {
            const modal = document.getElementById('trebleClefRangeModal');
            if (modal) {
                // ‰ªéÁ≥ªÁªüËÆæÁΩÆ‰∏≠ËØªÂèñÂΩìÂâçÂÄºÂπ∂ÂêåÊ≠•Âà∞UI
                if (window.pianoSettings) {
                    const minSelect = document.getElementById('trebleClefRangeMin');
                    const maxSelect = document.getElementById('trebleClefRangeMax');

                    if (minSelect) minSelect.value = window.pianoSettings.trebleClefRangeMin || 55;
                    if (maxSelect) maxSelect.value = window.pianoSettings.trebleClefRangeMax || 88;

                    console.log(`üéπ Â∑≤ÂêåÊ≠•È´òÈü≥Ë∞±Âè∑Èü≥ÂüüÂà∞UI: ${window.pianoSettings.trebleClefRangeMin}-${window.pianoSettings.trebleClefRangeMax}`);
                }

                modal.style.display = 'block';
                applyTranslations();
                console.log('üéπ È´òÈü≥Ë∞±Âè∑Èü≥ÂüüËÆæÁΩÆÂºπÁ™óÂ∑≤ÊâìÂºÄ');
            }
        }

        // üéπ ÂÖ≥Èó≠È´òÈü≥Ë∞±Âè∑Èü≥ÂüüËÆæÁΩÆÂºπÁ™ó
        function closeTrebleClefRangeModal() {
            const modal = document.getElementById('trebleClefRangeModal');
            if (modal) {
                modal.style.display = 'none';
                console.log('üéπ È´òÈü≥Ë∞±Âè∑Èü≥ÂüüËÆæÁΩÆÂºπÁ™óÂ∑≤ÂÖ≥Èó≠');
            }
        }

        // üéπ ‰øùÂ≠òÈ´òÈü≥Ë∞±Âè∑Èü≥ÂüüËÆæÁΩÆ
        function saveTrebleClefRange() {
            const rangeMin = document.getElementById('trebleClefRangeMin').value;
            const rangeMax = document.getElementById('trebleClefRangeMax').value;

            // ‰øùÂ≠òÂà∞ÂÖ®Â±ÄËÆæÁΩÆÂØπË±°ÔºàÂ∞ÜÂú®ÂêéÁª≠Èò∂ÊÆµÂÆûÁé∞Ôºâ
            if (!window.pianoSettings) {
                window.pianoSettings = {};
            }
            window.pianoSettings.trebleClefRangeMin = parseInt(rangeMin);
            window.pianoSettings.trebleClefRangeMax = parseInt(rangeMax);

            // Êõ¥Êñ∞ÊåâÈíÆÊòæÁ§∫
            const midiToNoteName = (midi) => {
                const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                const octave = Math.floor(midi / 12) - 1;
                const noteName = notes[midi % 12];
                return `${noteName}${octave}`;
            };

            const displayText = `(${midiToNoteName(rangeMin)}-${midiToNoteName(rangeMax)})`;
            document.getElementById('trebleClefRangeDisplay').textContent = displayText;

            console.log(`üéπ È´òÈü≥Ë∞±Âè∑Èü≥ÂüüÂ∑≤‰øùÂ≠ò: ${displayText}`);
            closeTrebleClefRangeModal();
        }

        // üéπ Èí¢Áê¥ËÆæÁΩÆÁÆ°ÁêÜÂáΩÊï∞

        /**
         * ‰ªéUIËØªÂèñÈí¢Áê¥Èü≥Êï∞ÈÄâÊã©
         * @returns {Array<number>} ÈÄâ‰∏≠ÁöÑÈü≥Êï∞Êï∞ÁªÑ
         */
        function getPianoNoteCountsFromUI() {
            const noteCounts = [];
            console.log('üîç ÂºÄÂßãËØªÂèñÈí¢Áê¥Èü≥Êï∞checkboxÁä∂ÊÄÅ:');
            // üîß ‰øÆÂ§ç (2025-10-01): Âè™Â§ÑÁêÜ3-7Èü≥
            for (let i = 3; i <= 7; i++) {
                const checkbox = document.getElementById(`notecount-${i}`);
                if (checkbox) {
                    console.log(`  notecount-${i}: ${checkbox.checked ? '‚úÖ Â∑≤ÂãæÈÄâ' : '‚òê Êú™ÂãæÈÄâ'}`);
                    if (checkbox.checked) {
                        noteCounts.push(i);
                    }
                } else {
                    console.log(`  notecount-${i}: ‚ùå ÂÖÉÁ¥†Êú™ÊâæÂà∞`);
                }
            }
            console.log(`üîç ÊúÄÁªàËØªÂèñÂà∞ÁöÑÈü≥Êï∞: [${noteCounts.join(', ')}]`);
            return noteCounts;
        }

        /**
         * Êõ¥Êñ∞pianoSettings‰ªéUI
         */
        function updatePianoSettingsFromUI() {
            if (!window.pianoSettings) {
                console.warn('‚ö†Ô∏è pianoSettingsÊú™ÂàùÂßãÂåñ');
                return;
            }

            // üîç ËØäÊñ≠ÔºöÊòæÁ§∫Êõ¥Êñ∞ÂâçÁöÑÈü≥Êï∞ËÆæÁΩÆÔºà2025-10-01Ôºâ
            console.log('üîç [updatePianoSettingsFromUI] Êõ¥Êñ∞Ââç window.pianoSettings.enabledNoteCounts:',
                        JSON.stringify(window.pianoSettings.enabledNoteCounts));

            // Êõ¥Êñ∞Èü≥Êï∞ÈÄâÊã©
            const noteCountsFromUI = getPianoNoteCountsFromUI();
            console.log('üîç [updatePianoSettingsFromUI] ‰ªéUIËØªÂèñÁöÑÈü≥Êï∞:', JSON.stringify(noteCountsFromUI));

            window.pianoSettings.enabledNoteCounts = noteCountsFromUI;

            console.log('üîç [updatePianoSettingsFromUI] Êõ¥Êñ∞Âêé window.pianoSettings.enabledNoteCounts:',
                        JSON.stringify(window.pianoSettings.enabledNoteCounts));

            // üéπ ‰ªéUIÊéß‰ª∂ËØªÂèñÈü≥ÂüüËÆæÁΩÆÔºà2025-10-01‰øÆÂ§çÔºâ
            // Á°Æ‰øù‰ΩøÁî®ÊúÄÊñ∞ÁöÑÈü≥ÂüüËÆæÁΩÆÂÄº
            const bassMinSelect = document.getElementById('bassClefRangeMin');
            const bassMaxSelect = document.getElementById('bassClefRangeMax');
            const trebleMinSelect = document.getElementById('trebleClefRangeMin');
            const trebleMaxSelect = document.getElementById('trebleClefRangeMax');

            if (bassMinSelect && bassMinSelect.value) {
                window.pianoSettings.bassClefRangeMin = parseInt(bassMinSelect.value);
            }
            if (bassMaxSelect && bassMaxSelect.value) {
                window.pianoSettings.bassClefRangeMax = parseInt(bassMaxSelect.value);
            }
            if (trebleMinSelect && trebleMinSelect.value) {
                window.pianoSettings.trebleClefRangeMin = parseInt(trebleMinSelect.value);
            }
            if (trebleMaxSelect && trebleMaxSelect.value) {
                window.pianoSettings.trebleClefRangeMax = parseInt(trebleMaxSelect.value);
            }

            console.log('üéπ Èí¢Áê¥ËÆæÁΩÆÂ∑≤Êõ¥Êñ∞:', {
                enabledNoteCounts: window.pianoSettings.enabledNoteCounts,
                bassClefRange: `${window.pianoSettings.bassClefRangeMin}-${window.pianoSettings.bassClefRangeMax}`,
                trebleClefRange: `${window.pianoSettings.trebleClefRangeMin}-${window.pianoSettings.trebleClefRangeMax}`
            });
        }

        /**
         * È™åËØÅÈí¢Áê¥ËÆæÁΩÆÊúâÊïàÊÄß
         * @returns {Object} {valid: boolean, errors: Array<string>}
         */
        function validatePianoSettings() {
            const errors = [];

            if (!window.pianoSettings) {
                errors.push('pianoSettingsÊú™ÂàùÂßãÂåñ');
                return { valid: false, errors };
            }

            // È™åËØÅÈü≥Êï∞ÈÄâÊã©
            if (!window.pianoSettings.enabledNoteCounts || window.pianoSettings.enabledNoteCounts.length === 0) {
                errors.push('Êú™ÈÄâÊã©‰ªª‰ΩïÈü≥Êï∞');
            }

            // È™åËØÅ‰ΩéÈü≥Ë∞±Âè∑Èü≥Âüü
            if (window.pianoSettings.bassClefRangeMin >= window.pianoSettings.bassClefRangeMax) {
                errors.push('‰ΩéÈü≥Ë∞±Âè∑Èü≥ÂüüËåÉÂõ¥Êó†Êïà');
            }

            // È™åËØÅÈ´òÈü≥Ë∞±Âè∑Èü≥Âüü
            if (window.pianoSettings.trebleClefRangeMin >= window.pianoSettings.trebleClefRangeMax) {
                errors.push('È´òÈü≥Ë∞±Âè∑Èü≥ÂüüËåÉÂõ¥Êó†Êïà');
            }

            // È™åËØÅÈü≥Êï∞‰∏éÈü≥ÂüüÁöÑÂÖºÂÆπÊÄß
            const maxNoteCount = Math.max(...window.pianoSettings.enabledNoteCounts);
            const trebleClefMinNotes = window.pianoSettings.noteDistribution.trebleClefMinNotes;

            if (maxNoteCount < trebleClefMinNotes + 1) {  // +1 for bass clef root note
                errors.push(`ÊúÄÂ§ßÈü≥Êï∞(${maxNoteCount})Â∞è‰∫éÊúÄÂ∞èË¶ÅÊ±Ç(${trebleClefMinNotes + 1})`);
            }

            return {
                valid: errors.length === 0,
                errors
            };
        }

        /**
         * Ëé∑ÂèñÈí¢Áê¥ÂΩìÂâçËÆæÁΩÆÊëòË¶Å
         * @returns {string} ËÆæÁΩÆÊëòË¶ÅÂ≠óÁ¨¶‰∏≤
         */
        function getPianoSettingsSummary() {
            if (!window.pianoSettings) {
                return 'Èí¢Áê¥ËÆæÁΩÆÊú™ÂàùÂßãÂåñ';
            }

            const midiToNoteName = (midi) => {
                const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                const octave = Math.floor(midi / 12) - 1;
                const noteName = notes[midi % 12];
                return `${noteName}${octave}`;
            };

            return `
üéπ Èí¢Áê¥ÂíåÂ£∞ÁîüÊàêËÆæÁΩÆ:
  Èü≥Êï∞ÈÄâÊã©: ${window.pianoSettings.enabledNoteCounts.join(', ')}Èü≥
  ‰ΩéÈü≥Ë∞±Âè∑: ${midiToNoteName(window.pianoSettings.bassClefRangeMin)}-${midiToNoteName(window.pianoSettings.bassClefRangeMax)}
  È´òÈü≥Ë∞±Âè∑: ${midiToNoteName(window.pianoSettings.trebleClefRangeMin)}-${midiToNoteName(window.pianoSettings.trebleClefRangeMax)}
  Èü≥Á¨¶ÂàÜÈÖç: ‰ΩéÈü≥Ë∞±Âè∑(Ê†πÈü≥) + È´òÈü≥Ë∞±Âè∑(‚â•${window.pianoSettings.noteDistribution.trebleClefMinNotes}Èü≥)
  ‰ºòÂÖàÈü≥Á¨¶: ${window.pianoSettings.noteDistribution.priorityNotes.join(', ')}
            `.trim();
        }

        /**
         * üéπ Èí¢Áê¥ÂíåÂº¶ÁîüÊàê‰∏ªÂáΩÊï∞
         * ‰ΩøÁî®PianoNoteCountEngineÁîüÊàêÂü∫‰∫éÈü≥Êï∞ÈÄâÊã©ÁöÑÈí¢Áê¥ÂíåÂ£∞
         */
        function generatePianoChords() {
            console.log('üéπ ========== ÂºÄÂßãÁîüÊàêÈí¢Áê¥ÂíåÂº¶ ==========');

            try {
                // üîß 2025-10-01 ‰øÆÂ§çÔºöÁßªÈô§updatePianoSettingsFromUI()Ë∞ÉÁî®
                // ÈóÆÈ¢òÔºöÁî®Êà∑Âú®ÂºπÁ™ó‰∏≠‰øùÂ≠òËÆæÁΩÆÂêéÔºåÊ≠§Â§ÑÈáçÊñ∞‰ªéUIËØªÂèñ‰ºöË¶ÜÁõñÂ∑≤‰øùÂ≠òÁöÑËÆæÁΩÆ
                // ÂéüÂõ†ÔºöÂºπÁ™óÂÖ≥Èó≠ÂêéUI checkboxÁä∂ÊÄÅÂèØËÉΩ‰∏é‰øùÂ≠òÁöÑËÆæÁΩÆ‰∏çÂêåÊ≠•
                // Ëß£ÂÜ≥Ôºö‰æùËµñÂºπÁ™ó‰øùÂ≠òÁöÑwindow.pianoSettingsÔºå‰∏çÂú®ÁîüÊàêÊó∂ÈáçÊñ∞ËØªÂèñUI
                // Êóß‰ª£Á†ÅÔºöupdatePianoSettingsFromUI();

                // üîç ËØäÊñ≠ÔºöÊòæÁ§∫ÂΩìÂâç‰ΩøÁî®ÁöÑÈü≥Êï∞ËÆæÁΩÆ
                console.log('üéπ ÂΩìÂâç window.pianoSettings.enabledNoteCounts:',
                           JSON.stringify(window.pianoSettings?.enabledNoteCounts));

                // 2. È™åËØÅËÆæÁΩÆ
                const validation = validatePianoSettings();
                if (!validation.valid) {
                    console.error('‚ùå Èí¢Áê¥ËÆæÁΩÆÈ™åËØÅÂ§±Ë¥•:', validation.errors);
                    alert('ËÆæÁΩÆÈîôËØØÔºö\n' + validation.errors.join('\n'));
                    return;
                }

                console.log(getPianoSettingsSummary());

                // 3. ÂàùÂßãÂåñÈí¢Áê¥ÂºïÊìé
                if (typeof PianoNoteCountEngine === 'undefined') {
                    throw new Error('PianoNoteCountEngine Êú™Âä†ËΩΩ');
                }

                if (!window.harmonyTheory) {
                    throw new Error('HarmonyTheory Êú™ÂàùÂßãÂåñ');
                }

                const pianoEngine = new PianoNoteCountEngine(window.harmonyTheory);
                console.log('‚úÖ Èí¢Áê¥ÂºïÊìéÂàùÂßãÂåñÊàêÂäü');

                // 4. ËØªÂèñÁî®Êà∑ËÆæÁΩÆ
                const measures = parseInt(document.querySelector('input[name="measures"]:checked')?.value || '4');

                // Ê£ÄÊü•ÊòØÂê¶ÂêØÁî®ÂäüËÉΩÂíåÂ£∞Ê®°ÂºèÔºàÊèêÂâçÊ£ÄÊü•ÔºåÁî®‰∫éË∞ÉÂè∑ÈÄâÊã©Ôºâ
                const functionalHarmonyToggle = document.getElementById('functionalHarmonyToggle');
                const useFunctionalHarmony = functionalHarmonyToggle ? functionalHarmonyToggle.checked : false;

                // üéØ Êô∫ËÉΩË∞ÉÂè∑ÈÄâÊã©ÔºöÂäüËÉΩÂíåÂ£∞Ê®°Âºè‰ΩøÁî®Á¨¨‰∏Ä‰∏™Ë∞ÉÂè∑ÔºåÈöèÊú∫Ê®°ÂºèÈöèÊú∫ÈÄâÊã©
                let key = 'C-major'; // ÈªòËÆ§Ë∞ÉÂè∑
                if (window.chordSettings && window.chordSettings.keys && window.chordSettings.keys.length > 0) {
                    if (useFunctionalHarmony) {
                        // ÂäüËÉΩÂíåÂ£∞Ê®°ÂºèÔºö‰ΩøÁî®Á¨¨‰∏Ä‰∏™ÈÄâ‰∏≠ÁöÑË∞ÉÂè∑ÔºàÁî®Êà∑ÊòéÁ°ÆÈÄâÊã©ÁöÑË∞ÉÊÄßÔºâ
                        key = window.chordSettings.keys[0];
                        console.log(`üéº ÂäüËÉΩÂíåÂ£∞Ê®°Âºè - ‰ΩøÁî®Á¨¨‰∏Ä‰∏™ÈÄâ‰∏≠Ë∞ÉÂè∑: ${key}`);
                    } else {
                        // ÈöèÊú∫Ê®°ÂºèÔºö‰ªéÂèØÁî®Ë∞ÉÂè∑‰∏≠ÈöèÊú∫ÈÄâÊã©
                        const randomIndex = Math.floor(Math.random() * window.chordSettings.keys.length);
                        key = window.chordSettings.keys[randomIndex];
                        console.log(`üé≤ ÈöèÊú∫Ê®°Âºè - ÈöèÊú∫ÈÄâÊã©Ë∞ÉÂè∑: ${key} (‰ªé${window.chordSettings.keys.length}‰∏™ÂèØÁî®Ë∞ÉÂè∑‰∏≠ÈÄâÊã©)`);
                    }
                } else {
                    console.log(`üéπ ‰ΩøÁî®ÈªòËÆ§Ë∞ÉÂè∑: ${key}`);
                }

                console.log(`üéπ Â∞èËäÇÊï∞: ${measures}, Ë∞ÉÊÄß: ${key}`);

                // 5. üéµ ÈõÜÊàêÂíåÂº¶ËøõË°åÁîüÊàêÁ≥ªÁªü - ÊîØÊåÅÈöèÊú∫Ê®°ÂºèÂíåÂäüËÉΩÂíåÂ£∞Ê®°Âºè
                console.log('üéµ ÂºÄÂßãÁîüÊàêÂíåÂº¶ËøõË°å...');

                // üîç ËØäÊñ≠ÔºöÊ£ÄÊü•ÂíåÂº¶Á±ªÂûãËÆæÁΩÆ
                console.log('\nüîç ========== Èí¢Áê¥Ê®°ÂºèÂÆåÊï¥ËÆæÁΩÆËØäÊñ≠ ==========');
                console.log('üéØ window.chordSettings.chordTypes:', window.chordSettings.chordTypes);
                console.log('üéØ ÊòØÂê¶‰∏∫Êï∞ÁªÑ:', Array.isArray(window.chordSettings.chordTypes));
                console.log('üéØ Êï∞ÁªÑÈïøÂ∫¶:', window.chordSettings.chordTypes ? window.chordSettings.chordTypes.length : 'undefined');
                console.log('üéØ ÂåÖÂê´7ÂíåÂº¶:', window.chordSettings.chordTypes ? window.chordSettings.chordTypes.filter(t => t.includes('7')).length : 0);
                console.log('üéØ ÂåÖÂê´3ÂíåÂº¶:', window.chordSettings.chordTypes ? window.chordSettings.chordTypes.filter(t => ['major', 'minor', 'diminished', 'augmented'].includes(t)).length : 0);
                console.log('üéØ ÂÆåÊï¥ÁöÑchordSettings:', JSON.stringify(window.chordSettings, null, 2));
                console.log('\nüéπ window.pianoSettings.enabledNoteCounts:', window.pianoSettings?.enabledNoteCounts);
                console.log('üéπ ÊòØÂê¶‰∏∫Êï∞ÁªÑ:', Array.isArray(window.pianoSettings?.enabledNoteCounts));
                console.log('üéπ Êï∞ÁªÑÈïøÂ∫¶:', window.pianoSettings?.enabledNoteCounts ? window.pianoSettings.enabledNoteCounts.length : 'undefined');
                console.log('üéπ ÂÆåÊï¥ÁöÑpianoSettings:', JSON.stringify(window.pianoSettings, null, 2));
                console.log('========== ËØäÊñ≠ÁªìÊùü ==========\n');

                // Ë∞ÉÁî®ÂØπÂ∫îÁöÑÂíåÂº¶ËøõË°åÁîüÊàêÂáΩÊï∞
                let chordProgression;
                if (useFunctionalHarmony) {
                    console.log('üéº ‰ΩøÁî®ÂäüËÉΩÂíåÂ£∞Ê®°ÂºèÁîüÊàêÂíåÂº¶ËøõË°å');
                    chordProgression = window.generateFunctionalProgression(key, measures);
                } else {
                    console.log('üé≤ ‰ΩøÁî®ÈöèÊú∫Ê®°ÂºèÁîüÊàêÂíåÂº¶ËøõË°å');
                    chordProgression = window.generateDiverseProgression(key, measures);
                }

                if (!chordProgression || chordProgression.length === 0) {
                    throw new Error('ÂíåÂº¶ËøõË°åÁîüÊàêÂ§±Ë¥•');
                }

                console.log(`‚úÖ ÁîüÊàê‰∫Ü${chordProgression.length}‰∏™ÂíåÂº¶:`, chordProgression.map(c => `${c.root}${c.type}`).join(', '));

                // üîç ËØäÊñ≠ÔºöÊ£ÄÊü•ÂäüËÉΩÂíåÂ£∞ËΩ¨‰Ωç‰ø°ÊÅØÊòØÂê¶Â≠òÂú®
                console.log('\nüîç ========== ÂäüËÉΩÂíåÂ£∞ËΩ¨‰ΩçËØäÊñ≠ ==========');
                console.log(`ÂäüËÉΩÂíåÂ£∞Ê®°Âºè: ${useFunctionalHarmony ? 'ÂºÄÂêØ' : 'ÂÖ≥Èó≠'}`);
                chordProgression.forEach((chord, i) => {
                    console.log(`Á¨¨${i+1}Â∞èËäÇ: ${chord.root}${chord.type}`);
                    console.log(`  - inversion: ${chord.inversion !== undefined ? chord.inversion : 'Êú™ÂÆö‰πâ'}`);
                    console.log(`  - inversionReason: ${chord.inversionReason || 'Êó†'}`);
                    console.log(`  - forcedBassNote: ${chord.forcedBassNote || 'Êó†'}`);
                });
                console.log('========================================\n');

                // 6. üéπ ‰∏∫ÊØè‰∏™ÂíåÂº¶ÁîüÊàêÈí¢Áê¥voicingÔºàÂêØÁî®Voice LeadingÔºâ
                // üîß ‰øÆÂ§ç (2025-10-02 Â∞ùËØï5): ÊîπÁî®whileÂæ™ÁéØÔºåÁ°Æ‰øùÁîüÊàêË∂≥Â§üÁöÑÂ∞èËäÇÊï∞
                // üîß ‰øÆÂ§ç (2025-10-06): Ê∑ªÂä†Â§ñÂ±ÇÂ§öÊ†∑ÊÄßÊ£ÄÊü•Âæ™ÁéØ

                const generatedChords = [];
                let prevBassMidi = null;  // ËÆ∞ÂΩïÂâç‰∏Ä‰∏™ÂíåÂº¶ÁöÑ‰ΩéÈü≥MIDIÂÄº
                let chordIndex = 0;  // ÂΩìÂâçÂ∞ùËØïÁöÑÂíåÂº¶ËøõË°åÁ¥¢Âºï
                let successfulCount = 0;  // ÊàêÂäüÁîüÊàêÁöÑÂíåÂº¶Êï∞Èáè

                // üîß Êñ∞Â¢û (2025-10-06): ÂíåÂº¶Â§öÊ†∑ÊÄßÊ£ÄÊµã - ‰ªÖÈí¢Áê¥Ê®°Âºè6/7Èü≥ÈÖçÁΩÆ
                const userWantsSingleNoteCount = window.pianoSettings.enabledNoteCounts.length === 1;
                const singleNoteCountValue = userWantsSingleNoteCount ? window.pianoSettings.enabledNoteCounts[0] : null;
                const needsDiversityCheck = userWantsSingleNoteCount && (singleNoteCountValue === 6 || singleNoteCountValue === 7);

                let generatedChordNames = [];  // ËÆ∞ÂΩïÂ∑≤ÁîüÊàêÁöÑÂíåÂº¶ÂêçÁß∞
                let attemptsSinceLastSuccess = 0;  // Ëá™‰∏äÊ¨°ÊàêÂäüÂêéÁöÑÂ∞ùËØïÊ¨°Êï∞
                let progressionRegenerationCount = 0;  // ÂíåÂº¶ËøõË°åÈáçÊñ∞ÁîüÊàêÊ¨°Êï∞
                const maxProgressionRegenerations = 3;  // ÊúÄÂ§öÈáçÊñ∞ÁîüÊàê3Ê¨°
                const maxAttemptsBeforeRegeneration = chordProgression.length * 3;  // ÊúÄÂ§ßÂ∞ùËØïÊ¨°Êï∞

                // üîß Êñ∞Â¢û (2025-10-06): Â§ñÂ±ÇÂ§öÊ†∑ÊÄßÊ£ÄÊü•
                let diversityRetryCount = 0;
                const maxDiversityRetries = 3;
                let finalGeneratedChords = [];

                if (needsDiversityCheck) {
                    console.log(`üéØ ÂêØÁî®ÂíåÂº¶Â§öÊ†∑ÊÄßÊ£ÄÊµã (${singleNoteCountValue}Èü≥ÈÖçÁΩÆ)`);
                    console.log(`  - Á≠ñÁï•: ÁîüÊàêÂÆåÊàêÂêéÊ£ÄÊü•Â§öÊ†∑ÊÄß`);
                    console.log(`  - Â¶ÇÊûúÈáçÂ§çÂ§™Â§öÔºåÊúÄÂ§öÈáçÊñ∞ÁîüÊàê${maxDiversityRetries}Ê¨°`);
                }

                // Â§ñÂ±ÇÂæ™ÁéØÔºöÂ§öÊ†∑ÊÄßÊ£ÄÊü•
                while (diversityRetryCount <= maxDiversityRetries) {
                    // ÈáçÁΩÆÂÜÖÂ±ÇÂæ™ÁéØÁöÑÁä∂ÊÄÅ
                    generatedChords.length = 0;
                    generatedChordNames.length = 0;
                    successfulCount = 0;
                    chordIndex = 0;
                    prevBassMidi = null;
                    attemptsSinceLastSuccess = 0;
                    progressionRegenerationCount = 0;

                    // üîß ‰øÆÂ§ç (2025-10-06): Â∞ÜÂèòÈáèÂ£∞ÊòéÁßªÂà∞Âæ™ÁéØÂ§ñÔºåÈò≤Ê≠¢‰ΩúÁî®ÂüüÈîôËØØ
                    // Ëøô‰∫õÂèòÈáèÈúÄË¶ÅÂú®Âç°‰ΩèÊ£ÄÊµã‰ª£Á†Å‰∏≠ËÆøÈóÆÔºåÊâÄ‰ª•ÂøÖÈ°ªÂú®tryÂùóÂ§ñÂÆö‰πâ
                    const originalNoteCounts = [...window.pianoSettings.enabledNoteCounts];
                    const userWantsSingleNoteCount = originalNoteCounts.length === 1;
                    const singleNoteCountValue = userWantsSingleNoteCount ? originalNoteCounts[0] : null;

                    // ÂÜÖÂ±ÇÂæ™ÁéØÔºöÁîüÊàêÂíåÂº¶
                    while (successfulCount < measures) {
                    // üîß ‰øÆÂ§ç (2025-10-06): Ê£ÄÊµãÊòØÂê¶Âç°‰ΩèÔºàÂ∞ùËØïÂ§™Â§öÊ¨°‰ªçÊó†ËøõÂ±ïÔºâ
                    // üîß ‰øÆÂ§ç (2025-10-06): ÁßªÈô§needsDiversityCheckÊù°‰ª∂ÔºåÈò≤Ê≠¢Â§öÈü≥Êï∞ÈÖçÁΩÆÂç°Ê≠ª
                    if (attemptsSinceLastSuccess > maxAttemptsBeforeRegeneration) {
                        console.warn(`‚ö†Ô∏è Ê£ÄÊµãÂà∞ÁîüÊàêÂç°‰Ωè: Â∞ùËØï‰∫Ü${attemptsSinceLastSuccess}Ê¨°Ôºå‰ªçÊú™ÁîüÊàêÊñ∞ÂíåÂº¶`);

                        if (progressionRegenerationCount >= maxProgressionRegenerations) {
                            console.error(`‚ùå Â∑≤ÈáçÊñ∞ÁîüÊàê${maxProgressionRegenerations}Ê¨°ÂíåÂº¶ËøõË°åÔºå‰ªçÁÑ∂Âç°‰Ωè`);

                            // üîß ‰øÆÂ§ç (2025-10-06): Âä®ÊÄÅÁîüÊàêÈîôËØØ‰ø°ÊÅØÔºåÈÄÇÁî®‰∫éÂçï‰∏ÄÂíåÂ§öÈü≥Êï∞Ê®°Âºè
                            const noteCountDesc = userWantsSingleNoteCount
                                ? `${singleNoteCountValue}Èü≥ÈÖçÁΩÆ`
                                : `Â§öÈü≥Êï∞ÈÖçÁΩÆ [${originalNoteCounts.join(', ')}]`;

                            throw new Error(`Êó†Ê≥ïÁîüÊàêË∂≥Â§üÁöÑÂíåÂº¶Ôºà${noteCountDesc}ÔºâÔºåËØ∑Â∞ùËØïÔºö\n1. Êâ©Â§ßÈü≥ÂüüËåÉÂõ¥\n2. ÈÄâÊã©Êõ¥Â§öÂíåÂº¶Á±ªÂûã\n3. ÂáèÂ∞ëÁîüÊàêÁöÑÂ∞èËäÇÊï∞`);
                        }

                        console.warn(`üîÑ ÈáçÊñ∞ÁîüÊàêÂíåÂº¶ËøõË°åÔºàÁ¨¨${progressionRegenerationCount + 1}Ê¨°Ôºâ`);

                        // ÈáçÊñ∞ÁîüÊàêÂíåÂº¶ËøõË°å
                        if (useFunctionalHarmony) {
                            chordProgression = window.generateFunctionalProgression(key, measures);
                        } else {
                            chordProgression = window.generateDiverseProgression(key, measures);
                        }

                        console.log(`‚úÖ Êñ∞ÂíåÂº¶ËøõË°å: ${chordProgression.map(c => `${c.root}${c.type}`).join(', ')}`);

                        // ÈáçÁΩÆÁä∂ÊÄÅÔºå‰ΩÜ‰øùÁïôÂ∑≤ÁîüÊàêÁöÑÂíåÂº¶Ôºà‰∏ç‰ªéÂ§¥ÂºÄÂßãÔºâ
                        chordIndex = 0;
                        attemptsSinceLastSuccess = 0;
                        progressionRegenerationCount++;
                        continue;  // Ë∑≥ËøáÊú¨Ê¨°Âæ™ÁéØÔºå‰ΩøÁî®Êñ∞ÁöÑÂíåÂº¶ËøõË°å
                    }

                    attemptsSinceLastSuccess++;  // ËÆ∞ÂΩïÂ∞ùËØïÊ¨°Êï∞

                    // ‰ªéÂíåÂº¶ËøõË°å‰∏≠Âæ™ÁéØÈÄâÊã©ÂíåÂº¶ÔºàÂ¶ÇÊûúÂà∞ËææÊú´Â∞æÔºå‰ªéÂ§¥ÂºÄÂßãÔºâ
                    const chord = chordProgression[chordIndex % chordProgression.length];
                    chordIndex++;

                    console.log(`üéπ ÁîüÊàêÁ¨¨${successfulCount + 1}/${measures}Â∞èËäÇ (Â∞ùËØïÂíåÂº¶: ${chord.root}${chord.type})`);

                    try {
                        let result = null;
                        let generatedSuccessfully = false;

                        // üîß ‰øÆÂ§ç (2025-10-02 Â∞ùËØï5): Êô∫ËÉΩÈôçÁ∫ßÁ≠ñÁï•
                        // ÈóÆÈ¢òÔºöÁî®Êà∑Âè™ÂãæÈÄâ7Èü≥Êó∂ÔºåÁ≥ªÁªüËá™Âä®ÈôçÁ∫ßÂà∞6Èü≥/5Èü≥ÔºåËøùËÉåÁî®Êà∑ÊÑèÂõæ
                        // Ëß£ÂÜ≥ÔºöÊ£ÄÊµãÁî®Êà∑ÊòØÂê¶Âè™ÂãæÈÄâ‰∫Ü‰∏Ä‰∏™Èü≥Êï∞ÔºåÂ¶ÇÊûúÊòØÂàô‰∏çÈôçÁ∫ßÔºåÂ§±Ë¥•Êó∂Ë∑≥ËøáËØ•ÂíåÂº¶
                        // üîß ‰øÆÂ§ç (2025-10-06): originalNoteCountsÂíåuserWantsSingleNoteCountÂ∑≤Âú®Âæ™ÁéØÂ§ñÂÆö‰πâ
                        const fallbackSequence = [];

                        // üîç ËØäÊñ≠ÔºöÊòæÁ§∫Áî®Êà∑ÂÆûÈôÖÂãæÈÄâÁöÑÈü≥Êï∞
                        console.log(`üîç Áî®Êà∑ÂãæÈÄâÁöÑÈü≥Êï∞ÈÖçÁΩÆ: [${originalNoteCounts.join(', ')}] (Êï∞Èáè: ${originalNoteCounts.length})`);
                        console.log(`üîç ÊòØÂê¶Âçï‰∏ÄÈü≥Êï∞Ê®°Âºè: ${userWantsSingleNoteCount}`);

                        // ÊûÑÂª∫fallbackÂ∫èÂàóÔºö
                        // - Áî®Êà∑Âè™ÂãæÈÄâ‰∏Ä‰∏™Èü≥Êï∞ÔºöÂè™Â∞ùËØïËØ•Èü≥Êï∞Ôºå‰∏çÈôçÁ∫ß
                        // - Áî®Êà∑ÂãæÈÄâÂ§ö‰∏™Èü≥Êï∞ÔºöÈöèÊú∫ÈÄâÊã©‰∏Ä‰∏™‰Ωú‰∏∫È¶ñÈÄâÔºåÂÖ∂‰ªñ‰Ωú‰∏∫fallback
                        if (userWantsSingleNoteCount) {
                            // üéØ Âçï‰∏ÄÈü≥Êï∞Ê®°ÂºèÔºö‰∏çÈôçÁ∫ßÔºåÂ§±Ë¥•Êó∂Ë∑≥Ëøá
                            fallbackSequence.push(originalNoteCounts[0]);
                            console.log(`üéØ Âçï‰∏ÄÈü≥Êï∞Ê®°ÂºèÔºöÂè™Â∞ùËØï ${originalNoteCounts[0]}Èü≥ÔºåÂ§±Ë¥•Êó∂Ë∑≥ËøáÂíåÂº¶`);
                        } else {
                            // üîÑ Â§öÈü≥Êï∞Ê®°ÂºèÔºöÈöèÊú∫ÈÄâÊã© + fallback
                            // üîß ‰øÆÂ§ç (2025-10-06): ‰ΩøÁî®Áî®Êà∑ÂãæÈÄâÁöÑÈü≥Êï∞ÔºåÈöèÊú∫ÈÄâÊã©È¶ñÈÄâÈ°π

                            // 1. ÈöèÊú∫Êâì‰π±Áî®Êà∑ÂãæÈÄâÁöÑÈü≥Êï∞
                            const shuffledNoteCounts = [...originalNoteCounts].sort(() => Math.random() - 0.5);

                            // 2. Â∞ÜÊâì‰π±ÂêéÁöÑÈü≥Êï∞‰Ωú‰∏∫fallbackÂ∫èÂàó
                            fallbackSequence.push(...shuffledNoteCounts);

                            console.log(`üîÑ Â§öÈü≥Êï∞Ê®°ÂºèÔºöÈöèÊú∫ÈÄâÊã©È¶ñÈÄâÈü≥Êï∞Ôºåfallback = [${fallbackSequence.join(' ‚Üí ')}]`);
                            console.log(`   Áî®Êà∑ÂãæÈÄâ: [${originalNoteCounts.join(', ')}]`);
                        }

                        // Â∞ùËØïÊØè‰∏™Èü≥Êï∞ÈÖçÁΩÆ
                        for (let attemptIndex = 0; attemptIndex < fallbackSequence.length; attemptIndex++) {
                            const attemptNoteCount = fallbackSequence[attemptIndex];

                            // ‰∏¥Êó∂‰øÆÊîπsettingsÔºåÂè™ÂÖÅËÆ∏ÂΩìÂâçÂ∞ùËØïÁöÑÈü≥Êï∞
                            const attemptSettings = {
                                ...window.pianoSettings,
                                enabledNoteCounts: [attemptNoteCount]
                            };

                            console.log(`\nüîÑ Â∞ùËØï ${attemptIndex + 1}/${fallbackSequence.length}: ${attemptNoteCount}Èü≥ÈÖçÁΩÆ`);

                            try {
                                // üîß ‰øÆÂ§ç (2025-10-02): ÂäüËÉΩÂíåÂ£∞Ê®°Âºè‰∏ã‰∏ç‰º†ÈÄíÈöèÊú∫ËΩ¨‰ΩçËÆæÁΩÆ
                                // ÂéüÂõ†ÔºöÂäüËÉΩÂíåÂ£∞Ê®°Âºè‰∏ãÔºåchord.inversion Â∑≤Áî± applyFunctionalInversions() ËÆæÁΩÆ
                                // ‰º†ÈÄíÈöèÊú∫ËΩ¨‰ΩçËÆæÁΩÆ‰ºöÂºïËµ∑ÂÜ≤Á™ÅÔºåÈí¢Áê¥ÂºïÊìéÂ∫îËØ•Âè™‰ΩøÁî® chord.inversion
                                const inversionSettings = useFunctionalHarmony ? null : {
                                    includeTriadInversions: window.chordSettings.includeTriadInversions || false,
                                    includeSeventhInversions: window.chordSettings.includeSeventhInversions || false
                                };

                                // üîß Êñ∞Â¢û (2025-10-06): Ê£ÄÊµãËøûÁª≠ÈáçÂ§çÔºåÂº∫Âà∂‰ΩøÁî®ËΩ¨‰ΩçÊù•Â¢ûÂä†ÂèòÂåñ
                                if (needsDiversityCheck && !useFunctionalHarmony && inversionSettings && successfulCount > 0) {
                                    const prevChordName = generatedChordNames[generatedChordNames.length - 1];
                                    const currentChordName = `${chord.root}${chord.type}`;

                                    if (prevChordName === currentChordName) {
                                        // ËøûÁª≠ÈáçÂ§çÔºÅÂº∫Âà∂‰ΩøÁî®ËΩ¨‰Ωç
                                        const hasInversionsEnabled = inversionSettings.includeTriadInversions || inversionSettings.includeSeventhInversions;

                                        if (hasInversionsEnabled) {
                                            inversionSettings.forceInversion = true;
                                            inversionSettings.minInversion = 1;  // Ëá≥Â∞ëÁ¨¨‰∏ÄËΩ¨‰Ωç
                                            console.log(`üéØ Ê£ÄÊµãÂà∞ËøûÁª≠ÈáçÂ§ç: ${prevChordName} ‚Üí ${currentChordName}`);
                                            console.log(`   Âº∫Âà∂‰ΩøÁî®ËΩ¨‰ΩçÊù•Â¢ûÂä†ÂèòÂåñÔºàminInversion=1Ôºâ`);
                                        } else {
                                            console.log(`‚ö†Ô∏è Ê£ÄÊµãÂà∞ËøûÁª≠ÈáçÂ§ç‰ΩÜËΩ¨‰ΩçÊú™ÂêØÁî®: ${currentChordName}`);
                                        }
                                    }
                                }

                                // üîç ËØäÊñ≠ÔºöÊòæÁ§∫ËΩ¨‰ΩçËÆæÁΩÆÊù•Ê∫ê
                                if (useFunctionalHarmony) {
                                    console.log(`üéº ÂäüËÉΩÂíåÂ£∞Ê®°ÂºèÔºöinversionSettings = nullÔºà‰ΩøÁî® chord.inversionÔºâ`);
                                } else {
                                    console.log(`üé≤ ÈöèÊú∫Ê®°ÂºèÔºöinversionSettings =`, inversionSettings);
                                }

                                // üéØ Á¨¨‰∏âËΩ¨‰ΩçÁ∫¶ÊùüÊ£ÄÊü•Ôºà‰ªÖÈöèÊú∫Ê®°ÂºèÔºâ
                                // üîß ‰øÆÂ§ç (2025-10-02): Âè™Âú®ÈöèÊú∫Ê®°Âºè‰∏ãÊâßË°åÔºàinversionSettings ‰∏ç‰∏∫ nullÔºâ
                                // Èü≥‰πêÁêÜËÆ∫Ôºö"Third inversion will sound ambiguous if it is not preceded by a root-position voicing of the same chord"
                                if (!useFunctionalHarmony && inversionSettings) {
                                    const hasTensions = chord.is69Voicing || chord.failed69Conversion;
                                    const isSeventhChord = chord.type.includes('7') ||
                                                          chord.type.includes('9') ||
                                                          chord.type.includes('11') ||
                                                          chord.type.includes('13');
                                    const needsThirdInversionCheck = isSeventhChord || hasTensions;

                                    if (needsThirdInversionCheck && successfulCount > 0) {
                                        const prevChord = generatedChords[successfulCount - 1];
                                        const isSameChord = prevChord.chordInfo.root === chord.root &&
                                                            prevChord.chordInfo.type === chord.type;
                                        const prevWasRootPosition = !prevChord.inversionIndex || prevChord.inversionIndex === 0;

                                        if (!isSameChord || !prevWasRootPosition) {
                                            // Á¶ÅÊ≠¢Á¨¨‰∏âËΩ¨‰ΩçÔºöÊúÄÂ§ßËΩ¨‰ΩçËÆæÁΩÆ‰∏∫2
                                            inversionSettings.maxInversion = 2;
                                            console.log(`üéØ Á¨¨‰∏âËΩ¨‰ΩçÁ∫¶Êùü: ${chord.root}${chord.type} ÊúÄÂ§ßËΩ¨‰Ωç=2 (‰∏ÉÂíåÂº¶/tensionÔºåÂâç‰∏ÄÂíåÂº¶‰∏çÁ¨¶ÂêàÊù°‰ª∂)`);
                                        }
                                    }
                                } else if (useFunctionalHarmony) {
                                    console.log(`üéº ÂäüËÉΩÂíåÂ£∞Ê®°ÂºèÔºöÁ¨¨‰∏âËΩ¨‰ΩçÁ∫¶ÊùüÁî± applySeventhChordThirdInversion() Â§ÑÁêÜ`);
                                }

                                result = pianoEngine.generatePianoChord(
                                    chord,
                                    attemptSettings,
                                    key,
                                    null,
                                    prevBassMidi,
                                    inversionSettings  // üîß Êñ∞Â¢ûÂèÇÊï∞ (2025-10-02)
                                );

                                // È™åËØÅÁªìÊûú
                                const resultValidation = pianoEngine.validateResult(result, attemptSettings);
                                if (resultValidation.valid) {
                                    generatedSuccessfully = true;
                                    if (attemptIndex > 0) {
                                        // üîß ‰øÆÂ§ç (2025-10-06): ÁßªÈô§ÂØπmaxNoteCountÁöÑÂºïÁî®ÔºàÂèòÈáè‰∏çÂ≠òÂú®Ôºâ
                                        console.warn(`‚úÖ FallbackÊàêÂäü: ${chord.root}${chord.type} ‰ΩøÁî®${attemptNoteCount}Èü≥ÈÖçÁΩÆÔºàÂ∞ùËØï${attemptIndex + 1}/${fallbackSequence.length}Ôºâ`);
                                    } else {
                                        // üîß ‰øÆÂ§ç (2025-10-06): ‰ΩøÁî®successfulCountÊõø‰ª£iÔºàÂèòÈáè‰∏çÂ≠òÂú®Ôºâ
                                        console.log(`‚úÖ ÂíåÂº¶ ${successfulCount + 1} ÁîüÊàêÊàêÂäü: ${attemptNoteCount}Èü≥ÈÖçÁΩÆ`);
                                    }
                                    break;  // ÊàêÂäüÔºåË∑≥Âá∫Â∞ùËØïÂæ™ÁéØ
                                } else {
                                    console.warn(`‚ö†Ô∏è ${attemptNoteCount}Èü≥ÈÖçÁΩÆÈ™åËØÅÂ§±Ë¥•:`, resultValidation.errors);
                                }
                            } catch (attemptError) {
                                console.warn(`‚ö†Ô∏è ${attemptNoteCount}Èü≥ÈÖçÁΩÆÁîüÊàêÂ§±Ë¥•: ${attemptError.message}`);
                                if (attemptIndex === fallbackSequence.length - 1) {
                                    // üîß ‰øÆÂ§ç (2025-10-02 Â∞ùËØï5): Âçï‰∏ÄÈü≥Êï∞Ê®°Âºè‰∏ãË∑≥ËøáÂíåÂº¶Ôºå‰∏çÊäõÂá∫ÈîôËØØ
                                    if (userWantsSingleNoteCount) {
                                        console.warn(`‚è≠Ô∏è Ë∑≥ËøáÂíåÂº¶ ${chord.root}${chord.type}ÔºàÁî®Êà∑Âè™ÂãæÈÄâ‰∫Ü${originalNoteCounts[0]}Èü≥ÔºåÊó†Ê≥ïÊª°Ë∂≥Á∫¶ÊùüÔºâ`);
                                        // ‰∏çÊäõÂá∫ÈîôËØØÔºåÁªßÁª≠‰∏ã‰∏Ä‰∏™ÂíåÂº¶
                                        break;  // Ë∑≥Âá∫Â∞ùËØïÂæ™ÁéØÔºåËøõÂÖ•‰∏ã‰∏Ä‰∏™ÂíåÂº¶
                                    } else {
                                        // Â§öÈü≥Êï∞Ê®°ÂºèÔºöÊâÄÊúâÈôçÁ∫ßÂ∞ùËØïÈÉΩÂ§±Ë¥•‰∫ÜÔºåÊäõÂá∫ÈîôËØØ
                                        throw new Error(`ÊâÄÊúâÈôçÁ∫ßÂ∞ùËØïÂ§±Ë¥•: ${chord.root}${chord.type}`);
                                    }
                                }
                                // ÁªßÁª≠Â∞ùËØï‰∏ã‰∏Ä‰∏™Èü≥Êï∞
                            }
                        }

                        if (generatedSuccessfully && result) {
                            generatedChords.push(result);
                            successfulCount++;  // üîß ‰øÆÂ§ç (2025-10-02 Â∞ùËØï5): ÊàêÂäüÁîüÊàêÂêéÂ¢ûÂä†ËÆ°Êï∞

                            // üîß Êñ∞Â¢û (2025-10-06): ÊàêÂäüÊó∂ÈáçÁΩÆÂ∞ùËØïËÆ°Êï∞Âô®
                            if (needsDiversityCheck) {
                                attemptsSinceLastSuccess = 0;  // ÈáçÁΩÆ
                                const chordName = `${chord.root}${chord.type}`;
                                generatedChordNames.push(chordName);
                                console.log(`üìù ÊàêÂäüÁîüÊàê: ${chordName} (ÊÄªÂÖ±${generatedChordNames.length}‰∏™ÔºåÈáçÁΩÆÂ∞ùËØïËÆ°Êï∞Âô®)`);
                            }

                            // üîç ËØ¶ÁªÜËØäÊñ≠Á≥ªÁªüÔºà2025-10-01Êñ∞Â¢ûÔºâ
                            console.log(`\nüîç ========== Â∞èËäÇ${successfulCount}ËØ¶ÁªÜËØäÊñ≠ ==========`);
                            console.log(`üéµ ÂíåÂº¶ÂêçÁß∞: ${chord.root}${chord.type}`);
                            console.log(`üéπ ÊÄªÈü≥Á¨¶Êï∞: ${result.noteCount}Èü≥`);

                            // ‰ΩéÈü≥Ë∞±Âè∑ËØäÊñ≠
                            console.log(`\nüìç ‰ΩéÈü≥Ë∞±Âè∑ (Bass Clef):`);
                            console.log(`  Èü≥Á¨¶Êï∞Èáè: ${result.bassClefNotes.length}Èü≥`);
                            if (result.bassClefNotes && result.bassClefNotes.length > 0) {
                                const bassNoteNames = result.bassClefNotes.map(midi => {
                                    const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                                    const octave = Math.floor(midi / 12) - 1;
                                    const noteIndex = midi % 12;
                                    return `${noteNames[noteIndex]}${octave}`;
                                });
                                const bassSpan = Math.max(...result.bassClefNotes) - Math.min(...result.bassClefNotes);
                                console.log(`  Èü≥Á¨¶: ${bassNoteNames.join(', ')}`);
                                console.log(`  MIDI: ${result.bassClefNotes.join(', ')}`);
                                console.log(`  Ë∑®Â∫¶: ${bassSpan}ÂçäÈü≥ (${Math.min(...result.bassClefNotes)} ‚Üí ${Math.max(...result.bassClefNotes)})`);
                            }

                            // È´òÈü≥Ë∞±Âè∑ËØäÊñ≠
                            console.log(`\nüìç È´òÈü≥Ë∞±Âè∑ (Treble Clef):`);
                            console.log(`  Èü≥Á¨¶Êï∞Èáè: ${result.trebleClefNotes.length}Èü≥`);
                            if (result.trebleClefNotes && result.trebleClefNotes.length > 0) {
                                const trebleNoteNames = result.trebleClefNotes.map(midi => {
                                    const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                                    const octave = Math.floor(midi / 12) - 1;
                                    const noteIndex = midi % 12;
                                    return `${noteNames[noteIndex]}${octave}`;
                                });
                                const trebleSpan = Math.max(...result.trebleClefNotes) - Math.min(...result.trebleClefNotes);
                                const sortedTreble = [...result.trebleClefNotes].sort((a, b) => a - b);

                                // ËÆ°ÁÆóÁõ∏ÈÇªÈü≥Á¨¶Èó¥Ë∑ù
                                const intervals = [];
                                for (let j = 1; j < sortedTreble.length; j++) {
                                    intervals.push(sortedTreble[j] - sortedTreble[j-1]);
                                }
                                const maxInterval = intervals.length > 0 ? Math.max(...intervals) : 0;
                                const avgInterval = intervals.length > 0 ? (intervals.reduce((a,b) => a+b, 0) / intervals.length).toFixed(1) : 0;

                                console.log(`  Èü≥Á¨¶: ${trebleNoteNames.join(', ')}`);
                                console.log(`  MIDI: ${result.trebleClefNotes.join(', ')}`);
                                console.log(`  Ë∑®Â∫¶: ${trebleSpan}ÂçäÈü≥ (${Math.min(...result.trebleClefNotes)} ‚Üí ${Math.max(...result.trebleClefNotes)})`);
                                console.log(`  ÊúÄÂ§ßÈó¥Ë∑ù: ${maxInterval}ÂçäÈü≥`);
                                console.log(`  Âπ≥ÂùáÈó¥Ë∑ù: ${avgInterval}ÂçäÈü≥`);

                                // Close VoicingÂà§Êñ≠
                                if (trebleSpan <= 12) {
                                    console.log(`  ‚úÖ Close Voicing (ÊâÄÊúâÈü≥Á¨¶Âú®‰∏Ä‰∏™ÂÖ´Â∫¶ÂÜÖ)`);
                                } else {
                                    console.log(`  ‚ö†Ô∏è ÈùûClose Voicing (Ë∑®Â∫¶Ë∂ÖËøá‰∏Ä‰∏™ÂÖ´Â∫¶)`);
                                }
                            }

                            // ÂÖ®Â±ÄÁªüËÆ°
                            console.log(`\nüìä Êï¥‰ΩìÁªüËÆ°:`);
                            const allNotes = [...result.bassClefNotes, ...result.trebleClefNotes];
                            const globalSpan = Math.max(...allNotes) - Math.min(...allNotes);
                            console.log(`  ÂÖ®Â±ÄË∑®Â∫¶: ${globalSpan}ÂçäÈü≥`);
                            console.log(`  Èü≥ÂüüËåÉÂõ¥: MIDI ${Math.min(...allNotes)} (${(() => {
                                const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                                const midi = Math.min(...allNotes);
                                const octave = Math.floor(midi / 12) - 1;
                                const noteIndex = midi % 12;
                                return `${noteNames[noteIndex]}${octave}`;
                            })()}) ‚Üí MIDI ${Math.max(...allNotes)} (${(() => {
                                const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                                const midi = Math.max(...allNotes);
                                const octave = Math.floor(midi / 12) - 1;
                                const noteIndex = midi % 12;
                                return `${noteNames[noteIndex]}${octave}`;
                            })()})`);
                            console.log(`========== ËØäÊñ≠ÁªìÊùü ==========\n`);

                            // üéº Êõ¥Êñ∞prevBassMidi‰∏∫ÂΩìÂâçÂíåÂº¶ÁöÑÊúÄ‰ΩéÈü≥ÔºàÁî®‰∫é‰∏ã‰∏Ä‰∏™ÂíåÂº¶ÁöÑVoice LeadingÔºâ
                            if (result.bassClefNotes && result.bassClefNotes.length > 0) {
                                prevBassMidi = Math.min(...result.bassClefNotes);
                                console.log(`üéº Êõ¥Êñ∞‰ΩéÈü≥ÂèÇËÄÉ: MIDI ${prevBassMidi}`);
                            }
                        }
                    } catch (error) {
                        // üîß ‰øÆÂ§ç (2025-10-02): ÈôçÁ∫ßÁ≠ñÁï•Â§±Ë¥•ÂêéÁöÑÂºÇÂ∏∏Â§ÑÁêÜ
                        console.error(`‚ùå ÂíåÂº¶ (${chord.root}${chord.type}) ÊâÄÊúâÈôçÁ∫ßÂ∞ùËØïÂ§±Ë¥•`);
                        console.error(`   ÂéüÂõ†: ${error.message}`);
                        console.error(`   üí° Ê≠§ÂíåÂº¶Âú®ÊâÄÊúâÈü≥Êï∞ÈÖçÁΩÆ‰∏ãÈÉΩÊó†Ê≥ïÊª°Ë∂≥12ÂçäÈü≥Á∫¶ÊùüÔºåÂ∑≤Ë∑≥Ëøá`);
                        // üîß ‰øÆÂ§ç (2025-10-02 Â∞ùËØï5): ‰∏çÂ¢ûÂä†successfulCountÔºåÁªßÁª≠Â∞ùËØï‰∏ã‰∏Ä‰∏™ÂíåÂº¶
                        // whileÂæ™ÁéØ‰ºöËá™Âä®ÈÄâÊã©‰∏ã‰∏Ä‰∏™ÂíåÂº¶ÔºåÁõ¥Âà∞ÊàêÂäüÁîüÊàêË∂≥Â§üÊï∞Èáè
                    }
                }
                    // ÂÜÖÂ±ÇÂæ™ÁéØÁªìÊùü

                    // üîß Êñ∞Â¢û (2025-10-06): Ê£ÄÊü•ÁîüÊàêÁöÑÂíåÂº¶Â§öÊ†∑ÊÄß
                    if (needsDiversityCheck && generatedChordNames.length > 0) {
                        const uniqueChords = new Set(generatedChordNames);
                        const diversityRatio = uniqueChords.size / generatedChordNames.length;

                        console.log(`\nüîç ========== ÂíåÂº¶Â§öÊ†∑ÊÄßÊ£ÄÊü• ==========`);
                        console.log(`  ÁîüÊàêÁöÑÂíåÂº¶: [${generatedChordNames.join(', ')}]`);
                        console.log(`  ÂîØ‰∏ÄÂíåÂº¶Êï∞: ${uniqueChords.size}`);
                        console.log(`  ÊÄªÂíåÂº¶Êï∞: ${generatedChordNames.length}`);
                        console.log(`  Â§öÊ†∑ÊÄßÊØî‰æã: ${(diversityRatio * 100).toFixed(1)}%`);

                        // Âà§Êñ≠Ê†áÂáÜÔºöËá≥Â∞ë50%ÁöÑÂíåÂº¶ÊòØ‰∏çÂêåÁöÑ
                        const isDiverse = uniqueChords.size >= 2 && diversityRatio >= 0.5;

                        if (isDiverse || diversityRetryCount >= maxDiversityRetries) {
                            console.log(`‚úÖ Â§öÊ†∑ÊÄßÊ£ÄÊü•ÈÄöËøá (ÈáçËØï${diversityRetryCount}Ê¨°)`);
                            finalGeneratedChords = generatedChords;
                            break;  // ÈÄÄÂá∫Â§ñÂ±ÇÂæ™ÁéØ
                        } else {
                            console.warn(`‚ö†Ô∏è Â§öÊ†∑ÊÄß‰∏çË∂≥ÔºàÁ¨¨${diversityRetryCount + 1}Ê¨°Â∞ùËØïÔºâ`);
                            console.warn(`   ÂîØ‰∏ÄÂíåÂº¶Âè™Êúâ${uniqueChords.size}Áßç: ${Array.from(uniqueChords).join(', ')}`);

                            // ÈáçÊñ∞ÁîüÊàêÂíåÂº¶ËøõË°å
                            if (useFunctionalHarmony) {
                                chordProgression = window.generateFunctionalProgression(key, measures);
                            } else {
                                chordProgression = window.generateDiverseProgression(key, measures);
                            }

                            console.log(`üîÑ ÈáçÊñ∞ÁîüÊàêÂíåÂº¶ËøõË°å: ${chordProgression.map(c => `${c.root}${c.type}`).join(', ')}`);
                            diversityRetryCount++;
                            continue;  // ÁªßÁª≠Â§ñÂ±ÇÂæ™ÁéØ
                        }
                    } else {
                        // ‰∏çÈúÄË¶ÅÂ§öÊ†∑ÊÄßÊ£ÄÊü•ÔºåÁõ¥Êé•‰ΩøÁî®ÁªìÊûú
                        finalGeneratedChords = generatedChords;
                        break;
                    }
                }
                // Â§ñÂ±ÇÂæ™ÁéØÁªìÊùü

                console.log(`\n‚úÖ ========== ÂíåÂº¶ÁîüÊàêÂÆåÊàê ==========`);
                console.log(`  ÁõÆÊ†áÂ∞èËäÇÊï∞: ${measures}`);
                console.log(`  ÊàêÂäüÁîüÊàê: ${successfulCount}Â∞èËäÇ`);
                console.log(`  Â∞ùËØïÂíåÂº¶ÊÄªÊï∞: ${chordIndex}`);
                console.log(`========================================\n`);

                console.log('üéπ Èí¢Áê¥ÂíåÂº¶ËøõË°åÁîüÊàêÂÆåÊàê:', finalGeneratedChords);

                // 6. üéµ Phase 4: Ê∏≤ÊüìMusicXMLÂ§ßË∞±Ë°®
                console.log('\nüéº ========== Phase 4: ÂºÄÂßãÊ∏≤ÊüìÂ§ßË∞±Ë°®MusicXML ==========');

                // 6.1 Â∞ÜÈí¢Áê¥ÂºïÊìéËæìÂá∫ËΩ¨Êç¢‰∏∫Ê†áÂáÜÂíåÂº¶ÂØπË±°Ê†ºÂºè
                const pianoChordProgression = finalGeneratedChords.map((result, index) => {
                    console.log(`üéπ ËΩ¨Êç¢Á¨¨${index + 1}Â∞èËäÇ‰∏∫Ê†áÂáÜÊ†ºÂºè:`, result);

                    // üîç ËØäÊñ≠Êó•Âøó (2025-10-02): ËØ¶ÁªÜÊòæÁ§∫ÂíåÂº¶‰ø°ÊÅØ
                    console.log(`üîç ÂíåÂº¶ËØäÊñ≠‰ø°ÊÅØ:`);
                    console.log(`  - chordInfo.type: ${result.chordInfo.type}`);
                    console.log(`  - chordInfo.is69Voicing: ${result.chordInfo.is69Voicing}`);
                    console.log(`  - tensionsÊï∞ÁªÑ: ${JSON.stringify(result.tensions)}`);
                    console.log(`  - tensionsÈïøÂ∫¶: ${result.tensions ? result.tensions.length : 'undefined'}`);

                    // üéµ Ê£ÄÊµãtensionsÂπ∂Êõ¥Êñ∞ÂíåÂº¶Á±ªÂûãÔºà2025-10-02Êñ∞Â¢ûÔºöÊîØÊåÅadd2/6/6/9ÂíåÂº¶‰ª£Âè∑ÊòæÁ§∫Ôºâ
                    let displayType = result.chordInfo.type;

                    // üéµ ‰ºòÂÖàÊ£ÄÊü•6/9ÂíåÂº¶Ôºà2025-10-02Êñ∞Â¢ûÔºâ
                    if (result.chordInfo.is69Voicing) {
                        displayType = '6/9';
                        console.log(`üéµ Ê£ÄÊµãÂà∞6/9ÂíåÂº¶Ê†áËÆ∞: ${result.chordInfo.root}maj7 ‚Üí ${result.chordInfo.root}6/9`);
                    } else if (result.tensions && result.tensions.length > 0) {
                        const tensions = result.tensions;
                        console.log(`üéµ Ê£ÄÊµãÂà∞tensions: ${tensions.join(', ')}`);

                        // Âà§Êñ≠ÊòØ‰∏âÂíåÂº¶ËøòÊòØ‰∏ÉÂíåÂº¶
                        const isTriad = !result.chordInfo.type.includes('7') &&
                                       !result.chordInfo.type.includes('9') &&
                                       !result.chordInfo.type.includes('11') &&
                                       !result.chordInfo.type.includes('13');

                        if (isTriad) {
                            // ‰∏âÂíåÂº¶ÔºöÊ∑ªÂä†add2Êàñ6ÂêéÁºÄ
                            if (tensions.includes('13')) {
                                // 6ÂíåÂº¶Ôºà13th = Â§ßÂÖ≠Â∫¶Ôºâ
                                if (result.chordInfo.type === 'major') {
                                    displayType = '6';
                                } else if (result.chordInfo.type === 'minor') {
                                    displayType = 'm6';
                                } else {
                                    displayType = result.chordInfo.type + '6';
                                }
                                console.log(`  ‚úÖ ‰∏âÂíåÂº¶+13Èü≥ ‚Üí 6ÂíåÂº¶: ${displayType}`);
                            } else if (tensions.includes('9')) {
                                // add2ÂíåÂº¶Ôºà9th = Â§ß‰∫åÂ∫¶Ôºâ
                                if (result.chordInfo.type === 'major') {
                                    displayType = 'add2';
                                } else if (result.chordInfo.type === 'minor') {
                                    displayType = 'madd2';
                                } else {
                                    displayType = result.chordInfo.type + 'add2';
                                }
                                console.log(`  ‚úÖ ‰∏âÂíåÂº¶+9Èü≥ ‚Üí add2ÂíåÂº¶: ${displayType}`);
                            }
                        } else {
                            // üîß ‰øÆÂ§ç (2025-10-02): ‰∏ÉÂíåÂº¶ÈúÄË¶ÅÂå∫ÂàÜÊ≠£Â∏∏tensionÂíå6/9ËΩ¨Êç¢Â§±Ë¥•
                            // major7ÂíåÂº¶Ê∑ªÂä†tensionÂêéÔºå‰ªçÁÑ∂ÊòæÁ§∫‰∏∫maj7Ôºà‰∏çÊòæÁ§∫‰∏∫maj9Á≠âÔºâ
                            // ‰ΩÜ6/9ËΩ¨Êç¢Â§±Ë¥•Êó∂Ôºà‰∏ÉÈü≥Ë¢´Ë∑≥ËøáÔºâÔºåÂ∫îËØ•ÊòæÁ§∫‰∏∫add2/6
                            if (result.chordInfo.type === 'major7' || result.chordInfo.type === 'maj7') {
                                // Ê£ÄÊü•ÊòØÂê¶‰∏∫6/9ËΩ¨Êç¢Â§±Ë¥•Ôºà‰∏ÉÈü≥Â∑≤Ë¢´Ë∑≥ËøáÔºâ
                                if (result.chordInfo.failed69Conversion) {
                                    // 6/9ËΩ¨Êç¢Â§±Ë¥•Ôºö‰∏ÉÈü≥Â∑≤Ë¢´Ë∑≥ËøáÔºåÂè™Êúâtensions
                                    if (tensions.includes('9') && tensions.includes('13')) {
                                        // ÂêåÊó∂Êúâ9Âíå13‰ΩÜÈ™åËØÅÂ§±Ë¥• ‚Üí ÂèØËÉΩÊòØ6add9
                                        displayType = '6add9';
                                        console.log(`  ‚ö†Ô∏è 6/9ËΩ¨Êç¢Â§±Ë¥•‰ΩÜÊúâ9+13 ‚Üí 6add9ÂíåÂº¶: ${displayType}`);
                                    } else if (tensions.includes('13') && !tensions.includes('9')) {
                                        // Âè™Êúâ13th ‚Üí 6ÂíåÂº¶
                                        displayType = '6';
                                        console.log(`  ‚ö†Ô∏è 6/9ËΩ¨Êç¢Â§±Ë¥•+‰ªÖ13Èü≥ ‚Üí 6ÂíåÂº¶: ${displayType}`);
                                    } else if (tensions.includes('9') && !tensions.includes('13')) {
                                        // Âè™Êúâ9th ‚Üí add2ÂíåÂº¶
                                        displayType = 'add2';
                                        console.log(`  ‚ö†Ô∏è 6/9ËΩ¨Êç¢Â§±Ë¥•+‰ªÖ9Èü≥ ‚Üí add2ÂíåÂº¶: ${displayType}`);
                                    }
                                } else {
                                    // Ê≠£Â∏∏ÁöÑmajor7ÂíåÂº¶ + tensions ‚Üí ‰øùÊåÅ‰∏∫maj7
                                    console.log(`  ‚úÖ major7ÂíåÂº¶Ê∑ªÂä†tensionsÂêé‰øùÊåÅÊòæÁ§∫‰∏∫maj7`);
                                    // displayTypeÂ∑≤ÁªèÊòØ'major7'Ôºå‰∏çÈúÄË¶Å‰øÆÊîπ
                                }
                            } else {
                                // ÂÖ∂‰ªñ‰∏ÉÂíåÂº¶ÔºötensionsÂ∑≤ÁªèÂåÖÂê´Âú®Âéütype‰∏≠ÔºàÂ¶Çmaj9, m11Á≠âÔºâ
                                console.log(`  ‚ÑπÔ∏è ‰∏ÉÂíåÂº¶tensions‰øùÊåÅÂéütype: ${displayType}`);
                            }
                        }
                    }

                    // üéº ÂàõÂª∫ÂÖºÂÆπÁé∞ÊúâMusicXMLÁ≥ªÁªüÁöÑÂíåÂº¶ÂØπË±°
                    const formattedChord = {
                        root: result.chordInfo.root,
                        type: displayType,  // üîß ‰øÆÊîπÔºö‰ΩøÁî®Êõ¥Êñ∞ÂêéÁöÑdisplayType
                        quality: result.chordInfo.quality,
                        // üéπ Èí¢Áê¥‰∏ìÁî®Ê†áËÆ∞ÔºöÂåÖÂê´ÂèåË∞±Ë°®MIDIÊï∞ÊçÆ
                        isPianoMode: true,
                        pianoData: {
                            bassClefMidi: result.bassClefNotes,
                            trebleClefMidi: result.trebleClefNotes,
                            noteCount: result.noteCount
                        },
                        // ÂàõÂª∫ÂÖºÂÆπvoicingÂØπË±°‰æõMusicXMLÁ≥ªÁªü‰ΩøÁî®
                        voicing: {
                            type: `piano-${result.noteCount}notes`,
                            midiNotes: result.allNotes, // ÊâÄÊúâÈü≥Á¨¶ÊåâÈü≥È´òÊéíÂ∫è
                            notes: result.allNotes.map(midi => {
                                // ÁÆÄÂçïÁöÑMIDIÂà∞Èü≥Á¨¶ÂêçÁß∞ËΩ¨Êç¢ÔºàÂêéÁª≠Áî±midiToPitchInfoÁ≤æÁ°ÆÂ§ÑÁêÜÔºâ
                                const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                                const octave = Math.floor(midi / 12) - 1;
                                const noteIndex = midi % 12;
                                return noteNames[noteIndex] + octave;
                            })
                        }
                    };

                    console.log(`‚úÖ Á¨¨${index + 1}Â∞èËäÇËΩ¨Êç¢ÂÆåÊàê:`, formattedChord);
                    return formattedChord;
                });

                // 6.2 ÊûÑÂª∫ÂÆåÊï¥ÁöÑÂíåÂº¶ÂØπË±°‰æõdisplayChords‰ΩøÁî®

                // üéØ ÂÆâÂÖ®Âú∞ÊûÑÈÄ†keyInfoÂØπË±°ÔºàÂ¢ûÂº∫ÊñπÊ°àÔºöÁõ¥Êé•ÊûÑÈÄ†Ôºå‰∏ç‰æùËµñÊü•ÊâæÔºâ
                // üîß ‰øÆÂ§ç (2025-10-01): Èí¢Áê¥Ê®°ÂºèÊãºÂÜôÈóÆÈ¢ò - Á°Æ‰øùkeyInfoÊ≠£Á°Æ‰º†ÈÄí
                let keyInfo;

                // Â∞ùËØï‰ªéharmonyTheory.keysÊü•Êâæ
                if (window.harmonyTheory && window.harmonyTheory.keys && window.harmonyTheory.keys[key]) {
                    keyInfo = window.harmonyTheory.keys[key];
                    console.log(`‚úÖ ‰ªéharmonyTheory.keysÊü•ÊâæÂà∞keyInfo:`, keyInfo);
                } else {
                    // Êü•ÊâæÂ§±Ë¥•ÔºåÊâãÂä®ÊûÑÈÄ†keyInfoÂØπË±°
                    console.warn(`‚ö†Ô∏è harmonyTheory.keys[${key}]Êü•ÊâæÂ§±Ë¥•ÔºåÊâãÂä®ÊûÑÈÄ†keyInfo`);

                    // Ëß£ÊûêkeyÂ≠óÁ¨¶‰∏≤ÔºàÂ¶Ç "C-major", "a-minor", "Eb-major"Ôºâ
                    const [tonicStr, modeStr] = key.split('-');
                    const mode = modeStr || 'major';

                    // ÊâãÂä®ÊûÑÈÄ†keyInfoÔºàÂèÇËÄÉharmony-theory.jsÁöÑkeysÂØπË±°ÁªìÊûÑÔºâ
                    const sharpKeys = {
                        'G': 1, 'D': 2, 'A': 3, 'E': 4, 'B': 5, 'F#': 6, 'C#': 7
                    };
                    const flatKeys = {
                        'F': 1, 'Bb': 2, 'Eb': 3, 'Ab': 4, 'Db': 5, 'Gb': 6, 'Cb': 7
                    };

                    let sharps = 0;
                    let flats = 0;
                    let tonic = tonicStr;

                    if (mode === 'major') {
                        if (sharpKeys[tonicStr]) {
                            sharps = sharpKeys[tonicStr];
                        } else if (flatKeys[tonicStr]) {
                            flats = flatKeys[tonicStr];
                        }
                    } else if (mode === 'minor') {
                        // Â∞èË∞ÉÁöÑÂçáÈôçÂè∑Êï∞ÈáèÔºàÁõ∏ÂØπÂ§ßË∞É-3‰∏™ÂçáÂè∑Êàñ+3‰∏™ÈôçÂè∑Ôºâ
                        const minorSharpKeys = {
                            'e': 1, 'b': 2, 'f#': 3, 'c#': 4, 'g#': 5, 'd#': 6, 'a#': 7
                        };
                        const minorFlatKeys = {
                            'd': 1, 'g': 2, 'c': 3, 'f': 4, 'bb': 5, 'eb': 6, 'ab': 7
                        };

                        const tonicLower = tonicStr.toLowerCase();
                        if (minorSharpKeys[tonicLower]) {
                            sharps = minorSharpKeys[tonicLower];
                        } else if (minorFlatKeys[tonicLower]) {
                            flats = minorFlatKeys[tonicLower];
                        }

                        // Ë∞ÉÊï¥tonic‰∏∫È¶ñÂ≠óÊØçÂ∞èÂÜôÔºàÂ∞èË∞ÉÊÉØ‰æãÔºâ
                        tonic = tonicStr.charAt(0).toLowerCase() + tonicStr.slice(1);
                    }

                    keyInfo = {
                        tonic: tonic,
                        mode: mode,
                        sharps: sharps,
                        flats: flats
                    };

                    console.log(`üîß ÊâãÂä®ÊûÑÈÄ†keyInfo:`, keyInfo);
                }

                console.log(`üéØ ÊúÄÁªà‰ΩøÁî®ÁöÑkeyInfo:`, keyInfo, `(Âü∫‰∫éË∞ÉÂè∑: ${key})`);

                // üîç ËØäÊñ≠ÔºöÈ™åËØÅFb/CbËßÑÂàôÊòØÂê¶Â∫îËØ•Ëß¶Âèë
                if (keyInfo.flats >= 6) {
                    console.log(`üéµ ËØäÊñ≠ÔºöË∞ÉÂè∑Êúâ${keyInfo.flats}‰∏™ÈôçÂè∑ÔºåÂ∫îËØ•‰ΩøÁî®FbÂíåCb`);
                } else if (keyInfo.mode === 'minor' && keyInfo.tonic === 'Db') {
                    console.log(`üéµ ËØäÊñ≠ÔºödbÂ∞èË∞ÉÁâπÊÆäÊÉÖÂÜµÔºåÂ∫îËØ•‰ΩøÁî®Fb`);
                } else {
                    console.log(`üéµ ËØäÊñ≠ÔºöË∞ÉÂè∑${keyInfo.tonic}-${keyInfo.mode}Êúâ${keyInfo.flats}‰∏™ÈôçÂè∑/${keyInfo.sharps}‰∏™ÂçáÂè∑ÔºåÂ∫îËØ•‰ΩøÁî®EÂíåB`);
                }

                const chordsObject = {
                    progression: pianoChordProgression,
                    measures: pianoChordProgression.length,
                    key: 'C-major', // ‰øùÊåÅÂÆâÂÖ®ÁöÑÈªòËÆ§ÂÄº
                    keyInfo: keyInfo, // üéØ Êñ∞Â¢ûÔºöÁõ¥Êé•‰º†ÈÄíÊûÑÈÄ†Â•ΩÁöÑkeyInfoÂØπË±°
                    timestamp: Date.now(),
                    isPianoMode: true // üéπ Ê†áËÆ∞‰∏∫Èí¢Áê¥Ê®°Âºè
                };

                console.log('üéπ Èí¢Áê¥ÂíåÂº¶ÂØπË±°:', chordsObject);
                console.log('üîç ËØäÊñ≠ÔºöchordsObject.keyInfoÁ°ÆËÆ§:', chordsObject.keyInfo);

                // üîß ‰øÆÂ§ç (2025-10-01): Ê∑ªÂä†Âà∞ÂéÜÂè≤ËÆ∞ÂΩïÔºà‰Ωø‰∏ä‰∏ÄÊù°/‰∏ã‰∏ÄÊù°ÂäüËÉΩÊ≠£Â∏∏Â∑•‰ΩúÔºâ
                if (typeof window.currentChords !== 'undefined') {
                    window.currentChords = chordsObject;
                }
                if (typeof window.chordsHistory !== 'undefined' && typeof window.currentChordsIndex !== 'undefined') {
                    window.chordsHistory.push(chordsObject);
                    window.currentChordsIndex = window.chordsHistory.length - 1;
                    console.log(`üìã Â∑≤Ê∑ªÂä†Âà∞ÂéÜÂè≤ËÆ∞ÂΩï (Á¥¢Âºï: ${window.currentChordsIndex}, ÊÄªÊï∞: ${window.chordsHistory.length})`);
                }

                // 6.3 Ë∞ÉÁî®displayChordsÊ∏≤ÊüìÂà∞‰∫îÁ∫øË∞±
                // displayChords‰ºöËá™Âä®Ê£ÄÊµãÈí¢Áê¥Ê®°ÂºèÂπ∂‰ΩøÁî®Â§ßË∞±Ë°®Ê∏≤Êüì
                console.log('üéº Ë∞ÉÁî®displayChordsÊ∏≤ÊüìÂ§ßË∞±Ë°®...');
                displayChords(chordsObject);

                console.log('‚úÖ Èí¢Áê¥Â§ßË∞±Ë°®Ê∏≤ÊüìÂÆåÊàê');

            } catch (error) {
                console.error('‚ùå Èí¢Áê¥ÂíåÂº¶ÁîüÊàêÂ§±Ë¥•:', error);
                alert(`ÁîüÊàêÂ§±Ë¥•Ôºö${error.message}\nËØ∑Êü•ÁúãÊéßÂà∂Âè∞‰∫ÜËß£ËØ¶ÊÉÖ`);
            }

            console.log('üéπ ========== Èí¢Áê¥ÂíåÂº¶ÁîüÊàêÁªìÊùü ==========');
        }

        // ‰øùÂ≠òËÆæÁΩÆÁöÑÂáΩÊï∞ÔºàÁÆÄÂåñÁâàÊú¨Ôºâ

        function saveRhythmSettings() {
            console.log('üíæ ‰øùÂ≠òËäÇÂ•èËÆæÁΩÆ...');
            // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†ÂÆûÈôÖÁöÑ‰øùÂ≠òÈÄªËæë

            // üîß 2025-10-01 ‰øÆÂ§çÔºöÊõ¥Êñ∞Âä®ÊÄÅÊéß‰ª∂ÁøªËØë
            updateDynamicControlsTranslation();
            console.log('üîÑ Â∑≤Êõ¥Êñ∞Âä®ÊÄÅÊéß‰ª∂ÁøªËØë');

            closeRhythmSettings();
            console.log('‚úÖ ËäÇÂ•èËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºåÂºπÁ™óÂ∑≤ÂÖ≥Èó≠');
        }

        function saveKeySettings() {
            console.log('üíæ ‰øùÂ≠òË∞ÉÂè∑ËÆæÁΩÆ...');

            // üîç ËØäÊñ≠ÔºöËÆ∞ÂΩï‰øùÂ≠òÂâçÁöÑÂäüËÉΩÂíåÂ£∞Áä∂ÊÄÅ
            const functionalToggleBefore = document.getElementById('functionalHarmonyToggle');
            const stateBefore = {
                toggleExists: !!functionalToggleBefore,
                toggleChecked: functionalToggleBefore ? functionalToggleBefore.checked : null,
                chordSettingsExists: typeof window.chordSettings !== 'undefined',
                useFunctionalHarmony: window.chordSettings ? window.chordSettings.useFunctionalHarmony : null
            };
            console.log('üîç ‰øùÂ≠òÂâçÁä∂ÊÄÅ:', stateBefore);

            // Ëé∑ÂèñÊâÄÊúâÈÄâ‰∏≠ÁöÑË∞ÉÂè∑
            const selectedKeys = [];
            const keyCheckboxes = document.querySelectorAll('#keySignatureModal input[type="checkbox"]:checked');

            console.log(`üîç ÊâæÂà∞${keyCheckboxes.length}‰∏™ÈÄâ‰∏≠ÁöÑË∞ÉÂè∑checkbox`);
            keyCheckboxes.forEach(checkbox => {
                selectedKeys.push(checkbox.value);
                console.log(`  ‚úÖ ÈÄâ‰∏≠Ë∞ÉÂè∑: ${checkbox.value}`);
            });

            console.log(`üéØ ÊÄªÂÖ±Êî∂ÈõÜ‰∫Ü${selectedKeys.length}‰∏™Ë∞ÉÂè∑:`, selectedKeys);

            // ‰øùÂ≠òÂà∞ÂÖ®Â±ÄËÆæÁΩÆ (‰ΩøÁî®Ê≠£Á°ÆÁöÑkeysÂ≠óÊÆµ)
            if (typeof window.chordSettings !== 'undefined') {
                // üîß 2025-09-30 ‰øÆÂ§çÔºö‰øùÂ≠òË∞ÉÂè∑ËÆæÁΩÆÊó∂‰øùÁïôÂäüËÉΩÂíåÂ£∞Ê®°ÂºèÁä∂ÊÄÅ
                // ÈóÆÈ¢òÔºöÂè™Êõ¥Êñ∞keysÂèØËÉΩ‰∏ç‰ºö‰øùÁïôÂÖ∂‰ªñËÆæÁΩÆ
                // Ëß£ÂÜ≥ÔºöÊòéÁ°Æ‰øùÁïô useFunctionalHarmony ÁöÑÂΩìÂâçÂÄº
                const currentFunctionalState = window.chordSettings.useFunctionalHarmony;
                window.chordSettings.keys = selectedKeys;
                // Á°Æ‰øùÂäüËÉΩÂíåÂ£∞Áä∂ÊÄÅ‰∏çË¢´ÊîπÂèò
                window.chordSettings.useFunctionalHarmony = currentFunctionalState;
                console.log('üéØ Â∑≤‰øùÂ≠òË∞ÉÂè∑ËÆæÁΩÆÂà∞ chordSettings.keys:', selectedKeys);
                console.log('üîí ÂäüËÉΩÂíåÂ£∞Áä∂ÊÄÅ‰øùÊåÅ‰∏çÂèò:', currentFunctionalState);
            } else {
                // üîß ‰øÆÂ§çÔºöÂ¶ÇÊûúchordSettings‰∏çÂ≠òÂú®ÔºåÂàõÂª∫‰∏Ä‰∏™Â∏¶ÈªòËÆ§ÂÄºÁöÑÂØπË±°
                // ÈáçË¶ÅÔºö‰∏çË¶ÅË¶ÜÁõñÂ∑≤Â≠òÂú®ÁöÑchordSettingsÔºÅ
                if (!window.chordSettings) {
                    window.chordSettings = {
                        keys: selectedKeys,
                        useFunctionalHarmony: true  // ‰øùÁïôÈªòËÆ§ÁöÑÂäüËÉΩÂíåÂ£∞Ê®°ÂºèÁä∂ÊÄÅ
                    };
                } else {
                    window.chordSettings.keys = selectedKeys;
                }
                console.log('üéØ Â∑≤ÂàõÂª∫Âπ∂‰øùÂ≠òË∞ÉÂè∑ËÆæÁΩÆÂà∞ chordSettings.keys:', selectedKeys);
            }

            // Êõ¥Êñ∞ÊòæÁ§∫Áä∂ÊÄÅ
            updateKeySettingsDisplay(selectedKeys);

            closeKeySignatureSettings();

            // üîç ËØäÊñ≠ÔºöËÆ∞ÂΩï‰øùÂ≠òÂêéÁöÑÂäüËÉΩÂíåÂ£∞Áä∂ÊÄÅ
            const functionalToggleAfter = document.getElementById('functionalHarmonyToggle');
            const stateAfter = {
                toggleExists: !!functionalToggleAfter,
                toggleChecked: functionalToggleAfter ? functionalToggleAfter.checked : null,
                chordSettingsExists: typeof window.chordSettings !== 'undefined',
                useFunctionalHarmony: window.chordSettings ? window.chordSettings.useFunctionalHarmony : null
            };
            console.log('üîç ‰øùÂ≠òÂêéÁä∂ÊÄÅ:', stateAfter);

            // üö® Ê£ÄÊµãÁä∂ÊÄÅÂèòÂåñ
            if (stateBefore.toggleChecked !== stateAfter.toggleChecked) {
                console.warn('üö® Ë≠¶ÂëäÔºöÂäüËÉΩÂíåÂ£∞toggleÁä∂ÊÄÅÂèëÁîü‰∫ÜÂèòÂåñÔºÅ');
                console.warn(`   - ÂèòÂåñÂâç: ${stateBefore.toggleChecked}`);
                console.warn(`   - ÂèòÂåñÂêé: ${stateAfter.toggleChecked}`);
            }
            if (stateBefore.useFunctionalHarmony !== stateAfter.useFunctionalHarmony) {
                console.warn('üö® Ë≠¶ÂëäÔºöchordSettings.useFunctionalHarmonyÂèëÁîü‰∫ÜÂèòÂåñÔºÅ');
                console.warn(`   - ÂèòÂåñÂâç: ${stateBefore.useFunctionalHarmony}`);
                console.warn(`   - ÂèòÂåñÂêé: ${stateAfter.useFunctionalHarmony}`);
            }

            // üîß 2025-09-30 ‰øÆÂ§çÔºöÊõ¥Êñ∞Âä®ÊÄÅÊéß‰ª∂ÁøªËØëÔºåÁ°Æ‰øùlabelÊñáÂ≠ó‰∏étoggleÁä∂ÊÄÅÂêåÊ≠•
            // ÈóÆÈ¢òÔºöapplyTranslations()‰ºöÂ∞ÜharmonyModeLabelÈáçÁΩÆ‰∏∫data-i18nÁöÑÈªòËÆ§ÂÄº"ÈöèÊú∫Ê®°Âºè"
            // Ëß£ÂÜ≥ÔºöË∞ÉÁî®updateDynamicControlsTranslation()Ê†πÊçÆtoggleÂÆûÈôÖÁä∂ÊÄÅÊõ¥Êñ∞ÊñáÂ≠ó
            updateDynamicControlsTranslation();
            console.log('üîÑ Â∑≤Êõ¥Êñ∞Âä®ÊÄÅÊéß‰ª∂ÁøªËØëÔºåÁ°Æ‰øùÂäüËÉΩÂíåÂ£∞labelÊñáÂ≠óÊ≠£Á°Æ');

            console.log('‚úÖ Ë∞ÉÂè∑ËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºåÂºπÁ™óÂ∑≤ÂÖ≥Èó≠');
        }

        function updateKeySettingsDisplay(selectedKeys) {
            const keyBtn = document.getElementById('keySettingsBtn');
            if (keyBtn) {
                // ÂßãÁªàÊòæÁ§∫Âõ∫ÂÆöÁöÑ"Ë∞ÉÂè∑ËÆæÁΩÆ"ÊñáÊú¨Ôºå‰∏çÊòæÁ§∫ÂÖ∑‰ΩìÊï∞Èáè
                keyBtn.textContent = translate('controls.KeySettings');
                console.log(`üéØ Ë∞ÉÂè∑ÊåâÈíÆ‰øùÊåÅÂõ∫ÂÆöÊòæÁ§∫: ${translate('controls.KeySettings')} (Â∑≤ÈÄâÊã©${selectedKeys ? selectedKeys.length : 0}‰∏™Ë∞ÉÂè∑)`);
            }
        }

        function saveTimeSignatureSettings() {
            console.log('üíæ ‰øùÂ≠òÊãçÂè∑ËÆæÁΩÆ...');
            // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†ÂÆûÈôÖÁöÑ‰øùÂ≠òÈÄªËæë

            // üîß 2025-10-01 ‰øÆÂ§çÔºöÊõ¥Êñ∞Âä®ÊÄÅÊéß‰ª∂ÁøªËØë
            updateDynamicControlsTranslation();
            console.log('üîÑ Â∑≤Êõ¥Êñ∞Âä®ÊÄÅÊéß‰ª∂ÁøªËØë');

            closeTimeSignatureSettings();
            console.log('‚úÖ ÊãçÂè∑ËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºåÂºπÁ™óÂ∑≤ÂÖ≥Èó≠');
        }

        function saveClefSettings() {
            console.log('üíæ ‰øùÂ≠òË∞±Âè∑ËÆæÁΩÆ...');
            // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†ÂÆûÈôÖÁöÑ‰øùÂ≠òÈÄªËæë

            // üîß 2025-10-01 ‰øÆÂ§çÔºöÊõ¥Êñ∞Âä®ÊÄÅÊéß‰ª∂ÁøªËØë
            updateDynamicControlsTranslation();
            console.log('üîÑ Â∑≤Êõ¥Êñ∞Âä®ÊÄÅÊéß‰ª∂ÁøªËØë');

            closeClefSettings();
            console.log('‚úÖ Ë∞±Âè∑ËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºåÂºπÁ™óÂ∑≤ÂÖ≥Èó≠');
        }

        // Â¢ûÂº∫ÁøªËØëÂ∫îÁî®ÂäüËÉΩ
        function applyTranslationsToModals() {
            // üîß ‰ΩøÁî® I18n Á≥ªÁªü (2025-10-04)
            // Âº∫Âà∂ÈáçÊñ∞Â∫îÁî®ÁøªËØëÂà∞ÊâÄÊúâÊ®°ÊÄÅÊ°Ü
            if (window.I18n && window.I18n.applyLanguage) {
                window.I18n.applyLanguage(currentLanguage);
                console.log('üåê Ê®°ÊÄÅÊ°ÜÁøªËØëÂ∑≤ÈÄöËøáI18nÁ≥ªÁªüÈáçÊñ∞Â∫îÁî®');
            } else {
                console.warn('‚ö†Ô∏è I18nÁ≥ªÁªüÊú™Âä†ËΩΩÔºåÊó†Ê≥ïÂ∫îÁî®Ê®°ÊÄÅÊ°ÜÁøªËØë');
            }
        }

        // ÈáçÂÜôËØ≠Ë®ÄÂàáÊç¢ÂáΩÊï∞‰ª•Á°Æ‰øùÊ®°ÊÄÅÊ°ÜÁøªËØë
        function switchLanguage(language) {
            currentLanguage = language;
            localStorage.setItem('preferredLanguage', language);
            applyTranslations();
            applyTranslationsToModals(); // È¢ùÂ§ñÂ∫îÁî®Ê®°ÊÄÅÊ°ÜÁøªËØë
            updateDynamicControlsTranslation(); // Êõ¥Êñ∞Âä®ÊÄÅÊéß‰ª∂ÁøªËØë

            // Ëß¶ÂèëÁªü‰∏ÄÂêåÊ≠•Á≥ªÁªü (ÂêåÊ†áÁ≠æÈ°µÂÜÖÂÆûÊó∂ÂêåÊ≠•)
            if (window.ICStudioSync) {
                window.ICStudioSync.syncLanguage(language, 'chord-tool');
            }

            // ÂÖ≥Èó≠ËÆæÁΩÆËèúÂçï
            if (typeof closeSettings === 'function') {
                closeSettings();
            }

            console.log(`üåê ÂíåÂº¶ËßÜÂ•èÂ∑•ÂÖ∑ËØ≠Ë®ÄÂ∑≤ÂàáÊç¢‰∏∫: ${language}ÔºåÊ®°ÊÄÅÊ°ÜÁøªËØëÂ∑≤Êõ¥Êñ∞`);
        }

        // ‚å®Ô∏è ÂÖ®Â±ÄÈîÆÁõòÂø´Êç∑ÈîÆ
        document.addEventListener('keydown', function(e) {
            // Â¶ÇÊûúÂú®ËæìÂÖ•Ê°Ü„ÄÅÊñáÊú¨Ê°ÜÊàñÊ®°ÊÄÅÊ°ÜËæìÂÖ•‰∏≠Ôºå‰∏çËß¶ÂèëÂø´Êç∑ÈîÆ
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                return;
            }

            // Ê£ÄÊü•ÊòØÂê¶ÊúâÊ®°ÊÄÅÊ°ÜÊâìÂºÄÔºàÈÅøÂÖçÂú®ËÆæÁΩÆ‰∏≠Ëß¶ÂèëÔºâ
            const hasOpenModal = document.querySelector('.modal:not([style*="display: none"])');
            if (hasOpenModal) {
                return;
            }

            const key = e.key.toLowerCase();

            switch(key) {
                case 'p':
                    // Êí≠Êîæ/ÊöÇÂÅúÊí≠Êîæ
                    e.preventDefault();
                    if (typeof directPlayTest === 'function') {
                        directPlayTest();
                        console.log('‚å®Ô∏è Âø´Êç∑ÈîÆ: P - Êí≠Êîæ/ÊöÇÂÅú');
                    }
                    break;

                case 'arrowleft':
                    // ‰∏ä‰∏ÄÊù°
                    e.preventDefault();
                    if (typeof previousChords === 'function') {
                        previousChords();
                        console.log('‚å®Ô∏è Âø´Êç∑ÈîÆ: ‚Üê - ‰∏ä‰∏ÄÊù°');
                    }
                    break;

                case 'arrowright':
                    // ‰∏ã‰∏ÄÊù°
                    e.preventDefault();
                    if (typeof nextChords === 'function') {
                        nextChords();
                        console.log('‚å®Ô∏è Âø´Êç∑ÈîÆ: ‚Üí - ‰∏ã‰∏ÄÊù°');
                    }
                    break;

                case ' ':
                    // ÁîüÊàêÔºàÁ©∫Ê†ºÈîÆÔºâ
                    e.preventDefault();
                    const generateBtn = document.getElementById('generateChordsBtn');
                    if (generateBtn) {
                        generateBtn.click();
                        console.log('‚å®Ô∏è Âø´Êç∑ÈîÆ: Space - ÁîüÊàêÂíåÂº¶');
                    }
                    break;

                case 'h':
                    // ÈöêËóè/ÊòæÁ§∫
                    e.preventDefault();
                    if (typeof toggleMelodyVisibility === 'function') {
                        toggleMelodyVisibility();
                        console.log('‚å®Ô∏è Âø´Êç∑ÈîÆ: H - ÈöêËóè/ÊòæÁ§∫');
                    }
                    break;

                case 'c':
                    // ËäÇÊãçÂô®ÂºÄÂÖ≥
                    e.preventDefault();
                    if (typeof toggleMetronome === 'function') {
                        toggleMetronome();
                        console.log('‚å®Ô∏è Âø´Êç∑ÈîÆ: C - ËäÇÊãçÂô®ÂºÄÂÖ≥');
                    }
                    break;
            }
        });

        console.log('‚å®Ô∏è ÂíåÂº¶ËßÜÂ•èÂ∑•ÂÖ∑Âø´Êç∑ÈîÆÂ∑≤ÂêØÁî®: P=Êí≠Êîæ ‚Üê‚Üí=ÂØºËà™ Space=ÁîüÊàê H=ÈöêËóè C=ËäÇÊãçÂô®');

        /* ========== ÊóßÁöÑËØïÁî®ÈôêÂà∂ÁÆ°ÁêÜÁ≥ªÁªü (Â∑≤Á¶ÅÁî®ÔºåÁé∞‰ΩøÁî®Áªü‰∏ÄÁöÑ melody-counter-system.js) ==========
        // ========== ËØïÁî®ÈôêÂà∂ÁÆ°ÁêÜÁ≥ªÁªü ==========
        const TrialManager = {
            maxTrialUses: 20, // ÂÖçË¥πËØïÁî®ÊúÄÂ§ßÊ¨°Êï∞

            // Ê£ÄÊü•ÊòØÂê¶‰∏∫ÂÆåÊï¥ÁâàÁî®Êà∑
            isFullVersion() {
                return localStorage.getItem('ic_full_version') === 'true';
            },

            // Ëé∑ÂèñÂΩìÂâçËØïÁî®Ê¨°Êï∞
            getTrialCount() {
                const count = localStorage.getItem('ic_trial_count');
                return count ? parseInt(count) : 0;
            },

            // Â¢ûÂä†ËØïÁî®Ê¨°Êï∞
            incrementTrialCount() {
                const currentCount = this.getTrialCount();
                const newCount = currentCount + 1;
                localStorage.setItem('ic_trial_count', newCount.toString());
                return newCount;
            },

            // Ëé∑ÂèñÂâ©‰ΩôËØïÁî®Ê¨°Êï∞
            getRemainingTrials() {
                return Math.max(0, this.maxTrialUses - this.getTrialCount());
            },

            // Ê£ÄÊü•ÊòØÂê¶ÂèØ‰ª•ÁªßÁª≠‰ΩøÁî®
            canUse() {
                return this.isFullVersion() || this.getRemainingTrials() > 0;
            },

            // Êõ¥Êñ∞ËØïÁî®‰ø°ÊÅØÊòæÁ§∫
            updateTrialDisplay() {
                const trialInfo = document.getElementById('trialInfo');
                const trialCounter = document.getElementById('trialCounter');

                if (this.isFullVersion()) {
                    // ÂÆåÊï¥ÁâàÁî®Êà∑ÔºöÈöêËóèÊâÄÊúâËØïÁî®Áõ∏ÂÖ≥ÊòæÁ§∫
                    if (trialInfo) {
                        trialInfo.style.display = 'none';
                    }
                    if (trialCounter) {
                        trialCounter.style.display = 'none';
                    }
                } else {
                    // ËØïÁî®ÁâàÁî®Êà∑ÔºöÈöêËóèheader‰∏≠ÁöÑÊèêÁ§∫ÔºåÂè™Âú®ÊåâÈíÆÊóÅÊòæÁ§∫ÁÆÄÂçïÊï∞Â≠ó
                    if (trialInfo) {
                        trialInfo.style.display = 'none';
                    }
                    if (trialCounter) {
                        const remaining = this.getRemainingTrials();
                        if (remaining > 0) {
                            trialCounter.innerHTML = `${remaining}`;
                            trialCounter.style.display = 'inline-block';
                        } else {
                            trialCounter.innerHTML = '0';
                            trialCounter.style.display = 'inline-block';
                        }
                    }
                }
            },

            // ÊòæÁ§∫ËØïÁî®ÈôêÂà∂Ë≠¶Âëä
            showTrialLimitWarning() {
                // ÈùôÈªòÂ§ÑÁêÜÔºöËØïÁî®Ê¨°Êï∞Áî®ÂÆåÂêé‰∏çÊòæÁ§∫‰ªª‰ΩïÊèêÁ§∫ÔºåÁõ¥Êé•ËøîÂõû false
                return false;
            },

            // È™åËØÅËÆøÈóÆÁ†Å
            validateAccessCode(code) {
                // ËøôÈáåÂèØ‰ª•ËÆæÁΩÆÂ§ö‰∏™ÊúâÊïàÁöÑËÆøÈóÆÁ†Å
                const validCodes = [
                    'IC2025FULL',
                    'ICSTUDIO2025',
                    'SIGHT2025',
                    'CHORD2025'
                ];
                return validCodes.includes(code.toUpperCase());
            }
        };
        ========== ÊóßÁöÑËØïÁî®ÈôêÂà∂ÁÆ°ÁêÜÁ≥ªÁªüÁªìÊùü ========== */

    </script>

    <!-- ËØïÁî®ÈôêÂà∂Á≥ªÁªüËÑöÊú¨ -->
    <script src="/js/trial-limiter.js?v=20250909"></script>
    <script src="/js/advanced-trial-protection.js?v=20250920"></script>
    <script src="/js/melody-counter-system.js?v=20250920"></script>
    <script src="/js/integrated-trial-manager.js?v=20250920"></script>


    <!-- ========== ‰∫ßÂìÅÊùÉÈôêÊéßÂà∂Á≥ªÁªü ========== -->
    <script>
    (function() {
        'use strict';

        const FEATURE_CONFIG = {
            'melody': { name: 'ÊóãÂæãËßÜÂ•è', icon: 'üéµ', url: 'melody-generator.html' },
            'interval': { name: 'Èü≥Á®ãËßÜÂ•è', icon: 'üéº', url: 'interval-generator.html' },
            'chord': { name: 'ÂíåÂº¶ËßÜÂ•è', icon: 'üéπ', url: 'chord-generator.html' }
        };

        function hasFeatureAccess(featureName) {
            if (localStorage.getItem('ic_full_version') === 'true') {
                return true;
            }

            const accessCodeData = localStorage.getItem('ic_access_code_data');
            if (!accessCodeData) {
                return false;
            }

            try {
                const data = JSON.parse(accessCodeData);

                if (data.features && Array.isArray(data.features)) {
                    return data.features.includes(featureName);
                }

                if (data.productType === 'all') {
                    return true;
                }

            } catch (e) {
                console.error('Ëß£ÊûêËÆøÈóÆÁ†ÅÊï∞ÊçÆÂ§±Ë¥•:', e);
                return false;
            }

            return false;
        }

        function showUpgradeDialog(featureName) {
            const feature = FEATURE_CONFIG[featureName];
            if (!feature) return;

            const dialog = document.createElement('div');
            dialog.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';

            dialog.innerHTML = '<div style="background: white; padding: 40px; border-radius: 16px; max-width: 500px; width: 100%; text-align: center; box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);"><div style="font-size: 64px; margin-bottom: 20px;">' + feature.icon + '</div><h2 style="color: #333; margin-bottom: 15px;">Ëß£ÈîÅ ' + feature.name + ' ÂäüËÉΩ</h2><p style="color: #666; font-size: 16px; line-height: 1.6; margin-bottom: 30px;">ÊÇ®ÂΩìÂâçÊ≤°Êúâ ' + feature.name + ' ÂäüËÉΩÁöÑËÆøÈóÆÊùÉÈôê„ÄÇ<br>ËØ∑Ë¥≠‰π∞ÂçïÁã¨ÂäüËÉΩÊàñ‰∏âÂêà‰∏ÄÂ•óÈ§ê‰ª•Ëß£ÈîÅ„ÄÇ</p><div style="display: flex; gap: 15px; justify-content: center;"><button onclick="this.closest(\'div\').parentElement.remove()" style="padding: 15px 30px; background: #f8f9fa; color: #333; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px;">ËøîÂõû</button><button onclick="window.location.href=\'/sight-reading-tool-page\'" style="padding: 15px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">üõí Á´ãÂç≥Ë¥≠‰π∞</button></div></div>';

            document.body.appendChild(dialog);
        }

        const originalSwitchFunction = window.switchFunction;
        if (originalSwitchFunction) {
            window.switchFunction = function(mode) {
                if (!hasFeatureAccess(mode)) {
                    showUpgradeDialog(mode);
                    return;
                }
                originalSwitchFunction(mode);
            };
            console.log('‚úÖ ‰∫ßÂìÅÊùÉÈôêÊéßÂà∂Â∑≤ÂêØÁî®');
        }

        document.addEventListener('DOMContentLoaded', function() {
            const currentFeature = 'chord';
            if (!hasFeatureAccess(currentFeature)) {
                showUpgradeDialog(currentFeature);
            }
        });

    })();
    console.log('‚úÖ ÂíåÂº¶ËßÜÂ•èÂ∑•ÂÖ∑ÊùÉÈôêÊéßÂà∂Â∑≤Âä†ËΩΩ');
    </script>

</body></html>
