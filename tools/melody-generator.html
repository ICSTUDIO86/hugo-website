<!DOCTYPE html>
<!-- saved from url=(0303)file:///Users/igorchen/Downloads/IC%20Studio/IC%20%E8%A7%86%E5%A5%8F%E5%B7%A5%E5%85%B7%20%E7%AC%AC%E4%B8%80%E7%89%88%20(%E5%B7%B2%E4%B8%8A%E6%9E%B6)%20%E9%9F%B3%E7%A8%8B%E4%BF%AE%E5%A4%8D%E4%B8%AD%202/%E8%A7%86%E5%A5%8F%E6%97%8B%E5%BE%8B%E7%94%9F%E6%88%90%E5%99%A8%20-%20%E7%BB%88%E6%9E%81%E7%89%88.html -->
<html lang="zh-CN" data-theme="dark"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IC ËßÜÂ•èÂ∑•ÂÖ∑</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com/">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="">
    <link href="./IC ÊóãÂæãËßÜÂ•èÂ∑•ÂÖ∑_files/css2" rel="stylesheet">
    
    <!-- OpenSheetMusicDisplay -->
    <script src="./IC ÊóãÂæãËßÜÂ•èÂ∑•ÂÖ∑_files/opensheetmusicdisplay.min.js"></script>

    <!-- Âà†Èô§SpessaSynth - ÊîπÁî®Êõ¥ÁÆÄÂçïÁöÑWeb Audio APIÊñπÊ°à -->

    <link rel="stylesheet" href="./IC ÊóãÂæãËßÜÂ•èÂ∑•ÂÖ∑_files/apple-ui-styles.css">
    <script src="assets/js/sample-player.js?v=6"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function(){
        try {
          if (!window.__icSamplePlayer && window.ICSamplePlayer) {
            window.__icSamplePlayer = new ICSamplePlayer({ rootPath: 'assets/samples/piano-ogg-full' });
            window.__icSamplePlayer.load();
          }
        } catch(e) { console.warn('ÈááÊ†∑Âô®ÂàùÂßãÂåñÂ§±Ë¥•:', e); }
      });
    </script>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="header-text">
                    <h1 data-i18n="app.title">IC Studio - ÊóãÂæãËßÜÂ•èÁîüÊàêÂô®</h1>
                    <p data-i18n="app.subtitle">‰∏ì‰∏öÁ∫ß‰πêË∞±Ê∏≤Êüì‰∏éÈü≥‰πêÁêÜËÆ∫Â∑•ÂÖ∑</p>
                </div>
                <div class="header-controls">
                    <div class="function-selector">
                        <button class="function-btn" id="functionBtn" onclick="toggleFunctionSelector()">
                            üéµ <span id="currentFunction" data-i18n="app.melodyMode">ÊóãÂæãËßÜÂ•è</span>
                        </button>
                        <div class="function-menu" id="functionMenu">
                            <div class="function-option" onclick="switchFunction('melody')">
                                <span class="function-icon">üéµ</span>
                                <span data-i18n="app.melodyMode">ÊóãÂæãËßÜÂ•è</span>
                            </div>
                            <div class="function-option" onclick="switchFunction('interval')">
                                <span class="function-icon">üéº</span>
                                <span data-i18n="app.intervalMode">Èü≥Á®ãËßÜÂ•è</span>
                            </div>
                            <div class="function-option" onclick="switchFunction('chord')">
                                <span class="function-icon">üéπ</span>
                                <span data-i18n="app.chordMode">ÂíåÂº¶ËßÜÂ•è</span>
                            </div>
                        </div>
                    </div>
                    <div class="settings-dropdown">
                        <button class="settings-btn" id="settingsBtn" onclick="toggleSettings()">
                            ‚öôÔ∏è <span data-i18n="settings.title">ËÆæÁΩÆ</span>
                        </button>
                        <div class="settings-menu" id="settingsMenu">
                            <!-- ‰∏ªÈ¢òËÆæÁΩÆ -->
                            <div class="settings-section">
                                <div class="settings-section-title" data-i18n="settings.theme">‰∏ªÈ¢ò</div>
                                <div class="theme-options">
                                    <div class="theme-option" onclick="setTheme('light')">
                                        <span class="theme-icon">‚òÄÔ∏è</span>
                                        <span data-i18n="settings.lightMode">ÊµÖËâ≤Ê®°Âºè</span>
                                    </div>
                                    <div class="theme-option" onclick="setTheme('dark')">
                                        <span class="theme-icon">üåô</span>
                                        <span data-i18n="settings.darkMode">Ê∑±Ëâ≤Ê®°Âºè</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ËØ≠Ë®ÄËÆæÁΩÆ -->
                            <div class="settings-section">
                                <div class="settings-section-title" data-i18n="settings.language">ËØ≠Ë®Ä</div>
                                <div class="language-options">
                                    <div class="language-option" onclick="switchLanguage('zh-CN')">
                                        ÁÆÄ‰Ωì‰∏≠Êñá
                                    </div>
                                    <div class="language-option" onclick="switchLanguage('zh-TW')">
                                        ÁπÅÈ´î‰∏≠Êñá
                                    </div>
                                    <div class="language-option" onclick="switchLanguage('en')">
                                        English
                                    </div>
                                </div>
                            </div>


                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="control-row">
                <div class="control-group">
                    <label data-i18n="controls.interval">Èü≥Á®ãË∑®Â∫¶</label>
                    <button class="btn-secondary" onclick="openIntervalSettings()" id="intervalSettingsBtn" data-i18n="controls.intervalSettings">Èü≥Á®ãËÆæÁΩÆ</button>
                </div>

                <div class="control-group">
                    <label data-i18n="controls.measures">Â∞èËäÇÊï∞</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="measures-2" name="measures" value="2">
                            <label for="measures-2" data-i18n="controls.measures2">2Â∞èËäÇ</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="measures-4" name="measures" value="4" checked="">
                            <label for="measures-4" data-i18n="controls.measures4">4Â∞èËäÇ</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="measures-8" name="measures" value="8">
                            <label for="measures-8" data-i18n="controls.measures8">8Â∞èËäÇ</label>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <label data-i18n="controls.key">Ë∞ÉÂè∑</label>
                    <button class="btn-secondary" onclick="openKeySettings()" id="keySettingsBtn" data-i18n="controls.keySettings">Ë∞ÉÂè∑ËÆæÁΩÆ</button>
                </div>

                <div class="control-group">
                    <label data-i18n="controls.time">ÊãçÂè∑</label>
                    <button class="btn-secondary" onclick="openTimeSignatureSettings()" id="timeSignatureSettingsBtn" data-i18n="controls.timeSettings">ÊãçÂè∑ËÆæÁΩÆ</button>
                </div>

                <div class="control-group">
                    <label data-i18n="controls.clef">Ë∞±Âè∑</label>
                    <button class="btn-secondary" onclick="openClefSettings()" id="clefSettingsBtn" data-i18n="controls.clefSettings">Ë∞±Âè∑ËÆæÁΩÆ</button>
                </div>
            </div>

            <!-- Êñ∞Â¢ûÔºöÈü≥ÂüüËÆæÁΩÆ -->
            <div class="control-row">
                <div class="control-group">
                    <label for="rangeMin" data-i18n="controls.rangeMin">ÊúÄ‰ΩéÈü≥</label>
                    <select id="rangeMin">
                        <option value="33">A1</option>
                        <option value="35">B1</option>
                        <option value="36">C2</option>
                        <option value="38">D2</option>
                        <option value="40">E2</option>
                        <option value="41">F2</option>
                        <option value="43">G2</option>
                        <option value="45">A2</option>
                        <option value="47">B2</option>
                        <option value="48">C3</option>
                        <option value="50">D3</option>
                        <option value="52">E3</option>
                        <option value="53">F3</option>
                        <option value="55">G3</option>
                        <option value="57">A3</option>
                        <option value="59">B3</option>
                        <option value="60" selected="">C4</option>
                        <option value="62">D4</option>
                        <option value="64">E4</option>
                        <option value="65">F4</option>
                        <option value="67">G4</option>
                        <option value="69">A4</option>
                        <option value="71">B4</option>
                        <option value="72">C5</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="rangeMax" data-i18n="controls.rangeMax">ÊúÄÈ´òÈü≥</label>
                    <select id="rangeMax">
                        <option value="48">C3</option>
                        <option value="50">D3</option>
                        <option value="52">E3</option>
                        <option value="53">F3</option>
                        <option value="55">G3</option>
                        <option value="57">A3</option>
                        <option value="59">B3</option>
                        <option value="60">C4</option>
                        <option value="62">D4</option>
                        <option value="64">E4</option>
                        <option value="65">F4</option>
                        <option value="67">G4</option>
                        <option value="69">A4</option>
                        <option value="71">B4</option>
                        <option value="72">C5</option>
                        <option value="74">D5</option>
                        <option value="76">E5</option>
                        <option value="77">F5</option>
                        <option value="79" selected="">G5</option>
                        <option value="81">A5</option>
                        <option value="82">B5</option>
                        <option value="83">C6</option>
                        <option value="84">D6</option>
                        <option value="85">E6</option>
                    </select>
                </div>

                <div class="control-group" style="flex: none; width: 140px;">
                    <label for="accidentalRate" data-i18n="controls.accidental">‰∏¥Êó∂ËÆ∞Âè∑</label>
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <input type="range" id="accidentalRate" min="0" max="100" value="0" step="10" style="width: 90px;">
                        <span id="accidentalRateValue" style="font-weight: 400; min-width: 30px;">0%</span>
                    </div>
                </div>

                <div class="control-group metronome-group" style="flex: none; width: 160px;">
                    <label for="headerMetronomeBpm" data-i18n="controls.metronome">ËäÇÊãçÂô®</label>
                    <div class="metronome-control">
                        <input type="number" id="headerMetronomeBpm" min="1" max="999" value="60" class="bpm-input-control">
                        <button class="metronome-play-btn" id="headerMetronomeBtn" onclick="toggleMetronome()" title="ÂºÄÂßã/ÂÅúÊ≠¢ËäÇÊãçÂô®">
                            üéµ
                        </button>
                        <div class="metronome-beat-indicator" id="headerBeatIndicator"></div>
                    </div>
                </div>
            </div>

            <div class="control-row">
                <div class="buttons">
                    <button class="btn-primary" onclick="generateMelody()" data-i18n="controls.generate">ÁîüÊàêÊóãÂæã</button>
                    <div class="button-group">
                        <button class="btn-secondary" onclick="previousMelody()" data-i18n="controls.previous">‰∏ä‰∏ÄÊù°</button>
                        <button class="btn-secondary" onclick="nextMelody()" data-i18n="controls.next">‰∏ã‰∏ÄÊù°</button>
                    </div>
                        <div class="button-group">
                            <button class="btn-secondary" id="playMelodyBtn" onclick="directPlayTest()" data-i18n="controls.play">Êí≠Êîæ</button>
                            <button class="melody-visibility-btn" id="melodyVisibilityBtn" onclick="toggleMelodyVisibility()" title="ÈöêËóè/ÊòæÁ§∫ÊóãÂæã">
                                üëÄ
                            </button>
                            
                        </div>
                    <div class="button-group">
                        <button class="btn-secondary" onclick="openRhythmSettings()" data-i18n="controls.rhythm">ËäÇÂ•èËÆæÁΩÆ</button>
                        <button class="btn-secondary" onclick="openArticulationSettings()" data-i18n="controls.articulation">ÊºîÂ•èÊäÄÂ∑ß</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="score-container">
            <div id="score" title="ÁÇπÂáªÁîüÊàêÊñ∞ÊóãÂæã" style="cursor: pointer;">
                <div class="empty-score-message">
                    <p data-i18n="score.empty">ÁÇπÂáªÁîüÊàêÊóãÂæãÂºÄÂßãÁªÉ‰π†</p>
                </div>
            </div>
        </div>
        
        <!-- Copyright Information -->
        <div style="
            padding: 5px 0;
            text-align: center;
            font-size: 14px;
            color: var(--neutral-dark);
            opacity: 0.7;
            border-top: 1px solid var(--border-color);
            margin-top: 7.5px;
        ">
            <p style="margin: 0; line-height: 1.5;">
                <strong>IC Studio ËßÜÂ•èÂ∑•ÂÖ∑</strong> - ‰∏ì‰∏öÁ∫ßËßÜÂ•èÊóãÂæãÁîüÊàêÂô®
            </p>
            <p style="margin: 8px 0 0 0; font-size: 13px; opacity: 0.8;">
                Copyright ¬© 2025. All rights reserved. Igor Chen - 
                <a href="https://icstudio.club/" target="_blank" style="color: var(--primary-blue); text-decoration: none;">icstudio.club</a>
            </p>
        </div>

    </div>

    <!-- ËäÇÂ•èËÆæÁΩÆÂºπÁ™ó -->
    <div id="rhythmModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="modal.rhythm.title">ËäÇÂ•èËÆæÁΩÆ</h3>
                <button class="close-btn" onclick="closeRhythmSettings()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="modal.rhythm.basicUnit">Âü∫Êú¨ËäÇÂ•èÂçï‰Ωç</h4>
                        <button class="btn-select-all" onclick="selectAllRhythms()" style="padding: 5px 10px; font-size: 12px; background: rgb(40, 167, 69); color: white; border: none; border-radius: 4px; cursor: pointer; transition: 0.3s;" data-i18n="button.selectAll">ÂÖ®ÈÄâ</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item" id="rhythm-whole-label">
                            <input type="checkbox" id="rhythm-whole" value="whole">
                            <span data-i18n="rhythm.whole">ÂÖ®Èü≥Á¨¶</span>
                        </label>
                        <label class="checkbox-item" id="rhythm-dotted-half-label" style="display: none;">
                            <input type="checkbox" id="rhythm-dotted-half" value="half.">
                            <span data-i18n="rhythm.dottedHalf">ÈôÑÁÇπ‰∫åÂàÜÈü≥Á¨¶</span>
                        </label>
                        <label class="checkbox-item" id="rhythm-half-label">
                            <input type="checkbox" id="rhythm-half" value="half" checked="">
                            <span data-i18n="rhythm.half">‰∫åÂàÜÈü≥Á¨¶</span>
                        </label>
                        <label class="checkbox-item" id="rhythm-dotted-quarter-label" style="display: none;">
                            <input type="checkbox" id="rhythm-dotted-quarter" value="quarter.">
                            <span data-i18n="rhythm.dottedQuarter">ÈôÑÁÇπÂõõÂàÜÈü≥Á¨¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="rhythm-quarter" value="quarter" checked="">
                            <span data-i18n="rhythm.quarter">ÂõõÂàÜÈü≥Á¨¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="rhythm-eighth" value="eighth" checked="">
                            <span data-i18n="rhythm.eighth">ÂÖ´ÂàÜÈü≥Á¨¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="rhythm-16th" value="16th">
                            <span data-i18n="rhythm.sixteenth">ÂçÅÂÖ≠ÂàÜÈü≥Á¨¶</span>
                        </label>
                        <label class="checkbox-item" id="rhythm-triplet-label" style="display: flex;">
                            <input type="checkbox" id="rhythm-triplet" value="triplet">
                            <span data-i18n="rhythm.triplet">‰∏âËøûÈü≥</span>
                        </label>
                        <label class="checkbox-item" id="rhythm-duplet-label" style="display: none;">
                            <input type="checkbox" id="rhythm-duplet" value="duplet">
                            <span data-i18n="rhythm.duplet">‰∫åËøûÈü≥</span>
                        </label>
                        <label class="checkbox-item" id="rhythm-quadruplet-label" style="display: none;">
                            <input type="checkbox" id="rhythm-quadruplet" value="quadruplet">
                            <span data-i18n="rhythm.quadruplet">ÂõõËøûÈü≥</span>
                        </label>
                    </div>
                </div>

                <!-- üî• ÈÄöÁî®ÈôÑÁÇπÈü≥Á¨¶ÈÄâÈ°π -->
                <div class="rhythm-section" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--info-border);">
                    <h4 style="margin-bottom: 15px;" data-i18n="rhythm.dottedOptions">ÈôÑÁÇπÈü≥Á¨¶ÈÄâÈ°π</h4>
                    <div style="background: var(--info-bg); padding: 15px; border-radius: 8px;">
                        <label class="checkbox-item" style="margin-bottom: 10px;">
                            <input type="checkbox" id="allowDottedNotes" value="dotted" checked>
                            <span data-i18n="rhythm.allowDotted">ÂÖÅËÆ∏ÈôÑÁÇπÈü≥Á¨¶ (Ê†πÊçÆÂ∑≤ÈÄâËäÇÂ•èËá™Âä®ÁîüÊàêÈôÑÁÇπÁâàÊú¨)</span>
                        </label>
                        <p style="font-size: 0.85rem; color: var(--secondary-text); margin: 0; line-height: 1.4;">
                            <span data-i18n="rhythm.dottedDesc">ÂãæÈÄâÂêéÂ∞ÜËá™Âä®‰∏∫Â∑≤ÈÄâÊã©ÁöÑËäÇÂ•èÁ±ªÂûãÁîüÊàêÈôÑÁÇπÁâàÊú¨</span><br>
                            <span data-i18n="rhythm.dottedExample">‰æãÂ¶ÇÔºöÂãæÈÄâÂõõÂàÜÈü≥Á¨¶+ÈôÑÁÇπÈü≥Á¨¶ ‚Üí ÂèØÁîüÊàêÂõõÂàÜÈü≥Á¨¶ÂíåÈôÑÁÇπÂõõÂàÜÈü≥Á¨¶</span>
                        </p>
                    </div>
                </div>

                <!-- È´òÁ∫ßËÆæÁΩÆÂå∫Âüü -->
                <div id="rhythmAdvancedSettings" style="display: none; margin-top: 20px; padding: 20px; background: var(--info-bg); border-radius: 8px; border: 2px solid var(--info-border);">
                    <h4 style="margin-bottom: 15px; color: var(--heading-text);" data-i18n="rhythm.advancedFreq">È´òÁ∫ßÈ¢ëÁéáËÆæÁΩÆ</h4>
                    <p style="font-size: 0.9rem; color: var(--secondary-text); margin-bottom: 20px;" data-i18n="rhythm.freqDesc">Ë∞ÉÊï¥ÂêÑËäÇÂ•èÂçï‰ΩçÂú®ÊóãÂæã‰∏≠ÁöÑÂá∫Áé∞È¢ëÁéá (0% = ‰∏ç‰ΩøÁî®, 100% = ‰ºòÂÖà‰ΩøÁî®)</p>
                    
                    <div class="rhythm-frequency-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="frequency-item" id="freq-whole-item">
                            <label for="freq-whole" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;" data-i18n="rhythm.freq.whole">ÂÖ®Èü≥Á¨¶È¢ëÁéá:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-whole" min="0" max="100" value="20" style="flex: 1;">
                                <span id="freq-whole-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">20%</span>
                            </div>
                        </div>
                        <div class="frequency-item" id="freq-dotted-half-item" style="display: none;">
                            <label for="freq-dotted-half" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;" data-i18n="rhythm.freq.dottedHalf">ÈôÑÁÇπ‰∫åÂàÜÈü≥Á¨¶È¢ëÁéá:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-dotted-half" min="0" max="100" value="12" style="flex: 1;">
                                <span id="freq-dotted-half-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">12%</span>
                            </div>
                        </div>
                        <div class="frequency-item" id="freq-half-item">
                            <label for="freq-half" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;" data-i18n="rhythm.freq.half">‰∫åÂàÜÈü≥Á¨¶È¢ëÁéá:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-half" min="0" max="100" value="8" style="flex: 1;">
                                <span id="freq-half-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">8%</span>
                            </div>
                        </div>
                        <div class="frequency-item" id="freq-dotted-quarter-item" style="display: none;">
                            <label for="freq-dotted-quarter" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;" data-i18n="rhythm.freq.dottedQuarter">ÈôÑÁÇπÂõõÂàÜÈü≥Á¨¶È¢ëÁéá:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-dotted-quarter" min="0" max="100" value="60" style="flex: 1;">
                                <span id="freq-dotted-quarter-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">60%</span>
                            </div>
                        </div>
                        <div class="frequency-item" id="freq-dotted-eighth-item" style="display: none;">
                            <label for="freq-dotted-eighth" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;" data-i18n="rhythm.freq.dottedEighth">ÈôÑÁÇπÂÖ´ÂàÜÈü≥Á¨¶È¢ëÁéá:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-dotted-eighth" min="0" max="100" value="25" style="flex: 1;">
                                <span id="freq-dotted-eighth-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">25%</span>
                            </div>
                        </div>
                        <div class="frequency-item">
                            <label for="freq-quarter" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;" data-i18n="rhythm.freq.quarter">ÂõõÂàÜÈü≥Á¨¶È¢ëÁéá:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-quarter" min="0" max="100" value="25" style="flex: 1;">
                                <span id="freq-quarter-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">25%</span>
                            </div>
                        </div>
                        <div class="frequency-item">
                            <label for="freq-eighth" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;" data-i18n="rhythm.freq.eighth">ÂÖ´ÂàÜÈü≥Á¨¶È¢ëÁéá:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-eighth" min="0" max="100" value="15" style="flex: 1;">
                                <span id="freq-eighth-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">15%</span>
                            </div>
                        </div>
                        <div class="frequency-item">
                            <label for="freq-16th" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;" data-i18n="rhythm.freq.sixteenth">ÂçÅÂÖ≠ÂàÜÈü≥Á¨¶È¢ëÁéá:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-16th" min="0" max="100" value="6" style="flex: 1;">
                                <span id="freq-16th-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">6%</span>
                            </div>
                        </div>
                        <div class="frequency-item" id="freq-triplet-item">
                            <label for="freq-triplet" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;" data-i18n="rhythm.freq.triplet">‰∏âËøûÈü≥È¢ëÁéá:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-triplet" min="0" max="100" value="15" style="flex: 1;">
                                <span id="freq-triplet-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">15%</span>
                            </div>
                        </div>
                        <div class="frequency-item" id="freq-duplet-item" style="display: none;">
                            <label for="freq-duplet" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">‰∫åËøûÈü≥È¢ëÁéá:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-duplet" min="0" max="100" value="25" style="flex: 1;">
                                <span id="freq-duplet-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">25%</span>
                            </div>
                        </div>
                        <div class="frequency-item" id="freq-quadruplet-item" style="display: none;">
                            <label for="freq-quadruplet" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">ÂõõËøûÈü≥È¢ëÁéá:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-quadruplet" min="0" max="100" value="20" style="flex: 1;">
                                <span id="freq-quadruplet-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">20%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn-secondary" onclick="resetRhythmFrequencies()" style="margin-right: 10px;" data-i18n="button.resetDefault">ËøîÂõûÈªòËÆ§</button>
                    </div>
                </div>
                
                <div class="modal-buttons">
                    <button class="btn-secondary" onclick="toggleRhythmAdvancedSettings()" id="rhythmAdvancedBtn" data-i18n="button.advanced">È´òÁ∫ßËÆæÁΩÆ</button>
                    <button class="btn-primary" onclick="saveRhythmSettings()" data-i18n="button.save">‰øùÂ≠òËÆæÁΩÆ</button>
                    <button class="btn-secondary" onclick="closeRhythmSettings()" data-i18n="button.cancel">ÂèñÊ∂à</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Articulations ÂºπÁ™ó -->
    <div id="articulationModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="modal.articulation.title">Articulations</h3>
                <button class="close-btn" onclick="closeArticulationSettings()">√ó</button>
            </div>
            <div class="modal-body">
                <!-- Âü∫Êú¨ArticulationÊäÄÂ∑ß -->
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="articulation.basic.title">Âü∫Êú¨ÊºîÂ•èÊ≥ï (Basic Articulations)</h4>
                        <button class="btn-select-all" onclick="selectAllBasicArticulations()" style="padding: 5px 10px; font-size: 12px; background: rgb(40, 167, 69); color: white; border: none; border-radius: 4px; cursor: pointer; transition: 0.3s;" data-i18n="button.selectAll">ÂÖ®ÈÄâ</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item" title="Êñ≠Â•è - Èü≥Á¨¶Êó∂ÂÄºÂáèÂçäÔºåËΩªÂø´Âú∞ÊºîÂ•è">
                            <input type="checkbox" id="art-staccato" value="staccato">
                            <span data-i18n="articulation.staccato">Staccato (Êñ≠Â•è) ‚Ä¢</span>
                        </label>
                        <label class="checkbox-item" title="ÈáçÈü≥ - Âº∫Ë∞ÉÊüê‰∫õÈü≥Á¨¶">
                            <input type="checkbox" id="art-accent" value="accent">
                            <span data-i18n="articulation.accent">Accent (ÈáçÈü≥) &gt;</span>
                        </label>
                        <label class="checkbox-item" title="Áü≠ÂÄöÈü≥ - Âø´ÈÄüÁöÑË£ÖÈ•∞Èü≥">
                            <input type="checkbox" id="art-acciaccatura" value="acciaccatura">
                            <span data-i18n="articulation.acciaccatura">Acciaccatura (Áü≠ÂÄöÈü≥)</span>
                        </label>
                    </div>
                </div>


                <!-- Âêâ‰ªñÁâπÊúâÊäÄÂ∑ß -->
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="articulation.guitar.title">Âêâ‰ªñÊäÄÂ∑ß (Guitar Techniques)</h4>
                        <button class="btn-select-all" onclick="selectAllGuitarTechniques()" style="padding: 5px 10px; font-size: 12px; background: rgb(40, 167, 69); color: white; border: none; border-radius: 4px; cursor: pointer; transition: 0.3s;" data-i18n="button.selectAll">ÂÖ®ÈÄâ</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item" title="ÂáªÂº¶ - Áî®Â∑¶ÊâãÊï≤Âáª‰∫ßÁîüÈü≥Á¨¶">
                            <input type="checkbox" id="gtr-hammer" value="hammer-on">
                            <span data-i18n="articulation.hammer">Hammer-on (ÂáªÂº¶) H</span>
                        </label>
                        <label class="checkbox-item" title="ÂãæÂº¶ - Áî®Â∑¶ÊâãÂãæÁ¶ª‰∫ßÁîüÈü≥Á¨¶">
                            <input type="checkbox" id="gtr-pull" value="pull-off">
                            <span data-i18n="articulation.pulloff">Pull-off (ÂãæÂº¶) P</span>
                        </label>
                        <!-- ÊöÇÊó∂ÈöêËóèglissandoÁõ∏ÂÖ≥ÈÄâÈ°πÔºåÂõ†‰∏∫OSMD‰∏çÊîØÊåÅÊ∏≤Êüì -->
                        <label class="checkbox-item" title="ÊªëÈü≥ - Âú®ÂìÅÊ†ºÈó¥ÊªëÂä®ÔºàÊ≥®ÔºöOSMDÊöÇ‰∏çÊîØÊåÅÊ∏≤ÊüìÔºâ" style="display: none;">
                            <input type="checkbox" id="gtr-glissando" value="glissando">
                            <span>Glissando (ÊªëÈü≥) /</span>
                        </label>
                        <label class="checkbox-item" title="ÊªëÂÖ• - ‰ªé‰∏ãÊñπÊªëÂÖ•‰∏ªÈü≥ÔºàÊ≥®ÔºöOSMDÊöÇ‰∏çÊîØÊåÅÊ∏≤ÊüìÔºâ" style="display: none;">
                            <input type="checkbox" id="gtr-slide-in" value="slide-in">
                            <span>Slide In (ÊªëÂÖ•)</span>
                        </label>
                        <label class="checkbox-item" title="ÊªëÂá∫ - ‰ªé‰∏ªÈü≥ÊªëÂá∫ÔºàÊ≥®ÔºöOSMDÊöÇ‰∏çÊîØÊåÅÊ∏≤ÊüìÔºâ" style="display: none;">
                            <input type="checkbox" id="gtr-slide-out" value="slide-out">
                            <span>Slide Out (ÊªëÂá∫)</span>
                        </label>
                    </div>
                </div>

                <!-- ÊöÇÊó∂ÈöêËóèglissandoÁõ∏ÂÖ≥ËØ¥Êòé -->
                <div style="padding: 10px 20px; color: #666; font-size: 12px; border-top: 1px solid #eee; margin-top: 10px; display: none;">
                    <small>* Ê≥®ÔºöÊ†áÊúâÊòüÂè∑ÁöÑÊäÄÂ∑ßÔºàGlissando„ÄÅSlide In/OutÔºâÁî±‰∫éOSMDÊ∏≤ÊüìÂºïÊìéÈôêÂà∂ÔºåÊöÇÊó∂‰ºöÊòæÁ§∫‰∏∫ÊñáÊú¨ÊèêÁ§∫„ÄÇ</small>
                </div>

                <!-- È´òÁ∫ßËÆæÁΩÆÂå∫Âüü -->
                <div id="articulationAdvancedSettings" style="display: none; margin-top: 20px; padding: 20px; background: var(--info-bg); border-radius: 8px; border: 2px solid var(--info-border);">
                    <h4 style="margin-bottom: 15px; color: var(--heading-text);" data-i18n="articulation.advancedFreq">È´òÁ∫ßÈ¢ëÁéáËÆæÁΩÆ</h4>
                    <p style="font-size: 0.9rem; color: var(--secondary-text); margin-bottom: 20px;" data-i18n="articulation.freqDesc">Ë∞ÉÊï¥ÂêÑÊºîÂ•èÊ≥ïÂú®ÊóãÂæã‰∏≠ÁöÑÂá∫Áé∞È¢ëÁéá (0% = ‰∏ç‰ΩøÁî®, 100% = ÁªèÂ∏∏‰ΩøÁî®)</p>
                    
                    <div style="margin-bottom: 20px;">
                        <h5 style="color: #495057; margin-bottom: 10px;" data-i18n="articulation.basicFreq">Âü∫Êú¨ÊºîÂ•èÊ≥ïÈ¢ëÁéá</h5>
                        <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
                            <div class="frequency-item">
                                <label for="freq-staccato" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;" data-i18n="articulation.freq.staccato">Staccato (Êñ≠Â•è) È¢ëÁéá:</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="range" id="freq-staccato" min="0" max="100" value="20" style="flex: 1;">
                                    <span id="freq-staccato-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">20%</span>
                                </div>
                            </div>
                            <div class="frequency-item">
                                <label for="freq-accent" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;" data-i18n="articulation.freq.accent">Accent (ÈáçÈü≥) È¢ëÁéá:</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="range" id="freq-accent" min="0" max="100" value="15" style="flex: 1;">
                                    <span id="freq-accent-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">15%</span>
                                </div>
                            </div>
                            <div class="frequency-item">
                                <label for="freq-acciaccatura" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;" data-i18n="articulation.freq.acciaccatura">Acciaccatura (Áü≠ÂÄöÈü≥) È¢ëÁéá:</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="range" id="freq-acciaccatura" min="0" max="100" value="10" style="flex: 1;">
                                    <span id="freq-acciaccatura-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">10%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h5 style="color: #495057; margin-bottom: 10px;" data-i18n="articulation.guitarFreq">Âêâ‰ªñÊäÄÂ∑ßÈ¢ëÁéá</h5>
                        <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
                            <div class="frequency-item">
                                <label for="freq-slur" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;" data-i18n="articulation.freq.slur">ÂáªÂãæÂº¶È¢ëÁéá:</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="range" id="freq-slur" min="0" max="100" value="15" style="flex: 1;">
                                    <span id="freq-slur-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">15%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn-secondary" onclick="resetArticulationFrequencies()" style="margin-right: 10px;" data-i18n="button.resetDefault">ËøîÂõûÈªòËÆ§</button>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-secondary" onclick="toggleArticulationAdvancedSettings()" id="articulationAdvancedBtn" data-i18n="button.advanced">È´òÁ∫ßËÆæÁΩÆ</button>
                    <button class="btn-primary" onclick="saveArticulationSettings()" data-i18n="button.save">‰øùÂ≠òËÆæÁΩÆ</button>
                    <button class="btn-secondary" onclick="closeArticulationSettings()" data-i18n="button.cancel">ÂèñÊ∂à</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ë∞ÉÂè∑ËÆæÁΩÆÂºπÁ™ó -->
    <div id="keySignatureModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="modal.keySignature.title">Ë∞ÉÂè∑ËÆæÁΩÆ</h3>
                <button class="close-btn" onclick="closeKeySettings()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="modal.keySignature.major">Â§ßË∞É (Major)</h4>
                        <button class="btn-select-all" onclick="selectAllMajorKeys()" style="padding: 5px 10px; font-size: 12px; background: rgb(40, 167, 69); color: white; border: none; border-radius: 4px; cursor: pointer; transition: 0.3s;" data-i18n="button.selectAllMajor">ÂÖ®ÈÄâ</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-C" value="C" checked="">
                            <span>C Â§ßË∞É</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-G" value="G">
                            <span>G Â§ßË∞É (1#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-D" value="D">
                            <span>D Â§ßË∞É (2#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-A" value="A">
                            <span>A Â§ßË∞É (3#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-E" value="E">
                            <span>E Â§ßË∞É (4#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-B" value="B">
                            <span>B Â§ßË∞É (5#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-F#" value="F#">
                            <span>F# Â§ßË∞É (6#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-F" value="F">
                            <span>F Â§ßË∞É (1b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Bb" value="Bb">
                            <span>Bb Â§ßË∞É (2b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Eb" value="Eb">
                            <span>Eb Â§ßË∞É (3b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Ab" value="Ab">
                            <span>Ab Â§ßË∞É (4b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Db" value="Db">
                            <span>Db Â§ßË∞É (5b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Gb" value="Gb">
                            <span>Gb Â§ßË∞É (6b)</span>
                        </label>
                    </div>
                </div>

                <div class="rhythm-section" style="margin-top: 30px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="modal.keySignature.minor">Â∞èË∞É (Minor)</h4>
                        <button class="btn-select-all" onclick="selectAllMinorKeys()" style="padding: 5px 10px; font-size: 12px; background: rgb(40, 167, 69); color: white; border: none; border-radius: 4px; cursor: pointer; transition: 0.3s;" data-i18n="button.selectAllMinor">ÂÖ®ÈÄâ</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Am" value="Am">
                            <span>A Â∞èË∞É</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Em" value="Em">
                            <span>E Â∞èË∞É (1#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Bm" value="Bm">
                            <span>B Â∞èË∞É (2#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-F#m" value="F#m">
                            <span>F# Â∞èË∞É (3#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-C#m" value="C#m">
                            <span>C# Â∞èË∞É (4#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-G#m" value="G#m">
                            <span>G# Â∞èË∞É (5#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-D#m" value="D#m">
                            <span>D# Â∞èË∞É (6#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Dm" value="Dm">
                            <span>D Â∞èË∞É (1b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Gm" value="Gm">
                            <span>G Â∞èË∞É (2b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Cm" value="Cm">
                            <span>C Â∞èË∞É (3b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Fm" value="Fm">
                            <span>F Â∞èË∞É (4b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Bbm" value="Bbm">
                            <span>Bb Â∞èË∞É (5b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Ebm" value="Ebm">
                            <span>Eb Â∞èË∞É (6b)</span>
                        </label>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveKeySettings()" data-i18n="button.save">‰øùÂ≠òËÆæÁΩÆ</button>
                    <button class="btn-secondary" onclick="closeKeySettings()" data-i18n="button.cancel">ÂèñÊ∂à</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ÊãçÂè∑ËÆæÁΩÆÂºπÁ™ó -->
    <div id="timeSignatureModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="modal.timeSignature.title">ÊãçÂè∑ËÆæÁΩÆ</h3>
                <button class="close-btn" onclick="closeTimeSignatureSettings()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="modal.timeSignature.selection">ÊãçÂè∑ÈÄâÈ°π</h4>
                        <button class="btn-select-all" onclick="selectAllTimeSignatures()" style="padding: 5px 10px; font-size: 12px; background: rgb(40, 167, 69); color: white; border: none; border-radius: 4px; cursor: pointer; transition: 0.3s;" data-i18n="button.selectAll">ÂÖ®ÈÄâ</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="time-2/4" value="2/4">
                            <span data-i18n="time.2-4">2/4 Êãç</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="time-3/4" value="3/4">
                            <span data-i18n="time.3-4">3/4 Êãç</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="time-4/4" value="4/4" checked="">
                            <span data-i18n="time.4-4">4/4 Êãç</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="time-6/8" value="6/8">
                            <span data-i18n="time.6-8">6/8 Êãç</span>
                        </label>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveTimeSignatureSettings()" data-i18n="button.save">‰øùÂ≠òËÆæÁΩÆ</button>
                    <button class="btn-secondary" onclick="closeTimeSignatureSettings()" data-i18n="button.cancel">ÂèñÊ∂à</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Èü≥Á®ãË∑®Â∫¶ËÆæÁΩÆÂºπÁ™ó -->
    <div id="intervalModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="modal.interval.title">Èü≥Á®ãË∑®Â∫¶ËÆæÁΩÆ</h3>
                <button class="close-btn" onclick="closeIntervalSettings()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="modal.interval.selection">ÊúÄÂ§ßÈü≥Á®ãË∑®Â∫¶ÈÄâÈ°π</h4>
                        <small style="color: #666; font-size: 12px;" data-i18n="interval.singleSelect">Âè™ËÉΩÈÄâÊã©‰∏Ä‰∏™Èü≥Á®ã‰Ωú‰∏∫ÊúÄÂ§ßË∑®Â∫¶</small>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-1" value="1" onchange="handleIntervalCheckboxChange(this)">
                            <span data-i18n="interval.minor2nd">Â∞è‰∫åÂ∫¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-2" value="2" onchange="handleIntervalCheckboxChange(this)">
                            <span data-i18n="interval.major2nd">Â§ß‰∫åÂ∫¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-3" value="3" onchange="handleIntervalCheckboxChange(this)">
                            <span data-i18n="interval.minor3rd">Â∞è‰∏âÂ∫¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-4" value="4" onchange="handleIntervalCheckboxChange(this)">
                            <span data-i18n="interval.major3rd">Â§ß‰∏âÂ∫¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-5" value="5" onchange="handleIntervalCheckboxChange(this)">
                            <span data-i18n="interval.perfect4th">ÂÆåÂÖ®ÂõõÂ∫¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-6" value="6" onchange="handleIntervalCheckboxChange(this)">
                            <span data-i18n="interval.tritone">Â¢ûÂõõÂ∫¶/Âáè‰∫îÂ∫¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-7" value="7" onchange="handleIntervalCheckboxChange(this)">
                            <span data-i18n="interval.perfect5th">ÂÆåÂÖ®‰∫îÂ∫¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-8" value="8" onchange="handleIntervalCheckboxChange(this)">
                            <span data-i18n="interval.minor6th">Â∞èÂÖ≠Â∫¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-9" value="9" onchange="handleIntervalCheckboxChange(this)">
                            <span data-i18n="interval.major6th">Â§ßÂÖ≠Â∫¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-10" value="10" onchange="handleIntervalCheckboxChange(this)">
                            <span data-i18n="interval.minor7th">Â∞è‰∏ÉÂ∫¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-11" value="11" onchange="handleIntervalCheckboxChange(this)">
                            <span data-i18n="interval.major7th">Â§ß‰∏ÉÂ∫¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-12" value="12" checked="" onchange="handleIntervalCheckboxChange(this)">
                            <span data-i18n="interval.perfect8th">ÂÆåÂÖ®ÂÖ´Â∫¶</span>
                        </label>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveIntervalSettings()" data-i18n="button.save">‰øùÂ≠òËÆæÁΩÆ</button>
                    <button class="btn-secondary" onclick="closeIntervalSettings()" data-i18n="button.cancel">ÂèñÊ∂à</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ë∞±Âè∑ËÆæÁΩÆÂºπÁ™ó -->
    <div id="clefModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="modal.clef.title">Ë∞±Âè∑ËÆæÁΩÆ</h3>
                <button class="close-btn" onclick="closeClefSettings()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="clef.options">Ë∞±Âè∑ÈÄâÈ°π</h4>
                        <button class="btn-select-all" onclick="selectAllClefs()" style="padding: 5px 10px; font-size: 12px; background: rgb(40, 167, 69); color: white; border: none; border-radius: 4px; cursor: pointer; transition: 0.3s;" data-i18n="button.selectAll">ÂÖ®ÈÄâ</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="clef-treble" value="treble" checked="">
                            <span data-i18n="clef.treble">È´òÈü≥Ë∞±Âè∑ (GË∞±Âè∑)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="clef-bass" value="bass">
                            <span data-i18n="clef.bass">‰ΩéÈü≥Ë∞±Âè∑ (FË∞±Âè∑)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="clef-alto" value="alto">
                            <span data-i18n="clef.alto">‰∏≠Èü≥Ë∞±Âè∑ (CË∞±Âè∑)</span>
                        </label>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveClefSettings()" data-i18n="button.save">‰øùÂ≠òËÆæÁΩÆ</button>
                    <button class="btn-secondary" onclick="closeClefSettings()" data-i18n="button.cancel">ÂèñÊ∂à</button>
                </div>
            </div>
        </div>
    </div>

    <script src="./IC ÊóãÂæãËßÜÂ•èÂ∑•ÂÖ∑_files/minor-scale-spelling.js"></script>
    <script src="./IC ÊóãÂæãËßÜÂ•èÂ∑•ÂÖ∑_files/sight-reading-final.js"></script>
    <script src="./IC ÊóãÂæãËßÜÂ•èÂ∑•ÂÖ∑_files/minor-alterations.js"></script>
    <script src="./IC ÊóãÂæãËßÜÂ•èÂ∑•ÂÖ∑_files/emergency-fix.js"></script>

    <!-- Â¢ûÂº∫ÁöÑÂÖ®ÈÄâÂàáÊç¢ÂäüËÉΩ -->
    <!-- <script src="enhanced-select-all.js"></script> -->
    
    <!-- ‰∏ªÈ¢òÂàáÊç¢Á≥ªÁªü -->
    <script>
        // ‰∏ªÈ¢òÂàáÊç¢Áõ∏ÂÖ≥ÂèòÈáèÂíåÂäüËÉΩ
        let currentTheme = localStorage.getItem('preferredTheme') || 'light';
        
        // ‰∏ªÈ¢òÂõæÊ†á
        const themeIcons = {
            'light': 'üåô', // Âú®lightÊ®°ÂºèÊòæÁ§∫Êúà‰∫ÆÂõæÊ†áÔºåÁÇπÂáªÂàáÊç¢Âà∞dark
            'dark': '‚òÄÔ∏è'   // Âú®darkÊ®°ÂºèÊòæÁ§∫Â§™Èò≥ÂõæÊ†áÔºåÁÇπÂáªÂàáÊç¢Âà∞light
        };
        
        // ÂàáÊç¢‰∏ªÈ¢ò (‰øùÁïôÂêëÂêéÂÖºÂÆπÊÄß)
        function toggleTheme() {
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            setTheme(newTheme);
        }
        
        // ËÆæÁΩÆ‰∏ªÈ¢ò (Êñ∞ÁâàÊú¨ÔºåÁî®‰∫éËÆæÁΩÆËèúÂçï)
        function setTheme(theme) {
            currentTheme = theme;
            localStorage.setItem('preferredTheme', theme);

            // ËÆæÁΩÆHTMLÁöÑdata-themeÂ±ûÊÄß
            document.documentElement.setAttribute('data-theme', theme);

            // Ëß¶ÂèëÁªü‰∏ÄÂêåÊ≠•Á≥ªÁªü (ÂêåÊ†áÁ≠æÈ°µÂÜÖÂÆûÊó∂ÂêåÊ≠•)
            if (window.ICStudioSync) {
                window.ICStudioSync.syncTheme(theme, 'melody-tool');
            }

            // ÂÖ≥Èó≠ËÆæÁΩÆËèúÂçï
            closeSettings();

            console.log(`üé® ‰∏ªÈ¢òÂ∑≤ËÆæÁΩÆ‰∏∫: ${theme}`);
        }
        
        // Â∫îÁî®‰∏ªÈ¢ò (‰øùÁïôÂêëÂêéÂÖºÂÆπÊÄß)
        function switchTheme(theme) {
            currentTheme = theme;
            localStorage.setItem('preferredTheme', theme);
            
            // ËÆæÁΩÆHTMLÁöÑdata-themeÂ±ûÊÄß
            document.documentElement.setAttribute('data-theme', theme);
            
            // Êõ¥Êñ∞ÊåâÈíÆÂõæÊ†á (Â¶ÇÊûúÂ≠òÂú®ÊóßÁöÑ‰∏ªÈ¢òÂàáÊç¢Âô®)
            const themeSwitcher = document.getElementById('themeSwitcher');
            if (themeSwitcher) {
                themeSwitcher.textContent = themeIcons[theme];
            }
            
            console.log(`üé® ‰∏ªÈ¢òÂ∑≤ÂàáÊç¢Âà∞: ${theme}`);
        }
        
        // ËÆæÁΩÆËèúÂçïÊéßÂà∂
        function toggleSettings() {
            const settingsMenu = document.getElementById('settingsMenu');
            const isVisible = settingsMenu.classList.contains('show');
            
            if (isVisible) {
                closeSettings();
            } else {
                openSettings();
            }
        }
        
        function openSettings() {
            const settingsMenu = document.getElementById('settingsMenu');
            settingsMenu.classList.add('show');
            
            // Ê∑ªÂä†ÁÇπÂáªÂ§ñÈÉ®Âå∫ÂüüÂÖ≥Èó≠ËèúÂçïÁöÑÁõëÂê¨Âô®
            setTimeout(() => {
                document.addEventListener('click', handleClickOutside);
            }, 10);
        }
        
        function closeSettings() {
            const settingsMenu = document.getElementById('settingsMenu');
            settingsMenu.classList.remove('show');
            
            // ÁßªÈô§ÁÇπÂáªÂ§ñÈÉ®Âå∫ÂüüÁöÑÁõëÂê¨Âô®
            document.removeEventListener('click', handleClickOutside);
        }
        
        // ÂäüËÉΩÈÄâÊã©Âô®ÊéßÂà∂
        function toggleFunctionSelector() {
            const functionMenu = document.getElementById('functionMenu');
            const isVisible = functionMenu.classList.contains('show');
            
            if (isVisible) {
                closeFunctionSelector();
            } else {
                openFunctionSelector();
            }
        }
        
        function openFunctionSelector() {
            const functionMenu = document.getElementById('functionMenu');
            functionMenu.classList.add('show');
            
            // Ê∑ªÂä†ÁÇπÂáªÂ§ñÈÉ®Âå∫ÂüüÂÖ≥Èó≠ËèúÂçïÁöÑÁõëÂê¨Âô®
            setTimeout(() => {
                document.addEventListener('click', handleFunctionClickOutside);
            }, 10);
        }
        
        function closeFunctionSelector() {
            const functionMenu = document.getElementById('functionMenu');
            functionMenu.classList.remove('show');
            
            // ÁßªÈô§ÁÇπÂáªÂ§ñÈÉ®Âå∫ÂüüÁöÑÁõëÂê¨Âô®
            document.removeEventListener('click', handleFunctionClickOutside);
        }
        
        // Â§ÑÁêÜÁÇπÂáªÂ§ñÈÉ®Âå∫ÂüüÂÖ≥Èó≠ÂäüËÉΩËèúÂçï
        function handleFunctionClickOutside(event) {
            const functionSelector = document.querySelector('.function-selector');
            
            if (functionSelector && !functionSelector.contains(event.target)) {
                closeFunctionSelector();
            }
        }
        
        // ÂΩìÂâçÂäüËÉΩÊ®°Âºè
        let currentFunctionMode = 'melody';
        
        // ÂàáÊç¢ÂäüËÉΩ
        function switchFunction(mode) {
            if (mode === 'melody') {
                // Â∑≤ÁªèÂú®ÊóãÂæãËßÜÂ•èÈ°µÈù¢
                closeFunctionSelector();
                console.log('Â∑≤Âú®ÊóãÂæãËßÜÂ•èÊ®°Âºè');
            } else if (mode === 'interval') {
                // ÂØºËà™Âà∞Èü≥Á®ãËßÜÂ•èÈ°µÈù¢
                window.location.href = 'interval-generator.html';
            } else if (mode === 'chord') {
                // ÂØºËà™Âà∞ÂíåÂº¶ËßÜÂ•èÈ°µÈù¢
                window.location.href = 'chord-generator.html';
            }
        }
        
        // Â§ÑÁêÜÁÇπÂáªÂ§ñÈÉ®Âå∫ÂüüÂÖ≥Èó≠ËÆæÁΩÆËèúÂçï
        function handleClickOutside(event) {
            const settingsDropdown = document.querySelector('.settings-dropdown');
            
            if (settingsDropdown && !settingsDropdown.contains(event.target)) {
                closeSettings();
            }
        }

        // ËäÇÊãçÂô®Áõ∏ÂÖ≥ÂèòÈáèÂíåÂäüËÉΩ
        let metronomeInterval = null;
        let metronomeAudioContext = null;
        let metronomeOscillator = null;
        let isMetronomeRunning = false;
        let metronomeTempo = 60; // ÈªòËÆ§60 BPM

        // üîß Á≤æÁ°ÆÂêåÊ≠•ÔºöËÆ∞ÂΩïËäÇÊãçÂô®ÂêØÂä®Êó∂Èó¥ÂíåÂΩìÂâçËäÇÊãç
        let metronomeStartTime = null;
        let metronomeCurrentBeat = 0;
        let metronomeSchedulerInterval = null;

        // üîß ÂÖ≥ÈîÆ‰øÆÂ§çÔºö‰ΩøÁî®‰∏éÊóãÂæãÊí≠ÊîæÁõ∏ÂêåÁöÑ AudioContext
        // ËøôÊ†∑ÂèØ‰ª•Á°Æ‰øùËäÇÊãçÂô®ÂíåÊóãÂæã‰ΩøÁî®Âêå‰∏Ä‰∏™Êó∂ÈíüÔºåÂÆûÁé∞ÂÆåÁæéÂêåÊ≠•
        function initializeMetronomeAudio() {
            try {
                // ‰ºòÂÖà‰ΩøÁî®ÊóãÂæãÊí≠ÊîæÁöÑ AudioContext
                if (window.melodyAudioCtx) {
                    metronomeAudioContext = window.melodyAudioCtx;
                    console.log('üéµ ËäÇÊãçÂô®‰ΩøÁî®ÊóãÂæãÁöÑ AudioContextÔºàÂÖ±‰∫´Êó∂ÈíüÔºâ');
                } else {
                    metronomeAudioContext = new (window.AudioContext || window.webkitAudioContext)();
                    // ÂèçÂêëÂÖ±‰∫´ÔºöËÆ©ÊóãÂæã‰πü‰ΩøÁî®Ëøô‰∏™ AudioContext
                    window.melodyAudioCtx = metronomeAudioContext;
                    console.log('üéµ ËäÇÊãçÂô®ÂàõÂª∫Êñ∞ AudioContextÔºàÂÖ±‰∫´ÁªôÊóãÂæãÔºâ');
                }
                return true;
            } catch (error) {
                console.error('‚ùå Web Audio API ‰∏çÊîØÊåÅ:', error);
                return false;
            }
        }

        // Êí≠ÊîæËäÇÊãçÂô®Â£∞Èü≥ - ÊîØÊåÅÁ≤æÁ°ÆË∞ÉÂ∫¶
        function playMetronomeSound(time) {
            if (!metronomeAudioContext) {
                if (!initializeMetronomeAudio()) return;
            }

            try {
                // ÊÅ¢Â§çÈü≥È¢ë‰∏ä‰∏ãÊñáÔºàÁî®Êà∑‰∫§‰∫íÂêéÔºâ
                if (metronomeAudioContext.state === 'suspended') {
                    metronomeAudioContext.resume();
                }

                // üîß ‰ΩøÁî®‰º†ÂÖ•ÁöÑÁ≤æÁ°ÆÊó∂Èó¥ÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàô‰ΩøÁî®ÂΩìÂâçÊó∂Èó¥
                const scheduleTime = time !== undefined ? time : metronomeAudioContext.currentTime;

                const oscillator = metronomeAudioContext.createOscillator();
                const gainNode = metronomeAudioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(metronomeAudioContext.destination);

                // ‰ΩøÁî®ÊñπÊ≥¢ÂíåËá™ÁÑ∂Èü≥È´ò (ÂèÇËÄÉNiceChordËäÇÊãçÂô®)
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(523.25, scheduleTime); // C5Èü≥È´ò

                // ËÆæÁΩÆËá™ÁÑ∂ÁöÑÈü≥ÈáèÂåÖÁªú (Êõ¥Â•ΩÁöÑrelease time)
                gainNode.gain.setValueAtTime(0.25, scheduleTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, scheduleTime + 0.05);

                oscillator.start(scheduleTime);
                oscillator.stop(scheduleTime + 0.05);

                // ËßÜËßâÂèçÈ¶à - Êõ¥Êñ∞headerÊåáÁ§∫Âô®ÔºàÂè™Âú®Á´ãÂç≥Êí≠ÊîæÊó∂Ôºâ
                if (time === undefined || scheduleTime <= metronomeAudioContext.currentTime + 0.05) {
                    const headerIndicator = document.getElementById('headerBeatIndicator');

                    if (headerIndicator) {
                        headerIndicator.classList.add('beat');
                        setTimeout(() => {
                            headerIndicator.classList.remove('beat');
                        }, 150);
                    }
                }

            } catch (error) {
                console.error('‚ùå ËäÇÊãçÂô®Â£∞Èü≥Êí≠ÊîæÂ§±Ë¥•:', error);
            }
        }

        // ËÆæÁΩÆËäÇÊãçÂô®ÈÄüÂ∫¶
        function setMetronomeTempo(bpm) {
            metronomeTempo = Math.max(1, Math.min(999, bpm));
            
            // ÂêåÊ≠•Êõ¥Êñ∞headerËæìÂÖ•Ê°Ü
            const headerInput = document.getElementById('headerMetronomeBpm');
            if (headerInput) headerInput.value = metronomeTempo;
            
            // Â¶ÇÊûúËäÇÊãçÂô®Ê≠£Âú®ËøêË°åÔºåÈáçÊñ∞ÂêØÂä®‰ª•Â∫îÁî®Êñ∞ÈÄüÂ∫¶
            if (isMetronomeRunning) {
                stopMetronome();
                startMetronome();
            }
            
            console.log(`üéµ ËäÇÊãçÂô®ÈÄüÂ∫¶ËÆæÁΩÆ‰∏∫: ${metronomeTempo} BPM`);
        }

        // üîß Á≤æÁ°ÆËäÇÊãçÂô®Ë∞ÉÂ∫¶Âô® - ‰ΩøÁî® Web Audio API Êó∂Èíü
        function scheduleMetronomeBeat() {
            if (!metronomeAudioContext) {
                if (!initializeMetronomeAudio()) return;
            }

            const beatDuration = 60.0 / metronomeTempo; // ÊØèÊãçÁöÑÁßíÊï∞
            const lookahead = 0.1; // ÊèêÂâç 100ms Ë∞ÉÂ∫¶
            const scheduleAheadTime = 0.2; // Ë∞ÉÂ∫¶Êú™Êù• 200ms ÁöÑËäÇÊãç

            while (metronomeStartTime + metronomeCurrentBeat * beatDuration <
                   metronomeAudioContext.currentTime + scheduleAheadTime) {

                const beatTime = metronomeStartTime + metronomeCurrentBeat * beatDuration;

                // Ë∞ÉÂ∫¶Ëøô‰∏ÄÊãç
                playMetronomeSound(beatTime);

                metronomeCurrentBeat++;
            }
        }

        // ÂêØÂä®ËäÇÊãçÂô® - ‰ΩøÁî®Á≤æÁ°Æ Web Audio API Ë∞ÉÂ∫¶
        function startMetronome() {
            const headerInput = document.getElementById('headerMetronomeBpm');
            const tempo = parseInt(headerInput ? headerInput.value : metronomeTempo) || 60;
            metronomeTempo = tempo;

            // ÂêåÊ≠•Êõ¥Êñ∞headerËæìÂÖ•Ê°Ü
            if (headerInput) headerInput.value = metronomeTempo;

            if (isMetronomeRunning) return;

            if (!metronomeAudioContext) {
                if (!initializeMetronomeAudio()) return;
            }

            // ÊÅ¢Â§çÈü≥È¢ë‰∏ä‰∏ãÊñá
            if (metronomeAudioContext.state === 'suspended') {
                metronomeAudioContext.resume();
            }

            isMetronomeRunning = true;

            // üîß ÂÖ≥ÈîÆ‰øÆÂ§çÔºö‰ΩøÁî® AudioContext Êó∂Èó¥ 0 ‰Ωú‰∏∫ÂÖ®Â±ÄËäÇÊãçÁΩëÊ†ºÁöÑËµ∑ÁÇπ
            // ËøôÊ†∑ÊâÄÊúâÈü≥‰πêÂíåËäÇÊãçÂô®ÈÉΩÂú®Âêå‰∏Ä‰∏™ÁΩëÊ†º‰∏ä
            metronomeStartTime = 0; // ÂÖ®Â±ÄÁΩëÊ†ºËµ∑ÁÇπ

            const beatDuration = 60.0 / metronomeTempo;
            const now = metronomeAudioContext.currentTime;

            // ËÆ°ÁÆóÂΩìÂâçÂ∫îËØ•Âú®Á¨¨Âá†ÊãçÔºà‰ªéÊó∂Èó¥ 0 ÂºÄÂßãÔºâ
            const currentBeatNumber = Math.floor(now / beatDuration);
            const nextBeatNumber = currentBeatNumber + 1;
            const nextBeatTime = nextBeatNumber * beatDuration;

            // Á°Æ‰øù‰∏ã‰∏ÄÊãçËá≥Â∞ëÂú®Êú™Êù• 50msÔºåÂê¶ÂàôË∑≥Ëøá
            const minLookahead = 0.05;
            if (nextBeatTime < now + minLookahead) {
                metronomeCurrentBeat = nextBeatNumber + 1;
            } else {
                metronomeCurrentBeat = nextBeatNumber;
            }

            console.log(`üéµ ËäÇÊãçÂô®ÂØπÈΩêÂÖ®Â±ÄÁΩëÊ†º: ${metronomeTempo} BPM, ÂΩìÂâç=${now.toFixed(3)}s, ‰ªéÁ¨¨${metronomeCurrentBeat}ÊãçÂºÄÂßã (Êó∂Èó¥=${(metronomeCurrentBeat * beatDuration).toFixed(3)}s)`);

            // Á´ãÂç≥Ë∞ÉÂ∫¶Á¨¨‰∏ÄÊâπËäÇÊãç
            scheduleMetronomeBeat();

            // üîß ‰ΩøÁî®Êõ¥È¢ëÁπÅÁöÑÂÆöÊó∂Âô®Êù•Ê£ÄÊü•ÂíåË∞ÉÂ∫¶Ôºà25msÔºâÔºåËÄå‰∏çÊòØÁî®ÂÆÉÊù•Êí≠ÊîæÂ£∞Èü≥
            // ËøôÊ†∑ÂèØ‰ª•Á°Æ‰øùËäÇÊãçÊÄªÊòØÊèêÂâçË∞ÉÂ∫¶Â•Ω
            metronomeSchedulerInterval = setInterval(scheduleMetronomeBeat, 25);

            // Êõ¥Êñ∞UI
            updateMetronomeUI();
        }

        // ÂÅúÊ≠¢ËäÇÊãçÂô®
        function stopMetronome() {
            if (metronomeInterval) {
                clearInterval(metronomeInterval);
                metronomeInterval = null;
            }

            // üîß Ê∏ÖÈô§Ë∞ÉÂ∫¶Âô®ÂÆöÊó∂Âô®
            if (metronomeSchedulerInterval) {
                clearInterval(metronomeSchedulerInterval);
                metronomeSchedulerInterval = null;
            }

            isMetronomeRunning = false;

            // ÈáçÁΩÆËäÇÊãçËÆ°Êï∞
            metronomeStartTime = null;
            metronomeCurrentBeat = 0;

            updateMetronomeUI();

            console.log('üîá ËäÇÊãçÂô®Â∑≤ÂÅúÊ≠¢');
        }

        // ÂàáÊç¢ËäÇÊãçÂô®ÂºÄÂÖ≥
        function toggleMetronome() {
            if (isMetronomeRunning) {
                stopMetronome();
            } else {
                startMetronome();
            }
        }

        // Êõ¥Êñ∞ËäÇÊãçÂô®UI
        function updateMetronomeUI() {
            const headerToggleBtn = document.getElementById('headerMetronomeBtn');
            
            // Êõ¥Êñ∞header‰∏≠ÁöÑÊåâÈíÆ
            if (headerToggleBtn) {
                if (isMetronomeRunning) {
                    headerToggleBtn.classList.add('active');
                    headerToggleBtn.textContent = 'üéµ';
                    headerToggleBtn.title = 'ÂÅúÊ≠¢ËäÇÊãçÂô®';
                } else {
                    headerToggleBtn.classList.remove('active');
                    headerToggleBtn.textContent = 'üéµ';
                    headerToggleBtn.title = 'ÂºÄÂßãËäÇÊãçÂô®';
                }
            }
        }

        // ÁõëÂê¨header‰∏≠BPMËæìÂÖ•Ê°ÜÁöÑÂèòÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            const headerSpeedInput = document.getElementById('headerMetronomeBpm');
            
            if (headerSpeedInput) {
                // ÂÆûÊó∂ËæìÂÖ•È™åËØÅ
                headerSpeedInput.addEventListener('input', function() {
                    let value = parseInt(this.value);
                    
                    // ÈôêÂà∂ËåÉÂõ¥
                    if (value < 1) {
                        this.value = 1;
                        value = 1;
                    } else if (value > 999) {
                        this.value = 999;
                        value = 999;
                    }
                    
                    if (!isNaN(value)) {
                        setMetronomeTempo(value);
                    }
                });
                
                // EnterÈîÆÁ°ÆËÆ§
                headerSpeedInput.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        this.blur(); // Â§±ÂéªÁÑ¶ÁÇπÔºåËß¶ÂèëÈ™åËØÅ
                    }
                });
                
                // Â§±ÂéªÁÑ¶ÁÇπÊó∂È™åËØÅ
                headerSpeedInput.addEventListener('blur', function() {
                    let value = parseInt(this.value);
                    
                    if (isNaN(value) || value < 1) {
                        this.value = 1;
                        value = 1;
                    } else if (value > 999) {
                        this.value = 999;
                        value = 999;
                    }
                    
                    setMetronomeTempo(value);
                });

                // BPMÊãñÂä®ÂäüËÉΩÂÆûÁé∞
                let isDragging = false;
                let startY = 0;
                let startValue = 0;
                let dragTimeout = null;
                let hasStartedDrag = false;
                
                // Èº†Ê†áÊåâ‰∏ã‰∫ã‰ª∂
                headerSpeedInput.addEventListener('mousedown', function(event) {
                    // Âè™Â§ÑÁêÜÂ∑¶ÈîÆÁÇπÂáª
                    if (event.button !== 0) return;
                    
                    startY = event.clientY;
                    startValue = parseInt(this.value) || 60;
                    hasStartedDrag = false;
                    
                    console.log('BPMÊãñÂä®: Èº†Ê†áÊåâ‰∏ã', startValue);
                    
                    // ÈïøÊåâ80msÂêéÂêØÂä®ÊãñÂä®Ê®°Âºè
                    dragTimeout = setTimeout(() => {
                        isDragging = true;
                        hasStartedDrag = true;
                        
                        console.log('BPMÊãñÂä®: ÂêØÂä®ÊãñÂä®Ê®°Âºè');
                        
                        // Èò≤Ê≠¢ÊñáÊú¨ÈÄâÊã©ÂíåÈªòËÆ§Ë°å‰∏∫
                        event.preventDefault();
                        document.body.style.userSelect = 'none';
                        document.body.style.webkitUserSelect = 'none';
                        document.body.style.mozUserSelect = 'none';
                        document.body.style.msUserSelect = 'none';
                        
                        // Ê∑ªÂä†ÊãñÂä®‰∏≠ÁöÑËßÜËßâÂèçÈ¶à
                        this.style.cursor = 'ns-resize';
                        this.classList.add('dragging');
                        this.blur(); // Â§±ÂéªÁÑ¶ÁÇπÔºåÈÅøÂÖçÈîÆÁõòËæìÂÖ•Âπ≤Êâ∞
                    }, 80);
                });
                
                // Èº†Ê†áÁßªÂä®‰∫ã‰ª∂ - ÁªëÂÆöÂà∞ÂÖ®Â±Ä
                const handleMouseMove = function(event) {
                    if (!isDragging || !hasStartedDrag) return;
                    
                    const deltaY = startY - event.clientY; // Âêë‰∏ä‰∏∫Ê≠£ÔºåÂêë‰∏ã‰∏∫Ë¥ü
                    const sensitivity = 1; // ÊãñÂä®ÁÅµÊïèÂ∫¶ÔºåÊØè1ÂÉèÁ¥†ÊîπÂèò1‰∏™BPM
                    const newValue = Math.max(1, Math.min(999, startValue + Math.round(deltaY / sensitivity)));
                    
                    console.log('BPMÊãñÂä®: ÁßªÂä®‰∏≠', deltaY, newValue);
                    
                    headerSpeedInput.value = newValue;
                    setMetronomeTempo(newValue);
                    
                    // ÈòªÊ≠¢ÈªòËÆ§Ë°å‰∏∫
                    event.preventDefault();
                    event.stopPropagation();
                };
                
                // Èº†Ê†áÈáäÊîæ‰∫ã‰ª∂ - ÁªëÂÆöÂà∞ÂÖ®Â±Ä
                const handleMouseUp = function(event) {
                    console.log('BPMÊãñÂä®: Èº†Ê†áÈáäÊîæ', isDragging);
                    
                    // Ê∏ÖÈô§ÈïøÊåâËÆ°Êó∂Âô®
                    if (dragTimeout) {
                        clearTimeout(dragTimeout);
                        dragTimeout = null;
                    }
                    
                    if (isDragging && hasStartedDrag) {
                        isDragging = false;
                        hasStartedDrag = false;
                        
                        // ÊÅ¢Â§çÊñáÊú¨ÈÄâÊã©
                        document.body.style.userSelect = '';
                        document.body.style.webkitUserSelect = '';
                        document.body.style.mozUserSelect = '';
                        document.body.style.msUserSelect = '';
                        
                        // ÁßªÈô§ËßÜËßâÂèçÈ¶à
                        headerSpeedInput.style.cursor = '';
                        headerSpeedInput.classList.remove('dragging');
                        
                        console.log('BPMÊãñÂä®: ÁªìÊùüÊãñÂä®Ê®°Âºè');
                    }
                };
                
                // ÁªëÂÆöÂÖ®Â±Ä‰∫ã‰ª∂
                document.addEventListener('mousemove', handleMouseMove, true);
                document.addEventListener('mouseup', handleMouseUp, true);
                
                // Èº†Ê†áÁ¶ªÂºÄËæìÂÖ•Ê°ÜÊó∂ÂèñÊ∂àÈïøÊåâ
                headerSpeedInput.addEventListener('mouseleave', function(event) {
                    if (dragTimeout && !isDragging) {
                        clearTimeout(dragTimeout);
                        dragTimeout = null;
                        console.log('BPMÊãñÂä®: Èº†Ê†áÁ¶ªÂºÄÔºåÂèñÊ∂àÈïøÊåâ');
                    }
                });
                
                // Èò≤Ê≠¢Âè≥ÈîÆËèúÂçïÂπ≤Êâ∞
                headerSpeedInput.addEventListener('contextmenu', function(event) {
                    if (isDragging) {
                        event.preventDefault();
                    }
                });
            }
        });
        
        // ÂàùÂßãÂåñ‰∏ªÈ¢ò
        function initializeTheme() {
            switchTheme(currentTheme);
        }
        
        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ‰∏ªÈ¢ò
        document.addEventListener('DOMContentLoaded', function() {
            initializeTheme();
        });
    </script>

    <!-- Â§öËØ≠Ë®ÄÁ≥ªÁªü -->
    <script>
        // Â§öËØ≠Ë®ÄÁøªËØëÂØπË±°
        const translations = {
            'zh-CN': {
                'app.title': 'IC Studio - ËßÜÂ•èÊóãÂæãÁîüÊàêÂô®',
                'app.subtitle': '‰∏ì‰∏öÁ∫ß‰πêË∞±Ê∏≤Êüì‰∏éÈü≥‰πêÁêÜËÆ∫Â∑•ÂÖ∑',
                'app.melodyMode': 'ÊóãÂæãËßÜÂ•è',
                'app.intervalMode': 'Èü≥Á®ãËßÜÂ•è',
                'app.chordMode': 'ÂíåÂº¶ËßÜÂ•è',
                'controls.interval': 'Èü≥Á®ãË∑®Â∫¶',
                'controls.intervalSettings': 'Èü≥Á®ãËÆæÁΩÆ',
                'controls.measures': 'Â∞èËäÇÊï∞',
                'controls.measures2': '2Â∞èËäÇ',
                'controls.measures4': '4Â∞èËäÇ',
                'controls.measures8': '8Â∞èËäÇ',
                'controls.key': 'Ë∞ÉÂè∑',
                'controls.keySettings': 'Ë∞ÉÂè∑ËÆæÁΩÆ',
                'controls.time': 'ÊãçÂè∑',
                'controls.timeSettings': 'ÊãçÂè∑ËÆæÁΩÆ',
                'controls.clef': 'Ë∞±Âè∑',
                'controls.clefSettings': 'Ë∞±Âè∑ËÆæÁΩÆ',
                'controls.rangeMin': 'ÊúÄ‰ΩéÈü≥',
                'controls.rangeMax': 'ÊúÄÈ´òÈü≥',
                'controls.accidental': '‰∏¥Êó∂ËÆ∞Âè∑',
                'controls.metronome': 'ËäÇÊãçÂô®',
                'controls.generate': 'ÁîüÊàêÊóãÂæã',
                'controls.previous': '‰∏ä‰∏ÄÊù°',
                'controls.next': '‰∏ã‰∏ÄÊù°',
                'controls.play': 'Êí≠Êîæ',
                'controls.stop': 'ÂÅúÊ≠¢',
                'controls.tempo': 'ÈÄüÂ∫¶',
                'controls.playbackNote': 'Êí≠ÊîæÈÄüÂ∫¶Ë∑üÈöèËäÇÊãçÂô®ËÆæÁΩÆ',
                'controls.rhythm': 'ËäÇÂ•èËÆæÁΩÆ',
                'controls.articulation': 'ÊºîÂ•èÊäÄÂ∑ß',
                'score.empty': 'ÁÇπÂáªÁîüÊàêÊóãÂæãÂºÄÂßãÁªÉ‰π†',
                'settings.title': 'ËÆæÁΩÆ',
                'settings.theme': '‰∏ªÈ¢ò',
                'settings.language': 'ËØ≠Ë®Ä',
                'settings.lightMode': 'ÊµÖËâ≤Ê®°Âºè',
                'settings.darkMode': 'Ê∑±Ëâ≤Ê®°Âºè',
                'settings.metronome': 'ËäÇÊãçÂô®',
                'settings.tempo': 'ÈÄüÂ∫¶ (BPM)',
                'settings.startMetronome': 'ÂºÄÂßãËäÇÊãçÂô®',
                'settings.stopMetronome': 'ÂÅúÊ≠¢ËäÇÊãçÂô®',
                // Modal titles
                'modal.rhythm.title': 'ËäÇÂ•èËÆæÁΩÆ',
                'modal.keySignature.title': 'Ë∞ÉÂè∑ËÆæÁΩÆ',
                'modal.timeSignature.title': 'ÊãçÂè∑ËÆæÁΩÆ',
                'modal.interval.title': 'Èü≥Á®ãË∑®Â∫¶ËÆæÁΩÆ',
                'modal.clef.title': 'Ë∞±Âè∑ËÆæÁΩÆ',
                'modal.articulation.title': 'Articulations',
                // Modal content
                'modal.rhythm.basicUnit': 'Âü∫Êú¨ËäÇÂ•èÂçï‰Ωç',
                'modal.keySignature.major': 'Â§ßË∞É (Major)',
                'modal.keySignature.minor': 'Â∞èË∞É (Minor)',
                'modal.timeSignature.selection': 'ÊãçÂè∑ÈÄâÈ°π',
                'modal.interval.selection': 'ÊúÄÂ§ßÈü≥Á®ãË∑®Â∫¶ÈÄâÈ°π',
                'modal.clef.selection': 'Ë∞±Âè∑ÈÄâÈ°π',
                // Clef types
                'clef.options': 'Ë∞±Âè∑ÈÄâÈ°π',
                'clef.treble': 'È´òÈü≥Ë∞±Âè∑ (GË∞±Âè∑)',
                'clef.bass': '‰ΩéÈü≥Ë∞±Âè∑ (FË∞±Âè∑)',
                'clef.alto': '‰∏≠Èü≥Ë∞±Âè∑ (CË∞±Âè∑)',
                // Articulation types
                'articulation.basic.title': 'Âü∫Êú¨ÊºîÂ•èÊ≥ï (Basic Articulations)',
                'articulation.guitar.title': 'Âêâ‰ªñÊäÄÂ∑ß (Guitar Techniques)',
                'articulation.staccato': 'Staccato (Êñ≠Â•è) ‚Ä¢',
                'articulation.accent': 'Accent (ÈáçÈü≥) >',
                'articulation.acciaccatura': 'Acciaccatura (Áü≠ÂÄöÈü≥)',
                'articulation.hammer': 'Hammer-on (ÂáªÂº¶) H',
                'articulation.pulloff': 'Pull-off (ÂãæÂº¶) P',
                'articulation.advancedFreq': 'È´òÁ∫ßÈ¢ëÁéáËÆæÁΩÆ',
                'rhythm.advancedFreq': 'È´òÁ∫ßÈ¢ëÁéáËÆæÁΩÆ',
                'rhythm.freqDesc': 'Ë∞ÉÊï¥ÂêÑËäÇÂ•èÂçï‰ΩçÂú®ÊóãÂæã‰∏≠ÁöÑÂá∫Áé∞È¢ëÁéá (0% = ‰∏ç‰ΩøÁî®, 100% = ‰ºòÂÖà‰ΩøÁî®)',
                'articulation.freqDesc': 'Ë∞ÉÊï¥ÂêÑÊºîÂ•èÊ≥ïÂú®ÊóãÂæã‰∏≠ÁöÑÂá∫Áé∞È¢ëÁéá (0% = ‰∏ç‰ΩøÁî®, 100% = ÁªèÂ∏∏‰ΩøÁî®)',
                'articulation.basicFreq': 'Âü∫Êú¨ÊºîÂ•èÊ≥ïÈ¢ëÁéá',
                'articulation.guitarFreq': 'Âêâ‰ªñÊäÄÂ∑ßÈ¢ëÁéá',
                'articulation.freq.staccato': 'Staccato (Êñ≠Â•è) È¢ëÁéá:',
                'articulation.freq.accent': 'Accent (ÈáçÈü≥) È¢ëÁéá:',
                'articulation.freq.acciaccatura': 'Acciaccatura (Áü≠ÂÄöÈü≥) È¢ëÁéá:',
                'articulation.freq.slur': 'ÂáªÂãæÂº¶È¢ëÁéá:',
                // Interval types
                'interval.singleSelect': 'Âè™ËÉΩÈÄâÊã©‰∏Ä‰∏™Èü≥Á®ã‰Ωú‰∏∫ÊúÄÂ§ßË∑®Â∫¶',
                'interval.minor2nd': 'Â∞è‰∫åÂ∫¶',
                'interval.major2nd': 'Â§ß‰∫åÂ∫¶',
                'interval.minor3rd': 'Â∞è‰∏âÂ∫¶',
                'interval.major3rd': 'Â§ß‰∏âÂ∫¶',
                'interval.perfect4th': 'ÂÆåÂÖ®ÂõõÂ∫¶',
                'interval.tritone': 'Â¢ûÂõõÂ∫¶/Âáè‰∫îÂ∫¶',
                'interval.perfect5th': 'ÂÆåÂÖ®‰∫îÂ∫¶',
                'interval.minor6th': 'Â∞èÂÖ≠Â∫¶',
                'interval.major6th': 'Â§ßÂÖ≠Â∫¶',
                'interval.minor7th': 'Â∞è‰∏ÉÂ∫¶',
                'interval.major7th': 'Â§ß‰∏ÉÂ∫¶',
                'interval.perfect8th': 'ÂÆåÂÖ®ÂÖ´Â∫¶',
                // Rhythm types
                'rhythm.whole': 'ÂÖ®Èü≥Á¨¶',
                'rhythm.dottedHalf': 'ÈôÑÁÇπ‰∫åÂàÜÈü≥Á¨¶',
                'rhythm.half': '‰∫åÂàÜÈü≥Á¨¶',
                'rhythm.dottedQuarter': 'ÈôÑÁÇπÂõõÂàÜÈü≥Á¨¶',
                'rhythm.quarter': 'ÂõõÂàÜÈü≥Á¨¶',
                'rhythm.eighth': 'ÂÖ´ÂàÜÈü≥Á¨¶',
                'rhythm.sixteenth': 'ÂçÅÂÖ≠ÂàÜÈü≥Á¨¶',
                'rhythm.triplet': '‰∏âËøûÈü≥',
                'rhythm.duplet': '‰∫åËøûÈü≥',
                'rhythm.quadruplet': 'ÂõõËøûÈü≥',
                'rhythm.dottedOptions': 'ÈôÑÁÇπÈü≥Á¨¶ÈÄâÈ°π',
                'rhythm.allowDotted': 'ÂÖÅËÆ∏ÈôÑÁÇπÈü≥Á¨¶ (Ê†πÊçÆÂ∑≤ÈÄâËäÇÂ•èËá™Âä®ÁîüÊàêÈôÑÁÇπÁâàÊú¨)',
                'rhythm.freq.whole': 'ÂÖ®Èü≥Á¨¶È¢ëÁéá:',
                'rhythm.freq.dottedHalf': 'ÈôÑÁÇπ‰∫åÂàÜÈü≥Á¨¶È¢ëÁéá:',
                'rhythm.freq.half': '‰∫åÂàÜÈü≥Á¨¶È¢ëÁéá:',
                'rhythm.freq.dottedQuarter': 'ÈôÑÁÇπÂõõÂàÜÈü≥Á¨¶È¢ëÁéá:',
                'rhythm.freq.quarter': 'ÂõõÂàÜÈü≥Á¨¶È¢ëÁéá:',
                'rhythm.freq.dottedEighth': 'ÈôÑÁÇπÂÖ´ÂàÜÈü≥Á¨¶È¢ëÁéá:',
                'rhythm.freq.eighth': 'ÂÖ´ÂàÜÈü≥Á¨¶È¢ëÁéá:',
                'rhythm.freq.sixteenth': 'ÂçÅÂÖ≠ÂàÜÈü≥Á¨¶È¢ëÁéá:',
                'rhythm.freq.triplet': '‰∏âËøûÈü≥È¢ëÁéá:',
                'rhythm.dottedDesc': 'ÂãæÈÄâÂêéÂ∞ÜËá™Âä®‰∏∫Â∑≤ÈÄâÊã©ÁöÑËäÇÂ•èÁ±ªÂûãÁîüÊàêÈôÑÁÇπÁâàÊú¨',
                'rhythm.dottedExample': '‰æãÂ¶ÇÔºöÂãæÈÄâÂõõÂàÜÈü≥Á¨¶+ÈôÑÁÇπÈü≥Á¨¶ ‚Üí ÂèØÁîüÊàêÂõõÂàÜÈü≥Á¨¶ÂíåÈôÑÁÇπÂõõÂàÜÈü≥Á¨¶',
                'time.2-4': '2/4 Êãç',
                'time.3-4': '3/4 Êãç',
                'time.4-4': '4/4 Êãç',
                'time.6-8': '6/8 Êãç',
                'button.selectAll': 'ÂÖ®ÈÄâ',
                'button.selectAllMajor': 'ÂÖ®ÈÄâ',
                'button.selectAllMinor': 'ÂÖ®ÈÄâ',
                'button.save': '‰øùÂ≠òËÆæÁΩÆ',
                'button.cancel': 'ÂèñÊ∂à',
                'button.advanced': 'È´òÁ∫ßËÆæÁΩÆ',
                'button.hideAdvanced': 'ÈöêËóèÈ´òÁ∫ßËÆæÁΩÆ',
                'button.resetDefault': 'ËøîÂõûÈªòËÆ§',
            },
            'zh-TW': {
                'app.title': 'IC Studio - Ë¶ñÂ•èÊóãÂæãÁîüÊàêÂô®',
                'app.subtitle': 'Â∞àÊ•≠Á¥öÊ®ÇË≠úÊ∏≤ÊüìËàáÈü≥Ê®ÇÁêÜË´ñÂ∑•ÂÖ∑',
                'app.melodyMode': 'ÊóãÂæãË¶ñÂ•è',
                'app.intervalMode': 'Èü≥Á®ãË¶ñÂ•è',
                'app.chordMode': 'ÂíåÂº¶Ë¶ñÂ•è',
                'controls.interval': 'Èü≥Á®ãË∑®Â∫¶',
                'controls.intervalSettings': 'Èü≥Á®ãË®≠ÁΩÆ',
                'controls.measures': 'Â∞èÁØÄÊï∏',
                'controls.measures2': '2Â∞èÁØÄ',
                'controls.measures4': '4Â∞èÁØÄ',
                'controls.measures8': '8Â∞èÁØÄ',
                'controls.key': 'Ë™øËôü',
                'controls.keySettings': 'Ë™øËôüË®≠ÁΩÆ',
                'controls.time': 'ÊãçËôü',
                'controls.timeSettings': 'ÊãçËôüË®≠ÁΩÆ',
                'controls.clef': 'Ë≠úËôü',
                'controls.clefSettings': 'Ë≠úËôüË®≠ÁΩÆ',
                'controls.rangeMin': 'ÊúÄ‰ΩéÈü≥',
                'controls.rangeMax': 'ÊúÄÈ´òÈü≥',
                'controls.accidental': 'Ëá®ÊôÇË®òËôü',
                'controls.metronome': 'ÁØÄÊãçÂô®',
                'controls.generate': 'ÁîüÊàêÊóãÂæã',
                'controls.previous': '‰∏ä‰∏ÄÊ¢ù',
                'controls.next': '‰∏ã‰∏ÄÊ¢ù',
                'controls.play': 'Êí≠Êîæ',
                'controls.stop': 'ÂÅúÊ≠¢',
                'controls.tempo': 'ÈÄüÂ∫¶',
                'controls.playbackNote': 'Êí≠ÊîæÈÄüÂ∫¶Ë∑üÈö®ÁØÄÊãçÂô®Ë®≠ÁΩÆ',
                'controls.rhythm': 'ÁØÄÂ•èË®≠ÁΩÆ',
                'controls.articulation': 'ÊºîÂ•èÊäÄÂ∑ß',
                'score.empty': 'ÈªûÊìäÁîüÊàêÊóãÂæãÈñãÂßãÁ∑¥Áøí',
                'settings.title': 'Ë®≠ÁΩÆ',
                'settings.theme': '‰∏ªÈ°å',
                'settings.language': 'Ë™ûË®Ä',
                'settings.lightMode': 'Ê∑∫Ëâ≤Ê®°Âºè',
                'settings.darkMode': 'Ê∑±Ëâ≤Ê®°Âºè',
                'settings.metronome': 'ÁØÄÊãçÂô®',
                'settings.tempo': 'ÈÄüÂ∫¶ (BPM)',
                'settings.startMetronome': 'ÈñãÂßãÁØÄÊãçÂô®',
                'settings.stopMetronome': 'ÂÅúÊ≠¢ÁØÄÊãçÂô®',
                // Modal titles
                'modal.rhythm.title': 'ÁØÄÂ•èË®≠ÁΩÆ',
                'modal.keySignature.title': 'Ë™øËôüË®≠ÁΩÆ',
                'modal.timeSignature.title': 'ÊãçËôüË®≠ÁΩÆ',
                'modal.interval.title': 'Èü≥Á®ãË∑®Â∫¶Ë®≠ÁΩÆ',
                'modal.clef.title': 'Ë≠úËôüË®≠ÁΩÆ',
                'modal.articulation.title': 'Articulations',
                // Modal content
                'modal.rhythm.basicUnit': 'Âü∫Êú¨ÁØÄÂ•èÂñÆ‰Ωç',
                'modal.keySignature.major': 'Â§ßË™ø (Major)',
                'modal.keySignature.minor': 'Â∞èË™ø (Minor)',
                'modal.timeSignature.selection': 'ÊãçËôüÈÅ∏È†Ö',
                'modal.interval.selection': 'ÊúÄÂ§ßÈü≥Á®ãË∑®Â∫¶ÈÅ∏È†Ö',
                'modal.clef.selection': 'Ë≠úËôüÈÅ∏È†Ö',
                // Clef types
                'clef.options': 'Ë≠úËôüÈÅ∏È†Ö',
                'clef.treble': 'È´òÈü≥Ë≠úËôü (GË≠úËôü)',
                'clef.bass': '‰ΩéÈü≥Ë≠úËôü (FË≠úËôü)',
                'clef.alto': '‰∏≠Èü≥Ë≠úËôü (CË≠úËôü)',
                // Articulation types
                'articulation.basic.title': 'Âü∫Êú¨ÊºîÂ•èÊ≥ï (Basic Articulations)',
                'articulation.guitar.title': 'Âêâ‰ªñÊäÄÂ∑ß (Guitar Techniques)',
                'articulation.staccato': 'Staccato (Êñ∑Â•è) ‚Ä¢',
                'articulation.accent': 'Accent (ÈáçÈü≥) >',
                'articulation.acciaccatura': 'Acciaccatura (Áü≠ÂÄöÈü≥)',
                'articulation.hammer': 'Hammer-on (ÊìäÂº¶) H',
                'articulation.pulloff': 'Pull-off (ÂãæÂº¶) P',
                'articulation.advancedFreq': 'È´òÁ¥öÈ†ªÁéáË®≠ÁΩÆ',
                'rhythm.advancedFreq': 'È´òÁ¥öÈ†ªÁéáË®≠ÁΩÆ',
                'rhythm.freqDesc': 'Ë™øÊï¥ÂêÑÁØÄÂ•èÂñÆ‰ΩçÂú®ÊóãÂæã‰∏≠ÁöÑÂá∫ÁèæÈ†ªÁéá (0% = ‰∏ç‰ΩøÁî®, 100% = ÂÑ™ÂÖà‰ΩøÁî®)',
                'articulation.freqDesc': 'Ë™øÊï¥ÂêÑÊºîÂ•èÊ≥ïÂú®ÊóãÂæã‰∏≠ÁöÑÂá∫ÁèæÈ†ªÁéá (0% = ‰∏ç‰ΩøÁî®, 100% = Á∂ìÂ∏∏‰ΩøÁî®)',
                'articulation.basicFreq': 'Âü∫Êú¨ÊºîÂ•èÊ≥ïÈ†ªÁéá',
                'articulation.guitarFreq': 'Âêâ‰ªñÊäÄÂ∑ßÈ†ªÁéá',
                'articulation.freq.staccato': 'Staccato (Êñ∑Â•è) È†ªÁéá:',
                'articulation.freq.accent': 'Accent (ÈáçÈü≥) È†ªÁéá:',
                'articulation.freq.acciaccatura': 'Acciaccatura (Áü≠ÂÄöÈü≥) È†ªÁéá:',
                'articulation.freq.slur': 'ÊìäÂãæÂº¶È†ªÁéá:',
                // Interval types
                'interval.singleSelect': 'Âè™ËÉΩÈÅ∏Êìá‰∏ÄÂÄãÈü≥Á®ã‰ΩúÁÇ∫ÊúÄÂ§ßË∑®Â∫¶',
                'interval.minor2nd': 'Â∞è‰∫åÂ∫¶',
                'interval.major2nd': 'Â§ß‰∫åÂ∫¶',
                'interval.minor3rd': 'Â∞è‰∏âÂ∫¶',
                'interval.major3rd': 'Â§ß‰∏âÂ∫¶',
                'interval.perfect4th': 'ÂÆåÂÖ®ÂõõÂ∫¶',
                'interval.tritone': 'Â¢ûÂõõÂ∫¶/Ê∏õ‰∫îÂ∫¶',
                'interval.perfect5th': 'ÂÆåÂÖ®‰∫îÂ∫¶',
                'interval.minor6th': 'Â∞èÂÖ≠Â∫¶',
                'interval.major6th': 'Â§ßÂÖ≠Â∫¶',
                'interval.minor7th': 'Â∞è‰∏ÉÂ∫¶',
                'interval.major7th': 'Â§ß‰∏ÉÂ∫¶',
                'interval.perfect8th': 'ÂÆåÂÖ®ÂÖ´Â∫¶',
                // Rhythm types
                'rhythm.whole': 'ÂÖ®Èü≥Á¨¶',
                'rhythm.dottedHalf': 'ÈôÑÈªû‰∫åÂàÜÈü≥Á¨¶',
                'rhythm.half': '‰∫åÂàÜÈü≥Á¨¶',
                'rhythm.dottedQuarter': 'ÈôÑÈªûÂõõÂàÜÈü≥Á¨¶',
                'rhythm.quarter': 'ÂõõÂàÜÈü≥Á¨¶',
                'rhythm.eighth': 'ÂÖ´ÂàÜÈü≥Á¨¶',
                'rhythm.sixteenth': 'ÂçÅÂÖ≠ÂàÜÈü≥Á¨¶',
                'rhythm.triplet': '‰∏âÈÄ£Èü≥',
                'rhythm.duplet': '‰∫åÈÄ£Èü≥',
                'rhythm.quadruplet': 'ÂõõÈÄ£Èü≥',
                'rhythm.dottedOptions': 'ÈôÑÈªûÈü≥Á¨¶ÈÅ∏È†Ö',
                'rhythm.allowDotted': 'ÂÖÅË®±ÈôÑÈªûÈü≥Á¨¶ (Ê†πÊìöÂ∑≤ÈÅ∏ÁØÄÂ•èËá™ÂãïÁîüÊàêÈôÑÈªûÁâàÊú¨)',
                'rhythm.freq.whole': 'ÂÖ®Èü≥Á¨¶È†ªÁéá:',
                'rhythm.freq.dottedHalf': 'ÈôÑÈªû‰∫åÂàÜÈü≥Á¨¶È†ªÁéá:',
                'rhythm.freq.half': '‰∫åÂàÜÈü≥Á¨¶È†ªÁéá:',
                'rhythm.freq.dottedQuarter': 'ÈôÑÈªûÂõõÂàÜÈü≥Á¨¶È†ªÁéá:',
                'rhythm.freq.quarter': 'ÂõõÂàÜÈü≥Á¨¶È†ªÁéá:',
                'rhythm.freq.dottedEighth': 'ÈôÑÈªûÂÖ´ÂàÜÈü≥Á¨¶È†ªÁéá:',
                'rhythm.freq.eighth': 'ÂÖ´ÂàÜÈü≥Á¨¶È†ªÁéá:',
                'rhythm.freq.sixteenth': 'ÂçÅÂÖ≠ÂàÜÈü≥Á¨¶È†ªÁéá:',
                'rhythm.freq.triplet': '‰∏âÈÄ£Èü≥È†ªÁéá:',
                'rhythm.dottedDesc': 'ÂãæÈÅ∏ÂæåÂ∞áËá™ÂãïÁÇ∫Â∑≤ÈÅ∏ÊìáÁöÑÁØÄÂ•èÈ°ûÂûãÁîüÊàêÈôÑÈªûÁâàÊú¨',
                'rhythm.dottedExample': '‰æãÂ¶ÇÔºöÂãæÈÅ∏ÂõõÂàÜÈü≥Á¨¶+ÈôÑÈªûÈü≥Á¨¶ ‚Üí ÂèØÁîüÊàêÂõõÂàÜÈü≥Á¨¶ÂíåÈôÑÈªûÂõõÂàÜÈü≥Á¨¶',
                'time.2-4': '2/4 Êãç',
                'time.3-4': '3/4 Êãç',
                'time.4-4': '4/4 Êãç',
                'time.6-8': '6/8 Êãç',
                'button.selectAll': 'ÂÖ®ÈÅ∏',
                'button.selectAllMajor': 'ÂÖ®ÈÅ∏Â§ßË™ø',
                'button.selectAllMinor': 'ÂÖ®ÈÅ∏Â∞èË™ø',
                'button.save': '‰øùÂ≠òË®≠ÁΩÆ',
                'button.cancel': 'ÂèñÊ∂à',
                'button.advanced': 'È´òÁ¥öË®≠ÁΩÆ',
                'button.hideAdvanced': 'Èö±ËóèÈ´òÁ¥öË®≠ÁΩÆ',
                'button.resetDefault': 'ËøîÂõûÈªòË™ç',
            },
            'en': {
                'app.title': 'IC Studio - Sight-Reading Generator',
                'app.subtitle': 'Professional Music Score Rendering & Music Theory Tool',
                'app.melodyMode': 'Melody Sight-Reading',
                'app.intervalMode': 'Interval Sight-Reading',
                'app.chordMode': 'Chord Sight-Reading',
                'controls.interval': 'Interval Range',
                'controls.intervalSettings': 'Interval Settings',
                'controls.measures': 'Measures',
                'controls.measures2': '2 Measures',
                'controls.measures4': '4 Measures',
                'controls.measures8': '8 Measures',
                'controls.key': 'Key Signature',
                'controls.keySettings': 'Key Settings',
                'controls.time': 'Time Signature',
                'controls.timeSettings': 'Time Settings',
                'controls.clef': 'Clef',
                'controls.clefSettings': 'Clef Settings',
                'controls.rangeMin': 'Lowest Note',
                'controls.rangeMax': 'Highest Note',
                'controls.accidental': 'Accidentals',
                'controls.metronome': 'Metronome',
                'controls.generate': 'Generate Melody',
                'controls.previous': 'Previous',
                'controls.next': 'Next',
                'controls.play': 'Play',
                'controls.stop': 'Stop',
                'controls.tempo': 'Tempo',
                'controls.playbackNote': 'Playback follows metronome tempo',
                'controls.rhythm': 'Rhythm Settings',
                'controls.articulation': 'Articulations',
                'score.empty': 'Click Generate Melody to Start Practice',
                'settings.title': 'Settings',
                'settings.theme': 'Theme',
                'settings.language': 'Language',
                'settings.lightMode': 'Light Mode',
                'settings.darkMode': 'Dark Mode',
                'settings.metronome': 'Metronome',
                'settings.tempo': 'Tempo (BPM)',
                'settings.startMetronome': 'Start Metronome',
                'settings.stopMetronome': 'Stop Metronome',
                // Modal titles
                'modal.rhythm.title': 'Rhythm Settings',
                'modal.keySignature.title': 'Key Signature Settings',
                'modal.timeSignature.title': 'Time Signature Settings',
                'modal.interval.title': 'Interval Range Settings',
                'modal.clef.title': 'Clef Settings',
                'modal.articulation.title': 'Articulations',
                // Modal content
                'modal.rhythm.basicUnit': 'Basic Rhythm Unit',
                'modal.keySignature.major': 'Major',
                'modal.keySignature.minor': 'Minor',
                'modal.timeSignature.selection': 'Time Signature Options',
                'modal.interval.selection': 'Maximum Interval Range Options',
                'modal.clef.selection': 'Clef Options',
                // Clef types
                'clef.options': 'Clef Options',
                'clef.treble': 'Treble Clef (G Clef)',
                'clef.bass': 'Bass Clef (F Clef)',
                'clef.alto': 'Alto Clef (C Clef)',
                // Articulation types
                'articulation.basic.title': 'Basic Articulations',
                'articulation.guitar.title': 'Guitar Techniques',
                'articulation.staccato': 'Staccato ‚Ä¢',
                'articulation.accent': 'Accent >',
                'articulation.acciaccatura': 'Acciaccatura',
                'articulation.hammer': 'Hammer-on H',
                'articulation.pulloff': 'Pull-off P',
                'articulation.advancedFreq': 'Advanced Frequency Settings',
                'rhythm.advancedFreq': 'Advanced Frequency Settings',
                'rhythm.freqDesc': 'Adjust the frequency of each rhythm unit in melody generation (0% = not used, 100% = preferred)',
                'articulation.freqDesc': 'Adjust frequency of each articulation in melody (0% = not used, 100% = frequently used)',
                'articulation.basicFreq': 'Basic Articulation Frequency',
                'articulation.guitarFreq': 'Guitar Technique Frequency',
                'articulation.freq.staccato': 'Staccato Frequency:',
                'articulation.freq.accent': 'Accent Frequency:',
                'articulation.freq.acciaccatura': 'Acciaccatura Frequency:',
                'articulation.freq.slur': 'Hammer-on/Pull-off Frequency:',
                // Interval types
                'interval.singleSelect': 'Can only select one interval as maximum span',
                'interval.minor2nd': 'Minor 2nd',
                'interval.major2nd': 'Major 2nd',
                'interval.minor3rd': 'Minor 3rd',
                'interval.major3rd': 'Major 3rd',
                'interval.perfect4th': 'Perfect 4th',
                'interval.tritone': 'Tritone (Aug 4th/Dim 5th)',
                'interval.perfect5th': 'Perfect 5th',
                'interval.minor6th': 'Minor 6th',
                'interval.major6th': 'Major 6th',
                'interval.minor7th': 'Minor 7th',
                'interval.major7th': 'Major 7th',
                'interval.perfect8th': 'Perfect 8th (Octave)',
                // Rhythm types
                'rhythm.whole': 'Whole Note',
                'rhythm.dottedHalf': 'Dotted Half Note',
                'rhythm.half': 'Half Note',
                'rhythm.dottedQuarter': 'Dotted Quarter Note',
                'rhythm.quarter': 'Quarter Note',
                'rhythm.eighth': 'Eighth Note',
                'rhythm.sixteenth': 'Sixteenth Note',
                'rhythm.triplet': 'Triplet',
                'rhythm.duplet': 'Duplet',
                'rhythm.quadruplet': 'Quadruplet',
                'rhythm.dottedOptions': 'Dotted Note Options',
                'rhythm.allowDotted': 'Allow Dotted Notes (Auto-generate dotted versions based on selected rhythms)',
                'rhythm.freq.whole': 'Whole Note Frequency:',
                'rhythm.freq.dottedHalf': 'Dotted Half Note Frequency:',
                'rhythm.freq.half': 'Half Note Frequency:',
                'rhythm.freq.dottedQuarter': 'Dotted Quarter Note Frequency:',
                'rhythm.freq.quarter': 'Quarter Note Frequency:',
                'rhythm.freq.dottedEighth': 'Dotted Eighth Note Frequency:',
                'rhythm.freq.eighth': 'Eighth Note Frequency:',
                'rhythm.freq.sixteenth': 'Sixteenth Note Frequency:',
                'rhythm.freq.triplet': 'Triplet Frequency:',
                'rhythm.dottedDesc': 'Auto-generate dotted versions for selected rhythm types when checked',
                'rhythm.dottedExample': 'Example: Select quarter note + dotted notes ‚Üí generates both quarter notes and dotted quarter notes',
                'time.2-4': '2/4 Time',
                'time.3-4': '3/4 Time',
                'time.4-4': '4/4 Time',
                'time.6-8': '6/8 Time',
                'button.selectAll': 'Select All',
                'button.selectAllMajor': 'Select All Major',
                'button.selectAllMinor': 'Select All Minor',
                'button.save': 'Save Settings',
                'button.cancel': 'Cancel',
                'button.advanced': 'Advanced Settings',
                'button.hideAdvanced': 'Hide Advanced Settings',
                'button.resetDefault': 'Reset to Default',
            }
        };

        // ËØ≠Ë®ÄÂàáÊç¢Áõ∏ÂÖ≥ÂèòÈáè
        let currentLanguage = 'zh-CN'; // ÈªòËÆ§ÂÄºÔºåÁ®çÂêéÂú®DOMContentLoaded‰∏≠Ê≠£Á°ÆÂàùÂßãÂåñ
        
        // ËØ≠Ë®ÄÊåâÈíÆÊòæÁ§∫ÊñáÊú¨
        const languageLabels = {
            'zh-CN': 'üåê ÁÆÄ‰Ωì‰∏≠Êñá',
            'zh-TW': 'üåê ÁπÅÈ´î‰∏≠Êñá',
            'en': 'üåê English'
        };


        // ÂàáÊç¢ËØ≠Ë®Ä
        function switchLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('preferredLanguage', lang);

            // Êõ¥Êñ∞ÊåâÈíÆÊñáÊú¨ (Â¶ÇÊûúÂ≠òÂú®ÊóßÁöÑËØ≠Ë®ÄÊåâÈíÆ)
            const languageBtn = document.getElementById('languageBtn');
            if (languageBtn) {
                languageBtn.textContent = languageLabels[lang];
            }

            // Â∫îÁî®ÁøªËØë
            applyTranslations();

            // Ëß¶ÂèëÁªü‰∏ÄÂêåÊ≠•Á≥ªÁªü (ÂêåÊ†áÁ≠æÈ°µÂÜÖÂÆûÊó∂ÂêåÊ≠•)
            if (window.ICStudioSync) {
                window.ICStudioSync.syncLanguage(lang, 'melody-tool');
            }

            // ÂÖ≥Èó≠ËÆæÁΩÆËèúÂçï
            closeSettings();
            
            console.log(`üåê ËØ≠Ë®ÄÂ∑≤ÂàáÊç¢Âà∞: ${lang}`);
        }

        // Â∫îÁî®ÁøªËØë
        function applyTranslations() {
            const elements = document.querySelectorAll('[data-i18n]');
            const currentTranslations = translations[currentLanguage] || translations['zh-CN'];

            elements.forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (currentTranslations[key]) {
                    // Ê£ÄÊü•ÂÖÉÁ¥†ÊòØÂê¶Âè™ÂåÖÂê´ÊñáÊú¨ÂÜÖÂÆπÔºàÊ≤°ÊúâÂ≠êÂÖÉÁ¥†Ôºâ
                    if (element.children.length === 0) {
                        // Âè™ÊúâÊñáÊú¨ÂÜÖÂÆπÔºåÁõ¥Êé•ÊõøÊç¢
                        element.textContent = currentTranslations[key];
                    } else {
                        // ÊúâÂ≠êÂÖÉÁ¥†ÔºåÈúÄË¶Å‰øùÁïôÁªìÊûÑÔºåÂè™ÊõøÊç¢ÊñáÊú¨ËäÇÁÇπ
                        const textNodes = [];
                        const walker = document.createTreeWalker(
                            element,
                            NodeFilter.SHOW_TEXT,
                            null,
                            false
                        );
                        let node;
                        while (node = walker.nextNode()) {
                            if (node.nodeValue.trim()) {
                                textNodes.push(node);
                            }
                        }

                        // Â¶ÇÊûúÂè™Êúâ‰∏Ä‰∏™‰∏ªË¶ÅÊñáÊú¨ËäÇÁÇπÔºåÊõøÊç¢ÂÆÉ
                        if (textNodes.length === 1) {
                            textNodes[0].nodeValue = currentTranslations[key];
                        } else {
                            // Â§çÊùÇÁªìÊûÑÔºå‰ΩøÁî®textContent‰Ωú‰∏∫ÂêéÂ§á
                            element.textContent = currentTranslations[key];
                        }
                    }
                }
            });
        }

        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñËØ≠Ë®Ä
        document.addEventListener('DOMContentLoaded', function() {
            // Ê£ÄÊü•ÊòØÂê¶Êúâ‰øùÂ≠òÁöÑËØ≠Ë®ÄÂÅèÂ•Ω
            const savedLanguage = localStorage.getItem('preferredLanguage');

            if (savedLanguage) {
                // Â¶ÇÊûúÊúâ‰øùÂ≠òÁöÑËØ≠Ë®ÄÂÅèÂ•ΩÔºåËÆæÁΩÆÂΩìÂâçËØ≠Ë®ÄÂπ∂ÊòæÁ§∫ÂØπÂ∫îËØ≠Ë®ÄÂêçÁß∞
                currentLanguage = savedLanguage;
                const languageBtn = document.getElementById('languageBtn');
                if (languageBtn) {
                    languageBtn.textContent = languageLabels[currentLanguage];
                }
            } else {
                // Â¶ÇÊûúÊ≤°Êúâ‰øùÂ≠òÁöÑËØ≠Ë®ÄÂÅèÂ•ΩÔºå‰ΩøÁî®ÈªòËÆ§ÁöÑ‰∏≠ÊñáÔºåÊòæÁ§∫ÈªòËÆ§ÁöÑ üåê Êñá/A
                currentLanguage = 'zh-CN';
                const languageBtn = document.getElementById('languageBtn');
                if (languageBtn) {
                    languageBtn.textContent = 'üåê Êñá/A';
                }
            }

            // Â∫îÁî®ÁøªËØë
            applyTranslations();

            console.log(`üåê ÊóãÂæãÂ∑•ÂÖ∑ÂàùÂßãÂåñËØ≠Ë®Ä: ${currentLanguage}`);

            // ============ ÈôÑÁÇπÈü≥Á¨¶ËÆæÁΩÆ‰øùÂ≠ò/ÊÅ¢Â§ç ============
            const allowDottedNotesCheckbox = document.getElementById('allowDottedNotes');
            if (allowDottedNotesCheckbox) {
                // ÁâàÊú¨ÊéßÂà∂ÔºöÂº∫Âà∂Êñ∞Áî®Êà∑ÂíåÂçáÁ∫ßÁî®Êà∑‰ΩøÁî®Êñ∞ÈªòËÆ§ÂÄº
                const settingsVersion = localStorage.getItem('melodySettingsVersion');
                const currentVersion = '2.0'; // ÁâàÊú¨ 2.0ÔºöÈôÑÁÇπÈü≥Á¨¶ÈªòËÆ§ÂãæÈÄâ

                if (settingsVersion !== currentVersion) {
                    // ÁâàÊú¨ÂçáÁ∫ßÊàñÈ¶ñÊ¨°ËÆøÈóÆÔºå‰ΩøÁî®Êñ∞ÁöÑÈªòËÆ§ÂÄº
                    allowDottedNotesCheckbox.checked = true;
                    localStorage.setItem('allowDottedNotes', 'true');
                    localStorage.setItem('melodySettingsVersion', currentVersion);
                    console.log(`üîÑ ËÆæÁΩÆÁâàÊú¨ÂçáÁ∫ßÂà∞ ${currentVersion}Ôºå‰ΩøÁî®Êñ∞ÈªòËÆ§ÂÄº`);
                } else {
                    // ÊÅ¢Â§ç‰øùÂ≠òÁöÑÁä∂ÊÄÅ
                    const savedDottedState = localStorage.getItem('allowDottedNotes');
                    allowDottedNotesCheckbox.checked = (savedDottedState === 'true');
                }

                // ÁõëÂê¨ÂèòÂåñÂπ∂‰øùÂ≠ò
                allowDottedNotesCheckbox.addEventListener('change', function() {
                    localStorage.setItem('allowDottedNotes', this.checked);
                    console.log(`üíæ ÈôÑÁÇπÈü≥Á¨¶ËÆæÁΩÆÂ∑≤‰øùÂ≠ò: ${this.checked}`);
                });

                console.log(`‚úÖ ÈôÑÁÇπÈü≥Á¨¶ËÆæÁΩÆÂàùÂßãÂåñ: ${allowDottedNotesCheckbox.checked}`);
            }

            // ============ Ë∑®Â∑•ÂÖ∑ÂêåÊ≠•ÁõëÂê¨Êú∫Âà∂ ============
            // ÁõëÂê¨ÂÖ∂‰ªñÂ∑•ÂÖ∑ÂØπlocalStorageÁöÑ‰øÆÊîπ
            window.addEventListener('storage', function(e) {
                if (e.key === 'preferredTheme' && e.newValue !== currentTheme) {
                    console.log(`üîÑ ÊóãÂæãËßÜÂ•èÂ∑•ÂÖ∑Ê£ÄÊµãÂà∞‰∏ªÈ¢òÂèòÂåñ: ${currentTheme} ‚Üí ${e.newValue}`);
                    currentTheme = e.newValue;
                    document.documentElement.setAttribute('data-theme', currentTheme);
                    console.log(`üé® ÊóãÂæãËßÜÂ•èÂ∑•ÂÖ∑‰∏ªÈ¢òÂ∑≤ÂêåÊ≠•‰∏∫: ${currentTheme}`);
                }

                if (e.key === 'preferredLanguage' && e.newValue !== currentLanguage) {
                    console.log(`üîÑ ÊóãÂæãËßÜÂ•èÂ∑•ÂÖ∑Ê£ÄÊµãÂà∞ËØ≠Ë®ÄÂèòÂåñ: ${currentLanguage} ‚Üí ${e.newValue}`);
                    currentLanguage = e.newValue;
                    applyTranslations();
                    console.log(`üåê ÊóãÂæãËßÜÂ•èÂ∑•ÂÖ∑ËØ≠Ë®ÄÂ∑≤ÂêåÊ≠•‰∏∫: ${currentLanguage}`);
                }
            });

            console.log('üîó ÊóãÂæãËßÜÂ•èÂ∑•ÂÖ∑localStorageË∑®Â∑•ÂÖ∑ÂêåÊ≠•ÁõëÂê¨Â∑≤ÂêØÁî®');

            // ============ Áªü‰∏ÄÂêåÊ≠•Á≥ªÁªü ============
            // ÂàõÂª∫ÂÖ®Â±ÄÂêåÊ≠•ÂáΩÊï∞ÔºåÊîØÊåÅÂêåÊ†áÁ≠æÈ°µÂÜÖÂÆûÊó∂ÂêåÊ≠•
            window.ICStudioSync = window.ICStudioSync || {
                tools: new Set(),

                // Ê≥®ÂÜåÂ∑•ÂÖ∑
                registerTool: function(toolName, callbacks) {
                    this.tools.add({
                        name: toolName,
                        onThemeChange: callbacks.onThemeChange,
                        onLanguageChange: callbacks.onLanguageChange
                    });
                    console.log(`üîó ${toolName} Â∑≤Ê≥®ÂÜåÂà∞Áªü‰∏ÄÂêåÊ≠•Á≥ªÁªü`);
                },

                // ÂêåÊ≠•‰∏ªÈ¢òÂà∞ÊâÄÊúâÂ∑•ÂÖ∑
                syncTheme: function(newTheme, fromTool) {
                    console.log(`üîÑ Áªü‰∏ÄÂêåÊ≠•Á≥ªÁªü: ÂêåÊ≠•‰∏ªÈ¢ò ${newTheme} (Êù•Ê∫ê: ${fromTool})`);
                    this.tools.forEach(tool => {
                        if (tool.name !== fromTool && tool.onThemeChange) {
                            try {
                                tool.onThemeChange(newTheme);
                            } catch (error) {
                                console.warn(`‚ö†Ô∏è ${tool.name} ‰∏ªÈ¢òÂêåÊ≠•Â§±Ë¥•:`, error);
                            }
                        }
                    });
                },

                // ÂêåÊ≠•ËØ≠Ë®ÄÂà∞ÊâÄÊúâÂ∑•ÂÖ∑
                syncLanguage: function(newLanguage, fromTool) {
                    console.log(`üîÑ Áªü‰∏ÄÂêåÊ≠•Á≥ªÁªü: ÂêåÊ≠•ËØ≠Ë®Ä ${newLanguage} (Êù•Ê∫ê: ${fromTool})`);
                    this.tools.forEach(tool => {
                        if (tool.name !== fromTool && tool.onLanguageChange) {
                            try {
                                tool.onLanguageChange(newLanguage);
                            } catch (error) {
                                console.warn(`‚ö†Ô∏è ${tool.name} ËØ≠Ë®ÄÂêåÊ≠•Â§±Ë¥•:`, error);
                            }
                        }
                    });
                }
            };

            // Ê≥®ÂÜåÊóãÂæãÂ∑•ÂÖ∑Âà∞Áªü‰∏ÄÂêåÊ≠•Á≥ªÁªü
            window.ICStudioSync.registerTool('melody-tool', {
                onThemeChange: function(newTheme) {
                    if (currentTheme !== newTheme) {
                        console.log(`üé® ÊóãÂæãÂ∑•ÂÖ∑Êé•Êî∂‰∏ªÈ¢òÂêåÊ≠•: ${currentTheme} ‚Üí ${newTheme}`);
                        currentTheme = newTheme;
                        document.documentElement.setAttribute('data-theme', currentTheme);
                    }
                },
                onLanguageChange: function(newLanguage) {
                    if (currentLanguage !== newLanguage) {
                        console.log(`üåê ÊóãÂæãÂ∑•ÂÖ∑Êé•Êî∂ËØ≠Ë®ÄÂêåÊ≠•: ${currentLanguage} ‚Üí ${newLanguage}`);
                        currentLanguage = newLanguage;
                        applyTranslations();
                    }
                }
            });
        });
    </script>

    <script>
        // ÈáçÂÜôÊ®°ÊÄÅÊ°ÜÂÖ≥Èó≠ÂáΩÊï∞‰ª•ÈáçÁΩÆÂÖ®ÈÄâÁä∂ÊÄÅ
        const originalCloseRhythmSettings = window.closeRhythmSettings;
        const originalCloseArticulationSettings = window.closeArticulationSettings;
        const originalCloseKeySettings = window.closeKeySettings;
        const originalCloseTimeSignatureSettings = window.closeTimeSignatureSettings;
        const originalCloseIntervalSettings = window.closeIntervalSettings;
        const originalCloseClefSettings = window.closeClefSettings;

        if (typeof originalCloseRhythmSettings === 'function') {
            window.closeRhythmSettings = function() {
                originalCloseRhythmSettings();
                if (typeof resetSelectAllStates === 'function') resetSelectAllStates();
            };
        }

        if (typeof originalCloseArticulationSettings === 'function') {
            window.closeArticulationSettings = function() {
                originalCloseArticulationSettings();
                if (typeof resetSelectAllStates === 'function') resetSelectAllStates();
            };
        }

        if (typeof originalCloseKeySettings === 'function') {
            window.closeKeySettings = function() {
                originalCloseKeySettings();
                if (typeof resetSelectAllStates === 'function') resetSelectAllStates();
            };
        }

        if (typeof originalCloseTimeSignatureSettings === 'function') {
            window.closeTimeSignatureSettings = function() {
                originalCloseTimeSignatureSettings();
                if (typeof resetSelectAllStates === 'function') resetSelectAllStates();
            };
        }

        if (typeof originalCloseIntervalSettings === 'function') {
            window.closeIntervalSettings = function() {
                originalCloseIntervalSettings();
                if (typeof resetSelectAllStates === 'function') resetSelectAllStates();
            };
        }

        if (typeof originalCloseClefSettings === 'function') {
            window.closeClefSettings = function() {
                originalCloseClefSettings();
                if (typeof resetSelectAllStates === 'function') resetSelectAllStates();
            };
        }

        // üåê ÁÆÄÂåñÁöÑÊ†áÁ≠æÁøªËØëÁ≥ªÁªüÔºàÁßªÈô§ÂÖ∑‰ΩìÈÄâÊã©ÂÜÖÂÆπÊòæÁ§∫Ôºâ
        // ‰∏ªÈ°µÈù¢ÊåâÈíÆÂè™ÊòæÁ§∫Âü∫Á°ÄÊ†áÁ≠æÔºå‰∏çÊòæÁ§∫ÂÖ∑‰ΩìÈÄâÊã©ÁöÑÂÜÖÂÆπ
        console.log('üåê ‰ΩøÁî®ÁÆÄÂåñÁöÑÊ†áÁ≠æÁøªËØëÁ≥ªÁªü - ‰∏ªÈ°µÈù¢ÊåâÈíÆÂè™ÊòæÁ§∫Âü∫Á°ÄÊ†áÁ≠æ');

        // Âä®ÊÄÅÈöêËóèÂåÖÂê´ÁâπÂÆöÊñáÊú¨ÁöÑSVGÂÖÉÁ¥†
        function hideTitleAndInstrumentElements() {
            // Á≠âÂæÖ‰∏Ä‰ºöÂÑøËÆ©OSMDÊ∏≤ÊüìÂÆåÊàê
            setTimeout(() => {
                const scoreDiv = document.getElementById('score');
                if (scoreDiv) {
                    // Êü•ÊâæÊâÄÊúâSVG textÂÖÉÁ¥†
                    const textElements = scoreDiv.querySelectorAll('svg text');
                    textElements.forEach(element => {
                        const text = element.textContent || element.innerText;
                        if (text && (
                            text.includes('Piano') || 
                            text.includes('Untitled') || 
                            text.includes('Untitled Score') ||
                            text.trim() === 'Piano' ||
                            text.trim() === 'Untitled Score'
                        )) {
                            element.style.display = 'none';
                            element.style.visibility = 'hidden';
                            console.log('ÈöêËóèÊñáÊú¨ÂÖÉÁ¥†:', text);
                        }
                    });
                    
                    // ‰πüÊ£ÄÊü•ÂÖ∂‰ªñÂèØËÉΩÁöÑÂÖÉÁ¥†
                    const allElements = scoreDiv.querySelectorAll('*');
                    allElements.forEach(element => {
                        const text = element.textContent || element.innerText;
                        if (text && element.tagName !== 'SCRIPT' && (
                            text.trim() === 'Piano' ||
                            text.trim() === 'Untitled Score'
                        )) {
                            element.style.display = 'none';
                            element.style.visibility = 'hidden';
                            console.log('ÈöêËóèÂÖÉÁ¥†:', element.tagName, text);
                        }
                    });

                    // üîß ‰øÆÂ§çÔºöÁßªÈô§Â§ö‰ΩôÁöÑÊñ≠Â•èÁÇπÔºàstaccato dotsÔºâ
                    removeExtraStaccatoDots();
                }
            }, 500);
        }

        // üîß ‰øÆÂ§çMusicXML‰∏≠ÁöÑÂ§ö‰ΩôÈôÑÁÇπ
        function cleanupExcessiveDots(musicXML) {
            console.log('üîß ÂºÄÂßãÊ∏ÖÁêÜMusicXML‰∏≠ÁöÑÂ§ö‰ΩôÈôÑÁÇπ...');

            // ÊñπÊ≥ï1ÔºöÂÆåÂÖ®ÁßªÈô§ÊâÄÊúâ <dot/> ÂÖÉÁ¥†
            let cleanedXML = musicXML.replace(/<dot\s*\/?>|<dot><\/dot>/g, '');

            // ÊñπÊ≥ï2ÔºöÂ¶ÇÊûúÈúÄË¶Å‰øùÁïôÂêàÁêÜÁöÑÈôÑÁÇπÔºåÂèØ‰ª•‰ΩøÁî®Êõ¥Á≤æÁ°ÆÁöÑÊ∏ÖÁêÜ
            // ËøôÈáåÊàë‰ª¨ÂÖàÁÆÄÂçïÂú∞ÁßªÈô§ÊâÄÊúâÈôÑÁÇπÔºåÂõ†‰∏∫ÁîüÊàêÁöÑÈü≥Á¨¶Â∫îËØ•ÈÉΩÊòØÂü∫Á°ÄÊó∂ÂÄº

            console.log('üîß Â∑≤ÁßªÈô§ÊâÄÊúâ <dot> ÂÖÉÁ¥†');

            return cleanedXML;
        }

        // üîß ‰øÆÂ§çÈôÑÁÇπÈóÆÈ¢òÔºöÁßªÈô§Â§ö‰ΩôÁöÑÊñ≠Â•èÁÇπ
        function removeExtraStaccatoDots() {
            const scoreDiv = document.getElementById('score');
            if (!scoreDiv) return;

            // Êü•ÊâæÊâÄÊúâÂèØËÉΩÁöÑÊñ≠Â•èÁÇπÂÖÉÁ¥†
            const svgElements = scoreDiv.querySelectorAll('svg circle, svg ellipse, svg use, svg path');

            let removedCount = 0;

            svgElements.forEach((element, index) => {
                // Ê£ÄÊü•ÊòØÂê¶ÊòØÂ∞èÂúÜÁÇπÔºàÊñ≠Â•èËÆ∞Âè∑Ôºâ
                if (element.tagName === 'circle') {
                    const radius = parseFloat(element.getAttribute('r')) || 0;
                    const cx = parseFloat(element.getAttribute('cx')) || 0;
                    const cy = parseFloat(element.getAttribute('cy')) || 0;

                    // Â¶ÇÊûúÊòØÂ∞èÂúÜÁÇπÔºàÂçäÂæÑÂ∞è‰∫é3ÔºâÔºåÂæàÂèØËÉΩÊòØÊñ≠Â•èËÆ∞Âè∑
                    if (radius > 0 && radius < 3) {
                        // ÈöêËóèËøô‰∏™ÂÖÉÁ¥†
                        element.style.display = 'none';
                        element.style.visibility = 'hidden';
                        removedCount++;
                    }
                }

                // Ê£ÄÊü•useÂÖÉÁ¥†ÔºàÂèØËÉΩÊòØÁ¨¶Âè∑ÂºïÁî®Ôºâ
                if (element.tagName === 'use') {
                    const href = element.getAttribute('href') || element.getAttribute('xlink:href') || '';
                    if (href.includes('staccato') || href.includes('dot') || href.includes('articulation')) {
                        element.style.display = 'none';
                        element.style.visibility = 'hidden';
                        removedCount++;
                    }
                }

                // Ê£ÄÊü•pathÂÖÉÁ¥†‰∏≠ÂèØËÉΩÁöÑÊñ≠Â•èÁÇπ
                if (element.tagName === 'path') {
                    const d = element.getAttribute('d') || '';
                    // Â¶ÇÊûúË∑ØÂæÑÂæàÁü≠‰∏îÂåÖÂê´ÂúÜÂºßÔºåÂèØËÉΩÊòØÊñ≠Â•èÁÇπ
                    if (d.length < 50 && (d.includes('C') || d.includes('A'))) {
                        const bbox = element.getBBox ? element.getBBox() : { width: 0, height: 0 };
                        if (bbox.width < 10 && bbox.height < 10) {
                            element.style.display = 'none';
                            element.style.visibility = 'hidden';
                            removedCount++;
                        }
                    }
                }
            });
        }
        
        // Ê∏ÖÈô§Á©∫Ë∞±Â≠êÊèêÁ§∫‰ø°ÊÅØ
        function clearEmptyScoreMessage() {
            const scoreDiv = document.getElementById('score');
            if (scoreDiv) {
                const emptyMessage = scoreDiv.querySelector('.empty-score-message');
                if (emptyMessage) {
                    emptyMessage.remove();
                }
            }
        }

        // ÁõëÂê¨OSMDÊ∏≤ÊüìÂÆåÊàê
        const originalGenerateMelody = window.generateMelody;
        if (originalGenerateMelody) {
            window.generateMelody = function(...args) {
                // Ëá™Âä®ÂÅúÊ≠¢ÂΩìÂâçÊí≠Êîæ
                if (window.isPlayingMelody) {
                    window.isPlayingMelody = false;
                    // ÂÅúÊ≠¢ÊâÄÊúâË∞ÉÂ∫¶ÁöÑÊí≠Êîæ
                    if (window.melodyScheduledSounds) {
                        window.melodyScheduledSounds.forEach(sound => {
                            try {
                                if (sound.oscillator) {
                                    sound.oscillator.stop();
                                }
                                if (sound.source) {
                                    sound.source.stop();
                                }
                                if (sound.element) {
                                    sound.element.pause();
                                    sound.element.src = '';
                                }
                            } catch (e) {
                                // ËäÇÁÇπÂèØËÉΩÂ∑≤ÁªèÂÅúÊ≠¢ÔºåÂøΩÁï•ÈîôËØØ
                            }
                        });
                        window.melodyScheduledSounds = [];
                    }
                    // Êõ¥Êñ∞Êí≠ÊîæÊåâÈíÆÁä∂ÊÄÅ
                    if (typeof updatePlayButton === 'function') {
                        updatePlayButton();
                    }
                }

                // Ê∏ÖÈô§Á©∫Ë∞±Â≠êÊèêÁ§∫‰ø°ÊÅØ
                clearEmptyScoreMessage();

                // üîí È¢ÑÈöêËóèÂÆπÂô®ÔºàÂèÇËÄÉÈü≥Á®ãËßÜÂ•èÂ∑•ÂÖ∑ÁöÑÂÆûÁé∞Ôºâ
                if (typeof isMelodyHidden !== 'undefined' && isMelodyHidden) {
                    const scoreEl = document.getElementById('score');
                    if (scoreEl) {
                        scoreEl.style.opacity = '0';
                        scoreEl.style.filter = 'blur(10px)';
                        console.log('üîí Ê∏≤ÊüìÂâçÈ¢ÑÈöêËóèÂÆπÂô®ÔºàÈÅøÂÖçÈó™Áé∞Ôºâ');
                    }
                }

                const result = originalGenerateMelody.apply(this, args);
                hideTitleAndInstrumentElements();
                // üîí ÈöêËóèÁä∂ÊÄÅÁé∞Âú®Âú® renderScore ‰∏≠Á´ãÂç≥Â∫îÁî®ÔºåÊó†ÈúÄÂª∂Ëøü
                return result;
            };
        }

        // ÂåÖË£Ö previousMelody Âíå nextMelodyÔºåÊ∑ªÂä†ÂÅúÊ≠¢Êí≠ÊîæÈÄªËæë
        const originalPreviousMelody = window.previousMelody;
        if (originalPreviousMelody) {
            window.previousMelody = function(...args) {
                // ÂàáÊç¢Êó∂Ëá™Âä®ÂÅúÊ≠¢Êí≠Êîæ
                if (window.isPlayingMelody) {
                    window.isPlayingMelody = false;
                    if (window.melodyScheduledSounds) {
                        window.melodyScheduledSounds.forEach(sound => {
                            try {
                                if (sound.oscillator) sound.oscillator.stop();
                                if (sound.source) sound.source.stop();
                                if (sound.element) {
                                    sound.element.pause();
                                    sound.element.src = '';
                                }
                            } catch (e) {}
                        });
                        window.melodyScheduledSounds = [];
                    }
                    if (typeof updatePlayButton === 'function') {
                        updatePlayButton();
                    }
                }
                return originalPreviousMelody.apply(this, args);
            };
        }

        const originalNextMelody = window.nextMelody;
        if (originalNextMelody) {
            window.nextMelody = function(...args) {
                // ÂàáÊç¢Êó∂Ëá™Âä®ÂÅúÊ≠¢Êí≠Êîæ
                if (window.isPlayingMelody) {
                    window.isPlayingMelody = false;
                    if (window.melodyScheduledSounds) {
                        window.melodyScheduledSounds.forEach(sound => {
                            try {
                                if (sound.oscillator) sound.oscillator.stop();
                                if (sound.source) sound.source.stop();
                                if (sound.element) {
                                    sound.element.pause();
                                    sound.element.src = '';
                                }
                            } catch (e) {}
                        });
                        window.melodyScheduledSounds = [];
                    }
                    if (typeof updatePlayButton === 'function') {
                        updatePlayButton();
                    }
                }
                return originalNextMelody.apply(this, args);
            };
        }
        
        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêé‰πüÊâßË°å‰∏ÄÊ¨°
        document.addEventListener('DOMContentLoaded', () => {
            hideTitleAndInstrumentElements();
            // ÂÆöÊúüÊ£ÄÊü•
            setInterval(hideTitleAndInstrumentElements, 2000);

            // üéµ Ê∑ªÂä†‰πêË∞±ÂÆπÂô®ÁÇπÂáª‰∫ã‰ª∂ÔºåËß¶ÂèëÁîüÊàêÊóãÂæã
            const scoreContainer = document.getElementById('score');
            if (scoreContainer) {
                scoreContainer.addEventListener('click', function(event) {
                    console.log('üéµ Áî®Êà∑ÁÇπÂáª‰πêË∞±ÂÆπÂô®ÔºåËß¶ÂèëÁîüÊàêÊóãÂæã');
                    // Ê£ÄÊü•ÊòØÂê¶ÁÇπÂáªÁöÑÊòØ‰πêË∞±ÂÜÖÂÆπËÄå‰∏çÊòØÊéßÂà∂ÊåâÈíÆ
                    if (!event.target.closest('button') && !event.target.closest('.control')) {
                        generateMelody();
                    }
                });
                // Ê∑ªÂä†Ê†∑ÂºèÊèêÁ§∫ÔºåËÆ©Áî®Êà∑Áü•ÈÅìÂÆπÂô®ÂèØ‰ª•ÁÇπÂáª
                scoreContainer.style.cursor = 'pointer';
                scoreContainer.title = 'ÁÇπÂáªÁîüÊàêÊñ∞ÊóãÂæã';
            }
        });

        // ====== Áõ¥Êé•Âú®HTML‰∏≠ÂÆö‰πâÁöÑÁÆÄÂçïÊí≠ÊîæÂô® ======
        console.log('üéπ Áõ¥Êé•Âú®HTML‰∏≠ÂàõÂª∫Êí≠ÊîæÂô®...');

        window.isPlayingMelody = false;
        window.melodyAudioCtx = null;
        window.melodyMetronomeSyncTimeout = null; // ËäÇÊãçÂô®ÂêåÊ≠•ÁöÑ setTimeout ID

        function directPlayTest() {
            console.log('üéµ Áõ¥Êé•Êí≠ÊîæË¢´Ë∞ÉÁî®');

            if (window.isPlayingMelody) {
                // ÂÅúÊ≠¢Êí≠Êîæ
                window.isPlayingMelody = false;

                // üîß Ê∏ÖÈô§ËäÇÊãçÂô®ÂêåÊ≠•ÁöÑ setTimeoutÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
                if (window.melodyMetronomeSyncTimeout) {
                    clearTimeout(window.melodyMetronomeSyncTimeout);
                    window.melodyMetronomeSyncTimeout = null;
                    console.log('‚èπÔ∏è Â∑≤Ê∏ÖÈô§ËäÇÊãçÂô®ÂêåÊ≠•ÂÆöÊó∂Âô®');
                }

                // ÂÅúÊ≠¢ÊâÄÊúâË∞ÉÂ∫¶ÁöÑÊí≠Êîæ
                if (window.melodyScheduledSounds) {
                    window.melodyScheduledSounds.forEach(sound => {
                        try {
                            // Â§ÑÁêÜÊåØËç°Âô®ËäÇÁÇπÔºàÂêàÊàêÂô®ÂõûÈÄÄÔºâ
                            if (sound.oscillator) {
                                sound.oscillator.stop();
                            }
                            // Â§ÑÁêÜÈááÊ†∑Âô®ÁöÑ BufferSource ËäÇÁÇπ
                            if (sound.source) {
                                sound.source.stop();
                            }
                            // Â§ÑÁêÜ HTMLAudioElementÔºàfile:// ÂçèËÆÆ‰∏ãÁöÑÂõûÈÄÄÔºâ
                            if (sound.element) {
                                sound.element.pause();
                                sound.element.src = '';
                            }
                        } catch (e) {
                            // ËäÇÁÇπÂèØËÉΩÂ∑≤ÁªèÂÅúÊ≠¢ÔºåÂøΩÁï•ÈîôËØØ
                        }
                    });
                    window.melodyScheduledSounds = [];
                }
                updatePlayButton();
                console.log('‚èπÔ∏è ÂÅúÊ≠¢Èí¢Áê¥Êí≠Êîæ');
                return;
            }

            try {
                // ÂàõÂª∫Èü≥È¢ë‰∏ä‰∏ãÊñá
                if (!window.melodyAudioCtx) {
                    window.melodyAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    console.log('üéπ ÂàõÂª∫‰∫ÜÊñ∞ÁöÑAudioContext');
                }

                // Ê£ÄÊü•Áä∂ÊÄÅ
                if (window.melodyAudioCtx.state === 'suspended') {
                    window.melodyAudioCtx.resume().then(() => {
                        console.log('üîÑ AudioContextÂ∑≤ÊÅ¢Â§ç');
                        // üîß ‰øÆÂ§çÔºöÊ£ÄÊü•ÊòØÂê¶Âú®resumeÊúüÈó¥Áî®Êà∑ÁÇπÂáª‰∫ÜÂÅúÊ≠¢
                        if (!window.isPlayingMelody) {
                            console.log('‚èπÔ∏è ResumeÂÆåÊàêÂâçÁî®Êà∑Â∑≤ÂÅúÊ≠¢ÔºåÂèñÊ∂àÊí≠Êîæ');
                            return;
                        }
                        startMelodyPlayback();
                    });
                } else {
                    startMelodyPlayback();
                }

            } catch (error) {
                console.error('‚ùå Êí≠ÊîæÈîôËØØ:', error);
                alert('Êí≠ÊîæÂá∫Èîô: ' + error.message);
            }
        }

        function startMelodyPlayback() {
            console.log('üéµ ÂºÄÂßãÊóãÂæãÊí≠Êîæ');

            // Ëé∑ÂèñÂΩìÂâçÊóãÂæãÊï∞ÊçÆ
            let melodyData = null;
            if (typeof getCurrentMelodyData === 'function') {
                melodyData = getCurrentMelodyData();
            } else {
                // Â¶ÇÊûúÂáΩÊï∞‰∏çÂ≠òÂú®ÔºåÂ∞ùËØï‰ªéÂÖ®Â±ÄÂèòÈáèËé∑Âèñ
                if (typeof melodyHistory !== 'undefined' && typeof currentHistoryIndex !== 'undefined' &&
                    melodyHistory && melodyHistory.length > 0 && currentHistoryIndex >= 0 &&
                    currentHistoryIndex < melodyHistory.length) {
                    melodyData = melodyHistory[currentHistoryIndex];
                    console.log('üìã ‰ªéÂÖ®Â±ÄÂèòÈáèËé∑ÂèñÊóãÂæãÊï∞ÊçÆ:', melodyData);
                }
            }

            if (!melodyData) {
                console.log('‚ö†Ô∏è Ê≤°ÊúâÊóãÂæãÊï∞ÊçÆÔºåÊí≠ÊîæÊµãËØïÈü≥Á¨¶');
                // ÂàùÂßãÂåñÈááÊ†∑Âô®ÔºàÊáíÂä†ËΩΩÔºâ
                if (!window.__icSamplePlayer && window.ICSamplePlayer) {
                    window.__icSamplePlayer = new ICSamplePlayer({ rootPath: 'assets/samples/piano-ogg' });
                    window.__icSamplePlayer.load();
                }
                playTestNote();
                return;
            }

            // Ê£ÄÊü•ÊòØÂê¶‰∏∫ÈöêËóèÊ®°Âºè
            const isHiddenMode = checkIfMelodyHidden();

            if (isHiddenMode) {
                console.log('üéº ÈöêËóèÊ®°ÂºèÊøÄÊ¥ªÔºåÂêØÂä®count-in + ËäÇÊãçÂô®');
                playCountInThenMelody(melodyData);
            } else {
                // üîß Êô∫ËÉΩÊí≠ÊîæÊó∂Èó¥ÔºöËäÇÊãçÂô®ÂºÄÂêØÊó∂ÂØπÈΩêÁΩëÊ†ºÔºåÂÖ≥Èó≠Êó∂Á´ãÂç≥ÂìçÂ∫î

                // Ëé∑ÂèñÂΩìÂâçÈÄüÂ∫¶
                let tempo = 60;
                if (typeof getCurrentTempo === 'function') {
                    tempo = getCurrentTempo();
                } else if (typeof metronomeTempo !== 'undefined') {
                    tempo = metronomeTempo;
                }

                const beatDuration = 60.0 / tempo;
                const now = window.melodyAudioCtx.currentTime;
                let startTime;

                if (typeof isMetronomeRunning !== 'undefined' && isMetronomeRunning) {
                    // üéµ ËäÇÊãçÂô®ÂºÄÂêØ - ÂØπÈΩêÂÖ®Â±ÄÁΩëÊ†ºÁ°Æ‰øùÂêåÊ≠•
                    const currentBeatNumber = Math.floor(now / beatDuration);
                    let nextBeatNumber = currentBeatNumber + 1;
                    startTime = nextBeatNumber * beatDuration;

                    // ÂÆâÂÖ®Ê£ÄÊü•ÔºöÁ°Æ‰øù startTime Ëá≥Â∞ëÂú®Êú™Êù• 50ms
                    const minLookahead = 0.05;
                    if (startTime < now + minLookahead) {
                        nextBeatNumber++;
                        startTime = nextBeatNumber * beatDuration;
                        console.log(`‚ö†Ô∏è Êó∂Èó¥Â§™ËøëÔºåË∑≥Âà∞‰∏ã‰∏ÄÊãç (Á¨¨${nextBeatNumber}Êãç)`);
                    }

                    console.log(`üéµ ËäÇÊãçÂô®ÂºÄÂêØ - ÂêåÊ≠•Âà∞ÂÖ®Â±ÄÁΩëÊ†º: BPM=${tempo}, ÂΩìÂâç=${now.toFixed(3)}s, Êí≠Êîæ=${startTime.toFixed(3)}s (Á¨¨${nextBeatNumber}Êãç)`);
                } else {
                    // üöÄ ËäÇÊãçÂô®ÂÖ≥Èó≠ - Á´ãÂç≥Êí≠ÊîæÔºåÂìçÂ∫îËøÖÈÄü
                    startTime = now + 0.1;
                    console.log(`üöÄ ËäÇÊãçÂô®Êú™ÂºÄÂêØ - Á´ãÂç≥Êí≠Êîæ: BPM=${tempo}, ÂΩìÂâç=${now.toFixed(3)}s, Êí≠Êîæ=${startTime.toFixed(3)}s`);
                }

                playFullMelody(melodyData, startTime);
            }
        }

        // Ê£ÄÊü•ÊóãÂæãÊòØÂê¶ÈöêËóè
        function checkIfMelodyHidden() {
            // Ê£ÄÊü•ÂÖ®Â±ÄÂèòÈáèisMelodyHidden
            if (typeof isMelodyHidden !== 'undefined' && isMelodyHidden) {
                return true;
            }

            // Ê£ÄÊü•SVGÊòØÂê¶Êúâhidden class
            const scoreElement = document.getElementById('score');
            if (scoreElement) {
                const svgElements = scoreElement.querySelectorAll('svg');
                for (let svg of svgElements) {
                    if (svg.classList.contains('melody-hidden')) {
                        return true;
                    }
                }
            }

            return false;
        }

        function playTestNote() {
            try {
                console.log('üéπ Êí≠Êîæ440HzÈí¢Áê¥ÊµãËØïÈü≥Á¨¶');

                window.isPlayingMelody = true;
                updatePlayButton();

                // ‰ΩøÁî®Êñ∞ÁöÑÈí¢Áê¥Èü≥Ëâ≤Êí≠ÊîæÊµãËØïÈü≥Á¨¶
                const now = window.melodyAudioCtx.currentTime;
                const testDuration = 1.0;
                const pianoTestNote = createPianoNote(440, now, testDuration);

                console.log('‚úÖ Èí¢Áê¥ÊµãËØïÈü≥Á¨¶ÂºÄÂßãÊí≠Êîæ');

                // 1.5ÁßíÂêéÂÅúÊ≠¢Áä∂ÊÄÅ
                setTimeout(() => {
                    window.isPlayingMelody = false;
                    updatePlayButton();
                    console.log('‚úÖ Èí¢Áê¥Èü≥Ëâ≤Êí≠ÊîæÂÆåÊàê - Èü≥È¢ëÁ≥ªÁªüÂ∑•‰ΩúÊ≠£Â∏∏');

                    // Êí≠ÊîæÊàêÂäüÂêéÂèØ‰ª•Êâ©Â±ïÂà∞ÂÆåÊï¥ÊóãÂæãÊí≠Êîæ
                    if (typeof getCurrentMelodyData === 'function') {
                        console.log('üéµ Èí¢Áê¥Èü≥Ëâ≤ÊµãËØïÊàêÂäüÔºåÁ≥ªÁªüÂáÜÂ§áÂ∞±Áª™');
                    }
                }, 1500);

            } catch (error) {
                console.error('‚ùå Èí¢Áê¥ÊµãËØïÈü≥Á¨¶Êí≠ÊîæÂ§±Ë¥•:', error);
                window.isPlayingMelody = false;
                updatePlayButton();
            }
        }

        function updatePlayButton() {
            const playBtn = document.getElementById('playMelodyBtn');
            if (playBtn) {
                if (window.isPlayingMelody) {
                    playBtn.innerHTML = 'ÂÅúÊ≠¢';
                } else {
                    playBtn.innerHTML = 'Êí≠Êîæ';
                }
                console.log('üîÑ ÊåâÈíÆÁä∂ÊÄÅÂ∑≤Êõ¥Êñ∞:', window.isPlayingMelody ? 'Êí≠Êîæ‰∏≠' : 'Â∑≤ÂÅúÊ≠¢');
            }
        }

        // ÂàáÊç¢ÊóãÂæãÊòæÁ§∫/ÈöêËóè
        var isMelodyHidden = false;
        function toggleMelodyVisibility() {
            isMelodyHidden = !isMelodyHidden;
            const visibilityBtn = document.getElementById('melodyVisibilityBtn');
            const scoreElement = document.getElementById('score');

            if (isMelodyHidden) {
                // ÈöêËóèÊóãÂæãÔºàÂêåÊ≠•ÈöêËóèÂÆπÂô®‰∏éSVGÔºåÈÅøÂÖçÊ∏≤ÊüìÂâçÂêéÁä∂ÊÄÅ‰∏ç‰∏ÄËá¥Ôºâ
                if (scoreElement) {
                    // ÈöêËóèÂÆπÂô®
                    scoreElement.style.opacity = '0';
                    scoreElement.style.filter = 'blur(10px)';

                    // ÈöêËóèSVGÂÖÉÁ¥†
                    const svgElements = scoreElement.querySelectorAll('svg');
                    svgElements.forEach(svg => {
                        svg.classList.add('melody-hidden');
                        svg.style.opacity = '0';
                        svg.style.filter = 'blur(10px)';
                    });
                }
                if (visibilityBtn) {
                    visibilityBtn.innerHTML = 'üëÇ';
                    visibilityBtn.title = 'ÊòæÁ§∫ÊóãÂæã';
                    visibilityBtn.classList.add('hidden-state');
                }
                console.log('üëÇ ÊóãÂæãÂ∑≤ÈöêËóèÔºàÂÆπÂô®+SVGÔºâ');
            } else {
                // ÊòæÁ§∫ÊóãÂæãÔºàÊ∏ÖÈô§ÂÆπÂô®‰∏éSVG‰∏äÁöÑÈöêËóèÊ†∑ÂºèÔºåÁ°Æ‰øùÂèØËßÅÔºâ
                if (scoreElement) {
                    // ÊòæÁ§∫ÂÆπÂô®
                    scoreElement.style.opacity = '1';
                    scoreElement.style.filter = 'none';

                    // ÊòæÁ§∫SVGÂÖÉÁ¥†
                    const svgElements = scoreElement.querySelectorAll('svg');
                    svgElements.forEach(svg => {
                        svg.classList.remove('melody-hidden');
                        svg.style.opacity = '1';
                        svg.style.filter = 'none';
                    });
                }
                if (visibilityBtn) {
                    visibilityBtn.innerHTML = 'üëÄ';
                    visibilityBtn.title = 'ÈöêËóèÊóãÂæã';
                    visibilityBtn.classList.remove('hidden-state');
                }
                console.log('üëÄ ÊóãÂæãÂ∑≤ÊòæÁ§∫');
            }
        }

        // MIDIËΩ¨È¢ëÁéáÁöÑËæÖÂä©ÂáΩÊï∞
        function midiToFrequency(midiNote) {
            return 440 * Math.pow(2, (midiNote - 69) / 12);
        }

        // Èü≥Á¨¶Êó∂ÂÄºËΩ¨ÁßíÊï∞ÁöÑËæÖÂä©ÂáΩÊï∞
        function durationToSeconds(duration, tempo = 60) {
            const beatsPerSecond = tempo / 60;

            // ÊîØÊåÅ‰∏§ÁßçÈôÑÁÇπÊ†ºÂºèÔºö
            // 1. ÁÇπÂêéÁºÄÊ†ºÂºè: 'quarter.' (Êù•Ëá™ sight-reading-final.js ÁöÑÊüê‰∫õË∑ØÂæÑ)
            // 2. Á†¥ÊäòÂè∑ÂâçÁºÄÊ†ºÂºè: 'dotted-quarter' (Êù•Ëá™ MusicXML Ëß£Êûê)
            let normalizedDuration = duration;
            if (duration && duration.endsWith('.')) {
                const baseDuration = duration.slice(0, -1);  // ÁßªÈô§ÁÇπÂè∑
                normalizedDuration = `dotted-${baseDuration}`;
            }

            const durationMap = {
                'whole': 4,
                'half': 2,
                'quarter': 1,
                'eighth': 0.5,
                '16th': 0.25,
                '32nd': 0.125,
                'dotted-whole': 6,          // ÈôÑÁÇπÂÖ®Èü≥Á¨¶ = 6Êãç
                'dotted-half': 3,           // ÈôÑÁÇπ‰∫åÂàÜÈü≥Á¨¶ = 3Êãç
                'dotted-quarter': 1.5,      // ÈôÑÁÇπÂõõÂàÜÈü≥Á¨¶ = 1.5Êãç
                'dotted-eighth': 0.75,      // ÈôÑÁÇπÂÖ´ÂàÜÈü≥Á¨¶ = 0.75Êãç
                'dotted-16th': 0.375        // ÈôÑÁÇπÂçÅÂÖ≠ÂàÜÈü≥Á¨¶ = 0.375Êãç
            };
            const beats = durationMap[normalizedDuration] || 1;
            return beats / beatsPerSecond;
        }


        // ÂÆâÊéíÂçï‰∏™Èü≥Á¨¶Êí≠ÊîæÔºö‰ºòÂÖà‰ΩøÁî®ÈááÊ†∑Âô®ÔºåÂ§±Ë¥•ÂõûÈÄÄÂà∞ÂêàÊàêÂô®
        function scheduleNotePlay(frequency, startTime, duration) {
            try {
                if (window.__icSamplePlayer && window.__icSamplePlayer.ready && window.melodyAudioCtx) {
                    const midi = Math.round(69 + 12 * Math.log2(frequency / 440));
                    const playResult = window.__icSamplePlayer.scheduleAtExternalContext(
                        window.melodyAudioCtx, startTime, midi, duration, 0.85
                    );
                    // ‰øùÂ≠òËøîÂõûÂÄº‰ª•‰æøÂÅúÊ≠¢Êó∂‰ΩøÁî®
                    if (playResult && window.melodyScheduledSounds) {
                        window.melodyScheduledSounds.push(playResult);
                    }
                    return;
                }
            } catch (e) {
                console.warn('ÈááÊ†∑Âô®Êí≠ÊîæÂ§±Ë¥•ÔºåÂõûÈÄÄÊåØËç°Âô®:', e);
            }
            try {
                const pianoSound = createPianoNote(frequency, startTime, duration);
                window.melodyScheduledSounds.push(...pianoSound.components);
            } catch (error) {
                console.error('‚ùå Èü≥Á¨¶Êí≠ÊîæÂÆâÊéíÂ§±Ë¥•:', error);
            }
        }

        // ‰ºòÂåñÁâàÊú¨ÔºöÁõ¥Êé•‰ΩøÁî® MIDI ÁºñÂè∑ÔºåÈÅøÂÖçÈ¢ëÁéá‚ÜîMIDI ÁöÑÂÜó‰ΩôËΩ¨Êç¢
        function scheduleNotePlayDirect(midi, startTime, duration) {
            try {
                if (window.__icSamplePlayer && window.__icSamplePlayer.ready && window.melodyAudioCtx) {
                    const playResult = window.__icSamplePlayer.scheduleAtExternalContext(
                        window.melodyAudioCtx, startTime, midi, duration, 0.85
                    );
                    // ‰øùÂ≠òËøîÂõûÂÄº‰ª•‰æøÂÅúÊ≠¢Êó∂‰ΩøÁî®
                    if (playResult && window.melodyScheduledSounds) {
                        window.melodyScheduledSounds.push(playResult);
                    }
                    return;
                }
            } catch (e) {
                console.warn('ÈááÊ†∑Âô®Êí≠ÊîæÂ§±Ë¥•ÔºåÂõûÈÄÄÊåØËç°Âô®:', e);
            }
            // ÂõûÈÄÄÂà∞ÂêàÊàêÂô®
            try {
                const frequency = 440 * Math.pow(2, (midi - 69) / 12);
                const pianoSound = createPianoNote(frequency, startTime, duration);
                window.melodyScheduledSounds.push(...pianoSound.components);
            } catch (error) {
                console.error('‚ùå Èü≥Á¨¶Êí≠ÊîæÂÆâÊéíÂ§±Ë¥•:', error);
            }
        }

        // ÂàõÂª∫È´òÂìÅË¥®Èí¢Áê¥Èü≥Ëâ≤
        function createPianoNote(frequency, startTime, duration) {
            const components = [];

            // üéπ Ê†πÊçÆÈü≥È´òË∞ÉÊï¥ÂèÇÊï∞
            const isLowNote = frequency < 130; // C3‰ª•‰∏ã
            const isMidNote = frequency >= 130 && frequency < 520; // C3-C5
            const isHighNote = frequency >= 520; // C5‰ª•‰∏ä

            // üìä Èü≥È´òÁõ∏ÂÖ≥ÁöÑÈü≥Ëâ≤ÂèÇÊï∞
            const harmonicWeights = getHarmonicWeights(frequency);
            const envelopeParams = getEnvelopeParams(frequency, duration);

            // üéº ‰∏ªÈü≥È¢ëÈìæÔºöÂü∫È¢ë + Êª§Ê≥¢Âô® + ÂéãÁº©Âô®
            const fundamental = window.melodyAudioCtx.createOscillator();
            const fundamentalGain = window.melodyAudioCtx.createGain();
            const mainFilter = window.melodyAudioCtx.createBiquadFilter();
            const compressor = window.melodyAudioCtx.createDynamicsCompressor();

            // Âü∫È¢ëËÆæÁΩÆ
            fundamental.frequency.value = frequency;
            fundamental.type = isMidNote ? 'triangle' : 'sawtooth';

            // ‰∏ªÊª§Ê≥¢Âô® - Ê®°ÊãüÈí¢Áê¥ÁöÑÊú®Ë¥®ÂÖ±È∏£ÔºåÈôç‰ΩéÊà™Ê≠¢È¢ëÁéáÂâäÂº±È´òÈ¢ë
            mainFilter.type = 'lowpass';
            mainFilter.frequency.value = frequency * (isLowNote ? 2.5 : isHighNote ? 6 : 4);
            mainFilter.Q.value = isLowNote ? 0.7 : 1.0;

            // ÂéãÁº©Âô®ËÆæÁΩÆ - Ê®°ÊãüÈí¢Áê¥ÁöÑÂä®ÊÄÅÂìçÂ∫î
            compressor.threshold.value = -18;
            compressor.knee.value = 12;
            compressor.ratio.value = isLowNote ? 3 : 6;
            compressor.attack.value = 0.003;
            compressor.release.value = 0.1;

            // ËøûÊé•‰∏ªÈü≥È¢ëÈìæ
            fundamental.connect(mainFilter);
            mainFilter.connect(fundamentalGain);
            fundamentalGain.connect(compressor);
            compressor.connect(window.melodyAudioCtx.destination);

            // üéµ Ë∞êÊ≥¢Á≥ªÂàó - Ê®°ÊãüÁúüÂÆûÈí¢Áê¥ÁöÑË∞êÊ≥¢ÁªìÊûÑ
            const harmonics = [];
            const harmonicRatios = [2, 3, 4, 5, 6, 7, 8]; // ÂÖ´Â∫¶„ÄÅÂçÅ‰∫åÂ∫¶„ÄÅ‰∏§ÂÖ´Â∫¶Á≠â

            harmonicRatios.forEach((ratio, index) => {
                const weight = harmonicWeights[index] || 0;
                if (weight > 0.01) {
                    const harmonic = window.melodyAudioCtx.createOscillator();
                    const harmonicGain = window.melodyAudioCtx.createGain();
                    const harmonicFilter = window.melodyAudioCtx.createBiquadFilter();

                    harmonic.frequency.value = frequency * ratio;
                    harmonic.type = ratio % 2 === 0 ? 'triangle' : 'sine';

                    // Ë∞êÊ≥¢Êª§Ê≥¢Âô® - Ëøõ‰∏ÄÊ≠•ÂâäÂº±È´òÈ¢ë
                    harmonicFilter.type = 'lowpass';
                    harmonicFilter.frequency.value = frequency * ratio * 1.2;
                    harmonicFilter.Q.value = 0.6;

                    harmonic.connect(harmonicFilter);
                    harmonicFilter.connect(harmonicGain);
                    harmonicGain.connect(compressor);

                    harmonics.push({ oscillator: harmonic, gainNode: harmonicGain, filter: harmonicFilter, weight });
                }
            });

            // üé≠ Âô™Èü≥ÊàêÂàÜÂ∑≤ÁßªÈô§ - Êèê‰æõÊõ¥Á∫ØÂáÄÁöÑÈü≥Ëâ≤

            // üéº È´òÁ∫ßADSRÂåÖÁªú
            const now = startTime;
            const { attack, decay, sustain, release } = envelopeParams;

            // ‰∏ªÈü≥ÂåÖÁªú
            fundamentalGain.gain.setValueAtTime(0, now);
            fundamentalGain.gain.linearRampToValueAtTime(0.5, now + attack);
            fundamentalGain.gain.exponentialRampToValueAtTime(0.5 * sustain, now + attack + decay);
            fundamentalGain.gain.setValueAtTime(0.5 * sustain, now + duration - release);
            fundamentalGain.gain.exponentialRampToValueAtTime(0.001, now + duration);

            // Ë∞êÊ≥¢ÂåÖÁªú - ÊØè‰∏™Ë∞êÊ≥¢Êúâ‰∏çÂêåÁöÑË°∞ÂáèÁâπÊÄß
            harmonics.forEach(({ gainNode, weight }, index) => {
                const harmonicAttack = attack * (0.8 + index * 0.1);
                const harmonicDecay = decay * (0.5 + index * 0.2);
                const harmonicSustain = sustain * (0.6 - index * 0.1);
                const harmonicRelease = release * (0.8 + index * 0.15);

                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(weight, now + harmonicAttack);
                gainNode.gain.exponentialRampToValueAtTime(weight * harmonicSustain, now + harmonicAttack + harmonicDecay);
                gainNode.gain.setValueAtTime(weight * harmonicSustain, now + duration - harmonicRelease);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + duration);
            });

            // Âô™Èü≥ÂåÖÁªúÂ∑≤ÁßªÈô§

            // üéπ Âä®ÊÄÅÊª§Ê≥¢Âô®ÂåÖÁªú - Êõ¥‰øùÂÆàÁöÑÈ´òÈ¢ëÊéßÂà∂
            mainFilter.frequency.setValueAtTime(frequency * 5, now);
            mainFilter.frequency.exponentialRampToValueAtTime(frequency * 2.5, now + attack + decay);
            mainFilter.frequency.setValueAtTime(frequency * 2.5, now + duration - release);
            mainFilter.frequency.exponentialRampToValueAtTime(frequency * 1.8, now + duration);

            // ÂêØÂä®ÊâÄÊúâÊåØËç°Âô®
            fundamental.start(now);
            harmonics.forEach(({ oscillator }) => oscillator.start(now));

            // ÂÅúÊ≠¢ÊâÄÊúâÊåØËç°Âô®
            fundamental.stop(now + duration);
            harmonics.forEach(({ oscillator }) => oscillator.stop(now + duration));

            // ËÆ∞ÂΩïÁªÑ‰ª∂
            components.push({ oscillator: fundamental, gainNode: fundamentalGain, filter: mainFilter });
            components.push(...harmonics);

            console.log(`üéπ ÂàõÂª∫Á∫ØÂáÄÈí¢Áê¥Èü≥Ëâ≤: ${frequency.toFixed(1)}Hz (Âü∫È¢ë + ${harmonics.length}‰∏™Ë∞êÊ≥¢)`);

            return { components };
        }

        // Ê†πÊçÆÈü≥È´òËé∑ÂèñË∞êÊ≥¢ÊùÉÈáç
        function getHarmonicWeights(frequency) {
            const isLowNote = frequency < 130;
            const isMidNote = frequency >= 130 && frequency < 520;
            const isHighNote = frequency >= 520;

            if (isLowNote) {
                // ‰ΩéÈü≥ÔºöÊõ¥Â§ö‰ΩéÊ¨°Ë∞êÊ≥¢ÔºåÂéöÈáçÊÑüÔºåÂ§ßÂπÖÂâäÂº±Á¨¨4‰∏™Ê≥õÈü≥Âàó
                return [0.25, 0.12, 0.025, 0.015, 0.01, 0.003, 0.001];
            } else if (isHighNote) {
                // È´òÈü≥Ôºö‰øùÊåÅÊòé‰∫Æ‰ΩÜÂ§ßÂπÖÂâäÂº±È´òÈ¢ëÊàêÂàÜÔºåÁâπÂà´ÊòØÁ¨¨4‰∏™Ê≥õÈü≥Âàó
                return [0.18, 0.18, 0.06, 0.04, 0.02, 0.008, 0.002];
            } else {
                // ‰∏≠Èü≥ÔºöÂπ≥Ë°°ÁªìÊûÑÔºåÂ§ßÂπÖÂâäÂº±Á¨¨4‰∏™Ê≥õÈü≥Âàó
                return [0.22, 0.15, 0.04, 0.03, 0.018, 0.01, 0.003];
            }
        }

        // Ê†πÊçÆÈü≥È´òÂíåÊó∂ÈïøËé∑ÂèñÂåÖÁªúÂèÇÊï∞
        function getEnvelopeParams(frequency, duration) {
            const isLowNote = frequency < 130;
            const isMidNote = frequency >= 130 && frequency < 520;
            const isHighNote = frequency >= 520;

            let attack, decay, sustain, release;

            if (isLowNote) {
                // ‰ΩéÈü≥ÔºöËæÉÊÖ¢ÁöÑËµ∑Èü≥ÔºåÈïøÁöÑË°∞Âáè
                attack = Math.max(0.008, 0.03 - (frequency / 200) * 0.01);
                decay = 0.5;
                sustain = 0.3;
                release = Math.min(1.5, duration * 0.3);
            } else if (isHighNote) {
                // È´òÈü≥ÔºöÂø´Ëµ∑Èü≥ÔºåÁü≠Ë°∞Âáè
                attack = 0.003;
                decay = 0.15;
                sustain = 0.2;
                release = Math.min(0.3, duration * 0.2);
            } else {
                // ‰∏≠Èü≥ÔºöÂπ≥Ë°°ÁöÑÂèÇÊï∞
                attack = 0.005;
                decay = 0.3;
                sustain = 0.25;
                release = Math.min(0.8, duration * 0.25);
            }

            return {
                attack,
                decay,
                sustain,
                release
            };
        }

        // ÊîπËøõÁöÑMusicXMLÈü≥Á¨¶Ëß£ÊûêÂáΩÊï∞
        function parseNotesFromMusicXML(musicXML) {
            const notes = [];

            try {
                console.log('üéº ÂºÄÂßãËØ¶ÁªÜËß£ÊûêMusicXML...');

                // üîç Ë∞ÉËØïÔºöËæìÂá∫ÂéüÂßãMusicXML‰ª•ÂàÜÊûêÈôÑÁÇπÈóÆÈ¢ò
                console.log('üìã ÂéüÂßãMusicXMLÂÜÖÂÆπ:', musicXML);

                // üîç Ê£ÄÊü•MusicXML‰∏≠ÁöÑ <dot> ÂÖÉÁ¥†ÔºàË∞ÉËØïÁî®Ôºâ
                const dotCount = (musicXML.match(/<dot/g) || []).length;
                console.log(`üîç Ê£ÄÊµãÂà∞ ${dotCount} ‰∏™ <dot> ÂÖÉÁ¥†`);

                // ‚ö†Ô∏è Â∑≤Á¶ÅÁî®Ôºö‰πãÂâçËøôÈáå‰ºöÈîôËØØÂú∞Âà†Èô§ÊâÄÊúâÈôÑÁÇπÂÖÉÁ¥†
                // ÂΩìÁî®Êà∑ÂêØÁî®ÈôÑÁÇπÈü≥Á¨¶ÂäüËÉΩÊó∂ÔºåËøô‰∫õ<dot>ÂÖÉÁ¥†ÊòØÂêàÊ≥ï‰∏îÂøÖÈúÄÁöÑ
                // if (dotCount > 0) {
                //     console.log(`‚ö†Ô∏è ÂèëÁé∞ ${dotCount} ‰∏™ÈôÑÁÇπÂÖÉÁ¥†ÔºåÂºÄÂßãÊ∏ÖÁêÜÂ§ö‰ΩôÈôÑÁÇπ...`);
                //     musicXML = cleanupExcessiveDots(musicXML);
                //     const cleanedDotCount = (musicXML.match(/<dot/g) || []).length;
                //     console.log(`‚úÖ Ê∏ÖÁêÜÂÆåÊàêÔºåÂâ©‰Ωô ${cleanedDotCount} ‰∏™ÈôÑÁÇπÂÖÉÁ¥†`);
                // }

                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(musicXML, 'text/xml');

                // Êü•ÊâæÊâÄÊúânoteÂÖÉÁ¥†
                const noteElements = xmlDoc.getElementsByTagName('note');
                console.log(`üîç XML‰∏≠ÊâæÂà∞ ${noteElements.length} ‰∏™noteÂÖÉÁ¥†`);

                for (let i = 0; i < noteElements.length; i++) {
                    const noteElement = noteElements[i];

                    // Ëé∑ÂèñÂü∫Êú¨ÁöÑduration‰ø°ÊÅØÔºàMusicXML durationÂçï‰ΩçÔºâ
                    const durationElement = noteElement.getElementsByTagName('duration')[0];
                    const xmlDuration = durationElement ? parseInt(durationElement.textContent) : 4;

                    // Ëé∑ÂèñÊó∂ÂÄºÁ±ªÂûã
                    const typeElement = noteElement.getElementsByTagName('type')[0];
                    const noteType = typeElement ? typeElement.textContent : 'quarter';

                    // Ê£ÄÊü•ÊòØÂê¶ÊúâÈôÑÁÇπ
                    const dotElements = noteElement.getElementsByTagName('dot');
                    const hasDot = dotElements.length > 0;

                    // üîç Ë∞ÉËØïÔºöÊòæÁ§∫ÊØè‰∏™Èü≥Á¨¶ÁöÑÈôÑÁÇπÊÉÖÂÜµ
                    console.log(`üîç Èü≥Á¨¶ ${i+1}: Á±ªÂûã=${noteType}, ÈôÑÁÇπÊï∞Èáè=${dotElements.length}`);
                    if (dotElements.length > 0) {
                        console.log(`‚ö†Ô∏è Ê£ÄÊµãÂà∞ÂºÇÂ∏∏ÔºÅÈü≥Á¨¶Êúâ ${dotElements.length} ‰∏™ÈôÑÁÇπ`);
                    }

                    // ËÆ°ÁÆóÂÆûÈôÖÁöÑdurationÂ≠óÁ¨¶‰∏≤
                    let actualDuration = noteType;
                    if (hasDot) {
                        actualDuration = `dotted-${noteType}`;
                    }

                    // Ê£ÄÊü•ÊòØÂê¶ÊòØ‰ºëÊ≠¢Á¨¶
                    const restElement = noteElement.getElementsByTagName('rest')[0];
                    if (restElement) {
                        const restObj = {
                            type: 'rest',
                            duration: actualDuration,
                            xmlDuration: xmlDuration,
                            beats: calculateBeatsFromDuration(actualDuration)
                        };
                        console.log(`üéµ Ëß£Êûê‰ºëÊ≠¢Á¨¶: ${actualDuration} (${restObj.beats}Êãç)`);
                        notes.push(restObj);
                        continue;
                    }

                    // Ëé∑ÂèñÈü≥È´ò‰ø°ÊÅØ
                    const pitchElement = noteElement.getElementsByTagName('pitch')[0];
                    if (pitchElement) {
                        const step = pitchElement.getElementsByTagName('step')[0]?.textContent;
                        const octave = parseInt(pitchElement.getElementsByTagName('octave')[0]?.textContent);
                        const alterElement = pitchElement.getElementsByTagName('alter')[0];
                        const alter = alterElement ? parseInt(alterElement.textContent) : 0;

                        // Ê£ÄÊü•ËøûÁ∫ø‰ø°ÊÅØ
                        const tieElements = noteElement.getElementsByTagName('tie');
                        let tieInfo = null;
                        if (tieElements.length > 0) {
                            const tieTypes = Array.from(tieElements).map(tie => tie.getAttribute('type'));
                            tieInfo = {
                                isStart: tieTypes.includes('start'),
                                isStop: tieTypes.includes('stop'),
                                types: tieTypes
                            };
                        }

                        // ËÆ°ÁÆóMIDIÈü≥Á¨¶Âè∑
                        if (step && !isNaN(octave)) {
                            const midi = stepOctaveToMidi(step, octave, alter);

                            const noteObj = {
                                type: 'note',
                                step: step,
                                octave: octave,
                                alter: alter,
                                midi: midi,
                                duration: actualDuration,
                                xmlDuration: xmlDuration,
                                beats: calculateBeatsFromDuration(actualDuration),
                                tied: tieInfo ? true : false,
                                tieInfo: tieInfo
                            };

                            const tieStr = tieInfo ? ` [ËøûÁ∫ø:${tieInfo.types.join(',')}]` : '';
                            console.log(`üéµ Ëß£ÊûêÈü≥Á¨¶: ${step}${alter > 0 ? '#' : alter < 0 ? 'b' : ''}${octave} (MIDI: ${midi}) ${actualDuration} (${noteObj.beats}Êãç)${tieStr}`);
                            notes.push(noteObj);
                        }
                    }
                }

                console.log(`üéº XMLËß£ÊûêÂÆåÊàêÔºåÂÖ±${notes.length}‰∏™Èü≥Á¨¶/‰ºëÊ≠¢Á¨¶`);

            } catch (error) {
                console.error('‚ùå MusicXMLËß£ÊûêÈîôËØØ:', error);
            }

            return notes;
        }

        // ËÆ°ÁÆóÈü≥Á¨¶Êó∂ÂÄºÂØπÂ∫îÁöÑÊãçÊï∞
        function calculateBeatsFromDuration(duration) {
            const baseDurations = {
                'whole': 4,
                'half': 2,
                'quarter': 1,
                'eighth': 0.5,
                '16th': 0.25,
                '32nd': 0.125
            };

            // Â§ÑÁêÜÈôÑÁÇπÈü≥Á¨¶ÔºàÁî®‰∫éËß£ÊûêÁé∞ÊúâMusicXMLÔºâ
            if (duration.startsWith('dotted-')) {
                const baseDuration = duration.replace('dotted-', '');
                const baseBeats = baseDurations[baseDuration] || 1;
                return baseBeats * 1.5; // ÈôÑÁÇπÂ¢ûÂä†50%Êó∂ÂÄº
            }

            return baseDurations[duration] || 1;
        }

        // Â∞ÜÈü≥ÂêçÂíåÂÖ´Â∫¶ËΩ¨Êç¢‰∏∫MIDIÈü≥Á¨¶Âè∑
        function stepOctaveToMidi(step, octave, alter = 0) {
            const stepToSemitone = {
                'C': 0, 'D': 2, 'E': 4, 'F': 5, 'G': 7, 'A': 9, 'B': 11
            };

            const baseMidi = stepToSemitone[step];
            if (baseMidi === undefined) return 60; // ÈªòËÆ§C4

            return (octave + 1) * 12 + baseMidi + alter;
        }



        // Ëé∑ÂèñÊãçÂè∑‰ø°ÊÅØ
        function getTimeSignature(melodyData) {
            // ÈªòËÆ§ÂÄº
            let timeSignature = { numerator: 4, denominator: 4 };

            try {
                // ‰ªéconfig‰∏≠Ëé∑Âèñ
                if (melodyData.config && melodyData.config.timeSignature) {
                    const ts = melodyData.config.timeSignature;
                    if (ts.includes('/')) {
                        const parts = ts.split('/');
                        timeSignature.numerator = parseInt(parts[0]) || 4;
                        timeSignature.denominator = parseInt(parts[1]) || 4;
                    }
                }

                // ‰ªémusicXML‰∏≠Ëé∑Âèñ
                if (melodyData.musicXML && timeSignature.numerator === 4) {
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(melodyData.musicXML, 'text/xml');
                    const timeElements = xmlDoc.getElementsByTagName('time');

                    if (timeElements.length > 0) {
                        const beats = timeElements[0].getElementsByTagName('beats')[0]?.textContent;
                        const beatType = timeElements[0].getElementsByTagName('beat-type')[0]?.textContent;

                        if (beats && beatType) {
                            timeSignature.numerator = parseInt(beats) || 4;
                            timeSignature.denominator = parseInt(beatType) || 4;
                        }
                    }
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Êó†Ê≥ïËß£ÊûêÊãçÂè∑Ôºå‰ΩøÁî®ÈªòËÆ§4/4Êãç:', error);
            }

            console.log(`üéº Ê£ÄÊµãÂà∞ÊãçÂè∑: ${timeSignature.numerator}/${timeSignature.denominator}`);
            return timeSignature;
        }

        // Êí≠ÊîæÂÆåÊï¥ÊóãÂæãÔºàÁ∫ØÊóãÂæãÔºå‰∏çÂ∏¶ËäÇÊãçÂô®Ôºâ
        function playFullMelody(melodyData, customStartTime = null) {
            console.log('üé∂ ÂºÄÂßãÊóãÂæãÊí≠Êîæ');

            // Âè™Âú®È¶ñÊ¨°Ë∞ÉÁî®Êó∂ËÆæÁΩÆÊí≠ÊîæÁä∂ÊÄÅÔºåcount-inË∞ÉÁî®Êó∂Â∑≤ÁªèËÆæÁΩÆËøá‰∫Ü
            if (!window.isPlayingMelody) {
                window.isPlayingMelody = true;
                updatePlayButton();
                window.melodyScheduledSounds = [];
            }

            // Ëé∑ÂèñËäÇÊãçÂô®ÈÄüÂ∫¶
            let tempo = 60;
            if (typeof getCurrentTempo === 'function') {
                tempo = getCurrentTempo();
            }
            console.log('üï∞Ô∏è Êí≠ÊîæÈÄüÂ∫¶:', tempo, 'BPM');

            // Ëß£ÊûêÈü≥Á¨¶Êï∞ÊçÆ
            let notes = extractNotesFromMelodyData(melodyData);

            if (notes.length === 0) {
                console.log('‚ö†Ô∏è Ê≤°ÊúâÊâæÂà∞Èü≥Á¨¶ÔºåÊí≠ÊîæÈí¢Áê¥ÊµãËØïÈü≥Á¨¶');
                playTestNote();
                return;
            }

            console.log(`üéµ ÊâæÂà∞ ${notes.length} ‰∏™Èü≥Á¨¶ÔºåÂºÄÂßãÂÆâÊéíÊí≠Êîæ`);

            // Â§ÑÁêÜËøûÁ∫øÈü≥Á¨¶Âíå‰ºëÊ≠¢Á¨¶
            const processedNotes = processNotesForPlayback(notes);
            console.log(`üéµ Â§ÑÁêÜÂêéÁöÑÈü≥Á¨¶: ${processedNotes.length}‰∏™‰∫ã‰ª∂`);

            // ËÆ°ÁÆóÊÄªÊó∂ÈïøÂπ∂ÂÆâÊéíÊí≠Êîæ
            const startTime = customStartTime || window.melodyAudioCtx.currentTime;
            let totalDuration = 0;
            let currentTime = 0;

            // ÂÆâÊéíÈü≥Á¨¶Êí≠Êîæ
            processedNotes.forEach((event, index) => {
                const eventStartTime = startTime + currentTime;
                const eventDuration = durationToSeconds(event.duration || 'quarter', tempo);

                if (event.type === 'note' && event.midi && !event.isTiedContinuation) {
                    // Êí≠ÊîæÈü≥Á¨¶ÔºàË∑≥ËøáËøûÁ∫øÁöÑÂª∂Áª≠ÈÉ®ÂàÜÔºâ
                    // ‰ºòÂåñÔºöÁõ¥Êé•‰ΩøÁî® MIDIÔºåÈÅøÂÖç MIDI‚ÜíÈ¢ëÁéá‚ÜíMIDI ÁöÑÂÜó‰ΩôËΩ¨Êç¢
                    scheduleNotePlayDirect(event.midi, eventStartTime, eventDuration);
                    console.log(`üéπ ÂÆâÊéíÊí≠Êîæ: MIDI ${event.midi} @ ${eventStartTime.toFixed(2)}s, Êó∂Èïø ${eventDuration.toFixed(2)}s`);
                } else if (event.type === 'rest') {
                    // ‰ºëÊ≠¢Á¨¶ - Âè™ËÆ°Êó∂Ôºå‰∏çÊí≠Êîæ
                    console.log(`üîá ‰ºëÊ≠¢Á¨¶: ${eventDuration.toFixed(2)}s @ ${eventStartTime.toFixed(2)}s`);
                }

                totalDuration = Math.max(totalDuration, currentTime + eventDuration);
                currentTime += eventDuration;
            });

            // ËÆæÁΩÆÊí≠ÊîæÂÆåÊàêÂõûË∞É
            setTimeout(() => {
                if (window.isPlayingMelody) {
                    window.isPlayingMelody = false;
                    updatePlayButton();
                    window.melodyScheduledSounds = [];
                    console.log('‚úÖ ÊóãÂæãÊí≠ÊîæÂÆåÊàê');
                }
            }, (totalDuration + 0.5) * 1000);

            console.log(`üéº Êí≠ÊîæÂÆâÊéíÂÆåÊàê: ${totalDuration.toFixed(2)}Áßí`);
        }

        // ÊèêÂèñÈü≥Á¨¶Êï∞ÊçÆÁöÑËæÖÂä©ÂáΩÊï∞
        function extractNotesFromMelodyData(melodyData) {
            let notes = [];

            // ÊñπÊ≥ï1ÔºöÊ£ÄÊü•measuresÁªìÊûÑ
            if (melodyData.measures && Array.isArray(melodyData.measures)) {
                melodyData.measures.forEach((measure, measureIndex) => {
                    if (measure.notes && Array.isArray(measure.notes)) {
                        measure.notes.forEach(note => {
                            notes.push(note);
                        });
                    }
                });
            }

            // ÊñπÊ≥ï2ÔºöÊ£ÄÊü•ÊòØÂê¶ÊúâÁõ¥Êé•ÁöÑnotesÊï∞ÁªÑ
            if (notes.length === 0 && melodyData.notes && Array.isArray(melodyData.notes)) {
                notes = melodyData.notes;
            }

            // ÊñπÊ≥ï3ÔºöÊ£ÄÊü•musicXML‰∏≠ÊòØÂê¶ËÉΩËß£ÊûêÂá∫Èü≥Á¨¶
            if (notes.length === 0 && melodyData.musicXML) {
                notes = parseNotesFromMusicXML(melodyData.musicXML);
            }

            return notes;
        }

        // Â§ÑÁêÜËøûÁ∫øÈü≥Á¨¶Âíå‰ºëÊ≠¢Á¨¶
        function processNotesForPlayback(notes) {
            const processedNotes = [];
            let i = 0;

            while (i < notes.length) {
                const currentNote = notes[i];

                if (currentNote.type === 'rest') {
                    // ‰ºëÊ≠¢Á¨¶Áõ¥Êé•Ê∑ªÂä†
                    processedNotes.push(currentNote);
                    i++;
                } else if (currentNote.type === 'note') {
                    if (currentNote.tied && currentNote.tieInfo && currentNote.tieInfo.isStart) {
                        // ËøôÊòØËøûÁ∫øÁöÑÂºÄÂßãÔºåÈúÄË¶ÅÂêàÂπ∂ÂêéÁª≠ÁöÑËøûÁ∫øÈü≥Á¨¶
                        const mergedNote = mergeTiedNotes(notes, i);
                        processedNotes.push(mergedNote.note);
                        i = mergedNote.nextIndex;
                    } else if (currentNote.tied && currentNote.tieInfo && currentNote.tieInfo.isStop && !currentNote.tieInfo.isStart) {
                        // ËøôÊòØËøûÁ∫øÁöÑÁªìÊùüÔºå‰ΩÜ‰∏çÊòØÂºÄÂßãÔºåÊ†áËÆ∞‰∏∫Âª∂Áª≠Ôºà‰∏çÊí≠ÊîæÔºâ
                        const continuationNote = {
                            ...currentNote,
                            isTiedContinuation: true
                        };
                        processedNotes.push(continuationNote);
                        i++;
                    } else {
                        // ÊôÆÈÄöÈü≥Á¨¶ÔºåÁõ¥Êé•Ê∑ªÂä†
                        processedNotes.push(currentNote);
                        i++;
                    }
                } else {
                    // ÂÖ∂‰ªñÁ±ªÂûãÔºåÁõ¥Êé•Ê∑ªÂä†
                    processedNotes.push(currentNote);
                    i++;
                }
            }

            return processedNotes;
        }

        // ÂêàÂπ∂ËøûÁ∫øÈü≥Á¨¶
        function mergeTiedNotes(notes, startIndex) {
            const startNote = notes[startIndex];
            let totalBeats = startNote.beats || calculateBeatsFromDuration(startNote.duration);
            let nextIndex = startIndex + 1;

            console.log(`üîó ÂºÄÂßãÂ§ÑÁêÜËøûÁ∫ø: ${startNote.step}${startNote.octave} (ÂºÄÂßãÈü≥Á¨¶: ${startNote.beats}Êãç)`);

            // Êü•ÊâæÂêéÁª≠ÁöÑËøûÁ∫øÈü≥Á¨¶
            while (nextIndex < notes.length) {
                const nextNote = notes[nextIndex];

                // Ê£ÄÊü•ÊòØÂê¶ÊòØÂêåÈü≥È´òÁöÑËøûÁ∫øÈü≥Á¨¶
                if (nextNote.type === 'note' &&
                    nextNote.tied &&
                    nextNote.midi === startNote.midi &&
                    nextNote.tieInfo) {

                    const noteBeats = nextNote.beats || calculateBeatsFromDuration(nextNote.duration);
                    totalBeats += noteBeats;
                    console.log(`üîó ÂêàÂπ∂ËøûÁ∫øÈü≥Á¨¶: +${noteBeats}Êãç, ÊÄªËÆ°: ${totalBeats}Êãç`);

                    nextIndex++;

                    // Â¶ÇÊûúËøôÊòØËøûÁ∫øÁöÑÁªìÊùüÔºåÂÅúÊ≠¢ÂêàÂπ∂
                    if (nextNote.tieInfo.isStop && !nextNote.tieInfo.isStart) {
                        break;
                    }
                } else {
                    // ÈÅáÂà∞ÈùûËøûÁ∫øÈü≥Á¨¶ÔºåÂÅúÊ≠¢
                    break;
                }
            }

            // ËÆ°ÁÆóÂêàÂπ∂ÂêéÁöÑduration
            const mergedDuration = beatsToClosestDuration(totalBeats);

            const mergedNote = {
                ...startNote,
                duration: mergedDuration,
                beats: totalBeats,
                isMergedTie: true,
                originalDuration: startNote.duration
            };

            console.log(`üîó ËøûÁ∫øÂêàÂπ∂ÂÆåÊàê: ${startNote.step}${startNote.octave}, ÊÄªÊó∂Èïø: ${totalBeats}Êãç (${mergedDuration})`);

            return {
                note: mergedNote,
                nextIndex: nextIndex
            };
        }

        // Â∞ÜÊãçÊï∞ËΩ¨Êç¢‰∏∫ÊúÄÊé•ËøëÁöÑdurationÂ≠óÁ¨¶‰∏≤
        function beatsToClosestDuration(beats) {
            // ÂÆåÊï¥ÁöÑÈü≥Á¨¶Êó∂ÂÄºÊò†Â∞ÑÔºàÂåÖÂê´ÈôÑÁÇπÈü≥Á¨¶Ôºâ
            const durationMap = [
                { beats: 4, duration: 'whole' },
                { beats: 3, duration: 'dotted-half' },      // ÈôÑÁÇπ‰∫åÂàÜÈü≥Á¨¶
                { beats: 2, duration: 'half' },
                { beats: 1.5, duration: 'dotted-quarter' }, // ÈôÑÁÇπÂõõÂàÜÈü≥Á¨¶
                { beats: 1, duration: 'quarter' },
                { beats: 0.75, duration: 'dotted-eighth' }, // ÈôÑÁÇπÂÖ´ÂàÜÈü≥Á¨¶
                { beats: 0.5, duration: 'eighth' },
                { beats: 0.25, duration: '16th' },
                { beats: 0.125, duration: '32nd' }
            ];

            // Á≤æÁ°ÆÂåπÈÖç‰ºòÂÖàÔºàÂÆπÂ∑Æ0.01ÊãçÔºâ
            for (const { beats: targetBeats, duration } of durationMap) {
                if (Math.abs(beats - targetBeats) < 0.01) {
                    return duration;
                }
            }

            // Êó†Á≤æÁ°ÆÂåπÈÖçÊó∂ÔºåÊâæÊúÄÊé•ËøëÁöÑ
            let closestDuration = 'quarter';
            let minDifference = Infinity;

            for (const { beats: targetBeats, duration } of durationMap) {
                const difference = Math.abs(beats - targetBeats);
                if (difference < minDifference) {
                    minDifference = difference;
                    closestDuration = duration;
                }
            }

            return closestDuration;
        }

        // ====== ÈöêËóèÊ®°Âºè‰∏ãÁöÑËäÇÊãçÂô®ÂäüËÉΩ ======

        // ÂàõÂª∫ËäÇÊãçÂô®Â£∞Èü≥
        function createMetronomeClick(frequency = 523.25, isDownbeat = false) {
            try {
                const oscillator = window.melodyAudioCtx.createOscillator();
                const gainNode = window.melodyAudioCtx.createGain();

                // ‰ΩøÁî®ÊñπÊ≥¢ÂíåËá™ÁÑ∂Èü≥È´ò (‰∏é‰∏ªËäÇÊãçÂô®‰øùÊåÅ‰∏ÄËá¥)
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(
                    isDownbeat ? frequency * 1.2 : frequency,
                    window.melodyAudioCtx.currentTime
                );

                oscillator.connect(gainNode);
                gainNode.connect(window.melodyAudioCtx.destination);

                return { oscillator, gainNode };
            } catch (error) {
                console.error('‚ùå ÂàõÂª∫ËäÇÊãçÂô®Â£∞Èü≥Â§±Ë¥•:', error);
                return null;
            }
        }

        // Êí≠ÊîæËäÇÊãçÂô®ÁÇπÂáªÂ£∞
        function playMetronomeClick(startTime, isDownbeat = false) {
            const metronome = createMetronomeClick(523.25, isDownbeat);
            if (!metronome) return;

            const { oscillator, gainNode } = metronome;

            // ‰ΩøÁî®‰∏éNiceChordËäÇÊãçÂô®‰∏ÄËá¥ÁöÑÂåÖÁªú
            const clickDuration = 0.05;
            const volume = 0.25; // Áªü‰∏ÄÈü≥Èáè

            gainNode.gain.setValueAtTime(volume, startTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + clickDuration);

            oscillator.start(startTime);
            oscillator.stop(startTime + clickDuration);

            // ËÆ∞ÂΩï‰ª•‰æøÂÅúÊ≠¢Êó∂Ê∏ÖÁêÜ
            window.melodyScheduledSounds.push({ oscillator, gainNode });

            console.log(`ü•Å ËäÇÊãçÂô®: ${isDownbeat ? 'Âº∫Êãç' : 'Âº±Êãç'} @ ${startTime.toFixed(2)}s`);
        }

        // ÂêØÂä®È°µÈù¢‰∏äÁöÑËäÇÊãçÂô®
        function startPageMetronome() {
            // Êü•ÊâæÈ°µÈù¢‰∏äÁöÑËäÇÊãçÂô®ÊåâÈíÆÂπ∂ÂêØÂä®
            const metronomeBtn = document.querySelector('#headerMetronomePlay, .metronome-play-btn');
            if (metronomeBtn && !metronomeBtn.classList.contains('playing')) {
                console.log('üéº ÂêØÂä®È°µÈù¢ËäÇÊãçÂô®');
                metronomeBtn.click();
                return true;
            }
            return false;
        }

        // ÂÅúÊ≠¢È°µÈù¢‰∏äÁöÑËäÇÊãçÂô®
        function stopPageMetronome() {
            const metronomeBtn = document.querySelector('#headerMetronomePlay, .metronome-play-btn');
            if (metronomeBtn && metronomeBtn.classList.contains('playing')) {
                console.log('‚èπÔ∏è ÂÅúÊ≠¢È°µÈù¢ËäÇÊãçÂô®');
                metronomeBtn.click();
                return true;
            }
            return false;
        }

        // Count-inÁÑ∂ÂêéÊí≠ÊîæÊóãÂæãÔºàÈöêËóèÊ®°Âºè‰∏ìÁî®Ôºâ
        function playCountInThenMelody(melodyData) {
            console.log('üéº ÈöêËóèÊ®°ÂºèÔºöÂºÄÂßãcount-inÔºà‰ªÖcount-inÔºå‰∏çÂêØÂä®È°µÈù¢ËäÇÊãçÂô®Ôºâ');

            window.isPlayingMelody = true;
            updatePlayButton();
            window.melodyScheduledSounds = [];

            // Ëé∑ÂèñËäÇÊãçÂô®ÈÄüÂ∫¶ÂíåÊãçÂè∑
            let tempo = 60;
            if (typeof getCurrentTempo === 'function') {
                tempo = getCurrentTempo();
            }

            // Ëé∑ÂèñÊãçÂè∑‰ø°ÊÅØ
            const timeSignature = getTimeSignature(melodyData);
            const countInBeats = timeSignature.numerator; // ‰ΩøÁî®ÊãçÂè∑ÂàÜÂ≠ê‰Ωú‰∏∫count-inÊ¨°Êï∞

            console.log(`üéº Count-inËÆæÁΩÆ: ${tempo} BPM, ÊãçÂè∑ ${timeSignature.numerator}/${timeSignature.denominator}, count-in ${countInBeats}‰∏ã`);

            const beatDuration = 60 / tempo; // ÊØèÊãçÁöÑÁßíÊï∞
            const now = window.melodyAudioCtx.currentTime;

            // Ê≥®ÈáäÊéâÂêØÂä®È°µÈù¢ËäÇÊãçÂô®ÁöÑ‰ª£Á†Å
            // startPageMetronome();

            // Êí≠Êîæcount-inÔºàÊ†πÊçÆÊãçÂè∑ÂàÜÂ≠êÂÜ≥ÂÆöÊ¨°Êï∞Ôºâ
            for (let beat = 0; beat < countInBeats; beat++) {
                const beatTime = now + beat * beatDuration;
                const isDownbeat = beat === 0;
                playMetronomeClick(beatTime, isDownbeat);
            }

            // count-inÂÆåÊàêÂêéÁöÑÂ§ÑÁêÜ
            const countInEndTime = now + countInBeats * beatDuration;
            console.log(`üéµ Count-inÂ∞ÜÂú®${countInEndTime.toFixed(3)}sÁªìÊùüÔºåÁÑ∂ÂêéÁ≤æÁ°ÆÂºÄÂßãÊóãÂæãÊí≠Êîæ`);

            // üîß ÂÖ≥ÈîÆ‰øÆÂ§çÔºö‰∏ç‰ΩøÁî®setTimeoutÔºåÁ´ãÂç≥Ë∞ÉÁî®Êí≠ÊîæÂáΩÊï∞Ôºå‰º†ÂÖ•count-inÁªìÊùüÁöÑÁ≤æÁ°ÆÊó∂Èó¥
            // Web Audio API ‰ºöÁ≤æÁ°ÆÂú∞Âú®count-inÁªìÊùüÊó∂ÂºÄÂßãÊí≠ÊîæÊóãÂæã
            playFullMelody(melodyData, countInEndTime);
        }

        // üéπ ‰∏¥Êó∂Ê†∑Êú¨ÁîüÊàêÂô® - ÊµãËØïÁî®
        function generateTestSample(frequency, name, audioContext) {
            console.log(`üéµ ÁîüÊàêÊµãËØïÊ†∑Êú¨: ${name} (${frequency}Hz)`);

            const duration = 2.5;
            const sampleRate = 22050;
            const length = duration * sampleRate;

            // ÂàõÂª∫AudioBuffer
            const buffer = audioContext.createBuffer(1, length, sampleRate);
            const data = buffer.getChannelData(0);

            // Ê†πÊçÆÂÖ∑‰ΩìÈü≥Á¨¶Ë∞ÉÊï¥Ë∞êÊ≥¢ÁªìÊûÑ
            let harmonics, decay, brightness;

            switch(name) {
                case 'C4':
                    harmonics = [1.0, 0.5, 0.3, 0.2, 0.12, 0.08, 0.05]; // Ê∏©ÊöñÁöÑ‰∏≠Èü≥
                    decay = 0.7;
                    brightness = 0.8;
                    break;
                case 'E4':
                    harmonics = [1.0, 0.45, 0.35, 0.22, 0.15, 0.09, 0.04]; // Áï•Â∏¶Êòé‰∫Æ
                    decay = 0.65;
                    brightness = 0.9;
                    break;
                case 'G4':
                    harmonics = [1.0, 0.4, 0.4, 0.25, 0.18, 0.1, 0.03]; // Âπ≥Ë°°ÁöÑÈ´ò‰∏≠Èü≥
                    decay = 0.6;
                    brightness = 1.0;
                    break;
                case 'A4':
                    harmonics = [1.0, 0.35, 0.45, 0.28, 0.2, 0.12, 0.02]; // Êòé‰∫ÆÁöÑA4
                    decay = 0.58;
                    brightness = 1.1;
                    break;
                default:
                    harmonics = [1.0, 0.4, 0.3, 0.2, 0.1, 0.05];
                    decay = 0.7;
                    brightness = 1.0;
            }

            // ÁîüÊàêÊ†∑Êú¨Êï∞ÊçÆ
            for (let i = 0; i < length; i++) {
                const t = i / sampleRate;
                let sample = 0;

                // Ê∑ªÂä†Ë∞êÊ≥¢Á≥ªÂàó
                harmonics.forEach((amplitude, index) => {
                    const harmonic = index + 1;
                    const freq = frequency * harmonic;

                    // È´òÊ¨°Ë∞êÊ≥¢ÈöèÊó∂Èó¥Ë°∞ÂáèÊõ¥Âø´
                    const harmonicDecay = decay * (1 + index * 0.3);
                    const envelope = Math.exp(-harmonicDecay * t);

                    sample += amplitude * Math.sin(2 * Math.PI * freq * t) * envelope;
                });

                // Ê∑ªÂä†ËΩªÂæÆÁöÑÁê¥Âº¶ÂÖ±È∏£Âô™Â£∞
                const noiseLevel = 0.015 * Math.exp(-t * 3);
                sample += (Math.random() - 0.5) * noiseLevel;

                // ÊÄª‰ΩìÈü≥ÈáèÂåÖÁªúÔºàÊ®°ÊãüÈí¢Áê¥Ëß¶ÈîÆÔºâ
                const attack = Math.min(1, t * 50); // Âø´ÈÄüÊîªÂáª
                const sustain = Math.exp(-t * 0.8); // Ëá™ÁÑ∂Ë°∞Âáè
                const totalEnvelope = attack * sustain;

                data[i] = sample * totalEnvelope * 0.25; // ÊéßÂà∂ÊÄªÈü≥Èáè
            }

            console.log(`‚úÖ ${name} Ê†∑Êú¨ÁîüÊàêÂÆåÊàêÔºåÊó∂Èïø ${duration}s`);
            return buffer;
        }

        // üéπ ÊµãËØïÊ†∑Êú¨Êí≠ÊîæÂô®
        window.testSamplePlayback = function(sampleName) {
            console.log(`üéµ ÊµãËØïÊí≠ÊîæÊ†∑Êú¨: ${sampleName}`);

            // Á°Æ‰øùAudioContextÂ∑≤ÂàùÂßãÂåñ
            if (!window.melodyAudioCtx) {
                console.log('üîß ÂàùÂßãÂåñAudioContext...');
                try {
                    window.melodyAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    console.log('‚úÖ AudioContextÂàùÂßãÂåñÊàêÂäü');
                } catch (error) {
                    console.error('‚ùå AudioContextÂàùÂßãÂåñÂ§±Ë¥•:', error);
                    return;
                }
            }

            // Á°Æ‰øùAudioContextÊú™Ë¢´ÊöÇÂÅú
            if (window.melodyAudioCtx.state === 'suspended') {
                window.melodyAudioCtx.resume();
            }

            const frequencies = {
                'C4': 261.63,
                'E4': 329.63,
                'G4': 392.00,
                'A4': 440.00
            };

            const frequency = frequencies[sampleName];
            if (!frequency) {
                console.error(`‚ùå Êú™Áü•Ê†∑Êú¨: ${sampleName}`);
                return;
            }

            try {
                // ÁîüÊàêÊµãËØïÊ†∑Êú¨
                const buffer = generateTestSample(frequency, sampleName, window.melodyAudioCtx);

                // Êí≠ÊîæÊ†∑Êú¨
                const source = window.melodyAudioCtx.createBufferSource();
                source.buffer = buffer;
                source.connect(window.melodyAudioCtx.destination);

                const now = window.melodyAudioCtx.currentTime;
                source.start(now);

                console.log(`üîä ${sampleName} Ê†∑Êú¨ÂºÄÂßãÊí≠Êîæ`);

                // ËÆ∞ÂΩïÊí≠ÊîæÁä∂ÊÄÅ
                setTimeout(() => {
                    console.log(`‚úÖ ${sampleName} Ê†∑Êú¨Êí≠ÊîæÂÆåÊàê`);
                }, 3000);

            } catch (error) {
                console.error(`‚ùå ${sampleName} Ê†∑Êú¨Êí≠ÊîæÂ§±Ë¥•:`, error);
            }
        };

        // üéπ Êí≠ÊîæÊâÄÊúâÊµãËØïÊ†∑Êú¨ÔºàÊåâÈ°∫Â∫èÔºâ
        window.testAllSamples = function() {
            console.log('üéµ === ÂºÄÂßãÊµãËØïÊâÄÊúâ‰∏≠È´òÈü≥Ê†∑Êú¨ ===');

            const samples = ['C4', 'E4', 'G4', 'A4'];
            let currentIndex = 0;

            function playNext() {
                if (currentIndex >= samples.length) {
                    console.log('‚úÖ === ÊâÄÊúâÊ†∑Êú¨ÊµãËØïÂÆåÊàê ===');
                    return;
                }

                const sample = samples[currentIndex];
                console.log(`\nüéµ Á¨¨${currentIndex + 1}‰∏™Ê†∑Êú¨: ${sample}`);
                window.testSamplePlayback(sample);

                currentIndex++;
                setTimeout(playNext, 3500); // 3.5ÁßíÈó¥Èöî
            }

            playNext();
        };

        // üéπ ÊµãËØïpitch shiftingÊïàÊûú
        window.testPitchShifting = function() {
            console.log('üéµ === Pitch Shifting ÊµãËØï ===');

            // ‰ΩøÁî®A4Ê†∑Êú¨ÁîüÊàê‰∏çÂêåÈü≥È´ò
            const baseFreq = 440; // A4
            const baseSample = generateTestSample(baseFreq, 'A4');

            // ÊµãËØï‰∏çÂêåÁöÑpitch shiftingÊØî‰æã
            const testNotes = [
                { name: 'C3', freq: 130.81, ratio: 130.81/440 },  // Âêë‰∏ãshift
                { name: 'F3', freq: 174.61, ratio: 174.61/440 },  // ‰∏≠Á≠âÂêë‰∏ã
                { name: 'A4', freq: 440, ratio: 1.0 },            // ÂéüÈü≥
                { name: 'C5', freq: 523.25, ratio: 523.25/440 },  // Âêë‰∏äshift
                { name: 'F5', freq: 698.46, ratio: 698.46/440 }   // Â§ßÂπÖÂêë‰∏ä
            ];

            let index = 0;
            function playNextShifted() {
                if (index >= testNotes.length) {
                    console.log('‚úÖ Pitch Shifting ÊµãËØïÂÆåÊàê');
                    return;
                }

                const note = testNotes[index];
                console.log(`üéµ ÊµãËØï ${note.name}: ÊØî‰æã ${note.ratio.toFixed(2)}x`);

                const source = window.melodyAudioCtx.createBufferSource();
                source.buffer = baseSample;
                source.playbackRate.value = note.ratio;
                source.connect(window.melodyAudioCtx.destination);

                source.start(window.melodyAudioCtx.currentTime);

                index++;
                setTimeout(playNextShifted, 2500);
            }

            playNextShifted();
        };

        console.log('‚úÖ HTMLÂÜÖÊí≠ÊîæÂô®ÂàõÂª∫ÂÆåÊàêÔºàÂê´ÈöêËóèÊ®°ÂºèËäÇÊãçÂô® + Ê†∑Êú¨ÊµãËØïÂäüËÉΩÔºâ');

        // üéØ ÈÄöÁî®ÂºπÁ™óÂ§ñÈÉ®ÁÇπÂáªÂÖ≥Èó≠ÂäüËÉΩ
        function initializeModalClickOutsideToClose() {
            const modalIds = [
                'rhythmModal',
                'articulationModal',
                'keySignatureModal',
                'timeSignatureModal',
                'intervalModal',
                'clefModal'
            ];

            modalIds.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.addEventListener('click', function(event) {
                        // Âè™ÊúâÂΩìÁÇπÂáªÁöÑÊòØÂºπÁ™óËÉåÊôØÔºàmodalÂÆπÂô®Êú¨Ë∫´ÔºâÊó∂ÊâçÂÖ≥Èó≠
                        if (event.target === modal) {
                            console.log(`üéØ ÁÇπÂáªÂ§ñÈÉ®Âå∫ÂüüÂÖ≥Èó≠ÂºπÁ™ó: ${modalId}`);

                            // Ê†πÊçÆÂºπÁ™óÁ±ªÂûãË∞ÉÁî®Áõ∏Â∫îÁöÑÂÖ≥Èó≠ÂáΩÊï∞
                            switch(modalId) {
                                case 'rhythmModal':
                                    if (typeof closeRhythmSettings === 'function') {
                                        closeRhythmSettings();
                                    }
                                    break;
                                case 'articulationModal':
                                    if (typeof closeArticulationSettings === 'function') {
                                        closeArticulationSettings();
                                    }
                                    break;
                                case 'keySignatureModal':
                                    if (typeof closeKeySettings === 'function') {
                                        closeKeySettings();
                                    }
                                    break;
                                case 'timeSignatureModal':
                                    if (typeof closeTimeSignatureSettings === 'function') {
                                        closeTimeSignatureSettings();
                                    }
                                    break;
                                case 'intervalModal':
                                    if (typeof closeIntervalSettings === 'function') {
                                        closeIntervalSettings();
                                    }
                                    break;
                                case 'clefModal':
                                    if (typeof closeClefSettings === 'function') {
                                        closeClefSettings();
                                    }
                                    break;
                                default:
                                    // ÈÄöÁî®ÂÖ≥Èó≠ÊñπÊ≥ï
                                    modal.style.display = 'none';
                            }
                        }
                    });
                    console.log(`‚úÖ Â∑≤‰∏∫ ${modalId} Ê∑ªÂä†Â§ñÈÉ®ÁÇπÂáªÂÖ≥Èó≠ÂäüËÉΩ`);
                }
            });
        }

        // Âú®È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            initializeModalClickOutsideToClose();
            console.log('üéØ ÂºπÁ™óÂ§ñÈÉ®ÁÇπÂáªÂÖ≥Èó≠ÂäüËÉΩÂ∑≤ÂàùÂßãÂåñ');
        });

        // È´òÁ∫ßËÆæÁΩÆÂàáÊç¢ÂáΩÊï∞
        function toggleRhythmAdvancedSettings() {
            const advancedSection = document.getElementById('rhythmAdvancedSettings');
            const button = document.getElementById('rhythmAdvancedBtn');

            if (advancedSection && button) {
                if (advancedSection.style.display === 'none' || !advancedSection.style.display) {
                    advancedSection.style.display = 'block';
                    button.textContent = translations[currentLanguage]['button.hideAdvanced'] || 'ÈöêËóèÈ´òÁ∫ßËÆæÁΩÆ';
                } else {
                    advancedSection.style.display = 'none';
                    button.textContent = translations[currentLanguage]['button.advanced'] || 'È´òÁ∫ßËÆæÁΩÆ';
                }
            }
        }

        function toggleArticulationAdvancedSettings() {
            const advancedSection = document.getElementById('articulationAdvancedSettings');
            const button = document.getElementById('articulationAdvancedBtn');

            if (advancedSection && button) {
                if (advancedSection.style.display === 'none' || !advancedSection.style.display) {
                    advancedSection.style.display = 'block';
                    button.textContent = translations[currentLanguage]['button.hideAdvanced'] || 'ÈöêËóèÈ´òÁ∫ßËÆæÁΩÆ';
                } else {
                    advancedSection.style.display = 'none';
                    button.textContent = translations[currentLanguage]['button.advanced'] || 'È´òÁ∫ßËÆæÁΩÆ';
                }
            }
        }

        // ÈáçÁΩÆÈ¢ëÁéáËÆæÁΩÆÂáΩÊï∞
        function resetRhythmFrequencies() {
            // ÈáçÁΩÆÊâÄÊúâËäÇÂ•èÈ¢ëÁéáÂà∞ÈªòËÆ§ÂÄº
            const defaults = {
                'freq-whole': 10,
                'freq-dotted-half': 12,
                'freq-half': 30,
                'freq-dotted-quarter': 60,
                'freq-quarter': 25,
                'freq-eighth': 15,
                'freq-sixteenth': 20,
                'freq-triplet': 15
            };

            Object.keys(defaults).forEach(id => {
                const slider = document.getElementById(id);
                const valueSpan = document.getElementById(id + '-value');
                if (slider && valueSpan) {
                    slider.value = defaults[id];
                    valueSpan.textContent = defaults[id] + '%';
                }
            });
        }

        function resetArticulationFrequencies() {
            // ÈáçÁΩÆÊâÄÊúâÊºîÂ•èÊ≥ïÈ¢ëÁéáÂà∞ÈªòËÆ§ÂÄº
            const defaults = {
                'freq-staccato': 20,
                'freq-accent': 15,
                'freq-acciaccatura': 10,
                'freq-slur': 15
            };

            Object.keys(defaults).forEach(id => {
                const slider = document.getElementById(id);
                const valueSpan = document.getElementById(id + '-value');
                if (slider && valueSpan) {
                    slider.value = defaults[id];
                    valueSpan.textContent = defaults[id] + '%';
                }
            });
        }

        // ‚å®Ô∏è ÂÖ®Â±ÄÈîÆÁõòÂø´Êç∑ÈîÆ
        document.addEventListener('keydown', function(e) {
            // Â¶ÇÊûúÂú®ËæìÂÖ•Ê°Ü„ÄÅÊñáÊú¨Ê°ÜÊàñÊ®°ÊÄÅÊ°ÜËæìÂÖ•‰∏≠Ôºå‰∏çËß¶ÂèëÂø´Êç∑ÈîÆ
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                return;
            }

            // Ê£ÄÊü•ÊòØÂê¶ÊúâÊ®°ÊÄÅÊ°ÜÊâìÂºÄÔºàÈÅøÂÖçÂú®ËÆæÁΩÆ‰∏≠Ëß¶ÂèëÔºâ
            const hasOpenModal = document.querySelector('.modal:not([style*="display: none"])');
            if (hasOpenModal) {
                return;
            }

            const key = e.key.toLowerCase();

            switch(key) {
                case 'p':
                    // Êí≠Êîæ/ÊöÇÂÅúÊí≠Êîæ
                    e.preventDefault();
                    if (typeof directPlayTest === 'function') {
                        directPlayTest();
                        console.log('‚å®Ô∏è Âø´Êç∑ÈîÆ: P - Êí≠Êîæ/ÊöÇÂÅú');
                    }
                    break;

                case 'arrowleft':
                    // ‰∏ä‰∏ÄÊù°
                    e.preventDefault();
                    if (typeof previousMelody === 'function') {
                        previousMelody();
                        console.log('‚å®Ô∏è Âø´Êç∑ÈîÆ: ‚Üê - ‰∏ä‰∏ÄÊù°');
                    }
                    break;

                case 'arrowright':
                    // ‰∏ã‰∏ÄÊù°
                    e.preventDefault();
                    if (typeof nextMelody === 'function') {
                        nextMelody();
                        console.log('‚å®Ô∏è Âø´Êç∑ÈîÆ: ‚Üí - ‰∏ã‰∏ÄÊù°');
                    }
                    break;

                case ' ':
                    // ÁîüÊàêÔºàÁ©∫Ê†ºÈîÆÔºâ
                    e.preventDefault();
                    if (typeof generateMelody === 'function') {
                        generateMelody();
                        console.log('‚å®Ô∏è Âø´Êç∑ÈîÆ: Space - ÁîüÊàêÊóãÂæã');
                    }
                    break;

                case 'h':
                    // ÈöêËóè/ÊòæÁ§∫
                    e.preventDefault();
                    if (typeof toggleMelodyVisibility === 'function') {
                        toggleMelodyVisibility();
                        console.log('‚å®Ô∏è Âø´Êç∑ÈîÆ: H - ÈöêËóè/ÊòæÁ§∫');
                    }
                    break;

                case 'c':
                    // ËäÇÊãçÂô®ÂºÄÂÖ≥
                    e.preventDefault();
                    if (typeof toggleMetronome === 'function') {
                        toggleMetronome();
                        console.log('‚å®Ô∏è Âø´Êç∑ÈîÆ: C - ËäÇÊãçÂô®ÂºÄÂÖ≥');
                    }
                    break;
            }
        });

        console.log('‚å®Ô∏è ÊóãÂæãËßÜÂ•èÂ∑•ÂÖ∑Âø´Êç∑ÈîÆÂ∑≤ÂêØÁî®: P=Êí≠Êîæ ‚Üê‚Üí=ÂØºËà™ Space=ÁîüÊàê H=ÈöêËóè C=ËäÇÊãçÂô®');
    </script>

    <!-- üõ°Ô∏è ËØïÁî®‰øùÊä§Á≥ªÁªüËÑöÊú¨ -->
    <script src="/js/trial-limiter.js?v=20250909"></script>
    <script src="/js/advanced-trial-protection.js?v=20250920"></script>
    <script src="/js/melody-counter-system.js?v=20250920"></script>
    <script src="/js/integrated-trial-manager.js?v=20250920"></script>

</body></html>
