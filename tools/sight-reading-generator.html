<!DOCTYPE html>
<!--
    IC Studio 视奏工具 - 专业级视奏旋律生成器
    Professional Music Sight-Reading Tool
    
    Copyright © 2025. All rights reserved. Igor Chen - icstudio.club
    
    Author: Igor Chen
    Website: https://icstudio.club
    Email: service@icstudio.club
    
    This software provides professional-grade sight-reading melody generation
    with advanced music theory features and Apple-inspired design.
-->
<html lang="zh-CN"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IC Studio 视奏工具 - 专业级视奏旋律生成器</title>
    
    <!-- Favicon - 多种格式支持 -->
    <link rel="icon" type="image/svg+xml" href="sight-reading-icon.svg">
    <link rel="alternate icon" href="sight-reading-icon.svg">
    <link rel="shortcut icon" type="image/svg+xml" href="sight-reading-icon.svg">
    <link rel="apple-touch-icon" href="sight-reading-icon.svg">
    <link rel="mask-icon" href="sight-reading-icon.svg" color="#007AFF">
    
    <!-- Preconnect to external domains -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net">

    <!-- Umami Analytics -->
    <script defer src="https://cloud.umami.is/script.js" data-website-id="24f8b47e-5590-49d6-a19e-4c34929d6741"></script>

    <!-- Early Access Check - 早期权限检查，防止试用界面闪烁 -->
    <script>
        (function() {
            // 早期权限检查函数
            function hasValidAccessCode() {
                try {
                    const accessData = localStorage.getItem('ic-premium-access');
                    if (!accessData) return false;

                    const data = JSON.parse(accessData);
                    if (!data || !data.code || data.code.length !== 12) return false;

                    // 检查是否过期
                    if (data.expiresAt && data.expiresAt !== null && Date.now() > data.expiresAt) {
                        return false;
                    }

                    // 检查测试前缀
                    if (!data.serverVerified) {
                        const hasObviousTestPrefix = ['TEST', 'DEMO', 'FORCE', 'BACKUP', 'EMERGENCY'].some(prefix => data.code.startsWith(prefix));
                        if (hasObviousTestPrefix) {
                            localStorage.removeItem('ic-premium-access');
                            return false;
                        }
                    }

                    return true;
                } catch (error) {
                    return false;
                }
            }

            // 检查其他权限标记
            function hasOtherAccessMarkers() {
                return localStorage.getItem('ic-verified-user') === 'true' ||
                       localStorage.getItem('ic-full-access') === 'true' ||
                       localStorage.getItem('ic-sight-reading-license');
            }

            // 设置全局权限状态
            window.IC_PREMIUM_USER = hasValidAccessCode() || hasOtherAccessMarkers();

            if (window.IC_PREMIUM_USER) {
                console.log('🚀 早期检测：完整版用户，将隐藏试用界面');

                // 添加CSS来立即隐藏试用相关元素
                const style = document.createElement('style');
                style.textContent = `
                    #trial-status,
                    #zpay-container,
                    #access-code-container,
                    .trial-only,
                    .trial-warning,
                    .trial-limit {
                        display: none !important;
                    }
                `;
                document.head.appendChild(style);

                // 设置标记供后续脚本使用
                window.IC_EARLY_PREMIUM_DETECTED = true;
            } else {
                console.log('💡 早期检测：普通用户，显示试用界面');
                window.IC_EARLY_PREMIUM_DETECTED = false;
            }
        })();
    </script>

    <!-- Critical CSS - Inlined for faster loading and fallback -->
    <style>
        /* 完整的关键样式 - 确保页面在任何情况下都能正常显示 */
        :root {
            --primary-blue: #007AFF;
            --secondary-blue: #5AC8FA;
            --neutral-white: #FFFFFF;
            --neutral-light: #F2F2F7;
            --neutral-medium: #C7C7CC;
            --neutral-dark: #8E8E93;
            --neutral-black: #1D1D1F;
            --accent-green: #34C759;
            --accent-orange: #FF9500;
            --background-blur: rgba(255, 255, 255, 0.8);
            --card-shadow: rgba(0, 0, 0, 0.04);
            --border-color: rgba(0, 0, 0, 0.06);
            --body-bg: #f5f5f7;
            --font-system: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }
        [data-theme="dark"] {
            --primary-blue: #0A84FF;
            --neutral-white: #2C2C2E;
            --neutral-light: #3A3A3C;
            --neutral-medium: #48484A;
            --neutral-dark: #8E8E93;
            --neutral-black: #F2F2F7;
            --accent-green: #32D74B;
            --accent-orange: #FF9F0A;
            --background-blur: rgba(44, 44, 46, 0.8);
            --card-shadow: rgba(0, 0, 0, 0.4);
            --border-color: rgba(255, 255, 255, 0.1);
            --body-bg: #1C1C1E;
        }
        body {
            font-family: var(--font-system);
            background: var(--body-bg);
            color: var(--neutral-black);
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background: var(--neutral-white);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 20px var(--card-shadow);
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            font-size: 18px;
        }
        /* 关键组件样式 - 确保基本布局始终正常 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #ffffff;
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: 18px;
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 32px var(--card-shadow);
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            z-index: 1;
            border-top: 8px solid #007bff58;
        }
        .header {
            background: #007bff05;
            color: #1d1d1f;
            padding: 40px 30px;
            text-align: center;
            border-bottom: 1px solid #d2d2d7;
        }
        .header h1 {
            font-family: var(--font-system);
            font-size: 3.2rem;
            margin-bottom: 12px;
            font-weight: 400;
            letter-spacing: -0.03em;
            line-height: 1.1;
            color: #1d1d1f;
        }
        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            padding: 30px;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        }
        .control-section {
            background: #ffffff;
            padding: 22px;
            border-radius: 14px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
            border: 1px solid rgba(0, 0, 0, 0.04);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .control-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.08);
            border-color: rgba(0, 122, 255, 0.1);
        }
        .primary-button {
            width: 100%;
            background: linear-gradient(135deg, #007aff 0%, #5ac8fa 100%);
            color: #FFFFFF;
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 0 4px 15px rgba(0, 122, 255, 0.25);
            position: relative;
            overflow: hidden;
        }
        .primary-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 122, 255, 0.35);
        }
        select, input {
            width: 100%;
            padding: 14px 18px;
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 400;
            color: #1d1d1f;
            background: #ffffff;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.02);
        }
        select:focus, input:focus {
            outline: none;
            border-color: #007aff;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15);
            transform: translateY(-1px);
        }
        #scoreContainer {
            margin: 30px;
            padding: 40px;
            background: #ffffff;
            border-radius: 14px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(0, 0, 0, 0.04);
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            color: #6e6e73;
            letter-spacing: -0.01em;
        }
    </style>
    
    <!-- 主样式文件 - 使用绝对路径确保强制刷新时能正确加载 -->
    <link rel="stylesheet" href="/tools/apple-ui-styles.css?v=20250908">
    
    <!-- 字体文件 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/inter@5.0.16/400.css">
    
    <!-- OpenSheetMusicDisplay from CDN -->
    <script async src="https://cdn.jsdelivr.net/npm/opensheetmusicdisplay@1.8.5/build/opensheetmusicdisplay.min.js"></script>

    <!-- OSMD Loader Fix - 确保库正确加载 -->
    <script src="js/osmd-loader-fix.js"></script>
    <script src="js/osmd-quick-fix.js"></script>

    <!-- Umami Analytics -->
    <script defer src="https://cloud.umami.is/script.js" data-website-id="24f8b47e-5590-49d6-a19e-4c34929d6741"></script>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div style="text-align: center;">
            <div>正在加载 IC Studio 视奏工具...</div>
            <div style="font-size: 14px; margin-top: 10px; opacity: 0.7;">请稍候片刻</div>
        </div>
    </div>
    
    <!-- Immediate loading hide script -->
    <script>
    (function() {
        console.log('🚀 Immediate loading hide script started');
        
        // Hide loading after 1 second, no matter what
        setTimeout(function() {
            var loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                console.log('⚡ Force hiding loading overlay (1 second timer)');
                loadingOverlay.style.opacity = '0';
                loadingOverlay.style.transition = 'opacity 0.3s ease';
                setTimeout(function() {
                    loadingOverlay.style.display = 'none';
                    console.log('✅ Loading overlay forcefully hidden');
                }, 300);
            }
        }, 1000);
        
        // Emergency fallback - hide after 500ms
        setTimeout(function() {
            var loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay && loadingOverlay.style.display !== 'none') {
                console.log('🆘 Emergency fallback - hiding loading overlay');
                loadingOverlay.style.display = 'none';
            }
        }, 500);
    })();
    </script>
    
    <!-- Trial Timer Removed - Now Using Counter System -->
    
    <!-- Premium Access Verification -->
    <!-- Premium overlay removed - integrated trial system replaces this -->

    <div class="container">
        <!-- 试用状态显示区域 -->
        <div id="trial-status" style="margin: 20px 0; padding: 15px; border-radius: 8px; background: #f8f9fa;"></div>
        
        <!-- 支付区域 -->
        <div id="zpay-container" style="display: none; margin: 20px 0; padding: 20px; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <!-- 隐藏支付按钮部分 -->
            <div id="payment-section" style="display: none;">
                <h3 style="color: #667eea; margin-bottom: 15px;">购买完整版</h3>
                
                <!-- 使用条款确认 -->
                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea;">
                    <label style="display: flex; align-items: flex-start; cursor: pointer; font-size: 14px; color: #555;">
                        <input type="checkbox" id="terms-checkbox" onchange="togglePaymentButton()" style="margin-right: 10px; margin-top: 3px; transform: scale(1.2);">
                        <span>我已阅读并同意 <a href="#" onclick="showTermsDialog()" style="color: #667eea; text-decoration: none;">《使用条款》</a> 和 <a href="#" onclick="showPrivacyDialog()" style="color: #667eea; text-decoration: none;">《隐私政策》</a></span>
                    </label>
                </div>
                
                <div id="payment-button-container" style="display: none;">
                    <button id="zpay-btn" onclick="window.createZPayment()" style="display: inline-block; background: linear-gradient(135deg, #1677FF 0%, #00A0E9 100%); color: white; padding: 15px 30px; border: none; border-radius: 12px; font-weight: 600; font-size: 16px; box-shadow: 0 8px 25px rgba(22, 119, 255, 0.3); cursor: pointer;">
                        支付宝 ￥48.00 (早鸟价)
                    </button>
                    <p style="font-size: 14px; color: #888; margin-top: 15px;">*使用支付宝安全支付，支付成功后立即获得专属访问码*</p>
                </div>
            </div>

            <!-- 访问码验证区域 (简化版) -->
            <div style="margin-top: 20px;">
                <h3 style="color: #667eea; margin-bottom: 10px;">输入访问码</h3>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="access-code-input" placeholder="输入访问码(11-12位)"
                           style="flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; text-transform: uppercase; transition: border-color 0.3s ease;"
                           maxlength="12" oninput="handleInputChange()" onkeyup="handleInputChange()" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#ddd'">
                    <button onclick="handleVerifyClick()" id="verify-btn"
                            style="padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: not-allowed; font-weight: 600; font-size: 14px; transition: all 0.3s ease; opacity: 1;"
                            onmousedown="this.style.opacity='0.3'; this.style.transform='scale(0.98)'"
                            onmouseup="this.style.transform='scale(1)'; setTimeout(() => { this.style.opacity='1'; }, 100)"
                            onmouseleave="this.style.transform='scale(1)'; setTimeout(() => { this.style.opacity='1'; }, 100)">
                        验证
                    </button>
                </div>
                <div id="verify-result" style="margin-top: 10px; font-size: 14px;"></div>
            </div>
        </div>
        <div class="header">
            <div class="header-content">
                <div class="header-text">
                    <h1 data-i18n="app.title">IC Studio - 视奏旋律生成器</h1>
                    <p data-i18n="app.subtitle">专业级乐谱渲染与音乐理论工具</p>
                </div>
                <div class="header-controls">
                    <div class="settings-dropdown">
                        <button class="settings-btn" id="settingsBtn" onclick="toggleSettings()">
                            <span data-i18n="settings.title">设置</span>
                        </button>
                        <div class="settings-menu" id="settingsMenu">
                            <!-- 主题设置 -->
                            <div class="settings-section">
                                <div class="settings-section-title" data-i18n="settings.theme">主题</div>
                                <div class="theme-options">
                                    <div class="theme-option" onclick="setTheme('light')">
                                        <span data-i18n="settings.lightMode">浅色模式</span>
                                    </div>
                                    <div class="theme-option" onclick="setTheme('dark')">
                                        <span data-i18n="settings.darkMode">深色模式</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 语言设置 -->
                            <div class="settings-section">
                                <div class="settings-section-title" data-i18n="settings.language">语言</div>
                                <div class="language-options">
                                    <div class="language-option" onclick="switchLanguage('zh-CN')">
                                        🇨🇳 简体中文
                                    </div>
                                    <div class="language-option" onclick="switchLanguage('zh-TW')">
                                        🇹🇼 繁體中文
                                    </div>
                                    <div class="language-option" onclick="switchLanguage('en')">
                                        🇺🇸 English
                                    </div>
                                </div>
                            </div>


                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="control-row">
                <div class="control-group">
                    <label data-i18n="controls.interval">音程跨度</label>
                    <button class="btn-secondary" onclick="openIntervalSettings()" id="intervalSettingsBtn" data-i18n="controls.intervalSettings">
                        音程设置
                    </button>
                </div>

                <div class="control-group">
                    <label data-i18n="controls.measures">小节数</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="measures-2" name="measures" value="2">
                            <label for="measures-2" data-i18n="controls.measures2">2小节</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="measures-4" name="measures" value="4" checked="">
                            <label for="measures-4" data-i18n="controls.measures4">4小节</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="measures-8" name="measures" value="8">
                            <label for="measures-8" data-i18n="controls.measures8">8小节</label>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <label data-i18n="controls.key">调号</label>
                    <button class="btn-secondary" onclick="openKeySettings()" id="keySettingsBtn" data-i18n="controls.keySettings">
                        调号设置
                    </button>
                </div>

                <div class="control-group">
                    <label data-i18n="controls.time">拍号</label>
                    <button class="btn-secondary" onclick="openTimeSignatureSettings()" id="timeSignatureSettingsBtn" data-i18n="controls.timeSettings">
                        拍号设置
                    </button>
                </div>

                <div class="control-group">
                    <label data-i18n="controls.clef">谱号</label>
                    <button class="btn-secondary" onclick="openClefSettings()" id="clefSettingsBtn" data-i18n="controls.clefSettings">
                        谱号设置
                    </button>
                </div>
            </div>

            <!-- 新增：音域设置 -->
            <div class="control-row">
                <div class="control-group">
                    <label for="rangeMin" data-i18n="controls.rangeMin">最低音</label>
                    <select id="rangeMin">
                        <option value="33">A1</option>
                        <option value="35">B1</option>
                        <option value="36">C2</option>
                        <option value="38">D2</option>
                        <option value="40">E2</option>
                        <option value="41">F2</option>
                        <option value="43">G2</option>
                        <option value="45">A2</option>
                        <option value="47">B2</option>
                        <option value="48">C3</option>
                        <option value="50">D3</option>
                        <option value="52">E3</option>
                        <option value="53">F3</option>
                        <option value="55">G3</option>
                        <option value="57">A3</option>
                        <option value="59">B3</option>
                        <option value="60" selected="">C4</option>
                        <option value="62">D4</option>
                        <option value="64">E4</option>
                        <option value="65">F4</option>
                        <option value="67">G4</option>
                        <option value="69">A4</option>
                        <option value="71">B4</option>
                        <option value="72">C5</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="rangeMax" data-i18n="controls.rangeMax">最高音</label>
                    <select id="rangeMax">
                        <option value="48">C3</option>
                        <option value="50">D3</option>
                        <option value="52">E3</option>
                        <option value="53">F3</option>
                        <option value="55">G3</option>
                        <option value="57">A3</option>
                        <option value="59">B3</option>
                        <option value="60">C4</option>
                        <option value="62">D4</option>
                        <option value="64">E4</option>
                        <option value="65">F4</option>
                        <option value="67">G4</option>
                        <option value="69">A4</option>
                        <option value="71">B4</option>
                        <option value="72">C5</option>
                        <option value="74">D5</option>
                        <option value="76">E5</option>
                        <option value="77">F5</option>
                        <option value="79">G5</option>
                        <option value="81" selected="">A5</option>
                        <option value="82">B5</option>
                        <option value="83">C6</option>
                        <option value="84">D6</option>
                        <option value="85">E6</option>
                    </select>
                </div>

                <div class="control-group" style="flex: none; width: 140px;">
                    <label for="accidentalRate" data-i18n="controls.accidental">临时记号</label>
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <input type="range" id="accidentalRate" min="0" max="100" value="0" step="10" style="width: 90px;">
                        <span id="accidentalRateValue" style="font-weight: 400; min-width: 30px;">0%</span>
                    </div>
                </div>

                <div class="control-group metronome-group" style="flex: none; width: 160px;">
                    <label for="headerMetronomeBpm" data-i18n="controls.metronome">节拍器</label>
                    <div class="metronome-control">
                        <input type="number" id="headerMetronomeBpm" min="1" max="999" value="60" class="bpm-input-control">
                        <button class="metronome-play-btn" id="headerMetronomeBtn" onclick="toggleMetronome()" title="开始/停止节拍器">
                            🎵
                        </button>
                        <div class="metronome-beat-indicator" id="headerBeatIndicator"></div>
                    </div>
                </div>
            </div>

            <div class="control-row">
                <div class="buttons">
                    <button class="btn-primary" onclick="generateMelody()" data-i18n="controls.generate">
                        生成旋律
                    </button>
                    <div class="button-group">
                        <button class="btn-secondary" onclick="previousMelody()" data-i18n="controls.previous">
                            上一条
                        </button>
                        <button class="btn-secondary" onclick="nextMelody()" data-i18n="controls.next">
                            下一条
                        </button>
                    </div>
                    <div class="button-group">
                        <button class="btn-secondary" onclick="openRhythmSettings()" data-i18n="controls.rhythm">
                            节奏设置
                        </button>
                        <button class="btn-secondary" onclick="openArticulationSettings()" data-i18n="controls.articulation">
                            演奏技巧
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="score-container">
            <div id="score">
                <div class="empty-score-message">
                    <p data-i18n="score.empty">点击生成旋律开始练习</p>
                </div>
            </div>
        </div>
        
        <!-- Copyright Information -->
        <div style="
            padding: 5px 0;
            text-align: center;
            font-size: 14px;
            color: var(--neutral-dark);
            opacity: 0.7;
            border-top: 1px solid var(--border-color);
            margin-top: 7.5px;
        ">
            <p style="margin: 0; line-height: 1.5;">
                <strong>IC Studio 视奏工具</strong> - 专业级视奏旋律生成器
            </p>
            <p style="margin: 8px 0 0 0; font-size: 13px; opacity: 0.8;">
                Copyright © 2025. All rights reserved. Igor Chen - 
                <a href="https://icstudio.club" target="_blank" style="color: var(--primary-blue); text-decoration: none;">icstudio.club</a>
            </p>
        </div>

    </div>

    <!-- 节奏设置弹窗 -->
    <div id="rhythmModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>节奏设置</h3>
                <button class="close-btn" onclick="closeRhythmSettings()">×</button>
            </div>
            <div class="modal-body">
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4>基本节奏单位</h4>
                        <button class="btn-select-all" onclick="selectAllRhythms()" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">全选</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item" id="rhythm-whole-label">
                            <input type="checkbox" id="rhythm-whole" value="whole">
                            <span>全音符</span>
                        </label>
                        <label class="checkbox-item" id="rhythm-dotted-half-label" style="display: none;">
                            <input type="checkbox" id="rhythm-dotted-half" value="half.">
                            <span>附点二分音符</span>
                        </label>
                        <label class="checkbox-item" id="rhythm-half-label">
                            <input type="checkbox" id="rhythm-half" value="half" checked="">
                            <span>二分音符</span>
                        </label>
                        <label class="checkbox-item" id="rhythm-dotted-quarter-label" style="display: none;">
                            <input type="checkbox" id="rhythm-dotted-quarter" value="quarter.">
                            <span>附点四分音符</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="rhythm-quarter" value="quarter" checked="">
                            <span>四分音符</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="rhythm-eighth" value="eighth" checked="">
                            <span>八分音符</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="rhythm-16th" value="16th">
                            <span>十六分音符</span>
                        </label>
                        <label class="checkbox-item" id="rhythm-triplet-label" style="display: flex;">
                            <input type="checkbox" id="rhythm-triplet" value="triplet">
                            <span>三连音</span>
                        </label>
                        <label class="checkbox-item" id="rhythm-duplet-label" style="display: none;">
                            <input type="checkbox" id="rhythm-duplet" value="duplet">
                            <span>二连音</span>
                        </label>
                        <label class="checkbox-item" id="rhythm-quadruplet-label" style="display: none;">
                            <input type="checkbox" id="rhythm-quadruplet" value="quadruplet">
                            <span>四连音</span>
                        </label>
                    </div>
                </div>
                
                <!-- 高级设置区域 -->
                <div id="rhythmAdvancedSettings" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 2px solid #e9ecef;">
                    <h4 style="margin-bottom: 15px; color: #495057;">高级频率设置</h4>
                    <p style="font-size: 0.9rem; color: #6c757d; margin-bottom: 20px;">调整各节奏单位在旋律中的出现频率 (0% = 不使用, 100% = 优先使用)</p>
                    
                    <div class="rhythm-frequency-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="frequency-item" id="freq-whole-item">
                            <label for="freq-whole" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">全音符频率:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-whole" min="0" max="100" value="10" style="flex: 1;">
                                <span id="freq-whole-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">10%</span>
                            </div>
                        </div>
                        <div class="frequency-item" id="freq-dotted-half-item" style="display: none;">
                            <label for="freq-dotted-half" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">附点二分音符频率:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-dotted-half" min="0" max="100" value="15" style="flex: 1;">
                                <span id="freq-dotted-half-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">15%</span>
                            </div>
                        </div>
                        <div class="frequency-item" id="freq-half-item">
                            <label for="freq-half" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">二分音符频率:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-half" min="0" max="100" value="30" style="flex: 1;">
                                <span id="freq-half-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">30%</span>
                            </div>
                        </div>
                        <div class="frequency-item" id="freq-dotted-quarter-item" style="display: none;">
                            <label for="freq-dotted-quarter" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">附点四分音符频率:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-dotted-quarter" min="0" max="100" value="35" style="flex: 1;">
                                <span id="freq-dotted-quarter-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">35%</span>
                            </div>
                        </div>
                        <div class="frequency-item">
                            <label for="freq-quarter" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">四分音符频率:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-quarter" min="0" max="100" value="50" style="flex: 1;">
                                <span id="freq-quarter-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">50%</span>
                            </div>
                        </div>
                        <div class="frequency-item">
                            <label for="freq-eighth" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">八分音符频率:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-eighth" min="0" max="100" value="40" style="flex: 1;">
                                <span id="freq-eighth-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">40%</span>
                            </div>
                        </div>
                        <div class="frequency-item">
                            <label for="freq-16th" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">十六分音符频率:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-16th" min="0" max="100" value="20" style="flex: 1;">
                                <span id="freq-16th-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">20%</span>
                            </div>
                        </div>
                        <div class="frequency-item" id="freq-triplet-item">
                            <label for="freq-triplet" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">三连音频率:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-triplet" min="0" max="100" value="15" style="flex: 1;">
                                <span id="freq-triplet-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">15%</span>
                            </div>
                        </div>
                        <div class="frequency-item" id="freq-duplet-item" style="display: none;">
                            <label for="freq-duplet" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">二连音频率:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-duplet" min="0" max="100" value="30" style="flex: 1;">
                                <span id="freq-duplet-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">30%</span>
                            </div>
                        </div>
                        <div class="frequency-item" id="freq-quadruplet-item" style="display: none;">
                            <label for="freq-quadruplet" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">四连音频率:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-quadruplet" min="0" max="100" value="25" style="flex: 1;">
                                <span id="freq-quadruplet-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">25%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn-secondary" onclick="resetRhythmFrequencies()" style="margin-right: 10px;">返回默认</button>
                    </div>
                </div>
                
                <div class="modal-buttons">
                    <button class="btn-secondary" onclick="toggleRhythmAdvancedSettings()" id="rhythmAdvancedBtn">高级设置</button>
                    <button class="btn-primary" onclick="saveRhythmSettings()">保存设置</button>
                    <button class="btn-secondary" onclick="closeRhythmSettings()">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Articulations 弹窗 -->
    <div id="articulationModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Articulations</h3>
                <button class="close-btn" onclick="closeArticulationSettings()">×</button>
            </div>
            <div class="modal-body">
                <!-- 基本Articulation技巧 -->
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4>基本演奏法 (Basic Articulations)</h4>
                        <button class="btn-select-all" onclick="selectAllBasicArticulations()" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">全选</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item" title="断奏 - 音符时值减半，轻快地演奏">
                            <input type="checkbox" id="art-staccato" value="staccato">
                            <span>Staccato (断奏) •</span>
                        </label>
                        <label class="checkbox-item" title="重音 - 强调某些音符">
                            <input type="checkbox" id="art-accent" value="accent">
                            <span>Accent (重音) &gt;</span>
                        </label>
                        <label class="checkbox-item" title="短倚音 - 快速的装饰音">
                            <input type="checkbox" id="art-acciaccatura" value="acciaccatura">
                            <span>Acciaccatura (短倚音)</span>
                        </label>
                    </div>
                </div>


                <!-- 吉他特有技巧 -->
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4>吉他技巧 (Guitar Techniques)</h4>
                        <button class="btn-select-all" onclick="selectAllGuitarTechniques()" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">全选</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item" title="击弦 - 用左手敲击产生音符">
                            <input type="checkbox" id="gtr-hammer" value="hammer-on">
                            <span>Hammer-on (击弦) H</span>
                        </label>
                        <label class="checkbox-item" title="勾弦 - 用左手勾离产生音符">
                            <input type="checkbox" id="gtr-pull" value="pull-off">
                            <span>Pull-off (勾弦) P</span>
                        </label>
                        <!-- 暂时隐藏glissando相关选项，因为OSMD不支持渲染 -->
                        <label class="checkbox-item" title="滑音 - 在品格间滑动（注：OSMD暂不支持渲染）" style="display: none;">
                            <input type="checkbox" id="gtr-glissando" value="glissando">
                            <span>Glissando (滑音) /</span>
                        </label>
                        <label class="checkbox-item" title="滑入 - 从下方滑入主音（注：OSMD暂不支持渲染）" style="display: none;">
                            <input type="checkbox" id="gtr-slide-in" value="slide-in">
                            <span>Slide In (滑入)</span>
                        </label>
                        <label class="checkbox-item" title="滑出 - 从主音滑出（注：OSMD暂不支持渲染）" style="display: none;">
                            <input type="checkbox" id="gtr-slide-out" value="slide-out">
                            <span>Slide Out (滑出)</span>
                        </label>
                    </div>
                </div>

                <!-- 暂时隐藏glissando相关说明 -->
                <div style="padding: 10px 20px; color: #666; font-size: 12px; border-top: 1px solid #eee; margin-top: 10px; display: none;">
                    <small>* 注：标有星号的技巧（Glissando、Slide In/Out）由于OSMD渲染引擎限制，暂时会显示为文本提示。</small>
                </div>

                <!-- 高级设置区域 -->
                <div id="articulationAdvancedSettings" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 2px solid #e9ecef;">
                    <h4 style="margin-bottom: 15px; color: #495057;">高级频率设置</h4>
                    <p style="font-size: 0.9rem; color: #6c757d; margin-bottom: 20px;">调整各演奏法在旋律中的出现频率 (0% = 不使用, 100% = 经常使用)</p>
                    
                    <div style="margin-bottom: 20px;">
                        <h5 style="color: #495057; margin-bottom: 10px;">基本演奏法频率</h5>
                        <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
                            <div class="frequency-item">
                                <label for="freq-staccato" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">Staccato (断奏) 频率:</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="range" id="freq-staccato" min="0" max="100" value="20" style="flex: 1;">
                                    <span id="freq-staccato-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">20%</span>
                                </div>
                            </div>
                            <div class="frequency-item">
                                <label for="freq-accent" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">Accent (重音) 频率:</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="range" id="freq-accent" min="0" max="100" value="15" style="flex: 1;">
                                    <span id="freq-accent-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">15%</span>
                                </div>
                            </div>
                            <div class="frequency-item">
                                <label for="freq-acciaccatura" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">Acciaccatura (短倚音) 频率:</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="range" id="freq-acciaccatura" min="0" max="100" value="10" style="flex: 1;">
                                    <span id="freq-acciaccatura-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">10%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h5 style="color: #495057; margin-bottom: 10px;">吉他技巧频率</h5>
                        <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
                            <div class="frequency-item">
                                <label for="freq-slur" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">击勾弦频率:</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="range" id="freq-slur" min="0" max="100" value="15" style="flex: 1;">
                                    <span id="freq-slur-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">15%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn-secondary" onclick="resetArticulationFrequencies()" style="margin-right: 10px;">返回默认</button>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-secondary" onclick="toggleArticulationAdvancedSettings()" id="articulationAdvancedBtn">高级设置</button>
                    <button class="btn-primary" onclick="saveArticulationSettings()">保存设置</button>
                    <button class="btn-secondary" onclick="closeArticulationSettings()">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 调号设置弹窗 -->
    <div id="keySignatureModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>调号设置</h3>
                <button class="close-btn" onclick="closeKeySettings()">×</button>
            </div>
            <div class="modal-body">
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4>大调 (Major)</h4>
                        <button class="btn-select-all" onclick="selectAllMajorKeys()" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">全选大调</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-C" value="C" checked>
                            <span>C 大调</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-G" value="G">
                            <span>G 大调 (1#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-D" value="D">
                            <span>D 大调 (2#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-A" value="A">
                            <span>A 大调 (3#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-E" value="E">
                            <span>E 大调 (4#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-B" value="B">
                            <span>B 大调 (5#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-F#" value="F#">
                            <span>F# 大调 (6#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-F" value="F">
                            <span>F 大调 (1b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Bb" value="Bb">
                            <span>Bb 大调 (2b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Eb" value="Eb">
                            <span>Eb 大调 (3b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Ab" value="Ab">
                            <span>Ab 大调 (4b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Db" value="Db">
                            <span>Db 大调 (5b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Gb" value="Gb">
                            <span>Gb 大调 (6b)</span>
                        </label>
                    </div>
                </div>

                <div class="rhythm-section" style="margin-top: 30px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4>小调 (Minor)</h4>
                        <button class="btn-select-all" onclick="selectAllMinorKeys()" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">全选小调</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Am" value="Am">
                            <span>A 小调</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Em" value="Em">
                            <span>E 小调 (1#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Bm" value="Bm">
                            <span>B 小调 (2#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-F#m" value="F#m">
                            <span>F# 小调 (3#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-C#m" value="C#m">
                            <span>C# 小调 (4#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-G#m" value="G#m">
                            <span>G# 小调 (5#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-D#m" value="D#m">
                            <span>D# 小调 (6#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Dm" value="Dm">
                            <span>D 小调 (1b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Gm" value="Gm">
                            <span>G 小调 (2b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Cm" value="Cm">
                            <span>C 小调 (3b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Fm" value="Fm">
                            <span>F 小调 (4b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Bbm" value="Bbm">
                            <span>Bb 小调 (5b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Ebm" value="Ebm">
                            <span>Eb 小调 (6b)</span>
                        </label>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveKeySettings()">保存设置</button>
                    <button class="btn-secondary" onclick="closeKeySettings()">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 拍号设置弹窗 -->
    <div id="timeSignatureModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>拍号设置</h3>
                <button class="close-btn" onclick="closeTimeSignatureSettings()">×</button>
            </div>
            <div class="modal-body">
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4>拍号选项</h4>
                        <button class="btn-select-all" onclick="selectAllTimeSignatures()" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">全选</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="time-2/4" value="2/4">
                            <span>2/4 拍</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="time-3/4" value="3/4">
                            <span>3/4 拍</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="time-4/4" value="4/4" checked>
                            <span>4/4 拍</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="time-6/8" value="6/8">
                            <span>6/8 拍</span>
                        </label>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveTimeSignatureSettings()">保存设置</button>
                    <button class="btn-secondary" onclick="closeTimeSignatureSettings()">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 音程跨度设置弹窗 -->
    <div id="intervalModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>音程跨度设置</h3>
                <button class="close-btn" onclick="closeIntervalSettings()">×</button>
            </div>
            <div class="modal-body">
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4>最大音程跨度选项</h4>
                        <small style="color: #666; font-size: 12px;">只能选择一个音程作为最大跨度</small>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-1" value="1" onchange="handleIntervalCheckboxChange(this)">
                            <span>小二度</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-2" value="2" onchange="handleIntervalCheckboxChange(this)">
                            <span>大二度</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-3" value="3" onchange="handleIntervalCheckboxChange(this)">
                            <span>小三度</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-4" value="4" onchange="handleIntervalCheckboxChange(this)">
                            <span>大三度</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-5" value="5" onchange="handleIntervalCheckboxChange(this)">
                            <span>完全四度</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-6" value="6" onchange="handleIntervalCheckboxChange(this)">
                            <span>增四度/减五度</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-7" value="7" onchange="handleIntervalCheckboxChange(this)">
                            <span>完全五度</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-8" value="8" onchange="handleIntervalCheckboxChange(this)">
                            <span>小六度</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-9" value="9" onchange="handleIntervalCheckboxChange(this)">
                            <span>大六度</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-10" value="10" onchange="handleIntervalCheckboxChange(this)">
                            <span>小七度</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-11" value="11" onchange="handleIntervalCheckboxChange(this)">
                            <span>大七度</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-12" value="12" checked onchange="handleIntervalCheckboxChange(this)">
                            <span>完全八度</span>
                        </label>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveIntervalSettings()">保存设置</button>
                    <button class="btn-secondary" onclick="closeIntervalSettings()">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 谱号设置弹窗 -->
    <div id="clefModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>谱号设置</h3>
                <button class="close-btn" onclick="closeClefSettings()">×</button>
            </div>
            <div class="modal-body">
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4>谱号选项</h4>
                        <button class="btn-select-all" onclick="selectAllClefs()" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">全选</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="clef-treble" value="treble" checked>
                            <span>高音谱号 (G谱号)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="clef-bass" value="bass">
                            <span>低音谱号 (F谱号)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="clef-alto" value="alto">
                            <span>中音谱号 (C谱号)</span>
                        </label>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveClefSettings()">保存设置</button>
                    <button class="btn-secondary" onclick="closeClefSettings()">取消</button>
                </div>
            </div>
        </div>
    </div>

    <script src="js/minor-scale-spelling.js?v=20250908"></script>
    <script src="js/sight-reading-final.js?v=20250908"></script>
    <script src="js/minor-alterations.js?v=20250908"></script>
    <script src="js/emergency-fix.js?v=20250908"></script>
    
    <!-- 增强的全选切换功能 -->
    <script src="enhanced-select-all.js?v=20250908"></script>
    
    <!-- 主题切换系统 -->
    <script>
        // 主题切换相关变量和功能
        let currentTheme = localStorage.getItem('preferredTheme') || 'light';
        
        // 主题图标
        const themeIcons = {
            'light': '深色', // 在light模式显示深色选项
            'dark': '浅色'   // 在dark模式显示浅色选项
        };
        
        // 切换主题 (保留向后兼容性)
        function toggleTheme() {
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            setTheme(newTheme);
        }
        
        // 设置主题 (新版本，用于设置菜单)
        function setTheme(theme) {
            currentTheme = theme;
            localStorage.setItem('preferredTheme', theme);
            
            // 设置HTML的data-theme属性
            document.documentElement.setAttribute('data-theme', theme);
            
            // 关闭设置菜单
            closeSettings();
            
            console.log(`🎨 主题已设置为: ${theme}`);
        }
        
        // 应用主题 (保留向后兼容性)
        function switchTheme(theme) {
            currentTheme = theme;
            localStorage.setItem('preferredTheme', theme);
            
            // 设置HTML的data-theme属性
            document.documentElement.setAttribute('data-theme', theme);
            
            // 更新按钮图标 (如果存在旧的主题切换器)
            const themeSwitcher = document.getElementById('themeSwitcher');
            if (themeSwitcher) {
                themeSwitcher.textContent = themeIcons[theme];
            }
            
            console.log(`🎨 主题已切换到: ${theme}`);
        }
        
        // 设置菜单控制
        function toggleSettings() {
            const settingsMenu = document.getElementById('settingsMenu');
            const isVisible = settingsMenu.classList.contains('show');
            
            if (isVisible) {
                closeSettings();
            } else {
                openSettings();
            }
        }
        
        function openSettings() {
            const settingsMenu = document.getElementById('settingsMenu');
            settingsMenu.classList.add('show');
            
            // 添加点击外部区域关闭菜单的监听器
            setTimeout(() => {
                document.addEventListener('click', handleClickOutside);
            }, 10);
        }
        
        function closeSettings() {
            const settingsMenu = document.getElementById('settingsMenu');
            settingsMenu.classList.remove('show');
            
            // 移除点击外部区域的监听器
            document.removeEventListener('click', handleClickOutside);
        }
        
        // 处理点击外部区域关闭设置菜单
        function handleClickOutside(event) {
            const settingsDropdown = document.querySelector('.settings-dropdown');
            
            if (settingsDropdown && !settingsDropdown.contains(event.target)) {
                closeSettings();
            }
        }

        // 节拍器相关变量和功能
        let metronomeInterval = null;
        let metronomeAudioContext = null;
        let metronomeOscillator = null;
        let isMetronomeRunning = false;
        let metronomeTempo = 60; // 默认60 BPM

        // 初始化Web Audio API
        function initializeMetronomeAudio() {
            try {
                metronomeAudioContext = new (window.AudioContext || window.webkitAudioContext)();
                console.log('🎵 节拍器音频初始化成功');
                return true;
            } catch (error) {
                console.error('❌ Web Audio API 不支持:', error);
                return false;
            }
        }

        // 播放节拍器声音
        function playMetronomeSound() {
            if (!metronomeAudioContext) {
                if (!initializeMetronomeAudio()) return;
            }

            try {
                // 恢复音频上下文（用户交互后）
                if (metronomeAudioContext.state === 'suspended') {
                    metronomeAudioContext.resume();
                }

                const oscillator = metronomeAudioContext.createOscillator();
                const gainNode = metronomeAudioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(metronomeAudioContext.destination);
                
                // 设置音调 (高音调的嘀嗒声)
                oscillator.frequency.setValueAtTime(800, metronomeAudioContext.currentTime);
                
                // 设置音量包络
                gainNode.gain.setValueAtTime(0, metronomeAudioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.3, metronomeAudioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.01, metronomeAudioContext.currentTime + 0.1);
                
                oscillator.start(metronomeAudioContext.currentTime);
                oscillator.stop(metronomeAudioContext.currentTime + 0.1);

                // 视觉反馈 - 更新header指示器
                const headerIndicator = document.getElementById('headerBeatIndicator');
                
                if (headerIndicator) {
                    headerIndicator.classList.add('beat');
                    setTimeout(() => {
                        headerIndicator.classList.remove('beat');
                    }, 150);
                }
                
            } catch (error) {
                console.error('❌ 节拍器声音播放失败:', error);
            }
        }

        // 设置节拍器速度
        function setMetronomeTempo(bpm) {
            metronomeTempo = Math.max(1, Math.min(999, bpm));
            
            // 同步更新header输入框
            const headerInput = document.getElementById('headerMetronomeBpm');
            if (headerInput) headerInput.value = metronomeTempo;
            
            // 如果节拍器正在运行，重新启动以应用新速度
            if (isMetronomeRunning) {
                stopMetronome();
                startMetronome();
            }
            
            console.log(`🎵 节拍器速度设置为: ${metronomeTempo} BPM`);
        }

        // 启动节拍器
        function startMetronome() {
            const headerInput = document.getElementById('headerMetronomeBpm');
            const tempo = parseInt(headerInput ? headerInput.value : metronomeTempo) || 60;
            setMetronomeTempo(tempo);
            
            if (isMetronomeRunning) return;
            
            const interval = 60000 / metronomeTempo; // 计算间隔时间（毫秒）
            
            isMetronomeRunning = true;
            
            // 立即播放第一拍
            playMetronomeSound();
            
            // 设置定时器
            metronomeInterval = setInterval(() => {
                playMetronomeSound();
            }, interval);
            
            // 更新UI
            updateMetronomeUI();
            
            console.log(`🎵 节拍器已启动: ${metronomeTempo} BPM`);
        }

        // 停止节拍器
        function stopMetronome() {
            if (metronomeInterval) {
                clearInterval(metronomeInterval);
                metronomeInterval = null;
            }
            
            isMetronomeRunning = false;
            updateMetronomeUI();
            
            console.log('🎵 节拍器已停止');
        }

        // 切换节拍器开关
        function toggleMetronome() {
            if (isMetronomeRunning) {
                stopMetronome();
            } else {
                startMetronome();
            }
        }

        // 更新节拍器UI
        function updateMetronomeUI() {
            const headerToggleBtn = document.getElementById('headerMetronomeBtn');
            
            // 更新header中的按钮
            if (headerToggleBtn) {
                if (isMetronomeRunning) {
                    headerToggleBtn.classList.add('active');
                    headerToggleBtn.textContent = '⏸️';
                    headerToggleBtn.title = '停止节拍器';
                } else {
                    headerToggleBtn.classList.remove('active');
                    headerToggleBtn.textContent = '🎵';
                    headerToggleBtn.title = '开始节拍器';
                }
            }
        }

        // 监听header中BPM输入框的变化
        document.addEventListener('DOMContentLoaded', function() {
            const headerSpeedInput = document.getElementById('headerMetronomeBpm');
            
            if (headerSpeedInput) {
                // 实时输入验证
                headerSpeedInput.addEventListener('input', function() {
                    let value = parseInt(this.value);
                    
                    // 限制范围
                    if (value < 1) {
                        this.value = 1;
                        value = 1;
                    } else if (value > 999) {
                        this.value = 999;
                        value = 999;
                    }
                    
                    if (!isNaN(value)) {
                        setMetronomeTempo(value);
                    }
                });
                
                // Enter键确认
                headerSpeedInput.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        this.blur(); // 失去焦点，触发验证
                    }
                });
                
                // 失去焦点时验证
                headerSpeedInput.addEventListener('blur', function() {
                    let value = parseInt(this.value);
                    
                    if (isNaN(value) || value < 1) {
                        this.value = 1;
                        value = 1;
                    } else if (value > 999) {
                        this.value = 999;
                        value = 999;
                    }
                    
                    setMetronomeTempo(value);
                });

                // BPM拖动功能实现
                let isDragging = false;
                let startY = 0;
                let startValue = 0;
                let dragTimeout = null;
                let hasStartedDrag = false;
                
                // 鼠标按下事件
                headerSpeedInput.addEventListener('mousedown', function(event) {
                    // 只处理左键点击
                    if (event.button !== 0) return;
                    
                    startY = event.clientY;
                    startValue = parseInt(this.value) || 60;
                    hasStartedDrag = false;
                    
                    console.log('BPM拖动: 鼠标按下', startValue);
                    
                    // 长按80ms后启动拖动模式
                    dragTimeout = setTimeout(() => {
                        isDragging = true;
                        hasStartedDrag = true;
                        
                        console.log('BPM拖动: 启动拖动模式');
                        
                        // 防止文本选择和默认行为
                        event.preventDefault();
                        document.body.style.userSelect = 'none';
                        document.body.style.webkitUserSelect = 'none';
                        document.body.style.mozUserSelect = 'none';
                        document.body.style.msUserSelect = 'none';
                        
                        // 添加拖动中的视觉反馈
                        this.style.cursor = 'ns-resize';
                        this.classList.add('dragging');
                        this.blur(); // 失去焦点，避免键盘输入干扰
                    }, 80);
                });
                
                // 鼠标移动事件 - 绑定到全局
                const handleMouseMove = function(event) {
                    if (!isDragging || !hasStartedDrag) return;
                    
                    const deltaY = startY - event.clientY; // 向上为正，向下为负
                    const sensitivity = 1; // 拖动灵敏度，每1像素改变1个BPM
                    const newValue = Math.max(1, Math.min(999, startValue + Math.round(deltaY / sensitivity)));
                    
                    console.log('BPM拖动: 移动中', deltaY, newValue);
                    
                    headerSpeedInput.value = newValue;
                    setMetronomeTempo(newValue);
                    
                    // 阻止默认行为
                    event.preventDefault();
                    event.stopPropagation();
                };
                
                // 鼠标释放事件 - 绑定到全局
                const handleMouseUp = function(event) {
                    console.log('BPM拖动: 鼠标释放', isDragging);
                    
                    // 清除长按计时器
                    if (dragTimeout) {
                        clearTimeout(dragTimeout);
                        dragTimeout = null;
                    }
                    
                    if (isDragging && hasStartedDrag) {
                        isDragging = false;
                        hasStartedDrag = false;
                        
                        // 恢复文本选择
                        document.body.style.userSelect = '';
                        document.body.style.webkitUserSelect = '';
                        document.body.style.mozUserSelect = '';
                        document.body.style.msUserSelect = '';
                        
                        // 移除视觉反馈
                        headerSpeedInput.style.cursor = '';
                        headerSpeedInput.classList.remove('dragging');
                        
                        console.log('BPM拖动: 结束拖动模式');
                    }
                };
                
                // 绑定全局事件
                document.addEventListener('mousemove', handleMouseMove, true);
                document.addEventListener('mouseup', handleMouseUp, true);
                
                // 鼠标离开输入框时取消长按
                headerSpeedInput.addEventListener('mouseleave', function(event) {
                    if (dragTimeout && !isDragging) {
                        clearTimeout(dragTimeout);
                        dragTimeout = null;
                        console.log('BPM拖动: 鼠标离开，取消长按');
                    }
                });
                
                // 防止右键菜单干扰
                headerSpeedInput.addEventListener('contextmenu', function(event) {
                    if (isDragging) {
                        event.preventDefault();
                    }
                });
            }
        });
        
        // 初始化主题
        function initializeTheme() {
            switchTheme(currentTheme);
        }
        
        // 页面加载时初始化主题
        document.addEventListener('DOMContentLoaded', function() {
            initializeTheme();
        });
    </script>

    <!-- 多语言系统 -->
    <script>
        // 多语言翻译对象
        const translations = {
            'zh-CN': {
                'app.title': 'IC Studio - 视奏旋律生成器',
                'app.subtitle': '专业级乐谱渲染与音乐理论工具',
                'controls.interval': '音程跨度',
                'controls.intervalSettings': '音程设置',
                'controls.measures': '小节数',
                'controls.measures2': '2小节',
                'controls.measures4': '4小节',
                'controls.measures8': '8小节',
                'controls.key': '调号',
                'controls.keySettings': '调号设置',
                'controls.time': '拍号',
                'controls.timeSettings': '拍号设置',
                'controls.clef': '谱号',
                'controls.clefSettings': '谱号设置',
                'controls.rangeMin': '最低音',
                'controls.rangeMax': '最高音',
                'controls.accidental': '临时记号',
                'controls.metronome': '节拍器',
                'controls.generate': '生成旋律',
                'controls.previous': '上一条',
                'controls.next': '下一条',
                'controls.rhythm': '节奏设置',
                'controls.articulation': '演奏技巧',
                'score.empty': '点击生成旋律开始练习',
                'settings.title': '设置',
                'settings.theme': '主题',
                'settings.language': '语言',
                'settings.lightMode': '浅色模式',
                'settings.darkMode': '深色模式',
                'settings.metronome': '节拍器',
                'settings.tempo': '速度 (BPM)',
                'settings.startMetronome': '开始节拍器',
                'settings.stopMetronome': '停止节拍器'
            },
            'zh-TW': {
                'app.title': 'IC Studio - 視奏旋律生成器',
                'app.subtitle': '專業級樂譜渲染與音樂理論工具',
                'controls.interval': '音程跨度',
                'controls.intervalSettings': '音程設置',
                'controls.measures': '小節數',
                'controls.measures2': '2小節',
                'controls.measures4': '4小節',
                'controls.measures8': '8小節',
                'controls.key': '調號',
                'controls.keySettings': '調號設置',
                'controls.time': '拍號',
                'controls.timeSettings': '拍號設置',
                'controls.clef': '譜號',
                'controls.clefSettings': '譜號設置',
                'controls.rangeMin': '最低音',
                'controls.rangeMax': '最高音',
                'controls.accidental': '臨時記號',
                'controls.metronome': '節拍器',
                'controls.generate': '生成旋律',
                'controls.previous': '上一條',
                'controls.next': '下一條',
                'controls.rhythm': '節奏設置',
                'controls.articulation': '演奏技巧',
                'score.empty': '點擊生成旋律開始練習',
                'settings.title': '設置',
                'settings.theme': '主題',
                'settings.language': '語言',
                'settings.lightMode': '淺色模式',
                'settings.darkMode': '深色模式',
                'settings.metronome': '節拍器',
                'settings.tempo': '速度 (BPM)',
                'settings.startMetronome': '開始節拍器',
                'settings.stopMetronome': '停止節拍器'
            },
            'en': {
                'app.title': 'IC Studio - Sight-Reading Generator',
                'app.subtitle': 'Professional Music Score Rendering & Music Theory Tool',
                'controls.interval': 'Interval Range',
                'controls.intervalSettings': 'Interval Settings',
                'controls.measures': 'Measures',
                'controls.measures2': '2 Measures',
                'controls.measures4': '4 Measures',
                'controls.measures8': '8 Measures',
                'controls.key': 'Key Signature',
                'controls.keySettings': 'Key Settings',
                'controls.time': 'Time Signature',
                'controls.timeSettings': 'Time Settings',
                'controls.clef': 'Clef',
                'controls.clefSettings': 'Clef Settings',
                'controls.rangeMin': 'Lowest Note',
                'controls.rangeMax': 'Highest Note',
                'controls.accidental': 'Accidentals',
                'controls.metronome': 'Metronome',
                'controls.generate': 'Generate Melody',
                'controls.previous': 'Previous',
                'controls.next': 'Next',
                'controls.rhythm': 'Rhythm Settings',
                'controls.articulation': 'Articulations',
                'score.empty': 'Click Generate Melody to Start Practice',
                'settings.title': 'Settings',
                'settings.theme': 'Theme',
                'settings.language': 'Language',
                'settings.lightMode': 'Light Mode',
                'settings.darkMode': 'Dark Mode',
                'settings.metronome': 'Metronome',
                'settings.tempo': 'Tempo (BPM)',
                'settings.startMetronome': 'Start Metronome',
                'settings.stopMetronome': 'Stop Metronome'
            }
        };

        // 语言切换相关变量
        let currentLanguage = localStorage.getItem('preferredLanguage') || 'zh-CN';
        
        // 语言按钮显示文本
        const languageLabels = {
            'zh-CN': '🌐 简体中文',
            'zh-TW': '🌐 繁體中文',
            'en': '🌐 English'
        };


        // 切换语言
        function switchLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('preferredLanguage', lang);
            
            // 更新按钮文本 (如果存在旧的语言按钮)
            const languageBtn = document.getElementById('languageBtn');
            if (languageBtn) {
                languageBtn.textContent = languageLabels[lang];
            }
            
            // 应用翻译
            applyTranslations();
            
            // 关闭设置菜单
            closeSettings();
            
            console.log(`🌐 语言已切换到: ${lang}`);
        }

        // 应用翻译
        function applyTranslations() {
            const elements = document.querySelectorAll('[data-i18n]');
            const currentTranslations = translations[currentLanguage] || translations['zh-CN'];
            
            elements.forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (currentTranslations[key]) {
                    element.textContent = currentTranslations[key];
                }
            });
        }

        // 页面加载时初始化语言
        document.addEventListener('DOMContentLoaded', function() {
            // 检查是否有保存的语言偏好
            const savedLanguage = localStorage.getItem('preferredLanguage');
            
            if (savedLanguage) {
                // 如果有保存的语言偏好，设置当前语言并显示对应语言名称
                currentLanguage = savedLanguage;
                document.getElementById('languageBtn').textContent = languageLabels[currentLanguage];
            } else {
                // 如果没有保存的语言偏好，显示默认的 🌐 文/A
                document.getElementById('languageBtn').textContent = '🌐 文/A';
            }
            
            // 应用翻译
            applyTranslations();
            
            console.log(`🌐 初始化语言: ${currentLanguage}`);
        });
    </script>

    <script>
        // 重写模态框关闭函数以重置全选状态
        const originalCloseRhythmSettings = window.closeRhythmSettings;
        const originalCloseArticulationSettings = window.closeArticulationSettings;
        const originalCloseKeySettings = window.closeKeySettings;
        const originalCloseTimeSignatureSettings = window.closeTimeSignatureSettings;
        const originalCloseIntervalSettings = window.closeIntervalSettings;
        const originalCloseClefSettings = window.closeClefSettings;

        if (typeof originalCloseRhythmSettings === 'function') {
            window.closeRhythmSettings = function() {
                originalCloseRhythmSettings();
                if (typeof resetSelectAllStates === 'function') resetSelectAllStates();
            };
        }

        if (typeof originalCloseArticulationSettings === 'function') {
            window.closeArticulationSettings = function() {
                originalCloseArticulationSettings();
                if (typeof resetSelectAllStates === 'function') resetSelectAllStates();
            };
        }

        if (typeof originalCloseKeySettings === 'function') {
            window.closeKeySettings = function() {
                originalCloseKeySettings();
                if (typeof resetSelectAllStates === 'function') resetSelectAllStates();
            };
        }

        if (typeof originalCloseTimeSignatureSettings === 'function') {
            window.closeTimeSignatureSettings = function() {
                originalCloseTimeSignatureSettings();
                if (typeof resetSelectAllStates === 'function') resetSelectAllStates();
            };
        }

        if (typeof originalCloseIntervalSettings === 'function') {
            window.closeIntervalSettings = function() {
                originalCloseIntervalSettings();
                if (typeof resetSelectAllStates === 'function') resetSelectAllStates();
            };
        }

        if (typeof originalCloseClefSettings === 'function') {
            window.closeClefSettings = function() {
                originalCloseClefSettings();
                if (typeof resetSelectAllStates === 'function') resetSelectAllStates();
            };
        }

        // 动态隐藏包含特定文本的SVG元素
        function hideTitleAndInstrumentElements() {
            // 等待一会儿让OSMD渲染完成
            setTimeout(() => {
                const scoreDiv = document.getElementById('score');
                if (scoreDiv) {
                    // 查找所有SVG text元素
                    const textElements = scoreDiv.querySelectorAll('svg text');
                    textElements.forEach(element => {
                        const text = element.textContent || element.innerText;
                        if (text && (
                            text.includes('Piano') || 
                            text.includes('Untitled') || 
                            text.includes('Untitled Score') ||
                            text.trim() === 'Piano' ||
                            text.trim() === 'Untitled Score'
                        )) {
                            element.style.display = 'none';
                            element.style.visibility = 'hidden';
                            console.log('隐藏文本元素:', text);
                        }
                    });
                    
                    // 也检查其他可能的元素
                    const allElements = scoreDiv.querySelectorAll('*');
                    allElements.forEach(element => {
                        const text = element.textContent || element.innerText;
                        if (text && element.tagName !== 'SCRIPT' && (
                            text.trim() === 'Piano' ||
                            text.trim() === 'Untitled Score'
                        )) {
                            element.style.display = 'none';
                            element.style.visibility = 'hidden';
                            console.log('隐藏元素:', element.tagName, text);
                        }
                    });
                }
            }, 500);
        }
        
        // 清除空谱子提示信息
        function clearEmptyScoreMessage() {
            const scoreDiv = document.getElementById('score');
            if (scoreDiv) {
                const emptyMessage = scoreDiv.querySelector('.empty-score-message');
                if (emptyMessage) {
                    emptyMessage.remove();
                }
            }
        }

        // 监听OSMD渲染完成 - 临时禁用所有重写
        /*
        const originalGenerateMelody = window.generateMelody;
        if (originalGenerateMelody) {
            window.generateMelody = function(...args) {
                // 清除空谱子提示信息
                clearEmptyScoreMessage();
                
                const result = originalGenerateMelody.apply(this, args);
                hideTitleAndInstrumentElements();
                return result;
            };
        }
        */
        
        // 页面加载完成后也执行一次
        document.addEventListener('DOMContentLoaded', () => {
            hideTitleAndInstrumentElements();
            // 定期检查
            setInterval(hideTitleAndInstrumentElements, 2000);
        });
    </script>


    <!-- Trial Management Script Removed - Now Using Counter System -->
    <script>
        console.log("⚡ 时间限制系统已移除，现在使用计数器系统管理");
        // 移除所有试用相关的localStorage数据
        localStorage.removeItem("ic_studio_trial_data");
        localStorage.removeItem("trial-start-time");
        localStorage.removeItem("trial-used-time");
        localStorage.removeItem("trial-end-time");
        console.log("🧹 已清理所有时间相关存储数据");
    </script>
    <!-- 全局错误拦截器 - 必须最先加载 -->
    <script src="/js/global-error-interceptor.js?v=20250908"></script>
    
    <!-- 自动填充访问码脚本 -->
    <script>
        // 检查是否需要自动填充访问码
        function checkAutoFillAccessCode() {
            const accessData = localStorage.getItem('ic-premium-access');
            if (accessData) {
                try {
                    const data = JSON.parse(accessData);
                    if (data && data.autoFill && data.code) {
                        console.log('🎯 检测到自动填充标记，准备填入访问码:', data.code);
                        
                        // 延迟执行确保DOM已加载
                        setTimeout(() => {
                            const accessInput = document.getElementById('access-code-input');
                            const verifyResult = document.getElementById('verify-result');
                            
                            if (accessInput && verifyResult) {
                                // 自动填入访问码
                                accessInput.value = data.code;
                                console.log('✅ 访问码已自动填入:', data.code);
                                
                                // 清除自动填充标记
                                data.autoFill = false;
                                localStorage.setItem('ic-premium-access', JSON.stringify(data));
                                
                                // 自动触发验证
                                verifyResult.innerHTML = '<span style="color: #3498db;">🎯 自动验证访问码中...</span>';
                                
                                setTimeout(() => {
                                    if (window.directVerifyCode) {
                                        directVerifyCode();
                                        console.log('✅ 自动验证访问码已触发');
                                    } else {
                                        console.log('⚠️ directVerifyCode函数未找到，手动处理验证');
                                        // 手动验证逻辑
                                        const accessData = {
                                            code: data.code,
                                            activatedAt: Date.now(),
                                            deviceId: 'auto-fill-' + Date.now(),
                                            expiresAt: null,
                                            version: '2.0-auto-fill',
                                            source: 'auto-fill'
                                        };
                                        localStorage.setItem('ic-premium-access', JSON.stringify(accessData));
                                        verifyResult.innerHTML = '<span style="color: #27ae60;">✅ 访问码自动验证成功！</span>';
                                        
                                        // 隐藏支付相关区域
                                        const zpayContainer = document.getElementById('zpay-container');
                                        if (zpayContainer) zpayContainer.style.display = 'none';
                                        
                                        const accessCodeContainer = document.getElementById('access-code-container');
                                        if (accessCodeContainer) accessCodeContainer.style.display = 'none';
                                        
                                        setTimeout(() => {
                                            window.location.reload();
                                        }, 1500);
                                    }
                                }, 500);
                                
                            } else {
                                console.log('⚠️ 访问码输入框未找到，延迟重试');
                                setTimeout(checkAutoFillAccessCode, 1000);
                            }
                        }, 100);
                    }
                } catch (e) {
                    console.log('⚠️ 访问码数据解析失败:', e);
                }
            }
        }
        
        // 页面加载完成后检查
        document.addEventListener('DOMContentLoaded', checkAutoFillAccessCode);
        
        // 额外的延迟检查（确保所有脚本加载完毕）
        setTimeout(checkAutoFillAccessCode, 1000);
    </script>
    
    <!-- 20条旋律严格计数系统 - 必须最先加载以拦截generateMelody -->
    <script src="/js/melody-counter-system.js?v=20250113-fix"></script>

    <!-- 高级试用保护系统 - 防无痕浏览模式绕过 -->
    <script src="/js/advanced-trial-protection.js?v=20250920"></script>

    <!-- 试用限制器 (已移除时间限制，现在使用计数器系统) -->
    <script src="/js/trial-limiter.js?v=20250114"></script>

    <!-- 集成试用管理器 - 统一管理所有试用限制 -->
    <script src="/js/integrated-trial-manager.js?v=20250920"></script>

    <!-- 付费用户界面管理器 -->
    <script src="/js/premium-ui-manager.js?v=20250908"></script>
    
    <!-- 支付状态管理器 - 解决验证不一致和状态持久化问题 -->
    <script src="/js/payment-state-manager.js?v=20250909"></script>
    
    <!-- 访问码验证增强器 -->
    <script src="/js/access-code-enhancer.js?v=20250909"></script>
    
    <!-- 确保全局函数可用的备用脚本 -->
    <script>
    // 【增强】保护访问码输入框不被意外清空或替换
    function protectAccessCodeInput() {
        const input = document.getElementById('access-code-input');
        if (input && !input.hasAttribute('data-protected')) {
            input.setAttribute('data-protected', 'true');
            
            // 备份当前值
            let userValue = input.value;
            let isUserTyping = false;
            let protectionActive = true;
            
            // 监听用户输入事件
            input.addEventListener('input', function() {
                isUserTyping = true;
                userValue = this.value;
                console.log('📝 用户输入访问码:', userValue);
            });
            
            input.addEventListener('focus', function() {
                isUserTyping = true;
                console.log('🎯 用户聚焦访问码输入框');
            });
            
            input.addEventListener('blur', function() {
                setTimeout(() => { isUserTyping = false; }, 1000);
                console.log('👤 用户离开访问码输入框');
            });
            
            // 监听DOM变化，防止整个输入框被替换
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList') {
                        // 检查访问码输入框是否还存在
                        const currentInput = document.getElementById('access-code-input');
                        if (!currentInput && protectionActive) {
                            console.log('⚠️ 访问码输入框被移除，尝试恢复');
                            setTimeout(protectAccessCodeInput, 100);
                        } else if (currentInput && currentInput !== input && protectionActive) {
                            console.log('⚠️ 访问码输入框被替换，恢复用户数据');
                            if (userValue) {
                                currentInput.value = userValue;
                                console.log('✅ 已恢复用户输入:', userValue);
                            }
                            setTimeout(protectAccessCodeInput, 100);
                        }
                    }
                });
            });
            
            // 开始观察DOM变化
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
            
            // 重写value属性保护
            const originalDescriptor = Object.getOwnPropertyDescriptor(HTMLInputElement.prototype, 'value');
            Object.defineProperty(input, 'value', {
                get: function() {
                    return originalDescriptor.get.call(this);
                },
                set: function(newValue) {
                    // 如果用户正在输入且新值为空，则保护用户数据
                    if (isUserTyping && newValue === '' && userValue !== '') {
                        console.log('🛡️ 阻止清空用户正在输入的访问码:', userValue);
                        return;
                    }
                    // 如果不是用户输入且有备份值，询问是否恢复
                    if (!isUserTyping && newValue === '' && userValue !== '') {
                        console.log('🔄 检测到输入框被清空，保持用户数据:', userValue);
                        originalDescriptor.set.call(this, userValue);
                        return;
                    }
                    originalDescriptor.set.call(this, newValue);
                },
                configurable: true
            });
            
            // 页面卸载时清理
            window.addEventListener('beforeunload', function() {
                protectionActive = false;
                observer.disconnect();
            });
            
            console.log('🛡️ 增强版访问码输入框保护已启用');
        }
    }
    
    // 调试功能：监控访问码输入框的所有变化
    function debugAccessCodeInput() {
        const input = document.getElementById('access-code-input');
        if (input && !input.hasAttribute('data-debug')) {
            input.setAttribute('data-debug', 'true');
            
            // 监控所有可能的事件
            ['input', 'change', 'keydown', 'keyup', 'focus', 'blur', 'select'].forEach(eventType => {
                input.addEventListener(eventType, function(e) {
                    console.log(`🔍 访问码输入框事件 [${eventType}]:`, this.value, e);
                });
            });
            
            // 监控value属性被直接设置
            const originalDescriptor = Object.getOwnPropertyDescriptor(HTMLInputElement.prototype, 'value');
            if (originalDescriptor && !input.hasAttribute('data-value-monitored')) {
                input.setAttribute('data-value-monitored', 'true');
                
                Object.defineProperty(input, 'value', {
                    get: function() {
                        const value = originalDescriptor.get.call(this);
                        console.log('🔍 读取访问码输入框值:', value);
                        return value;
                    },
                    set: function(newValue) {
                        const oldValue = originalDescriptor.get.call(this);
                        console.log('🔍 设置访问码输入框值:', oldValue, '=>', newValue);
                        console.trace('调用堆栈:');
                        originalDescriptor.set.call(this, newValue);
                    },
                    configurable: true
                });
            }
            
            console.log('🔍 访问码输入框调试监控已启用');
        }
    }
    
    // 页面加载后启用保护和调试
    document.addEventListener('DOMContentLoaded', function() {
        protectAccessCodeInput();
        debugAccessCodeInput();
    });
    
    // 定期检查并保护（减少频率）- 临时禁用，避免干扰验证
    // setInterval(function() {
    //     protectAccessCodeInput();
    //     debugAccessCodeInput();
    // }, 3000);
    
    // 备用重置函数，确保控制台可用
    if (!window.resetToFreshUser) {
        window.resetToFreshUser = function() {
            console.log('🔄 使用备用重置函数');
            
            try {
                // 清理所有存储的用户数据
                localStorage.removeItem('ic-premium-access');
                localStorage.removeItem('ic-full-access');
                localStorage.removeItem('ic-verified-user');
                localStorage.removeItem('ic-sight-reading-trial');
                localStorage.removeItem('ic-device-id');
                localStorage.removeItem('ic-trial-end');
                localStorage.removeItem('ic-reset-count');
                localStorage.removeItem('ic-anticheat-exempt');
                
                // 清理会话存储
                sessionStorage.removeItem('ic-device-id-session');
                
                // 清理cookie
                document.cookie = 'ic_device_backup=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                
                console.log('✅ 已清理所有用户数据');
                
                // 刷新页面重新开始
                window.location.reload();
                
            } catch (error) {
                console.error('❌ 重置过程中出现错误:', error);
                alert('⚠️ 重置过程中出现错误，建议手动刷新页面');
            }
        };
    }
    
    // 确保其他常用函数也可用
    if (!window.debugAccessSystem) {
        window.debugAccessSystem = function() {
            console.log('🔍 访问系统调试信息:');
            console.log('💾 LocalStorage数据:');
            console.log('  - ic-premium-access:', localStorage.getItem('ic-premium-access'));
            console.log('  - ic-sight-reading-trial:', localStorage.getItem('ic-sight-reading-trial'));
            console.log('  - ic-device-id:', localStorage.getItem('ic-device-id'));
            
            console.log('🔧 系统状态:');
            console.log('  - cloudbaseAPI:', !!window.cloudbaseAPI);
            console.log('  - trialLimiter:', !!window.trialLimiter);
            console.log('  - premiumUIManager:', !!window.premiumUIManager);
            
            return {
                localStorage: {
                    premiumAccess: localStorage.getItem('ic-premium-access'),
                    trial: localStorage.getItem('ic-sight-reading-trial'),
                    deviceId: localStorage.getItem('ic-device-id')
                },
                functions: {
                    resetToFreshUser: typeof window.resetToFreshUser,
                    trialLimiter: !!window.trialLimiter,
                    uiManager: !!window.premiumUIManager,
                    cloudbaseAPI: !!window.cloudbaseAPI
                }
            };
        };
    }
    
    // 【新增】简化的访问码测试函数
    if (!window.testAccessCodeDirect) {
        window.testAccessCodeDirect = async function(code) {
            if (!code) {
                console.error('❌ 请提供访问码，例如: testAccessCodeDirect("ABC123456789")');
                return;
            }
            
            console.log('🧪 直接测试访问码验证:', code);
            
            try {
                if (!window.cloudbaseAPI) {
                    console.error('❌ CloudBase API未初始化');
                    return { error: 'CloudBase API未初始化' };
                }
                
                console.log('🔄 开始验证...');
                const result = await window.cloudbaseAPI.verifyAccessCode(code);
                
                console.log('📥 验证结果:', result);
                
                if (result && result.valid) {
                    console.log('✅ 验证成功！保存到localStorage...');
                    
                    const accessData = {
                        code: result.data.code,
                        activatedAt: Date.now(),
                        deviceId: window.trialLimiter?.deviceId || 'test',
                        expiresAt: result.data.expiresAt,
                        version: '3.0-test',
                        purchaseDate: result.data.purchaseDate,
                        features: result.data.features || ['sight-reading-tool']
                    };
                    
                    localStorage.setItem('ic-premium-access', JSON.stringify(accessData));
                    console.log('✅ 已保存访问码，2秒后刷新页面...');
                    
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                    
                    return { success: true, data: accessData };
                } else {
                    console.log('❌ 验证失败:', result?.error || '未知错误');
                    return { success: false, error: result?.error || '验证失败' };
                }
                
            } catch (error) {
                console.error('❌ 测试过程中发生错误:', error);
                return { success: false, error: error.message };
            }
        };
    }
    
    // 【临时调试】检查访问码验证函数状态
    window.debugVerificationSystem = function() {
        console.log('🔍 访问码验证系统调试:');
        
        if (window.cloudbaseAPI) {
            console.log('✅ CloudBase API已加载');
            console.log('API版本:', window.cloudbaseAPI.version);
            console.log('API模式:', window.cloudbaseAPI.getCurrentMode ? window.cloudbaseAPI.getCurrentMode() : '未知');
            
            // 测试一个12位随机访问码
            const testCode = 'AB8X3KL9MN12';
            console.log('🧪 测试随机访问码格式验证:', testCode);
            
            // 检查应急验证逻辑
            try {
                const isValidFormat = /^[A-Z0-9]{11,12}$/.test(testCode);
                console.log('格式验证结果:', isValidFormat);
                
                if (window.cloudbaseAPI.verifyAccessCode) {
                    console.log('开始API验证测试...');
                    window.cloudbaseAPI.verifyAccessCode(testCode).then(result => {
                        console.log('API验证结果:', result);
                    }).catch(error => {
                        console.log('API验证错误:', error);
                    });
                }
            } catch (error) {
                console.error('调试过程出错:', error);
            }
        } else {
            console.error('❌ CloudBase API未加载');
        }
    };
    </script>
    
    <!-- 集成统一支付系统 -->
    <script src="/js/cloudbase-api.js?v=20250908"></script>
    <script src="/js/payment-success-handler.js?v=20250910"></script>
    <script src="/js/zpay-simple.js?v=1.0.0"></script>
    
    <!-- 测试支付注入器（仅在开发环境） -->
    <script src="/js/test-payment-injector.js?v=20250908"></script>
    
    <!-- 使用条款弹窗 -->
    <div id="terms-dialog" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 30px; border-radius: 16px; max-width: 600px; max-height: 80vh; overflow-y: auto; margin: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.3);">
            <h3 style="color: #2d3748; margin-bottom: 20px; text-align: center;">📜 使用条款</h3>
            <div style="line-height: 1.6; color: #4a5568; font-size: 14px;">
                <h4>1. 服务说明</h4>
                <p>IC Studio 视奏工具为用户提供专业级视奏旋律生成服务。</p>
                
                <h4>2. 购买及使用</h4>
                <p>一次性购买，永久使用。支付成功后立即获得访问码。</p>
                
                <h4>3. 退款政策</h4>
                <p>支持<strong>7天无理由退款</strong>，超过期限不支持退款。</p>
                
                <h4>4. 隐私保护</h4>
                <p>我们严格保护您的个人信息，不会泄露给第三方。</p>
                
                <h4>5. 联系方式</h4>
                <p>如有问题，请发邮件至 service@icstudio.club</p>
            </div>
            <div style="text-align: center; margin-top: 25px;">
                <button onclick="closeTermsDialog()" style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                    关闭
                </button>
            </div>
        </div>
    </div>
    
    <!-- 隐私政策弹窗 -->
    <div id="privacy-dialog" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 30px; border-radius: 16px; max-width: 600px; max-height: 80vh; overflow-y: auto; margin: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.3);">
            <h3 style="color: #2d3748; margin-bottom: 20px; text-align: center;">🔒 隐私政策</h3>
            <div style="line-height: 1.6; color: #4a5568; font-size: 14px;">
                <h4>1. 信息收集</h4>
                <p>我们只收集必要的交易信息，不会收集与服务无关的个人信息。</p>
                
                <h4>2. 信息使用</h4>
                <p>您的信息仅用于提供服务和客户支持。</p>
                
                <h4>3. 信息保护</h4>
                <p>我们采用业界标准的安全措施保护您的信息。</p>
                
                <h4>4. 信息共享</h4>
                <p>除法律要求外，我们不会与第三方共享您的信息。</p>
            </div>
            <div style="text-align: center; margin-top: 25px;">
                <button onclick="closePrivacyDialog()" style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                    关闭
                </button>
            </div>
        </div>
    </div>

    <script>
        // 访问码输入验证按钮状态更新
        function updateVerifyButton() {
            const input = document.getElementById('access-code-input');
            const button = document.getElementById('verify-btn');
            
            if (input && button) {
                const code = input.value.trim();
                const isValid = code.length === 12 && /^[A-Z0-9]{12}$/.test(code);
                
                button.disabled = !isValid;
                button.style.opacity = isValid ? '1' : '0.5';
                button.style.cursor = isValid ? 'pointer' : 'not-allowed';
            }
        }

        // 处理输入变化
        function handleInputChange() {
            const input = document.getElementById('access-code-input');
            const button = document.getElementById('verify-btn');
            
            if (input && button) {
                const code = input.value.trim();
                const isValid = code.length >= 11 && code.length <= 12 && /^[A-Z0-9]+$/.test(code);
                
                button.dataset.valid = isValid;
                button.style.opacity = '1'; // 始终保持完全不透明
                button.style.cursor = isValid ? 'pointer' : 'not-allowed';
                button.style.background = '#667eea';
                
                console.log('🔄 输入变化处理:', { code, isValid });
            }
        }

        // 处理验证按钮点击
        function handleVerifyClick() {
            console.log('🎯 验证按钮被点击');
            const button = document.getElementById('verify-btn');
            
            if (!button) {
                console.error('❌ 找不到验证按钮');
                return;
            }
            
            const isValid = button.dataset.valid === 'true';
            console.log('🔍 按钮状态检查:', { isValid });
            
            if (!isValid) {
                console.log('⚠️ 按钮处于禁用状态，不执行验证');
                const resultDiv = document.getElementById('verify-result');
                if (resultDiv) {
                    resultDiv.innerHTML = '<span style="color: #e74c3c;">❌ 请输入有效的11-12位访问码</span>';
                }
                return;
            }
            
            // 执行验证
            console.log('✅ 开始执行访问码验证');
            verifyAccessCodeWithServer();
        }

        // 使用服务器端验证访问码
        async function verifyAccessCodeWithServer() {
            const input = document.getElementById('access-code-input');
            const resultDiv = document.getElementById('verify-result');
            const button = document.getElementById('verify-btn');
            
            if (!input || !resultDiv) {
                console.error('❌ 找不到必要的页面元素');
                return;
            }
            
            const code = input.value.trim().toUpperCase();
            if (!code) {
                resultDiv.innerHTML = '<span style="color: #e74c3c;">❌ 请输入访问码</span>';
                return;
            }
            
            if (code.length !== 12 && code.length !== 11) {
                resultDiv.innerHTML = '<span style="color: #e74c3c;">❌ 访问码必须是11-12位</span>';
                return;
            }
            
            if (!/^[A-Z0-9]+$/.test(code)) {
                resultDiv.innerHTML = '<span style="color: #e74c3c;">❌ 访问码只能包含字母和数字</span>';
                return;
            }

            // 禁用按钮防止重复点击
            button.disabled = true;
            button.style.opacity = '0.5';
            resultDiv.innerHTML = '<span style="color: #3498db;">🔄 正在验证访问码...</span>';

            try {
                // 等待 PaymentStateManager 加载
                if (!window.paymentManager) {
                    resultDiv.innerHTML = '<span style="color: #f39c12;">⏳ 正在加载验证系统...</span>';
                    
                    // 等待最多5秒让PaymentStateManager加载
                    let attempts = 0;
                    while (!window.paymentManager && attempts < 50) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        attempts++;
                    }
                    
                    if (!window.paymentManager) {
                        throw new Error('验证系统加载超时，请刷新页面重试');
                    }
                }
                
                console.log('🔍 使用 PaymentStateManager 验证访问码:', code);
                resultDiv.innerHTML = '<span style="color: #3498db;">🔄 正在服务器验证...</span>';
                
                const result = await window.paymentManager.verifyAccessCode(code, true);
                
                if (result.success) {
                    console.log('✅ 访问码验证成功:', result.data);
                    resultDiv.innerHTML = '<span style="color: #27ae60;">✅ 访问码验证成功！</span>';
                    
                    // 重新启用按钮
                    button.disabled = false;
                    button.style.opacity = '1';
                    
                    // 延迟显示弹窗，让用户看到成功消息
                    setTimeout(() => {
                        showPaymentSuccessPopup(code, result.data);
                    }, 800);
                    
                } else {
                    console.log('❌ 访问码验证失败:', result.error);
                    resultDiv.innerHTML = `<span style="color: #e74c3c;">❌ ${result.error}</span>`;
                    button.disabled = false;
                    button.style.opacity = '1';
                }
            } catch (error) {
                console.error('验证访问码失败:', error);
                resultDiv.innerHTML = `<span style="color: #e74c3c;">❌ ${error.message || '验证失败，请稍后重试'}</span>`;
                button.disabled = false;
                button.style.opacity = '1';
            }
        }

        // ===== 支付成功弹窗相关函数 =====
        function showPaymentSuccessPopup(accessCode, orderData) {
            // 创建弹窗HTML
            const popup = document.createElement('div');
            popup.id = 'success-popup';
            popup.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;">
                    <div style="background: white; padding: 40px; border-radius: 16px; max-width: 500px; width: 90%; text-align: center; box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);">
                        <div style="margin-bottom: 30px;">
                            <div style="width: 80px; height: 80px; background: #4CAF50; border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 48px;">✓</div>
                            <h2 style="color: #333; margin-bottom: 10px;">🎉 访问验证成功！</h2>
                            <p style="color: #666; font-size: 16px; margin-bottom: 0;">您的访问码已验证，现在可以使用完整版功能</p>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 30px; text-align: left;">
                            <h3 style="color: #333; margin-bottom: 15px; text-align: center;">📋 验证信息</h3>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center;">
                                <span style="color: #666;">访问码：</span>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-family: monospace; font-weight: bold; background: #f1f5f9; padding: 4px 8px; border-radius: 4px; border: 1px solid #e2e8f0;">${accessCode}</span>
                                    <button onclick="copyAccessCode('${accessCode}')" 
                                            style="background: #3b82f6; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s ease;"
                                            onmouseover="this.style.background='#2563eb'"
                                            onmouseout="this.style.background='#3b82f6'"
                                            title="复制访问码">
                                        📋
                                    </button>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span style="color: #666;">产品：</span>
                                <span>${orderData.product_name || 'IC Studio 视奏工具'}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #666;">验证时间：</span>
                                <span>${new Date().toLocaleString()}</span>
                            </div>
                        </div>

                        <div style="margin-bottom: 30px;">
                            <h3 style="color: #333; margin-bottom: 20px;">📦 下载资源</h3>
                            <div style="display: grid; gap: 10px;">
                                <a href="javascript:void(0)" onclick="downloadFile('/software-packages/IC Studio 视奏工具-1.0.0-mac-x64.dmg', 'IC Studio 视奏工具-1.0.0-mac-x64.dmg')"
                                   style="display: block; background: #f0f9ff; color: #1e40af; padding: 12px 20px; border: 2px solid #93c5fd; border-radius: 8px; text-decoration: none; font-weight: 600; transition: all 0.3s ease; cursor: pointer;"
                                   onmouseover="this.style.background='#1e40af'; this.style.color='white';" 
                                   onmouseout="this.style.background='#f0f9ff'; this.style.color='#1e40af';">
                                    🍎 Mac版本 (DMG)
                                </a>
                                <a href="javascript:void(0)" onclick="downloadFile('/software-packages/IC Studio 视奏工具-1.0.0-win-x64.exe', 'IC Studio 视奏工具-1.0.0-win-x64.exe')"
                                   style="display: block; background: #f0fdf4; color: #166534; padding: 12px 20px; border: 2px solid #86efac; border-radius: 8px; text-decoration: none; font-weight: 600; transition: all 0.3s ease; cursor: pointer;"
                                   onmouseover="this.style.background='#166534'; this.style.color='white';" 
                                   onmouseout="this.style.background='#f0fdf4'; this.style.color='#166534';">
                                    💻 Windows版本 (EXE)
                                </a>
                                <a href="javascript:void(0)" onclick="downloadFile('/software-packages/IC Studio 视奏工具-1.0.0-linux-x86_64.AppImage', 'IC Studio 视奏工具-1.0.0-linux-x86_64.AppImage')"
                                   style="display: block; background: #fef3c7; color: #92400e; padding: 12px 20px; border: 2px solid #fbbf24; border-radius: 8px; text-decoration: none; font-weight: 600; transition: all 0.3s ease; cursor: pointer;"
                                   onmouseover="this.style.background='#92400e'; this.style.color='white';" 
                                   onmouseout="this.style.background='#fef3c7'; this.style.color='#92400e';">
                                    🐧 Linux版本 (AppImage)
                                </a>
                            </div>
                            <p style="font-size: 12px; color: #888; margin-top: 15px;">下载完成后，使用以上访问码激活完整版功能</p>
                        </div>

                        <div style="display: flex; gap: 15px; justify-content: center;">
                            <button onclick="closeSuccessPopup()" 
                                    style="padding: 15px 30px; background: #f8f9fa; color: #333; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;"
                                    onmouseover="this.style.background='#e2e8f0'" 
                                    onmouseout="this.style.background='#f8f9fa'">
                                关闭弹窗
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(popup);
        }

        // 关闭成功弹窗
        function closeSuccessPopup() {
            const popup = document.getElementById('success-popup');
            if (popup) {
                popup.remove();
            }

            // Command+R 风格的页面刷新
            // 添加轻微的视觉反馈，然后执行刷新
            document.body.style.opacity = '0.95';
            document.body.style.transition = 'opacity 0.1s ease';

            setTimeout(() => {
                // 强制刷新页面，类似 Command+R 的效果
                window.location.reload(true);
            }, 100);
        }

        // 复制访问码功能
        function copyAccessCode(accessCode) {
            console.log('📋 复制访问码:', accessCode);
            
            // 使用现代的Clipboard API
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(accessCode).then(() => {
                    showCopyNotification('访问码已复制到剪贴板');
                }).catch(err => {
                    console.error('复制失败:', err);
                    fallbackCopyTextToClipboard(accessCode);
                });
            } else {
                // 降级方案
                fallbackCopyTextToClipboard(accessCode);
            }
        }

        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.top = '0';
            textArea.style.left = '0';
            textArea.style.position = 'fixed';
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopyNotification('访问码已复制到剪贴板');
                } else {
                    showCopyNotification('复制失败，请手动复制', 'error');
                }
            } catch (err) {
                console.error('降级复制失败:', err);
                showCopyNotification('复制失败，请手动复制', 'error');
            }
            
            document.body.removeChild(textArea);
        }

        function showCopyNotification(message, type = 'success') {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? '#22c55e' : '#ef4444';
            
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${bgColor};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                z-index: 10000;
                font-size: 14px;
                font-weight: 600;
            `;
            
            if (type === 'success') {
                notification.innerHTML = `🔽 ${message}`;
            } else {
                notification.innerHTML = `❌ ${message}`;
            }
            
            document.body.appendChild(notification);
            
            // 3秒后移除通知
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.opacity = '0';
                    notification.style.transition = 'opacity 0.3s ease';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            document.body.removeChild(notification);
                        }
                    }, 300);
                }
            }, 3000);
        }

        // 下载文件功能
        function downloadFile(url, filename) {
            console.log('🔽 开始下载文件:', filename);
            console.log('🔗 原始URL:', url);
            
            // 构建完整URL
            const fullUrl = new URL(url, window.location.origin).href;
            console.log('📍 完整URL:', fullUrl);
            
            // 创建临时下载链接元素
            const downloadLink = document.createElement('a');
            downloadLink.href = fullUrl;
            downloadLink.download = filename;
            downloadLink.style.display = 'none';
            
            // 添加到页面
            document.body.appendChild(downloadLink);
            
            try {
                // 触发下载
                downloadLink.click();
                console.log('✅ 下载已启动:', filename);
                showDownloadNotification(filename);
            } catch (error) {
                console.error('❌ 下载失败:', error);
                // 降级到直接打开
                window.open(fullUrl, '_blank');
                showDownloadNotification(filename);
            }
            
            // 清理临时元素
            setTimeout(() => {
                if (downloadLink.parentNode) {
                    document.body.removeChild(downloadLink);
                }
            }, 100);
        }

        function showDownloadNotification(message, type = 'success') {
            // 创建临时通知
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? '#22c55e' : '#ef4444';
            
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 20px;
                background: ${bgColor};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                z-index: 10000;
                font-size: 14px;
                font-weight: 600;
            `;
            
            if (type === 'success') {
                notification.innerHTML = `🔽 正在下载 ${message}...`;
            } else {
                notification.innerHTML = `❌ ${message}`;
            }
            
            document.body.appendChild(notification);
            
            // 3秒后移除通知
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.opacity = '0';
                    notification.style.transition = 'opacity 0.3s ease';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            document.body.removeChild(notification);
                        }
                    }, 300);
                }
            }, 3000);
        }

        // 使用条款和隐私政策相关函数
        function togglePaymentButton() {
            const checkbox = document.getElementById('terms-checkbox');
            const buttonContainer = document.getElementById('payment-button-container');
            
            if (checkbox && buttonContainer) {
                buttonContainer.style.display = checkbox.checked ? 'block' : 'none';
            }
        }

        function showTermsDialog() {
            const dialog = document.getElementById('terms-dialog');
            if (dialog) {
                dialog.style.display = 'flex';
            }
        }

        function closeTermsDialog() {
            const dialog = document.getElementById('terms-dialog');
            if (dialog) {
                dialog.style.display = 'none';
            }
        }

        function showPrivacyDialog() {
            const dialog = document.getElementById('privacy-dialog');
            if (dialog) {
                dialog.style.display = 'flex';
            }
        }

        function closePrivacyDialog() {
            const dialog = document.getElementById('privacy-dialog');
            if (dialog) {
                dialog.style.display = 'none';
            }
        }

        // 点击对话框外部关闭
        document.addEventListener('click', function(event) {
            const termsDialog = document.getElementById('terms-dialog');
            const privacyDialog = document.getElementById('privacy-dialog');
            
            if (event.target === termsDialog) {
                closeTermsDialog();
            }
            if (event.target === privacyDialog) {
                closePrivacyDialog();
            }
        });

        // 🧪 测试函数：立即显示支付界面（用于测试使用条款功能）
        window.showPaymentInterface = function() {
            console.log('🧪 测试：显示支付界面');
            
            // 显示支付容器
            const zpayContainer = document.getElementById('zpay-container');
            if (zpayContainer) {
                zpayContainer.style.display = 'block';
            }
            
            // 显示支付区域
            const paymentSection = document.getElementById('payment-section');
            if (paymentSection) {
                paymentSection.style.display = 'block';
            }
            
            console.log('✅ 支付界面已显示，现在您可以测试使用条款确认功能了！');
            console.log('💡 勾选"我已阅读并同意"复选框后，支付按钮将会显示');
        };

        // 新增：跳过试用阶段但显示购买页面的函数
        // 将函数提升到全局作用域确保控制台可访问
        window.showPurchaseMode = function showPurchaseMode() {
            console.log('🛒 进入购买模式（跳过试用）');
            
            try {
                // 1. 停止试用计时器
                if (window.trialLimiter) {
                    // 设置试用为过期状态，但不完全阻止功能
                    window.trialLimiter.isTrialActive = false;
                }
                
                // 2. 隐藏试用计时器
                const trialTimer = document.getElementById('trialTimer');
                if (trialTimer) {
                    trialTimer.style.display = 'none';
                }
                
                // 3. 显示试用结束状态
                const trialStatus = document.getElementById('trial-status');
                if (trialStatus) {
                    trialStatus.innerHTML = `
                        <div style="background: #fff8e1; padding: 20px; border-radius: 12px; border: 2px solid #ffb74d; text-align: center;">
                            <h3 style="color: #ef6c00; margin-bottom: 15px;">🛒 购买完整版解锁所有功能</h3>
                            <p style="color: #ef6c00; margin-bottom: 0;">现在可以购买完整版或输入访问码立即解锁</p>
                        </div>
                    `;
                    trialStatus.style.display = 'block';
                }
                
                // 4. 显示访问码输入区域
                const accessCodeContainer = document.getElementById('access-code-container');
                if (accessCodeContainer) {
                    accessCodeContainer.style.display = 'block';
                }
                
                // 5. 显示支付区域
                const zpayContainer = document.getElementById('zpay-container');
                if (zpayContainer) {
                    zpayContainer.style.display = 'block';
                    zpayContainer.scrollIntoView({ behavior: 'smooth' });
                }
                
                // 6. 禁用生成按钮，显示需要购买
                const generateBtn = document.getElementById('generateBtn') || 
                                   document.querySelector('button[onclick*="generateMelody"]') ||
                                   document.querySelector('button.btn-primary');
                if (generateBtn) {
                    generateBtn.disabled = true;
                    generateBtn.style.opacity = '0.6';
                    generateBtn.textContent = '请购买完整版或输入访问码';
                    generateBtn.style.cursor = 'not-allowed';
                }
                
                alert('🛒 已进入购买模式！\n\n您可以：\n• 购买完整版获得永久访问权\n• 输入访问码立即解锁功能');
                
                console.log('✅ 购买模式已激活');
                
            } catch (error) {
                console.error('❌ 进入购买模式失败:', error);
                alert('⚠️ 切换到购买模式时出现错误');
            }
        }

        console.log('🎉 访问码功能已加载');
        console.log('💡 可用的命令:');
        console.log('  - showPurchaseMode() - 跳过试用，显示购买页面');
        console.log('  - updateVerifyButton() - 更新验证按钮状态');
        console.log('  - verifyAccessCodeWithServer() - 验证访问码');
    </script>

    <!-- 确保20条旋律计数系统正确初始化 -->
    <script>
    // 等待所有脚本加载完成后初始化计数系统
    window.addEventListener('load', function() {
        setTimeout(function() {
            console.log('🎯 强制初始化20条旋律计数系统...');

            // 如果计数系统存在但未初始化，手动初始化
            if (window.melodyCounterSystem && !window.melodyCounterSystem.initialized) {
                window.melodyCounterSystem.init();
            }

            // 如果generateMelody还未被包装，手动包装
            if (window.generateMelody && window.melodyCounterSystem && !window.melodyCounterSystem.originalGenerateMelody) {
                console.log('📦 手动包装generateMelody函数...');
                window.melodyCounterSystem.wrapGenerateMelodyFunction();
            }

            // 跳过自动激活检查，让用户正常使用试用版
            console.log('🔍 跳过自动激活检查，保持试用版状态');

            console.log('✅ 计数系统检查完成');
        }, 2000); // 延迟2秒确保所有脚本都加载完成
    });
    </script>

</body></html>