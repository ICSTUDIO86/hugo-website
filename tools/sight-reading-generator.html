<!DOCTYPE html>
<!--
    IC Studio 视奏工具 - 专业级视奏旋律生成器
    Professional Music Sight-Reading Tool
    
    Copyright © 2026. All rights reserved. Igor Chen - icstudio.club
    
    Author: Igor Chen
    Website: https://icstudio.club
    Email: icstudio@fastmail.com
    
    This software provides professional-grade sight-reading melody generation
    with advanced music theory features and Apple-inspired design.
-->
<html lang="zh-CN"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="icon" type="image/png" href="/tools/assets/icon/cognote.png?v=20260204">
    
    <link rel="shortcut icon" type="image/png" href="/tools/assets/icon/cognote.png?v=20260204">
<link rel="icon" type="image/svg+xml" href="/tools/assets/icon/cognote.svg?v=20260204">
    <link rel="apple-touch-icon" href="/tools/assets/icon/cognote.png?v=20260204">
<title>IC 视奏工具</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@300;400;500;600;700&family=Lexend:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- OpenSheetMusicDisplay -->
    <script src="/tools/视奏旋律生成器 - 终极版_files/opensheetmusicdisplay.min.js"></script>

    <!-- 删除SpessaSynth - 改用更简单的Web Audio API方案 -->

    <link rel="stylesheet" href="/tools/apple-ui-styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="header-text">
                    <h1 data-i18n="app.title">IC Studio - 旋律视奏生成器</h1>
                    <p data-i18n="app.subtitle">专业级乐谱渲染与音乐理论工具</p>
                </div>
                <!-- 试用信息显示 -->
                <div class="trial-info" id="trialInfo"></div>
                <div class="header-controls">
                    <div class="function-selector">
                        <button class="function-btn" id="functionBtn" onclick="toggleFunctionSelector()">
                            🎵 <span id="currentFunction" data-i18n="app.melodyMode">旋律视奏</span>
                        </button>
                        <div class="function-menu" id="functionMenu">
                            <div class="function-option" onclick="switchFunction('melody')">
                                <span class="function-icon">🎵</span>
                                <span data-i18n="app.melodyMode">旋律视奏</span>
                            </div>
                            <div class="function-option" onclick="switchFunction('interval')">
                                <span class="function-icon">🎼</span>
                                <span data-i18n="app.intervalMode">音程视奏</span>
                            </div>
                            <div class="function-option" onclick="switchFunction('chord')">
                                <span class="function-icon">🎹</span>
                                <span data-i18n="app.chordMode">和弦视奏</span>
                            </div>
                        </div>
                    </div>
                    <div class="settings-dropdown">
                        <button class="settings-btn" id="settingsBtn" onclick="toggleSettings()">
                            ⚙️ <span data-i18n="settings.title">设置</span>
                        </button>
                        <div class="settings-menu" id="settingsMenu">
                            <!-- 主题设置 -->
                            <div class="settings-section">
                                <div class="settings-section-title" data-i18n="settings.theme">主题</div>
                                <div class="theme-options">
                                    <div class="theme-option" onclick="setTheme('light')">
                                        <span class="theme-icon">☀️</span>
                                        <span data-i18n="settings.lightMode">浅色模式</span>
                                    </div>
                                    <div class="theme-option" onclick="setTheme('dark')">
                                        <span class="theme-icon">🌙</span>
                                        <span data-i18n="settings.darkMode">深色模式</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 语言设置 -->
                            <div class="settings-section">
                                <div class="settings-section-title" data-i18n="settings.language">语言</div>
                                <div class="language-options">
                                    <div class="language-option" onclick="switchLanguage('zh-CN')">
                                        🇨🇳 简体中文
                                    </div>
                                    <div class="language-option" onclick="switchLanguage('zh-TW')">
                                        🇹🇼 繁體中文
                                    </div>
                                    <div class="language-option" onclick="switchLanguage('en')">
                                        🇺🇸 English
                                    </div>
                                </div>
                            </div>


                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="control-row">
                <div class="control-group">
                    <label data-i18n="controls.interval">音程跨度</label>
                    <button class="btn-secondary" onclick="openIntervalSettings()" id="intervalSettingsBtn" data-i18n="controls.intervalSettings">
                        音程设置
                    </button>
                </div>

                <div class="control-group">
                    <label data-i18n="controls.measures">小节数</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="measures-2" name="measures" value="2">
                            <label for="measures-2" data-i18n="controls.measures2">2小节</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="measures-4" name="measures" value="4" checked="">
                            <label for="measures-4" data-i18n="controls.measures4">4小节</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="measures-8" name="measures" value="8">
                            <label for="measures-8" data-i18n="controls.measures8">8小节</label>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <label data-i18n="controls.key">调号</label>
                    <button class="btn-secondary" onclick="openKeySettings()" id="keySettingsBtn" data-i18n="controls.keySettings">
                        调号设置
                    </button>
                </div>

                <div class="control-group">
                    <label data-i18n="controls.time">拍号</label>
                    <button class="btn-secondary" onclick="openTimeSignatureSettings()" id="timeSignatureSettingsBtn" data-i18n="controls.timeSettings">
                        拍号设置
                    </button>
                </div>

                <div class="control-group">
                    <label data-i18n="controls.clef">谱号</label>
                    <button class="btn-secondary" onclick="openClefSettings()" id="clefSettingsBtn" data-i18n="controls.clefSettings">
                        谱号设置
                    </button>
                </div>
            </div>

            <!-- 新增：音域设置 -->
            <div class="control-row">
                <div class="control-group">
                    <label for="rangeMin" data-i18n="controls.rangeMin">最低音</label>
                    <select id="rangeMin">
                        <option value="33">A1</option>
                        <option value="35">B1</option>
                        <option value="36">C2</option>
                        <option value="38">D2</option>
                        <option value="40">E2</option>
                        <option value="41">F2</option>
                        <option value="43">G2</option>
                        <option value="45">A2</option>
                        <option value="47">B2</option>
                        <option value="48">C3</option>
                        <option value="50">D3</option>
                        <option value="52">E3</option>
                        <option value="53">F3</option>
                        <option value="55">G3</option>
                        <option value="57">A3</option>
                        <option value="59">B3</option>
                        <option value="60" selected="">C4</option>
                        <option value="62">D4</option>
                        <option value="64">E4</option>
                        <option value="65">F4</option>
                        <option value="67">G4</option>
                        <option value="69">A4</option>
                        <option value="71">B4</option>
                        <option value="72">C5</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="rangeMax" data-i18n="controls.rangeMax">最高音</label>
                    <select id="rangeMax">
                        <option value="48">C3</option>
                        <option value="50">D3</option>
                        <option value="52">E3</option>
                        <option value="53">F3</option>
                        <option value="55">G3</option>
                        <option value="57">A3</option>
                        <option value="59">B3</option>
                        <option value="60">C4</option>
                        <option value="62">D4</option>
                        <option value="64">E4</option>
                        <option value="65">F4</option>
                        <option value="67">G4</option>
                        <option value="69">A4</option>
                        <option value="71">B4</option>
                        <option value="72" selected="">C5</option>
                        <option value="74">D5</option>
                        <option value="76">E5</option>
                        <option value="77">F5</option>
                        <option value="79">G5</option>
                        <option value="81">A5</option>
                        <option value="82">B5</option>
                        <option value="83">C6</option>
                        <option value="84">D6</option>
                        <option value="85">E6</option>
                    </select>
                </div>

                <div class="control-group" style="flex: none; width: 140px;">
                    <label for="accidentalRate" data-i18n="controls.accidental">临时记号</label>
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <input type="range" id="accidentalRate" min="0" max="100" value="0" step="10" style="width: 90px;">
                        <span id="accidentalRateValue" style="font-weight: 400; min-width: 30px;">0%</span>
                    </div>
                </div>

                <div class="control-group metronome-group" style="flex: none; width: 160px;">
                    <label for="headerMetronomeBpm" data-i18n="controls.metronome">节拍器</label>
                    <div class="metronome-control">
                        <input type="number" id="headerMetronomeBpm" min="1" max="999" value="60" class="bpm-input-control">
                        <button class="metronome-play-btn" id="headerMetronomeBtn" onclick="toggleMetronome()" title="开始/停止节拍器">
                            🎵
                        </button>
                        <div class="metronome-beat-indicator" id="headerBeatIndicator"></div>
                    </div>
                </div>
            </div>

            <div class="control-row">
                <div class="buttons">
                    <button class="btn-primary" onclick="generateMelody()" data-i18n="controls.generate">
                        生成旋律
                    </button>
                    <span id="trialCounter" style="display: none; margin-left: 8px; background: #f0f0f0; color: #666; padding: 2px 6px; border-radius: 4px; font-size: 12px;"></span>
                    <div class="button-group">
                        <button class="btn-secondary" onclick="previousMelody()" data-i18n="controls.previous">
                            上一条
                        </button>
                        <button class="btn-secondary" onclick="nextMelody()" data-i18n="controls.next">
                            下一条
                        </button>
                    </div>
                    <div class="button-group">
                        <button class="btn-secondary" id="playMelodyBtn" onclick="directPlayTest()" data-i18n="controls.play">
                            ▶️ 播放
                        </button>
                        <button class="melody-visibility-btn" id="melodyVisibilityBtn" onclick="toggleMelodyVisibility()" title="隐藏/显示旋律">
                            👀
                        </button>
                    </div>
                    <div class="button-group">
                        <button class="btn-secondary" onclick="openRhythmSettings()" data-i18n="controls.rhythm">
                            节奏设置
                        </button>
                        <button class="btn-secondary" onclick="openArticulationSettings()" data-i18n="controls.articulation">
                            演奏技巧
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="score-container">
            <div id="score">
                <div class="empty-score-message">
                    <p data-i18n="score.empty">点击生成旋律开始练习</p>
                </div>
            </div>
        </div>
        
        <!-- Copyright Information -->
        <div style="
            padding: 5px 0;
            text-align: center;
            font-size: 14px;
            color: var(--neutral-dark);
            opacity: 0.7;
            border-top: 1px solid var(--border-color);
            margin-top: 7.5px;
        ">
            <p style="margin: 0; line-height: 1.5;">
                <strong>IC Studio 视奏工具</strong> - 专业级视奏旋律生成器
            </p>
            <p style="margin: 8px 0 0 0; font-size: 13px; opacity: 0.8;">
                Copyright © 2026. All rights reserved. Igor Chen - 
                <a href="https://icstudio.club" target="_blank" style="color: var(--primary-blue); text-decoration: none;">icstudio.club</a>
            </p>
        </div>

    </div>

    <!-- 节奏设置弹窗 -->
    <div id="rhythmModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>节奏设置</h3>
                <button class="close-btn" onclick="closeRhythmSettings()">×</button>
            </div>
            <div class="modal-body">
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4>基本节奏单位</h4>
                        <button class="btn-select-all" onclick="selectAllRhythms()" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">全选</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item" id="rhythm-whole-label">
                            <input type="checkbox" id="rhythm-whole" value="whole">
                            <span>全音符</span>
                        </label>
                        <label class="checkbox-item" id="rhythm-dotted-half-label" style="display: none;">
                            <input type="checkbox" id="rhythm-dotted-half" value="half.">
                            <span>附点二分音符</span>
                        </label>
                        <label class="checkbox-item" id="rhythm-half-label">
                            <input type="checkbox" id="rhythm-half" value="half" checked="">
                            <span>二分音符</span>
                        </label>
                        <label class="checkbox-item" id="rhythm-dotted-quarter-label" style="display: none;">
                            <input type="checkbox" id="rhythm-dotted-quarter" value="quarter.">
                            <span>附点四分音符</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="rhythm-quarter" value="quarter" checked="">
                            <span>四分音符</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="rhythm-eighth" value="eighth" checked="">
                            <span>八分音符</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="rhythm-16th" value="16th">
                            <span>十六分音符</span>
                        </label>
                        <label class="checkbox-item" id="rhythm-triplet-label" style="display: flex;">
                            <input type="checkbox" id="rhythm-triplet" value="triplet">
                            <span>三连音</span>
                        </label>
                        <label class="checkbox-item" id="rhythm-duplet-label" style="display: none;">
                            <input type="checkbox" id="rhythm-duplet" value="duplet">
                            <span>二连音</span>
                        </label>
                        <label class="checkbox-item" id="rhythm-quadruplet-label" style="display: none;">
                            <input type="checkbox" id="rhythm-quadruplet" value="quadruplet">
                            <span>四连音</span>
                        </label>
                    </div>
                </div>

                <!-- 🔥 通用附点音符选项 -->
                <div class="rhythm-section" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--info-border);">
                    <h4 style="margin-bottom: 15px;">附点音符选项</h4>
                    <div style="background: var(--info-bg); padding: 15px; border-radius: 8px;">
                        <label class="checkbox-item" style="margin-bottom: 10px;">
                            <input type="checkbox" id="allowDottedNotes" value="dotted">
                            <span>允许附点音符 (根据已选节奏自动生成附点版本)</span>
                        </label>
                        <p style="font-size: 0.85rem; color: var(--secondary-text); margin: 0; line-height: 1.4;">
                            勾选后将自动为已选择的节奏类型生成附点版本<br>
                            例如：勾选四分音符+附点音符 → 可生成四分音符和附点四分音符
                        </p>
                    </div>
                </div>

                <!-- 高级设置区域 -->
                <div id="rhythmAdvancedSettings" style="display: none; margin-top: 20px; padding: 20px; background: var(--info-bg); border-radius: 8px; border: 2px solid var(--info-border);">
                    <h4 style="margin-bottom: 15px; color: var(--heading-text);">高级频率设置</h4>
                    <p style="font-size: 0.9rem; color: var(--secondary-text); margin-bottom: 20px;">调整各节奏单位在旋律中的出现频率 (0% = 不使用, 100% = 优先使用)</p>
                    
                    <div class="rhythm-frequency-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="frequency-item" id="freq-whole-item">
                            <label for="freq-whole" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">全音符频率:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-whole" min="0" max="100" value="20" style="flex: 1;">
                                <span id="freq-whole-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">20%</span>
                            </div>
                        </div>
                        <div class="frequency-item" id="freq-dotted-half-item" style="display: none;">
                            <label for="freq-dotted-half" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">附点二分音符频率:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-dotted-half" min="0" max="100" value="12" style="flex: 1;">
                                <span id="freq-dotted-half-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">12%</span>
                            </div>
                        </div>
                        <div class="frequency-item" id="freq-half-item">
                            <label for="freq-half" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">二分音符频率:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-half" min="0" max="100" value="8" style="flex: 1;">
                                <span id="freq-half-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">8%</span>
                            </div>
                        </div>
                        <div class="frequency-item" id="freq-dotted-quarter-item" style="display: none;">
                            <label for="freq-dotted-quarter" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">附点四分音符频率:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-dotted-quarter" min="0" max="100" value="60" style="flex: 1;">
                                <span id="freq-dotted-quarter-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">60%</span>
                            </div>
                        </div>
                        <div class="frequency-item" id="freq-dotted-eighth-item" style="display: none;">
                            <label for="freq-dotted-eighth" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">附点八分音符频率:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-dotted-eighth" min="0" max="100" value="25" style="flex: 1;">
                                <span id="freq-dotted-eighth-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">25%</span>
                            </div>
                        </div>
                        <div class="frequency-item">
                            <label for="freq-quarter" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">四分音符频率:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-quarter" min="0" max="100" value="25" style="flex: 1;">
                                <span id="freq-quarter-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">25%</span>
                            </div>
                        </div>
                        <div class="frequency-item">
                            <label for="freq-eighth" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">八分音符频率:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-eighth" min="0" max="100" value="15" style="flex: 1;">
                                <span id="freq-eighth-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">15%</span>
                            </div>
                        </div>
                        <div class="frequency-item">
                            <label for="freq-16th" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">十六分音符频率:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-16th" min="0" max="100" value="6" style="flex: 1;">
                                <span id="freq-16th-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">6%</span>
                            </div>
                        </div>
                        <div class="frequency-item" id="freq-triplet-item">
                            <label for="freq-triplet" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">三连音频率:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-triplet" min="0" max="100" value="15" style="flex: 1;">
                                <span id="freq-triplet-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">15%</span>
                            </div>
                        </div>
                        <div class="frequency-item" id="freq-duplet-item" style="display: none;">
                            <label for="freq-duplet" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">二连音频率:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-duplet" min="0" max="100" value="25" style="flex: 1;">
                                <span id="freq-duplet-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">25%</span>
                            </div>
                        </div>
                        <div class="frequency-item" id="freq-quadruplet-item" style="display: none;">
                            <label for="freq-quadruplet" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">四连音频率:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-quadruplet" min="0" max="100" value="20" style="flex: 1;">
                                <span id="freq-quadruplet-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">20%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn-secondary" onclick="resetRhythmFrequencies()" style="margin-right: 10px;">返回默认</button>
                    </div>
                </div>
                
                <div class="modal-buttons">
                    <button class="btn-secondary" onclick="toggleRhythmAdvancedSettings()" id="rhythmAdvancedBtn">高级设置</button>
                    <button class="btn-primary" onclick="saveRhythmSettings()">保存设置</button>
                    <button class="btn-secondary" onclick="closeRhythmSettings()">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Articulations 弹窗 -->
    <div id="articulationModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Articulations</h3>
                <button class="close-btn" onclick="closeArticulationSettings()">×</button>
            </div>
            <div class="modal-body">
                <!-- 基本Articulation技巧 -->
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4>基本演奏法 (Basic Articulations)</h4>
                        <button class="btn-select-all" onclick="selectAllBasicArticulations()" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">全选</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item" title="断奏 - 音符时值减半，轻快地演奏">
                            <input type="checkbox" id="art-staccato" value="staccato">
                            <span>Staccato (断奏) •</span>
                        </label>
                        <label class="checkbox-item" title="重音 - 强调某些音符">
                            <input type="checkbox" id="art-accent" value="accent">
                            <span>Accent (重音) &gt;</span>
                        </label>
                        <label class="checkbox-item" title="短倚音 - 快速的装饰音">
                            <input type="checkbox" id="art-acciaccatura" value="acciaccatura">
                            <span>Acciaccatura (短倚音)</span>
                        </label>
                    </div>
                </div>


                <!-- 吉他特有技巧 -->
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4>吉他技巧 (Guitar Techniques)</h4>
                        <button class="btn-select-all" onclick="selectAllGuitarTechniques()" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">全选</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item" title="击弦 - 用左手敲击产生音符">
                            <input type="checkbox" id="gtr-hammer" value="hammer-on">
                            <span>Hammer-on (击弦) H</span>
                        </label>
                        <label class="checkbox-item" title="勾弦 - 用左手勾离产生音符">
                            <input type="checkbox" id="gtr-pull" value="pull-off">
                            <span>Pull-off (勾弦) P</span>
                        </label>
                        <!-- 暂时隐藏glissando相关选项，因为OSMD不支持渲染 -->
                        <label class="checkbox-item" title="滑音 - 在品格间滑动（注：OSMD暂不支持渲染）" style="display: none;">
                            <input type="checkbox" id="gtr-glissando" value="glissando">
                            <span>Glissando (滑音) /</span>
                        </label>
                        <label class="checkbox-item" title="滑入 - 从下方滑入主音（注：OSMD暂不支持渲染）" style="display: none;">
                            <input type="checkbox" id="gtr-slide-in" value="slide-in">
                            <span>Slide In (滑入)</span>
                        </label>
                        <label class="checkbox-item" title="滑出 - 从主音滑出（注：OSMD暂不支持渲染）" style="display: none;">
                            <input type="checkbox" id="gtr-slide-out" value="slide-out">
                            <span>Slide Out (滑出)</span>
                        </label>
                    </div>
                </div>

                <!-- 暂时隐藏glissando相关说明 -->
                <div style="padding: 10px 20px; color: #666; font-size: 12px; border-top: 1px solid #eee; margin-top: 10px; display: none;">
                    <small>* 注：标有星号的技巧（Glissando、Slide In/Out）由于OSMD渲染引擎限制，暂时会显示为文本提示。</small>
                </div>

                <!-- 高级设置区域 -->
                <div id="articulationAdvancedSettings" style="display: none; margin-top: 20px; padding: 20px; background: var(--info-bg); border-radius: 8px; border: 2px solid var(--info-border);">
                    <h4 style="margin-bottom: 15px; color: var(--heading-text);">高级频率设置</h4>
                    <p style="font-size: 0.9rem; color: var(--secondary-text); margin-bottom: 20px;">调整各演奏法在旋律中的出现频率 (0% = 不使用, 100% = 经常使用)</p>
                    
                    <div style="margin-bottom: 20px;">
                        <h5 style="color: #495057; margin-bottom: 10px;">基本演奏法频率</h5>
                        <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
                            <div class="frequency-item">
                                <label for="freq-staccato" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">Staccato (断奏) 频率:</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="range" id="freq-staccato" min="0" max="100" value="20" style="flex: 1;">
                                    <span id="freq-staccato-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">20%</span>
                                </div>
                            </div>
                            <div class="frequency-item">
                                <label for="freq-accent" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">Accent (重音) 频率:</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="range" id="freq-accent" min="0" max="100" value="15" style="flex: 1;">
                                    <span id="freq-accent-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">15%</span>
                                </div>
                            </div>
                            <div class="frequency-item">
                                <label for="freq-acciaccatura" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">Acciaccatura (短倚音) 频率:</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="range" id="freq-acciaccatura" min="0" max="100" value="10" style="flex: 1;">
                                    <span id="freq-acciaccatura-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">10%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h5 style="color: #495057; margin-bottom: 10px;">吉他技巧频率</h5>
                        <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
                            <div class="frequency-item">
                                <label for="freq-slur" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">击勾弦频率:</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="range" id="freq-slur" min="0" max="100" value="15" style="flex: 1;">
                                    <span id="freq-slur-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">15%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn-secondary" onclick="resetArticulationFrequencies()" style="margin-right: 10px;">返回默认</button>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-secondary" onclick="toggleArticulationAdvancedSettings()" id="articulationAdvancedBtn">高级设置</button>
                    <button class="btn-primary" onclick="saveArticulationSettings()">保存设置</button>
                    <button class="btn-secondary" onclick="closeArticulationSettings()">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 调号设置弹窗 -->
    <div id="keySignatureModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>调号设置</h3>
                <button class="close-btn" onclick="closeKeySettings()">×</button>
            </div>
            <div class="modal-body">
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4>大调 (Major)</h4>
                        <button class="btn-select-all" onclick="selectAllMajorKeys()" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">全选大调</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-C" value="C" checked>
                            <span>C 大调</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-G" value="G">
                            <span>G 大调 (1#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-D" value="D">
                            <span>D 大调 (2#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-A" value="A">
                            <span>A 大调 (3#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-E" value="E">
                            <span>E 大调 (4#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-B" value="B">
                            <span>B 大调 (5#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-F#" value="F#">
                            <span>F# 大调 (6#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-F" value="F">
                            <span>F 大调 (1b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Bb" value="Bb">
                            <span>Bb 大调 (2b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Eb" value="Eb">
                            <span>Eb 大调 (3b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Ab" value="Ab">
                            <span>Ab 大调 (4b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Db" value="Db">
                            <span>Db 大调 (5b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Gb" value="Gb">
                            <span>Gb 大调 (6b)</span>
                        </label>
                    </div>
                </div>

                <div class="rhythm-section" style="margin-top: 30px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4>小调 (Minor)</h4>
                        <button class="btn-select-all" onclick="selectAllMinorKeys()" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">全选小调</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Am" value="Am">
                            <span>A 小调</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Em" value="Em">
                            <span>E 小调 (1#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Bm" value="Bm">
                            <span>B 小调 (2#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-F#m" value="F#m">
                            <span>F# 小调 (3#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-C#m" value="C#m">
                            <span>C# 小调 (4#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-G#m" value="G#m">
                            <span>G# 小调 (5#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-D#m" value="D#m">
                            <span>D# 小调 (6#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Dm" value="Dm">
                            <span>D 小调 (1b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Gm" value="Gm">
                            <span>G 小调 (2b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Cm" value="Cm">
                            <span>C 小调 (3b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Fm" value="Fm">
                            <span>F 小调 (4b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Bbm" value="Bbm">
                            <span>Bb 小调 (5b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Ebm" value="Ebm">
                            <span>Eb 小调 (6b)</span>
                        </label>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveKeySettings()">保存设置</button>
                    <button class="btn-secondary" onclick="closeKeySettings()">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 拍号设置弹窗 -->
    <div id="timeSignatureModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>拍号设置</h3>
                <button class="close-btn" onclick="closeTimeSignatureSettings()">×</button>
            </div>
            <div class="modal-body">
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4>拍号选项</h4>
                        <button class="btn-select-all" onclick="selectAllTimeSignatures()" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">全选</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="time-2/4" value="2/4">
                            <span>2/4 拍</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="time-3/4" value="3/4">
                            <span>3/4 拍</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="time-4/4" value="4/4" checked>
                            <span>4/4 拍</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="time-6/8" value="6/8">
                            <span>6/8 拍</span>
                        </label>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveTimeSignatureSettings()">保存设置</button>
                    <button class="btn-secondary" onclick="closeTimeSignatureSettings()">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 音程跨度设置弹窗 -->
    <div id="intervalModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>音程跨度设置</h3>
                <button class="close-btn" onclick="closeIntervalSettings()">×</button>
            </div>
            <div class="modal-body">
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4>最大音程跨度选项</h4>
                        <small style="color: #666; font-size: 12px;">只能选择一个音程作为最大跨度</small>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-1" value="1" onchange="handleIntervalCheckboxChange(this)">
                            <span>小二度</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-2" value="2" onchange="handleIntervalCheckboxChange(this)">
                            <span>大二度</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-3" value="3" onchange="handleIntervalCheckboxChange(this)">
                            <span>小三度</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-4" value="4" onchange="handleIntervalCheckboxChange(this)">
                            <span>大三度</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-5" value="5" onchange="handleIntervalCheckboxChange(this)">
                            <span>完全四度</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-6" value="6" onchange="handleIntervalCheckboxChange(this)">
                            <span>增四度/减五度</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-7" value="7" onchange="handleIntervalCheckboxChange(this)">
                            <span>完全五度</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-8" value="8" onchange="handleIntervalCheckboxChange(this)">
                            <span>小六度</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-9" value="9" onchange="handleIntervalCheckboxChange(this)">
                            <span>大六度</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-10" value="10" onchange="handleIntervalCheckboxChange(this)">
                            <span>小七度</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-11" value="11" onchange="handleIntervalCheckboxChange(this)">
                            <span>大七度</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-12" value="12" checked onchange="handleIntervalCheckboxChange(this)">
                            <span>完全八度</span>
                        </label>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveIntervalSettings()">保存设置</button>
                    <button class="btn-secondary" onclick="closeIntervalSettings()">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 谱号设置弹窗 -->
    <div id="clefModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>谱号设置</h3>
                <button class="close-btn" onclick="closeClefSettings()">×</button>
            </div>
            <div class="modal-body">
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4>谱号选项</h4>
                        <button class="btn-select-all" onclick="selectAllClefs()" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">全选</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="clef-treble" value="treble" checked>
                            <span>高音谱号 (G谱号)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="clef-bass" value="bass">
                            <span>低音谱号 (F谱号)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="clef-alto" value="alto">
                            <span>中音谱号 (C谱号)</span>
                        </label>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveClefSettings()">保存设置</button>
                    <button class="btn-secondary" onclick="closeClefSettings()">取消</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/tools/视奏旋律生成器 - 终极版_files/minor-scale-spelling.js"></script>
    <script src="/tools/视奏旋律生成器 - 终极版_files/sight-reading-final.js"></script>
    <script src="/tools/视奏旋律生成器 - 终极版_files/minor-alterations.js"></script>
    <script src="/tools/视奏旋律生成器 - 终极版_files/emergency-fix.js"></script>

    <!-- 增强的全选切换功能 -->
    <!-- <script src="enhanced-select-all.js"></script> -->
    
    <!-- 主题切换系统 -->
    <script>
        // 主题切换相关变量和功能
        let currentTheme = localStorage.getItem('preferredTheme') || 'light';
        
        // 主题图标
        const themeIcons = {
            'light': '🌙', // 在light模式显示月亮图标，点击切换到dark
            'dark': '☀️'   // 在dark模式显示太阳图标，点击切换到light
        };
        
        // 切换主题 (保留向后兼容性)
        function toggleTheme() {
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            setTheme(newTheme);
        }
        
        // 设置主题 (新版本，用于设置菜单)
        function setTheme(theme) {
            currentTheme = theme;
            localStorage.setItem('preferredTheme', theme);
            
            // 设置HTML的data-theme属性
            document.documentElement.setAttribute('data-theme', theme);
            
            // 关闭设置菜单
            closeSettings();
            
            console.log(`🎨 主题已设置为: ${theme}`);
        }
        
        // 应用主题 (保留向后兼容性)
        function switchTheme(theme) {
            currentTheme = theme;
            localStorage.setItem('preferredTheme', theme);
            
            // 设置HTML的data-theme属性
            document.documentElement.setAttribute('data-theme', theme);
            
            // 更新按钮图标 (如果存在旧的主题切换器)
            const themeSwitcher = document.getElementById('themeSwitcher');
            if (themeSwitcher) {
                themeSwitcher.textContent = themeIcons[theme];
            }
            
            console.log(`🎨 主题已切换到: ${theme}`);
        }
        
        // 设置菜单控制
        function toggleSettings() {
            const settingsMenu = document.getElementById('settingsMenu');
            const isVisible = settingsMenu.classList.contains('show');
            
            if (isVisible) {
                closeSettings();
            } else {
                openSettings();
            }
        }
        
        function openSettings() {
            const settingsMenu = document.getElementById('settingsMenu');
            settingsMenu.classList.add('show');
            
            // 添加点击外部区域关闭菜单的监听器
            setTimeout(() => {
                document.addEventListener('click', handleClickOutside);
            }, 10);
        }
        
        function closeSettings() {
            const settingsMenu = document.getElementById('settingsMenu');
            settingsMenu.classList.remove('show');
            
            // 移除点击外部区域的监听器
            document.removeEventListener('click', handleClickOutside);
        }
        
        // 功能选择器控制
        function toggleFunctionSelector() {
            const functionMenu = document.getElementById('functionMenu');
            const isVisible = functionMenu.classList.contains('show');
            
            if (isVisible) {
                closeFunctionSelector();
            } else {
                openFunctionSelector();
            }
        }
        
        function openFunctionSelector() {
            const functionMenu = document.getElementById('functionMenu');
            functionMenu.classList.add('show');
            
            // 添加点击外部区域关闭菜单的监听器
            setTimeout(() => {
                document.addEventListener('click', handleFunctionClickOutside);
            }, 10);
        }
        
        function closeFunctionSelector() {
            const functionMenu = document.getElementById('functionMenu');
            functionMenu.classList.remove('show');
            
            // 移除点击外部区域的监听器
            document.removeEventListener('click', handleFunctionClickOutside);
        }
        
        // 处理点击外部区域关闭功能菜单
        function handleFunctionClickOutside(event) {
            const functionSelector = document.querySelector('.function-selector');
            
            if (functionSelector && !functionSelector.contains(event.target)) {
                closeFunctionSelector();
            }
        }
        
        // 当前功能模式
        let currentFunctionMode = 'melody';
        
        // 切换功能
        function switchFunction(mode) {
            if (mode === 'melody') {
                // 已经在旋律视奏页面
                closeFunctionSelector();
                console.log('已在旋律视奏模式');
            } else if (mode === 'interval') {
                // 显示音程视奏开发中弹窗
                showDevelopmentModal('音程视奏');
                closeFunctionSelector();
            } else if (mode === 'chord') {
                // 显示和弦视奏开发中弹窗
                showDevelopmentModal('和弦视奏');
                closeFunctionSelector();
            }
        }

        // 显示开发中弹窗
        function showDevelopmentModal(featureName) {
            // 创建弹窗
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(10px);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                opacity: 0;
                transition: opacity 0.3s ease;
            `;

            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: #ffffff;
                border-radius: 16px;
                padding: 40px;
                max-width: 400px;
                text-align: center;
                box-shadow: 0 20px 64px rgba(0, 0, 0, 0.15);
                border: 1px solid #d2d2d7;
                position: relative;
            `;

            modalContent.innerHTML = `
                <div style="font-size: 48px; margin-bottom: 20px;">🚧</div>
                <h3 style="font-size: 1.5rem; color: #1d1d1f; margin-bottom: 16px; font-weight: 600;">${featureName}功能开发中</h3>
                <p style="color: #86868b; font-size: 1rem; line-height: 1.5; margin-bottom: 30px;">
                    该功能正在开发中，敬请期待！<br>
                    目前仅提供旋律视奏功能。
                </p>
                <button onclick="closeDevelopmentModal()" style="
                    background: #007aff;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    padding: 12px 24px;
                    font-size: 16px;
                    font-weight: 500;
                    cursor: pointer;
                    transition: background 0.2s ease;
                " onmouseover="this.style.background='#005FCC'" onmouseout="this.style.background='#007aff'">
                    了解
                </button>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            modal.id = 'developmentModal';

            // 显示动画
            setTimeout(() => {
                modal.style.opacity = '1';
            }, 10);
        }

        // 关闭开发中弹窗
        function closeDevelopmentModal() {
            const modal = document.getElementById('developmentModal');
            if (modal) {
                modal.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(modal);
                }, 300);
            }
        }
        
        // 处理点击外部区域关闭设置菜单
        function handleClickOutside(event) {
            const settingsDropdown = document.querySelector('.settings-dropdown');
            
            if (settingsDropdown && !settingsDropdown.contains(event.target)) {
                closeSettings();
            }
        }

        // 节拍器相关变量和功能
        let metronomeInterval = null;
        let metronomeAudioContext = null;
        let metronomeOscillator = null;
        let isMetronomeRunning = false;
        let metronomeTempo = 60; // 默认60 BPM

        // 初始化Web Audio API
        function initializeMetronomeAudio() {
            try {
                metronomeAudioContext = new (window.AudioContext || window.webkitAudioContext)();
                console.log('🎵 节拍器音频初始化成功');
                return true;
            } catch (error) {
                console.error('❌ Web Audio API 不支持:', error);
                return false;
            }
        }

        // 播放节拍器声音
        function playMetronomeSound() {
            if (!metronomeAudioContext) {
                if (!initializeMetronomeAudio()) return;
            }

            try {
                // 恢复音频上下文（用户交互后）
                if (metronomeAudioContext.state === 'suspended') {
                    metronomeAudioContext.resume();
                }

                const oscillator = metronomeAudioContext.createOscillator();
                const gainNode = metronomeAudioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(metronomeAudioContext.destination);

                // 使用方波和自然音高 (参考NiceChord节拍器)
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(523.25, metronomeAudioContext.currentTime); // C5音高

                // 设置自然的音量包络 (更好的release time)
                gainNode.gain.setValueAtTime(0.25, metronomeAudioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, metronomeAudioContext.currentTime + 0.05);

                oscillator.start(metronomeAudioContext.currentTime);
                oscillator.stop(metronomeAudioContext.currentTime + 0.05);

                // 视觉反馈 - 更新header指示器
                const headerIndicator = document.getElementById('headerBeatIndicator');
                
                if (headerIndicator) {
                    headerIndicator.classList.add('beat');
                    setTimeout(() => {
                        headerIndicator.classList.remove('beat');
                    }, 150);
                }
                
            } catch (error) {
                console.error('❌ 节拍器声音播放失败:', error);
            }
        }

        // 设置节拍器速度
        function setMetronomeTempo(bpm) {
            metronomeTempo = Math.max(1, Math.min(999, bpm));
            
            // 同步更新header输入框
            const headerInput = document.getElementById('headerMetronomeBpm');
            if (headerInput) headerInput.value = metronomeTempo;
            
            // 如果节拍器正在运行，重新启动以应用新速度
            if (isMetronomeRunning) {
                stopMetronome();
                startMetronome();
            }
            
            console.log(`🎵 节拍器速度设置为: ${metronomeTempo} BPM`);
        }

        // 启动节拍器
        function startMetronome() {
            const headerInput = document.getElementById('headerMetronomeBpm');
            const tempo = parseInt(headerInput ? headerInput.value : metronomeTempo) || 60;
            setMetronomeTempo(tempo);
            
            if (isMetronomeRunning) return;
            
            const interval = 60000 / metronomeTempo; // 计算间隔时间（毫秒）
            
            isMetronomeRunning = true;
            
            // 立即播放第一拍
            playMetronomeSound();
            
            // 设置定时器
            metronomeInterval = setInterval(() => {
                playMetronomeSound();
            }, interval);
            
            // 更新UI
            updateMetronomeUI();
            
            console.log(`🎵 节拍器已启动: ${metronomeTempo} BPM`);
        }

        // 停止节拍器
        function stopMetronome() {
            if (metronomeInterval) {
                clearInterval(metronomeInterval);
                metronomeInterval = null;
            }
            
            isMetronomeRunning = false;
            updateMetronomeUI();
            
            console.log('🎵 节拍器已停止');
        }

        // 切换节拍器开关
        function toggleMetronome() {
            if (isMetronomeRunning) {
                stopMetronome();
            } else {
                startMetronome();
            }
        }

        // 更新节拍器UI
        function updateMetronomeUI() {
            const headerToggleBtn = document.getElementById('headerMetronomeBtn');
            
            // 更新header中的按钮
            if (headerToggleBtn) {
                if (isMetronomeRunning) {
                    headerToggleBtn.classList.add('active');
                    headerToggleBtn.textContent = '⏸️';
                    headerToggleBtn.title = '停止节拍器';
                } else {
                    headerToggleBtn.classList.remove('active');
                    headerToggleBtn.textContent = '🎵';
                    headerToggleBtn.title = '开始节拍器';
                }
            }
        }

        // 监听header中BPM输入框的变化
        document.addEventListener('DOMContentLoaded', function() {
            const headerSpeedInput = document.getElementById('headerMetronomeBpm');
            
            if (headerSpeedInput) {
                // 实时输入验证
                headerSpeedInput.addEventListener('input', function() {
                    let value = parseInt(this.value);
                    
                    // 限制范围
                    if (value < 1) {
                        this.value = 1;
                        value = 1;
                    } else if (value > 999) {
                        this.value = 999;
                        value = 999;
                    }
                    
                    if (!isNaN(value)) {
                        setMetronomeTempo(value);
                    }
                });
                
                // Enter键确认
                headerSpeedInput.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        this.blur(); // 失去焦点，触发验证
                    }
                });
                
                // 失去焦点时验证
                headerSpeedInput.addEventListener('blur', function() {
                    let value = parseInt(this.value);
                    
                    if (isNaN(value) || value < 1) {
                        this.value = 1;
                        value = 1;
                    } else if (value > 999) {
                        this.value = 999;
                        value = 999;
                    }
                    
                    setMetronomeTempo(value);
                });

                // BPM拖动功能实现
                let isDragging = false;
                let startY = 0;
                let startValue = 0;
                let dragTimeout = null;
                let hasStartedDrag = false;
                
                // 鼠标按下事件
                headerSpeedInput.addEventListener('mousedown', function(event) {
                    // 只处理左键点击
                    if (event.button !== 0) return;
                    
                    startY = event.clientY;
                    startValue = parseInt(this.value) || 60;
                    hasStartedDrag = false;
                    
                    console.log('BPM拖动: 鼠标按下', startValue);
                    
                    // 长按80ms后启动拖动模式
                    dragTimeout = setTimeout(() => {
                        isDragging = true;
                        hasStartedDrag = true;
                        
                        console.log('BPM拖动: 启动拖动模式');
                        
                        // 防止文本选择和默认行为
                        event.preventDefault();
                        document.body.style.userSelect = 'none';
                        document.body.style.webkitUserSelect = 'none';
                        document.body.style.mozUserSelect = 'none';
                        document.body.style.msUserSelect = 'none';
                        
                        // 添加拖动中的视觉反馈
                        this.style.cursor = 'ns-resize';
                        this.classList.add('dragging');
                        this.blur(); // 失去焦点，避免键盘输入干扰
                    }, 80);
                });
                
                // 鼠标移动事件 - 绑定到全局
                const handleMouseMove = function(event) {
                    if (!isDragging || !hasStartedDrag) return;
                    
                    const deltaY = startY - event.clientY; // 向上为正，向下为负
                    const sensitivity = 1; // 拖动灵敏度，每1像素改变1个BPM
                    const newValue = Math.max(1, Math.min(999, startValue + Math.round(deltaY / sensitivity)));
                    
                    console.log('BPM拖动: 移动中', deltaY, newValue);
                    
                    headerSpeedInput.value = newValue;
                    setMetronomeTempo(newValue);
                    
                    // 阻止默认行为
                    event.preventDefault();
                    event.stopPropagation();
                };
                
                // 鼠标释放事件 - 绑定到全局
                const handleMouseUp = function(event) {
                    console.log('BPM拖动: 鼠标释放', isDragging);
                    
                    // 清除长按计时器
                    if (dragTimeout) {
                        clearTimeout(dragTimeout);
                        dragTimeout = null;
                    }
                    
                    if (isDragging && hasStartedDrag) {
                        isDragging = false;
                        hasStartedDrag = false;
                        
                        // 恢复文本选择
                        document.body.style.userSelect = '';
                        document.body.style.webkitUserSelect = '';
                        document.body.style.mozUserSelect = '';
                        document.body.style.msUserSelect = '';
                        
                        // 移除视觉反馈
                        headerSpeedInput.style.cursor = '';
                        headerSpeedInput.classList.remove('dragging');
                        
                        console.log('BPM拖动: 结束拖动模式');
                    }
                };
                
                // 绑定全局事件
                document.addEventListener('mousemove', handleMouseMove, true);
                document.addEventListener('mouseup', handleMouseUp, true);
                
                // 鼠标离开输入框时取消长按
                headerSpeedInput.addEventListener('mouseleave', function(event) {
                    if (dragTimeout && !isDragging) {
                        clearTimeout(dragTimeout);
                        dragTimeout = null;
                        console.log('BPM拖动: 鼠标离开，取消长按');
                    }
                });
                
                // 防止右键菜单干扰
                headerSpeedInput.addEventListener('contextmenu', function(event) {
                    if (isDragging) {
                        event.preventDefault();
                    }
                });
            }
        });
        
        // 初始化主题
        function initializeTheme() {
            switchTheme(currentTheme);
        }
        
        // 页面加载时初始化主题
        document.addEventListener('DOMContentLoaded', function() {
            initializeTheme();
        });
    </script>

    <!-- 多语言系统 -->
    <script>
        // 多语言翻译对象
        const translations = {
            'zh-CN': {
                'app.title': 'IC Studio - 视奏旋律生成器',
                'app.subtitle': '专业级乐谱渲染与音乐理论工具',
                'app.melodyMode': '旋律视奏',
                'app.intervalMode': '音程视奏',
                'app.chordMode': '和弦视奏',
                'controls.interval': '音程跨度',
                'controls.intervalSettings': '音程设置',
                'controls.measures': '小节数',
                'controls.measures2': '2小节',
                'controls.measures4': '4小节',
                'controls.measures8': '8小节',
                'controls.key': '调号',
                'controls.keySettings': '调号设置',
                'controls.time': '拍号',
                'controls.timeSettings': '拍号设置',
                'controls.clef': '谱号',
                'controls.clefSettings': '谱号设置',
                'controls.rangeMin': '最低音',
                'controls.rangeMax': '最高音',
                'controls.accidental': '临时记号',
                'controls.metronome': '节拍器',
                'controls.generate': '生成旋律',
                'controls.previous': '上一条',
                'controls.next': '下一条',
                'controls.play': '播放',
                'controls.stop': '停止',
                'controls.tempo': '速度',
                'controls.playbackNote': '播放速度跟随节拍器设置',
                'controls.rhythm': '节奏设置',
                'controls.articulation': '演奏技巧',
                'score.empty': '点击生成旋律开始练习',
                'settings.title': '设置',
                'settings.theme': '主题',
                'settings.language': '语言',
                'settings.lightMode': '浅色模式',
                'settings.darkMode': '深色模式',
                'settings.metronome': '节拍器',
                'settings.tempo': '速度 (BPM)',
                'settings.startMetronome': '开始节拍器',
                'settings.stopMetronome': '停止节拍器'
            },
            'zh-TW': {
                'app.title': 'IC Studio - 視奏旋律生成器',
                'app.subtitle': '專業級樂譜渲染與音樂理論工具',
                'app.melodyMode': '旋律視奏',
                'app.intervalMode': '音程視奏',
                'app.chordMode': '和弦視奏',
                'controls.interval': '音程跨度',
                'controls.intervalSettings': '音程設置',
                'controls.measures': '小節數',
                'controls.measures2': '2小節',
                'controls.measures4': '4小節',
                'controls.measures8': '8小節',
                'controls.key': '調號',
                'controls.keySettings': '調號設置',
                'controls.time': '拍號',
                'controls.timeSettings': '拍號設置',
                'controls.clef': '譜號',
                'controls.clefSettings': '譜號設置',
                'controls.rangeMin': '最低音',
                'controls.rangeMax': '最高音',
                'controls.accidental': '臨時記號',
                'controls.metronome': '節拍器',
                'controls.generate': '生成旋律',
                'controls.previous': '上一條',
                'controls.next': '下一條',
                'controls.play': '播放',
                'controls.stop': '停止',
                'controls.tempo': '速度',
                'controls.playbackNote': '播放速度跟隨節拍器設置',
                'controls.rhythm': '節奏設置',
                'controls.articulation': '演奏技巧',
                'score.empty': '點擊生成旋律開始練習',
                'settings.title': '設置',
                'settings.theme': '主題',
                'settings.language': '語言',
                'settings.lightMode': '淺色模式',
                'settings.darkMode': '深色模式',
                'settings.metronome': '節拍器',
                'settings.tempo': '速度 (BPM)',
                'settings.startMetronome': '開始節拍器',
                'settings.stopMetronome': '停止節拍器'
            },
            'en': {
                'app.title': 'IC Studio - Sight-Reading Generator',
                'app.subtitle': 'Professional Music Score Rendering & Music Theory Tool',
                'app.melodyMode': 'Melody Sight-Reading',
                'app.intervalMode': 'Interval Sight-Reading',
                'app.chordMode': 'Chord Sight-Reading',
                'controls.interval': 'Interval Range',
                'controls.intervalSettings': 'Interval Settings',
                'controls.measures': 'Measures',
                'controls.measures2': '2 Measures',
                'controls.measures4': '4 Measures',
                'controls.measures8': '8 Measures',
                'controls.key': 'Key Signature',
                'controls.keySettings': 'Key Settings',
                'controls.time': 'Time Signature',
                'controls.timeSettings': 'Time Settings',
                'controls.clef': 'Clef',
                'controls.clefSettings': 'Clef Settings',
                'controls.rangeMin': 'Lowest Note',
                'controls.rangeMax': 'Highest Note',
                'controls.accidental': 'Accidentals',
                'controls.metronome': 'Metronome',
                'controls.generate': 'Generate Melody',
                'controls.previous': 'Previous',
                'controls.next': 'Next',
                'controls.play': 'Play',
                'controls.stop': 'Stop',
                'controls.tempo': 'Tempo',
                'controls.playbackNote': 'Playback follows metronome tempo',
                'controls.rhythm': 'Rhythm Settings',
                'controls.articulation': 'Articulations',
                'score.empty': 'Click Generate Melody to Start Practice',
                'settings.title': 'Settings',
                'settings.theme': 'Theme',
                'settings.language': 'Language',
                'settings.lightMode': 'Light Mode',
                'settings.darkMode': 'Dark Mode',
                'settings.metronome': 'Metronome',
                'settings.tempo': 'Tempo (BPM)',
                'settings.startMetronome': 'Start Metronome',
                'settings.stopMetronome': 'Stop Metronome'
            }
        };

        // 语言切换相关变量
        let currentLanguage = localStorage.getItem('preferredLanguage') || 'zh-CN';
        
        // 语言按钮显示文本
        const languageLabels = {
            'zh-CN': '🌐 简体中文',
            'zh-TW': '🌐 繁體中文',
            'en': '🌐 English'
        };


        // 切换语言
        function switchLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('preferredLanguage', lang);
            
            // 更新按钮文本 (如果存在旧的语言按钮)
            const languageBtn = document.getElementById('languageBtn');
            if (languageBtn) {
                languageBtn.textContent = languageLabels[lang];
            }
            
            // 应用翻译
            applyTranslations();
            
            // 关闭设置菜单
            closeSettings();
            
            console.log(`🌐 语言已切换到: ${lang}`);
        }

        // 应用翻译
        function applyTranslations() {
            const elements = document.querySelectorAll('[data-i18n]');
            const currentTranslations = translations[currentLanguage] || translations['zh-CN'];
            
            elements.forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (currentTranslations[key]) {
                    element.textContent = currentTranslations[key];
                }
            });
        }

        // 页面加载时初始化语言
        document.addEventListener('DOMContentLoaded', function() {
            // 检查是否有保存的语言偏好
            const savedLanguage = localStorage.getItem('preferredLanguage');
            
            if (savedLanguage) {
                // 如果有保存的语言偏好，设置当前语言并显示对应语言名称
                currentLanguage = savedLanguage;
                document.getElementById('languageBtn').textContent = languageLabels[currentLanguage];
            } else {
                // 如果没有保存的语言偏好，显示默认的 🌐 文/A
                document.getElementById('languageBtn').textContent = '🌐 文/A';
            }
            
            // 应用翻译
            applyTranslations();
            
            console.log(`🌐 初始化语言: ${currentLanguage}`);
        });
    </script>

    <script>
        // 重写模态框关闭函数以重置全选状态
        const originalCloseRhythmSettings = window.closeRhythmSettings;
        const originalCloseArticulationSettings = window.closeArticulationSettings;
        const originalCloseKeySettings = window.closeKeySettings;
        const originalCloseTimeSignatureSettings = window.closeTimeSignatureSettings;
        const originalCloseIntervalSettings = window.closeIntervalSettings;
        const originalCloseClefSettings = window.closeClefSettings;

        if (typeof originalCloseRhythmSettings === 'function') {
            window.closeRhythmSettings = function() {
                originalCloseRhythmSettings();
                if (typeof resetSelectAllStates === 'function') resetSelectAllStates();
            };
        }

        if (typeof originalCloseArticulationSettings === 'function') {
            window.closeArticulationSettings = function() {
                originalCloseArticulationSettings();
                if (typeof resetSelectAllStates === 'function') resetSelectAllStates();
            };
        }

        if (typeof originalCloseKeySettings === 'function') {
            window.closeKeySettings = function() {
                originalCloseKeySettings();
                if (typeof resetSelectAllStates === 'function') resetSelectAllStates();
            };
        }

        if (typeof originalCloseTimeSignatureSettings === 'function') {
            window.closeTimeSignatureSettings = function() {
                originalCloseTimeSignatureSettings();
                if (typeof resetSelectAllStates === 'function') resetSelectAllStates();
            };
        }

        if (typeof originalCloseIntervalSettings === 'function') {
            window.closeIntervalSettings = function() {
                originalCloseIntervalSettings();
                if (typeof resetSelectAllStates === 'function') resetSelectAllStates();
            };
        }

        if (typeof originalCloseClefSettings === 'function') {
            window.closeClefSettings = function() {
                originalCloseClefSettings();
                if (typeof resetSelectAllStates === 'function') resetSelectAllStates();
            };
        }

        // 动态隐藏包含特定文本的SVG元素
        function hideTitleAndInstrumentElements() {
            // 等待一会儿让OSMD渲染完成
            setTimeout(() => {
                const scoreDiv = document.getElementById('score');
                if (scoreDiv) {
                    // 查找所有SVG text元素
                    const textElements = scoreDiv.querySelectorAll('svg text');
                    textElements.forEach(element => {
                        const text = element.textContent || element.innerText;
                        if (text && (
                            text.includes('Piano') || 
                            text.includes('Untitled') || 
                            text.includes('Untitled Score') ||
                            text.trim() === 'Piano' ||
                            text.trim() === 'Untitled Score'
                        )) {
                            element.style.display = 'none';
                            element.style.visibility = 'hidden';
                            console.log('隐藏文本元素:', text);
                        }
                    });
                    
                    // 也检查其他可能的元素
                    const allElements = scoreDiv.querySelectorAll('*');
                    allElements.forEach(element => {
                        const text = element.textContent || element.innerText;
                        if (text && element.tagName !== 'SCRIPT' && (
                            text.trim() === 'Piano' ||
                            text.trim() === 'Untitled Score'
                        )) {
                            element.style.display = 'none';
                            element.style.visibility = 'hidden';
                            console.log('隐藏元素:', element.tagName, text);
                        }
                    });

                    // 🔧 修复：移除多余的断奏点（staccato dots）
                    removeExtraStaccatoDots();
                }
            }, 500);
        }

        // 🔧 修复MusicXML中的多余附点
        function cleanupExcessiveDots(musicXML) {
            console.log('🔧 开始清理MusicXML中的多余附点...');

            // 方法1：完全移除所有 <dot/> 元素
            let cleanedXML = musicXML.replace(/<dot\s*\/?>|<dot><\/dot>/g, '');

            // 方法2：如果需要保留合理的附点，可以使用更精确的清理
            // 这里我们先简单地移除所有附点，因为生成的音符应该都是基础时值

            console.log('🔧 已移除所有 <dot> 元素');

            return cleanedXML;
        }

        // 🔧 修复附点问题：移除多余的断奏点
        function removeExtraStaccatoDots() {
            const scoreDiv = document.getElementById('score');
            if (!scoreDiv) return;

            // 查找所有可能的断奏点元素
            const svgElements = scoreDiv.querySelectorAll('svg circle, svg ellipse, svg use, svg path');

            let removedCount = 0;

            svgElements.forEach((element, index) => {
                // 检查是否是小圆点（断奏记号）
                if (element.tagName === 'circle') {
                    const radius = parseFloat(element.getAttribute('r')) || 0;
                    const cx = parseFloat(element.getAttribute('cx')) || 0;
                    const cy = parseFloat(element.getAttribute('cy')) || 0;

                    // 如果是小圆点（半径小于3），很可能是断奏记号
                    if (radius > 0 && radius < 3) {
                        // 隐藏这个元素
                        element.style.display = 'none';
                        element.style.visibility = 'hidden';
                        removedCount++;
                    }
                }

                // 检查use元素（可能是符号引用）
                if (element.tagName === 'use') {
                    const href = element.getAttribute('href') || element.getAttribute('xlink:href') || '';
                    if (href.includes('staccato') || href.includes('dot') || href.includes('articulation')) {
                        element.style.display = 'none';
                        element.style.visibility = 'hidden';
                        removedCount++;
                    }
                }

                // 检查path元素中可能的断奏点
                if (element.tagName === 'path') {
                    const d = element.getAttribute('d') || '';
                    // 如果路径很短且包含圆弧，可能是断奏点
                    if (d.length < 50 && (d.includes('C') || d.includes('A'))) {
                        const bbox = element.getBBox ? element.getBBox() : { width: 0, height: 0 };
                        if (bbox.width < 10 && bbox.height < 10) {
                            element.style.display = 'none';
                            element.style.visibility = 'hidden';
                            removedCount++;
                        }
                    }
                }
            });
        }
        
        // 清除空谱子提示信息
        function clearEmptyScoreMessage() {
            const scoreDiv = document.getElementById('score');
            if (scoreDiv) {
                const emptyMessage = scoreDiv.querySelector('.empty-score-message');
                if (emptyMessage) {
                    emptyMessage.remove();
                }
            }
        }

        // 试用限制管理系统
        const TrialManager = {
            maxTrialUses: 20, // 免费试用最大次数

            // 检查是否为完整版用户
            isFullVersion() {
                return localStorage.getItem('ic_full_version') === 'true';
            },

            // 获取当前试用次数
            getTrialCount() {
                const count = localStorage.getItem('ic_trial_count');
                return count ? parseInt(count) : 0;
            },

            // 增加试用次数
            incrementTrialCount() {
                const currentCount = this.getTrialCount();
                const newCount = currentCount + 1;
                localStorage.setItem('ic_trial_count', newCount.toString());
                return newCount;
            },

            // 获取剩余试用次数
            getRemainingTrials() {
                return Math.max(0, this.maxTrialUses - this.getTrialCount());
            },

            // 检查是否可以继续使用
            canUse() {
                return this.isFullVersion() || this.getRemainingTrials() > 0;
            },

            // 更新试用信息显示
            updateTrialDisplay() {
                const trialInfo = document.getElementById('trialInfo');
                const trialCounter = document.getElementById('trialCounter');

                if (this.isFullVersion()) {
                    // 完整版用户：隐藏所有试用相关显示
                    if (trialInfo) {
                        trialInfo.style.display = 'none';
                    }
                    if (trialCounter) {
                        trialCounter.style.display = 'none';
                    }
                } else {
                    // 试用版用户：隐藏header中的提示，只在按钮旁显示简单数字
                    if (trialInfo) {
                        trialInfo.style.display = 'none';
                    }
                    if (trialCounter) {
                        const remaining = this.getRemainingTrials();
                        if (remaining > 0) {
                            trialCounter.innerHTML = `${remaining}`;
                            trialCounter.style.display = 'inline-block';
                        } else {
                            trialCounter.innerHTML = '0';
                            trialCounter.style.display = 'inline-block';
                        }
                    }
                }
            },

            // 显示试用限制警告
            showTrialLimitWarning() {
                // 静默处理：试用次数用完后不显示任何提示，直接返回 false
                return false;
            },

            // 验证访问码
            validateAccessCode(code) {
                // 这里可以设置多个有效的访问码
                const validCodes = [
                    'IC2025FULL',
                    'ICSTUDIO2025',
                    'SIGHT2025',
                    'MELODY2025'
                ];
                return validCodes.includes(code.toUpperCase());
            }
        };

        // 监听OSMD渲染完成
        const originalGenerateMelody = window.generateMelody;
        if (originalGenerateMelody) {
            window.generateMelody = function(...args) {
                // 检查试用限制
                if (!TrialManager.canUse()) {
                    const unlocked = TrialManager.showTrialLimitWarning();
                    if (!unlocked) {
                        return; // 如果没有解锁成功，则停止执行
                    }
                    // 如果解锁成功，继续执行下面的代码
                }

                // 自动停止当前播放
                if (window.isPlayingMelody) {
                    window.isPlayingMelody = false;
                    // 停止所有调度的播放
                    if (window.melodyScheduledSounds) {
                        window.melodyScheduledSounds.forEach(sound => {
                            try {
                                if (sound.oscillator) {
                                    sound.oscillator.stop();
                                }
                            } catch (e) {
                                // 振荡器可能已经停止，忽略错误
                            }
                        });
                        window.melodyScheduledSounds = [];
                    }
                    // 更新播放按钮状态
                    if (typeof updatePlayButton === 'function') {
                        updatePlayButton();
                    }
                }

                // 清除空谱子提示信息
                clearEmptyScoreMessage();

                // 非完整版用户增加试用计数
                if (!TrialManager.isFullVersion()) {
                    TrialManager.incrementTrialCount();
                    TrialManager.updateTrialDisplay();
                }

                const result = originalGenerateMelody.apply(this, args);
                hideTitleAndInstrumentElements();

                // 检查并应用隐藏状态（如果用户之前开启了隐藏功能）
                setTimeout(() => {
                    if (typeof isMelodyHidden !== 'undefined' && isMelodyHidden) {
                        console.log('🔄 检测到隐藏状态，应用到新生成的旋律');
                        const scoreElement = document.getElementById('score');
                        if (scoreElement) {
                            const svgElements = scoreElement.querySelectorAll('svg');
                            svgElements.forEach(svg => {
                                svg.classList.add('melody-hidden');
                                svg.style.opacity = '0';
                                svg.style.filter = 'blur(10px)';
                            });
                        }
                    }
                }, 500); // 等待OSMD渲染完成

                return result;
            };
        }
        

        // 页面加载完成后也执行一次
        document.addEventListener('DOMContentLoaded', () => {
            hideTitleAndInstrumentElements();

            // 检查是否从访问码页面跳转过来
            const verifiedFromAccessPage = localStorage.getItem('ic_verified_from_access_page');
            const verifiedTimestamp = localStorage.getItem('ic_verified_timestamp');

            if (verifiedFromAccessPage === 'true' && verifiedTimestamp) {
                const timeDiff = Date.now() - parseInt(verifiedTimestamp);
                // 如果是5分钟内从访问码页面跳转过来的，确保完整版状态
                if (timeDiff < 5 * 60 * 1000) {
                    console.log('🎯 检测到从访问码页面跳转，确保完整版状态');
                    localStorage.setItem('ic_full_version', 'true');
                    // 清除跳转标记
                    localStorage.removeItem('ic_verified_from_access_page');
                    localStorage.removeItem('ic_verified_timestamp');
                }
            }

            // 初始化试用信息显示
            TrialManager.updateTrialDisplay();

            // 定期检查
            setInterval(hideTitleAndInstrumentElements, 2000);

            // 🎵 添加乐谱容器点击事件，触发生成旋律
            const scoreContainer = document.getElementById('score');
            if (scoreContainer) {
                scoreContainer.addEventListener('click', function(event) {
                    console.log('🎵 用户点击乐谱容器，触发生成旋律');
                    // 检查是否点击的是乐谱内容而不是控制按钮
                    if (!event.target.closest('button') && !event.target.closest('.control')) {
                        generateMelody();
                    }
                });
                // 添加样式提示，让用户知道容器可以点击
                scoreContainer.style.cursor = 'pointer';
                scoreContainer.title = '点击生成新旋律';
            }
        });

        // ====== 直接在HTML中定义的简单播放器 ======
        console.log('🎹 直接在HTML中创建播放器...');

        window.isPlayingMelody = false;
        window.melodyAudioCtx = null;

        function directPlayTest() {
            console.log('🎵 直接播放被调用');

            if (window.isPlayingMelody) {
                // 停止播放
                window.isPlayingMelody = false;
                // 停止所有调度的播放
                if (window.melodyScheduledSounds) {
                    window.melodyScheduledSounds.forEach(sound => {
                        try {
                            if (sound.oscillator) {
                                sound.oscillator.stop();
                            }
                        } catch (e) {
                            // 振荡器可能已经停止，忽略错误
                        }
                    });
                    window.melodyScheduledSounds = [];
                }
                updatePlayButton();
                console.log('⏹️ 停止钢琴播放');
                return;
            }

            try {
                // 创建音频上下文
                if (!window.melodyAudioCtx) {
                    window.melodyAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    console.log('🎹 创建了新的AudioContext');
                }

                // 检查状态
                if (window.melodyAudioCtx.state === 'suspended') {
                    window.melodyAudioCtx.resume().then(() => {
                        console.log('🔄 AudioContext已恢复');
                        startMelodyPlayback();
                    });
                } else {
                    startMelodyPlayback();
                }

            } catch (error) {
                console.error('❌ 播放错误:', error);
                alert('播放出错: ' + error.message);
            }
        }

        function startMelodyPlayback() {
            console.log('🎵 开始旋律播放');

            // 获取当前旋律数据
            let melodyData = null;
            if (typeof getCurrentMelodyData === 'function') {
                melodyData = getCurrentMelodyData();
            } else {
                // 如果函数不存在，尝试从全局变量获取
                if (typeof melodyHistory !== 'undefined' && typeof currentHistoryIndex !== 'undefined' &&
                    melodyHistory && melodyHistory.length > 0 && currentHistoryIndex >= 0 &&
                    currentHistoryIndex < melodyHistory.length) {
                    melodyData = melodyHistory[currentHistoryIndex];
                    console.log('📋 从全局变量获取旋律数据:', melodyData);
                }
            }

            if (!melodyData) {
                console.log('⚠️ 没有旋律数据，播放测试音符');
                playTestNote();
                return;
            }

            // 检查是否为隐藏模式
            const isHiddenMode = checkIfMelodyHidden();

            if (isHiddenMode) {
                console.log('🎼 隐藏模式激活，启动count-in + 节拍器');
                playCountInThenMelody(melodyData);
            } else {
                console.log('🎶 普通模式，直接播放旋律');
                playFullMelody(melodyData);
            }
        }

        // 检查旋律是否隐藏
        function checkIfMelodyHidden() {
            // 检查全局变量isMelodyHidden
            if (typeof isMelodyHidden !== 'undefined' && isMelodyHidden) {
                return true;
            }

            // 检查SVG是否有hidden class
            const scoreElement = document.getElementById('score');
            if (scoreElement) {
                const svgElements = scoreElement.querySelectorAll('svg');
                for (let svg of svgElements) {
                    if (svg.classList.contains('melody-hidden')) {
                        return true;
                    }
                }
            }

            return false;
        }

        function playTestNote() {
            try {
                console.log('🎹 播放440Hz钢琴测试音符');

                window.isPlayingMelody = true;
                updatePlayButton();

                // 使用新的钢琴音色播放测试音符
                const now = window.melodyAudioCtx.currentTime;
                const testDuration = 1.0;
                const pianoTestNote = createPianoNote(440, now, testDuration);

                console.log('✅ 钢琴测试音符开始播放');

                // 1.5秒后停止状态
                setTimeout(() => {
                    window.isPlayingMelody = false;
                    updatePlayButton();
                    console.log('✅ 钢琴音色播放完成 - 音频系统工作正常');

                    // 播放成功后可以扩展到完整旋律播放
                    if (typeof getCurrentMelodyData === 'function') {
                        console.log('🎵 钢琴音色测试成功，系统准备就绪');
                    }
                }, 1500);

            } catch (error) {
                console.error('❌ 钢琴测试音符播放失败:', error);
                window.isPlayingMelody = false;
                updatePlayButton();
            }
        }

        function updatePlayButton() {
            const playBtn = document.getElementById('playMelodyBtn');
            if (playBtn) {
                if (window.isPlayingMelody) {
                    playBtn.innerHTML = '⏸️ 停止';
                } else {
                    playBtn.innerHTML = '▶️ 播放';
                }
                console.log('🔄 按钮状态已更新:', window.isPlayingMelody ? '播放中' : '已停止');
            }
        }

        // 切换旋律显示/隐藏
        var isMelodyHidden = false;
        function toggleMelodyVisibility() {
            isMelodyHidden = !isMelodyHidden;
            const visibilityBtn = document.getElementById('melodyVisibilityBtn');
            const scoreElement = document.getElementById('score');

            if (isMelodyHidden) {
                // 隐藏旋律
                if (scoreElement) {
                    const svgElements = scoreElement.querySelectorAll('svg');
                    svgElements.forEach(svg => {
                        svg.classList.add('melody-hidden');
                        svg.style.opacity = '0';
                        svg.style.filter = 'blur(10px)';
                    });
                }
                if (visibilityBtn) {
                    visibilityBtn.innerHTML = '👂';
                    visibilityBtn.title = '显示旋律';
                    visibilityBtn.classList.add('hidden-state');
                }
                console.log('👂 旋律已隐藏');
            } else {
                // 显示旋律
                if (scoreElement) {
                    const svgElements = scoreElement.querySelectorAll('svg');
                    svgElements.forEach(svg => {
                        svg.classList.remove('melody-hidden');
                        svg.style.opacity = '1';
                        svg.style.filter = 'none';
                    });
                }
                if (visibilityBtn) {
                    visibilityBtn.innerHTML = '👀';
                    visibilityBtn.title = '隐藏旋律';
                    visibilityBtn.classList.remove('hidden-state');
                }
                console.log('👀 旋律已显示');
            }
        }

        // MIDI转频率的辅助函数
        function midiToFrequency(midiNote) {
            return 440 * Math.pow(2, (midiNote - 69) / 12);
        }

        // 音符时值转秒数的辅助函数
        function durationToSeconds(duration, tempo = 60) {
            const beatsPerSecond = tempo / 60;
            const durationMap = {
                'whole': 4,
                'half': 2,
                'quarter': 1,
                'eighth': 0.5,
                '16th': 0.25,
                'dotted-half': 3,
                'dotted-quarter': 1.5,
                'dotted-eighth': 0.75
            };
            const beats = durationMap[duration] || 1;
            return beats / beatsPerSecond;
        }


        // 安排单个音符播放 - 钢琴音色版本
        function scheduleNotePlay(frequency, startTime, duration) {
            try {
                // 创建钢琴音色的复合音符
                const pianoSound = createPianoNote(frequency, startTime, duration);

                // 记录所有组件以便停止时清理
                window.melodyScheduledSounds.push(...pianoSound.components);

            } catch (error) {
                console.error('❌ 音符播放安排失败:', error);
            }
        }

        // 创建高品质钢琴音色
        function createPianoNote(frequency, startTime, duration) {
            const components = [];

            // 🎹 根据音高调整参数
            const isLowNote = frequency < 130; // C3以下
            const isMidNote = frequency >= 130 && frequency < 520; // C3-C5
            const isHighNote = frequency >= 520; // C5以上

            // 📊 音高相关的音色参数
            const harmonicWeights = getHarmonicWeights(frequency);
            const envelopeParams = getEnvelopeParams(frequency, duration);

            // 🎼 主音频链：基频 + 滤波器 + 压缩器
            const fundamental = window.melodyAudioCtx.createOscillator();
            const fundamentalGain = window.melodyAudioCtx.createGain();
            const mainFilter = window.melodyAudioCtx.createBiquadFilter();
            const compressor = window.melodyAudioCtx.createDynamicsCompressor();

            // 基频设置
            fundamental.frequency.value = frequency;
            fundamental.type = isMidNote ? 'triangle' : 'sawtooth';

            // 主滤波器 - 模拟钢琴的木质共鸣，降低截止频率削弱高频
            mainFilter.type = 'lowpass';
            mainFilter.frequency.value = frequency * (isLowNote ? 2.5 : isHighNote ? 6 : 4);
            mainFilter.Q.value = isLowNote ? 0.7 : 1.0;

            // 压缩器设置 - 模拟钢琴的动态响应
            compressor.threshold.value = -18;
            compressor.knee.value = 12;
            compressor.ratio.value = isLowNote ? 3 : 6;
            compressor.attack.value = 0.003;
            compressor.release.value = 0.1;

            // 连接主音频链
            fundamental.connect(mainFilter);
            mainFilter.connect(fundamentalGain);
            fundamentalGain.connect(compressor);
            compressor.connect(window.melodyAudioCtx.destination);

            // 🎵 谐波系列 - 模拟真实钢琴的谐波结构
            const harmonics = [];
            const harmonicRatios = [2, 3, 4, 5, 6, 7, 8]; // 八度、十二度、两八度等

            harmonicRatios.forEach((ratio, index) => {
                const weight = harmonicWeights[index] || 0;
                if (weight > 0.01) {
                    const harmonic = window.melodyAudioCtx.createOscillator();
                    const harmonicGain = window.melodyAudioCtx.createGain();
                    const harmonicFilter = window.melodyAudioCtx.createBiquadFilter();

                    harmonic.frequency.value = frequency * ratio;
                    harmonic.type = ratio % 2 === 0 ? 'triangle' : 'sine';

                    // 谐波滤波器 - 进一步削弱高频
                    harmonicFilter.type = 'lowpass';
                    harmonicFilter.frequency.value = frequency * ratio * 1.2;
                    harmonicFilter.Q.value = 0.6;

                    harmonic.connect(harmonicFilter);
                    harmonicFilter.connect(harmonicGain);
                    harmonicGain.connect(compressor);

                    harmonics.push({ oscillator: harmonic, gainNode: harmonicGain, filter: harmonicFilter, weight });
                }
            });

            // 🎭 噪音成分已移除 - 提供更纯净的音色

            // 🎼 高级ADSR包络
            const now = startTime;
            const { attack, decay, sustain, release } = envelopeParams;

            // 主音包络
            fundamentalGain.gain.setValueAtTime(0, now);
            fundamentalGain.gain.linearRampToValueAtTime(0.5, now + attack);
            fundamentalGain.gain.exponentialRampToValueAtTime(0.5 * sustain, now + attack + decay);
            fundamentalGain.gain.setValueAtTime(0.5 * sustain, now + duration - release);
            fundamentalGain.gain.exponentialRampToValueAtTime(0.001, now + duration);

            // 谐波包络 - 每个谐波有不同的衰减特性
            harmonics.forEach(({ gainNode, weight }, index) => {
                const harmonicAttack = attack * (0.8 + index * 0.1);
                const harmonicDecay = decay * (0.5 + index * 0.2);
                const harmonicSustain = sustain * (0.6 - index * 0.1);
                const harmonicRelease = release * (0.8 + index * 0.15);

                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(weight, now + harmonicAttack);
                gainNode.gain.exponentialRampToValueAtTime(weight * harmonicSustain, now + harmonicAttack + harmonicDecay);
                gainNode.gain.setValueAtTime(weight * harmonicSustain, now + duration - harmonicRelease);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + duration);
            });

            // 噪音包络已移除

            // 🎹 动态滤波器包络 - 更保守的高频控制
            mainFilter.frequency.setValueAtTime(frequency * 5, now);
            mainFilter.frequency.exponentialRampToValueAtTime(frequency * 2.5, now + attack + decay);
            mainFilter.frequency.setValueAtTime(frequency * 2.5, now + duration - release);
            mainFilter.frequency.exponentialRampToValueAtTime(frequency * 1.8, now + duration);

            // 启动所有振荡器
            fundamental.start(now);
            harmonics.forEach(({ oscillator }) => oscillator.start(now));

            // 停止所有振荡器
            fundamental.stop(now + duration);
            harmonics.forEach(({ oscillator }) => oscillator.stop(now + duration));

            // 记录组件
            components.push({ oscillator: fundamental, gainNode: fundamentalGain, filter: mainFilter });
            components.push(...harmonics);

            console.log(`🎹 创建纯净钢琴音色: ${frequency.toFixed(1)}Hz (基频 + ${harmonics.length}个谐波)`);

            return { components };
        }

        // 根据音高获取谐波权重
        function getHarmonicWeights(frequency) {
            const isLowNote = frequency < 130;
            const isMidNote = frequency >= 130 && frequency < 520;
            const isHighNote = frequency >= 520;

            if (isLowNote) {
                // 低音：更多低次谐波，厚重感，大幅削弱第4个泛音列
                return [0.25, 0.12, 0.025, 0.015, 0.01, 0.003, 0.001];
            } else if (isHighNote) {
                // 高音：保持明亮但大幅削弱高频成分，特别是第4个泛音列
                return [0.18, 0.18, 0.06, 0.04, 0.02, 0.008, 0.002];
            } else {
                // 中音：平衡结构，大幅削弱第4个泛音列
                return [0.22, 0.15, 0.04, 0.03, 0.018, 0.01, 0.003];
            }
        }

        // 根据音高和时长获取包络参数
        function getEnvelopeParams(frequency, duration) {
            const isLowNote = frequency < 130;
            const isMidNote = frequency >= 130 && frequency < 520;
            const isHighNote = frequency >= 520;

            let attack, decay, sustain, release;

            if (isLowNote) {
                // 低音：较慢的起音，长的衰减
                attack = Math.max(0.008, 0.03 - (frequency / 200) * 0.01);
                decay = 0.5;
                sustain = 0.3;
                release = Math.min(1.5, duration * 0.3);
            } else if (isHighNote) {
                // 高音：快起音，短衰减
                attack = 0.003;
                decay = 0.15;
                sustain = 0.2;
                release = Math.min(0.3, duration * 0.2);
            } else {
                // 中音：平衡的参数
                attack = 0.005;
                decay = 0.3;
                sustain = 0.25;
                release = Math.min(0.8, duration * 0.25);
            }

            return {
                attack,
                decay,
                sustain,
                release
            };
        }

        // 改进的MusicXML音符解析函数
        function parseNotesFromMusicXML(musicXML) {
            const notes = [];

            try {
                console.log('🎼 开始详细解析MusicXML...');

                // 🔍 调试：输出原始MusicXML以分析附点问题
                console.log('📋 原始MusicXML内容:', musicXML);

                // 🔍 检查MusicXML中的 <dot> 元素
                const dotCount = (musicXML.match(/<dot/g) || []).length;
                console.log(`🔍 检测到 ${dotCount} 个 <dot> 元素`);

                // 🔧 修复：如果检测到多余的附点，进行清理
                if (dotCount > 0) {
                    console.log(`⚠️ 发现 ${dotCount} 个附点元素，开始清理多余附点...`);
                    musicXML = cleanupExcessiveDots(musicXML);
                    const cleanedDotCount = (musicXML.match(/<dot/g) || []).length;
                    console.log(`✅ 清理完成，剩余 ${cleanedDotCount} 个附点元素`);
                }

                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(musicXML, 'text/xml');

                // 查找所有note元素
                const noteElements = xmlDoc.getElementsByTagName('note');
                console.log(`🔍 XML中找到 ${noteElements.length} 个note元素`);

                for (let i = 0; i < noteElements.length; i++) {
                    const noteElement = noteElements[i];

                    // 获取基本的duration信息（MusicXML duration单位）
                    const durationElement = noteElement.getElementsByTagName('duration')[0];
                    const xmlDuration = durationElement ? parseInt(durationElement.textContent) : 4;

                    // 获取时值类型
                    const typeElement = noteElement.getElementsByTagName('type')[0];
                    const noteType = typeElement ? typeElement.textContent : 'quarter';

                    // 检查是否有附点
                    const dotElements = noteElement.getElementsByTagName('dot');
                    const hasDot = dotElements.length > 0;

                    // 🔍 调试：显示每个音符的附点情况
                    console.log(`🔍 音符 ${i+1}: 类型=${noteType}, 附点数量=${dotElements.length}`);
                    if (dotElements.length > 0) {
                        console.log(`⚠️ 检测到异常！音符有 ${dotElements.length} 个附点`);
                    }

                    // 计算实际的duration字符串
                    let actualDuration = noteType;
                    if (hasDot) {
                        actualDuration = `dotted-${noteType}`;
                    }

                    // 检查是否是休止符
                    const restElement = noteElement.getElementsByTagName('rest')[0];
                    if (restElement) {
                        const restObj = {
                            type: 'rest',
                            duration: actualDuration,
                            xmlDuration: xmlDuration,
                            beats: calculateBeatsFromDuration(actualDuration)
                        };
                        console.log(`🎵 解析休止符: ${actualDuration} (${restObj.beats}拍)`);
                        notes.push(restObj);
                        continue;
                    }

                    // 获取音高信息
                    const pitchElement = noteElement.getElementsByTagName('pitch')[0];
                    if (pitchElement) {
                        const step = pitchElement.getElementsByTagName('step')[0]?.textContent;
                        const octave = parseInt(pitchElement.getElementsByTagName('octave')[0]?.textContent);
                        const alterElement = pitchElement.getElementsByTagName('alter')[0];
                        const alter = alterElement ? parseInt(alterElement.textContent) : 0;

                        // 检查连线信息
                        const tieElements = noteElement.getElementsByTagName('tie');
                        let tieInfo = null;
                        if (tieElements.length > 0) {
                            const tieTypes = Array.from(tieElements).map(tie => tie.getAttribute('type'));
                            tieInfo = {
                                isStart: tieTypes.includes('start'),
                                isStop: tieTypes.includes('stop'),
                                types: tieTypes
                            };
                        }

                        // 计算MIDI音符号
                        if (step && !isNaN(octave)) {
                            const midi = stepOctaveToMidi(step, octave, alter);

                            const noteObj = {
                                type: 'note',
                                step: step,
                                octave: octave,
                                alter: alter,
                                midi: midi,
                                duration: actualDuration,
                                xmlDuration: xmlDuration,
                                beats: calculateBeatsFromDuration(actualDuration),
                                tied: tieInfo ? true : false,
                                tieInfo: tieInfo
                            };

                            const tieStr = tieInfo ? ` [连线:${tieInfo.types.join(',')}]` : '';
                            console.log(`🎵 解析音符: ${step}${alter > 0 ? '#' : alter < 0 ? 'b' : ''}${octave} (MIDI: ${midi}) ${actualDuration} (${noteObj.beats}拍)${tieStr}`);
                            notes.push(noteObj);
                        }
                    }
                }

                console.log(`🎼 XML解析完成，共${notes.length}个音符/休止符`);

            } catch (error) {
                console.error('❌ MusicXML解析错误:', error);
            }

            return notes;
        }

        // 计算音符时值对应的拍数
        function calculateBeatsFromDuration(duration) {
            const baseDurations = {
                'whole': 4,
                'half': 2,
                'quarter': 1,
                'eighth': 0.5,
                '16th': 0.25,
                '32nd': 0.125
            };

            // 处理附点音符（用于解析现有MusicXML）
            if (duration.startsWith('dotted-')) {
                const baseDuration = duration.replace('dotted-', '');
                const baseBeats = baseDurations[baseDuration] || 1;
                return baseBeats * 1.5; // 附点增加50%时值
            }

            return baseDurations[duration] || 1;
        }

        // 将音名和八度转换为MIDI音符号
        function stepOctaveToMidi(step, octave, alter = 0) {
            const stepToSemitone = {
                'C': 0, 'D': 2, 'E': 4, 'F': 5, 'G': 7, 'A': 9, 'B': 11
            };

            const baseMidi = stepToSemitone[step];
            if (baseMidi === undefined) return 60; // 默认C4

            return (octave + 1) * 12 + baseMidi + alter;
        }



        // 获取拍号信息
        function getTimeSignature(melodyData) {
            // 默认值
            let timeSignature = { numerator: 4, denominator: 4 };

            try {
                // 从config中获取
                if (melodyData.config && melodyData.config.timeSignature) {
                    const ts = melodyData.config.timeSignature;
                    if (ts.includes('/')) {
                        const parts = ts.split('/');
                        timeSignature.numerator = parseInt(parts[0]) || 4;
                        timeSignature.denominator = parseInt(parts[1]) || 4;
                    }
                }

                // 从musicXML中获取
                if (melodyData.musicXML && timeSignature.numerator === 4) {
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(melodyData.musicXML, 'text/xml');
                    const timeElements = xmlDoc.getElementsByTagName('time');

                    if (timeElements.length > 0) {
                        const beats = timeElements[0].getElementsByTagName('beats')[0]?.textContent;
                        const beatType = timeElements[0].getElementsByTagName('beat-type')[0]?.textContent;

                        if (beats && beatType) {
                            timeSignature.numerator = parseInt(beats) || 4;
                            timeSignature.denominator = parseInt(beatType) || 4;
                        }
                    }
                }
            } catch (error) {
                console.warn('⚠️ 无法解析拍号，使用默认4/4拍:', error);
            }

            console.log(`🎼 检测到拍号: ${timeSignature.numerator}/${timeSignature.denominator}`);
            return timeSignature;
        }

        // 播放完整旋律（纯旋律，不带节拍器）
        function playFullMelody(melodyData, customStartTime = null) {
            console.log('🎶 开始旋律播放');

            // 只在首次调用时设置播放状态，count-in调用时已经设置过了
            if (!window.isPlayingMelody) {
                window.isPlayingMelody = true;
                updatePlayButton();
                window.melodyScheduledSounds = [];
            }

            // 获取节拍器速度
            let tempo = 60;
            if (typeof getCurrentTempo === 'function') {
                tempo = getCurrentTempo();
            }
            console.log('🕰️ 播放速度:', tempo, 'BPM');

            // 解析音符数据
            let notes = extractNotesFromMelodyData(melodyData);

            if (notes.length === 0) {
                console.log('⚠️ 没有找到音符，播放钢琴测试音符');
                playTestNote();
                return;
            }

            console.log(`🎵 找到 ${notes.length} 个音符，开始安排播放`);

            // 处理连线音符和休止符
            const processedNotes = processNotesForPlayback(notes);
            console.log(`🎵 处理后的音符: ${processedNotes.length}个事件`);

            // 计算总时长并安排播放
            const startTime = customStartTime || window.melodyAudioCtx.currentTime;
            let totalDuration = 0;
            let currentTime = 0;

            // 安排音符播放
            processedNotes.forEach((event, index) => {
                const eventStartTime = startTime + currentTime;
                const eventDuration = durationToSeconds(event.duration || 'quarter', tempo);

                if (event.type === 'note' && event.midi && !event.isTiedContinuation) {
                    // 播放音符（跳过连线的延续部分）
                    const frequency = midiToFrequency(event.midi);
                    scheduleNotePlay(frequency, eventStartTime, eventDuration);
                    console.log(`🎹 安排播放: MIDI ${event.midi} @ ${eventStartTime.toFixed(2)}s, 时长 ${eventDuration.toFixed(2)}s`);
                } else if (event.type === 'rest') {
                    // 休止符 - 只计时，不播放
                    console.log(`🔇 休止符: ${eventDuration.toFixed(2)}s @ ${eventStartTime.toFixed(2)}s`);
                }

                totalDuration = Math.max(totalDuration, currentTime + eventDuration);
                currentTime += eventDuration;
            });

            // 设置播放完成回调
            setTimeout(() => {
                if (window.isPlayingMelody) {
                    window.isPlayingMelody = false;
                    updatePlayButton();
                    window.melodyScheduledSounds = [];
                    console.log('✅ 旋律播放完成');
                }
            }, (totalDuration + 0.5) * 1000);

            console.log(`🎼 播放安排完成: ${totalDuration.toFixed(2)}秒`);
        }

        // 提取音符数据的辅助函数
        function extractNotesFromMelodyData(melodyData) {
            let notes = [];

            // 方法1：检查measures结构
            if (melodyData.measures && Array.isArray(melodyData.measures)) {
                melodyData.measures.forEach((measure, measureIndex) => {
                    if (measure.notes && Array.isArray(measure.notes)) {
                        measure.notes.forEach(note => {
                            notes.push(note);
                        });
                    }
                });
            }

            // 方法2：检查是否有直接的notes数组
            if (notes.length === 0 && melodyData.notes && Array.isArray(melodyData.notes)) {
                notes = melodyData.notes;
            }

            // 方法3：检查musicXML中是否能解析出音符
            if (notes.length === 0 && melodyData.musicXML) {
                notes = parseNotesFromMusicXML(melodyData.musicXML);
            }

            return notes;
        }

        // 处理连线音符和休止符
        function processNotesForPlayback(notes) {
            const processedNotes = [];
            let i = 0;

            while (i < notes.length) {
                const currentNote = notes[i];

                if (currentNote.type === 'rest') {
                    // 休止符直接添加
                    processedNotes.push(currentNote);
                    i++;
                } else if (currentNote.type === 'note') {
                    if (currentNote.tied && currentNote.tieInfo && currentNote.tieInfo.isStart) {
                        // 这是连线的开始，需要合并后续的连线音符
                        const mergedNote = mergeTiedNotes(notes, i);
                        processedNotes.push(mergedNote.note);
                        i = mergedNote.nextIndex;
                    } else if (currentNote.tied && currentNote.tieInfo && currentNote.tieInfo.isStop && !currentNote.tieInfo.isStart) {
                        // 这是连线的结束，但不是开始，标记为延续（不播放）
                        const continuationNote = {
                            ...currentNote,
                            isTiedContinuation: true
                        };
                        processedNotes.push(continuationNote);
                        i++;
                    } else {
                        // 普通音符，直接添加
                        processedNotes.push(currentNote);
                        i++;
                    }
                } else {
                    // 其他类型，直接添加
                    processedNotes.push(currentNote);
                    i++;
                }
            }

            return processedNotes;
        }

        // 合并连线音符
        function mergeTiedNotes(notes, startIndex) {
            const startNote = notes[startIndex];
            let totalBeats = startNote.beats || calculateBeatsFromDuration(startNote.duration);
            let nextIndex = startIndex + 1;

            console.log(`🔗 开始处理连线: ${startNote.step}${startNote.octave} (开始音符: ${startNote.beats}拍)`);

            // 查找后续的连线音符
            while (nextIndex < notes.length) {
                const nextNote = notes[nextIndex];

                // 检查是否是同音高的连线音符
                if (nextNote.type === 'note' &&
                    nextNote.tied &&
                    nextNote.midi === startNote.midi &&
                    nextNote.tieInfo) {

                    const noteBeats = nextNote.beats || calculateBeatsFromDuration(nextNote.duration);
                    totalBeats += noteBeats;
                    console.log(`🔗 合并连线音符: +${noteBeats}拍, 总计: ${totalBeats}拍`);

                    nextIndex++;

                    // 如果这是连线的结束，停止合并
                    if (nextNote.tieInfo.isStop && !nextNote.tieInfo.isStart) {
                        break;
                    }
                } else {
                    // 遇到非连线音符，停止
                    break;
                }
            }

            // 计算合并后的duration
            const mergedDuration = beatsToClosestDuration(totalBeats);

            const mergedNote = {
                ...startNote,
                duration: mergedDuration,
                beats: totalBeats,
                isMergedTie: true,
                originalDuration: startNote.duration
            };

            console.log(`🔗 连线合并完成: ${startNote.step}${startNote.octave}, 总时长: ${totalBeats}拍 (${mergedDuration})`);

            return {
                note: mergedNote,
                nextIndex: nextIndex
            };
        }

        // 将拍数转换为最接近的duration字符串
        function beatsToClosestDuration(beats) {
            // 基础音符时值对应的拍数（不包含附点）
            const durationMap = [
                { beats: 4, duration: 'whole' },
                { beats: 2, duration: 'half' },
                { beats: 1, duration: 'quarter' },
                { beats: 0.5, duration: 'eighth' },
                { beats: 0.25, duration: '16th' },
                { beats: 0.125, duration: '32nd' }
            ];

            // 找到最接近的时值
            let closestDuration = 'quarter';
            let minDifference = Infinity;

            for (const { beats: targetBeats, duration } of durationMap) {
                const difference = Math.abs(beats - targetBeats);
                if (difference < minDifference) {
                    minDifference = difference;
                    closestDuration = duration;
                }
            }

            // 如果没有精确匹配，使用简单的映射
            if (minDifference > 0.01) {
                if (beats >= 4) return 'whole';
                if (beats >= 2) return 'half';
                if (beats >= 1) return 'quarter';
                if (beats >= 0.5) return 'eighth';
                return '16th';
            }

            return closestDuration;
        }

        // ====== 隐藏模式下的节拍器功能 ======

        // 创建节拍器声音
        function createMetronomeClick(frequency = 523.25, isDownbeat = false) {
            try {
                const oscillator = window.melodyAudioCtx.createOscillator();
                const gainNode = window.melodyAudioCtx.createGain();

                // 使用方波和自然音高 (与主节拍器保持一致)
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(
                    isDownbeat ? frequency * 1.2 : frequency,
                    window.melodyAudioCtx.currentTime
                );

                oscillator.connect(gainNode);
                gainNode.connect(window.melodyAudioCtx.destination);

                return { oscillator, gainNode };
            } catch (error) {
                console.error('❌ 创建节拍器声音失败:', error);
                return null;
            }
        }

        // 播放节拍器点击声
        function playMetronomeClick(startTime, isDownbeat = false) {
            const metronome = createMetronomeClick(523.25, isDownbeat);
            if (!metronome) return;

            const { oscillator, gainNode } = metronome;

            // 使用与NiceChord节拍器一致的包络
            const clickDuration = 0.05;
            const volume = 0.25; // 统一音量

            gainNode.gain.setValueAtTime(volume, startTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + clickDuration);

            oscillator.start(startTime);
            oscillator.stop(startTime + clickDuration);

            // 记录以便停止时清理
            window.melodyScheduledSounds.push({ oscillator, gainNode });

            console.log(`🥁 节拍器: ${isDownbeat ? '强拍' : '弱拍'} @ ${startTime.toFixed(2)}s`);
        }

        // 启动页面上的节拍器
        function startPageMetronome() {
            // 查找页面上的节拍器按钮并启动
            const metronomeBtn = document.querySelector('#headerMetronomePlay, .metronome-play-btn');
            if (metronomeBtn && !metronomeBtn.classList.contains('playing')) {
                console.log('🎼 启动页面节拍器');
                metronomeBtn.click();
                return true;
            }
            return false;
        }

        // 停止页面上的节拍器
        function stopPageMetronome() {
            const metronomeBtn = document.querySelector('#headerMetronomePlay, .metronome-play-btn');
            if (metronomeBtn && metronomeBtn.classList.contains('playing')) {
                console.log('⏹️ 停止页面节拍器');
                metronomeBtn.click();
                return true;
            }
            return false;
        }

        // Count-in然后播放旋律（隐藏模式专用）
        function playCountInThenMelody(melodyData) {
            console.log('🎼 隐藏模式：开始count-in（仅count-in，不启动页面节拍器）');

            window.isPlayingMelody = true;
            updatePlayButton();
            window.melodyScheduledSounds = [];

            // 获取节拍器速度和拍号
            let tempo = 60;
            if (typeof getCurrentTempo === 'function') {
                tempo = getCurrentTempo();
            }

            // 获取拍号信息
            const timeSignature = getTimeSignature(melodyData);
            const countInBeats = timeSignature.numerator; // 使用拍号分子作为count-in次数

            console.log(`🎼 Count-in设置: ${tempo} BPM, 拍号 ${timeSignature.numerator}/${timeSignature.denominator}, count-in ${countInBeats}下`);

            const beatDuration = 60 / tempo; // 每拍的秒数
            const now = window.melodyAudioCtx.currentTime;

            // 注释掉启动页面节拍器的代码
            // startPageMetronome();

            // 播放count-in（根据拍号分子决定次数）
            for (let beat = 0; beat < countInBeats; beat++) {
                const beatTime = now + beat * beatDuration;
                const isDownbeat = beat === 0;
                playMetronomeClick(beatTime, isDownbeat);
            }

            // count-in完成后的处理
            const countInEndTime = now + countInBeats * beatDuration;
            console.log(`🎵 Count-in将在${countInEndTime.toFixed(2)}s结束，然后开始旋律播放`);

            // 在count-in结束后开始播放旋律（不需要停止页面节拍器，因为没有启动过）
            setTimeout(() => {
                if (window.isPlayingMelody) {
                    console.log('🎼 Count-in结束，开始旋律播放');
                    // 由于没有启动页面节拍器，这里不需要停止操作

                    // 开始播放旋律
                    playFullMelody(melodyData, countInEndTime);
                }
            }, countInBeats * beatDuration * 1000);
        }

        // 🎹 临时样本生成器 - 测试用
        function generateTestSample(frequency, name, audioContext) {
            console.log(`🎵 生成测试样本: ${name} (${frequency}Hz)`);

            const duration = 2.5;
            const sampleRate = 22050;
            const length = duration * sampleRate;

            // 创建AudioBuffer
            const buffer = audioContext.createBuffer(1, length, sampleRate);
            const data = buffer.getChannelData(0);

            // 根据具体音符调整谐波结构
            let harmonics, decay, brightness;

            switch(name) {
                case 'C4':
                    harmonics = [1.0, 0.5, 0.3, 0.2, 0.12, 0.08, 0.05]; // 温暖的中音
                    decay = 0.7;
                    brightness = 0.8;
                    break;
                case 'E4':
                    harmonics = [1.0, 0.45, 0.35, 0.22, 0.15, 0.09, 0.04]; // 略带明亮
                    decay = 0.65;
                    brightness = 0.9;
                    break;
                case 'G4':
                    harmonics = [1.0, 0.4, 0.4, 0.25, 0.18, 0.1, 0.03]; // 平衡的高中音
                    decay = 0.6;
                    brightness = 1.0;
                    break;
                case 'A4':
                    harmonics = [1.0, 0.35, 0.45, 0.28, 0.2, 0.12, 0.02]; // 明亮的A4
                    decay = 0.58;
                    brightness = 1.1;
                    break;
                default:
                    harmonics = [1.0, 0.4, 0.3, 0.2, 0.1, 0.05];
                    decay = 0.7;
                    brightness = 1.0;
            }

            // 生成样本数据
            for (let i = 0; i < length; i++) {
                const t = i / sampleRate;
                let sample = 0;

                // 添加谐波系列
                harmonics.forEach((amplitude, index) => {
                    const harmonic = index + 1;
                    const freq = frequency * harmonic;

                    // 高次谐波随时间衰减更快
                    const harmonicDecay = decay * (1 + index * 0.3);
                    const envelope = Math.exp(-harmonicDecay * t);

                    sample += amplitude * Math.sin(2 * Math.PI * freq * t) * envelope;
                });

                // 添加轻微的琴弦共鸣噪声
                const noiseLevel = 0.015 * Math.exp(-t * 3);
                sample += (Math.random() - 0.5) * noiseLevel;

                // 总体音量包络（模拟钢琴触键）
                const attack = Math.min(1, t * 50); // 快速攻击
                const sustain = Math.exp(-t * 0.8); // 自然衰减
                const totalEnvelope = attack * sustain;

                data[i] = sample * totalEnvelope * 0.25; // 控制总音量
            }

            console.log(`✅ ${name} 样本生成完成，时长 ${duration}s`);
            return buffer;
        }

        // 🎹 测试样本播放器
        window.testSamplePlayback = function(sampleName) {
            console.log(`🎵 测试播放样本: ${sampleName}`);

            // 确保AudioContext已初始化
            if (!window.melodyAudioCtx) {
                console.log('🔧 初始化AudioContext...');
                try {
                    window.melodyAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    console.log('✅ AudioContext初始化成功');
                } catch (error) {
                    console.error('❌ AudioContext初始化失败:', error);
                    return;
                }
            }

            // 确保AudioContext未被暂停
            if (window.melodyAudioCtx.state === 'suspended') {
                window.melodyAudioCtx.resume();
            }

            const frequencies = {
                'C4': 261.63,
                'E4': 329.63,
                'G4': 392.00,
                'A4': 440.00
            };

            const frequency = frequencies[sampleName];
            if (!frequency) {
                console.error(`❌ 未知样本: ${sampleName}`);
                return;
            }

            try {
                // 生成测试样本
                const buffer = generateTestSample(frequency, sampleName, window.melodyAudioCtx);

                // 播放样本
                const source = window.melodyAudioCtx.createBufferSource();
                source.buffer = buffer;
                source.connect(window.melodyAudioCtx.destination);

                const now = window.melodyAudioCtx.currentTime;
                source.start(now);

                console.log(`🔊 ${sampleName} 样本开始播放`);

                // 记录播放状态
                setTimeout(() => {
                    console.log(`✅ ${sampleName} 样本播放完成`);
                }, 3000);

            } catch (error) {
                console.error(`❌ ${sampleName} 样本播放失败:`, error);
            }
        };

        // 🎹 播放所有测试样本（按顺序）
        window.testAllSamples = function() {
            console.log('🎵 === 开始测试所有中高音样本 ===');

            const samples = ['C4', 'E4', 'G4', 'A4'];
            let currentIndex = 0;

            function playNext() {
                if (currentIndex >= samples.length) {
                    console.log('✅ === 所有样本测试完成 ===');
                    return;
                }

                const sample = samples[currentIndex];
                console.log(`\n🎵 第${currentIndex + 1}个样本: ${sample}`);
                window.testSamplePlayback(sample);

                currentIndex++;
                setTimeout(playNext, 3500); // 3.5秒间隔
            }

            playNext();
        };

        // 🎹 测试pitch shifting效果
        window.testPitchShifting = function() {
            console.log('🎵 === Pitch Shifting 测试 ===');

            // 使用A4样本生成不同音高
            const baseFreq = 440; // A4
            const baseSample = generateTestSample(baseFreq, 'A4');

            // 测试不同的pitch shifting比例
            const testNotes = [
                { name: 'C3', freq: 130.81, ratio: 130.81/440 },  // 向下shift
                { name: 'F3', freq: 174.61, ratio: 174.61/440 },  // 中等向下
                { name: 'A4', freq: 440, ratio: 1.0 },            // 原音
                { name: 'C5', freq: 523.25, ratio: 523.25/440 },  // 向上shift
                { name: 'F5', freq: 698.46, ratio: 698.46/440 }   // 大幅向上
            ];

            let index = 0;
            function playNextShifted() {
                if (index >= testNotes.length) {
                    console.log('✅ Pitch Shifting 测试完成');
                    return;
                }

                const note = testNotes[index];
                console.log(`🎵 测试 ${note.name}: 比例 ${note.ratio.toFixed(2)}x`);

                const source = window.melodyAudioCtx.createBufferSource();
                source.buffer = baseSample;
                source.playbackRate.value = note.ratio;
                source.connect(window.melodyAudioCtx.destination);

                source.start(window.melodyAudioCtx.currentTime);

                index++;
                setTimeout(playNextShifted, 2500);
            }

            playNextShifted();
        };

        console.log('✅ HTML内播放器创建完成（含隐藏模式节拍器 + 样本测试功能）');

        // 🎯 通用弹窗外部点击关闭功能
        function initializeModalClickOutsideToClose() {
            const modalIds = [
                'rhythmModal',
                'articulationModal',
                'keySignatureModal',
                'timeSignatureModal',
                'intervalModal',
                'clefModal'
            ];

            modalIds.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.addEventListener('click', function(event) {
                        // 只有当点击的是弹窗背景（modal容器本身）时才关闭
                        if (event.target === modal) {
                            console.log(`🎯 点击外部区域关闭弹窗: ${modalId}`);

                            // 根据弹窗类型调用相应的关闭函数
                            switch(modalId) {
                                case 'rhythmModal':
                                    if (typeof closeRhythmSettings === 'function') {
                                        closeRhythmSettings();
                                    }
                                    break;
                                case 'articulationModal':
                                    if (typeof closeArticulationSettings === 'function') {
                                        closeArticulationSettings();
                                    }
                                    break;
                                case 'keySignatureModal':
                                    if (typeof closeKeySettings === 'function') {
                                        closeKeySettings();
                                    }
                                    break;
                                case 'timeSignatureModal':
                                    if (typeof closeTimeSignatureSettings === 'function') {
                                        closeTimeSignatureSettings();
                                    }
                                    break;
                                case 'intervalModal':
                                    if (typeof closeIntervalSettings === 'function') {
                                        closeIntervalSettings();
                                    }
                                    break;
                                case 'clefModal':
                                    if (typeof closeClefSettings === 'function') {
                                        closeClefSettings();
                                    }
                                    break;
                                default:
                                    // 通用关闭方法
                                    modal.style.display = 'none';
                            }
                        }
                    });
                    console.log(`✅ 已为 ${modalId} 添加外部点击关闭功能`);
                }
            });
        }

        // 在页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeModalClickOutsideToClose();
            console.log('🎯 弹窗外部点击关闭功能已初始化');
        });

        // 核心重置函数 - 重置所有设置到默认状态
        window.nuclearReset = function() {
            console.log('🚀 开始执行核心重置...');

            try {
                // 1. 重置节奏设置
                if (typeof resetRhythmFrequencies === 'function') {
                    resetRhythmFrequencies();
                    console.log('✅ 节奏频率已重置');
                }

                // 2. 重置全选状态
                if (typeof resetSelectAllStates === 'function') {
                    resetSelectAllStates();
                    console.log('✅ 全选状态已重置');
                }

                // 3. 重置表单控件到默认值
                const defaults = {
                    'measures-4': true,
                    'rangeMin': '60',
                    'rangeMax': '72',
                    'accidentalRate': '0',
                    'headerMetronomeBpm': '60'
                };

                Object.entries(defaults).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) {
                        if (element.type === 'radio' || element.type === 'checkbox') {
                            element.checked = value;
                        } else {
                            element.value = value;
                        }
                    }
                });

                // 4. 更新临时记号显示
                const accidentalDisplay = document.getElementById('accidentalRateValue');
                if (accidentalDisplay) {
                    accidentalDisplay.textContent = '0%';
                }

                // 5. 重置所有模态框状态
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    modal.style.display = 'none';
                });

                // 6. 清空乐谱显示
                const scoreDiv = document.getElementById('score');
                if (scoreDiv) {
                    scoreDiv.innerHTML = '<div class="empty-score-message"><p data-i18n="score.empty">点击生成旋律开始练习</p></div>';
                }

                // 7. 停止任何播放中的音频
                if (window.isPlayingMelody) {
                    window.isPlayingMelody = false;
                    if (typeof updatePlayButton === 'function') {
                        updatePlayButton();
                    }
                }

                // 8. 停止节拍器
                if (isMetronomeRunning) {
                    if (typeof stopMetronome === 'function') {
                        stopMetronome();
                    }
                }

                console.log('🎯 核心重置完成！所有设置已恢复到默认状态');

                // 显示重置完成提示
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #34C759;
                    color: white;
                    padding: 12px 20px;
                    border-radius: 8px;
                    font-size: 14px;
                    font-weight: 500;
                    z-index: 10000;
                    box-shadow: 0 4px 16px rgba(52, 199, 89, 0.3);
                    opacity: 0;
                    transform: translateX(100px);
                    transition: all 0.3s ease;
                `;
                notification.textContent = '🎯 重置完成！';
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.opacity = '1';
                    notification.style.transform = 'translateX(0)';
                }, 10);

                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100px)';
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 300);
                }, 2000);

            } catch (error) {
                console.error('❌ 重置过程中出现错误:', error);
            }
        };

        console.log('🚀 nuclearReset() 函数已初始化完成');

        // 试用管理开发者工具 - 仅用于开发和测试
        window.devTools = {
            // 设置为完整版用户
            setFullVersion() {
                localStorage.setItem('ic_full_version', 'true');
                TrialManager.updateTrialDisplay();
                console.log('✅ 已设置为完整版用户');
            },

            // 重置为试用用户
            setTrialVersion() {
                localStorage.removeItem('ic_full_version');
                TrialManager.updateTrialDisplay();
                console.log('✅ 已重置为试用用户');
            },

            // 重置试用次数
            resetTrialCount() {
                localStorage.removeItem('ic_trial_count');
                TrialManager.updateTrialDisplay();
                console.log('✅ 试用次数已重置');
            },

            // 设置试用次数
            setTrialCount(count) {
                localStorage.setItem('ic_trial_count', count.toString());
                TrialManager.updateTrialDisplay();
                console.log(`✅ 试用次数已设置为 ${count}`);
            },

            // 查看当前状态
            getStatus() {
                const isFullVersion = TrialManager.isFullVersion();
                const trialCount = TrialManager.getTrialCount();
                const remaining = TrialManager.getRemainingTrials();

                console.log('📊 当前试用状态:');
                console.log(`   完整版用户: ${isFullVersion ? '是' : '否'}`);
                console.log(`   已使用次数: ${trialCount}`);
                console.log(`   剩余次数: ${remaining}`);

                return {
                    isFullVersion,
                    trialCount,
                    remaining
                };
            }
        };

        console.log('🛠️ 开发者工具已加载:');
        console.log('   - devTools.setFullVersion() - 设置为完整版');
        console.log('   - devTools.setTrialVersion() - 设置为试用版');
        console.log('   - devTools.resetTrialCount() - 重置试用次数');
        console.log('   - devTools.setTrialCount(n) - 设置试用次数');
        console.log('   - devTools.getStatus() - 查看当前状态');
    </script>


<script defer src="/js/tool-access-loader.js?v=1.0.2"></script>
</body></html>