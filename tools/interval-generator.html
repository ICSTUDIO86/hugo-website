<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
<script>
    (function() {
      var isFile = location.protocol === 'file:' || location.origin === 'null';
      if (!isFile) return;
      try {
        console.warn('ğŸš« æ£€æµ‹åˆ°file://åè®®ï¼Œå·²é˜»æ­¢');
      } catch (e) {}
      var html = '<!doctype html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>æ— æ³•ç¦»çº¿ä½¿ç”¨</title><style>body{margin:0;font-family:-apple-system,'Helvetica Neue','PingFang SC','Segoe UI',sans-serif;background:#f5f6f8;color:#111;} .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:32px;} .card{max-width:560px;background:#fff;border:1px solid #e6e8ec;border-radius:16px;box-shadow:0 20px 40px rgba(0,0,0,.08);padding:28px;} h1{font-size:20px;margin:0 0 12px;} p{margin:0 0 16px;color:#444;line-height:1.6;} a{display:inline-block;background:#1a8cff;color:#fff;text-decoration:none;padding:10px 16px;border-radius:10px;font-weight:600;}</style></head><body><div class="wrap"><div class="card"><h1>âš ï¸ æ— æ³•ç¦»çº¿ä½¿ç”¨</h1><p>ICè§†å¥å·¥å…·éœ€è¦åœ¨çº¿ä½¿ç”¨ä»¥éªŒè¯æˆæƒã€‚</p><p>è¯·è®¿é—®åœ¨çº¿ç‰ˆæœ¬ä»¥è·å¾—å®Œæ•´ä½“éªŒã€‚</p><a href="https://icstudio.club/tools/">è®¿é—®åœ¨çº¿ç‰ˆæœ¬ â†’</a></div></div></body></html>';
      document.open();
      document.write(html);
      document.close();
      throw new Error('file-protocol-blocked');
    })();
  </script>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Primary SEO Meta Tags -->
    <title>Interval Training Tool | Cognote - Ear Training & Pitch Recognition</title>
    <meta name="description" content="Professional interval training and ear training tool online. Practice interval recognition with customizable range, harmonic/melodic intervals, all interval types (m2-M13). Features real-time piano audio playback, standard music notation. Free 20 trials. Perfect for musicians developing relative pitch, ear training, and sight reading intervals. | ä¸“ä¸šéŸ³ç¨‹è®­ç»ƒä¸å¬åŠ›è®­ç»ƒå·¥å…·ï¼Œæ”¯æŒè‡ªå®šä¹‰éŸ³åŸŸã€å’Œå£°/æ—‹å¾‹éŸ³ç¨‹ã€æ‰€æœ‰éŸ³ç¨‹ç±»å‹ï¼ˆå°äºŒåº¦-å¤§åä¸‰åº¦ï¼‰ï¼Œå®æ—¶é’¢ç´éŸ³é¢‘ã€‚">
    <meta name="keywords" content="interval training, ear training, interval recognition, pitch training, music ear training, interval exercises, harmonic intervals, melodic intervals, relative pitch, perfect pitch training, music theory intervals, sight reading intervals, interval identification, aural training, music theory tool, free ear training, online interval trainer, interval practice, éŸ³ç¨‹è®­ç»ƒ, å¬åŠ›è®­ç»ƒ, éŸ³ç¨‹è¯†åˆ«, ç›¸å¯¹éŸ³æ„Ÿ, éŸ³ç¨‹ç»ƒä¹ , å’Œå£°éŸ³ç¨‹, æ—‹å¾‹éŸ³ç¨‹, IC è§†å¥å·¥å…·, Cognote">
    <meta name="author" content="Igor Chen - Cognote">
    <link rel="canonical" href="https://icstudio.club/tools/interval-generator.html">
    <link rel="icon" type="image/svg+xml" href="assets/icon/cognote.svg">
    <link rel="icon" type="image/png" href="assets/icon/cognote.png">

    <!-- Open Graph / Facebook / WeChat -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://icstudio.club/tools/interval-generator.html">
    <meta property="og:title" content="Interval Training Tool | Cognote">
    <meta property="og:description" content="Professional interval training & ear training tool. Practice interval recognition with customizable settings. Piano audio playback, standard notation. Free 20 trials. | ä¸“ä¸šéŸ³ç¨‹ä¸å¬åŠ›è®­ç»ƒå·¥å…·ï¼Œè‡ªå®šä¹‰è®¾ç½®ï¼Œå®æ—¶éŸ³é¢‘ã€‚">
    <meta property="og:image" content="https://icstudio.club/images/ICLOGO.png">
    <meta property="og:image:alt" content="Cognote Interval Training Tool Interface">
    <meta property="og:site_name" content="Cognote">
    <meta property="og:locale" content="zh_CN">
    <meta property="og:locale:alternate" content="en_US">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://icstudio.club/tools/interval-generator.html">
    <meta name="twitter:title" content="Interval Training & Ear Training Tool | Cognote">
    <meta name="twitter:description" content="Professional interval training tool. Practice interval recognition with customizable settings. Piano audio. Free 20 trials.">
    <meta name="twitter:image" content="https://icstudio.club/images/ICLOGO.png">

    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Cognote Interval Training Tool",
      "alternateName": ["IC è§†å¥å·¥å…·", "éŸ³ç¨‹è§†å¥è®­ç»ƒå·¥å…·"],
      "description": "Professional online interval training and ear training tool for music students. Practice interval recognition with customizable pitch range, harmonic/melodic intervals, and all interval types from minor 2nd to major 13th. Features real-time piano audio playback and standard music notation rendering.",
      "url": "https://icstudio.club/tools/interval-generator.html",
      "applicationCategory": "MusicApplication",
      "operatingSystem": "Web Browser",
      "browserRequirements": "Requires JavaScript. HTML5 compatible browser.",
      "offers": {
        "@type": "Offer",
        "price": "30",
        "priceCurrency": "EUR",
        "description": "Full version with unlimited access",
        "availability": "https://schema.org/InStock"
      },
      "featureList": [
        "Interval recognition training",
        "Harmonic and melodic intervals",
        "All interval types (minor 2nd to major 13th)",
        "Customizable pitch range (C2-C7)",
        "Ascending and descending intervals",
        "Real-time piano audio playback",
        "Professional music notation rendering",
        "Treble and bass clef support",
        "Perfect for relative pitch training",
        "Ear training exercises",
        "Free trial (20 uses)",
        "Suitable for all instruments"
      ],
      "creator": {
        "@type": "Person",
        "name": "Igor Chen",
        "url": "https://icstudio.club"
      },
      "provider": {
        "@type": "Organization",
        "name": "Cognote",
        "url": "https://icstudio.club",
        "logo": "https://icstudio.club/images/ICLOGO.png",
        "sameAs": [
          "https://www.youtube.com/@ICStudio86",
          "https://space.bilibili.com/376362605"
        ]
      },
      "audience": {
        "@type": "EducationalAudience",
        "educationalRole": "music student, piano student, guitar student, violin student, music teacher, choir member"
      },
      "inLanguage": ["zh-CN", "en-US"],
      "potentialAction": {
        "@type": "UseAction",
        "target": {
          "@type": "EntryPoint",
          "urlTemplate": "https://icstudio.club/tools/interval-generator.html"
        }
      }
    }
    </script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com/">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="">
    <link href="./IC éŸ³ç¨‹è§†å¥å·¥å…·_files/css2" rel="stylesheet">
    
    <!-- OpenSheetMusicDisplay -->
    <script src="./IC éŸ³ç¨‹è§†å¥å·¥å…·_files/opensheetmusicdisplay.min.js"></script>

    <!-- éŸ³ç¨‹ç”Ÿæˆå™¨æ¨¡å— -->
    <script src="./IC éŸ³ç¨‹è§†å¥å·¥å…·_files/interval-settings.js"></script>
    <!-- ğŸµ å°è°ƒç³»ç»Ÿæ¨¡å—ï¼ˆä»æ—‹å¾‹å·¥å…·è¿ç§»ï¼Œ2025-10-09ï¼‰ -->
    <script src="./IC éŸ³ç¨‹è§†å¥å·¥å…·_files/minor-scale-spelling.js"></script>
    <script src="./IC éŸ³ç¨‹è§†å¥å·¥å…·_files/minor-alterations.js"></script>
    <!-- æ ¸å¿ƒç”Ÿæˆå™¨ -->
    <script src="./IC éŸ³ç¨‹è§†å¥å·¥å…·_files/interval-generator.js"></script>
    <script src="./IC éŸ³ç¨‹è§†å¥å·¥å…·_files/interval-renderer.js"></script>
    <!-- V4.0é›†æˆè„šæœ¬ -->
    <script src="./IC éŸ³ç¨‹è§†å¥å·¥å…·_files/interval-generator-v4-integration.js"></script>
    
    <link rel="stylesheet" href="./IC éŸ³ç¨‹è§†å¥å·¥å…·_files/apple-ui-styles-green.css">
    <link rel="stylesheet" href="assets/css/midi-input.css">
    <script src="assets/js/sample-player.js?v=6"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function(){
        try {
          if (!window.__icSamplePlayer && window.ICSamplePlayer) {
            window.__icSamplePlayer = new ICSamplePlayer({ rootPath: 'assets/samples/piano-ogg-full' });
            window.__icSamplePlayer.load();
          }
        } catch(e) { console.warn('é‡‡æ ·å™¨åˆå§‹åŒ–å¤±è´¥:', e); }
      });
    </script>
    <script>
      document.addEventListener('DOMContentLoaded', function(){
        try {
          if (window.ReactGrab && typeof window.ReactGrab.init === 'function') {
            window.ReactGrab.init();
          }
          const api = window.ReactGrab && typeof window.ReactGrab.getGlobalApi === 'function'
            ? window.ReactGrab.getGlobalApi()
            : null;
          if (api) {
            window.addEventListener('keydown', function(event){
              if ((event.ctrlKey || event.metaKey) && event.shiftKey && (event.key === 'g' || event.key === 'G')) {
                api.toggle();
              }
            });
          }
        } catch(_) {}
      });
    </script>
    <script src="https://unpkg.com/react-grab/dist/index.global.js" crossorigin="anonymous"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="header-text">
                    <h1 data-i18n="app.title">Cognote - éŸ³ç¨‹è§†å¥ç”Ÿæˆå™¨</h1>
                    <p data-i18n="app.subtitle">ä¸“ä¸šçº§ä¹è°±æ¸²æŸ“ä¸éŸ³ä¹ç†è®ºå·¥å…·</p>
                </div>
                <div class="header-controls">
                    <div class="function-selector">
                        <button class="function-btn" id="functionBtn" onclick="toggleFunctionSelector()">
                            ğŸ¼ <span id="currentFunction" data-i18n="app.intervalMode">éŸ³ç¨‹è§†å¥</span>
                        </button>
                        <div class="function-menu" id="functionMenu">
                            <div class="function-option" onclick="switchFunction('melody')">
                                <span class="function-icon">ğŸµ</span>
                                <span data-i18n="app.melodyMode">æ—‹å¾‹è§†å¥</span>
                            </div>
                            <div class="function-option" onclick="switchFunction('jianpu')">
                                <span class="function-icon">ğŸ”¢</span>
                                <span data-i18n="app.jianpuMode">ç®€è°±è§†å¥</span>
                            </div>
                            <div class="function-option" onclick="switchFunction('interval')">
                                <span class="function-icon">ğŸ¼</span>
                                <span data-i18n="app.intervalMode">éŸ³ç¨‹è§†å¥</span>
                            </div>
                            <div class="function-option" onclick="switchFunction('chord')">
                                <span class="function-icon">ğŸ¹</span>
                                <span data-i18n="app.chordMode">å’Œå¼¦è§†å¥</span>
                            </div>
                            <div class="function-option" onclick="switchFunction('rhythm')">
                                <span class="function-icon">ğŸ¥</span>
                                <span data-i18n="app.rhythmMode">èŠ‚å¥è§†å¥</span>
                            </div>
                        </div>
                    </div>
                    <div class="settings-dropdown">
                        <button class="settings-btn" id="settingsBtn" onclick="toggleSettings()">
                            âš™ï¸ <span data-i18n="settings.title">è®¾ç½®</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="control-row">
                <div class="control-group">
                    <label data-i18n="controls.intervalType">éŸ³ç¨‹ç±»å‹</label>
                    <button class="btn-secondary" onclick="openIntervalTypeSettings()" id="intervalTypeSettingsBtn" data-i18n="controls.intervalTypeSettings">éŸ³ç¨‹ç±»å‹è®¾ç½®</button>
                </div>

                <div class="control-group">
                    <label data-i18n="controls.measures">å°èŠ‚æ•°</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="measures-2" name="measures" value="2">
                            <label for="measures-2" data-i18n="controls.measures2">2å°èŠ‚</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="measures-4" name="measures" value="4" checked="">
                            <label for="measures-4" data-i18n="controls.measures4">4å°èŠ‚</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="measures-8" name="measures" value="8">
                            <label for="measures-8" data-i18n="controls.measures8">8å°èŠ‚</label>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <label data-i18n="controls.key">è°ƒå·</label>
                    <button class="btn-secondary" onclick="openKeySettings()" id="keySettingsBtn" data-i18n="controls.keySettings">è°ƒå·è®¾ç½®</button>
                </div>

                <div class="control-group">
                    <label data-i18n="controls.time">æ‹å·</label>
                    <button class="btn-secondary" onclick="openTimeSignatureSettings()" id="timeSignatureSettingsBtn" data-i18n="controls.timeSettings">æ‹å·è®¾ç½®</button>
                </div>

                <div class="control-group">
                    <label data-i18n="controls.clef">è°±å·</label>
                    <button class="btn-secondary" onclick="openClefSettings()" id="clefSettingsBtn" data-i18n="controls.clefSettings">è°±å·è®¾ç½®</button>
                </div>

                <!-- æ¨¡å¼åˆ‡æ¢ï¼ˆè‡ªç”±/æŒ‘æˆ˜ï¼‰ -->
                <div class="control-group">
                    <label data-i18n="controls.mode">æ¨¡å¼</label>
                    <div class="mode-toggle" style="display: flex; align-items: center; gap: 10px;">
                        <span id="modeLabelFree" data-i18n="mode.free" style="font-size: 14px; opacity: 0.8;">è‡ªç”±</span>
                        <label class="switch" style="position: relative; display: inline-block; width: 60px; height: 34px;">
                            <input type="checkbox" id="challengeModeToggle" style="opacity: 0; width: 0; height: 0;">
                            <span class="slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: 0.4s; border-radius: 34px;">
                                <span class="slider-button" style="position: absolute; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: 0.4s; border-radius: 50%; transform: translateX(0px);"></span>
                            </span>
                        </label>
                        <span id="modeLabelChallenge" data-i18n="mode.challenge" style="font-size: 14px; opacity: 0.8;">æŒ‘æˆ˜</span>
                    </div>
                </div>
            </div>

            <!-- æ–°å¢ï¼šéŸ³åŸŸè®¾ç½® -->
            <div class="control-row">
                <div class="control-group">
                    <label for="rangeMin" data-i18n="controls.rangeMin">æœ€ä½éŸ³</label>
                    <select id="rangeMin">
                        <option value="33">A1</option>
                        <option value="35">B1</option>
                        <option value="36">C2</option>
                        <option value="38">D2</option>
                        <option value="40">E2</option>
                        <option value="41">F2</option>
                        <option value="43">G2</option>
                        <option value="45">A2</option>
                        <option value="47">B2</option>
                        <option value="48">C3</option>
                        <option value="50">D3</option>
                        <option value="52">E3</option>
                        <option value="53">F3</option>
                        <option value="55">G3</option>
                        <option value="57">A3</option>
                        <option value="59">B3</option>
                        <option value="60" selected="">C4</option>
                        <option value="62">D4</option>
                        <option value="64">E4</option>
                        <option value="65">F4</option>
                        <option value="67">G4</option>
                        <option value="69">A4</option>
                        <option value="71">B4</option>
                        <option value="72">C5</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="rangeMax" data-i18n="controls.rangeMax">æœ€é«˜éŸ³</label>
                    <select id="rangeMax">
                        <option value="48">C3</option>
                        <option value="50">D3</option>
                        <option value="52">E3</option>
                        <option value="53">F3</option>
                        <option value="55">G3</option>
                        <option value="57">A3</option>
                        <option value="59">B3</option>
                        <option value="60">C4</option>
                        <option value="62">D4</option>
                        <option value="64">E4</option>
                        <option value="65">F4</option>
                        <option value="67">G4</option>
                        <option value="69">A4</option>
                        <option value="71">B4</option>
                        <option value="72" selected="">C5</option>
                        <option value="74">D5</option>
                        <option value="76">E5</option>
                        <option value="77">F5</option>
                        <option value="79">G5</option>
                        <option value="81">A5</option>
                        <option value="82">B5</option>
                        <option value="83">C6</option>
                        <option value="84">D6</option>
                        <option value="85">E6</option>
                    </select>
                </div>

                <div class="control-group" style="flex: none; width: 140px;">
                    <label for="accidentalRate" data-i18n="controls.accidental">ä¸´æ—¶è®°å·</label>
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <input type="range" id="accidentalRate" min="0" max="100" value="0" step="10" style="width: 90px;">
                        <span id="accidentalRateValue" style="font-weight: 400; min-width: 30px;">0%</span>
                    </div>
                </div>

                <div class="control-group metronome-group" style="flex: none; width: 160px;">
                    <div class="metronome-label-row">
                        <button class="metronome-settings-btn" id="metronomePatternBtn" onclick="openMetronomePatternSettings()" title="èŠ‚æ‹å™¨èŠ‚å¥è®¾ç½®" aria-label="èŠ‚æ‹å™¨èŠ‚å¥è®¾ç½®">
                            âš™ï¸
                        </button>
                        <label for="headerMetronomeBpm" data-i18n="controls.metronome">èŠ‚æ‹å™¨</label>
                    </div>
                    <div class="metronome-control">
                        <input type="number" id="headerMetronomeBpm" min="1" max="999" value="60" class="bpm-input-control">
                        <button class="metronome-play-btn" id="headerMetronomeBtn" onclick="toggleMetronome()" title="å¼€å§‹/åœæ­¢èŠ‚æ‹å™¨">
                            ğŸµ
                        </button>
                        <div class="metronome-beat-indicator" id="headerBeatIndicator"></div>
                    </div>
                </div>
            </div>

            <div class="control-row">
                <div class="buttons">
                    <div id="challengeCountdownUI" style="display:none; align-items: center; gap:6px; margin-right:10px; padding:6px 10px; border:1px solid var(--border-color); border-radius:999px; background: var(--neutral-white); color: var(--text-color); font-size:14px; line-height:1;">
                        <span id="challengeCountdownLabel" data-i18n="challenge.preparingLabel" style="opacity:0.7;">å‡†å¤‡</span>
                        <strong id="challengeCountdownValue">10</strong>
                        <span data-i18n="challenge.seconds" style="opacity:0.7;">ç§’</span>
                    </div>
                    <button class="btn-primary" onclick="generateIntervals()" data-i18n="controls.generateInterval">ç”ŸæˆéŸ³ç¨‹</button>
                    <div id="melody-counter-status"></div>
                    <div class="button-group">
                        <button class="btn-secondary" onclick="previousInterval()" data-i18n="controls.previous" disabled="" style="opacity: 1;">ä¸Šä¸€æ¡</button>
                        <button class="btn-secondary" onclick="nextInterval()" data-i18n="controls.next" disabled="" style="opacity: 1;">ä¸‹ä¸€æ¡</button>
                    </div>
                    <div class="button-group">
                        <button class="btn-secondary" id="playIntervalBtn" onclick="directPlayTest()" data-i18n="controls.play">æ’­æ”¾</button>
                        <button class="melody-visibility-btn" id="intervalVisibilityBtn" onclick="toggleIntervalVisibility()" title="éšè—/æ˜¾ç¤ºéŸ³ç¨‹">
                            ğŸ‘€
                        </button>
                        
                    </div>
                    <div class="button-group">
                        <button class="btn-secondary" onclick="openRhythmSettings()" data-i18n="controls.rhythm">èŠ‚å¥è®¾ç½®</button>
                        <button class="btn-secondary" onclick="openArticulationSettings()" data-i18n="controls.articulation" style="display: none;">æ¼”å¥æŠ€å·§</button>
                    </div>
                    <div class="practice-counter">
                        <label for="practiceCountValue" data-i18n="controls.practiceCounter">ç»ƒä¹ è®¡æ•°</label>
                        <div class="practice-counter-actions">
                            <span id="practiceCountValue">0</span>
                            <button class="btn-secondary" id="practiceCountBtn" onclick="incrementPracticeCount()" data-i18n="controls.practiceAdd">+</button>
                            <button class="btn-secondary" id="practiceResetBtn" onclick="decrementPracticeCount()" data-i18n="controls.practiceReset">-</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="score-container" title="ç‚¹å‡»ä»»æ„ä½ç½®ç”Ÿæˆæ–°éŸ³ç¨‹" style="cursor: pointer;">
            <div id="score" style="cursor: pointer; position: relative;">
                <div class="empty-score-message">
                    <p data-i18n="score.emptyInterval">ç‚¹å‡»ç”ŸæˆéŸ³ç¨‹å¼€å§‹ç»ƒä¹ </p>
                </div>
            </div>
        </div>
        
        <!-- Copyright Information -->
        <div style="
            padding: 5px 0;
            text-align: center;
            font-size: 14px;
            color: var(--neutral-dark);
            opacity: 0.7;
            border-top: 1px solid var(--border-color);
            margin-top: 7.5px;
        ">
            <p style="margin: 0; line-height: 1.5;">
                <strong>Cognote</strong> - ä¸“ä¸šçº§éŸ³ç¨‹è§†å¥ç”Ÿæˆå™¨
            </p>
            <p style="margin: 8px 0 0 0; font-size: 13px; opacity: 0.8;">
                Copyright Â© 2025. All rights reserved. Igor Chen - 
                <a href="https://icstudio.club/" target="_blank" style="color: var(--primary-green); text-decoration: none;">icstudio.club</a>
            </p>
        </div>

    </div>

    <!-- éŸ³ç¨‹ç±»å‹è®¾ç½®å¼¹çª— -->
    <div id="settingsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="settings.title">è®¾ç½®</h3>
                <button class="close-btn" onclick="closeSettingsModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="settings-menu show" id="settingsMenu" style="position: static; opacity: 1; visibility: visible; transform: none; box-shadow: none; border: 0; min-width: 0; background: transparent;">
                    <!-- ä¸»é¢˜è®¾ç½® -->
                    <div class="settings-section">
                        <div class="settings-section-title" data-i18n="settings.theme">ä¸»é¢˜</div>
                        <div class="theme-options">
                            <div class="theme-option" onclick="setTheme('light')">
                                <span class="theme-icon">â˜€ï¸</span>
                                <span data-i18n="settings.lightMode">æµ…è‰²æ¨¡å¼</span>
                            </div>
                            <div class="theme-option" onclick="setTheme('dark')">
                                <span class="theme-icon">ğŸŒ™</span>
                                <span data-i18n="settings.darkMode">æ·±è‰²æ¨¡å¼</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- è¯­è¨€è®¾ç½® -->
                    <div class="settings-section">
                        <div class="settings-section-title" data-i18n="settings.language">è¯­è¨€</div>
                        <div class="language-options">
                            <div class="language-option" onclick="switchLanguage('zh-CN')">
                                ç®€ä½“ä¸­æ–‡
                            </div>
                            <div class="language-option" onclick="switchLanguage('zh-TW')">
                                ç¹é«”ä¸­æ–‡
                            </div>
                            <div class="language-option" onclick="switchLanguage('en')">
                                English
                            </div>
                        </div>
                    </div>

                    <!-- MIDI è¾“å…¥ -->
                    <div class="settings-section" id="midiSettingsSection">
                        <div class="settings-section-title" data-i18n="settings.midi">MIDI è¾“å…¥</div>
                        <div class="midi-settings-row">
                            <span data-i18n="midi.enable">å¯ç”¨</span>
                            <label class="toggle-container">
                                <input type="checkbox" id="midiEnableToggle" class="toggle-input">
                                <span class="toggle-slider"><span class="toggle-button"></span></span>
                            </label>
                        </div>
                        <div class="midi-settings-row" style="flex-direction: column; align-items: stretch;">
                            <label for="midiDeviceSelect" data-i18n="midi.device">è®¾å¤‡</label>
                            <select id="midiDeviceSelect" class="midi-select" disabled>
                                <option value="">-</option>
                            </select>
                        </div>
                        <div class="midi-status" id="midiStatusText" data-i18n="midi.status.disabled">MIDI å·²å…³é—­</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="intervalTypeModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="controls.intervalTypeSettings">éŸ³ç¨‹ç±»å‹è®¾ç½®</h3>
                <button class="close-btn" onclick="closeIntervalTypeSettings()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="interval.basicTypes">åŸºæœ¬éŸ³ç¨‹ç±»å‹</h4>
                        <button class="btn-select-all" onclick="selectAllIntervalTypes()" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;" data-i18n="button.selectAll">å…¨é€‰</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-minor2" value="minor2">
                            <span data-i18n="intervalType.minor2nd">å°äºŒåº¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-major2" value="major2">
                            <span data-i18n="intervalType.major2nd">å¤§äºŒåº¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-minor3" value="minor3" checked="">
                            <span data-i18n="intervalType.minor3rd">å°ä¸‰åº¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-major3" value="major3" checked="">
                            <span data-i18n="intervalType.major3rd">å¤§ä¸‰åº¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-perfect4" value="perfect4" checked="">
                            <span data-i18n="intervalType.perfect4th">å®Œå…¨å››åº¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-tritone" value="tritone">
                            <span data-i18n="intervalType.tritone">å¢å››/å‡äº”åº¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-perfect5" value="perfect5" checked="">
                            <span data-i18n="intervalType.perfect5th">å®Œå…¨äº”åº¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-minor6" value="minor6" checked="">
                            <span data-i18n="intervalType.minor6th">å°å…­åº¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-major6" value="major6" checked="">
                            <span data-i18n="intervalType.major6th">å¤§å…­åº¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-minor7" value="minor7">
                            <span data-i18n="intervalType.minor7th">å°ä¸ƒåº¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-major7" value="major7">
                            <span data-i18n="intervalType.major7th">å¤§ä¸ƒåº¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-octave" value="octave">
                            <span data-i18n="intervalType.octave">å…«åº¦</span>
                        </label>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveIntervalTypeSettings()" data-i18n="button.save">ä¿å­˜è®¾ç½®</button>
                    <button class="btn-secondary" onclick="closeIntervalTypeSettings()" data-i18n="button.cancel">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- èŠ‚å¥è®¾ç½®å¼¹çª— -->
    <div id="rhythmModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="controls.rhythm">èŠ‚å¥è®¾ç½®</h3>
                <button class="close-btn" onclick="closeRhythmSettings()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="rhythm.basicUnits">åŸºæœ¬èŠ‚å¥å•ä½</h4>
                        <button class="btn-select-all" onclick="selectAllRhythms()" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;" data-i18n="button.selectAll">å…¨é€‰</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item" id="rhythm-whole-label" style="display: block;">
                            <input type="checkbox" id="rhythm-whole" value="whole">
                            <span data-i18n="rhythm.whole">å…¨éŸ³ç¬¦</span>
                        </label>
                        <label class="checkbox-item" id="rhythm-dotted-half-label" style="display: none;">
                            <input type="checkbox" id="rhythm-dotted-half" value="half.">
                            <span data-i18n="rhythm.dottedHalf">é™„ç‚¹äºŒåˆ†éŸ³ç¬¦</span>
                        </label>
                        <label class="checkbox-item" id="rhythm-half-label" style="display: block;">
                            <input type="checkbox" id="rhythm-half" value="half" checked="">
                            <span data-i18n="rhythm.half">äºŒåˆ†éŸ³ç¬¦</span>
                        </label>
                        <label class="checkbox-item" id="rhythm-dotted-quarter-label" style="display: none;">
                            <input type="checkbox" id="rhythm-dotted-quarter" value="quarter.">
                            <span data-i18n="rhythm.dottedQuarter">é™„ç‚¹å››åˆ†éŸ³ç¬¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="rhythm-quarter" value="quarter" checked="">
                            <span data-i18n="rhythm.quarter">å››åˆ†éŸ³ç¬¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="rhythm-eighth" value="eighth">
                            <span data-i18n="rhythm.eighth">å…«åˆ†éŸ³ç¬¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="rhythm-16th" value="16th">
                            <span data-i18n="rhythm.sixteenth">åå…­åˆ†éŸ³ç¬¦</span>
                        </label>
                        <label class="checkbox-item" id="rhythm-triplet-label" style="display: flex;">
                            <input type="checkbox" id="rhythm-triplet" value="triplet">
                            <span data-i18n="rhythm.triplet">ä¸‰è¿éŸ³</span>
                        </label>
                        <label class="checkbox-item" id="rhythm-duplet-label" style="display: none;">
                            <input type="checkbox" id="rhythm-duplet" value="duplet">
                            <span data-i18n="rhythm.duplet">äºŒè¿éŸ³</span>
                        </label>
                        <label class="checkbox-item" id="rhythm-quadruplet-label" style="display: none;">
                            <input type="checkbox" id="rhythm-quadruplet" value="quadruplet">
                            <span data-i18n="rhythm.quadruplet">å››è¿éŸ³</span>
                        </label>
                    </div>
                </div>

                <!-- é«˜çº§è®¾ç½®åŒºåŸŸ -->
                <div id="rhythmAdvancedSettings" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 2px solid #e9ecef;">
                    <h4 style="margin-bottom: 15px; color: #495057;" data-i18n="rhythm.advancedFreq">é«˜çº§é¢‘ç‡è®¾ç½®</h4>
                    <p style="font-size: 0.9rem; color: #6c757d; margin-bottom: 20px;" data-i18n="rhythm.freqDesc">è°ƒæ•´å„èŠ‚å¥å•ä½åœ¨æ—‹å¾‹ä¸­çš„å‡ºç°é¢‘ç‡ (0% = ä¸ä½¿ç”¨, 100% = ä¼˜å…ˆä½¿ç”¨)</p>
                    
                    <div class="rhythm-frequency-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="frequency-item" id="freq-whole-item" style="display: block;">
                            <label for="freq-whole" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;" data-i18n="rhythm.freq.whole">å…¨éŸ³ç¬¦é¢‘ç‡:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-whole" min="0" max="100" value="10" style="flex: 1;">
                                <span id="freq-whole-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">10%</span>
                            </div>
                        </div>
                        <div class="frequency-item" id="freq-dotted-half-item" style="display: none;">
                            <label for="freq-dotted-half" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;" data-i18n="rhythm.freq.dottedHalf">é™„ç‚¹äºŒåˆ†éŸ³ç¬¦é¢‘ç‡:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-dotted-half" min="0" max="100" value="15" style="flex: 1;">
                                <span id="freq-dotted-half-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">15%</span>
                            </div>
                        </div>
                        <div class="frequency-item" id="freq-half-item" style="display: block;">
                            <label for="freq-half" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;" data-i18n="rhythm.freq.half">äºŒåˆ†éŸ³ç¬¦é¢‘ç‡:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-half" min="0" max="100" value="30" style="flex: 1;">
                                <span id="freq-half-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">30%</span>
                            </div>
                        </div>
                        <div class="frequency-item" id="freq-dotted-quarter-item" style="display: none;">
                            <label for="freq-dotted-quarter" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;" data-i18n="rhythm.freq.dottedQuarter">é™„ç‚¹å››åˆ†éŸ³ç¬¦é¢‘ç‡:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-dotted-quarter" min="0" max="100" value="35" style="flex: 1;">
                                <span id="freq-dotted-quarter-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">35%</span>
                            </div>
                        </div>
                        <div class="frequency-item">
                            <label for="freq-quarter" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;" data-i18n="rhythm.freq.quarter">å››åˆ†éŸ³ç¬¦é¢‘ç‡:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-quarter" min="0" max="100" value="50" style="flex: 1;">
                                <span id="freq-quarter-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">50%</span>
                            </div>
                        </div>
                        <div class="frequency-item">
                            <label for="freq-eighth" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;" data-i18n="rhythm.freq.eighth">å…«åˆ†éŸ³ç¬¦é¢‘ç‡:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-eighth" min="0" max="100" value="40" style="flex: 1;">
                                <span id="freq-eighth-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">40%</span>
                            </div>
                        </div>
                        <div class="frequency-item">
                            <label for="freq-16th" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;" data-i18n="rhythm.freq.sixteenth">åå…­åˆ†éŸ³ç¬¦é¢‘ç‡:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-16th" min="0" max="100" value="20" style="flex: 1;">
                                <span id="freq-16th-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">20%</span>
                            </div>
                        </div>
                        <div class="frequency-item" id="freq-triplet-item" style="display: block;">
                            <label for="freq-triplet" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;" data-i18n="rhythm.freq.triplet">ä¸‰è¿éŸ³é¢‘ç‡:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-triplet" min="0" max="100" value="15" style="flex: 1;">
                                <span id="freq-triplet-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">15%</span>
                            </div>
                        </div>
                        <div class="frequency-item" id="freq-duplet-item" style="display: none;">
                            <label for="freq-duplet" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;" data-i18n="rhythm.freq.duplet">äºŒè¿éŸ³é¢‘ç‡:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-duplet" min="0" max="100" value="30" style="flex: 1;">
                                <span id="freq-duplet-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">30%</span>
                            </div>
                        </div>
                        <div class="frequency-item" id="freq-quadruplet-item" style="display: none;">
                            <label for="freq-quadruplet" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">å››è¿éŸ³é¢‘ç‡:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-quadruplet" min="0" max="100" value="25" style="flex: 1;">
                                <span id="freq-quadruplet-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">25%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn-secondary" onclick="resetRhythmFrequencies()" style="margin-right: 10px;" data-i18n="button.resetDefault">è¿”å›é»˜è®¤</button>
                    </div>
                </div>
                
                <div class="modal-buttons">
                    <button class="btn-secondary" onclick="toggleRhythmAdvancedSettings()" id="rhythmAdvancedBtn" data-i18n="button.advanced">é«˜çº§è®¾ç½®</button>
                    <button class="btn-primary" onclick="saveRhythmSettings()" data-i18n="button.save">ä¿å­˜è®¾ç½®</button>
                    <button class="btn-secondary" onclick="closeRhythmSettings()" data-i18n="button.cancel">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Articulations å¼¹çª— -->
    <div id="articulationModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="controls.articulation">æ¼”å¥æŠ€å·§</h3>
                <button class="close-btn" onclick="closeArticulationSettings()">Ã—</button>
            </div>
            <div class="modal-body">
                <!-- åŸºæœ¬ArticulationæŠ€å·§ -->
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="articulation.basic.title">åŸºæœ¬æ¼”å¥æ³• (Basic Articulations)</h4>
                        <button class="btn-select-all" onclick="selectAllBasicArticulations()" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">å…¨é€‰</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item" title="æ–­å¥ - éŸ³ç¬¦æ—¶å€¼å‡åŠï¼Œè½»å¿«åœ°æ¼”å¥">
                            <input type="checkbox" id="art-staccato" value="staccato">
                            <span>Staccato (æ–­å¥) â€¢</span>
                        </label>
                        <label class="checkbox-item" title="é‡éŸ³ - å¼ºè°ƒæŸäº›éŸ³ç¬¦">
                            <input type="checkbox" id="art-accent" value="accent">
                            <span>Accent (é‡éŸ³) &gt;</span>
                        </label>
                        <label class="checkbox-item" title="çŸ­å€šéŸ³ - å¿«é€Ÿçš„è£…é¥°éŸ³">
                            <input type="checkbox" id="art-acciaccatura" value="acciaccatura">
                            <span>Acciaccatura (çŸ­å€šéŸ³)</span>
                        </label>
                    </div>
                </div>

                <!-- å‰ä»–ç‰¹æœ‰æŠ€å·§ -->
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4>å‰ä»–æŠ€å·§ (Guitar Techniques)</h4>
                        <button class="btn-select-all" onclick="selectAllGuitarTechniques()" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">å…¨é€‰</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item" title="å‡»å¼¦ - ç”¨å·¦æ‰‹æ•²å‡»äº§ç”ŸéŸ³ç¬¦">
                            <input type="checkbox" id="gtr-hammer" value="hammer-on">
                            <span>Hammer-on (å‡»å¼¦) H</span>
                        </label>
                        <label class="checkbox-item" title="å‹¾å¼¦ - ç”¨å·¦æ‰‹å‹¾ç¦»äº§ç”ŸéŸ³ç¬¦">
                            <input type="checkbox" id="gtr-pull" value="pull-off">
                            <span>Pull-off (å‹¾å¼¦) P</span>
                        </label>
                    </div>
                </div>

                <!-- é«˜çº§è®¾ç½®åŒºåŸŸ -->
                <div id="articulationAdvancedSettings" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 2px solid #e9ecef;">
                    <h4 style="margin-bottom: 15px; color: #495057;" data-i18n="rhythm.advancedFreq">é«˜çº§é¢‘ç‡è®¾ç½®</h4>
                    <p style="font-size: 0.9rem; color: #6c757d; margin-bottom: 20px;" data-i18n="articulation.freqDesc">è°ƒæ•´å„æ¼”å¥æ³•åœ¨æ—‹å¾‹ä¸­çš„å‡ºç°é¢‘ç‡ (0% = ä¸ä½¿ç”¨, 100% = ç»å¸¸ä½¿ç”¨)</p>
                    
                    <div style="margin-bottom: 20px;">
                        <h5 style="color: #495057; margin-bottom: 10px;" data-i18n="articulation.basicFreq">åŸºæœ¬æ¼”å¥æ³•é¢‘ç‡</h5>
                        <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
                            <div class="frequency-item">
                                <label for="freq-staccato" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">Staccato (æ–­å¥) é¢‘ç‡:</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="range" id="freq-staccato" min="0" max="100" value="20" style="flex: 1;">
                                    <span id="freq-staccato-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">20%</span>
                                </div>
                            </div>
                            <div class="frequency-item">
                                <label for="freq-accent" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">Accent (é‡éŸ³) é¢‘ç‡:</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="range" id="freq-accent" min="0" max="100" value="15" style="flex: 1;">
                                    <span id="freq-accent-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">15%</span>
                                </div>
                            </div>
                            <div class="frequency-item">
                                <label for="freq-acciaccatura" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">Acciaccatura (çŸ­å€šéŸ³) é¢‘ç‡:</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="range" id="freq-acciaccatura" min="0" max="100" value="10" style="flex: 1;">
                                    <span id="freq-acciaccatura-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">10%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h5 style="color: #495057; margin-bottom: 10px;">å‰ä»–æŠ€å·§é¢‘ç‡</h5>
                        <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
                            <div class="frequency-item">
                                <label for="freq-slur" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">å‡»å‹¾å¼¦é¢‘ç‡:</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="range" id="freq-slur" min="0" max="100" value="15" style="flex: 1;">
                                    <span id="freq-slur-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">15%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn-secondary" onclick="resetArticulationFrequencies()" style="margin-right: 10px;">è¿”å›é»˜è®¤</button>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-secondary" onclick="toggleArticulationAdvancedSettings()" id="articulationAdvancedBtn" data-i18n="button.advanced">é«˜çº§è®¾ç½®</button>
                    <button class="btn-primary" onclick="saveArticulationSettings()" data-i18n="button.save">ä¿å­˜è®¾ç½®</button>
                    <button class="btn-secondary" onclick="closeArticulationSettings()" data-i18n="button.cancel">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- è°ƒå·è®¾ç½®å¼¹çª— -->
    <div id="keySignatureModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>è°ƒå·è®¾ç½®</h3>
                <button class="close-btn" onclick="closeKeySettings()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="key.majorSection">å¤§è°ƒ (Major)</h4>
                        <button class="btn-select-all" onclick="selectAllMajorKeys()" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;" data-i18n="button.selectAllMajor">å…¨é€‰</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-C" value="C" checked="">
                            <span data-i18n="key.C-major">C å¤§è°ƒ (0#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-G" value="G">
                            <span data-i18n="key.G-major">G å¤§è°ƒ (1#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-D" value="D">
                            <span data-i18n="key.D-major">D å¤§è°ƒ (2#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-A" value="A">
                            <span data-i18n="key.A-major">A å¤§è°ƒ (3#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-E" value="E">
                            <span data-i18n="key.E-major">E å¤§è°ƒ (4#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-B" value="B">
                            <span data-i18n="key.B-major">B å¤§è°ƒ (5#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-F#" value="F#">
                            <span data-i18n="key.Fs-major">F# å¤§è°ƒ (6#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-F" value="F">
                            <span data-i18n="key.F-major">F å¤§è°ƒ (1b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Bb" value="Bb">
                            <span data-i18n="key.Bb-major">Bb å¤§è°ƒ (2b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Eb" value="Eb">
                            <span data-i18n="key.Eb-major">Eb å¤§è°ƒ (3b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Ab" value="Ab">
                            <span data-i18n="key.Ab-major">Ab å¤§è°ƒ (4b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Db" value="Db">
                            <span data-i18n="key.Db-major">Db å¤§è°ƒ (5b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Gb" value="Gb">
                            <span data-i18n="key.Gb-major">Gb å¤§è°ƒ (6b)</span>
                        </label>
                    </div>
                </div>

                <div class="rhythm-section" style="margin-top: 30px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="key.minorSection">å°è°ƒ (Minor)</h4>
                        <button class="btn-select-all" onclick="selectAllMinorKeys()" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;" data-i18n="button.selectAllMinor">å…¨é€‰</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Am" value="Am">
                            <span data-i18n="key.a-minor">A å°è°ƒ (0#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Em" value="Em">
                            <span data-i18n="key.e-minor">E å°è°ƒ (1#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Bm" value="Bm">
                            <span data-i18n="key.b-minor">B å°è°ƒ (2#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-F#m" value="F#m">
                            <span data-i18n="key.fs-minor">F# å°è°ƒ (3#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-C#m" value="C#m">
                            <span data-i18n="key.cs-minor">C# å°è°ƒ (4#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-G#m" value="G#m">
                            <span data-i18n="key.gs-minor">G# å°è°ƒ (5#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-D#m" value="D#m">
                            <span data-i18n="key.ds-minor">D# å°è°ƒ (6#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Dm" value="Dm">
                            <span data-i18n="key.d-minor">D å°è°ƒ (1b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Gm" value="Gm">
                            <span data-i18n="key.g-minor">G å°è°ƒ (2b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Cm" value="Cm">
                            <span data-i18n="key.c-minor">C å°è°ƒ (3b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Fm" value="Fm">
                            <span data-i18n="key.f-minor">F å°è°ƒ (4b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Bbm" value="Bbm">
                            <span data-i18n="key.bb-minor">Bb å°è°ƒ (5b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Ebm" value="Ebm">
                            <span data-i18n="key.eb-minor">Eb å°è°ƒ (6b)</span>
                        </label>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveKeySettings()" data-i18n="button.save">ä¿å­˜è®¾ç½®</button>
                    <button class="btn-secondary" onclick="closeKeySettings()" data-i18n="button.cancel">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ‹å·è®¾ç½®å¼¹çª— -->
    <div id="timeSignatureModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="modal.timeSignature.title">æ‹å·è®¾ç½®</h3>
                <button class="close-btn" onclick="closeTimeSignatureSettings()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="timeSignature.options">æ‹å·é€‰é¡¹</h4>
                        <button class="btn-select-all" onclick="selectAllTimeSignatures()" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;" data-i18n="button.selectAll">å…¨é€‰</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="time-2/4" value="2/4">
                            <span data-i18n="time.2-4">2/4 æ‹</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="time-3/4" value="3/4">
                            <span data-i18n="time.3-4">3/4 æ‹</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="time-4/4" value="4/4" checked="">
                            <span data-i18n="time.4-4">4/4 æ‹</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="time-6/8" value="6/8">
                            <span data-i18n="time.6-8">6/8 æ‹</span>
                        </label>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveTimeSignatureSettings()" data-i18n="button.save">ä¿å­˜è®¾ç½®</button>
                    <button class="btn-secondary" onclick="closeTimeSignatureSettings()" data-i18n="button.cancel">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- éŸ³ç¨‹è·¨åº¦è®¾ç½®å¼¹çª— -->
    <div id="intervalModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>éŸ³ç¨‹è·¨åº¦è®¾ç½®</h3>
                <button class="close-btn" onclick="closeIntervalSettings()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4>æœ€å¤§éŸ³ç¨‹è·¨åº¦é€‰é¡¹</h4>
                        <small style="color: #666; font-size: 12px;">åªèƒ½é€‰æ‹©ä¸€ä¸ªéŸ³ç¨‹ä½œä¸ºæœ€å¤§è·¨åº¦</small>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-1" value="1" onchange="handleIntervalCheckboxChange(this)">
                            <span>å°äºŒåº¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-2" value="2" onchange="handleIntervalCheckboxChange(this)">
                            <span>å¤§äºŒåº¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-3" value="3" onchange="handleIntervalCheckboxChange(this)">
                            <span>å°ä¸‰åº¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-4" value="4" onchange="handleIntervalCheckboxChange(this)">
                            <span>å¤§ä¸‰åº¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-5" value="5" onchange="handleIntervalCheckboxChange(this)">
                            <span>å®Œå…¨å››åº¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-6" value="6" onchange="handleIntervalCheckboxChange(this)">
                            <span>å¢å››åº¦/å‡äº”åº¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-7" value="7" onchange="handleIntervalCheckboxChange(this)">
                            <span>å®Œå…¨äº”åº¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-8" value="8" onchange="handleIntervalCheckboxChange(this)">
                            <span>å°å…­åº¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-9" value="9" onchange="handleIntervalCheckboxChange(this)">
                            <span>å¤§å…­åº¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-10" value="10" onchange="handleIntervalCheckboxChange(this)">
                            <span>å°ä¸ƒåº¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-11" value="11" onchange="handleIntervalCheckboxChange(this)">
                            <span>å¤§ä¸ƒåº¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-12" value="12" checked="" onchange="handleIntervalCheckboxChange(this)">
                            <span>å®Œå…¨å…«åº¦</span>
                        </label>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveIntervalSettings()" data-i18n="button.save">ä¿å­˜è®¾ç½®</button>
                    <button class="btn-secondary" onclick="closeIntervalSettings()" data-i18n="button.cancel">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- è°±å·è®¾ç½®å¼¹çª— -->
    <div id="clefModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="modal.clefSettings">è°±å·è®¾ç½®</h3>
                <button class="close-btn" onclick="closeClefSettings()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="clef.options">è°±å·é€‰é¡¹</h4>
                        <button class="btn-select-all" onclick="selectAllClefs()" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;" data-i18n="button.selectAll">å…¨é€‰</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="clef-treble" value="treble" checked="">
                            <span data-i18n="clef.treble">é«˜éŸ³è°±å· (Gè°±å·)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="clef-bass" value="bass">
                            <span data-i18n="clef.bass">ä½éŸ³è°±å· (Fè°±å·)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="clef-alto" value="alto">
                            <span data-i18n="clef.alto">ä¸­éŸ³è°±å· (Cè°±å·)</span>
                        </label>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveClefSettings()" data-i18n="button.save">ä¿å­˜è®¾ç½®</button>
                    <button class="btn-secondary" onclick="closeClefSettings()" data-i18n="button.cancel">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æŒ‘æˆ˜æ¨¡å¼å¼¹çª— -->
    <div id="challengeModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="modal.challenge.title">æŒ‘æˆ˜æ¨¡å¼</h3>
                <button class="close-btn" onclick="closeChallengeModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="control-row">
                    <div class="control-group">
                        <label for="challengeModeToggleModal" data-i18n="challenge.modeToggle">æŒ‘æˆ˜æ¨¡å¼</label>
                        <label class="switch" style="position: relative; display: inline-block; width: 60px; height: 34px;">
                            <input type="checkbox" id="challengeModeToggleModal" style="opacity: 0; width: 0; height: 0;">
                            <span class="slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: 0.4s; border-radius: 34px;">
                                <span class="slider-button" style="position: absolute; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: 0.4s; border-radius: 50%; transform: translateX(0px);"></span>
                            </span>
                        </label>
                    </div>
                    <div class="control-group">
                        <label for="challengeCalibrationToggle" data-i18n="challenge.calibration">è¾“å…¥æ ¡å‡†</label>
                        <label class="switch" style="position: relative; display: inline-block; width: 60px; height: 34px;">
                            <input type="checkbox" id="challengeCalibrationToggle" style="opacity: 0; width: 0; height: 0;">
                            <span class="slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: 0.4s; border-radius: 34px;">
                                <span class="slider-button" style="position: absolute; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: 0.4s; border-radius: 50%; transform: translateX(0px);"></span>
                            </span>
                        </label>
                    </div>
                </div>
                <div class="control-row">
                    <div class="control-group">
                        <label for="challengePrepTime" data-i18n="challenge.prepTime">å‡†å¤‡æ—¶é—´ï¼ˆç§’ï¼‰</label>
                        <input type="number" id="challengePrepTime" min="0" max="60" step="1" value="10">
                    </div>
                    <div class="control-group">
                        <label for="challengeBPM" data-i18n="challenge.bpm">BPM</label>
                        <input type="number" id="challengeBPM" min="40" max="240" step="1" value="80">
                    </div>
                </div>

                <div class="control-row">
                    <div class="control-group">
                        <label for="challengeCursorToggle" data-i18n="challenge.cursor">å…‰æ ‡</label>
                        <label class="switch" style="position: relative; display: inline-block; width: 60px; height: 34px;">
                            <input type="checkbox" id="challengeCursorToggle" checked style="opacity: 0; width: 0; height: 0;">
                            <span class="slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: 0.4s; border-radius: 34px;">
                                <span class="slider-button" style="position: absolute; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: 0.4s; border-radius: 50%; transform: translateX(0px);"></span>
                            </span>
                        </label>
                    </div>
                    <div class="control-group">
                        <label for="challengeMetronomeToggle" data-i18n="challenge.metronome">èŠ‚æ‹å™¨</label>
                        <label class="switch" style="position: relative; display: inline-block; width: 60px; height: 34px;">
                            <input type="checkbox" id="challengeMetronomeToggle" checked style="opacity: 0; width: 0; height: 0;">
                            <span class="slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: 0.4s; border-radius: 34px;">
                                <span class="slider-button" style="position: absolute; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: 0.4s; border-radius: 50%; transform: translateX(0px);"></span>
                            </span>
                        </label>
                    </div>
                    <div class="control-group">
                        <label for="challengeHideToggle" data-i18n="challenge.hide">éšè—</label>
                        <label class="switch" style="position: relative; display: inline-block; width: 60px; height: 34px;">
                            <input type="checkbox" id="challengeHideToggle" checked style="opacity: 0; width: 0; height: 0;">
                            <span class="slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: 0.4s; border-radius: 34px;">
                                <span class="slider-button" style="position: absolute; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: 0.4s; border-radius: 50%; transform: translateX(0px);"></span>
                            </span>
                        </label>
                    </div>
                </div>

                <p class="modal-hint">
                    <span data-i18n="challenge.cursorHint">å…‰æ ‡å¼€å…³ï¼šå…‰æ ‡ç”¨äºæç¤ºå½“å‰åº”æ¼”å¥çš„ä½ç½®ï¼Œcount-inç»“æŸåå‡ºç°å¹¶éšæ—‹å¾‹è·³åŠ¨ã€‚</span>
                    <span data-i18n="challenge.hideHint" style="display: block; margin-top: 6px;">éšè—å¼€å…³ï¼šå¼€å¯åï¼Œç³»ç»Ÿåœ¨è¿›å…¥ä¸‹ä¸€å°èŠ‚æ—¶ä¼šè‡ªåŠ¨é®æŒ¡ä¸Šä¸€å°èŠ‚ï¼Œä»…ä¿ç•™å½“å‰é˜…è¯»åŒºã€‚</span>
                </p>

                <div class="modal-buttons">
                    <button class="btn-secondary" onclick="cancelChallengeSetup()" data-i18n="button.cancel">å–æ¶ˆ</button>
                    <button class="btn-primary" onclick="confirmChallengeSetup()" data-i18n="button.start">å¼€å§‹</button>
                </div>
            </div>
        </div>
    </div>

    <div id="metronomePatternModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="modal.metronomePattern.title">èŠ‚æ‹å™¨èŠ‚å¥å‹</h3>
                <button class="close-btn" onclick="closeMetronomePatternSettings()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="metronome-pattern-row">
                    <div class="control-group metronome-pattern-toggle-group" style="flex: 1; min-width: 160px;">
                        <div class="toggle-container">
                            <input type="checkbox" id="metronomePatternEnable" class="toggle-input">
                            <label for="metronomePatternEnable" class="toggle-slider">
                                <span class="toggle-button"></span>
                            </label>
                        </div>
                        <label for="metronomePatternEnable" data-i18n="metronomePattern.enable">å¯ç”¨è‡ªå®šä¹‰èŠ‚å¥</label>
                    </div>
                    <div class="control-group" style="flex: 1; min-width: 180px;">
                        <label data-i18n="metronomePattern.subdivision">ç»†åˆ†</label>
                        <select id="metronomePatternSubdivision" class="metronome-pattern-select">
                            <option value="1" data-i18n="metronomePattern.subdivision.beat">æ¯æ‹1ä¸‹</option>
                            <option value="2" data-i18n="metronomePattern.subdivision.eighth">æ¯æ‹2åˆ† (å…«åˆ†)</option>
                            <option value="3" data-i18n="metronomePattern.subdivision.triplet">æ¯æ‹3åˆ† (ä¸‰è¿)</option>
                            <option value="4" data-i18n="metronomePattern.subdivision.sixteenth">æ¯æ‹4åˆ† (åå…­åˆ†)</option>
                        </select>
                    </div>
                    <div class="control-group" style="flex: 1; min-width: 140px;">
                        <label data-i18n="metronomePattern.bars">å°èŠ‚æ•°</label>
                        <select id="metronomePatternBars" class="metronome-pattern-select">
                            <option value="1" data-i18n="metronomePattern.bars.1">1å°èŠ‚</option>
                            <option value="2" data-i18n="metronomePattern.bars.2">2å°èŠ‚</option>
                            <option value="4" data-i18n="metronomePattern.bars.4">4å°èŠ‚</option>
                        </select>
                    </div>
                    <div class="metronome-pattern-info">
                        <span data-i18n="metronomePattern.timeSig">å½“å‰æ‹å·</span>
                        <strong id="metronomePatternTimeSig">4/4</strong>
                    </div>
                </div>

                <div class="metronome-pattern-grid" id="metronomePatternGrid"></div>
                <p class="modal-hint" data-i18n="metronomePattern.hint">ç‚¹å‡»æ–¹æ ¼å¯ç”¨/é™éŸ³èŠ‚æ‹</p>

                <div class="modal-buttons">
                    <button class="btn-secondary" onclick="resetMetronomePattern()" data-i18n="metronomePattern.resetBeats">é‡ç½®ä¸ºæ¯æ‹</button>
                    <button class="btn-secondary" onclick="clearMetronomePattern()" data-i18n="metronomePattern.clear">å…¨éƒ¨é™éŸ³</button>
                    <button class="btn-primary" onclick="saveMetronomePatternSettingsAndClose()" data-i18n="button.saveOnly">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- emergency-fix.js removed - not needed for interval generation -->
    
    <!-- å¢å¼ºçš„å…¨é€‰åˆ‡æ¢åŠŸèƒ½ - å·²é›†æˆåˆ°ä¸»ä»£ç ä¸­ -->
    
    <!-- ä¸»é¢˜åˆ‡æ¢ç³»ç»Ÿ -->
    <script>
        // é¡µé¢æ¨¡å¼æ ‡è¯†
        const pageMode = 'interval';
        
        // ä¸»é¢˜åˆ‡æ¢ç›¸å…³å˜é‡å’ŒåŠŸèƒ½
        let currentTheme = localStorage.getItem('preferredTheme') || 'light';
        
        // ä¸»é¢˜å›¾æ ‡
        const themeIcons = {
            'light': 'ğŸŒ™', // åœ¨lightæ¨¡å¼æ˜¾ç¤ºæœˆäº®å›¾æ ‡ï¼Œç‚¹å‡»åˆ‡æ¢åˆ°dark
            'dark': 'â˜€ï¸'   // åœ¨darkæ¨¡å¼æ˜¾ç¤ºå¤ªé˜³å›¾æ ‡ï¼Œç‚¹å‡»åˆ‡æ¢åˆ°light
        };
        
        // åˆ‡æ¢ä¸»é¢˜ (ä¿ç•™å‘åå…¼å®¹æ€§)
        function toggleTheme() {
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            setTheme(newTheme);
        }
        
        // è®¾ç½®ä¸»é¢˜ (æ–°ç‰ˆæœ¬ï¼Œç”¨äºè®¾ç½®èœå•)
        function setTheme(theme) {
            currentTheme = theme;
            localStorage.setItem('preferredTheme', theme);

            // è®¾ç½®HTMLçš„data-themeå±æ€§
            document.documentElement.setAttribute('data-theme', theme);

            // è§¦å‘ç»Ÿä¸€åŒæ­¥ç³»ç»Ÿ (åŒæ ‡ç­¾é¡µå†…å®æ—¶åŒæ­¥)
            if (window.ICStudioSync) {
                window.ICStudioSync.syncTheme(theme, 'interval-tool');
            }

            // å…³é—­è®¾ç½®å¼¹çª—
            closeSettings();

            if (window.__icMidi && typeof window.__icMidi.refreshStatus === 'function') {
                window.__icMidi.refreshStatus();
            }

        }
        
        // åº”ç”¨ä¸»é¢˜ (ä¿ç•™å‘åå…¼å®¹æ€§)
        function switchTheme(theme) {
            currentTheme = theme;
            localStorage.setItem('preferredTheme', theme);
            
            // è®¾ç½®HTMLçš„data-themeå±æ€§
            document.documentElement.setAttribute('data-theme', theme);
            
            // æ›´æ–°æŒ‰é’®å›¾æ ‡ (å¦‚æœå­˜åœ¨æ—§çš„ä¸»é¢˜åˆ‡æ¢å™¨)
            const themeSwitcher = document.getElementById('themeSwitcher');
            if (themeSwitcher) {
                themeSwitcher.textContent = themeIcons[theme];
            }
            
        }
        
        // è®¾ç½®å¼¹çª—æ§åˆ¶
        function toggleSettings() {
            const modal = document.getElementById('settingsModal');
            const isVisible = modal && (modal.style.display === 'flex' || modal.style.display === 'block');
            
            if (isVisible) {
                closeSettingsModal();
            } else {
                openSettingsModal();
            }
        }
        
        function openSettingsModal() {
            const modal = document.getElementById('settingsModal');
            if (!modal) return;
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        
        function closeSettingsModal() {
            const modal = document.getElementById('settingsModal');
            if (!modal) return;
            modal.style.display = 'none';
            document.body.style.overflow = '';
        }
        
        function closeSettings() {
            closeSettingsModal();
        }
        
        // åŠŸèƒ½é€‰æ‹©å™¨æ§åˆ¶
        function toggleFunctionSelector() {
            const functionMenu = document.getElementById('functionMenu');
            const isVisible = functionMenu.classList.contains('show');
            
            if (isVisible) {
                closeFunctionSelector();
            } else {
                openFunctionSelector();
            }
        }
        
        function openFunctionSelector() {
            const functionMenu = document.getElementById('functionMenu');
            functionMenu.classList.add('show');
            
            // æ·»åŠ ç‚¹å‡»å¤–éƒ¨åŒºåŸŸå…³é—­èœå•çš„ç›‘å¬å™¨
            setTimeout(() => {
                document.addEventListener('click', handleFunctionClickOutside);
            }, 10);
        }
        
        function closeFunctionSelector() {
            const functionMenu = document.getElementById('functionMenu');
            functionMenu.classList.remove('show');
            
            // ç§»é™¤ç‚¹å‡»å¤–éƒ¨åŒºåŸŸçš„ç›‘å¬å™¨
            document.removeEventListener('click', handleFunctionClickOutside);
        }
        
        // å¤„ç†ç‚¹å‡»å¤–éƒ¨åŒºåŸŸå…³é—­åŠŸèƒ½èœå•
        function handleFunctionClickOutside(event) {
            const functionSelector = document.querySelector('.function-selector');
            
            if (functionSelector && !functionSelector.contains(event.target)) {
                closeFunctionSelector();
            }
        }
        
        // å½“å‰åŠŸèƒ½æ¨¡å¼
        let currentFunctionMode = 'interval';
        
        // éŸ³ç¨‹å†å²è®°å½•ç³»ç»Ÿ
        let intervalHistory = [];
        let currentIntervalIndex = -1;
        const MAX_HISTORY_SIZE = 50;
        
        // åˆ‡æ¢åŠŸèƒ½
        function switchFunction(mode) {
            if (mode === 'melody') {
                // å¯¼èˆªåˆ°æ—‹å¾‹è§†å¥é¡µé¢
                window.location.href = 'melody-generator.html';
            } else if (mode === 'jianpu') {
                // å¯¼èˆªåˆ°ç®€è°±è§†å¥é¡µé¢
                window.location.href = 'jianpu-generator.html';
            } else if (mode === 'interval') {
                // å·²ç»åœ¨éŸ³ç¨‹è§†å¥é¡µé¢
                closeFunctionSelector();
                console.log('å·²åœ¨éŸ³ç¨‹è§†å¥æ¨¡å¼');
            } else if (mode === 'chord') {
                // å¯¼èˆªåˆ°å’Œå¼¦è§†å¥é¡µé¢
                window.location.href = 'chord-generator.html';
            } else if (mode === 'rhythm') {
                // å¯¼èˆªåˆ°èŠ‚å¥è§†å¥é¡µé¢
                window.location.href = 'rhythm.html';
            }
        }
        
        // è®¾ç½®å·²æ”¹ä¸ºå¼¹çª—ï¼Œä¸å†ä½¿ç”¨ä¸‹æ‹‰å¤–éƒ¨ç‚¹å‡»å…³é—­

        // èŠ‚æ‹å™¨ç›¸å…³å˜é‡å’ŒåŠŸèƒ½
        let metronomeInterval = null;
        let metronomeAudioContext = null;
        let metronomeOscillator = null;
        let isMetronomeRunning = false;
        let metronomeTempo = 60; // é»˜è®¤60 BPM

        // ğŸ”§ ç²¾ç¡®åŒæ­¥ï¼šè®°å½•èŠ‚æ‹å™¨å¯åŠ¨æ—¶é—´å’Œå½“å‰èŠ‚æ‹
        let metronomeStartTime = null;
        let metronomeCurrentBeat = 0;
        let metronomeSchedulerInterval = null;

        const metronomePatternStorageKey = 'ic_interval_metronome_pattern';
        const metronomeSubdivisionOptions = [1, 2, 3, 4];
        const metronomeBarsOptions = [1, 2, 4];
        let metronomePattern = {
            enabled: false,
            subdivision: 1,
            bars: 1,
            steps: []
        };

        function normalizeMetronomeSubdivision(value) {
            const normalized = parseInt(value, 10);
            return metronomeSubdivisionOptions.includes(normalized) ? normalized : 1;
        }

        function normalizeMetronomeBars(value) {
            const normalized = parseInt(value, 10);
            return metronomeBarsOptions.includes(normalized) ? normalized : 1;
        }

        function buildDefaultMetronomePattern(stepsPerPattern, subdivision) {
            const steps = new Array(stepsPerPattern).fill(0);
            for (let i = 0; i < stepsPerPattern; i += subdivision) {
                steps[i] = 1;
            }
            return steps;
        }

        function ensureMetronomePatternSteps(stepsPerPattern, subdivision) {
            if (!Array.isArray(metronomePattern.steps) || metronomePattern.steps.length !== stepsPerPattern) {
                metronomePattern.steps = buildDefaultMetronomePattern(stepsPerPattern, subdivision);
                saveMetronomePatternSettings();
            }
            metronomePattern.steps = metronomePattern.steps.map(step => (step ? 1 : 0));
            return metronomePattern.steps;
        }

        function loadMetronomePatternSettings() {
            try {
                const raw = localStorage.getItem(metronomePatternStorageKey);
                if (!raw) return;
                const data = JSON.parse(raw);
                if (data && typeof data === 'object') {
                    metronomePattern.enabled = !!data.enabled;
                    metronomePattern.subdivision = normalizeMetronomeSubdivision(data.subdivision);
                    metronomePattern.bars = normalizeMetronomeBars(data.bars);
                    metronomePattern.steps = Array.isArray(data.steps) ? data.steps.map(step => (step ? 1 : 0)) : [];
                }
            } catch (error) {
                console.warn('âš ï¸ èŠ‚æ‹å™¨èŠ‚å¥å‹è¯»å–å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®', error);
            }
        }

        function saveMetronomePatternSettings() {
            try {
                const payload = {
                    enabled: !!metronomePattern.enabled,
                    subdivision: normalizeMetronomeSubdivision(metronomePattern.subdivision),
                    bars: normalizeMetronomeBars(metronomePattern.bars),
                    steps: Array.isArray(metronomePattern.steps) ? metronomePattern.steps.map(step => (step ? 1 : 0)) : []
                };
                localStorage.setItem(metronomePatternStorageKey, JSON.stringify(payload));
            } catch (error) {
                console.warn('âš ï¸ èŠ‚æ‹å™¨èŠ‚å¥å‹ä¿å­˜å¤±è´¥', error);
            }
        }

        function getMetronomeTimeSignatureInfo() {
            let beats = 4;
            let den = 4;
            try {
                if (typeof userSettings !== 'undefined' && Array.isArray(userSettings.allowedTimeSignatures) && userSettings.allowedTimeSignatures.length === 1) {
                    const parts = String(userSettings.allowedTimeSignatures[0]).split('/');
                    beats = parseInt(parts[0] || '4', 10) || beats;
                    den = parseInt(parts[1] || '4', 10) || den;
                    return { beats, den };
                }
                if (typeof window !== 'undefined' && window.currentTimeSignature) {
                    const parts = String(window.currentTimeSignature).split('/');
                    beats = parseInt(parts[0] || '4', 10) || beats;
                    den = parseInt(parts[1] || '4', 10) || den;
                }
            } catch (error) {
                console.warn('âš ï¸ æ— æ³•è¯»å–å½“å‰æ‹å·ï¼Œä½¿ç”¨é»˜è®¤4/4æ‹', error);
            }
            return { beats, den };
        }

        function getMetronomePatternInfo(tempoOverride) {
            const tempo = Math.max(1, tempoOverride || metronomeTempo);
            if (!metronomePattern.enabled) {
                return {
                    usePattern: false,
                    stepDuration: 60.0 / tempo
                };
            }

            const tsInfo = getMetronomeTimeSignatureInfo();
            const subdivision = normalizeMetronomeSubdivision(metronomePattern.subdivision);
            const bars = normalizeMetronomeBars(metronomePattern.bars);
            const beatDuration = (60.0 / tempo) * (4 / tsInfo.den);
            const stepDuration = beatDuration / subdivision;
            const stepsPerBar = tsInfo.beats * subdivision;
            const stepsPerPattern = stepsPerBar * bars;
            const steps = ensureMetronomePatternSteps(stepsPerPattern, subdivision);

            return {
                usePattern: true,
                stepDuration,
                stepsPerBar,
                stepsPerPattern,
                steps,
                subdivision,
                bars
            };
        }

        function restartMetronomeIfRunning() {
            if (isMetronomeRunning) {
                stopMetronome();
                startMetronome();
            }
        }

        function updateMetronomePatternTimeSig() {
            const label = document.getElementById('metronomePatternTimeSig');
            if (!label) return;
            const tsInfo = getMetronomeTimeSignatureInfo();
            label.textContent = `${tsInfo.beats}/${tsInfo.den}`;
        }

        function renderMetronomePatternGrid() {
            const grid = document.getElementById('metronomePatternGrid');
            if (!grid) return;
            const tsInfo = getMetronomeTimeSignatureInfo();
            const subdivision = normalizeMetronomeSubdivision(metronomePattern.subdivision);
            const bars = normalizeMetronomeBars(metronomePattern.bars);
            const stepsPerBar = tsInfo.beats * subdivision;
            const stepsPerPattern = stepsPerBar * bars;
            const steps = ensureMetronomePatternSteps(stepsPerPattern, subdivision);

            grid.classList.toggle('disabled', !metronomePattern.enabled);
            grid.style.gridTemplateColumns = `repeat(${stepsPerBar}, minmax(32px, 1fr))`;
            grid.style.gridAutoFlow = 'row';
            grid.innerHTML = '';

            for (let i = 0; i < stepsPerPattern; i++) {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'metronome-pattern-step';
                if (steps[i]) btn.classList.add('active');
                if (i % subdivision === 0) btn.classList.add('beat-start');
                if (i % stepsPerBar === 0) btn.classList.add('bar-start');
                btn.dataset.step = String(i);
                btn.setAttribute('aria-pressed', steps[i] ? 'true' : 'false');
                if (i % subdivision === 0) {
                    const beatNumber = (Math.floor(i / subdivision) % tsInfo.beats) + 1;
                    btn.textContent = String(beatNumber);
                } else {
                    btn.textContent = '';
                }
                grid.appendChild(btn);
            }
        }

        function updateMetronomePatternUI() {
            const enableToggle = document.getElementById('metronomePatternEnable');
            const subdivisionSelect = document.getElementById('metronomePatternSubdivision');
            const barsSelect = document.getElementById('metronomePatternBars');

            if (enableToggle) enableToggle.checked = !!metronomePattern.enabled;
            if (subdivisionSelect) subdivisionSelect.value = String(normalizeMetronomeSubdivision(metronomePattern.subdivision));
            if (barsSelect) barsSelect.value = String(normalizeMetronomeBars(metronomePattern.bars));

            updateMetronomePatternTimeSig();
            renderMetronomePatternGrid();
        }

        function openMetronomePatternSettings() {
            const modal = document.getElementById('metronomePatternModal');
            if (!modal) return;
            updateMetronomePatternUI();
            modal.style.display = 'flex';
        }

        function closeMetronomePatternSettings() {
            const modal = document.getElementById('metronomePatternModal');
            if (modal) modal.style.display = 'none';
        }

        function saveMetronomePatternSettingsAndClose() {
            saveMetronomePatternSettings();
            closeMetronomePatternSettings();
        }

        function resetMetronomePattern() {
            const tsInfo = getMetronomeTimeSignatureInfo();
            const subdivision = normalizeMetronomeSubdivision(metronomePattern.subdivision);
            const bars = normalizeMetronomeBars(metronomePattern.bars);
            const stepsPerPattern = tsInfo.beats * subdivision * bars;
            metronomePattern.steps = buildDefaultMetronomePattern(stepsPerPattern, subdivision);
            saveMetronomePatternSettings();
            renderMetronomePatternGrid();
            restartMetronomeIfRunning();
        }

        function clearMetronomePattern() {
            const tsInfo = getMetronomeTimeSignatureInfo();
            const subdivision = normalizeMetronomeSubdivision(metronomePattern.subdivision);
            const bars = normalizeMetronomeBars(metronomePattern.bars);
            const stepsPerPattern = tsInfo.beats * subdivision * bars;
            metronomePattern.steps = new Array(stepsPerPattern).fill(0);
            saveMetronomePatternSettings();
            renderMetronomePatternGrid();
            restartMetronomeIfRunning();
        }

        function initializeMetronomePatternUI() {
            loadMetronomePatternSettings();
            const enableToggle = document.getElementById('metronomePatternEnable');
            const subdivisionSelect = document.getElementById('metronomePatternSubdivision');
            const barsSelect = document.getElementById('metronomePatternBars');
            const grid = document.getElementById('metronomePatternGrid');

            if (enableToggle) {
                enableToggle.checked = !!metronomePattern.enabled;
                enableToggle.addEventListener('change', function() {
                    metronomePattern.enabled = !!this.checked;
                    saveMetronomePatternSettings();
                    renderMetronomePatternGrid();
                    restartMetronomeIfRunning();
                });
            }

            if (subdivisionSelect) {
                subdivisionSelect.value = String(normalizeMetronomeSubdivision(metronomePattern.subdivision));
                subdivisionSelect.addEventListener('change', function() {
                    metronomePattern.subdivision = normalizeMetronomeSubdivision(this.value);
                    updateMetronomePatternUI();
                    saveMetronomePatternSettings();
                    restartMetronomeIfRunning();
                });
            }

            if (barsSelect) {
                barsSelect.value = String(normalizeMetronomeBars(metronomePattern.bars));
                barsSelect.addEventListener('change', function() {
                    metronomePattern.bars = normalizeMetronomeBars(this.value);
                    updateMetronomePatternUI();
                    saveMetronomePatternSettings();
                    restartMetronomeIfRunning();
                });
            }

            if (grid) {
                grid.addEventListener('click', function(event) {
                    const target = event.target.closest('button[data-step]');
                    if (!target) return;
                    const index = parseInt(target.dataset.step, 10);
                    if (isNaN(index)) return;
                    if (!metronomePattern.enabled) {
                        metronomePattern.enabled = true;
                        if (enableToggle) enableToggle.checked = true;
                        grid.classList.remove('disabled');
                    }
                    metronomePattern.steps[index] = metronomePattern.steps[index] ? 0 : 1;
                    target.classList.toggle('active', !!metronomePattern.steps[index]);
                    target.setAttribute('aria-pressed', metronomePattern.steps[index] ? 'true' : 'false');
                    saveMetronomePatternSettings();
                    restartMetronomeIfRunning();
                });
            }

            updateMetronomePatternUI();
        }

        // ğŸ”§ å…³é”®ä¿®å¤ï¼šä½¿ç”¨ä¸éŸ³ç¨‹æ’­æ”¾ç›¸åŒçš„ AudioContext
        function initializeMetronomeAudio() {
            try {
                // ä¼˜å…ˆä½¿ç”¨éŸ³ç¨‹æ’­æ”¾çš„ AudioContext
                if (window.intervalAudioCtx) {
                    metronomeAudioContext = window.intervalAudioCtx;
                    console.log('ğŸµ èŠ‚æ‹å™¨ä½¿ç”¨éŸ³ç¨‹çš„ AudioContextï¼ˆå…±äº«æ—¶é’Ÿï¼‰');
                } else {
                    metronomeAudioContext = new (window.AudioContext || window.webkitAudioContext)();
                    // åå‘å…±äº«ï¼šè®©éŸ³ç¨‹ä¹Ÿä½¿ç”¨è¿™ä¸ª AudioContext
                    window.intervalAudioCtx = metronomeAudioContext;
                    console.log('ğŸµ èŠ‚æ‹å™¨åˆ›å»ºæ–° AudioContextï¼ˆå…±äº«ç»™éŸ³ç¨‹ï¼‰');
                }
                return true;
            } catch (error) {
                console.error('âŒ Web Audio API ä¸æ”¯æŒ:', error);
                return false;
            }
        }

        // æ’­æ”¾èŠ‚æ‹å™¨å£°éŸ³ - æ”¯æŒç²¾ç¡®è°ƒåº¦
        function playMetronomeSound(time) {
            if (!metronomeAudioContext) {
                if (!initializeMetronomeAudio()) return;
            }

            try {
                // æ¢å¤éŸ³é¢‘ä¸Šä¸‹æ–‡ï¼ˆç”¨æˆ·äº¤äº’åï¼‰
                if (metronomeAudioContext.state === 'suspended') {
                    metronomeAudioContext.resume();
                }

                // ğŸ”§ ä½¿ç”¨ä¼ å…¥çš„ç²¾ç¡®æ—¶é—´ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨å½“å‰æ—¶é—´
                const scheduleTime = time !== undefined ? time : metronomeAudioContext.currentTime;

                const oscillator = metronomeAudioContext.createOscillator();
                const gainNode = metronomeAudioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(metronomeAudioContext.destination);

                // ä½¿ç”¨æ–¹æ³¢å’Œè‡ªç„¶éŸ³é«˜ (å‚è€ƒNiceChordèŠ‚æ‹å™¨)
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(523.25, scheduleTime); // C5éŸ³é«˜

                // è®¾ç½®è‡ªç„¶çš„éŸ³é‡åŒ…ç»œ (æ›´å¥½çš„release time)
                gainNode.gain.setValueAtTime(0.5, scheduleTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, scheduleTime + 0.05);

                oscillator.start(scheduleTime);
                oscillator.stop(scheduleTime + 0.05);

                // è§†è§‰åé¦ˆ - æ›´æ–°headeræŒ‡ç¤ºå™¨ï¼ˆåªåœ¨ç«‹å³æ’­æ”¾æ—¶ï¼‰
                if (time === undefined || scheduleTime <= metronomeAudioContext.currentTime + 0.05) {
                    const headerIndicator = document.getElementById('headerBeatIndicator');

                    if (headerIndicator) {
                        headerIndicator.classList.add('beat');
                        setTimeout(() => {
                            headerIndicator.classList.remove('beat');
                        }, 150);
                    }
                }

            } catch (error) {
                console.error('âŒ èŠ‚æ‹å™¨å£°éŸ³æ’­æ”¾å¤±è´¥:', error);
            }
        }

        // è®¾ç½®èŠ‚æ‹å™¨é€Ÿåº¦
        function setMetronomeTempo(bpm) {
            metronomeTempo = Math.max(1, Math.min(999, bpm));

            // åŒæ­¥æ›´æ–°headerè¾“å…¥æ¡†
            const headerInput = document.getElementById('headerMetronomeBpm');
            if (headerInput) headerInput.value = metronomeTempo;

            // å¦‚æœèŠ‚æ‹å™¨æ­£åœ¨è¿è¡Œï¼Œé‡æ–°å¯åŠ¨ä»¥åº”ç”¨æ–°é€Ÿåº¦
            if (isMetronomeRunning) {
                stopMetronome();
                startMetronome();
            }
        }

        // ğŸ”§ ç²¾ç¡®èŠ‚æ‹å™¨è°ƒåº¦å™¨ - ä½¿ç”¨ Web Audio API æ—¶é’Ÿ
        function scheduleMetronomeBeat() {
            if (!metronomeAudioContext) {
                if (!initializeMetronomeAudio()) return;
            }

            const patternInfo = getMetronomePatternInfo(metronomeTempo);
            const stepDuration = patternInfo.usePattern ? patternInfo.stepDuration : (60.0 / metronomeTempo);
            const scheduleAheadTime = 0.2; // è°ƒåº¦æœªæ¥ 200ms çš„èŠ‚æ‹

            while (metronomeStartTime + metronomeCurrentBeat * stepDuration <
                   metronomeAudioContext.currentTime + scheduleAheadTime) {

                const beatTime = metronomeStartTime + metronomeCurrentBeat * stepDuration;

                let shouldPlay = true;
                if (patternInfo.usePattern && patternInfo.stepsPerPattern) {
                    const stepIndex = metronomeCurrentBeat % patternInfo.stepsPerPattern;
                    shouldPlay = patternInfo.steps[stepIndex] === 1;
                }

                if (shouldPlay) {
                    playMetronomeSound(beatTime);
                }

                metronomeCurrentBeat++;
            }
        }

        // å¯åŠ¨èŠ‚æ‹å™¨ - ä½¿ç”¨ç²¾ç¡® Web Audio API è°ƒåº¦
        function startMetronome() {
            loadMetronomePatternSettings();
            const headerInput = document.getElementById('headerMetronomeBpm');
            const tempo = parseInt(headerInput ? headerInput.value : metronomeTempo) || 60;
            metronomeTempo = tempo;

            // åŒæ­¥æ›´æ–°headerè¾“å…¥æ¡†
            if (headerInput) headerInput.value = metronomeTempo;

            if (isMetronomeRunning) return;

            if (!metronomeAudioContext) {
                if (!initializeMetronomeAudio()) return;
            }

            // æ¢å¤éŸ³é¢‘ä¸Šä¸‹æ–‡
            if (metronomeAudioContext.state === 'suspended') {
                metronomeAudioContext.resume();
            }

            isMetronomeRunning = true;

            // ğŸ”§ å…³é”®ä¿®å¤ï¼šä½¿ç”¨ AudioContext æ—¶é—´ 0 ä½œä¸ºå…¨å±€èŠ‚æ‹ç½‘æ ¼çš„èµ·ç‚¹
            metronomeStartTime = 0; // å…¨å±€ç½‘æ ¼èµ·ç‚¹

            const patternInfo = getMetronomePatternInfo(metronomeTempo);
            const beatDuration = patternInfo.usePattern ? patternInfo.stepDuration : (60.0 / metronomeTempo);
            const now = metronomeAudioContext.currentTime;

            // è®¡ç®—å½“å‰åº”è¯¥åœ¨ç¬¬å‡ æ‹ï¼ˆä»æ—¶é—´ 0 å¼€å§‹ï¼‰
            const currentBeatNumber = Math.floor(now / beatDuration);
            const nextBeatNumber = currentBeatNumber + 1;
            const nextBeatTime = nextBeatNumber * beatDuration;

            // ç¡®ä¿ä¸‹ä¸€æ‹è‡³å°‘åœ¨æœªæ¥ 50msï¼Œå¦åˆ™è·³è¿‡
            const minLookahead = 0.05;
            if (nextBeatTime < now + minLookahead) {
                metronomeCurrentBeat = nextBeatNumber + 1;
            } else {
                metronomeCurrentBeat = nextBeatNumber;
            }

            console.log(`ğŸµ èŠ‚æ‹å™¨å¯¹é½å…¨å±€ç½‘æ ¼: ${metronomeTempo} BPM, å½“å‰=${now.toFixed(3)}s, ä»ç¬¬${metronomeCurrentBeat}æ‹å¼€å§‹ (æ—¶é—´=${(metronomeCurrentBeat * beatDuration).toFixed(3)}s)`);

            // ç«‹å³è°ƒåº¦ç¬¬ä¸€æ‰¹èŠ‚æ‹
            scheduleMetronomeBeat();

            // ğŸ”§ ä½¿ç”¨æ›´é¢‘ç¹çš„å®šæ—¶å™¨æ¥æ£€æŸ¥å’Œè°ƒåº¦ï¼ˆ25msï¼‰ï¼Œè€Œä¸æ˜¯ç”¨å®ƒæ¥æ’­æ”¾å£°éŸ³
            metronomeSchedulerInterval = setInterval(scheduleMetronomeBeat, 25);

            // æ›´æ–°UI
            updateMetronomeUI();
        }

        // ä¸æ’­æ”¾å†…å®¹åŒæ­¥çš„èŠ‚æ‹å™¨å¯åŠ¨
        function synchronizeMetronomeWithPlayback(interval) {
            const currentTime = performance.now();
            const playbackElapsed = currentTime - window.intervalPlaybackStartTime; // æ’­æ”¾å·²ç»è¿‡å»çš„æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰

            // ğŸµ è®°å½•èŠ‚æ‹å™¨å¯åŠ¨æ—¶é—´ï¼Œç”¨äºåŒæ­¥è®¡ç®—
            window.metronomeStartTime = currentTime;

            // è·å–æ’­æ”¾å†…å®¹çš„æ‹å·ä¿¡æ¯
            const timeSignature = window.intervalPlaybackTimeSignature || { beats: 4, beatType: 4 };
            const beatsPerMeasure = timeSignature.beats;

            // è®¡ç®—å½“å‰åœ¨å“ªä¸€æ‹ï¼ˆåŸºäºå››åˆ†éŸ³ç¬¦ï¼‰
            const beatDurationMs = interval; // æ¯æ‹çš„æ¯«ç§’æ•°
            const currentBeatPosition = (playbackElapsed / beatDurationMs) % beatsPerMeasure;
            const currentBeatNumber = Math.floor(currentBeatPosition) + 1; // 1-based
            const positionInBeat = currentBeatPosition % 1; // åœ¨å½“å‰æ‹å†…çš„ä½ç½®ï¼ˆ0-1ï¼‰

            console.log(`  - æ’­æ”¾å·²è¿›è¡Œ: ${(playbackElapsed/1000).toFixed(2)}ç§’`);
            console.log(`  - å½“å‰æ‹ä½ç½®: ${currentBeatPosition.toFixed(3)} (ç¬¬${currentBeatNumber}æ‹)`);
            console.log(`  - æ‹å†…ä½ç½®: ${(positionInBeat*100).toFixed(1)}%`);

            // è®¡ç®—åˆ°ä¸‹ä¸€ä¸ªæ•´æ‹çš„æ—¶é—´
            const timeToNextBeat = (1 - positionInBeat) * beatDurationMs;

            if (timeToNextBeat < 50) {
                // å¦‚æœè·ç¦»ä¸‹ä¸€æ‹å¾ˆè¿‘ï¼ˆ<50msï¼‰ï¼Œç«‹å³æ’­æ”¾
                playMetronomeSound();

                // è®¾ç½®å®šæ—¶å™¨ä»ä¸‹ä¸€æ‹å¼€å§‹
                metronomeInterval = setInterval(() => {
                    playMetronomeSound();
                }, interval);
            } else {
                // å»¶è¿Ÿåˆ°ä¸‹ä¸€æ‹å¼€å§‹

                // å»¶è¿Ÿåˆ°ä¸‹ä¸€æ‹
                setTimeout(() => {
                    if (isMetronomeRunning) { // ç¡®ä¿ç”¨æˆ·æ²¡æœ‰å–æ¶ˆ
                        playMetronomeSound();

                        // è®¾ç½®å®šæ—¶å™¨
                        metronomeInterval = setInterval(() => {
                            playMetronomeSound();
                        }, interval);
                    }
                }, timeToNextBeat);
            }
        }

        // åœæ­¢èŠ‚æ‹å™¨
        function stopMetronome() {
            if (metronomeInterval) {
                clearInterval(metronomeInterval);
                metronomeInterval = null;
            }

            // ğŸ”§ æ¸…é™¤è°ƒåº¦å™¨å®šæ—¶å™¨
            if (metronomeSchedulerInterval) {
                clearInterval(metronomeSchedulerInterval);
                metronomeSchedulerInterval = null;
            }

            isMetronomeRunning = false;

            // é‡ç½®èŠ‚æ‹è®¡æ•°
            metronomeStartTime = null;
            metronomeCurrentBeat = 0;

            updateMetronomeUI();

            console.log('ğŸ”‡ èŠ‚æ‹å™¨å·²åœæ­¢');
        }

        // åˆ‡æ¢èŠ‚æ‹å™¨å¼€å…³
        function toggleMetronome() {
            if (isMetronomeRunning) {
                stopMetronome();
            } else {
                startMetronome();
            }
        }

        // æ›´æ–°èŠ‚æ‹å™¨UI
        function updateMetronomeUI() {
            const headerToggleBtn = document.getElementById('headerMetronomeBtn');
            
            // æ›´æ–°headerä¸­çš„æŒ‰é’®
            if (headerToggleBtn) {
                if (isMetronomeRunning) {
                    headerToggleBtn.classList.add('active');
                    headerToggleBtn.textContent = 'ğŸµ';
                    headerToggleBtn.title = 'åœæ­¢èŠ‚æ‹å™¨';
                } else {
                    headerToggleBtn.classList.remove('active');
                    headerToggleBtn.textContent = 'ğŸµ';
                    headerToggleBtn.title = 'å¼€å§‹èŠ‚æ‹å™¨';
                }
            }
        }

        // ç›‘å¬headerä¸­BPMè¾“å…¥æ¡†çš„å˜åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            const headerSpeedInput = document.getElementById('headerMetronomeBpm');
            
            if (headerSpeedInput) {
                // å®æ—¶è¾“å…¥éªŒè¯
                headerSpeedInput.addEventListener('input', function() {
                    let value = parseInt(this.value);
                    
                    // é™åˆ¶èŒƒå›´
                    if (value < 1) {
                        this.value = 1;
                        value = 1;
                    } else if (value > 999) {
                        this.value = 999;
                        value = 999;
                    }
                    
                    if (!isNaN(value)) {
                        setMetronomeTempo(value);
                    }
                });
                
                // Enteré”®ç¡®è®¤
                headerSpeedInput.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        this.blur(); // å¤±å»ç„¦ç‚¹ï¼Œè§¦å‘éªŒè¯
                    }
                });
                
                // å¤±å»ç„¦ç‚¹æ—¶éªŒè¯
                headerSpeedInput.addEventListener('blur', function() {
                    let value = parseInt(this.value);
                    
                    if (isNaN(value) || value < 1) {
                        this.value = 1;
                        value = 1;
                    } else if (value > 999) {
                        this.value = 999;
                        value = 999;
                    }
                    
                    setMetronomeTempo(value);
                });

                // BPMæ‹–åŠ¨åŠŸèƒ½å®ç°
                let isDragging = false;
                let startY = 0;
                let startValue = 0;
                let dragTimeout = null;
                let hasStartedDrag = false;
                
                const handleDragStart = function(event) {
                    // åªå¤„ç†å·¦é”®ç‚¹å‡»
                    if (event.button !== 0) return;
                    
                    startY = event.clientY;
                    startValue = parseInt(this.value) || 60;
                    hasStartedDrag = false;
                    
                    console.log('BPMæ‹–åŠ¨: é¼ æ ‡æŒ‰ä¸‹', startValue);
                    
                    // é•¿æŒ‰80msåå¯åŠ¨æ‹–åŠ¨æ¨¡å¼
                    dragTimeout = setTimeout(() => {
                        isDragging = true;
                        hasStartedDrag = true;
                        
                        console.log('BPMæ‹–åŠ¨: å¯åŠ¨æ‹–åŠ¨æ¨¡å¼');
                        
                        // é˜²æ­¢æ–‡æœ¬é€‰æ‹©å’Œé»˜è®¤è¡Œä¸º
                        event.preventDefault();
                        document.body.style.userSelect = 'none';
                        document.body.style.webkitUserSelect = 'none';
                        document.body.style.mozUserSelect = 'none';
                        document.body.style.msUserSelect = 'none';
                        
                        // æ·»åŠ æ‹–åŠ¨ä¸­çš„è§†è§‰åé¦ˆ
                        this.style.cursor = 'ns-resize';
                        this.classList.add('dragging');
                        this.blur(); // å¤±å»ç„¦ç‚¹ï¼Œé¿å…é”®ç›˜è¾“å…¥å¹²æ‰°
                    }, 80);
                };
                
                // é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶
                headerSpeedInput.addEventListener('mousedown', handleDragStart);
                
                // è§¦æ§/è§¦ç¬”æ”¯æŒï¼ˆé¿å…æ— æ³•æ‹–åŠ¨ï¼‰
                if ('PointerEvent' in window) {
                    headerSpeedInput.addEventListener('pointerdown', function(event) {
                        if (event.pointerType === 'mouse') return;
                        handleDragStart.call(this, event);
                    });
                }
                
                // é¼ æ ‡ç§»åŠ¨äº‹ä»¶ - ç»‘å®šåˆ°å…¨å±€
                const handleMouseMove = function(event) {
                    if (!isDragging || !hasStartedDrag) return;
                    
                    const deltaY = startY - event.clientY; // å‘ä¸Šä¸ºæ­£ï¼Œå‘ä¸‹ä¸ºè´Ÿ
                    const sensitivity = 1; // æ‹–åŠ¨çµæ•åº¦ï¼Œæ¯1åƒç´ æ”¹å˜1ä¸ªBPM
                    const newValue = Math.max(1, Math.min(999, startValue + Math.round(deltaY / sensitivity)));
                    
                    console.log('BPMæ‹–åŠ¨: ç§»åŠ¨ä¸­', deltaY, newValue);
                    
                    headerSpeedInput.value = newValue;
                    setMetronomeTempo(newValue);
                    
                    // é˜»æ­¢é»˜è®¤è¡Œä¸º
                    event.preventDefault();
                    event.stopPropagation();
                };
                
                // é¼ æ ‡é‡Šæ”¾äº‹ä»¶ - ç»‘å®šåˆ°å…¨å±€
                const handleMouseUp = function(event) {
                    console.log('BPMæ‹–åŠ¨: é¼ æ ‡é‡Šæ”¾', isDragging);
                    
                    // æ¸…é™¤é•¿æŒ‰è®¡æ—¶å™¨
                    if (dragTimeout) {
                        clearTimeout(dragTimeout);
                        dragTimeout = null;
                    }
                    
                    if (isDragging && hasStartedDrag) {
                        isDragging = false;
                        hasStartedDrag = false;
                        
                        // æ¢å¤æ–‡æœ¬é€‰æ‹©
                        document.body.style.userSelect = '';
                        document.body.style.webkitUserSelect = '';
                        document.body.style.mozUserSelect = '';
                        document.body.style.msUserSelect = '';
                        
                        // ç§»é™¤è§†è§‰åé¦ˆ
                        headerSpeedInput.style.cursor = '';
                        headerSpeedInput.classList.remove('dragging');
                        
                        console.log('BPMæ‹–åŠ¨: ç»“æŸæ‹–åŠ¨æ¨¡å¼');
                    }
                };
                
                // ç»‘å®šå…¨å±€äº‹ä»¶
                document.addEventListener('mousemove', handleMouseMove, true);
                document.addEventListener('mouseup', handleMouseUp, true);
                if ('PointerEvent' in window) {
                    document.addEventListener('pointermove', function(event) {
                        if (event.pointerType === 'mouse') return;
                        handleMouseMove(event);
                    }, true);
                    document.addEventListener('pointerup', function(event) {
                        if (event.pointerType === 'mouse') return;
                        handleMouseUp(event);
                    }, true);
                    document.addEventListener('pointercancel', function(event) {
                        if (event.pointerType === 'mouse') return;
                        handleMouseUp(event);
                    }, true);
                }
                
                // é¼ æ ‡ç¦»å¼€è¾“å…¥æ¡†æ—¶å–æ¶ˆé•¿æŒ‰
                headerSpeedInput.addEventListener('mouseleave', function(event) {
                    if (dragTimeout && !isDragging) {
                        clearTimeout(dragTimeout);
                        dragTimeout = null;
                        console.log('BPMæ‹–åŠ¨: é¼ æ ‡ç¦»å¼€ï¼Œå–æ¶ˆé•¿æŒ‰');
                    }
                });
                
                // é˜²æ­¢å³é”®èœå•å¹²æ‰°
                headerSpeedInput.addEventListener('contextmenu', function(event) {
                    if (isDragging) {
                        event.preventDefault();
                    }
                });
            }

            initializeMetronomePatternUI();
            
            // ç›‘å¬ä¸´æ—¶è®°å·æ»‘å—å˜åŒ–
            const accidentalSlider = document.getElementById('accidentalRate');
            const accidentalValue = document.getElementById('accidentalRateValue');

            if (accidentalSlider && accidentalValue) {
                accidentalSlider.addEventListener('input', function() {
                    accidentalValue.textContent = this.value + '%';
                });
            }

            // ğŸ¼ æ™ºèƒ½è°±å·-éŸ³åŸŸç»‘å®šç³»ç»Ÿï¼šæ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            function initClefRangeBinding() {
                // ç»Ÿä¸€ä½¿ç”¨å…¨å±€ intervalSettings å®ä¾‹ï¼Œé¿å…é‡å¤åˆ›å»º
                if (typeof window.intervalSettings === 'undefined') {
                    // å¦‚æœå…¨å±€å˜é‡ä¸å­˜åœ¨ï¼Œæš‚æ—¶åˆ›å»ºï¼Œä½†ä¼˜å…ˆä½¿ç”¨å·²å­˜åœ¨çš„å®ä¾‹
                    if (typeof intervalSettings !== 'undefined') {
                        window.intervalSettings = intervalSettings;
                    } else {
                        window.intervalSettings = new IntervalSettings();
                    }
                }

                // è°±å·å¤é€‰æ¡†äº‹ä»¶ç›‘å¬
                const clefCheckboxes = document.querySelectorAll('#clefModal input[type="checkbox"]');

                clefCheckboxes.forEach((checkbox, index) => {

                    checkbox.addEventListener('change', function() {

                        if (this.checked) {
                            // ä¿å­˜å½“å‰éŸ³åŸŸåˆ°ä¹‹å‰çš„è°±å·
                            const currentMin = document.getElementById('rangeMin')?.value;
                            const currentMax = document.getElementById('rangeMax')?.value;
                            if (currentMin && currentMax) {
                                // æ‰¾åˆ°ä¹‹å‰é€‰ä¸­çš„è°±å·
                                const previouslyChecked = Array.from(clefCheckboxes).find(cb =>
                                    cb !== this && cb.checked
                                );
                                if (previouslyChecked) {
                                    window.intervalSettings.setClefRange(previouslyChecked.value, parseInt(currentMin), parseInt(currentMax));
                                }
                            }

                            // å–æ¶ˆå…¶ä»–è°±å·é€‰æ‹©ï¼ˆç¡®ä¿åªé€‰æ‹©ä¸€ä¸ªï¼‰
                            clefCheckboxes.forEach(cb => {
                                if (cb !== this && cb.checked) {
                                    console.log(`ğŸ”„ å–æ¶ˆé€‰æ‹©è°±å·: ${cb.value}`);
                                    cb.checked = false;
                                }
                            });

                            // å¤„ç†è°±å·å˜åŒ–
                            window.intervalSettings.onClefChange(this.value);
                        }
                    });
                });

                // éŸ³åŸŸé€‰æ‹©å™¨äº‹ä»¶ç›‘å¬
                const rangeMinSelect = document.getElementById('rangeMin');
                const rangeMaxSelect = document.getElementById('rangeMax');

                if (rangeMinSelect) {
                    rangeMinSelect.addEventListener('change', function() {
                        console.log('ğŸšï¸ æœ€ä½éŸ³å‘ç”Ÿå˜åŒ–:', this.value);
                        if (window.intervalSettings && typeof window.intervalSettings.onRangeChange === 'function') {
                            window.intervalSettings.onRangeChange();
                        } else {
                            console.warn('âš ï¸ intervalSettings.onRangeChange ä¸å¯ç”¨');
                        }
                    });
                }

                if (rangeMaxSelect) {
                    rangeMaxSelect.addEventListener('change', function() {
                        console.log('ğŸšï¸ æœ€é«˜éŸ³å‘ç”Ÿå˜åŒ–:', this.value);
                        if (window.intervalSettings && typeof window.intervalSettings.onRangeChange === 'function') {
                            window.intervalSettings.onRangeChange();
                        } else {
                            console.warn('âš ï¸ intervalSettings.onRangeChange ä¸å¯ç”¨');
                        }
                    });
                }

                // åˆå§‹åŒ–UIï¼šè®¾ç½®å½“å‰è°±å·å¯¹åº”çš„é»˜è®¤éŸ³åŸŸ
                setTimeout(() => {
                    const currentClef = window.intervalSettings.getClef();
                    console.log(`ğŸ”„ é¡µé¢åŠ è½½åˆå§‹åŒ–: ${currentClef} è°±å·`);

                    // è®¾ç½®åˆå§‹è°±å·è®°å½•
                    window.intervalSettings.lastSelectedClef = currentClef;

                    // ç¡®ä¿å…ƒç´ å·²ç»å®Œå…¨åŠ è½½
                    const rangeMinSelect = document.getElementById('rangeMin');
                    const rangeMaxSelect = document.getElementById('rangeMax');

                    if (rangeMinSelect && rangeMaxSelect) {

                        // ğŸ¯ é¡µé¢åŠ è½½æ—¶æ€»æ˜¯ä½¿ç”¨é»˜è®¤éŸ³åŸŸï¼Œä¸ä½¿ç”¨ä¿å­˜çš„è®¾ç½®
                        const defaultRange = window.intervalSettings.getClefDefaultRange(currentClef);

                        rangeMinSelect.value = defaultRange.min.toString();
                        rangeMaxSelect.value = defaultRange.max.toString();

                    } else {
                        console.error('âŒ åˆå§‹åŒ–æ—¶æ— æ³•æ‰¾åˆ°éŸ³åŸŸé€‰æ‹©å™¨');
                    }
                }, 100); // ç»™DOMä¸€ç‚¹æ—¶é—´å®Œå…¨åˆå§‹åŒ–


                // æ·»åŠ æµ‹è¯•å‡½æ•°åˆ°å…¨å±€ä½œç”¨åŸŸï¼ˆè°ƒè¯•ç”¨ï¼‰
                window.testClefRangeBinding = function() {
                    console.log('ğŸ§ª æµ‹è¯•è°±å·-éŸ³åŸŸç»‘å®šåŠŸèƒ½');
                    const settings = window.intervalSettings;

                    console.log('ğŸ§ª æµ‹è¯•1: åˆ‡æ¢åˆ°ä½éŸ³è°±å·');
                    document.getElementById('clef-bass').checked = true;
                    document.getElementById('clef-treble').checked = false;
                    settings.updateRangeUIForClef('bass');

                    setTimeout(() => {
                        console.log('ğŸ§ª æµ‹è¯•2: åˆ‡æ¢åˆ°é«˜éŸ³è°±å·');
                        document.getElementById('clef-treble').checked = true;
                        document.getElementById('clef-bass').checked = false;
                        settings.updateRangeUIForClef('treble');
                    }, 2000);
                };

                // æ·»åŠ éšæœºé€‰æ‹©æµ‹è¯•å‡½æ•°
                window.testRandomClefSelection = function() {
                    console.log('ğŸ§ª æµ‹è¯•éšæœºè°±å·é€‰æ‹©åŠŸèƒ½');
                    const settings = window.intervalSettings;

                    // å‹¾é€‰å¤šä¸ªè°±å·
                    document.getElementById('clef-treble').checked = true;
                    document.getElementById('clef-bass').checked = true;
                    document.getElementById('clef-alto').checked = true;

                    console.log('ğŸ§ª å·²å‹¾é€‰æ‰€æœ‰è°±å·ï¼Œå¼€å§‹å¤šæ¬¡è°ƒç”¨getCurrentSettings()');

                    // å¤šæ¬¡è°ƒç”¨getCurrentSettings()æ¥æ¨¡æ‹Ÿç”ŸæˆéŸ³ç¨‹
                    for (let i = 0; i < 5; i++) {
                        setTimeout(() => {
                            console.log(`ğŸ§ª ç¬¬${i + 1}æ¬¡è°ƒç”¨getCurrentSettings()`);
                            const currentSettings = settings.getCurrentSettings();
                            console.log(`ğŸ§ª æœ¬æ¬¡é€‰ä¸­çš„è°±å·: ${currentSettings.clef}`);
                        }, i * 1000);
                    }
                };

                // ğŸµ æ·»åŠ ç´§æ€¥æ’­æ”¾æµ‹è¯•åŠŸèƒ½
                window.emergencyPlayTest = function() {

                    // åˆ›å»ºä¸€ä¸ªç®€å•çš„æµ‹è¯•éŸ³ç¨‹æ•°æ®
                    const testProgression = {
                        measures: [
                            {
                                index: 0,
                                lowerVoice: [
                                    { type: 'note', pitch: 'C4', duration: 1.0 }
                                ],
                                upperVoice: [
                                    { type: 'note', pitch: 'E4', duration: 1.0 }
                                ]
                            }
                        ],
                        tempo: 120,
                        timeSignature: { beats: 4, beatType: 4 },
                        keySignature: 'C'
                    };

                    window.currentIntervalProgression = testProgression;

                    try {
                        directPlayTest();
                    } catch (error) {
                        console.error('ğŸµğŸš¨ æ’­æ”¾æµ‹è¯•å¤±è´¥:', error);
                    }
                };

                // ğŸ­ æ·»åŠ éšè—æ¨¡å¼æµ‹è¯•åŠŸèƒ½
                window.testHiddenModeWithCountIn = function() {

                    // å¼€å¯éšè—æ¨¡å¼
                    if (!isIntervalHidden) {
                        toggleIntervalVisibility();
                    }

                    // åˆ›å»ºæµ‹è¯•æ•°æ®
                    const testProgression = {
                        measures: [
                            {
                                index: 0,
                                lowerVoice: [
                                    { type: 'note', pitch: 'C4', duration: 1.0 }
                                ],
                                upperVoice: [
                                    { type: 'note', pitch: 'E4', duration: 1.0 }
                                ]
                            }
                        ],
                        tempo: 120,
                        timeSignature: { beats: 4, beatType: 4 },
                        keySignature: 'C'
                    };

                    window.currentIntervalProgression = testProgression;

                    directPlayTest();
                };
            }

            // åˆå§‹åŒ–ç»‘å®šç³»ç»Ÿ
            initClefRangeBinding();
        });
        
        // åˆå§‹åŒ–ä¸»é¢˜
        function initializeTheme() {
            switchTheme(currentTheme);
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–ä¸»é¢˜
        document.addEventListener('DOMContentLoaded', function() {
            initializeTheme();
        });
    </script>

    <!-- å¤šè¯­è¨€ç³»ç»Ÿ -->
    <script>
        // å¤šè¯­è¨€ç¿»è¯‘å¯¹è±¡
        const translations = {
            'zh-CN': {
                'app.title': 'Cognote - éŸ³ç¨‹è§†å¥ç”Ÿæˆå™¨',
                'app.subtitle': 'ä¸“ä¸šçº§ä¹è°±æ¸²æŸ“ä¸éŸ³ä¹ç†è®ºå·¥å…·',
                'app.melodyMode': 'æ—‹å¾‹è§†å¥',
                'app.intervalMode': 'éŸ³ç¨‹è§†å¥',
                'app.jianpuMode': 'ç®€è°±è§†å¥',
                'app.chordMode': 'å’Œå¼¦è§†å¥',
                'app.rhythmMode': 'èŠ‚å¥è§†å¥',
                'controls.intervalType': 'éŸ³ç¨‹ç±»å‹',
                'controls.intervalTypeSettings': 'éŸ³ç¨‹ç±»å‹è®¾ç½®',
                'controls.measures': 'å°èŠ‚æ•°',
                'controls.measures2': '2å°èŠ‚',
                'controls.measures4': '4å°èŠ‚',
                'controls.measures8': '8å°èŠ‚',
                'controls.key': 'è°ƒå·',
                'controls.keySettings': 'è°ƒå·è®¾ç½®',
                'controls.time': 'æ‹å·',
                'controls.timeSettings': 'æ‹å·è®¾ç½®',
                'controls.clef': 'è°±å·',
                'controls.clefSettings': 'è°±å·è®¾ç½®',
                'controls.mode': 'æ¨¡å¼',
                'mode.free': 'è‡ªç”±',
                'mode.challenge': 'æŒ‘æˆ˜',
                'modal.clefSettings': 'è°±å·è®¾ç½®',
                'clef.options': 'è°±å·é€‰é¡¹',
                'clef.treble': 'é«˜éŸ³è°±å· (Gè°±å·)',
                'clef.bass': 'ä½éŸ³è°±å· (Fè°±å·)',
                'clef.alto': 'ä¸­éŸ³è°±å· (Cè°±å·)',
                'key.majorSection': 'å¤§è°ƒ (Major)',
                'key.minorSection': 'å°è°ƒ (Minor)',
                'controls.rangeMin': 'æœ€ä½éŸ³',
                'controls.rangeMax': 'æœ€é«˜éŸ³',
                'controls.accidental': 'ä¸´æ—¶è®°å·',
                'controls.metronome': 'èŠ‚æ‹å™¨',
                'controls.metronomePattern': 'èŠ‚æ‹å™¨èŠ‚å¥å‹',
                'controls.generateInterval': 'ç”ŸæˆéŸ³ç¨‹',
                'controls.previous': 'ä¸Šä¸€æ¡',
                'controls.next': 'ä¸‹ä¸€æ¡',
                'controls.rhythm': 'èŠ‚å¥è®¾ç½®',
                'controls.articulation': 'æ¼”å¥æŠ€å·§',
                'controls.practiceCounter': 'ç»ƒä¹ è®¡æ•°',
                'controls.practiceAdd': '+',
                'controls.practiceReset': '-',
                'controls.play': 'æ’­æ”¾',
                'score.emptyInterval': 'ç‚¹å‡»ç”ŸæˆéŸ³ç¨‹å¼€å§‹ç»ƒä¹ ',
                'settings.title': 'è®¾ç½®',
                'settings.theme': 'ä¸»é¢˜',
                'settings.language': 'è¯­è¨€',
                'settings.lightMode': 'æµ…è‰²æ¨¡å¼',
                'settings.darkMode': 'æ·±è‰²æ¨¡å¼',
                'settings.midi': 'MIDI è¾“å…¥',
                'midi.enable': 'å¯ç”¨',
                'midi.device': 'è®¾å¤‡',
                'midi.status.unsupported': 'å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ MIDI',
                'midi.status.permission': 'æœªæˆæƒ MIDI è®¿é—®',
                'midi.status.nodevice': 'æœªæ£€æµ‹åˆ° MIDI è®¾å¤‡',
                'midi.status.connected': 'å·²è¿æ¥: {device}',
                'midi.status.disconnected': 'è®¾å¤‡å·²æ–­å¼€',
                'midi.status.disabled': 'MIDI å·²å…³é—­',
                'settings.metronome': 'èŠ‚æ‹å™¨',
                'settings.tempo': 'é€Ÿåº¦ (BPM)',
                'settings.startMetronome': 'å¼€å§‹èŠ‚æ‹å™¨',
                'settings.stopMetronome': 'åœæ­¢èŠ‚æ‹å™¨',
                'modal.challenge.title': 'æŒ‘æˆ˜æ¨¡å¼',
                'modal.metronomePattern.title': 'èŠ‚æ‹å™¨èŠ‚å¥å‹',
                'metronomePattern.enable': 'å¯ç”¨è‡ªå®šä¹‰èŠ‚å¥',
                'metronomePattern.subdivision': 'ç»†åˆ†',
                'metronomePattern.subdivision.beat': 'æ¯æ‹1ä¸‹',
                'metronomePattern.subdivision.eighth': 'æ¯æ‹2åˆ† (å…«åˆ†)',
                'metronomePattern.subdivision.triplet': 'æ¯æ‹3åˆ† (ä¸‰è¿)',
                'metronomePattern.subdivision.sixteenth': 'æ¯æ‹4åˆ† (åå…­åˆ†)',
                'metronomePattern.bars': 'å°èŠ‚æ•°',
                'metronomePattern.bars.1': '1å°èŠ‚',
                'metronomePattern.bars.2': '2å°èŠ‚',
                'metronomePattern.bars.4': '4å°èŠ‚',
                'metronomePattern.timeSig': 'å½“å‰æ‹å·',
                'metronomePattern.hint': 'ç‚¹å‡»æ–¹æ ¼å¯ç”¨/é™éŸ³èŠ‚æ‹',
                'metronomePattern.resetBeats': 'é‡ç½®ä¸ºæ¯æ‹',
                'metronomePattern.clear': 'å…¨éƒ¨é™éŸ³',
                'challenge.prepTime': 'å‡†å¤‡æ—¶é—´ï¼ˆç§’ï¼‰',
                'challenge.bpm': 'BPM',
                'challenge.cursor': 'å…‰æ ‡',
                'challenge.metronome': 'èŠ‚æ‹å™¨',
                'challenge.hide': 'éšè—',
                'challenge.modeToggle': 'æŒ‘æˆ˜æ¨¡å¼',
                'challenge.calibration': 'è¾“å…¥æ ¡å‡†',
                'challenge.cursorHint': 'å…‰æ ‡å¼€å…³ï¼šå…‰æ ‡ç”¨äºæç¤ºå½“å‰åº”æ¼”å¥çš„ä½ç½®ï¼Œcount-inç»“æŸåå‡ºç°å¹¶éšæ—‹å¾‹è·³åŠ¨ã€‚',
                'challenge.hideHint': 'éšè—å¼€å…³ï¼šå¼€å¯åï¼Œç³»ç»Ÿåœ¨è¿›å…¥ä¸‹ä¸€å°èŠ‚æ—¶ä¼šè‡ªåŠ¨é®æŒ¡ä¸Šä¸€å°èŠ‚ï¼Œä»…ä¿ç•™å½“å‰é˜…è¯»åŒºã€‚',
                'challenge.preparingLabel': 'å‡†å¤‡',
                'challenge.seconds': 'ç§’',
                'button.start': 'å¼€å§‹',
                'button.saveOnly': 'ä¿å­˜',
                // è°ƒå·ï¼ˆå«å‡é™å·æ•°é‡ï¼‰
                'key.C-major': 'C å¤§è°ƒ (0#)',
                'key.G-major': 'G å¤§è°ƒ (1#)',
                'key.D-major': 'D å¤§è°ƒ (2#)',
                'key.A-major': 'A å¤§è°ƒ (3#)',
                'key.E-major': 'E å¤§è°ƒ (4#)',
                'key.B-major': 'B å¤§è°ƒ (5#)',
                'key.Fs-major': 'F# å¤§è°ƒ (6#)',
                'key.F-major': 'F å¤§è°ƒ (1b)',
                'key.Bb-major': 'Bb å¤§è°ƒ (2b)',
                'key.Eb-major': 'Eb å¤§è°ƒ (3b)',
                'key.Ab-major': 'Ab å¤§è°ƒ (4b)',
                'key.Db-major': 'Db å¤§è°ƒ (5b)',
                'key.Gb-major': 'Gb å¤§è°ƒ (6b)',
                'key.a-minor': 'A å°è°ƒ (0#)',
                'key.e-minor': 'E å°è°ƒ (1#)',
                'key.b-minor': 'B å°è°ƒ (2#)',
                'key.fs-minor': 'F# å°è°ƒ (3#)',
                'key.cs-minor': 'C# å°è°ƒ (4#)',
                'key.gs-minor': 'G# å°è°ƒ (5#)',
                'key.ds-minor': 'D# å°è°ƒ (6#)',
                'key.d-minor': 'D å°è°ƒ (1b)',
                'key.g-minor': 'G å°è°ƒ (2b)',
                'key.c-minor': 'C å°è°ƒ (3b)',
                'key.f-minor': 'F å°è°ƒ (4b)',
                'key.bb-minor': 'Bb å°è°ƒ (5b)',
                'key.eb-minor': 'Eb å°è°ƒ (6b)',
                // èŠ‚å¥ç±»å‹
                'rhythm.whole': 'å…¨éŸ³ç¬¦',
                'rhythm.dottedHalf': 'é™„ç‚¹äºŒåˆ†éŸ³ç¬¦',
                'rhythm.half': 'äºŒåˆ†éŸ³ç¬¦',
                'rhythm.dottedQuarter': 'é™„ç‚¹å››åˆ†éŸ³ç¬¦',
                'rhythm.quarter': 'å››åˆ†éŸ³ç¬¦',
                'rhythm.eighth': 'å…«åˆ†éŸ³ç¬¦',
                'rhythm.sixteenth': 'åå…­åˆ†éŸ³ç¬¦',
                'rhythm.triplet': 'ä¸‰è¿éŸ³',
                'rhythm.duplet': 'äºŒè¿éŸ³',
                'rhythm.quadruplet': 'å››è¿éŸ³',
                // å¼¹çª—æŒ‰é’®
                'button.save': 'ä¿å­˜è®¾ç½®',
                'button.cancel': 'å–æ¶ˆ',
                'button.close': 'å…³é—­',
                'button.selectAll': 'å…¨é€‰',
                'button.selectAllMajor': 'å…¨é€‰',
                'button.selectAllMinor': 'å…¨é€‰',
                'button.advanced': 'é«˜çº§è®¾ç½®',
                'button.hideAdvanced': 'éšè—é«˜çº§è®¾ç½®',
                'button.resetDefault': 'è¿”å›é»˜è®¤',
                'rhythm.advancedFreq': 'é«˜çº§é¢‘ç‡è®¾ç½®',
                'interval.basicTypes': 'åŸºæœ¬éŸ³ç¨‹ç±»å‹',
                'rhythm.basicUnits': 'åŸºæœ¬èŠ‚å¥å•ä½',
                'rhythm.freq.dottedQuarter': 'é™„ç‚¹å››åˆ†éŸ³ç¬¦é¢‘ç‡:',
                'rhythm.freq.quarter': 'å››åˆ†éŸ³ç¬¦é¢‘ç‡:',
                'rhythm.freq.eighth': 'å…«åˆ†éŸ³ç¬¦é¢‘ç‡:',
                'rhythm.freq.sixteenth': 'åå…­åˆ†éŸ³ç¬¦é¢‘ç‡:',
                'articulation.basic.title': 'åŸºæœ¬æ¼”å¥æ³• (Basic Articulations)',
                'articulation.freqDesc': 'è°ƒæ•´å„æ¼”å¥æ³•åœ¨æ—‹å¾‹ä¸­çš„å‡ºç°é¢‘ç‡ (0% = ä¸ä½¿ç”¨, 100% = ç»å¸¸ä½¿ç”¨)',
                'articulation.basicFreq': 'åŸºæœ¬æ¼”å¥æ³•é¢‘ç‡',
                'rhythm.freqDesc': 'è°ƒæ•´å„èŠ‚å¥å•ä½åœ¨æ—‹å¾‹ä¸­çš„å‡ºç°é¢‘ç‡ (0% = ä¸ä½¿ç”¨, 100% = ä¼˜å…ˆä½¿ç”¨)',
                'rhythm.freq.whole': 'å…¨éŸ³ç¬¦é¢‘ç‡:',
                'rhythm.freq.dottedHalf': 'é™„ç‚¹äºŒåˆ†éŸ³ç¬¦é¢‘ç‡:',
                'rhythm.freq.half': 'äºŒåˆ†éŸ³ç¬¦é¢‘ç‡:',
                'rhythm.freq.triplet': 'ä¸‰è¿éŸ³é¢‘ç‡:',
                'rhythm.freq.duplet': 'äºŒè¿éŸ³é¢‘ç‡:',
                // Interval types in type settings
                'intervalType.minor2nd': 'å°äºŒåº¦',
                'intervalType.major2nd': 'å¤§äºŒåº¦',
                'intervalType.minor3rd': 'å°ä¸‰åº¦',
                'intervalType.major3rd': 'å¤§ä¸‰åº¦',
                'intervalType.perfect4th': 'å®Œå…¨å››åº¦',
                'intervalType.tritone': 'å¢å››/å‡äº”åº¦',
                'intervalType.perfect5th': 'å®Œå…¨äº”åº¦',
                'intervalType.minor6th': 'å°å…­åº¦',
                'intervalType.major6th': 'å¤§å…­åº¦',
                'intervalType.minor7th': 'å°ä¸ƒåº¦',
                'intervalType.major7th': 'å¤§ä¸ƒåº¦',
                'intervalType.octave': 'å…«åº¦',
                'modal.timeSignature.title': 'æ‹å·è®¾ç½®',
                'timeSignature.options': 'æ‹å·é€‰é¡¹',
                'time.2-4': '2/4 æ‹',
                'time.3-4': '3/4 æ‹',
                'time.4-4': '4/4 æ‹',
                'time.6-8': '6/8 æ‹'
            },
            'zh-TW': {
                'app.title': 'Cognote - éŸ³ç¨‹è¦–å¥ç”Ÿæˆå™¨',
                'app.subtitle': 'å°ˆæ¥­ç´šæ¨‚è­œæ¸²æŸ“èˆ‡éŸ³æ¨‚ç†è«–å·¥å…·',
                'app.melodyMode': 'æ—‹å¾‹è¦–å¥',
                'app.intervalMode': 'éŸ³ç¨‹è¦–å¥',
                'app.jianpuMode': 'ç°¡è­œè¦–å¥',
                'app.chordMode': 'å’Œå¼¦è¦–å¥',
                'app.rhythmMode': 'ç¯€å¥è¦–å¥',
                'controls.intervalType': 'éŸ³ç¨‹é¡å‹',
                'controls.intervalTypeSettings': 'éŸ³ç¨‹é¡å‹è¨­ç½®',
                'controls.measures': 'å°ç¯€æ•¸',
                'controls.measures2': '2å°ç¯€',
                'controls.measures4': '4å°ç¯€',
                'controls.measures8': '8å°ç¯€',
                'controls.key': 'èª¿è™Ÿ',
                'controls.keySettings': 'èª¿è™Ÿè¨­ç½®',
                'controls.time': 'æ‹è™Ÿ',
                'controls.timeSettings': 'æ‹è™Ÿè¨­ç½®',
                'controls.clef': 'è­œè™Ÿ',
                'controls.clefSettings': 'è­œè™Ÿè¨­ç½®',
                'controls.mode': 'æ¨¡å¼',
                'mode.free': 'è‡ªç”±',
                'mode.challenge': 'æŒ‘æˆ°',
                'modal.clefSettings': 'è­œè™Ÿè¨­ç½®',
                'clef.options': 'è­œè™Ÿé¸é …',
                'clef.treble': 'é«˜éŸ³è­œè™Ÿ (Gè­œè™Ÿ)',
                'clef.bass': 'ä½éŸ³è­œè™Ÿ (Fè­œè™Ÿ)',
                'clef.alto': 'ä¸­éŸ³è­œè™Ÿ (Cè­œè™Ÿ)',
                'key.majorSection': 'å¤§èª¿ (Major)',
                'key.minorSection': 'å°èª¿ (Minor)',
                'controls.rangeMin': 'æœ€ä½éŸ³',
                'controls.rangeMax': 'æœ€é«˜éŸ³',
                'controls.accidental': 'è‡¨æ™‚è¨˜è™Ÿ',
                'controls.metronome': 'ç¯€æ‹å™¨',
                'controls.metronomePattern': 'ç¯€æ‹å™¨ç¯€å¥å‹',
                'controls.generateInterval': 'ç”ŸæˆéŸ³ç¨‹',
                'controls.previous': 'ä¸Šä¸€æ¢',
                'controls.next': 'ä¸‹ä¸€æ¢',
                'controls.rhythm': 'ç¯€å¥è¨­ç½®',
                'controls.articulation': 'æ¼”å¥æŠ€å·§',
                'controls.practiceCounter': 'ç·´ç¿’è¨ˆæ•¸',
                'controls.practiceAdd': '+',
                'controls.practiceReset': '-',
                'controls.play': 'æ’­æ”¾',
                'score.emptyInterval': 'é»æ“Šç”ŸæˆéŸ³ç¨‹é–‹å§‹ç·´ç¿’',
                'settings.title': 'è¨­ç½®',
                'settings.theme': 'ä¸»é¡Œ',
                'settings.language': 'èªè¨€',
                'settings.lightMode': 'æ·ºè‰²æ¨¡å¼',
                'settings.darkMode': 'æ·±è‰²æ¨¡å¼',
                'settings.midi': 'MIDI è¼¸å…¥',
                'midi.enable': 'å•Ÿç”¨',
                'midi.device': 'è£ç½®',
                'midi.status.unsupported': 'ç›®å‰ç€è¦½å™¨ä¸æ”¯æ´ MIDI',
                'midi.status.permission': 'æœªæˆæ¬Š MIDI å­˜å–',
                'midi.status.nodevice': 'æœªåµæ¸¬åˆ° MIDI è£ç½®',
                'midi.status.connected': 'å·²é€£æ¥: {device}',
                'midi.status.disconnected': 'è£ç½®å·²æ–·é–‹',
                'midi.status.disabled': 'MIDI å·²é—œé–‰',
                'settings.metronome': 'ç¯€æ‹å™¨',
                'settings.tempo': 'é€Ÿåº¦ (BPM)',
                'settings.startMetronome': 'é–‹å§‹ç¯€æ‹å™¨',
                'settings.stopMetronome': 'åœæ­¢ç¯€æ‹å™¨',
                'modal.challenge.title': 'æŒ‘æˆ°æ¨¡å¼',
                'modal.metronomePattern.title': 'ç¯€æ‹å™¨ç¯€å¥å‹',
                'metronomePattern.enable': 'å•Ÿç”¨è‡ªè¨‚ç¯€å¥',
                'metronomePattern.subdivision': 'ç´°åˆ†',
                'metronomePattern.subdivision.beat': 'æ¯æ‹1ä¸‹',
                'metronomePattern.subdivision.eighth': 'æ¯æ‹2åˆ† (å…«åˆ†)',
                'metronomePattern.subdivision.triplet': 'æ¯æ‹3åˆ† (ä¸‰é€£)',
                'metronomePattern.subdivision.sixteenth': 'æ¯æ‹4åˆ† (åå…­åˆ†)',
                'metronomePattern.bars': 'å°ç¯€æ•¸',
                'metronomePattern.bars.1': '1å°ç¯€',
                'metronomePattern.bars.2': '2å°ç¯€',
                'metronomePattern.bars.4': '4å°ç¯€',
                'metronomePattern.timeSig': 'ç›®å‰æ‹è™Ÿ',
                'metronomePattern.hint': 'é»æ“Šæ–¹æ ¼å•Ÿç”¨/éœéŸ³ç¯€æ‹',
                'metronomePattern.resetBeats': 'é‡ç½®ç‚ºæ¯æ‹',
                'metronomePattern.clear': 'å…¨éƒ¨éœéŸ³',
                'challenge.prepTime': 'æº–å‚™æ™‚é–“ï¼ˆç§’ï¼‰',
                'challenge.bpm': 'BPM',
                'challenge.cursor': 'å…‰æ¨™',
                'challenge.metronome': 'ç¯€æ‹å™¨',
                'challenge.hide': 'éš±è—',
                'challenge.modeToggle': 'æŒ‘æˆ°æ¨¡å¼',
                'challenge.calibration': 'è¼¸å…¥æ ¡æº–',
                'challenge.cursorHint': 'å…‰æ¨™é–‹é—œï¼šå…‰æ¨™ç”¨æ–¼æç¤ºç›®å‰æ‡‰æ¼”å¥çš„ä½ç½®ï¼Œcount-inçµæŸå¾Œå‡ºç¾ä¸¦éš¨æ—‹å¾‹è·³å‹•ã€‚',
                'challenge.hideHint': 'éš±è—é–‹é—œï¼šé–‹å•Ÿå¾Œï¼Œç³»çµ±åœ¨é€²å…¥ä¸‹ä¸€å°ç¯€æ™‚æœƒè‡ªå‹•é®æ“‹ä¸Šä¸€å°ç¯€ï¼Œåƒ…ä¿ç•™ç•¶å‰é–±è®€å€ã€‚',
                'challenge.preparingLabel': 'æº–å‚™',
                'challenge.seconds': 'ç§’',
                'button.start': 'é–‹å§‹',
                'button.saveOnly': 'å„²å­˜',
                // èª¿è™Ÿï¼ˆå«å‡é™è™Ÿæ•¸é‡ï¼‰
                'key.C-major': 'C å¤§èª¿ (0#)',
                'key.G-major': 'G å¤§èª¿ (1#)',
                'key.D-major': 'D å¤§èª¿ (2#)',
                'key.A-major': 'A å¤§èª¿ (3#)',
                'key.E-major': 'E å¤§èª¿ (4#)',
                'key.B-major': 'B å¤§èª¿ (5#)',
                'key.Fs-major': 'F# å¤§èª¿ (6#)',
                'key.F-major': 'F å¤§èª¿ (1b)',
                'key.Bb-major': 'Bb å¤§èª¿ (2b)',
                'key.Eb-major': 'Eb å¤§èª¿ (3b)',
                'key.Ab-major': 'Ab å¤§èª¿ (4b)',
                'key.Db-major': 'Db å¤§èª¿ (5b)',
                'key.Gb-major': 'Gb å¤§èª¿ (6b)',
                'key.a-minor': 'A å°èª¿ (0#)',
                'key.e-minor': 'E å°èª¿ (1#)',
                'key.b-minor': 'B å°èª¿ (2#)',
                'key.fs-minor': 'F# å°èª¿ (3#)',
                'key.cs-minor': 'C# å°èª¿ (4#)',
                'key.gs-minor': 'G# å°èª¿ (5#)',
                'key.ds-minor': 'D# å°èª¿ (6#)',
                'key.d-minor': 'D å°èª¿ (1b)',
                'key.g-minor': 'G å°èª¿ (2b)',
                'key.c-minor': 'C å°èª¿ (3b)',
                'key.f-minor': 'F å°èª¿ (4b)',
                'key.bb-minor': 'Bb å°èª¿ (5b)',
                'key.eb-minor': 'Eb å°èª¿ (6b)',
                // ç¯€å¥é¡å‹
                'rhythm.whole': 'å…¨éŸ³ç¬¦',
                'rhythm.dottedHalf': 'é™„é»äºŒåˆ†éŸ³ç¬¦',
                'rhythm.half': 'äºŒåˆ†éŸ³ç¬¦',
                'rhythm.dottedQuarter': 'é™„é»å››åˆ†éŸ³ç¬¦',
                'rhythm.quarter': 'å››åˆ†éŸ³ç¬¦',
                'rhythm.eighth': 'å…«åˆ†éŸ³ç¬¦',
                'rhythm.sixteenth': 'åå…­åˆ†éŸ³ç¬¦',
                'rhythm.triplet': 'ä¸‰é€£éŸ³',
                'rhythm.duplet': 'äºŒé€£éŸ³',
                'rhythm.quadruplet': 'å››é€£éŸ³',
                // å½ˆçª—æŒ‰éˆ•
                'button.save': 'ä¿å­˜è¨­ç½®',
                'button.cancel': 'å–æ¶ˆ',
                'button.close': 'é—œé–‰',
                'button.selectAll': 'å…¨é¸',
                'button.selectAllMajor': 'å…¨é¸å¤§èª¿',
                'button.selectAllMinor': 'å…¨é¸å°èª¿',
                'button.advanced': 'é«˜ç´šè¨­ç½®',
                'button.hideAdvanced': 'éš±è—é«˜ç´šè¨­ç½®',
                'button.resetDefault': 'è¿”å›é»˜èª',
                'rhythm.advancedFreq': 'é«˜ç´šé »ç‡è¨­ç½®',
                'interval.basicTypes': 'åŸºæœ¬éŸ³ç¨‹é¡å‹',
                'rhythm.basicUnits': 'åŸºæœ¬ç¯€å¥å–®ä½',
                'rhythm.freq.dottedQuarter': 'é™„é»å››åˆ†éŸ³ç¬¦é »ç‡:',
                'rhythm.freq.quarter': 'å››åˆ†éŸ³ç¬¦é »ç‡:',
                'rhythm.freq.eighth': 'å…«åˆ†éŸ³ç¬¦é »ç‡:',
                'rhythm.freq.sixteenth': 'åå…­åˆ†éŸ³ç¬¦é »ç‡:',
                'articulation.basic.title': 'åŸºæœ¬æ¼”å¥æ³• (Basic Articulations)',
                'articulation.freqDesc': 'èª¿æ•´å„æ¼”å¥æ³•åœ¨æ—‹å¾‹ä¸­çš„å‡ºç¾é »ç‡ (0% = ä¸ä½¿ç”¨, 100% = ç¶“å¸¸ä½¿ç”¨)',
                'articulation.basicFreq': 'åŸºæœ¬æ¼”å¥æ³•é »ç‡',
                'rhythm.freqDesc': 'èª¿æ•´å„ç¯€å¥å–®ä½åœ¨æ—‹å¾‹ä¸­çš„å‡ºç¾é »ç‡ (0% = ä¸ä½¿ç”¨, 100% = å„ªå…ˆä½¿ç”¨)',
                'rhythm.freq.whole': 'å…¨éŸ³ç¬¦é »ç‡:',
                'rhythm.freq.dottedHalf': 'é™„é»äºŒåˆ†éŸ³ç¬¦é »ç‡:',
                'rhythm.freq.half': 'äºŒåˆ†éŸ³ç¬¦é »ç‡:',
                'rhythm.freq.triplet': 'ä¸‰é€£éŸ³é »ç‡:',
                'rhythm.freq.duplet': 'äºŒé€£éŸ³é »ç‡:',
                // Interval types in type settings
                'intervalType.minor2nd': 'å°äºŒåº¦',
                'intervalType.major2nd': 'å¤§äºŒåº¦',
                'intervalType.minor3rd': 'å°ä¸‰åº¦',
                'intervalType.major3rd': 'å¤§ä¸‰åº¦',
                'intervalType.perfect4th': 'å®Œå…¨å››åº¦',
                'intervalType.tritone': 'å¢å››/æ¸›äº”åº¦',
                'intervalType.perfect5th': 'å®Œå…¨äº”åº¦',
                'intervalType.minor6th': 'å°å…­åº¦',
                'intervalType.major6th': 'å¤§å…­åº¦',
                'intervalType.minor7th': 'å°ä¸ƒåº¦',
                'intervalType.major7th': 'å¤§ä¸ƒåº¦',
                'intervalType.octave': 'å…«åº¦',
                'modal.timeSignature.title': 'æ‹è™Ÿè¨­ç½®',
                'timeSignature.options': 'æ‹è™Ÿé¸é …',
                'time.2-4': '2/4 æ‹',
                'time.3-4': '3/4 æ‹',
                'time.4-4': '4/4 æ‹',
                'time.6-8': '6/8 æ‹'
            },
            'en': {
                'app.title': 'Cognote - Interval Sight-Reading Generator',
                'app.subtitle': 'Professional Music Score Rendering & Music Theory Tool',
                'app.melodyMode': 'Melody Sight-Reading',
                'app.intervalMode': 'Interval Sight-Reading',
                'app.jianpuMode': 'Jianpu Sight-Reading',
                'app.chordMode': 'Chord Sight-Reading',
                'app.rhythmMode': 'Rhythm Sight-Reading',
                'controls.intervalType': 'Interval Type',
                'controls.intervalTypeSettings': 'Interval Type Settings',
                'controls.measures': 'Measures',
                'controls.measures2': '2 Measures',
                'controls.measures4': '4 Measures',
                'controls.measures8': '8 Measures',
                'controls.key': 'Key Signature',
                'controls.keySettings': 'Key Settings',
                'controls.time': 'Time Signature',
                'controls.timeSettings': 'Time Settings',
                'controls.clef': 'Clef',
                'controls.clefSettings': 'Clef Settings',
                'controls.mode': 'Mode',
                'mode.free': 'Free',
                'mode.challenge': 'Challenge',
                'modal.clefSettings': 'Clef Settings',
                'clef.options': 'Clef Options',
                'clef.treble': 'Treble Clef (G Clef)',
                'clef.bass': 'Bass Clef (F Clef)',
                'clef.alto': 'Alto Clef (C Clef)',
                'key.majorSection': 'Major Keys',
                'key.minorSection': 'Minor Keys',
                'controls.rangeMin': 'Lowest Note',
                'controls.rangeMax': 'Highest Note',
                'controls.accidental': 'Accidentals',
                'controls.metronome': 'Metronome',
                'controls.metronomePattern': 'Metronome Pattern',
                'controls.generateInterval': 'Generate Intervals',
                'controls.previous': 'Previous',
                'controls.next': 'Next',
                'controls.rhythm': 'Rhythm Settings',
                'controls.articulation': 'Articulations',
                'controls.practiceCounter': 'Practice',
                'controls.practiceAdd': '+',
                'controls.practiceReset': '-',
                'controls.play': 'Play',
                'score.emptyInterval': 'Click Generate Intervals to Start Practice',
                'settings.title': 'Settings',
                'settings.theme': 'Theme',
                'settings.language': 'Language',
                'settings.lightMode': 'Light Mode',
                'settings.darkMode': 'Dark Mode',
                'settings.midi': 'MIDI Input',
                'midi.enable': 'Enable',
                'midi.device': 'Device',
                'midi.status.unsupported': 'MIDI is not supported in this browser',
                'midi.status.permission': 'MIDI access not authorized',
                'midi.status.nodevice': 'No MIDI devices detected',
                'midi.status.connected': 'Connected: {device}',
                'midi.status.disconnected': 'Device disconnected',
                'midi.status.disabled': 'MIDI is off',
                'settings.metronome': 'Metronome',
                'settings.tempo': 'Tempo (BPM)',
                'settings.startMetronome': 'Start Metronome',
                'settings.stopMetronome': 'Stop Metronome',
                'modal.challenge.title': 'Challenge Mode',
                'modal.metronomePattern.title': 'Metronome Pattern',
                'metronomePattern.enable': 'Enable custom pattern',
                'metronomePattern.subdivision': 'Subdivision',
                'metronomePattern.subdivision.beat': '1 per beat',
                'metronomePattern.subdivision.eighth': '2 per beat (eighths)',
                'metronomePattern.subdivision.triplet': '3 per beat (triplets)',
                'metronomePattern.subdivision.sixteenth': '4 per beat (sixteenths)',
                'metronomePattern.bars': 'Bars',
                'metronomePattern.bars.1': '1 bar',
                'metronomePattern.bars.2': '2 bars',
                'metronomePattern.bars.4': '4 bars',
                'metronomePattern.timeSig': 'Time signature',
                'metronomePattern.hint': 'Click squares to enable/mute beats',
                'metronomePattern.resetBeats': 'Reset to beats',
                'metronomePattern.clear': 'Mute all',
                'challenge.prepTime': 'Preparation Time (sec)',
                'challenge.bpm': 'BPM',
                'challenge.cursor': 'Cursor',
                'challenge.metronome': 'Metronome',
                'challenge.hide': 'Hide',
                'challenge.modeToggle': 'Challenge Mode',
                'challenge.calibration': 'Input Calibration',
                'challenge.cursorHint': 'Cursor toggle: The cursor indicates the exact playing position and appears after the count-in, following the melody.',
                'challenge.hideHint': 'Hide toggle: When enabled, the previous measure is masked as you enter the next, leaving only the current reading area.',
                'challenge.preparingLabel': 'Prep',
                'challenge.seconds': 'sec',
                'button.start': 'Start',
                'button.saveOnly': 'Save',
                // Key signatures (with accidental counts)
                'key.C-major': 'C Major (0#)',
                'key.G-major': 'G Major (1#)',
                'key.D-major': 'D Major (2#)',
                'key.A-major': 'A Major (3#)',
                'key.E-major': 'E Major (4#)',
                'key.B-major': 'B Major (5#)',
                'key.Fs-major': 'F# Major (6#)',
                'key.F-major': 'F Major (1b)',
                'key.Bb-major': 'Bâ™­ Major (2b)',
                'key.Eb-major': 'Eâ™­ Major (3b)',
                'key.Ab-major': 'Aâ™­ Major (4b)',
                'key.Db-major': 'Dâ™­ Major (5b)',
                'key.Gb-major': 'Gâ™­ Major (6b)',
                'key.a-minor': 'A Minor (0#)',
                'key.e-minor': 'E Minor (1#)',
                'key.b-minor': 'B Minor (2#)',
                'key.fs-minor': 'F# Minor (3#)',
                'key.cs-minor': 'C# Minor (4#)',
                'key.gs-minor': 'G# Minor (5#)',
                'key.ds-minor': 'D# Minor (6#)',
                'key.d-minor': 'D Minor (1b)',
                'key.g-minor': 'G Minor (2b)',
                'key.c-minor': 'C Minor (3b)',
                'key.f-minor': 'F Minor (4b)',
                'key.bb-minor': 'Bâ™­ Minor (5b)',
                'key.eb-minor': 'Eâ™­ Minor (6b)',
                // Rhythm types
                'rhythm.whole': 'Whole Note',
                'rhythm.dottedHalf': 'Dotted Half Note',
                'rhythm.half': 'Half Note',
                'rhythm.dottedQuarter': 'Dotted Quarter Note',
                'rhythm.quarter': 'Quarter Note',
                'rhythm.eighth': 'Eighth Note',
                'rhythm.sixteenth': 'Sixteenth Note',
                'rhythm.triplet': 'Triplet',
                'rhythm.duplet': 'Duplet',
                'rhythm.quadruplet': 'Quadruplet',
                // Modal buttons
                'button.save': 'Save Settings',
                'button.cancel': 'Cancel',
                'button.close': 'Close',
                'button.selectAll': 'Select All',
                'button.selectAllMajor': 'Select All Major',
                'button.selectAllMinor': 'Select All Minor',
                'button.advanced': 'Advanced Settings',
                'button.hideAdvanced': 'Hide Advanced Settings',
                'button.resetDefault': 'Reset to Default',
                'rhythm.advancedFreq': 'Advanced Frequency Settings',
                'interval.basicTypes': 'Basic Interval Types',
                'rhythm.basicUnits': 'Basic Rhythm Units',
                'rhythm.freq.dottedQuarter': 'Dotted Quarter Note Frequency:',
                'rhythm.freq.quarter': 'Quarter Note Frequency:',
                'rhythm.freq.eighth': 'Eighth Note Frequency:',
                'rhythm.freq.sixteenth': 'Sixteenth Note Frequency:',
                'articulation.basic.title': 'Basic Articulations',
                'articulation.freqDesc': 'Adjust frequency of each articulation in melody (0% = not used, 100% = frequently used)',
                'articulation.basicFreq': 'Basic Articulation Frequency',
                'rhythm.freqDesc': 'Adjust frequency of each rhythm unit in melody (0% = not used, 100% = prioritized)',
                'rhythm.freq.whole': 'Whole Note Frequency:',
                'rhythm.freq.dottedHalf': 'Dotted Half Note Frequency:',
                'rhythm.freq.half': 'Half Note Frequency:',
                'rhythm.freq.triplet': 'Triplet Frequency:',
                'rhythm.freq.duplet': 'Duplet Frequency:',
                // Interval types in type settings
                'intervalType.minor2nd': 'Minor 2nd',
                'intervalType.major2nd': 'Major 2nd',
                'intervalType.minor3rd': 'Minor 3rd',
                'intervalType.major3rd': 'Major 3rd',
                'intervalType.perfect4th': 'Perfect 4th',
                'intervalType.tritone': 'Tritone (Aug 4th/Dim 5th)',
                'intervalType.perfect5th': 'Perfect 5th',
                'intervalType.minor6th': 'Minor 6th',
                'intervalType.major6th': 'Major 6th',
                'intervalType.minor7th': 'Minor 7th',
                'intervalType.major7th': 'Major 7th',
                'intervalType.octave': 'Octave',
                'modal.timeSignature.title': 'Time Signature Settings',
                'timeSignature.options': 'Time Signature Options',
                'time.2-4': '2/4 Time',
                'time.3-4': '3/4 Time',
                'time.4-4': '4/4 Time',
                'time.6-8': '6/8 Time'
            }
        };

        // è¯­è¨€åˆ‡æ¢ç›¸å…³å˜é‡
        let currentLanguage = localStorage.getItem('preferredLanguage') || 'zh-CN';
        
        // è¯­è¨€æŒ‰é’®æ˜¾ç¤ºæ–‡æœ¬
        const languageLabels = {
            'zh-CN': 'ğŸŒ ç®€ä½“ä¸­æ–‡',
            'zh-TW': 'ğŸŒ ç¹é«”ä¸­æ–‡',
            'en': 'ğŸŒ English'
        };

        // åˆ‡æ¢è¯­è¨€
        function switchLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('preferredLanguage', lang);

            // æ›´æ–°æŒ‰é’®æ–‡æœ¬ (å¦‚æœå­˜åœ¨æ—§çš„è¯­è¨€æŒ‰é’®)
            const languageBtn = document.getElementById('languageBtn');
            if (languageBtn) {
                languageBtn.textContent = languageLabels[lang];
            }

            // åº”ç”¨ç¿»è¯‘
            applyTranslations();

            // è§¦å‘ç»Ÿä¸€åŒæ­¥ç³»ç»Ÿ (åŒæ ‡ç­¾é¡µå†…å®æ—¶åŒæ­¥)
            if (window.ICStudioSync) {
                window.ICStudioSync.syncLanguage(lang, 'interval-tool');
            }

            // å…³é—­è®¾ç½®èœå•
            closeSettings();
            
            console.log(`ğŸŒ è¯­è¨€å·²åˆ‡æ¢åˆ°: ${lang}`);
        }

        // åº”ç”¨ç¿»è¯‘
        function applyTranslations() {
            const elements = document.querySelectorAll('[data-i18n]');
            const currentTranslations = translations[currentLanguage] || translations['zh-CN'];

            elements.forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (currentTranslations[key]) {
                    // æ£€æŸ¥å…ƒç´ æ˜¯å¦åªåŒ…å«æ–‡æœ¬å†…å®¹ï¼ˆæ²¡æœ‰å­å…ƒç´ ï¼‰
                    if (element.children.length === 0) {
                        // åªæœ‰æ–‡æœ¬å†…å®¹ï¼Œç›´æ¥æ›¿æ¢
                        element.textContent = currentTranslations[key];
                    } else {
                        // æœ‰å­å…ƒç´ ï¼Œéœ€è¦ä¿ç•™ç»“æ„ï¼Œåªæ›¿æ¢æ–‡æœ¬èŠ‚ç‚¹
                        // å…ˆä¿å­˜å½“å‰çš„HTMLç»“æ„
                        const originalHTML = element.innerHTML;
                        // æŸ¥æ‰¾æ–‡æœ¬èŠ‚ç‚¹å¹¶æ›¿æ¢
                        const textNodes = [];
                        const walker = document.createTreeWalker(
                            element,
                            NodeFilter.SHOW_TEXT,
                            null,
                            false
                        );
                        let node;
                        while (node = walker.nextNode()) {
                            if (node.nodeValue.trim()) {
                                textNodes.push(node);
                            }
                        }

                        // å¦‚æœåªæœ‰ä¸€ä¸ªä¸»è¦æ–‡æœ¬èŠ‚ç‚¹ï¼Œæ›¿æ¢å®ƒ
                        if (textNodes.length === 1) {
                            textNodes[0].nodeValue = currentTranslations[key];
                        } else {
                            // å¤æ‚ç»“æ„ï¼Œä½¿ç”¨textContentä½œä¸ºåå¤‡
                            element.textContent = currentTranslations[key];
                        }
                    }
                }
            });
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–è¯­è¨€
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„è¯­è¨€åå¥½
            const savedLanguage = localStorage.getItem('preferredLanguage');

            if (savedLanguage) {
                // å¦‚æœæœ‰ä¿å­˜çš„è¯­è¨€åå¥½ï¼Œè®¾ç½®å½“å‰è¯­è¨€å¹¶æ˜¾ç¤ºå¯¹åº”è¯­è¨€åç§°
                currentLanguage = savedLanguage;
                const languageBtn = document.getElementById('languageBtn');
                if (languageBtn) {
                    languageBtn.textContent = languageLabels[currentLanguage];
                }
                console.log(`ğŸ’¾ ä½¿ç”¨ä¿å­˜çš„è¯­è¨€: ${savedLanguage}`);
            } else {
                // å¦‚æœæ²¡æœ‰ä¿å­˜çš„è¯­è¨€åå¥½ï¼Œè‡ªåŠ¨æ£€æµ‹æµè§ˆå™¨è¯­è¨€
                const browserLang = navigator.language || navigator.userLanguage;
                // æ£€æµ‹æ˜¯å¦ä¸ºä¸­æ–‡ç¯å¢ƒï¼ˆæ”¯æŒ zh, zh-CN, zh-TW, zh-HKï¼‰
                const isChinese = browserLang && browserLang.toLowerCase().startsWith('zh');
                currentLanguage = isChinese ? 'zh-CN' : 'en';
                const languageBtn = document.getElementById('languageBtn');
                if (languageBtn) {
                    languageBtn.textContent = 'ğŸŒ æ–‡/A';
                }
                console.log(`ğŸŒ æµè§ˆå™¨è¯­è¨€æ£€æµ‹: ${browserLang} â†’ ${currentLanguage}`);
            }

            // åº”ç”¨ç¿»è¯‘
            applyTranslations();

            console.log(`ğŸŒ éŸ³ç¨‹å·¥å…·åˆå§‹åŒ–è¯­è¨€: ${currentLanguage}`);

            // ============ è·¨å·¥å…·åŒæ­¥ç›‘å¬æœºåˆ¶ ============
            // ç›‘å¬å…¶ä»–å·¥å…·å¯¹localStorageçš„ä¿®æ”¹
            window.addEventListener('storage', function(e) {
                if (e.key === 'preferredTheme' && e.newValue !== currentTheme) {
                    console.log(`ğŸ”„ éŸ³ç¨‹è§†å¥å·¥å…·æ£€æµ‹åˆ°ä¸»é¢˜å˜åŒ–: ${currentTheme} â†’ ${e.newValue}`);
                    currentTheme = e.newValue;
                    document.documentElement.setAttribute('data-theme', currentTheme);
                }

                if (e.key === 'preferredLanguage' && e.newValue !== currentLanguage) {
                    console.log(`ğŸ”„ éŸ³ç¨‹è§†å¥å·¥å…·æ£€æµ‹åˆ°è¯­è¨€å˜åŒ–: ${currentLanguage} â†’ ${e.newValue}`);
                    currentLanguage = e.newValue;
                    applyTranslations();
                    console.log(`ğŸŒ éŸ³ç¨‹è§†å¥å·¥å…·è¯­è¨€å·²åŒæ­¥ä¸º: ${currentLanguage}`);
                }
            });

            console.log('ğŸ”— éŸ³ç¨‹è§†å¥å·¥å…·localStorageè·¨å·¥å…·åŒæ­¥ç›‘å¬å·²å¯ç”¨');

            // ============ ç»Ÿä¸€åŒæ­¥ç³»ç»Ÿ ============
            // åˆ›å»ºå…¨å±€åŒæ­¥å‡½æ•°ï¼Œæ”¯æŒåŒæ ‡ç­¾é¡µå†…å®æ—¶åŒæ­¥
            window.ICStudioSync = window.ICStudioSync || {
                tools: new Set(),

                // æ³¨å†Œå·¥å…·
                registerTool: function(toolName, callbacks) {
                    this.tools.add({
                        name: toolName,
                        onThemeChange: callbacks.onThemeChange,
                        onLanguageChange: callbacks.onLanguageChange
                    });
                    console.log(`ğŸ”— ${toolName} å·²æ³¨å†Œåˆ°ç»Ÿä¸€åŒæ­¥ç³»ç»Ÿ`);
                },

                // åŒæ­¥ä¸»é¢˜åˆ°æ‰€æœ‰å·¥å…·
                syncTheme: function(newTheme, fromTool) {
                    console.log(`ğŸ”„ ç»Ÿä¸€åŒæ­¥ç³»ç»Ÿ: åŒæ­¥ä¸»é¢˜ ${newTheme} (æ¥æº: ${fromTool})`);
                    this.tools.forEach(tool => {
                        if (tool.name !== fromTool && tool.onThemeChange) {
                            try {
                                tool.onThemeChange(newTheme);
                            } catch (error) {
                                console.warn(`âš ï¸ ${tool.name} ä¸»é¢˜åŒæ­¥å¤±è´¥:`, error);
                            }
                        }
                    });
                },

                // åŒæ­¥è¯­è¨€åˆ°æ‰€æœ‰å·¥å…·
                syncLanguage: function(newLanguage, fromTool) {
                    console.log(`ğŸ”„ ç»Ÿä¸€åŒæ­¥ç³»ç»Ÿ: åŒæ­¥è¯­è¨€ ${newLanguage} (æ¥æº: ${fromTool})`);
                    this.tools.forEach(tool => {
                        if (tool.name !== fromTool && tool.onLanguageChange) {
                            try {
                                tool.onLanguageChange(newLanguage);
                            } catch (error) {
                                console.warn(`âš ï¸ ${tool.name} è¯­è¨€åŒæ­¥å¤±è´¥:`, error);
                            }
                        }
                    });
                }
            };

            // æ³¨å†ŒéŸ³ç¨‹å·¥å…·åˆ°ç»Ÿä¸€åŒæ­¥ç³»ç»Ÿ
            window.ICStudioSync.registerTool('interval-tool', {
                onThemeChange: function(newTheme) {
                    if (currentTheme !== newTheme) {
                        currentTheme = newTheme;
                        document.documentElement.setAttribute('data-theme', currentTheme);
                    }
                },
                onLanguageChange: function(newLanguage) {
                    if (currentLanguage !== newLanguage) {
                        console.log(`ğŸŒ éŸ³ç¨‹å·¥å…·æ¥æ”¶è¯­è¨€åŒæ­¥: ${currentLanguage} â†’ ${newLanguage}`);
                        currentLanguage = newLanguage;
                        applyTranslations();
                    }
                }
            });
        });
    </script>

    <script>
        // å¼¹çª—æ§åˆ¶å‡½æ•°
        
        // èŠ‚å¥è®¾ç½®å¼¹çª—
        function openRhythmSettings() {
            document.getElementById('rhythmModal').style.display = 'flex';
        }
        
        function closeRhythmSettings() {
            document.getElementById('rhythmModal').style.display = 'none';
        }
        
        function selectAllRhythms() {
            // ğŸ”¥ Fix C: åªé€‰æ‹©å¯è§çš„checkboxï¼Œé¿å…å‹¾é€‰éšè—çš„é™„ç‚¹éŸ³ç¬¦é€‰é¡¹
            const checkboxes = document.querySelectorAll('#rhythmModal input[type="checkbox"]');

            // è¿‡æ»¤å‡ºå¯è§çš„checkbox
            const visibleCheckboxes = Array.from(checkboxes).filter(cb => {
                const label = cb.closest('.checkbox-item') || cb.closest('label');
                if (!label) return true; // å¦‚æœæ²¡æœ‰çˆ¶labelï¼Œé»˜è®¤è®¤ä¸ºå¯è§
                const styles = window.getComputedStyle(label);
                return styles.display !== 'none' && styles.visibility !== 'hidden';
            });

            const allChecked = visibleCheckboxes.every(cb => cb.checked);

            visibleCheckboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
            });

            console.log(`ğŸ”§ å…¨é€‰èŠ‚å¥ï¼š${visibleCheckboxes.length}ä¸ªå¯è§é€‰é¡¹ï¼Œ${allChecked ? 'å–æ¶ˆå…¨é€‰' : 'å…¨éƒ¨é€‰ä¸­'}`);
        }
        
        function saveRhythmSettings() {
            // ğŸ¯ æ”¶é›†æ‰€æœ‰èŠ‚å¥è®¾ç½®å’Œé¢‘ç‡è®¾ç½®
            const rhythmSettings = {};
            const frequencySettings = {};

            // æ”¶é›†åŸºæœ¬èŠ‚å¥å¤é€‰æ¡†è®¾ç½®
            const rhythmCheckboxes = document.querySelectorAll('#rhythmModal input[type="checkbox"]');
            rhythmCheckboxes.forEach(checkbox => {
                if (checkbox.id && checkbox.id.startsWith('rhythm-')) {
                    rhythmSettings[checkbox.id] = checkbox.checked;
                }
            });

            // æ”¶é›†é¢‘ç‡æ»‘å—è®¾ç½®
            const frequencySliders = document.querySelectorAll('input[type="range"][id^="freq-"]');
            frequencySliders.forEach(slider => {
                frequencySettings[slider.id] = parseInt(slider.value);
            });

            console.log('âœ… èŠ‚å¥è®¾ç½®å·²ä¿å­˜');

            closeRhythmSettings();
        }
        
        function toggleRhythmAdvancedSettings() {
            const advancedSection = document.getElementById('rhythmAdvancedSettings');
            const button = document.getElementById('rhythmAdvancedBtn');

            if (advancedSection.style.display === 'none' || !advancedSection.style.display) {
                advancedSection.style.display = 'block';
                button.textContent = translations[currentLanguage]['button.hideAdvanced'] || 'éšè—é«˜çº§è®¾ç½®';
            } else {
                advancedSection.style.display = 'none';
                button.textContent = translations[currentLanguage]['button.advanced'] || 'é«˜çº§è®¾ç½®';
            }
        }
        
        function resetRhythmFrequencies() {
            // é‡ç½®æ‰€æœ‰é¢‘ç‡æ»‘å—åˆ°é»˜è®¤å€¼
            const frequencies = {
                'freq-whole': 10,
                'freq-dotted-half': 15,
                'freq-half': 30,
                'freq-dotted-quarter': 35,
                'freq-quarter': 50,
                'freq-eighth': 40,
                'freq-16th': 20,
                'freq-triplet': 15,
                'freq-duplet': 30,
                'freq-quadruplet': 25
            };
            
            for (const [id, defaultValue] of Object.entries(frequencies)) {
                const slider = document.getElementById(id);
                const valueSpan = document.getElementById(id + '-value');
                
                if (slider && valueSpan) {
                    slider.value = defaultValue;
                    valueSpan.textContent = defaultValue + '%';
                }
            }
        }
        
        // Articulationsè®¾ç½®å¼¹çª—
        function openArticulationSettings() {
            document.getElementById('articulationModal').style.display = 'flex';
        }
        
        function closeArticulationSettings() {
            document.getElementById('articulationModal').style.display = 'none';
        }
        
        function selectAllBasicArticulations() {
            const checkboxes = document.querySelectorAll('#articulationModal .rhythm-section:first-of-type input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
            });
        }
        
        function selectAllGuitarTechniques() {
            const checkboxes = document.querySelectorAll('#articulationModal .rhythm-section:nth-of-type(2) input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
            });
        }
        
        function saveArticulationSettings() {
            console.log('ä¿å­˜æ¼”å¥æŠ€å·§è®¾ç½®');
            closeArticulationSettings();
        }
        
        function toggleArticulationAdvancedSettings() {
            const advancedSection = document.getElementById('articulationAdvancedSettings');
            const button = document.getElementById('articulationAdvancedBtn');

            if (advancedSection.style.display === 'none' || !advancedSection.style.display) {
                advancedSection.style.display = 'block';
                button.textContent = translations[currentLanguage]['button.hideAdvanced'] || 'éšè—é«˜çº§è®¾ç½®';
            } else {
                advancedSection.style.display = 'none';
                button.textContent = translations[currentLanguage]['button.advanced'] || 'é«˜çº§è®¾ç½®';
            }
        }
        
        function resetArticulationFrequencies() {
            // é‡ç½®æ‰€æœ‰æ¼”å¥æ³•é¢‘ç‡åˆ°é»˜è®¤å€¼
            const frequencies = {
                'freq-staccato': 20,
                'freq-accent': 15,
                'freq-acciaccatura': 10,
                'freq-slur': 15
            };
            
            for (const [id, defaultValue] of Object.entries(frequencies)) {
                const slider = document.getElementById(id);
                const valueSpan = document.getElementById(id + '-value');
                
                if (slider && valueSpan) {
                    slider.value = defaultValue;
                    valueSpan.textContent = defaultValue + '%';
                }
            }
        }
        
        // è°ƒå·è®¾ç½®å¼¹çª—
        function openKeySettings() {
            document.getElementById('keySignatureModal').style.display = 'flex';
        }
        
        function closeKeySettings() {
            document.getElementById('keySignatureModal').style.display = 'none';
        }
        
        function selectAllMajorKeys() {
            const checkboxes = document.querySelectorAll('#keySignatureModal .rhythm-section:first-of-type input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
            });
        }
        
        function selectAllMinorKeys() {
            const checkboxes = document.querySelectorAll('#keySignatureModal .rhythm-section:nth-of-type(2) input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
            });
        }
        
        function saveKeySettings() {
            console.log('ä¿å­˜è°ƒå·è®¾ç½®');
            closeKeySettings();
        }
        
        // æ‹å·è®¾ç½®å¼¹çª—
        function openTimeSignatureSettings() {
            document.getElementById('timeSignatureModal').style.display = 'flex';
        }
        
        function closeTimeSignatureSettings() {
            document.getElementById('timeSignatureModal').style.display = 'none';
        }
        
        function selectAllTimeSignatures() {
            const checkboxes = document.querySelectorAll('#timeSignatureModal input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
            });
        }
        
        function saveTimeSignatureSettings() {
            console.log('ä¿å­˜æ‹å·è®¾ç½®');
            updateRhythmVisibilityForTimeSignature();
            closeTimeSignatureSettings();
        }

        // ğŸ¯ æ ¹æ®æ‹å·åŠ¨æ€æ§åˆ¶èŠ‚å¥é€‰é¡¹å¯è§æ€§
        function updateRhythmVisibilityForTimeSignature() {

            // è·å–é€‰ä¸­çš„æ‹å·
            const timeSignatureCheckboxes = document.querySelectorAll('#timeSignatureModal input[type="checkbox"]:checked');
            const selectedTimeSignatures = Array.from(timeSignatureCheckboxes).map(cb => cb.value);


            // æ£€æŸ¥é€‰æ‹©çš„æ‹å·é›†åˆ
            const has68TimeSignature = selectedTimeSignatures.includes('6/8');
            const hasSimpleTimeSignature = selectedTimeSignatures.some(v => ['2/4','3/4','4/4'].includes(v));

            // èŠ‚å¥é€‰é¡¹å…ƒç´ 
            const rhythmWholeLabel = document.getElementById('rhythm-whole-label');
            const rhythmHalfLabel = document.getElementById('rhythm-half-label');
            const rhythmDottedHalfLabel = document.getElementById('rhythm-dotted-half-label');
            const rhythmDottedQuarterLabel = document.getElementById('rhythm-dotted-quarter-label');
            const rhythmTripletLabel = document.getElementById('rhythm-triplet-label');
            const rhythmDupletLabel = document.getElementById('rhythm-duplet-label');
            const rhythmQuadrupletLabel = document.getElementById('rhythm-quadruplet-label');

            // å¯¹åº”çš„é¢‘ç‡æ§åˆ¶å…ƒç´ 
            const freqWholeItem = document.getElementById('freq-whole-item');
            const freqHalfItem = document.getElementById('freq-half-item');
            const freqDottedHalfItem = document.getElementById('freq-dotted-half-item');
            const freqDottedQuarterItem = document.getElementById('freq-dotted-quarter-item');
            const freqTripletItem = document.getElementById('freq-triplet-item');
            const freqDupletItem = document.getElementById('freq-duplet-item');
            const freqQuadrupletItem = document.getElementById('freq-quadruplet-item');

            if (has68TimeSignature && hasSimpleTimeSignature) {

                // ç®€å•æ‹ï¼šæ˜¾ç¤ºå…¨éŸ³ç¬¦/äºŒåˆ†éŸ³ç¬¦ + ä¸‰è¿éŸ³
                if (rhythmWholeLabel) rhythmWholeLabel.style.display = 'block';
                if (rhythmHalfLabel) rhythmHalfLabel.style.display = 'block';
                if (freqWholeItem) freqWholeItem.style.display = 'block';
                if (freqHalfItem) freqHalfItem.style.display = 'block';
                if (rhythmTripletLabel) rhythmTripletLabel.style.display = 'flex';
                if (freqTripletItem) freqTripletItem.style.display = 'block';

                // 6/8ï¼šæ˜¾ç¤ºé™„ç‚¹èŠ‚å¥ + äºŒè¿éŸ³/å››è¿éŸ³
                if (rhythmDottedHalfLabel) rhythmDottedHalfLabel.style.display = 'block';
                if (rhythmDottedQuarterLabel) rhythmDottedQuarterLabel.style.display = 'block';
                if (freqDottedHalfItem) freqDottedHalfItem.style.display = 'block';
                if (freqDottedQuarterItem) freqDottedQuarterItem.style.display = 'block';
                if (rhythmDupletLabel) rhythmDupletLabel.style.display = 'flex';
                if (rhythmQuadrupletLabel) rhythmQuadrupletLabel.style.display = 'flex';
                if (freqDupletItem) freqDupletItem.style.display = 'block';
                if (freqQuadrupletItem) freqQuadrupletItem.style.display = 'block';

                // ğŸ†• å½“åŒ…å«6/8æ—¶ï¼Œé»˜è®¤å‹¾é€‰å…«åˆ†éŸ³ç¬¦ä¸é™„ç‚¹å››åˆ†éŸ³ç¬¦ï¼Œç¡®ä¿å¤åˆæ‹æ ¸å¿ƒèŠ‚å¥å°±ç»ª
                const eighthCheckbox = document.getElementById('rhythm-eighth');
                const dottedQuarterCheckbox = document.getElementById('rhythm-dotted-quarter');
                if (eighthCheckbox && !eighthCheckbox.checked) {
                    eighthCheckbox.checked = true;
                    console.log('âœ… 6/8å·²è¢«å‹¾é€‰ï¼ˆä¸ç®€å•æ‹å¹¶å­˜ï¼‰â†’ è‡ªåŠ¨å‹¾é€‰ï¼šå…«åˆ†éŸ³ç¬¦');
                }
                if (dottedQuarterCheckbox && !dottedQuarterCheckbox.checked) {
                    dottedQuarterCheckbox.checked = true;
                    console.log('âœ… 6/8å·²è¢«å‹¾é€‰ï¼ˆä¸ç®€å•æ‹å¹¶å­˜ï¼‰â†’ è‡ªåŠ¨å‹¾é€‰ï¼šé™„ç‚¹å››åˆ†éŸ³ç¬¦');
                }

            } else if (has68TimeSignature) {

                // éšè—å…¨éŸ³ç¬¦/äºŒåˆ†éŸ³ç¬¦
                if (rhythmWholeLabel) rhythmWholeLabel.style.display = 'none';
                if (rhythmHalfLabel) rhythmHalfLabel.style.display = 'none';
                if (freqWholeItem) freqWholeItem.style.display = 'none';
                if (freqHalfItem) freqHalfItem.style.display = 'none';

                // æ˜¾ç¤ºé™„ç‚¹èŠ‚å¥ + äºŒè¿éŸ³/å››è¿éŸ³
                if (rhythmDottedHalfLabel) rhythmDottedHalfLabel.style.display = 'block';
                if (rhythmDottedQuarterLabel) rhythmDottedQuarterLabel.style.display = 'block';
                if (freqDottedHalfItem) freqDottedHalfItem.style.display = 'block';
                if (freqDottedQuarterItem) freqDottedQuarterItem.style.display = 'block';
                if (rhythmDupletLabel) rhythmDupletLabel.style.display = 'flex';
                if (rhythmQuadrupletLabel) rhythmQuadrupletLabel.style.display = 'flex';
                if (freqDupletItem) freqDupletItem.style.display = 'block';
                if (freqQuadrupletItem) freqQuadrupletItem.style.display = 'block';

                // ç¦ç”¨ä¸‰è¿éŸ³
                if (rhythmTripletLabel) rhythmTripletLabel.style.display = 'none';
                if (freqTripletItem) freqTripletItem.style.display = 'none';

                // ğŸ†• 6/8æ‹è‡ªåŠ¨å‹¾é€‰æ ¸å¿ƒèŠ‚å¥ç±»å‹
                const eighthCheckbox = document.getElementById('rhythm-eighth');
                const dottedQuarterCheckbox = document.getElementById('rhythm-dotted-quarter');
                if (eighthCheckbox && !eighthCheckbox.checked) {
                    eighthCheckbox.checked = true;
                    console.log('âœ… 6/8æ‹è‡ªåŠ¨å‹¾é€‰ï¼šå…«åˆ†éŸ³ç¬¦');
                }
                if (dottedQuarterCheckbox && !dottedQuarterCheckbox.checked) {
                    dottedQuarterCheckbox.checked = true;
                    console.log('âœ… 6/8æ‹è‡ªåŠ¨å‹¾é€‰ï¼šé™„ç‚¹å››åˆ†éŸ³ç¬¦');
                }

            } else {

                // æ˜¾ç¤ºå…¨éŸ³ç¬¦/äºŒåˆ†éŸ³ç¬¦ + ä¸‰è¿éŸ³
                if (rhythmWholeLabel) rhythmWholeLabel.style.display = 'block';
                if (rhythmHalfLabel) rhythmHalfLabel.style.display = 'block';
                if (freqWholeItem) freqWholeItem.style.display = 'block';
                if (freqHalfItem) freqHalfItem.style.display = 'block';
                if (rhythmTripletLabel) rhythmTripletLabel.style.display = 'flex';
                if (freqTripletItem) freqTripletItem.style.display = 'block';

                // éšè—6/8ä¸“å±
                if (rhythmDottedHalfLabel) rhythmDottedHalfLabel.style.display = 'none';
                if (rhythmDottedQuarterLabel) rhythmDottedQuarterLabel.style.display = 'none';
                if (freqDottedHalfItem) freqDottedHalfItem.style.display = 'none';
                if (freqDottedQuarterItem) freqDottedQuarterItem.style.display = 'none';
                if (rhythmDupletLabel) rhythmDupletLabel.style.display = 'none';
                if (rhythmQuadrupletLabel) rhythmQuadrupletLabel.style.display = 'none';
                if (freqDupletItem) freqDupletItem.style.display = 'none';
                if (freqQuadrupletItem) freqQuadrupletItem.style.display = 'none';
            }
        }
        
        // éŸ³ç¨‹è·¨åº¦è®¾ç½®å¼¹çª—
        function openIntervalSettings() {
            document.getElementById('intervalModal').style.display = 'flex';
        }
        
        function closeIntervalSettings() {
            document.getElementById('intervalModal').style.display = 'none';
        }
        
        function handleIntervalCheckboxChange(changedCheckbox) {
            // å–æ¶ˆé€‰ä¸­å…¶ä»–å¤é€‰æ¡†ï¼Œç¡®ä¿åªæœ‰ä¸€ä¸ªè¢«é€‰ä¸­
            const checkboxes = document.querySelectorAll('#intervalModal input[type="checkbox"]');
            
            checkboxes.forEach(checkbox => {
                if (checkbox !== changedCheckbox) {
                    checkbox.checked = false;
                }
            });
        }
        
        function saveIntervalSettings() {
            console.log('ä¿å­˜éŸ³ç¨‹è·¨åº¦è®¾ç½®');
            closeIntervalSettings();
        }
        
        // è°±å·è®¾ç½®å¼¹çª—
        function openClefSettings() {
            document.getElementById('clefModal').style.display = 'flex';

            // ğŸ¼ åœ¨æ¨¡æ€æ¡†æ˜¾ç¤ºåç«‹å³æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            setTimeout(() => {
                if (typeof window.addClefChangeListeners === 'function') {
                    window.addClefChangeListeners();
                } else {
                    // å¦‚æœå…¨å±€å‡½æ•°ä¸å­˜åœ¨ï¼Œç›´æ¥åœ¨è¿™é‡Œæ·»åŠ ç›‘å¬å™¨
                    const clefCheckboxes = document.querySelectorAll('#clefModal input[type="checkbox"]');

                    clefCheckboxes.forEach(checkbox => {
                        // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§ç›‘å¬å™¨
                        checkbox.removeEventListener('change', window.clefChangeHandler);

                        // æ·»åŠ æ–°çš„ç›‘å¬å™¨
                        window.clefChangeHandler = function() {

                            // å¦‚æœæœ‰å”¯ä¸€é€‰ä¸­çš„è°±å·ï¼Œç«‹å³åˆ‡æ¢åˆ°è¯¥è°±å·çš„é»˜è®¤éŸ³åŸŸ
                            const checkedClefs = Array.from(clefCheckboxes).filter(cb => cb.checked);

                            if (checkedClefs.length === 1) {
                                const selectedClef = checkedClefs[0].value;

                if (window.intervalSettings && typeof window.intervalSettings.setActiveClef === 'function') {
                    window.intervalSettings.setActiveClef(selectedClef);
                } else if (typeof window.switchToClefRange === 'function') {
                    window.switchToClefRange(selectedClef);
                }
                            } else if (checkedClefs.length > 1) {
                                // å¤šè°±å·ï¼šå°†â€œå½“å‰æ´»åŠ¨è°±å·â€è®¾ç½®ä¸ºç”¨æˆ·æœ€åç‚¹å‡»çš„è¿™ä¸ªè°±å·
                                if (this.checked) {
                                    window.currentActiveClef = this.value;
                                    if (typeof window.setRangeForClef === 'function') {
                                        window.setRangeForClef(window.currentActiveClef);
                                    }
                                } else {
                                }
                            } else {
                            }
                        };

                        checkbox.addEventListener('change', window.clefChangeHandler);
                    });
                }
            }, 100); // ç­‰å¾…æ¨¡æ€æ¡†å®Œå…¨æ˜¾ç¤º
        }
        
        function closeClefSettings() {
            document.getElementById('clefModal').style.display = 'none';
        }
        
        function selectAllClefs() {
            const checkboxes = document.querySelectorAll('#clefModal input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
            });
        }
        
        function saveClefSettings() {
            console.log('ä¿å­˜è°±å·è®¾ç½®');
            closeClefSettings();
        }
        
        // éŸ³ç¨‹ç±»å‹è®¾ç½®
        function openIntervalTypeSettings() {
            document.getElementById('intervalTypeModal').style.display = 'flex';
        }
        
        function closeIntervalTypeSettings() {
            document.getElementById('intervalTypeModal').style.display = 'none';
        }
        
        function selectAllIntervalTypes() {
            const checkboxes = document.querySelectorAll('#intervalTypeModal input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
            });
        }
        
        function saveIntervalTypeSettings() {
            console.log('ä¿å­˜éŸ³ç¨‹ç±»å‹è®¾ç½®');
            closeIntervalTypeSettings();
        }
        
        // === éŸ³ç¨‹ç”Ÿæˆå™¨æ•´åˆæ¨¡å— ===
        // åˆå§‹åŒ–éŸ³ç¨‹ç”Ÿæˆå™¨å®ä¾‹
        let intervalSettings, intervalGenerator, intervalRenderer;
        
        // é¡µé¢åŠ è½½ååˆå§‹åŒ–æ‰€æœ‰éŸ³ç¨‹ç”Ÿæˆå™¨æ¨¡å—
        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log('å¼€å§‹åˆå§‹åŒ–éŸ³ç¨‹ç”Ÿæˆå™¨æ¨¡å—...');

                console.log('åˆå§‹åŒ–IntervalSettings...');
                intervalSettings = new IntervalSettings();
                window.intervalSettings = intervalSettings; // ç»Ÿä¸€å¼•ç”¨
                console.log('IntervalSettingsåˆå§‹åŒ–æˆåŠŸ:', !!intervalSettings);

                console.log('åˆå§‹åŒ–IntervalGenerator...');
                intervalGenerator = new IntervalGenerator();
                console.log('IntervalGeneratoråˆå§‹åŒ–æˆåŠŸ:', !!intervalGenerator);

                console.log('åˆå§‹åŒ–IntervalRenderer...');
                intervalRenderer = new IntervalRenderer();
                console.log('IntervalRendereråˆå§‹åŒ–æˆåŠŸ:', !!intervalRenderer);

                // åˆå§‹åŒ–å¯¼èˆªæŒ‰é’®çŠ¶æ€
                updateNavigationButtons();

                // ğŸ¯ åˆå§‹åŒ–èŠ‚å¥å¯è§æ€§ï¼ˆåŸºäºé»˜è®¤æ‹å·è®¾ç½®ï¼‰
                updateRhythmVisibilityForTimeSignature();

            } catch (initError) {
                console.error('âŒ éŸ³ç¨‹ç”Ÿæˆå™¨æ¨¡å—åˆå§‹åŒ–å¤±è´¥:', initError);
                console.error('é”™è¯¯è¯¦æƒ…:', initError.stack);

                // å°è¯•éƒ¨åˆ†åˆå§‹åŒ–
                try {
                    if (!intervalSettings) {
                        intervalSettings = new IntervalSettings();
                        window.intervalSettings = intervalSettings; // ç»Ÿä¸€å¼•ç”¨
                        console.log('è¡¥æ•‘ï¼šIntervalSettingsåˆå§‹åŒ–æˆåŠŸ');
                    }
                } catch (settingsError) {
                    console.error('IntervalSettingsåˆå§‹åŒ–å¤±è´¥:', settingsError);
                }

                try {
                    if (!intervalGenerator) {
                        intervalGenerator = new IntervalGenerator();
                        console.log('è¡¥æ•‘ï¼šIntervalGeneratoråˆå§‹åŒ–æˆåŠŸ');
                    }
                } catch (generatorError) {
                    console.error('IntervalGeneratoråˆå§‹åŒ–å¤±è´¥:', generatorError);
                }

                try {
                    if (!intervalRenderer) {
                        intervalRenderer = new IntervalRenderer();
                        console.log('è¡¥æ•‘ï¼šIntervalRendereråˆå§‹åŒ–æˆåŠŸ');
                    }
                } catch (rendererError) {
                    console.error('IntervalRendereråˆå§‹åŒ–å¤±è´¥:', rendererError);
                }
            }
        });
        
        // å»¶è¿Ÿåˆå§‹åŒ–å‡½æ•° - å¤‡ç”¨æœºåˆ¶
        function ensureModulesInitialized() {
            console.log('ğŸ”„ æ‰§è¡Œå»¶è¿Ÿåˆå§‹åŒ–æ£€æŸ¥...');

            if (!intervalSettings) {
                try {
                    intervalSettings = new IntervalSettings();
                    window.intervalSettings = intervalSettings; // ç»Ÿä¸€å¼•ç”¨
                } catch (error) {
                    console.error('âŒ IntervalSettingså»¶è¿Ÿåˆå§‹åŒ–å¤±è´¥:', error);
                }
            }

            if (!intervalGenerator) {
                try {
                    intervalGenerator = new IntervalGenerator();
                } catch (error) {
                    console.error('âŒ IntervalGeneratorå»¶è¿Ÿåˆå§‹åŒ–å¤±è´¥:', error);
                }
            }

            if (!intervalRenderer) {
                try {
                    intervalRenderer = new IntervalRenderer();
                } catch (error) {
                    console.error('âŒ IntervalRendererå»¶è¿Ÿåˆå§‹åŒ–å¤±è´¥:', error);
                }
            }
        }

        // ä¸»éŸ³ç¨‹ç”Ÿæˆå‡½æ•° - è°ƒç”¨ç‹¬ç«‹æ¨¡å—
        async function generateIntervals() {

            // ğŸµ è‡ªåŠ¨æš‚åœå½“å‰æ’­æ”¾
            if (window.isPlayingInterval) {
                directPlayTest(); // è°ƒç”¨æ’­æ”¾å‡½æ•°æ¥åˆ‡æ¢çŠ¶æ€ï¼ˆåœæ­¢æ’­æ”¾ï¼‰
            }

            try {
                // ğŸ”§ é¦–å…ˆå°è¯•å»¶è¿Ÿåˆå§‹åŒ–ï¼ˆå¤‡ç”¨æœºåˆ¶ï¼‰
                ensureModulesInitialized();

                // ğŸ” æ£€æŸ¥å¿…è¦çš„æ¨¡å—æ˜¯å¦å·²åˆå§‹åŒ–

                if (!intervalSettings) {
                    throw new Error('intervalSettings æ¨¡å—æœªåˆå§‹åŒ–');
                }
                if (!intervalGenerator) {
                    throw new Error('intervalGenerator æ¨¡å—æœªåˆå§‹åŒ–');
                }
                if (!intervalRenderer) {
                    throw new Error('intervalRenderer æ¨¡å—æœªåˆå§‹åŒ–');
                }

                // è·å–å½“å‰è®¾ç½®å‚æ•°
                const settings = intervalSettings.getCurrentSettings();

                // éªŒè¯è®¾ç½®
                const validation = intervalSettings.validateSettings(settings);

                if (!validation.isValid) {
                    console.error('âŒ è®¾ç½®éªŒè¯å¤±è´¥:', validation.errors);
                    alert('è®¾ç½®é”™è¯¯: ' + validation.errors.join(', '));
                    return;
                }

                console.log('ğŸ“Š è®¾ç½®æ‘˜è¦:', intervalSettings.getSettingsSummary(settings));

                // ç”ŸæˆéŸ³ç¨‹è¿›è¡Œ
                const intervalProgression = intervalGenerator.generateIntervalProgression(settings);

                // ğŸµ ç«‹å³ä¿å­˜å½“å‰éŸ³ç¨‹è¿›è¡Œæ•°æ®ä¾›æ’­æ”¾åŠŸèƒ½ä½¿ç”¨
                window.currentIntervalProgression = intervalProgression;

                // ğŸ¯ éªŒè¯æ’­æ”¾æ•°æ®å®Œæ•´æ€§
                if (intervalProgression?.measures) {
                    intervalProgression.measures.forEach((measure, index) => {
                    });
                } else {
                    console.warn('âš ï¸ ç”Ÿæˆçš„éŸ³ç¨‹è¿›è¡Œæ•°æ®ç»“æ„å¼‚å¸¸');
                }

                // ä¿å­˜åˆ°å†å²è®°å½•
                saveToHistory(intervalProgression, settings);

                // ğŸµ ä½¿ç”¨V4.0æ¸²æŸ“å™¨

                try {
                    // ğŸ¨ å¼€å§‹æ¸²æŸ“è¿‡ç¨‹

                    // æ£€æŸ¥V4.0æ¸²æŸ“å™¨æ˜¯å¦å¯ç”¨
                    console.log('renderIntervalProgressionæ–¹æ³•:', typeof window.intervalRenderer?.renderIntervalProgression);

                    if (window.intervalRenderer && typeof window.intervalRenderer.renderIntervalProgression === 'function') {

                        // ä½¿ç”¨V4.0æ¸²æŸ“å™¨æ¸²æŸ“éŸ³ç¨‹è¿›è¡Œ
                        if (isIntervalHidden){ const scoreEl=document.getElementById('score'); if(scoreEl){ scoreEl.style.opacity='0'; scoreEl.style.filter='blur(10px)'; }}
                        await window.intervalRenderer.renderIntervalProgression(intervalProgression);

                        // ğŸ­ æ£€æŸ¥éšè—çŠ¶æ€ï¼Œå¦‚æœå¼€å¯éšè—åŠŸèƒ½åˆ™éšè—æ–°ç”Ÿæˆçš„éŸ³ç¨‹
                        if (isIntervalHidden) {
                            console.log('ğŸ‘‚ éšè—åŠŸèƒ½å·²å¼€å¯ï¼Œéšè—æ–°ç”Ÿæˆçš„éŸ³ç¨‹');
                            applyIntervalHiddenState();
                        }
                    } else {
                        console.error('âŒ V4.0æ¸²æŸ“å™¨ä¸å¯ç”¨');
                        console.error('æ¸²æŸ“å™¨è°ƒè¯•ä¿¡æ¯:');
                        console.error('- window.intervalRenderer:', window.intervalRenderer);
                        console.error('- ç±»å‹:', typeof window.intervalRenderer);
                        console.error('- renderIntervalProgressionæ–¹æ³•:', window.intervalRenderer?.renderIntervalProgression);
                        throw new Error('V4.0æ¸²æŸ“å™¨ä¸å¯ç”¨');
                    }
                } catch (renderError) {
                    console.error('âŒ V4.0æ¸²æŸ“å™¨å¤±è´¥:', renderError);
                    console.error('æ¸²æŸ“é”™è¯¯è¯¦æƒ…:', renderError.stack);
                    console.error('æ¸²æŸ“å™¨çŠ¶æ€:', {
                        intervalRenderer: window.intervalRenderer,
                        renderMethod: window.intervalRenderer?.renderIntervalProgression,
                        progression: intervalProgression
                    });
                    throw new Error(`V4.0æ¸²æŸ“ç³»ç»Ÿå¤±è´¥: ${renderError.message}`);
                }
                
            } catch (error) {
                console.error('âŒ éŸ³ç¨‹ç”Ÿæˆé”™è¯¯:', error);
                console.error('âŒ é”™è¯¯è¯¦æƒ…:', error.stack);

                // æä¾›æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                let errorMessage = 'éŸ³ç¨‹ç”Ÿæˆå¤±è´¥';
                if (error.message.includes('æ¨¡å—æœªåˆå§‹åŒ–')) {
                    errorMessage = 'ç³»ç»Ÿæ¨¡å—åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•';
                } else if (error.message.includes('è®¾ç½®')) {
                    errorMessage = 'è®¾ç½®å‚æ•°æœ‰è¯¯: ' + error.message;
                } else if (error.message.includes('æ¸²æŸ“')) {
                    errorMessage = 'ä¹è°±æ¸²æŸ“å¤±è´¥: ' + error.message;
                } else if (error.message.includes('OpenSheetMusicDisplay')) {
                    errorMessage = 'ä¹è°±æ˜¾ç¤ºç»„ä»¶åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
                } else {
                    errorMessage = `ç”Ÿæˆå¤±è´¥: ${error.message}`;
                }

                alert(errorMessage + '\n\nè¯¦ç»†ä¿¡æ¯è¯·æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°');
            }
        }
        
        // ä¿å­˜éŸ³ç¨‹åˆ°å†å²è®°å½•
        function saveToHistory(intervalProgression, settings) {
            // ä»å½“å‰ä½ç½®å¼€å§‹æˆªæ–­å†å²è®°å½•ï¼ˆåˆ é™¤ä¹‹åçš„è®°å½•ï¼‰
            intervalHistory = intervalHistory.slice(0, currentIntervalIndex + 1);
            
            // æ·»åŠ æ–°è®°å½•
            intervalHistory.push({
                progression: intervalProgression,
                settings: settings,
                timestamp: Date.now()
            });
            
            // é™åˆ¶å†å²è®°å½•å¤§å°
            if (intervalHistory.length > MAX_HISTORY_SIZE) {
                intervalHistory.shift();
            } else {
                currentIntervalIndex++;
            }
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            updateNavigationButtons();
            
            console.log(`ğŸ’¾ ä¿å­˜éŸ³ç¨‹åˆ°å†å²è®°å½•ï¼Œå½“å‰ç´¢å¼•: ${currentIntervalIndex}, å†å²é•¿åº¦: ${intervalHistory.length}`);
        }
        
        // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
        function updateNavigationButtons() {
            const prevBtn = document.querySelector('button[onclick="previousInterval()"]');
            const nextBtn = document.querySelector('button[onclick="nextInterval()"]');

            if (prevBtn) {
                prevBtn.disabled = currentIntervalIndex <= 0;
                // ğŸ¨ ç§»é™¤å˜æ·¡æ•ˆæœï¼šæŒ‰é’®ä¿æŒæ­£å¸¸å¤–è§‚
                prevBtn.style.opacity = '1';
            }

            if (nextBtn) {
                nextBtn.disabled = currentIntervalIndex >= intervalHistory.length - 1;
                // ğŸ¨ ç§»é™¤å˜æ·¡æ•ˆæœï¼šæŒ‰é’®ä¿æŒæ­£å¸¸å¤–è§‚
                nextBtn.style.opacity = '1';
            }
        }
        
        // æ¸²æŸ“æŒ‡å®šçš„éŸ³ç¨‹è¿›è¡Œ
        async function renderIntervalProgression(intervalProgression) {
            try {
                // ğŸµ ä¿å­˜å½“å‰éŸ³ç¨‹è¿›è¡Œæ•°æ®ä¾›æ’­æ”¾åŠŸèƒ½ä½¿ç”¨
                window.currentIntervalProgression = intervalProgression;

                // ğŸ¯ éªŒè¯æ’­æ”¾æ•°æ®å®Œæ•´æ€§
                if (intervalProgression?.measures) {
                    intervalProgression.measures.forEach((measure, index) => {
                        measure.lowerVoice.forEach((note, noteIndex) => {
                            if (note.type === 'note') {
                                console.log(`  éŸ³ç¬¦${noteIndex + 1}: pitch="${note.pitch}", duration=${note.duration}, type=${note.type}`);
                            }
                        });
                    });
                }

                // ğŸ¯ ä½¿ç”¨V4.0æ¸²æŸ“å™¨
                if (window.intervalRenderer && typeof window.intervalRenderer.renderIntervalProgression === 'function') {

                    // ä½¿ç”¨V4.0æ¸²æŸ“å™¨æ¸²æŸ“éŸ³ç¨‹è¿›è¡Œ
                    await window.intervalRenderer.renderIntervalProgression(intervalProgression);
                } else {
                    console.log('âŒ V4.0æ¸²æŸ“å™¨ä¸å¯ç”¨');
                    throw new Error('V4.0æ¸²æŸ“å™¨ä¸å¯ç”¨');
                }
            } catch (renderError) {
                console.warn('V4.0æ¸²æŸ“å™¨å¤±è´¥:', renderError);
                alert('éŸ³ç¨‹æ¸²æŸ“å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        function previousInterval() {
            if (currentIntervalIndex > 0) {
                currentIntervalIndex--;
                const historyItem = intervalHistory[currentIntervalIndex];

                console.log(`â¬…ï¸ æ˜¾ç¤ºä¸Šä¸€æ¡éŸ³ç¨‹ï¼Œç´¢å¼•: ${currentIntervalIndex}`);

                // ğŸµ æ›´æ–°æ’­æ”¾æ•°æ®
                window.currentIntervalProgression = historyItem.progression;

                // æ¸²æŸ“å†å²ä¸­çš„éŸ³ç¨‹è¿›è¡Œ
                renderIntervalProgression(historyItem.progression);

                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                updateNavigationButtons();
            } else {
                console.log('âš ï¸ å·²ç»æ˜¯ç¬¬ä¸€æ¡éŸ³ç¨‹');
            }
        }
        
        function nextInterval() {
            if (currentIntervalIndex < intervalHistory.length - 1) {
                currentIntervalIndex++;
                const historyItem = intervalHistory[currentIntervalIndex];

                console.log(`â¡ï¸ æ˜¾ç¤ºä¸‹ä¸€æ¡éŸ³ç¨‹ï¼Œç´¢å¼•: ${currentIntervalIndex}`);

                // ğŸµ æ›´æ–°æ’­æ”¾æ•°æ®
                window.currentIntervalProgression = historyItem.progression;

                // æ¸²æŸ“å†å²ä¸­çš„éŸ³ç¨‹è¿›è¡Œ
                renderIntervalProgression(historyItem.progression);

                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                updateNavigationButtons();
            } else {
                console.log('âš ï¸ å·²ç»æ˜¯æœ€åä¸€æ¡éŸ³ç¨‹');
            }
        }
        
        // é¢‘ç‡æ»‘å—äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¢å¼ºç‰ˆï¼šè‡ªåŠ¨åŒæ­¥å‹¾é€‰æ¡†ï¼‰
        document.addEventListener('DOMContentLoaded', function() {
            // ç›‘å¬æ‰€æœ‰é¢‘ç‡æ»‘å—å˜åŒ–
            const frequencySliders = document.querySelectorAll('input[type="range"][id^="freq-"]');

            frequencySliders.forEach(slider => {
                const valueSpan = document.getElementById(slider.id + '-value');

                if (valueSpan) {
                    slider.addEventListener('input', function() {
                        const frequency = parseInt(this.value);
                        valueSpan.textContent = frequency + '%';

                        // ğŸ”¥ è‡ªåŠ¨åŒæ­¥å¤é€‰æ¡†ï¼š0%å–æ¶ˆå‹¾é€‰ï¼Œ>0%è‡ªåŠ¨å‹¾é€‰
                        const rhythmType = slider.id.replace('freq-', '');
                        const checkbox = document.getElementById('rhythm-' + rhythmType);

                        if (checkbox) {
                            if (frequency === 0) {
                                checkbox.checked = false;
                                console.log('ğŸ”„ è‡ªåŠ¨å–æ¶ˆå‹¾é€‰ ' + rhythmType + ': é¢‘ç‡ä¸º 0%');
                            } else if (!checkbox.checked) {
                                checkbox.checked = true;
                                console.log('ğŸ”„ è‡ªåŠ¨å‹¾é€‰ ' + rhythmType + ': é¢‘ç‡ä¸º ' + frequency + '%');
                            }
                        }
                    });
                }
            });
        });

        // ğŸ¼ è°±å·-éŸ³åŸŸæ™ºèƒ½ç»‘å®šç³»ç»Ÿäº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('DOMContentLoaded', function() {

            // è·å–éŸ³åŸŸæ§åˆ¶å…ƒç´ 
            const rangeMinSelect = document.getElementById('rangeMin');
            const rangeMaxSelect = document.getElementById('rangeMax');

            if (!rangeMinSelect || !rangeMaxSelect) {
                console.warn('âš ï¸ éŸ³åŸŸé€‰æ‹©å™¨æœªæ‰¾åˆ°');
                return;
            }

            // ğŸ¼ æ·»åŠ è°±å·é€‰æ‹©å®æ—¶ç›‘å¬ - ç«‹å³åˆ‡æ¢éŸ³åŸŸï¼ˆå…¨å±€å‡½æ•°ï¼‰
            window.addClefChangeListeners = function() {
                const clefCheckboxes = document.querySelectorAll('#clefModal input[type="checkbox"]');

                if (clefCheckboxes.length === 0) {
                    console.warn('âš ï¸ æœªæ‰¾åˆ°è°±å·å¤é€‰æ¡†ï¼Œå¯èƒ½æ¨¡æ€æ¡†æœªæ˜¾ç¤º');
                    return;
                }

                clefCheckboxes.forEach(checkbox => {
                    // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§ç›‘å¬å™¨
                    if (window.clefChangeHandler) {
                        checkbox.removeEventListener('change', window.clefChangeHandler);
                    }

                    // åˆ›å»ºæ–°çš„ç›‘å¬å™¨å‡½æ•°
                    window.clefChangeHandler = function() {

                        // å¦‚æœæœ‰å”¯ä¸€é€‰ä¸­çš„è°±å·ï¼Œç«‹å³åˆ‡æ¢åˆ°è¯¥è°±å·çš„é»˜è®¤éŸ³åŸŸ
                        const checkedClefs = Array.from(clefCheckboxes).filter(cb => cb.checked);

                        if (checkedClefs.length === 1) {
                            const selectedClef = checkedClefs[0].value;

                            if (typeof window.switchToClefRange === 'function') {
                                window.switchToClefRange(selectedClef);
                                // æ›´æ–°å½“å‰ç”Ÿæˆçš„è°±å·
                                window.currentGeneratedClef = selectedClef;
                                window.currentActiveClef = selectedClef;

                            }
                        } else if (checkedClefs.length > 1) {
                            // å¤šä¸ªè°±å·å¯ç”¨ï¼šå°†æ´»åŠ¨è°±å·è®¾ä¸ºæœ€åç‚¹å‡»çš„è¯¥é¡¹ï¼Œå¹¶åŠ è½½å…¶ä¼šè¯éŸ³åŸŸ
                            if (this.checked) {
                                const newClef = this.value;
                                if (window.intervalSettings && typeof window.intervalSettings.setActiveClef === 'function') {
                                    window.intervalSettings.setActiveClef(newClef);
                                } else if (typeof window.setRangeForClef === 'function') {
                                    window.setRangeForClef(newClef);
                                }
                            } else {
                            }
                        } else {
                        }
                    };

                    checkbox.addEventListener('change', window.clefChangeHandler);
                });

            };

            // å­˜å‚¨å½“å‰ç”Ÿæˆçš„è°±å·ï¼ˆç”¨äºç»‘å®šç”¨æˆ·è‡ªå®šä¹‰éŸ³åŸŸï¼‰
            window.currentGeneratedClef = 'treble'; // é»˜è®¤é«˜éŸ³è°±å·

            // å…¼å®¹å˜é‡å - ä¸ºç”¨æˆ·æä¾›çš„å‡½æ•°ä½¿ç”¨
            window.currentActiveClef = window.currentGeneratedClef;

            // éŸ³åŸŸè®°å¿†ç³»ç»Ÿ - å‚è€ƒå’Œå¼¦è§†å¥å·¥å…·è®¾ç½®
            window.clefRangeMemory = {
                'treble': { min: 60, max: 81 },  // C4-A5ï¼ˆé«˜éŸ³è°±å·é»˜è®¤éŸ³åŸŸï¼‰
                'bass': { min: 40, max: 64 },    // E2-E4 (ä¸å’Œå¼¦è§†å¥å·¥å…·ä¸€è‡´)
                'alto': { min: 48, max: 67 }     // C3-G4 (ä¸­éŸ³è°±å·åˆç†éŸ³åŸŸï¼Œä¸å½±å“å’Œå¼¦å·¥å…·)
            };

            // ä¿å­˜ç”¨æˆ·å¯¹éŸ³åŸŸçš„è°ƒæ•´
            function saveRangeForCurrentClef() {
                const rangeMinSelect = document.getElementById('rangeMin');
                const rangeMaxSelect = document.getElementById('rangeMax');

                if (!rangeMinSelect || !rangeMaxSelect) return;

                // ä½¿ç”¨å½“å‰æ´»è·ƒçš„è°±å·
                if (!window.currentActiveClef) return;
                const minV = parseInt(rangeMinSelect.value);
                const maxV = parseInt(rangeMaxSelect.value);
                // æ›´æ–°ä¼šè¯ä¿å­˜ï¼ˆå½“å‰+é»˜è®¤ï¼‰
                if (window.intervalSettings && typeof window.intervalSettings.setClefRange === 'function') {
                    window.intervalSettings.setClefRange(window.currentActiveClef, minV, maxV);
                }
                // åˆ·æ–°é•œåƒ
                window.clefRangeMemory[window.currentActiveClef] = { min: minV, max: maxV };
                console.log(`ğŸ’¾ ä¿å­˜${window.currentActiveClef}è°±å·éŸ³åŸŸ(ä¼šè¯+é•œåƒ): ${minV}-${maxV}`);
            }

            // ä»è®°å¿†ä¸­åŠ è½½æŒ‡å®šè°±å·çš„éŸ³åŸŸ
            function loadRangeForClef(clef) {
                const rangeMinSelect = document.getElementById('rangeMin');
                const rangeMaxSelect = document.getElementById('rangeMax');

                if (!rangeMinSelect || !rangeMaxSelect) return;

                if (window.clefRangeMemory[clef]) {
                    const range = window.clefRangeMemory[clef];
                    rangeMinSelect.value = range.min.toString();
                    rangeMaxSelect.value = range.max.toString();
                    console.log(`ğŸ“– åŠ è½½${clef}è°±å·éŸ³åŸŸ: ${range.min}-${range.max}`);
                }
            }

            // åˆå§‹åŒ–éŸ³åŸŸç›‘å¬å™¨
            function initRangeListeners() {
                const rangeMinSelect = document.getElementById('rangeMin');
                const rangeMaxSelect = document.getElementById('rangeMax');

                if (rangeMinSelect && rangeMaxSelect) {
                    const handler = () => {
                        try {
                            if (window.intervalSettings && typeof window.intervalSettings.onRangeChange === 'function') {
                                window.intervalSettings.onRangeChange();
                                saveRangeForCurrentClef();
                            }
                        } catch(e){ console.warn('éŸ³åŸŸonChangeå¤±è´¥', e); }
                    };
                    rangeMinSelect.addEventListener('change', handler);
                    rangeMaxSelect.addEventListener('change', handler);
                }
            }

            // æ ¹æ®è°±å·è®¾ç½®åˆé€‚çš„éŸ³åŸŸ - ä½¿ç”¨ IntervalSettings ä¼šè¯ä¿å­˜
            function setRangeForClef(clef) {
                const rangeMinSelect = document.getElementById('rangeMin');
                const rangeMaxSelect = document.getElementById('rangeMax');

                if (!rangeMinSelect || !rangeMaxSelect) return;

                // æ›´æ–°å½“å‰æ´»è·ƒè°±å·
                window.currentActiveClef = clef;
                // ä» IntervalSettings ä¼šè¯ä¿å­˜è·å–è®¾ç½®
                try {
                    if (window.intervalSettings && typeof window.intervalSettings.getClefCurrentRange === 'function') {
                        const rangeSettings = window.intervalSettings.getClefCurrentRange(clef);
                        if (rangeSettings) {
                            rangeMinSelect.value = String(rangeSettings.min);
                            rangeMaxSelect.value = String(rangeSettings.max);
                            window.clefRangeMemory[clef] = { min: rangeSettings.min, max: rangeSettings.max };
                            const noteNames = { 36:'C2',40:'E2',48:'C3',50:'D3',55:'G3',60:'C4',64:'E4',67:'G4',71:'B4',72:'C5',81:'A5' };
                            const minNote = noteNames[rangeSettings.min] || `MIDI${rangeSettings.min}`;
                            const maxNote = noteNames[rangeSettings.max] || `MIDI${rangeSettings.max}`;
                        }
                    }
                } catch(e) { console.warn('è¯»å–ä¼šè¯éŸ³åŸŸå¤±è´¥', e); }

                console.log(`ğŸ”„ å½“å‰æ´»è·ƒè°±å·å·²æ›´æ–°ä¸º: ${window.currentActiveClef}`);
            }

            // å°†å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸä¾›å¤–éƒ¨è°ƒç”¨
            window.saveRangeForCurrentClef = saveRangeForCurrentClef;
            window.loadRangeForClef = loadRangeForClef;
            window.initRangeListeners = initRangeListeners;
            window.setRangeForClef = setRangeForClef;

            // ğŸ¯ ç›‘å¬éŸ³åŸŸå˜æ›´ï¼Œè‡ªåŠ¨ç»‘å®šåˆ°å½“å‰è°±å·
            function handleRangeChange() {
                if (!window.intervalSettings) {
                    console.warn('âš ï¸ intervalSettings ä¸å¯ç”¨');
                    return;
                }

                const currentClef = window.currentGeneratedClef;
                const minValue = parseInt(rangeMinSelect.value);
                const maxValue = parseInt(rangeMaxSelect.value);


                // ä½¿ç”¨ç”¨æˆ·æä¾›çš„å‡½æ•°ä¿å­˜éŸ³åŸŸ
                saveRangeForCurrentClef();
            }

            // âš ï¸ å·²ç§»é™¤å†²çªçš„äº‹ä»¶ç›‘å¬å™¨ï¼Œç»Ÿä¸€ä½¿ç”¨IntervalSettingsç³»ç»Ÿ
            // rangeMinSelect.addEventListener('change', handleRangeChange);
            // rangeMaxSelect.addEventListener('change', handleRangeChange);

            // ğŸ”„ è‡ªåŠ¨åˆ‡æ¢éŸ³åŸŸå‡½æ•°ï¼ˆå½“ç”Ÿæˆæ–°è°±å·æ—¶è°ƒç”¨ï¼‰- æ€»æ˜¯åˆ‡æ¢åˆ°é»˜è®¤éŸ³åŸŸ
            window.switchToClefRange = function(clef) {

                // æ›´æ–°å½“å‰ç”Ÿæˆçš„è°±å·
                window.currentGeneratedClef = clef;
                window.currentActiveClef = clef;

                const rangeMinSelect = document.getElementById('rangeMin');
                const rangeMaxSelect = document.getElementById('rangeMax');

                if (!rangeMinSelect || !rangeMaxSelect) {
                    console.warn('âš ï¸ éŸ³åŸŸé€‰æ‹©å™¨æ§ä»¶æœªæ‰¾åˆ°');
                    return;
                }

                // ğŸ¯ ä¼˜å…ˆä½¿ç”¨IntervalSettingsä¿å­˜çš„éŸ³åŸŸï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤éŸ³åŸŸ
                if (window.intervalSettings) {
                    const savedRange = window.intervalSettings.getClefCurrentRange(clef);

                    rangeMinSelect.value = savedRange.min.toString();
                    rangeMaxSelect.value = savedRange.max.toString();

                    // æ£€æŸ¥æ˜¯å¦ä¸ºè‡ªå®šä¹‰éŸ³åŸŸ
                    const clefSetting = window.intervalSettings.userSettings.clefRanges[clef];
                    const isCustom = clefSetting && clefSetting.hasCustomRange;

                } else {
                    // å›é€€åˆ°é»˜è®¤éŸ³åŸŸ (æ›´æ–°ä¸ºæ–°çš„é»˜è®¤è®¾ç½®)
                    const defaultRanges = {
                        'treble': { min: 60, max: 72 },  // C4-C5
                        'alto': { min: 50, max: 71 },    // D3-B4
                        'bass': { min: 40, max: 64 }     // E2-E4
                    };
                    const range = defaultRanges[clef] || defaultRanges['treble'];

                    rangeMinSelect.value = range.min.toString();
                    rangeMaxSelect.value = range.max.toString();

                }
            };

            // ğŸš€ åˆå§‹åŒ–æ–°çš„ç›‘å¬å™¨ç³»ç»Ÿ
            window.initRangeListeners();

            // ğŸš€ åˆå§‹åŒ–ï¼šè®¾ç½®ä¸ºé«˜éŸ³è°±å·çš„é»˜è®¤éŸ³åŸŸ
            window.setRangeForClef('treble');


            // ğŸ§ª æ·»åŠ æµ‹è¯•åŠŸèƒ½ï¼ˆå¼€å‘è°ƒè¯•ç”¨ï¼‰
            window.testClefRangeSwitching = function() {
                console.log('ğŸ§ª å¼€å§‹æµ‹è¯•è°±å·-éŸ³åŸŸæ™ºèƒ½åˆ‡æ¢åŠŸèƒ½');

                const testClefs = ['treble', 'bass', 'alto'];
                let testIndex = 0;

                function runNextTest() {
                    if (testIndex >= testClefs.length) {
                        alert('è°±å·-éŸ³åŸŸåˆ‡æ¢æµ‹è¯•å®Œæˆï¼è¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—æŸ¥çœ‹è¯¦ç»†ç»“æœã€‚');
                        return;
                    }

                    const clef = testClefs[testIndex];

                    window.switchToClefRange(clef);

                    testIndex++;
                    setTimeout(runNextTest, 1500); // 1.5ç§’é—´éš”ä¾¿äºè§‚å¯Ÿ
                }

                runNextTest();
            };

            // ğŸ”§ æ·»åŠ ç”¨æˆ·è‡ªå®šä¹‰éŸ³åŸŸæµ‹è¯•åŠŸèƒ½
            window.testUserCustomRange = function() {
                console.log('ğŸ§ª å¼€å§‹æµ‹è¯•ç”¨æˆ·è‡ªå®šä¹‰éŸ³åŸŸç»‘å®šåŠŸèƒ½');

                // æ¨¡æ‹Ÿç”¨æˆ·åœ¨é«˜éŸ³è°±å·ä¸Šè‡ªå®šä¹‰éŸ³åŸŸåˆ°F4-F5
                window.switchToClefRange('treble');
                setTimeout(() => {
                    rangeMinSelect.value = '65'; // F4
                    rangeMaxSelect.value = '77'; // F5
                    rangeMinSelect.dispatchEvent(new Event('change'));

                    // åˆ‡æ¢åˆ°ä½éŸ³è°±å·ï¼Œåº”è¯¥æ˜¾ç¤ºé»˜è®¤éŸ³åŸŸ
                    setTimeout(() => {
                        window.switchToClefRange('bass');

                        // å†åˆ‡æ¢å›é«˜éŸ³è°±å·ï¼Œåº”è¯¥æ˜¾ç¤ºç”¨æˆ·çš„è‡ªå®šä¹‰è®¾ç½®
                        setTimeout(() => {
                            window.switchToClefRange('treble');
                            alert('ç”¨æˆ·è‡ªå®šä¹‰éŸ³åŸŸæµ‹è¯•å®Œæˆï¼è¯·æŸ¥çœ‹æ§åˆ¶å°å’ŒéŸ³åŸŸé€‰æ‹©å™¨çš„å˜åŒ–ã€‚');
                        }, 1500);
                    }, 1500);
                }, 1000);
            };

            // ğŸ” æ·»åŠ ç»‘å®šçŠ¶æ€æŸ¥çœ‹åŠŸèƒ½
            window.showClefBindingStatus = function() {
                if (!window.intervalSettings) {
                    alert('âŒ intervalSettings æœªåˆå§‹åŒ–');
                    return;
                }

                const clefs = ['treble', 'bass', 'alto'];
                const clefNames = { 'treble': 'é«˜éŸ³è°±å·', 'bass': 'ä½éŸ³è°±å·', 'alto': 'ä¸­éŸ³è°±å·' };
                let statusMessage = 'ğŸ¼ å½“å‰è°±å·-éŸ³åŸŸç»‘å®šçŠ¶æ€:\n\n';

                clefs.forEach(clef => {
                    const range = window.intervalSettings.getClefCurrentRange(clef);
                    const name = clefNames[clef];
                    const minNote = window.intervalSettings.midiToNote(range.min);
                    const maxNote = window.intervalSettings.midiToNote(range.max);
                    const isCustom = window.intervalSettings.clefRangeBindings[clef]?.isCustom ? 'è‡ªå®šä¹‰' : 'é»˜è®¤';
                    statusMessage += `${name}: ${minNote}-${maxNote} (${isCustom})\n`;
                });

                statusMessage += `\nå½“å‰ç”Ÿæˆè°±å·: ${window.currentGeneratedClef || 'treble'}`;
                alert(statusMessage);
            };


            // ğŸ§ª æ·»åŠ å®Œæ•´å·¥ä½œæµç¨‹æµ‹è¯•
            window.testCompleteWorkflow = function() {
                console.group('ğŸ¼ å®Œæ•´è°±å·-éŸ³åŸŸç»‘å®šå·¥ä½œæµç¨‹æµ‹è¯•');
                console.log('æµ‹è¯•åœºæ™¯ï¼šéªŒè¯æ¯ä¸ªè°±å·çš„é»˜è®¤éŸ³åŸŸå’Œç”¨æˆ·è‡ªå®šä¹‰ç»‘å®š');

                let testStep = 1;

                function logStep(description) {
                }

                // æ­¥éª¤1: éªŒè¯é»˜è®¤éŸ³åŸŸ
                logStep('éªŒè¯å„è°±å·é»˜è®¤éŸ³åŸŸ');
                console.log('â€¢ é«˜éŸ³è°±å·é»˜è®¤: C4-C5 (MIDI 60-72)');
                console.log('â€¢ ä½éŸ³è°±å·é»˜è®¤: E2-E4 (MIDI 40-64)');
                console.log('â€¢ ä¸­éŸ³è°±å·é»˜è®¤: D3-B4 (MIDI 50-71)');

                // æ­¥éª¤2: æµ‹è¯•ä½éŸ³è°±å·è‡ªåŠ¨åˆ‡æ¢
                logStep('æµ‹è¯•ä½éŸ³è°±å·è‡ªåŠ¨éŸ³åŸŸåˆ‡æ¢');
                window.switchToClefRange('bass');
                const bassRange = window.intervalSettings.getClefCurrentRange('bass');

                // æ­¥éª¤3: æ¨¡æ‹Ÿç”¨æˆ·è‡ªå®šä¹‰ä½éŸ³è°±å·éŸ³åŸŸ
                setTimeout(() => {
                    logStep('æ¨¡æ‹Ÿç”¨æˆ·è‡ªå®šä¹‰ä½éŸ³è°±å·éŸ³åŸŸ (æ”¹ä¸ºF2-F4)');
                    const rangeMinSelect = document.getElementById('rangeMin');
                    const rangeMaxSelect = document.getElementById('rangeMax');
                    rangeMinSelect.value = '41'; // F2
                    rangeMaxSelect.value = '65'; // F4
                    rangeMinSelect.dispatchEvent(new Event('change'));

                    // æ­¥éª¤4: åˆ‡æ¢åˆ°ä¸­éŸ³è°±å·éªŒè¯ç‹¬ç«‹æ€§
                    setTimeout(() => {
                        logStep('åˆ‡æ¢åˆ°ä¸­éŸ³è°±å·ï¼ŒéªŒè¯éŸ³åŸŸç‹¬ç«‹æ€§');
                        window.switchToClefRange('alto');
                        const altoRange = window.intervalSettings.getClefCurrentRange('alto');

                        // æ­¥éª¤5: åˆ‡æ¢å›ä½éŸ³è°±å·éªŒè¯ç”¨æˆ·è‡ªå®šä¹‰ä¿æŒ
                        setTimeout(() => {
                            logStep('åˆ‡æ¢å›ä½éŸ³è°±å·ï¼ŒéªŒè¯ç”¨æˆ·è‡ªå®šä¹‰éŸ³åŸŸå·²ä¿å­˜');
                            window.switchToClefRange('bass');
                            const customBassRange = window.intervalSettings.getClefCurrentRange('bass');

                            console.log('æ ¸å¿ƒé€»è¾‘éªŒè¯:');
                            console.groupEnd();

                            alert('âœ… å®Œæ•´å·¥ä½œæµç¨‹æµ‹è¯•å®Œæˆï¼\nè¯·æŸ¥çœ‹æ§åˆ¶å°è¯¦ç»†æ—¥å¿—ã€‚');
                        }, 1500);
                    }, 1500);
                }, 1000);
            };

            // ğŸ§ª æ·»åŠ æ–°é€»è¾‘æµ‹è¯•
            window.testNewLogic = function() {
                console.group('ğŸ¼ æµ‹è¯•æ–°çš„éŸ³ç¨‹ç”Ÿæˆé€»è¾‘');
                console.log('æµ‹è¯•åœºæ™¯ï¼šéªŒè¯"ç”Ÿæˆåæ ¹æ®å®é™…è°±å·åˆ‡æ¢éŸ³åŸŸ"çš„é€»è¾‘');

                // æ‰‹åŠ¨è®¾ç½®ä¸€ä¸ªç‰¹å®šéŸ³åŸŸ
                const rangeMinSelect = document.getElementById('rangeMin');
                const rangeMaxSelect = document.getElementById('rangeMax');
                rangeMinSelect.value = '55'; // G3
                rangeMaxSelect.value = '67'; // G4

                // é€‰æ‹©æ‰€æœ‰è°±å·è®©ç³»ç»Ÿéšæœºé€‰æ‹©
                const trebleCheckbox = document.getElementById('clef-treble');
                const bassCheckbox = document.getElementById('clef-bass');
                const altoCheckbox = document.getElementById('clef-alto');

                if (trebleCheckbox) trebleCheckbox.checked = true;
                if (bassCheckbox) bassCheckbox.checked = true;
                if (altoCheckbox) altoCheckbox.checked = true;

                console.log('1. éŸ³ç¨‹æ˜¯å¦ä½¿ç”¨å½“å‰çš„ G3-G4 éŸ³åŸŸ');
                console.log('2. ç”ŸæˆåUIæ˜¯å¦åˆ‡æ¢åˆ°å®é™…ç”Ÿæˆè°±å·çš„é»˜è®¤éŸ³åŸŸ');

                // ç”ŸæˆéŸ³ç¨‹
                setTimeout(() => {
                    if (typeof window.generateIntervals === 'function') {
                        window.generateIntervals().then(() => {
                            // æ£€æŸ¥æœ€ç»ˆéŸ³åŸŸUI
                            setTimeout(() => {
                                const finalMin = document.getElementById('rangeMin').value;
                                const finalMax = document.getElementById('rangeMax').value;
                                console.groupEnd();
                            }, 500);
                        }).catch(error => {
                            console.error('âŒ ç”Ÿæˆå¤±è´¥:', error);
                            console.groupEnd();
                        });
                    }
                }, 1000);
            };

            // ğŸ§ª æµ‹è¯•è°±å·æ¨¡æ€æ¡†ç›‘å¬å™¨ç»‘å®š
            window.testModalListeners = function() {
                console.group('ğŸ¼ æµ‹è¯•è°±å·æ¨¡æ€æ¡†ç›‘å¬å™¨ç»‘å®š');
                console.log('æµ‹è¯•åœºæ™¯ï¼šæ‰“å¼€è°±å·è®¾ç½®æ¨¡æ€æ¡†ï¼Œæ£€æŸ¥äº‹ä»¶ç›‘å¬å™¨æ˜¯å¦æ­£ç¡®ç»‘å®š');

                // æ‰“å¼€è°±å·è®¾ç½®æ¨¡æ€æ¡†
                openClefSettings();

                // ç­‰å¾…æ¨¡æ€æ¡†å®Œå…¨æ˜¾ç¤ºå’Œç›‘å¬å™¨ç»‘å®š
                setTimeout(() => {
                    const clefCheckboxes = document.querySelectorAll('#clefModal input[type="checkbox"]');

                    if (clefCheckboxes.length > 0) {

                        // æµ‹è¯•æ‰‹åŠ¨è§¦å‘äº‹ä»¶
                        const trebleCheckbox = document.getElementById('clef-treble');
                        const bassCheckbox = document.getElementById('clef-bass');

                        if (trebleCheckbox && bassCheckbox) {
                            trebleCheckbox.checked = false;
                            bassCheckbox.checked = true;

                            // æ‰‹åŠ¨è§¦å‘changeäº‹ä»¶
                            bassCheckbox.dispatchEvent(new Event('change'));

                            setTimeout(() => {
                                const rangeMin = document.getElementById('rangeMin').value;
                                const rangeMax = document.getElementById('rangeMax').value;
                                const minNote = window.intervalSettings.midiToNote(parseInt(rangeMin));
                                const maxNote = window.intervalSettings.midiToNote(parseInt(rangeMax));
                                console.log(`æœŸæœ›éŸ³åŸŸ: E2-E4 (MIDI: 40-64)`);

                                bassCheckbox.checked = false;
                                trebleCheckbox.checked = true;
                                trebleCheckbox.dispatchEvent(new Event('change'));

                                setTimeout(() => {
                                    const newRangeMin = document.getElementById('rangeMin').value;
                                    const newRangeMax = document.getElementById('rangeMax').value;
                                    const newMinNote = window.intervalSettings.midiToNote(parseInt(newRangeMin));
                                    const newMaxNote = window.intervalSettings.midiToNote(parseInt(newRangeMax));
                                    console.log(`æœŸæœ›éŸ³åŸŸ: C4-C5 (MIDI: 60-72)`);

                                    console.groupEnd();

                                    alert('âœ… æ¨¡æ€æ¡†ç›‘å¬å™¨æµ‹è¯•å®Œæˆï¼\nè¯·æŸ¥çœ‹æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†ç»“æœã€‚');
                                }, 300);
                            }, 300);
                        } else {
                            console.error('âŒ æœªæ‰¾åˆ°é«˜éŸ³è°±å·æˆ–ä½éŸ³è°±å·å¤é€‰æ¡†');
                            console.groupEnd();
                        }
                    } else {
                        console.error('âŒ æ¨¡æ€æ¡†ä¸­æœªæ‰¾åˆ°è°±å·å¤é€‰æ¡†');
                        console.groupEnd();
                    }
                }, 200); // ç­‰å¾…ç›‘å¬å™¨ç»‘å®šå®Œæˆ
            };

            // ğŸ§ª æ·»åŠ å®æ—¶è°±å·åˆ‡æ¢æµ‹è¯•
            window.testRealtimeClefSwitching = function() {
                console.group('ğŸ¼ æµ‹è¯•å®æ—¶è°±å·åˆ‡æ¢åŠŸèƒ½');
                console.log('æµ‹è¯•åœºæ™¯ï¼šæ‰‹åŠ¨å‹¾é€‰/å–æ¶ˆå‹¾é€‰è°±å·ï¼ŒéªŒè¯éŸ³åŸŸæ˜¯å¦ç«‹å³æ›´æ–°');

                // æ˜¾ç¤ºå½“å‰çŠ¶æ€
                const rangeMin = document.getElementById('rangeMin').value;
                const rangeMax = document.getElementById('rangeMax').value;

                // è·å–æ‰€æœ‰è°±å·å¤é€‰æ¡†
                const trebleCheckbox = document.getElementById('clef-treble');
                const bassCheckbox = document.getElementById('clef-bass');
                const altoCheckbox = document.getElementById('clef-alto');

                if (trebleCheckbox && bassCheckbox && altoCheckbox) {
                    // æ­¥éª¤1ï¼šæ¸…é™¤æ‰€æœ‰é€‰æ‹©ï¼Œç„¶ååªé€‰æ‹©ä½éŸ³è°±å·
                    trebleCheckbox.checked = false;
                    altoCheckbox.checked = false;
                    bassCheckbox.checked = true;
                    bassCheckbox.dispatchEvent(new Event('change')); // è§¦å‘changeäº‹ä»¶

                    setTimeout(() => {
                        const newMin = document.getElementById('rangeMin').value;
                        const newMax = document.getElementById('rangeMax').value;

                        // æ­¥éª¤2ï¼šåˆ‡æ¢åˆ°é«˜éŸ³è°±å·
                        bassCheckbox.checked = false;
                        trebleCheckbox.checked = true;
                        trebleCheckbox.dispatchEvent(new Event('change'));

                        setTimeout(() => {
                            const trebleMin = document.getElementById('rangeMin').value;
                            const trebleMax = document.getElementById('rangeMax').value;

                            // æ­¥éª¤3ï¼šåˆ‡æ¢åˆ°ä¸­éŸ³è°±å·
                            trebleCheckbox.checked = false;
                            altoCheckbox.checked = true;
                            altoCheckbox.dispatchEvent(new Event('change'));

                            setTimeout(() => {
                                const altoMin = document.getElementById('rangeMin').value;
                                const altoMax = document.getElementById('rangeMax').value;

                                console.groupEnd();

                                alert('âœ… å®æ—¶è°±å·åˆ‡æ¢æµ‹è¯•å®Œæˆï¼\néŸ³åŸŸåº”è¯¥æ ¹æ®è°±å·é€‰æ‹©ç«‹å³æ›´æ–°ã€‚\nè¯·æŸ¥çœ‹æ§åˆ¶å°è¯¦ç»†æ—¥å¿—ã€‚');
                            }, 300);
                        }, 300);
                    }, 300);
                } else {
                    console.error('âŒ æœªæ‰¾åˆ°è°±å·å¤é€‰æ¡†');
                    console.groupEnd();
                }
            };

            // ğŸ§ª æµ‹è¯•ç®€åŒ–åçš„éŸ³åŸŸè®¾ç½®é€»è¾‘
            window.testSimplifiedRangeSetting = function() {
                console.group('ğŸ¼ æµ‹è¯•ç®€åŒ–åçš„éŸ³åŸŸè®¾ç½®é€»è¾‘');
                console.log('æµ‹è¯•åœºæ™¯ï¼šæ¯æ¬¡ç”Ÿæˆåï¼ŒéŸ³åŸŸæ— æ¡ä»¶è®¾ç½®ä¸ºç”Ÿæˆè°±å·çš„é»˜è®¤éŸ³åŸŸ');

                let testCount = 0;
                const maxTests = 3;

                function runSingleTest() {
                    testCount++;

                    // æ˜¾ç¤ºç”Ÿæˆå‰çŠ¶æ€
                    const beforeMin = document.getElementById('rangeMin').value;
                    const beforeMax = document.getElementById('rangeMax').value;
                    const beforeMinNote = window.intervalSettings.midiToNote(parseInt(beforeMin));
                    const beforeMaxNote = window.intervalSettings.midiToNote(parseInt(beforeMax));
                    console.log(`ç”Ÿæˆå‰éŸ³åŸŸ: ${beforeMinNote}-${beforeMaxNote} (MIDI: ${beforeMin}-${beforeMax})`);

                    // ç¡®ä¿é€‰æ‹©äº†å¤šä¸ªè°±å·
                    const trebleCheckbox = document.getElementById('clef-treble');
                    const bassCheckbox = document.getElementById('clef-bass');
                    const altoCheckbox = document.getElementById('clef-alto');

                    if (trebleCheckbox) trebleCheckbox.checked = true;
                    if (bassCheckbox) bassCheckbox.checked = true;
                    if (altoCheckbox) altoCheckbox.checked = true;

                    // ç”ŸæˆéŸ³ç¨‹

                    if (typeof window.generateIntervals === 'function') {
                        window.generateIntervals().then(() => {
                            // ç­‰å¾…éŸ³åŸŸè®¾ç½®å®Œæˆ
                            setTimeout(() => {
                                const afterMin = document.getElementById('rangeMin').value;
                                const afterMax = document.getElementById('rangeMax').value;
                                const afterMinNote = window.intervalSettings.midiToNote(parseInt(afterMin));
                                const afterMaxNote = window.intervalSettings.midiToNote(parseInt(afterMax));
                                const generatedClef = window.currentActiveClef;

                                console.log(`ç”ŸæˆåéŸ³åŸŸ: ${afterMinNote}-${afterMaxNote} (MIDI: ${afterMin}-${afterMax})`);
                                console.log(`ç”Ÿæˆçš„è°±å·: ${generatedClef}`);

                                // éªŒè¯éŸ³åŸŸæ˜¯å¦åŒ¹é…
                                const expectedRanges = {
                                    'treble': { min: 60, max: 72, name: 'C4-C5' },
                                    'bass': { min: 40, max: 64, name: 'E2-E4' },
                                    'alto': { min: 48, max: 67, name: 'C3-G4' }
                                };

                                const expected = expectedRanges[generatedClef];
                                if (expected &&
                                    parseInt(afterMin) === expected.min &&
                                    parseInt(afterMax) === expected.max) {
                                } else {
                                    console.log(`âŒ éŸ³åŸŸä¸åŒ¹é…ï¼ŒæœŸæœ›: ${expected ? expected.name : 'æœªçŸ¥'}ï¼Œå®é™…: ${afterMinNote}-${afterMaxNote}`);
                                }

                                // ç»§ç»­ä¸‹ä¸€æ¬¡æµ‹è¯•æˆ–ç»“æŸ
                                if (testCount < maxTests) {
                                    setTimeout(() => runSingleTest(), 1000);
                                } else {
                                    console.log('æ ¸å¿ƒéªŒè¯ï¼šæ¯æ¬¡ç”ŸæˆåéŸ³åŸŸéƒ½åº”è¯¥è‡ªåŠ¨è®¾ç½®ä¸ºè¯¥æ¬¡ç”Ÿæˆè°±å·çš„é»˜è®¤éŸ³åŸŸ');
                                    console.groupEnd();

                                    alert(`âœ… ç®€åŒ–é€»è¾‘æµ‹è¯•å®Œæˆï¼\nè¿›è¡Œäº†${maxTests}æ¬¡æµ‹è¯•ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°äº†è§£è¯¦ç»†ç»“æœã€‚\næ¯æ¬¡ç”ŸæˆåéŸ³åŸŸéƒ½åº”è¯¥è®¾ç½®ä¸ºå¯¹åº”è°±å·çš„é»˜è®¤éŸ³åŸŸã€‚`);
                                }
                            }, 800); // ç­‰å¾…éŸ³åŸŸè®¾ç½®å®Œæˆ
                        }).catch(error => {
                            console.error('âŒ ç”Ÿæˆå¤±è´¥:', error);
                            console.groupEnd();
                        });
                    } else {
                        console.error('âŒ generateIntervals å‡½æ•°ä¸å­˜åœ¨');
                        console.groupEnd();
                    }
                }

                // å¼€å§‹ç¬¬ä¸€æ¬¡æµ‹è¯•
                runSingleTest();
            };

            // ğŸ§ª æµ‹è¯•ç”Ÿæˆæ—¶è°±å·å˜åŒ–çš„éŸ³åŸŸè‡ªåŠ¨è°ƒæ•´
            window.testGeneratedClefSwitching = function() {
                console.group('ğŸ¼ æµ‹è¯•ç”Ÿæˆæ—¶è°±å·å˜åŒ–çš„éŸ³åŸŸè‡ªåŠ¨è°ƒæ•´');
                console.log('æµ‹è¯•åœºæ™¯ï¼šç”ŸæˆéŸ³ç¨‹æ—¶å¦‚æœè°±å·å˜åŒ–ï¼ŒéŸ³åŸŸåº”ç«‹å³è°ƒæ•´');

                // æ˜¾ç¤ºåˆå§‹çŠ¶æ€
                const initialMin = document.getElementById('rangeMin').value;
                const initialMax = document.getElementById('rangeMax').value;
                const initialMinNote = window.intervalSettings.midiToNote(parseInt(initialMin));
                const initialMaxNote = window.intervalSettings.midiToNote(parseInt(initialMax));

                // é€‰æ‹©å¤šä¸ªè°±å·è®©ç³»ç»Ÿéšæœºé€‰æ‹©
                const trebleCheckbox = document.getElementById('clef-treble');
                const bassCheckbox = document.getElementById('clef-bass');
                const altoCheckbox = document.getElementById('clef-alto');

                // ç¡®ä¿é€‰æ‹©äº†å¤šä¸ªè°±å·
                if (trebleCheckbox) trebleCheckbox.checked = true;
                if (bassCheckbox) bassCheckbox.checked = true;
                if (altoCheckbox) altoCheckbox.checked = true;


                // ç”ŸæˆéŸ³ç¨‹

                if (typeof window.generateIntervals === 'function') {
                    window.generateIntervals().then(() => {
                        // ç­‰å¾…ä¸€æ®µæ—¶é—´ç¡®ä¿éŸ³åŸŸè°ƒæ•´å®Œæˆ
                        setTimeout(() => {
                            const finalMin = document.getElementById('rangeMin').value;
                            const finalMax = document.getElementById('rangeMax').value;
                            const finalMinNote = window.intervalSettings.midiToNote(parseInt(finalMin));
                            const finalMaxNote = window.intervalSettings.midiToNote(parseInt(finalMax));


                            // æ£€æŸ¥éŸ³åŸŸæ˜¯å¦åŒ¹é…è°±å·
                            const expectedRanges = {
                                'treble': { min: 60, max: 72, name: 'C4-C5' },
                                'bass': { min: 40, max: 64, name: 'E2-E4' },
                                'alto': { min: 48, max: 67, name: 'C3-G4' }
                            };

                            const currentClef = window.currentActiveClef;
                            const expectedRange = expectedRanges[currentClef];

                            if (expectedRange &&
                                parseInt(finalMin) === expectedRange.min &&
                                parseInt(finalMax) === expectedRange.max) {
                            } else {
                                console.log(`âš ï¸ éŸ³åŸŸä¸åŒ¹é…é¢„æœŸï¼Œå½“å‰: ${finalMinNote}-${finalMaxNote}ï¼ŒæœŸæœ›: ${expectedRange ? expectedRange.name : 'æœªçŸ¥'}`);
                            }

                            console.groupEnd();

                            alert('âœ… ç”Ÿæˆæ—¶è°±å·å˜åŒ–æµ‹è¯•å®Œæˆï¼\nè¯·æŸ¥çœ‹æ§åˆ¶å°äº†è§£è¯¦ç»†ç»“æœã€‚\nå¦‚æœç”Ÿæˆçš„è°±å·å‘ç”Ÿå˜åŒ–ï¼ŒéŸ³åŸŸåº”è¯¥è‡ªåŠ¨è°ƒæ•´ã€‚');
                        }, 1000); // ç­‰å¾…éŸ³åŸŸè°ƒæ•´å®Œæˆ
                    }).catch(error => {
                        console.error('âŒ ç”Ÿæˆå¤±è´¥:', error);
                        console.groupEnd();
                    });
                } else {
                    console.error('âŒ generateIntervals å‡½æ•°ä¸å­˜åœ¨');
                    console.groupEnd();
                }
            };

            // ğŸ§ª æ·»åŠ ç”Ÿæˆæ—¶éŸ³åŸŸåˆ‡æ¢æµ‹è¯•
            window.testGenerationSwitching = function() {
                console.group('ğŸ¼ æµ‹è¯•éŸ³ç¨‹ç”Ÿæˆæ—¶çš„è‡ªåŠ¨éŸ³åŸŸåˆ‡æ¢');
                console.log('æµ‹è¯•åœºæ™¯ï¼šé€‰æ‹©ä¸åŒè°±å·å¹¶ç”ŸæˆéŸ³ç¨‹ï¼ŒéªŒè¯éŸ³åŸŸæ˜¯å¦è‡ªåŠ¨åˆ‡æ¢');

                // æ¨¡æ‹Ÿé€‰æ‹©ä½éŸ³è°±å·å¹¶ç”Ÿæˆ
                const bassCheckbox = document.getElementById('clef-bass');
                const trebleCheckbox = document.getElementById('clef-treble');
                const altoCheckbox = document.getElementById('clef-alto');

                // æ¸…é™¤æ‰€æœ‰é€‰æ‹©
                if (trebleCheckbox) trebleCheckbox.checked = false;
                if (altoCheckbox) altoCheckbox.checked = false;
                if (bassCheckbox) {
                    bassCheckbox.checked = true;

                    // æ˜¾ç¤ºå½“å‰éŸ³åŸŸ
                    const rangeMin = document.getElementById('rangeMin').value;
                    const rangeMax = document.getElementById('rangeMax').value;

                    console.log('ğŸ’¡ æˆ–è€…åœ¨æ§åˆ¶å°è¿è¡Œ generateIntervals() æ¥è§¦å‘ç”Ÿæˆ');

                    // è‡ªåŠ¨è§¦å‘ç”Ÿæˆæµ‹è¯•
                    setTimeout(() => {
                        if (typeof window.generateIntervals === 'function') {
                            window.generateIntervals();
                        }
                    }, 2000);
                } else {
                    console.warn('âš ï¸ æœªæ‰¾åˆ°ä½éŸ³è°±å·å¤é€‰æ¡†');
                }

                console.groupEnd();
            };

            // ğŸ§ª æµ‹è¯•ç”¨æˆ·æä¾›çš„éŸ³åŸŸä¿å­˜å‡½æ•°
            window.testUserFunctions = function() {
                console.group('ğŸ§ª æµ‹è¯•ç”¨æˆ·æä¾›çš„éŸ³åŸŸä¿å­˜å‡½æ•°');
                console.log('æµ‹è¯•åœºæ™¯ï¼šéªŒè¯ saveRangeForCurrentClef() å’Œ loadRangeForClef() å‡½æ•°');

                // æ­¥éª¤1ï¼šåˆ‡æ¢åˆ°ä½éŸ³è°±å·
                window.switchToClefRange('bass');
                console.log(`å½“å‰æ´»è·ƒè°±å·: ${window.currentActiveClef}`);

                // æ­¥éª¤2ï¼šä¿®æ”¹éŸ³åŸŸ
                setTimeout(() => {
                    const rangeMinSelect = document.getElementById('rangeMin');
                    const rangeMaxSelect = document.getElementById('rangeMax');
                    rangeMinSelect.value = '41'; // F2
                    rangeMaxSelect.value = '65'; // F4

                    // æ­¥éª¤3ï¼šè°ƒç”¨ç”¨æˆ·å‡½æ•°ä¿å­˜
                    window.saveRangeForCurrentClef();

                    // æ­¥éª¤4ï¼šæ£€æŸ¥å†…å­˜çŠ¶æ€
                    console.log('clefRangeMemory:', window.clefRangeMemory);

                    // æ­¥éª¤5ï¼šåˆ‡æ¢åˆ°å…¶ä»–è°±å·å†åˆ‡æ¢å›æ¥æµ‹è¯•åŠ è½½
                    setTimeout(() => {
                        window.switchToClefRange('treble');

                        setTimeout(() => {
                            window.currentActiveClef = 'bass';
                            window.loadRangeForClef('bass');

                            const finalMin = document.getElementById('rangeMin').value;
                            const finalMax = document.getElementById('rangeMax').value;

                            console.groupEnd();
                        }, 1000);
                    }, 1000);
                }, 1000);
            };

            // ğŸ§ª æµ‹è¯•å®Œæ•´çš„æ–°å‡½æ•°ç³»ç»Ÿ
            window.testNewFunctionSystem = function() {
                console.group('ğŸ§ª æµ‹è¯•å®Œæ•´çš„æ–°å‡½æ•°ç³»ç»Ÿ');
                console.log('æµ‹è¯•åœºæ™¯ï¼šéªŒè¯æ‰€æœ‰æ–°æ·»åŠ çš„ç”¨æˆ·å‡½æ•°');

                console.log('æµ‹è¯•å„è°±å·çš„é»˜è®¤éŸ³åŸŸè®¾ç½®...');

                // æµ‹è¯•é«˜éŸ³è°±å·
                window.setRangeForClef('treble');
                let currentMin = document.getElementById('rangeMin').value;
                let currentMax = document.getElementById('rangeMax').value;

                setTimeout(() => {
                    // æµ‹è¯•ä½éŸ³è°±å·
                    window.setRangeForClef('bass');
                    currentMin = document.getElementById('rangeMin').value;
                    currentMax = document.getElementById('rangeMax').value;

                    setTimeout(() => {
                        // æµ‹è¯•ä¸­éŸ³è°±å·
                        window.setRangeForClef('alto');
                        currentMin = document.getElementById('rangeMin').value;
                        currentMax = document.getElementById('rangeMax').value;

                        setTimeout(() => {

                            // ä¿®æ”¹ä¸­éŸ³è°±å·éŸ³åŸŸå¹¶ä¿å­˜ (æµ‹è¯•è‡ªå®šä¹‰éŸ³åŸŸ)
                            document.getElementById('rangeMin').value = '45'; // A2
                            document.getElementById('rangeMax').value = '69'; // A4

                            // æ‰‹åŠ¨ä¿å­˜
                            window.saveRangeForCurrentClef();

                            // åˆ‡æ¢åˆ°å…¶ä»–è°±å·
                            window.setRangeForClef('treble');
                            console.log('ğŸ”„ åˆ‡æ¢åˆ°é«˜éŸ³è°±å·');

                            // åˆ‡æ¢å›ä¸­éŸ³è°±å·éªŒè¯è®°å¿†
                            setTimeout(() => {
                                window.setRangeForClef('alto');
                                const finalMin = document.getElementById('rangeMin').value;
                                const finalMax = document.getElementById('rangeMax').value;

                                console.log('clefRangeMemory:', window.clefRangeMemory);

                                console.groupEnd();
                            }, 1000);
                        }, 1000);
                    }, 1000);
                }, 1000);
            };

            // ğŸ§ª æµ‹è¯•ç”¨æˆ·çš„å…·ä½“éœ€æ±‚ - ç”Ÿæˆåè‡ªåŠ¨åˆ‡æ¢åˆ°é»˜è®¤éŸ³åŸŸ
            window.testUserRequirement = function() {
                console.group('ğŸ¯ æµ‹è¯•ç”¨æˆ·å…·ä½“éœ€æ±‚ï¼šç”Ÿæˆåè‡ªåŠ¨åˆ‡æ¢åˆ°è°±å·é»˜è®¤éŸ³åŸŸ');
                console.log('éœ€æ±‚éªŒè¯ï¼šç”ŸæˆéŸ³ç¨‹ â†’ ä½¿ç”¨å½“å‰éŸ³åŸŸ â†’ ç”Ÿæˆååˆ‡æ¢åˆ°å®é™…è°±å·çš„é»˜è®¤éŸ³åŸŸ');

                // æ­¥éª¤1ï¼šæ‰‹åŠ¨è®¾ç½®ä¸€ä¸ªéé»˜è®¤éŸ³åŸŸ
                const rangeMinSelect = document.getElementById('rangeMin');
                const rangeMaxSelect = document.getElementById('rangeMax');
                rangeMinSelect.value = '53'; // F3
                rangeMaxSelect.value = '65'; // F4

                // æ­¥éª¤2ï¼šé€‰æ‹©æ‰€æœ‰è°±å·è®©ç³»ç»Ÿéšæœºé€‰æ‹©
                const trebleCheckbox = document.getElementById('clef-treble');
                const bassCheckbox = document.getElementById('clef-bass');
                const altoCheckbox = document.getElementById('clef-alto');

                if (trebleCheckbox) trebleCheckbox.checked = true;
                if (bassCheckbox) bassCheckbox.checked = true;
                if (altoCheckbox) altoCheckbox.checked = true;

                // æ­¥éª¤3ï¼šç”ŸæˆéŸ³ç¨‹
                console.log('é¢„æœŸç»“æœï¼š');
                console.log('1. éŸ³ç¨‹ä½¿ç”¨å½“å‰çš„ F3-F4 éŸ³åŸŸç”Ÿæˆ');
                console.log('2. ç”Ÿæˆå®ŒæˆåUIè‡ªåŠ¨åˆ‡æ¢åˆ°å®é™…ç”Ÿæˆè°±å·çš„é»˜è®¤éŸ³åŸŸ');
                console.log('3. ä¾‹å¦‚ç”Ÿæˆäº†ä½éŸ³è°±å·ï¼ŒUIåº”åˆ‡æ¢åˆ° E2-E4');

                setTimeout(() => {
                    if (typeof window.generateIntervals === 'function') {
                        window.generateIntervals().then(() => {
                            // æ£€æŸ¥ç”Ÿæˆåçš„éŸ³åŸŸUI
                            setTimeout(() => {
                                const finalMin = document.getElementById('rangeMin').value;
                                const finalMax = document.getElementById('rangeMax').value;
                                const minNote = window.intervalSettings.midiToNote(parseInt(finalMin));
                                const maxNote = window.intervalSettings.midiToNote(parseInt(finalMax));


                                // åˆ¤æ–­æ˜¯å¦åˆ‡æ¢åˆ°äº†æ­£ç¡®çš„é»˜è®¤éŸ³åŸŸ
                                const expectedRanges = {
                                    'treble': '60-72', // C4-C5
                                    'bass': '40-64',   // E2-E4
                                    'alto': '48-67'    // C3-G4
                                };

                                const currentRange = `${finalMin}-${finalMax}`;
                                const matchedClef = Object.keys(expectedRanges).find(clef =>
                                    expectedRanges[clef] === currentRange
                                );

                                if (matchedClef) {
                                } else {
                                    console.log(`âš ï¸ UIéŸ³åŸŸ ${currentRange} ä¸åŒ¹é…ä»»ä½•é»˜è®¤éŸ³åŸŸ`);
                                }

                                console.groupEnd();
                            }, 500);
                        }).catch(error => {
                            console.error('âŒ ç”Ÿæˆå¤±è´¥:', error);
                            console.groupEnd();
                        });
                    }
                }, 1000);
            };

            // ğŸ§ª å¼€å‘è€…æ§åˆ¶å°è¯´æ˜
            console.group('ğŸ¼ è°±å·-éŸ³åŸŸæ™ºèƒ½ç»‘å®šç³»ç»Ÿæµ‹è¯•æŒ‡å—');
            console.log('å¯ç”¨æµ‹è¯•å‡½æ•°:');
            console.log('â€¢ testUserFunctions() - ğŸ†• æµ‹è¯•ç”¨æˆ·æä¾›çš„éŸ³åŸŸä¿å­˜å‡½æ•°');
            console.log('â€¢ testNewLogic() - ğŸ†• æµ‹è¯•æ–°çš„éŸ³ç¨‹ç”Ÿæˆé€»è¾‘');
            console.log('â€¢ testGenerationSwitching() - æµ‹è¯•ç”Ÿæˆæ—¶è‡ªåŠ¨éŸ³åŸŸåˆ‡æ¢');
            console.log('â€¢ testClefRangeSwitching() - æµ‹è¯•è‡ªåŠ¨éŸ³åŸŸåˆ‡æ¢');
            console.log('â€¢ testUserCustomRange() - æµ‹è¯•ç”¨æˆ·è‡ªå®šä¹‰éŸ³åŸŸç»‘å®š');
            console.log('â€¢ showClefBindingStatus() - æŸ¥çœ‹å½“å‰ç»‘å®šçŠ¶æ€');
            console.log('â€¢ switchToClefRange("treble"|"bass"|"alto") - æ‰‹åŠ¨åˆ‡æ¢è°±å·');
            console.log('â€¢ saveRangeForCurrentClef() - ä¿å­˜å½“å‰è°±å·çš„éŸ³åŸŸè®¾ç½®');
            console.log('â€¢ loadRangeForClef(clef) - åŠ è½½æŒ‡å®šè°±å·çš„éŸ³åŸŸè®¾ç½®');
            console.log('â€¢ initRangeListeners() - åˆå§‹åŒ–éŸ³åŸŸç›‘å¬å™¨');
            console.log('â€¢ setRangeForClef(clef) - æ ¹æ®è°±å·è®¾ç½®åˆé€‚çš„éŸ³åŸŸ');
            console.log('â€¢ é«˜éŸ³è°±å·é»˜è®¤: C4-C5 (60-72) â† ä¸å’Œå¼¦è§†å¥å·¥å…·ä¸€è‡´');
            console.log('â€¢ ä½éŸ³è°±å·é»˜è®¤: E2-E4 (40-64) â† ä¸å’Œå¼¦è§†å¥å·¥å…·ä¸€è‡´');
            console.log('â€¢ ä¸­éŸ³è°±å·é»˜è®¤: C3-G4 (48-67) â† åˆç†çš„ä¸­éŸ³è°±å·éŸ³åŸŸ');
            console.log('â€¢ ç”ŸæˆéŸ³ç¨‹ä½¿ç”¨å½“å‰UIéŸ³åŸŸè®¾ç½®');
            console.log('â€¢ ç”Ÿæˆå®Œæˆåâ†’æ ¹æ®å®é™…ç”Ÿæˆçš„è°±å·åˆ‡æ¢éŸ³åŸŸUI');
            console.log('â€¢ ç”¨æˆ·è°ƒæ•´éŸ³åŸŸâ†’è‡ªåŠ¨ç»‘å®šåˆ°å½“å‰è°±å·ï¼Œæˆä¸ºè¯¥è°±å·å›ºå®šéŸ³åŸŸ');
            console.log('â€¢ å„è°±å·éŸ³åŸŸå®Œå…¨ç‹¬ç«‹ï¼Œäº’ä¸å½±å“');
            console.groupEnd();
        });

        // é‡å†™æ¨¡æ€æ¡†å…³é—­å‡½æ•°ä»¥é‡ç½®å…¨é€‰çŠ¶æ€
        const originalCloseRhythmSettings = window.closeRhythmSettings;
        const originalCloseArticulationSettings = window.closeArticulationSettings;
        const originalCloseKeySettings = window.closeKeySettings;
        const originalCloseTimeSignatureSettings = window.closeTimeSignatureSettings;
        const originalCloseIntervalSettings = window.closeIntervalSettings;
        const originalCloseClefSettings = window.closeClefSettings;

        if (typeof originalCloseRhythmSettings === 'function') {
            window.closeRhythmSettings = function() {
                originalCloseRhythmSettings();
                if (typeof resetSelectAllStates === 'function') resetSelectAllStates();
            };
        }

        if (typeof originalCloseArticulationSettings === 'function') {
            window.closeArticulationSettings = function() {
                originalCloseArticulationSettings();
                if (typeof resetSelectAllStates === 'function') resetSelectAllStates();
            };
        }

        if (typeof originalCloseKeySettings === 'function') {
            window.closeKeySettings = function() {
                originalCloseKeySettings();
                if (typeof resetSelectAllStates === 'function') resetSelectAllStates();
            };
        }

        if (typeof originalCloseTimeSignatureSettings === 'function') {
            window.closeTimeSignatureSettings = function() {
                originalCloseTimeSignatureSettings();
                if (typeof resetSelectAllStates === 'function') resetSelectAllStates();
            };
        }

        if (typeof originalCloseIntervalSettings === 'function') {
            window.closeIntervalSettings = function() {
                originalCloseIntervalSettings();
                if (typeof resetSelectAllStates === 'function') resetSelectAllStates();
            };
        }

        if (typeof originalCloseClefSettings === 'function') {
            window.closeClefSettings = function() {
                originalCloseClefSettings();
                if (typeof resetSelectAllStates === 'function') resetSelectAllStates();
            };
        }

        // åŠ¨æ€éšè—åŒ…å«ç‰¹å®šæ–‡æœ¬çš„SVGå…ƒç´ 
        function hideTitleAndInstrumentElements() {
            // ç­‰å¾…ä¸€ä¼šå„¿è®©OSMDæ¸²æŸ“å®Œæˆ
            setTimeout(() => {
                const scoreDiv = document.getElementById('score');
                if (scoreDiv) {
                    // æŸ¥æ‰¾æ‰€æœ‰SVG textå…ƒç´ 
                    const textElements = scoreDiv.querySelectorAll('svg text');
                    textElements.forEach(element => {
                        const text = element.textContent || element.innerText;
                        if (text && (
                            text.includes('Piano') || 
                            text.includes('Untitled') || 
                            text.includes('Untitled Score') ||
                            text.trim() === 'Piano' ||
                            text.trim() === 'Untitled Score'
                        )) {
                            element.style.display = 'none';
                            element.style.visibility = 'hidden';
                            console.log('éšè—æ–‡æœ¬å…ƒç´ :', text);
                        }
                    });
                    
                    // ä¹Ÿæ£€æŸ¥å…¶ä»–å¯èƒ½çš„å…ƒç´ 
                    const allElements = scoreDiv.querySelectorAll('*');
                    allElements.forEach(element => {
                        const text = element.textContent || element.innerText;
                        if (text && element.tagName !== 'SCRIPT' && (
                            text.trim() === 'Piano' ||
                            text.trim() === 'Untitled Score'
                        )) {
                            element.style.display = 'none';
                            element.style.visibility = 'hidden';
                            console.log('éšè—å…ƒç´ :', element.tagName, text);
                        }
                    });
                }
            }, 500);
        }
        
        // æ¸…é™¤ç©ºè°±å­æç¤ºä¿¡æ¯
        function clearEmptyScoreMessage() {
            const scoreDiv = document.getElementById('score');
            if (scoreDiv) {
                const emptyMessage = scoreDiv.querySelector('.empty-score-message');
                if (emptyMessage) {
                    emptyMessage.remove();
                }
            }
        }

        // ç›‘å¬OSMDæ¸²æŸ“å®Œæˆ
        const originalGenerateIntervals = window.generateIntervals;
        if (originalGenerateIntervals) {
            window.generateIntervals = function(...args) {
                // ğŸµ è‡ªåŠ¨åœæ­¢å½“å‰æ’­æ”¾
                if (typeof window.isPlayingInterval !== 'undefined' && window.isPlayingInterval) {
                    window.isPlayingInterval = false;
                    if (window.intervalScheduledSounds) {
                        window.intervalScheduledSounds.forEach(sound => {
                            try {
                                if (sound.oscillator) sound.oscillator.stop();
                                if (sound.source) sound.source.stop();
                                if (sound.element) {
                                    sound.element.pause();
                                    sound.element.src = '';
                                }
                            } catch (e) {}
                        });
                        window.intervalScheduledSounds = [];
                    }
                    // æ›´æ–°æ’­æ”¾æŒ‰é’®çŠ¶æ€
                    const playBtn = document.getElementById('playIntervalBtn');
                    if (playBtn) {
                        playBtn.innerHTML = 'æ’­æ”¾';
                    }
                }

                // æ¸…é™¤ç©ºè°±å­æç¤ºä¿¡æ¯
                clearEmptyScoreMessage();

                const result = originalGenerateIntervals.apply(this, args);
                hideTitleAndInstrumentElements();
                return result;
            };
        }

        // åŒ…è£… previousInterval å’Œ nextIntervalï¼Œæ·»åŠ åœæ­¢æ’­æ”¾é€»è¾‘
        const originalPreviousInterval = window.previousInterval;
        if (originalPreviousInterval) {
            window.previousInterval = function(...args) {
                if (typeof window.isPlayingInterval !== 'undefined' && window.isPlayingInterval) {
                    window.isPlayingInterval = false;
                    if (window.intervalScheduledSounds) {
                        window.intervalScheduledSounds.forEach(sound => {
                            try {
                                if (sound.oscillator) sound.oscillator.stop();
                                if (sound.source) sound.source.stop();
                                if (sound.element) {
                                    sound.element.pause();
                                    sound.element.src = '';
                                }
                            } catch (e) {}
                        });
                        window.intervalScheduledSounds = [];
                    }
                    const playBtn = document.getElementById('playIntervalBtn');
                    if (playBtn) {
                        playBtn.innerHTML = 'æ’­æ”¾';
                    }
                }
                return originalPreviousInterval.apply(this, args);
            };
        }

        const originalNextInterval = window.nextInterval;
        if (originalNextInterval) {
            window.nextInterval = function(...args) {
                if (typeof window.isPlayingInterval !== 'undefined' && window.isPlayingInterval) {
                    window.isPlayingInterval = false;
                    if (window.intervalScheduledSounds) {
                        window.intervalScheduledSounds.forEach(sound => {
                            try {
                                if (sound.oscillator) sound.oscillator.stop();
                                if (sound.source) sound.source.stop();
                                if (sound.element) {
                                    sound.element.pause();
                                    sound.element.src = '';
                                }
                            } catch (e) {}
                        });
                        window.intervalScheduledSounds = [];
                    }
                    const playBtn = document.getElementById('playIntervalBtn');
                    if (playBtn) {
                        playBtn.innerHTML = 'æ’­æ”¾';
                    }
                }
                return originalNextInterval.apply(this, args);
            };
        }

        // é¡µé¢åŠ è½½å®Œæˆåä¹Ÿæ‰§è¡Œä¸€æ¬¡
        document.addEventListener('DOMContentLoaded', () => {
            hideTitleAndInstrumentElements();
            // å®šæœŸæ£€æŸ¥
            setInterval(hideTitleAndInstrumentElements, 2000);
            
            // æ·»åŠ ç‚¹å‡»å®¹å™¨è§¦å‘ç”ŸæˆéŸ³ç¨‹åŠŸèƒ½
            const scoreContainer = document.querySelector('.score-container');
            if (scoreContainer) {
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
                scoreContainer.addEventListener('click', function(event) {
                    // ç¡®ä¿ generateIntervals å‡½æ•°å­˜åœ¨
                    if (typeof generateIntervals === 'function') {
                        generateIntervals();
                    } else {
                        console.warn('generateIntervals å‡½æ•°æœªæ‰¾åˆ°');
                    }
                });
                
                // æ·»åŠ é¼ æ ‡æ‚¬åœæ ·å¼æç¤º
                scoreContainer.style.cursor = 'pointer';
                scoreContainer.title = 'ç‚¹å‡»ä»»æ„ä½ç½®ç”Ÿæˆæ–°éŸ³ç¨‹';
                
            } else {
                console.warn('æœªæ‰¾åˆ° .score-container å…ƒç´ ');
            }
        });

        // ======================================
        // ğŸµ éŸ³ç¨‹æ’­æ”¾æ¨¡å¼å’Œéšè—æ¨¡å¼åŠŸèƒ½ï¼ˆä»æ—‹å¾‹è§†å¥å·¥å…·å¤åˆ¶ï¼‰
        // ======================================

        // éšè—æ¨¡å¼å˜é‡å’Œå‡½æ•°
        var isIntervalHidden = false;

        /**
         * ğŸ­ åº”ç”¨éŸ³ç¨‹éšè—çŠ¶æ€åˆ°å½“å‰ä¹è°±
         */
        function applyIntervalHiddenState() {
            const scoreElement = document.getElementById('score');
            if (!scoreElement) return;

            const svgElements = scoreElement.querySelectorAll('svg');
            if (isIntervalHidden) {
                // åŒæ­¥éšè—å®¹å™¨ä¸SVGï¼Œé¿å…æ¸²æŸ“å‰åçŠ¶æ€ä¸ä¸€è‡´
                scoreElement.style.opacity = '0';
                scoreElement.style.filter = 'blur(10px)';

                svgElements.forEach(svg => {
                    svg.classList.add('melody-hidden');
                    svg.style.opacity = '0';
                    svg.style.filter = 'blur(10px)';
                });
                console.log('ğŸ‘‚ å·²åº”ç”¨éšè—çŠ¶æ€åˆ°éŸ³ç¨‹');
            } else {
                // æ¸…é™¤å®¹å™¨ä¸SVGä¸Šçš„éšè—æ ·å¼ï¼Œç¡®ä¿å¯è§
                scoreElement.style.opacity = '1';
                scoreElement.style.filter = 'none';

                svgElements.forEach(svg => {
                    svg.classList.remove('melody-hidden');
                    svg.style.opacity = '1';
                    svg.style.filter = 'none';
                });
                console.log('ğŸ‘€ å·²åº”ç”¨æ˜¾ç¤ºçŠ¶æ€åˆ°éŸ³ç¨‹');
            }
        }

        /**
         * ğŸ­ æ›´æ–°éšè—æŒ‰é’®çš„çŠ¶æ€
         */
        function updateVisibilityButton() {
            const visibilityBtn = document.getElementById('intervalVisibilityBtn');
            if (!visibilityBtn) return;

            if (isIntervalHidden) {
                visibilityBtn.innerHTML = 'ğŸ‘‚';
                visibilityBtn.title = 'æ˜¾ç¤ºéŸ³ç¨‹';
                visibilityBtn.classList.add('hidden-state');
            } else {
                visibilityBtn.innerHTML = 'ğŸ‘€';
                visibilityBtn.title = 'éšè—éŸ³ç¨‹';
                visibilityBtn.classList.remove('hidden-state');
            }
        }

        function toggleIntervalVisibility() {
            isIntervalHidden = !isIntervalHidden;
            console.log(`ğŸ­ åˆ‡æ¢éšè—çŠ¶æ€: ${isIntervalHidden ? 'éšè—' : 'æ˜¾ç¤º'}`);

            // åº”ç”¨æ–°çŠ¶æ€
            applyIntervalHiddenState();
            updateVisibilityButton();
        }

        // æ’­æ”¾æ¨¡å¼å˜é‡å’Œå‡½æ•°
        window.isPlayingInterval = false;
        window.intervalAudioCtx = null;
        window.intervalScheduledSounds = [];
        window.intervalPlaybackStartTime = null; // æ’­æ”¾å¼€å§‹çš„å®é™…æ—¶é—´ï¼ˆPerformance.now()ï¼‰
        window.intervalPlaybackTempo = 60; // å½“å‰æ’­æ”¾çš„tempo
        window.intervalPlaybackTimeSignature = { beats: 4, beatType: 4 }; // å½“å‰æ’­æ”¾çš„æ‹å·
        window.intervalMetronomeSyncTimeout = null; // èŠ‚æ‹å™¨åŒæ­¥çš„ setTimeout ID

        function directPlayTest() {

            // ğŸ” è°ƒè¯•ï¼šæ£€æŸ¥å½“å‰æ•°æ®çŠ¶æ€
            if (window.currentIntervalProgression) {
                console.log('ğŸ” å½“å‰æ•°æ®çŠ¶æ€:', {
                    measures: window.currentIntervalProgression.measures?.length || 0,
                    tempo: window.currentIntervalProgression.tempo,
                    firstMeasureExists: !!window.currentIntervalProgression.measures?.[0],
                    firstMeasureLowerVoice: window.currentIntervalProgression.measures?.[0]?.lowerVoice?.length || 0,
                    firstMeasureUpperVoice: window.currentIntervalProgression.measures?.[0]?.upperVoice?.length || 0
                });
            }

            if (window.isPlayingInterval) {
                // åœæ­¢æ’­æ”¾
                window.isPlayingInterval = false;
                // ğŸµ æ¸…é™¤æ’­æ”¾çŠ¶æ€å˜é‡
                window.intervalPlaybackStartTime = null;
                window.intervalPlaybackTempo = 60;
                window.intervalPlaybackTimeSignature = { beats: 4, beatType: 4 };

                // ğŸ”§ æ¸…é™¤èŠ‚æ‹å™¨åŒæ­¥çš„ setTimeoutï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if (window.intervalMetronomeSyncTimeout) {
                    clearTimeout(window.intervalMetronomeSyncTimeout);
                    window.intervalMetronomeSyncTimeout = null;
                    console.log('â¹ï¸ å·²æ¸…é™¤èŠ‚æ‹å™¨åŒæ­¥å®šæ—¶å™¨');
                }

                // åœæ­¢æ‰€æœ‰è°ƒåº¦çš„æ’­æ”¾
                if (window.intervalScheduledSounds) {
                    window.intervalScheduledSounds.forEach(sound => {
                        try {
                            // å¤„ç†æŒ¯è¡å™¨èŠ‚ç‚¹ï¼ˆåˆæˆå™¨å›é€€ï¼‰
                            if (sound.oscillator) {
                                sound.oscillator.stop();
                            }
                            // å¤„ç†é‡‡æ ·å™¨çš„ BufferSource èŠ‚ç‚¹
                            if (sound.source) {
                                sound.source.stop();
                            }
                            // å¤„ç† HTMLAudioElementï¼ˆfile:// åè®®ä¸‹çš„å›é€€ï¼‰
                            if (sound.element) {
                                sound.element.pause();
                                sound.element.src = '';
                            }
                        } catch (e) {
                            // èŠ‚ç‚¹å¯èƒ½å·²ç»åœæ­¢ï¼Œå¿½ç•¥é”™è¯¯
                        }
                    });
                    window.intervalScheduledSounds = [];
                }
                updatePlayButton();
                console.log('â¹ï¸ åœæ­¢éŸ³ç¨‹æ’­æ”¾');
                return;
            }

            try {
                // ğŸ¯ ä¿®å¤ï¼šåˆå§‹åŒ–è°ƒåº¦éŸ³é¢‘æ•°ç»„
                if (!window.intervalScheduledSounds) {
                    window.intervalScheduledSounds = [];
                }

                // ğŸ¯ ä¿®å¤ï¼šå¢å¼ºçš„AudioContextåˆå§‹åŒ–å’Œé”™è¯¯å¤„ç†
                if (!window.intervalAudioCtx) {
                    const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                    if (!AudioContextClass) {
                        throw new Error('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒWeb Audio APIï¼Œæ— æ³•æ’­æ”¾éŸ³é¢‘');
                    }
                    window.intervalAudioCtx = new AudioContextClass();
                    console.log('ğŸ¹ åˆ›å»ºäº†æ–°çš„AudioContextï¼ŒçŠ¶æ€:', window.intervalAudioCtx.state);
                }

                // ğŸ¯ ä¿®å¤ï¼šå¼ºåˆ¶æ¢å¤AudioContextçŠ¶æ€ï¼Œå¢åŠ ç”¨æˆ·äº¤äº’æ£€æŸ¥
                if (window.intervalAudioCtx.state === 'suspended') {
                    console.log('ğŸ¹ AudioContextè¢«æš‚åœï¼Œå°è¯•æ¢å¤...');
                    window.intervalAudioCtx.resume().then(() => {
                        console.log('ğŸ¹ AudioContextå·²æ¢å¤ï¼ŒçŠ¶æ€:', window.intervalAudioCtx.state);
                        startIntervalPlayback();
                    }).catch(resumeError => {
                        console.error('âŒ AudioContextæ¢å¤å¤±è´¥:', resumeError);
                        alert('éŸ³é¢‘ä¸Šä¸‹æ–‡æ¢å¤å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•');
                    });
                } else {
                    console.log('ğŸ¹ AudioContextå·²å‡†å¤‡å°±ç»ªï¼ŒçŠ¶æ€:', window.intervalAudioCtx.state);
                    startIntervalPlayback();
                }

            } catch (error) {
                console.error('âŒ éŸ³ç¨‹æ’­æ”¾åˆå§‹åŒ–å¤±è´¥:', error);
                window.isPlayingInterval = false;
                updatePlayButton();
                alert('æ’­æ”¾åˆå§‹åŒ–å¤±è´¥ï¼š' + error.message);
            }
        }

        function startIntervalPlayback() {
            // ğŸ¯ ä¿®å¤ï¼šå¢å¼ºçš„æ•°æ®éªŒè¯å’Œé”™è¯¯å¤„ç†

            if (!window.currentIntervalProgression) {
                console.warn('âš ï¸ æ²¡æœ‰æ‰¾åˆ°éŸ³ç¨‹è¿›è¡Œæ•°æ®');
                alert('è¯·å…ˆç”ŸæˆéŸ³ç¨‹å†æ’­æ”¾');
                return;
            }


            if (!window.currentIntervalProgression.measures || window.currentIntervalProgression.measures.length === 0) {
                console.warn('âš ï¸ éŸ³ç¨‹è¿›è¡Œæ•°æ®ä¸­æ²¡æœ‰å°èŠ‚');
                alert('éŸ³ç¨‹æ•°æ®ä¸å®Œæ•´ï¼Œè¯·é‡æ–°ç”Ÿæˆ');
                return;
            }

            // éªŒè¯ç¬¬ä¸€ä¸ªå°èŠ‚æ˜¯å¦æœ‰æœ‰æ•ˆçš„éŸ³ç¬¦æ•°æ®
            const firstMeasure = window.currentIntervalProgression.measures[0];

            if (!firstMeasure.lowerVoice || !firstMeasure.upperVoice ||
                firstMeasure.lowerVoice.length === 0 || firstMeasure.upperVoice.length === 0) {
                console.warn('âš ï¸ éŸ³ç¨‹è¿›è¡Œæ•°æ®ä¸­æ²¡æœ‰æœ‰æ•ˆçš„éŸ³ç¬¦');
                alert('éŸ³ç¨‹æ•°æ®ä¸å®Œæ•´ï¼Œè¯·é‡æ–°ç”Ÿæˆ');
                return;
            }

            // éªŒè¯éŸ³ç¬¦çš„pitchå­—æ®µ
            let validNoteCount = 0;
            firstMeasure.lowerVoice.forEach((note, index) => {
                if (note.type === 'note' && note.pitch) {
                    validNoteCount++;
                }
            });

            firstMeasure.upperVoice.forEach((note, index) => {
                if (note.type === 'note' && note.pitch) {
                    validNoteCount++;
                }
            });


            if (validNoteCount === 0) {
                console.warn('âš ï¸ æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„éŸ³ç¬¦æ•°æ®');
                alert('éŸ³ç¨‹æ•°æ®ä¸­æ²¡æœ‰æœ‰æ•ˆéŸ³ç¬¦ï¼Œè¯·é‡æ–°ç”Ÿæˆ');
                return;
            }

            console.log('ğŸ“Š æ’­æ”¾æ•°æ®ç»Ÿè®¡:', {
                measures: window.currentIntervalProgression.measures.length,
                firstMeasureNotes: firstMeasure.lowerVoice.length,
                validNotes: validNoteCount,
                tempo: window.currentIntervalProgression.tempo || 120
            });

            window.isPlayingInterval = true;
            // ğŸµ è®°å½•æ’­æ”¾å¼€å§‹æ—¶é—´å’Œå‚æ•°ï¼Œç”¨äºèŠ‚æ‹å™¨åŒæ­¥
            window.intervalPlaybackStartTime = performance.now();
            window.intervalPlaybackTempo = parseInt(document.getElementById('headerMetronomeBpm')?.value) || 60;
            window.intervalPlaybackTimeSignature = window.currentIntervalProgression.timeSignature || { beats: 4, beatType: 4 };

            updatePlayButton();

            // ğŸµ æ£€æŸ¥éšè—æ¨¡å¼ï¼ˆéšè—æ¨¡å¼éœ€è¦count-inï¼‰
            if (isIntervalHidden) {
                if (isMetronomeRunning) {
                    handleHiddenModeWithMetronome(window.currentIntervalProgression);
                } else {
                    playCountIn(window.currentIntervalProgression);
                }
                return;
            }

            // ğŸ”§ æ™ºèƒ½æ’­æ”¾æ—¶é—´ï¼šèŠ‚æ‹å™¨å¼€å¯æ—¶å¯¹é½ç½‘æ ¼ï¼Œå…³é—­æ—¶ç«‹å³å“åº”

            // ç¡®ä¿ AudioContext å·²åˆå§‹åŒ–
            if (!window.intervalAudioCtx) {
                window.intervalAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }

            // è·å–å½“å‰é€Ÿåº¦
            let tempo = 60;
            if (typeof getCurrentTempo === 'function') {
                tempo = getCurrentTempo();
            } else if (typeof metronomeTempo !== 'undefined') {
                tempo = metronomeTempo;
            }

            const beatDuration = 60.0 / tempo;
            const now = window.intervalAudioCtx.currentTime;
            let startTime;

            if (typeof isMetronomeRunning !== 'undefined' && isMetronomeRunning) {
                // ğŸµ èŠ‚æ‹å™¨å¼€å¯ - å¯¹é½å…¨å±€ç½‘æ ¼ç¡®ä¿åŒæ­¥
                const currentBeatNumber = Math.floor(now / beatDuration);
                let nextBeatNumber = currentBeatNumber + 1;
                startTime = nextBeatNumber * beatDuration;

                // å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿ startTime è‡³å°‘åœ¨æœªæ¥ 50ms
                const minLookahead = 0.05;
                if (startTime < now + minLookahead) {
                    nextBeatNumber++;
                    startTime = nextBeatNumber * beatDuration;
                    console.log(`âš ï¸ æ—¶é—´å¤ªè¿‘ï¼Œè·³åˆ°ä¸‹ä¸€æ‹ (ç¬¬${nextBeatNumber}æ‹)`);
                }

                console.log(`ğŸµ èŠ‚æ‹å™¨å¼€å¯ - åŒæ­¥åˆ°å…¨å±€ç½‘æ ¼: BPM=${tempo}, å½“å‰=${now.toFixed(3)}s, æ’­æ”¾=${startTime.toFixed(3)}s (ç¬¬${nextBeatNumber}æ‹)`);
            } else {
                // ğŸš€ èŠ‚æ‹å™¨å…³é—­ - ç«‹å³æ’­æ”¾ï¼Œå“åº”è¿…é€Ÿ
                startTime = now + 0.1;
                console.log(`ğŸš€ èŠ‚æ‹å™¨æœªå¼€å¯ - ç«‹å³æ’­æ”¾: BPM=${tempo}, å½“å‰=${now.toFixed(3)}s, æ’­æ”¾=${startTime.toFixed(3)}s`);
            }

            playIntervalProgression(window.currentIntervalProgression, startTime);
        }

        function updatePlayButton() {
            const playBtn = document.getElementById('playIntervalBtn');
            if (playBtn) {
                if (window.isPlayingInterval) {
                    playBtn.innerHTML = 'åœæ­¢';
                    playBtn.classList.add('playing');
                } else {
                    playBtn.innerHTML = 'æ’­æ”¾';
                    playBtn.classList.remove('playing');
                }
            }
        }

        /**
         * ğŸ­ğŸµ å¤„ç†éšè—æ¨¡å¼ + èŠ‚æ‹å™¨ç»„åˆçš„ç‰¹æ®Šé€»è¾‘
         * @param {Object} progression - éŸ³ç¨‹è¿›è¡Œæ•°æ®
         */
        function handleHiddenModeWithMetronome(progression) {

            // ç¬¬ä¸€æ­¥ï¼šæš‚åœèŠ‚æ‹å™¨
            const wasMetronomeRunning = isMetronomeRunning;
            if (wasMetronomeRunning) {
                stopMetronome();
            }

            // ç¬¬äºŒæ­¥ï¼šæ’­æ”¾count-in
            playCountInWithMetronomeRestart(progression, wasMetronomeRunning);
        }

        /**
         * ğŸ—‘ï¸ å·²å¼ƒç”¨ï¼šæ—§çš„åŒæ­¥é€»è¾‘ï¼ˆä½¿ç”¨moduloæ–¹å¼ï¼‰
         * ç°åœ¨ä½¿ç”¨å…¨å±€èŠ‚æ‹ç½‘æ ¼ï¼Œæ‰€æœ‰æ’­æ”¾æ€»æ˜¯å¯¹é½ï¼Œä¸éœ€è¦è¿™ä¸ªå‡½æ•°
         */
        // function playIntervalProgressionWithMetronomeSync(progression) { ... }

        /**
         * ğŸ­ğŸµ æ’­æ”¾count-inå¹¶åœ¨ç»“æŸåé‡æ–°å¯åŠ¨èŠ‚æ‹å™¨
         * @param {Object} progression - éŸ³ç¨‹è¿›è¡Œæ•°æ®
         * @param {boolean} shouldRestartMetronome - æ˜¯å¦éœ€è¦é‡æ–°å¯åŠ¨èŠ‚æ‹å™¨
         */
        function playCountInWithMetronomeRestart(progression, shouldRestartMetronome) {

            // è·å–å½“å‰èŠ‚æ‹å™¨é€Ÿåº¦
            const headerInput = document.getElementById('headerMetronomeBpm');
            const currentTempo = parseInt(headerInput ? headerInput.value : 60) || 60;
            const tempo = currentTempo;
            const timeSignature = progression.timeSignature || { beats: 4, beatType: 4 };
            const beatDuration = 60 / tempo; // æ¯æ‹çš„ç§’æ•°

            // è®¡ç®—count-inçš„æ€»æ—¶é•¿
            let countInBeats, actualBeatDuration;
            if (timeSignature.beats === 6 && timeSignature.beatType === 8) {
                countInBeats = 2;
                actualBeatDuration = beatDuration * 3;
            } else if (timeSignature.beats === 9 && timeSignature.beatType === 8) {
                countInBeats = 3;
                actualBeatDuration = beatDuration * 3;
            } else if (timeSignature.beats === 12 && timeSignature.beatType === 8) {
                countInBeats = 4;
                actualBeatDuration = beatDuration * 3;
            } else {
                countInBeats = timeSignature.beats;
                actualBeatDuration = beatDuration;
            }

            const countInDuration = countInBeats * actualBeatDuration * 1000; // è½¬æ¢ä¸ºæ¯«ç§’

            console.log(`   - æ‹æ•°: ${countInBeats}æ‹`);
            console.log(`   - æ¯æ‹æ—¶é•¿: ${actualBeatDuration.toFixed(2)}ç§’`);
            console.log(`   - æ€»æ—¶é•¿: ${countInDuration.toFixed(2)}ms`);
            console.log(`   - å®Œæˆåé‡å¯èŠ‚æ‹å™¨: ${shouldRestartMetronome}`);

            // æ’­æ”¾count-inï¼Œä½†ä¸ç”±å†…éƒ¨è‡ªåŠ¨å¯åŠ¨æ’­æ”¾ï¼›ç”±å›è°ƒç»Ÿä¸€è°ƒåº¦
            playCountIn(progression, {
                autoStart: false,
                onFinish: ({ playbackStartAt }) => {
                    if (shouldRestartMetronome) {
                        window.metronomeStartTime = performance.now();
                        startMetronome();
                    } else {
                    }
                    playIntervalProgression(progression, playbackStartAt);
                }
            });
        }

        /**
         * ğŸµ æ’­æ”¾count-inï¼ˆæ‰“æ‹å­ï¼‰
         * @param {Object} progression - éŸ³ç¨‹è¿›è¡Œæ•°æ®
         */
        function playCountIn(progression, options = {}) {

            const { autoStart = true, onFinish = null } = options;

            // ğŸµ ä¿®å¤ï¼šä½¿ç”¨å½“å‰èŠ‚æ‹å™¨çš„tempoè€Œä¸æ˜¯ç”Ÿæˆæ—¶çš„tempo
            const headerInput = document.getElementById('headerMetronomeBpm');
            const currentTempo = parseInt(headerInput ? headerInput.value : 60) || 60;
            const tempo = currentTempo;
            const timeSignature = progression.timeSignature || { beats: 4, beatType: 4 };
            const beatDuration = 60 / tempo; // æ¯æ‹çš„ç§’æ•°

            // æ ¹æ®æ‹å·ç¡®å®šcount-inçš„æ‹æ•°
            let countInBeats, actualBeatDuration;

            if (timeSignature.beats === 6 && timeSignature.beatType === 8) {
                // 6/8æ‹ï¼šæ„Ÿå—ä¸º2ä¸ªå¤§æ‹ï¼Œæ¯æ‹ä¸ºé™„ç‚¹å››åˆ†éŸ³ç¬¦
                countInBeats = 2;
                actualBeatDuration = beatDuration * 3; // 3ä¸ªå…«åˆ†éŸ³ç¬¦ = 1ä¸ªé™„ç‚¹å››åˆ†éŸ³ç¬¦
            } else if (timeSignature.beats === 9 && timeSignature.beatType === 8) {
                // 9/8æ‹ï¼šæ„Ÿå—ä¸º3ä¸ªå¤§æ‹
                countInBeats = 3;
                actualBeatDuration = beatDuration * 3;
            } else if (timeSignature.beats === 12 && timeSignature.beatType === 8) {
                // 12/8æ‹ï¼šæ„Ÿå—ä¸º4ä¸ªå¤§æ‹
                countInBeats = 4;
                actualBeatDuration = beatDuration * 3;
            } else {
                // å…¶ä»–æ‹å·ï¼šæŒ‰åŸå§‹æ‹æ•°
                countInBeats = timeSignature.beats;
                actualBeatDuration = beatDuration;
            }

            if (!window.intervalAudioCtx) {
                console.error('âŒ AudioContextä¸å¯ç”¨');
                return;
            }

            // ä»¥AudioContextæ—¶é—´ä¸ºåŸºå‡†ï¼Œé¿å…setTimeoutæ¼‚ç§»
            const baseTime = window.intervalAudioCtx.currentTime + 0.1;
            let currentTime = baseTime;

            // åˆå§‹åŒ–é‡‡æ ·å™¨ï¼ˆè‹¥å¯ç”¨ï¼‰
            try {
                if (!window.__icSamplePlayer && window.ICSamplePlayer) {
                    window.__icSamplePlayer = new ICSamplePlayer({ rootPath: 'assets/samples/piano-ogg-full' });
                    window.__icSamplePlayer.load();
                }
            } catch (_) {}

            // æ’­æ”¾æ¯ä¸€æ‹çš„clickå£°
            for (let beat = 1; beat <= countInBeats; beat++) {
                // ç¬¬ä¸€æ‹éŸ³è°ƒæ›´é«˜ï¼Œå…¶ä»–æ‹éŸ³è°ƒè¾ƒä½
                const frequency = beat === 1 ? 800 : 600;
                const duration = 0.1; // clickå£°çš„æŒç»­æ—¶é—´
                const beatTime = currentTime + (beat - 1) * actualBeatDuration;


                // ç›´æ¥è°ƒåº¦clickå£°åˆ°AudioContext
                playClickSound(frequency, beatTime, duration);
            }

            // count-inç»“æŸåçš„ç²¾ç¡®æ’­æ”¾æ—¶é—´ï¼ˆåŠ å…¥å°‘é‡è£•é‡ä»¥ç¡®ä¿clickå°¾éŸ³ç»“æŸï¼‰
            const totalCountInDuration = countInBeats * actualBeatDuration;
            const playbackStartAt = baseTime + totalCountInDuration + 0.05;
            const delayMs = Math.max(0, (playbackStartAt - window.intervalAudioCtx.currentTime) * 1000);
            setTimeout(() => {
                if (window.isPlayingInterval) { // ç¡®ä¿è¿˜åœ¨æ’­æ”¾çŠ¶æ€
                    if (typeof onFinish === 'function') {
                        try { onFinish({ playbackStartAt, countInBeats, actualBeatDuration }); } catch (e) { console.warn('onFinishå›è°ƒå¼‚å¸¸:', e); }
                    }
                    if (autoStart) {
                        playIntervalProgression(progression, playbackStartAt);
                    }
                }
            }, delayMs);
        }

        /**
         * ğŸµ æ’­æ”¾clickå£°
         * @param {number} frequency - é¢‘ç‡
         * @param {number} startTime - å¼€å§‹æ—¶é—´
         * @param {number} duration - æŒç»­æ—¶é—´
         */
        function playClickSound(frequency, startTime, duration) {
            try {
                const oscillator = window.intervalAudioCtx.createOscillator();
                const gainNode = window.intervalAudioCtx.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(window.intervalAudioCtx.destination);

                oscillator.frequency.setValueAtTime(frequency, startTime);
                oscillator.type = 'square'; // æ–¹æ³¢äº§ç”Ÿæ›´æ¸…è„†çš„clickå£°

                // éŸ³é‡åŒ…ç»œï¼šå¿«é€Ÿèµ·å§‹ï¼Œå¿«é€Ÿè¡°å‡
                gainNode.gain.setValueAtTime(0, startTime);
                gainNode.gain.linearRampToValueAtTime(0.6, startTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, startTime + duration);

                oscillator.start(startTime);
                oscillator.stop(startTime + duration);

                // ä¿å­˜åˆ°è°ƒåº¦åˆ—è¡¨ç”¨äºåœæ­¢
                if (!window.intervalScheduledSounds) {
                    window.intervalScheduledSounds = [];
                }
                window.intervalScheduledSounds.push({ oscillator, gainNode });

            } catch (error) {
                console.error('âŒ æ’­æ”¾clickå£°å¤±è´¥:', error);
            }
        }

        function playIntervalProgression(progression, audioStartAt = null) {
            if (!progression || !progression.measures) {
                console.warn('âš ï¸ æ— æ•ˆçš„éŸ³ç¨‹è¿›è¡Œæ•°æ®');
                window.isPlayingInterval = false;
                updatePlayButton();
                return;
            }

            // ğŸ¯ è¯¦ç»†éªŒè¯æ’­æ”¾æ•°æ®

            // éªŒè¯æ¯ä¸ªå°èŠ‚çš„æ•°æ®å®Œæ•´æ€§
            let hasValidNotes = false;
            progression.measures.forEach((measure, measureIndex) => {
                console.log(`å°èŠ‚ ${measureIndex + 1}:`, {
                    lowerVoiceCount: measure.lowerVoice?.length || 0,
                    upperVoiceCount: measure.upperVoice?.length || 0
                });

                if (measure.lowerVoice && measure.upperVoice) {
                    measure.lowerVoice.forEach((note, noteIndex) => {
                        const upperNote = measure.upperVoice[noteIndex];
                        if (note && upperNote) {
                            console.log(`  éŸ³ç¬¦${noteIndex + 1}:`, {
                                lower: { type: note.type, pitch: note.pitch, duration: note.duration },
                                upper: { type: upperNote.type, pitch: upperNote.pitch, duration: upperNote.duration }
                            });
                            if (note.type === 'note' && upperNote.type === 'note' && note.pitch && upperNote.pitch) {
                                hasValidNotes = true;
                            }
                        }
                    });
                }
            });

            if (!hasValidNotes) {
                console.error('âŒ æ’­æ”¾æ•°æ®ä¸­æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„éŸ³ç¬¦');
                alert('æ’­æ”¾æ•°æ®ä¸å®Œæ•´ï¼Œè¯·é‡æ–°ç”ŸæˆéŸ³ç¨‹');
                window.isPlayingInterval = false;
                updatePlayButton();
                return;
            }

            // ğŸµ ä¿®å¤ï¼šä½¿ç”¨å½“å‰èŠ‚æ‹å™¨çš„tempoè€Œä¸æ˜¯ç”Ÿæˆæ—¶çš„tempo
            const headerInput = document.getElementById('headerMetronomeBpm');
            const currentTempo = parseInt(headerInput ? headerInput.value : 60) || 60;
            const tempo = currentTempo;
            const beatDuration = 60 / tempo; // æ¯æ‹çš„ç§’æ•°
            const timeSignature = progression.timeSignature || { beats: 4, beatType: 4 };

            // è‹¥æä¾›äº†ç»å¯¹AudioContextèµ·å§‹æ—¶é—´ï¼Œåˆ™ä¸¥æ ¼å¯¹é½ï¼›å¦åˆ™é‡‡ç”¨å½“å‰æ—¶é—´+0.1s
            let currentTime = audioStartAt ? Math.max(audioStartAt, window.intervalAudioCtx.currentTime + 0.02)
                                           : window.intervalAudioCtx.currentTime + 0.1; // ç¨å¾®å»¶è¿Ÿå¼€å§‹
            let totalPlaybackDuration = 0;

            progression.measures.forEach((measure, measureIndex) => {

                // æ’­æ”¾å°èŠ‚ä¸­çš„æ¯ä¸ªéŸ³ç¬¦
                for (let i = 0; i < measure.lowerVoice.length; i++) {
                    const lowerNote = measure.lowerVoice[i];
                    const upperNote = measure.upperVoice[i];


                    if (lowerNote.type === 'note' && upperNote.type === 'note') {
                        // æ£€æŸ¥éŸ³é«˜å­—æ®µ
                        if (!lowerNote.pitch || !upperNote.pitch) {
                            console.error(`âŒ éŸ³é«˜ç¼ºå¤±: lower.pitch=${lowerNote.pitch}, upper.pitch=${upperNote.pitch}`);
                            continue;
                        }

                        // è®¡ç®—éŸ³ç¬¦æŒç»­æ—¶é—´
                        const noteDuration = getNoteDurationInSeconds(lowerNote.duration, beatDuration);

                        // æ’­æ”¾éŸ³ç¨‹ï¼ˆå’Œå¼¦ï¼‰
                        playIntervalChord([lowerNote.pitch, upperNote.pitch], currentTime, noteDuration);

                        currentTime += noteDuration;
                        totalPlaybackDuration += noteDuration;
                    } else if (lowerNote.type === 'rest') {
                        // ä¼‘æ­¢ç¬¦ï¼šåªæ¨è¿›æ—¶é—´ï¼Œä¸æ’­æ”¾å£°éŸ³
                        const restDuration = getNoteDurationInSeconds(lowerNote.duration, beatDuration);
                        currentTime += restDuration;
                        totalPlaybackDuration += restDuration;
                    }
                }
            });


            // ğŸ¯ æ”¹è¿›æ’­æ”¾ç»“æŸå›è°ƒï¼Œæ·»åŠ æ¸…ç†é€»è¾‘
            const playbackEndTime = (totalPlaybackDuration + 0.5) * 1000; // å¢åŠ 0.5ç§’ç¼“å†²æ—¶é—´
            setTimeout(() => {
                if (window.isPlayingInterval) {
                    window.isPlayingInterval = false;
                    // ğŸµ æ¸…é™¤æ’­æ”¾çŠ¶æ€å˜é‡
                    window.intervalPlaybackStartTime = null;
                    window.intervalPlaybackTempo = 60;
                    window.intervalPlaybackTimeSignature = { beats: 4, beatType: 4 };

                    // æ¸…ç†è°ƒåº¦çš„éŸ³é¢‘
                    if (window.intervalScheduledSounds) {
                        window.intervalScheduledSounds = [];
                    }
                    updatePlayButton();
                }
            }, playbackEndTime);
        }

        function playIntervalChord(pitches, startTime, duration) {
            if (!window.intervalAudioCtx) {
                console.error('âŒ AudioContextä¸å¯ç”¨');
                return;
            }


            pitches.forEach((pitch, index) => {
                const frequency = pitchToFrequency(pitch);
                if (frequency) {
                    try {
                        if (window.__icSamplePlayer && window.__icSamplePlayer.ready) {
                            const midi = Math.round(69 + 12 * Math.log2(frequency / 440));
                            const playResult = window.__icSamplePlayer.scheduleAtExternalContext(window.intervalAudioCtx, startTime, midi, duration, 0.8);
                            // ä¿å­˜è¿”å›å€¼ä»¥ä¾¿åœæ­¢æ—¶ä½¿ç”¨
                            if (playResult) {
                                if (!window.intervalScheduledSounds) window.intervalScheduledSounds = [];
                                window.intervalScheduledSounds.push(playResult);
                            }
                        } else {
                            const oscillator = window.intervalAudioCtx.createOscillator();
                            const gainNode = window.intervalAudioCtx.createGain();
                            oscillator.connect(gainNode);
                            gainNode.connect(window.intervalAudioCtx.destination);
                            oscillator.frequency.setValueAtTime(frequency, startTime);
                            oscillator.type = 'sine';
                            const volume = 0.3;
                            gainNode.gain.setValueAtTime(0, startTime);
                            gainNode.gain.linearRampToValueAtTime(volume, startTime + 0.02);
                            gainNode.gain.setValueAtTime(volume * 0.8, startTime + duration - 0.05);
                            gainNode.gain.linearRampToValueAtTime(0, startTime + duration);
                            oscillator.start(startTime);
                            oscillator.stop(startTime + duration);
                            if (!window.intervalScheduledSounds) window.intervalScheduledSounds = [];
                            window.intervalScheduledSounds.push({ oscillator, gainNode });
                        }
                    } catch (error) {
                        console.error(`âŒ æ’­æ”¾éŸ³ç¬¦ ${pitch} å¤±è´¥:`, error);
                    }
                } else {
                    console.warn(`âš ï¸ æ— æ³•è§£æéŸ³é«˜: ${pitch}`);
                }
            });
        }

        function pitchToFrequency(pitch) {
            // ğŸ¯ å¢å¼ºè°ƒè¯•å’Œé”™è¯¯å¤„ç†

            if (!pitch || typeof pitch !== 'string') {
                console.error(`âŒ æ— æ•ˆéŸ³é«˜æ ¼å¼: ${pitch}`);
                return null;
            }

            // è§£æéŸ³é«˜ (å¦‚ "C4", "F#5")
            const match = pitch.match(/^([A-G])([#b]?)(\d+)$/);
            if (!match) {
                console.error(`âŒ éŸ³é«˜è§£æå¤±è´¥: "${pitch}" ä¸åŒ¹é…é¢„æœŸæ ¼å¼`);
                return null;
            }

            const [, note, accidental, octave] = match;
            const octaveNum = parseInt(octave);

            // C4 = MIDI 60 = 261.63 Hz
            const noteMap = { 'C': 0, 'D': 2, 'E': 4, 'F': 5, 'G': 7, 'A': 9, 'B': 11 };
            let midiNote = noteMap[note] + (octaveNum * 12) + 12; // C0 = MIDI 12

            if (accidental === '#') midiNote += 1;
            else if (accidental === 'b') midiNote -= 1;

            // MIDI note to frequency: f = 440 * 2^((n-69)/12)
            const frequency = 440 * Math.pow(2, (midiNote - 69) / 12);

            // ğŸ¯ ä¿®å¤ï¼šæ·»åŠ é¢‘ç‡èŒƒå›´éªŒè¯
            if (frequency < 20 || frequency > 20000) {
                console.warn(`âš ï¸ é¢‘ç‡è¶…å‡ºäººè€³å¬è§‰èŒƒå›´: ${frequency.toFixed(2)}Hz`);
            }

            return frequency;
        }

        // ğŸ¯ æ·»åŠ æ’­æ”¾æµ‹è¯•å‡½æ•°
        function testAudioPlayback() {
            console.log('ğŸ§ª æµ‹è¯•éŸ³é¢‘æ’­æ”¾åŠŸèƒ½');
            try {
                const testFreq = pitchToFrequency('C4');
                console.log('ğŸ§ª æµ‹è¯•é¢‘ç‡:', testFreq);

                if (window.intervalAudioCtx && testFreq) {
                    const osc = window.intervalAudioCtx.createOscillator();
                    const gain = window.intervalAudioCtx.createGain();

                    osc.connect(gain);
                    gain.connect(window.intervalAudioCtx.destination);

                    osc.frequency.value = testFreq;
                    gain.gain.value = 0.2;

                    osc.start();
                    osc.stop(window.intervalAudioCtx.currentTime + 0.5);

                    console.log('ğŸ§ª æµ‹è¯•éŸ³ç¬¦å·²æ’­æ”¾');
                    return true;
                }
            } catch (error) {
                console.error('âŒ éŸ³é¢‘æµ‹è¯•å¤±è´¥:', error);
                return false;
            }
        }

        // ğŸ¯ æ·»åŠ æ’­æ”¾æµ‹è¯•åŠŸèƒ½
        function testPlaybackSystem() {
            console.log('ğŸ§ª æµ‹è¯•æ’­æ”¾ç³»ç»Ÿ...');

            // åˆ›å»ºç®€å•çš„æµ‹è¯•æ•°æ®
            const testProgression = {
                measures: [{
                    lowerVoice: [
                        { type: 'note', pitch: 'C4', duration: 1.0 },
                        { type: 'note', pitch: 'D4', duration: 1.0 }
                    ],
                    upperVoice: [
                        { type: 'note', pitch: 'E4', duration: 1.0 },
                        { type: 'note', pitch: 'F4', duration: 1.0 }
                    ]
                }],
                tempo: 120,
                timeSignature: { beats: 4, beatType: 4 }
            };

            // ä¿å­˜æµ‹è¯•æ•°æ®
            window.currentIntervalProgression = testProgression;
            console.log('ğŸ§ª æµ‹è¯•æ•°æ®å·²ä¿å­˜');

            // å°è¯•æ’­æ”¾
            if (window.intervalAudioCtx) {
                directPlayTest();
            } else {
                console.log('ğŸ§ª åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡åå†è¯•æ’­æ”¾...');
                directPlayTest();
            }
        }

        // ä¸ºè°ƒè¯•æ·»åŠ å…¨å±€å‡½æ•°
        window.testPlaybackSystem = testPlaybackSystem;
        window.testAudioPlayback = testAudioPlayback;

        function getNoteDurationInSeconds(duration, beatDuration) {
            // ğŸ¯ ä¿®å¤ï¼šå¤„ç†æ•°å­—ç±»å‹çš„duration
            let durationValue;
            if (typeof duration === 'number') {
                durationValue = duration;
            } else {
                const durationMap = {
                    'whole': 4.0,
                    'half.': 3.0,  // é™„ç‚¹äºŒåˆ†éŸ³ç¬¦
                    'half': 2.0,
                    'quarter.': 1.5,  // é™„ç‚¹å››åˆ†éŸ³ç¬¦
                    'quarter': 1.0,
                    'eighth': 0.5,
                    '16th': 0.25,
                    'triplet': 2/3  // ğŸ¯ ä¿®å¤ï¼šå››åˆ†ä¸‰è¿éŸ³æ¯ä¸ªéŸ³ç¬¦ = 2/3æ‹
                };
                durationValue = durationMap[duration] || 1.0;
            }

            const result = durationValue * beatDuration;
            return result;
        }

        // ğŸ”§ é¡µé¢å¸è½½æ—¶æ¸…ç†V4.0æ¸²æŸ“å™¨èµ„æº
        window.addEventListener('beforeunload', function() {
            if (window.intervalRenderer && typeof window.intervalRenderer.clear === 'function') {
                try {
                    window.intervalRenderer.clear();
                } catch (cleanupError) {
                    console.warn('âš ï¸ V4.0æ¸²æŸ“å™¨æ¸…ç†æ—¶å‡ºé”™:', cleanupError);
                }
            }
        });


        // ğŸ¯ é€šç”¨å¼¹çª—å¤–éƒ¨ç‚¹å‡»å…³é—­åŠŸèƒ½
        function initializeModalClickOutsideToClose() {
            const modalIds = [
                'settingsModal',
                'intervalTypeModal',
                'rhythmModal',
                'articulationModal',
                'keySignatureModal',
                'timeSignatureModal',
                'intervalModal',
                'clefModal',
                'challengeModal',
                'metronomePatternModal'
            ];

            modalIds.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.addEventListener('click', function(event) {
                        // åªæœ‰å½“ç‚¹å‡»çš„æ˜¯å¼¹çª—èƒŒæ™¯ï¼ˆmodalå®¹å™¨æœ¬èº«ï¼‰æ—¶æ‰å…³é—­
                        if (event.target === modal) {

                            // æ ¹æ®å¼¹çª—ç±»å‹è°ƒç”¨ç›¸åº”çš„å…³é—­å‡½æ•°
                            switch(modalId) {
                                case 'settingsModal':
                                    if (typeof closeSettingsModal === 'function') {
                                        closeSettingsModal();
                                    }
                                    break;
                                case 'intervalTypeModal':
                                    if (typeof closeIntervalTypeSettings === 'function') {
                                        closeIntervalTypeSettings();
                                    }
                                    break;
                                case 'rhythmModal':
                                    if (typeof saveRhythmSettings === 'function') {
                                        console.log('ğŸ’¾ å¤–éƒ¨ç‚¹å‡»ï¼šè‡ªåŠ¨ä¿å­˜èŠ‚å¥è®¾ç½®');
                                        saveRhythmSettings();
                                    } else if (typeof closeRhythmSettings === 'function') {
                                        closeRhythmSettings();
                                    }
                                    break;
                                case 'articulationModal':
                                    if (typeof closeArticulationSettings === 'function') {
                                        closeArticulationSettings();
                                    }
                                    break;
                                case 'keySignatureModal':
                                    if (typeof closeKeySettings === 'function') {
                                        closeKeySettings();
                                    }
                                    break;
                                case 'timeSignatureModal':
                                    if (typeof saveTimeSignatureSettings === 'function') {
                                        console.log('ğŸ’¾ å¤–éƒ¨ç‚¹å‡»ï¼šè‡ªåŠ¨ä¿å­˜æ‹å·è®¾ç½®');
                                        saveTimeSignatureSettings();
                                    } else if (typeof closeTimeSignatureSettings === 'function') {
                                        closeTimeSignatureSettings();
                                    }
                                    break;
                                case 'intervalModal':
                                    if (typeof closeIntervalSettings === 'function') {
                                        closeIntervalSettings();
                                    }
                                    break;
                                case 'clefModal':
                                    if (typeof closeClefSettings === 'function') {
                                        closeClefSettings();
                                    }
                                    break;
                                case 'challengeModal':
                                    if (typeof cancelChallengeSetup === 'function') {
                                        cancelChallengeSetup();
                                    }
                                    break;
                                case 'metronomePatternModal':
                                    if (typeof closeMetronomePatternSettings === 'function') {
                                        closeMetronomePatternSettings();
                                    }
                                    break;
                                default:
                                    // é€šç”¨å…³é—­æ–¹æ³•
                                    modal.style.display = 'none';
                            }
                        }
                    });
                }
            });
        }

        // åœ¨é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeModalClickOutsideToClose();
        });

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('settingsModal');
                if (modal && modal.style.display !== 'none') {
                    closeSettingsModal();
                }
            }
        });
    </script>

    <!-- éŸ³ç¨‹å®¹å™¨ç‚¹å‡»ç”ŸæˆåŠŸèƒ½ -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const scoreContainer = document.getElementById('score');

            if (scoreContainer) {
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
                scoreContainer.addEventListener('click', function(event) {
                    // æ£€æŸ¥ç‚¹å‡»çš„ä¸æ˜¯æŒ‰é’®æˆ–å…¶ä»–äº¤äº’å…ƒç´ 
                    const targetElement = event.target;
                    const isInteractiveElement = targetElement.tagName === 'BUTTON' ||
                                                 targetElement.tagName === 'A' ||
                                                 targetElement.closest('button') ||
                                                 targetElement.closest('a');

                    // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯äº¤äº’å…ƒç´ ï¼Œè§¦å‘ç”Ÿæˆ
                    if (!isInteractiveElement && typeof generateIntervals === 'function') {
                        console.log('ğŸ–±ï¸ å®¹å™¨ç‚¹å‡»è§¦å‘ç”ŸæˆéŸ³ç¨‹');
                        generateIntervals();
                    }
                });

                // æ·»åŠ æŒ‡é’ˆæ ·å¼æç¤ºï¼ˆå¯ç‚¹å‡»ï¼‰
                scoreContainer.style.cursor = 'pointer';

                console.log('âœ… éŸ³ç¨‹å®¹å™¨ç‚¹å‡»ç”ŸæˆåŠŸèƒ½å·²å¯ç”¨');
            } else {
                console.warn('âš ï¸ æœªæ‰¾åˆ° score å®¹å™¨ï¼Œæ— æ³•å¯ç”¨ç‚¹å‡»ç”ŸæˆåŠŸèƒ½');
            }
        });

        // âŒ¨ï¸ å…¨å±€é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(e) {
            // å¦‚æœåœ¨è¾“å…¥æ¡†ã€æ–‡æœ¬æ¡†æˆ–æ¨¡æ€æ¡†è¾“å…¥ä¸­ï¼Œä¸è§¦å‘å¿«æ·é”®
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                return;
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰æ¨¡æ€æ¡†æ‰“å¼€ï¼ˆé¿å…åœ¨è®¾ç½®ä¸­è§¦å‘ï¼‰
            const hasOpenModal = document.querySelector('.modal:not([style*="display: none"])');
            if (hasOpenModal) {
                return;
            }

            const key = e.key.toLowerCase();

            switch(key) {
                case 'p':
                    // æ’­æ”¾/æš‚åœæ’­æ”¾
                    e.preventDefault();
                    if (typeof directPlayTest === 'function') {
                        directPlayTest();
                        console.log('âŒ¨ï¸ å¿«æ·é”®: P - æ’­æ”¾/æš‚åœ');
                    }
                    break;

                case 'arrowleft':
                    // ä¸Šä¸€æ¡
                    e.preventDefault();
                    if (typeof previousInterval === 'function') {
                        previousInterval();
                        console.log('âŒ¨ï¸ å¿«æ·é”®: â† - ä¸Šä¸€æ¡');
                    }
                    break;

                case 'arrowright':
                    // ä¸‹ä¸€æ¡
                    e.preventDefault();
                    if (typeof nextInterval === 'function') {
                        nextInterval();
                        console.log('âŒ¨ï¸ å¿«æ·é”®: â†’ - ä¸‹ä¸€æ¡');
                    }
                    break;

                case ' ':
                    // ç”Ÿæˆï¼ˆç©ºæ ¼é”®ï¼‰
                    e.preventDefault();
                    if (typeof generateIntervals === 'function') {
                        generateIntervals();
                        console.log('âŒ¨ï¸ å¿«æ·é”®: Space - ç”ŸæˆéŸ³ç¨‹');
                    }
                    break;

                case 'h':
                    // éšè—/æ˜¾ç¤º
                    e.preventDefault();
                    if (typeof toggleIntervalVisibility === 'function') {
                        toggleIntervalVisibility();
                        console.log('âŒ¨ï¸ å¿«æ·é”®: H - éšè—/æ˜¾ç¤º');
                    }
                    break;

                case 'c':
                    // èŠ‚æ‹å™¨å¼€å…³
                    e.preventDefault();
                    if (typeof toggleMetronome === 'function') {
                        toggleMetronome();
                        console.log('âŒ¨ï¸ å¿«æ·é”®: C - èŠ‚æ‹å™¨å¼€å…³');
                    }
                    break;
            }
        });

        console.log('âŒ¨ï¸ éŸ³ç¨‹è§†å¥å·¥å…·å¿«æ·é”®å·²å¯ç”¨: P=æ’­æ”¾ â†â†’=å¯¼èˆª Space=ç”Ÿæˆ H=éšè— C=èŠ‚æ‹å™¨');
    </script>

    <script>
        // ç»ƒä¹ è®¡æ•°å™¨ï¼ˆä¼šè¯å†…è®¡æ•°ï¼Œåˆ·æ–°æ¸…é›¶ï¼‰
        function loadPracticeCount(){
            const el = document.getElementById('practiceCountValue');
            if (!el) return 0;
            const v = parseInt(el.textContent || '0', 10);
            return isFinite(v) ? Math.max(0, v) : 0;
        }

        function updatePracticeCountDisplay(val){
            const el = document.getElementById('practiceCountValue');
            if (el) el.textContent = String(Math.max(0, val));
        }

        window.incrementPracticeCount = function(){
            const next = loadPracticeCount() + 1;
            updatePracticeCountDisplay(next);
        };

        window.decrementPracticeCount = function(){
            const next = Math.max(0, loadPracticeCount() - 1);
            updatePracticeCountDisplay(next);
        };

        document.addEventListener('DOMContentLoaded', function(){
            updatePracticeCountDisplay(0);
        });
    </script>

    <script>
        window.IC_MIDI_CONFIG = {
            getAudioContext: () => {
                if (!window.intervalAudioCtx) {
                    window.intervalAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (window.intervalAudioCtx && window.intervalAudioCtx.state === 'suspended') {
                    window.intervalAudioCtx.resume().catch(()=>{});
                }
                return window.intervalAudioCtx;
            },
            sampleRoot: 'assets/samples/piano-ogg-full',
            useSamplePlayer: true
        };
    </script>
    <script src="assets/js/midi-input.js?v=1"></script>

    <!-- æŒ‘æˆ˜æ¨¡å¼é€»è¾‘ -->
    <script src="./IC éŸ³ç¨‹è§†å¥å·¥å…·_files/challenge-mode.js"></script>

    <script>
        // è®©è¯•ç”¨ç³»ç»Ÿå¤ç”¨ generateMelody å…¥å£
        if (typeof window.generateIntervals === 'function') {
            const originalGenerateIntervals = window.generateIntervals;
            if (typeof window.generateMelody !== 'function') {
                window.generateMelody = function(...args) {
                    return originalGenerateIntervals.apply(this, args);
                };
            }
            window.generateIntervals = function(...args) {
                if (typeof window.generateMelody === 'function' && window.generateMelody !== window.generateIntervals) {
                    return window.generateMelody(...args);
                }
                return originalGenerateIntervals.apply(this, args);
            };
        }
    </script>

    <!-- ğŸ›¡ï¸ è¯•ç”¨ä¿æŠ¤ç³»ç»Ÿè„šæœ¬ -->
    <script defer src="/js/tool-access-loader.js?v=1.0.2"></script>
</body></html>
