<!DOCTYPE html>
<!-- saved from url=(0269)file:///Users/igorchen/Downloads/IC%20Studio/IC%20%E8%A7%86%E5%A5%8F%E5%B7%A5%E5%85%B7%20%E7%AC%AC%E4%B8%80%E7%89%88%20(%E5%B7%B2%E4%B8%8A%E6%9E%B6)%20%E9%9F%B3%E7%A8%8B%E4%BF%AE%E5%A4%8D%E4%B8%AD%202/%E9%9F%B3%E7%A8%8B%E8%A7%86%E5%A5%8F%E7%94%9F%E6%88%90%E5%99%A8.html -->
<html lang="zh-CN" data-theme="light">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Primary SEO Meta Tags -->
    <title>Interval Training Tool | IC 音程视奏训练工具 - Ear Training & Pitch Recognition</title>
    <meta name="description" content="Professional interval training and ear training tool online. Practice interval recognition with customizable range, harmonic/melodic intervals, all interval types (m2-M13). Features real-time piano audio playback, standard music notation. Free 20 trials. Perfect for musicians developing relative pitch, ear training, and sight reading intervals. | 专业音程训练与听力训练工具，支持自定义音域、和声/旋律音程、所有音程类型（小二度-大十三度），实时钢琴音频。">
    <meta name="keywords" content="interval training, ear training, interval recognition, pitch training, music ear training, interval exercises, harmonic intervals, melodic intervals, relative pitch, perfect pitch training, music theory intervals, sight reading intervals, interval identification, aural training, music theory tool, free ear training, online interval trainer, interval practice, 音程训练, 听力训练, 音程识别, 相对音感, 音程练习, 和声音程, 旋律音程">
    <meta name="author" content="Igor Chen - IC Studio">
    <link rel="canonical" href="https://icstudio.club/tools/interval-generator.html">

    <!-- Open Graph / Facebook / WeChat -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://icstudio.club/tools/interval-generator.html">
    <meta property="og:title" content="Interval Training Tool | IC 音程视奏训练工具">
    <meta property="og:description" content="Professional interval training & ear training tool. Practice interval recognition with customizable settings. Piano audio playback, standard notation. Free 20 trials. | 专业音程与听力训练工具，自定义设置，实时音频。">
    <meta property="og:image" content="https://icstudio.club/images/ICLOGO.png">
    <meta property="og:image:alt" content="IC Studio Interval Training Tool Interface">
    <meta property="og:site_name" content="IC Studio">
    <meta property="og:locale" content="zh_CN">
    <meta property="og:locale:alternate" content="en_US">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://icstudio.club/tools/interval-generator.html">
    <meta name="twitter:title" content="Interval Training & Ear Training Tool | IC Studio">
    <meta name="twitter:description" content="Professional interval training tool. Practice interval recognition with customizable settings. Piano audio. Free 20 trials.">
    <meta name="twitter:image" content="https://icstudio.club/images/ICLOGO.png">

    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "IC Interval Training Tool",
      "alternateName": "IC 音程视奏训练工具",
      "description": "Professional online interval training and ear training tool for music students. Practice interval recognition with customizable pitch range, harmonic/melodic intervals, and all interval types from minor 2nd to major 13th. Features real-time piano audio playback and standard music notation rendering.",
      "url": "https://icstudio.club/tools/interval-generator.html",
      "applicationCategory": "MusicApplication",
      "operatingSystem": "Web Browser",
      "browserRequirements": "Requires JavaScript. HTML5 compatible browser.",
      "offers": {
        "@type": "Offer",
        "price": "30",
        "priceCurrency": "EUR",
        "description": "Full version with unlimited access",
        "availability": "https://schema.org/InStock"
      },
      "featureList": [
        "Interval recognition training",
        "Harmonic and melodic intervals",
        "All interval types (minor 2nd to major 13th)",
        "Customizable pitch range (C2-C7)",
        "Ascending and descending intervals",
        "Real-time piano audio playback",
        "Professional music notation rendering",
        "Treble and bass clef support",
        "Perfect for relative pitch training",
        "Ear training exercises",
        "Free trial (20 uses)",
        "Suitable for all instruments"
      ],
      "creator": {
        "@type": "Person",
        "name": "Igor Chen",
        "url": "https://icstudio.club"
      },
      "provider": {
        "@type": "Organization",
        "name": "IC Studio",
        "url": "https://icstudio.club",
        "logo": "https://icstudio.club/images/ICLOGO.png",
        "sameAs": [
          "https://www.youtube.com/@ICStudio86",
          "https://space.bilibili.com/376362605"
        ]
      },
      "audience": {
        "@type": "EducationalAudience",
        "educationalRole": "music student, piano student, guitar student, violin student, music teacher, choir member"
      },
      "inLanguage": ["zh-CN", "en-US"],
      "potentialAction": {
        "@type": "UseAction",
        "target": {
          "@type": "EntryPoint",
          "urlTemplate": "https://icstudio.club/tools/interval-generator.html"
        }
      }
    }
    </script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com/">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="">
    <link href="./IC 音程视奏工具_files/css2" rel="stylesheet">
    
    <!-- OpenSheetMusicDisplay -->
    <script src="./IC 音程视奏工具_files/opensheetmusicdisplay.min.js"></script>

    <!-- 音程生成器模块 -->
    <script src="./IC 音程视奏工具_files/interval-settings.js"></script>
    <!-- 🎵 小调系统模块（从旋律工具迁移，2025-10-09） -->
    <script src="./IC 音程视奏工具_files/minor-scale-spelling.js"></script>
    <script src="./IC 音程视奏工具_files/minor-alterations.js"></script>
    <!-- 核心生成器 -->
    <script src="./IC 音程视奏工具_files/interval-generator.js"></script>
    <script src="./IC 音程视奏工具_files/interval-renderer.js"></script>
    <!-- V4.0集成脚本 -->
    <script src="./IC 音程视奏工具_files/interval-generator-v4-integration.js"></script>
    
    <link rel="stylesheet" href="./IC 音程视奏工具_files/apple-ui-styles-green.css">
    <script src="assets/js/sample-player.js?v=6"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function(){
        try {
          if (!window.__icSamplePlayer && window.ICSamplePlayer) {
            window.__icSamplePlayer = new ICSamplePlayer({ rootPath: 'assets/samples/piano-ogg-full' });
            window.__icSamplePlayer.load();
          }
        } catch(e) { console.warn('采样器初始化失败:', e); }
      });
    </script>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="header-text">
                    <h1 data-i18n="app.title">IC Studio - 音程视奏生成器</h1>
                    <p data-i18n="app.subtitle">专业级乐谱渲染与音乐理论工具</p>
                </div>
                <div class="header-controls">
                    <div class="function-selector">
                        <button class="function-btn" id="functionBtn" onclick="toggleFunctionSelector()">
                            🎼 <span id="currentFunction" data-i18n="app.intervalMode">音程视奏</span>
                        </button>
                        <div class="function-menu" id="functionMenu">
                            <div class="function-option" onclick="switchFunction('melody')">
                                <span class="function-icon">🎵</span>
                                <span data-i18n="app.melodyMode">旋律视奏</span>
                            </div>
                            <div class="function-option" onclick="switchFunction('interval')">
                                <span class="function-icon">🎼</span>
                                <span data-i18n="app.intervalMode">音程视奏</span>
                            </div>
                            <div class="function-option" onclick="switchFunction('chord')">
                                <span class="function-icon">🎹</span>
                                <span data-i18n="app.chordMode">和弦视奏</span>
                            </div>
                        </div>
                    </div>
                    <div class="settings-dropdown">
                        <button class="settings-btn" id="settingsBtn" onclick="toggleSettings()">
                            ⚙️ <span data-i18n="settings.title">设置</span>
                        </button>
                        <div class="settings-menu" id="settingsMenu">
                            <!-- 主题设置 -->
                            <div class="settings-section">
                                <div class="settings-section-title" data-i18n="settings.theme">主题</div>
                                <div class="theme-options">
                                    <div class="theme-option" onclick="setTheme('light')">
                                        <span class="theme-icon">☀️</span>
                                        <span data-i18n="settings.lightMode">浅色模式</span>
                                    </div>
                                    <div class="theme-option" onclick="setTheme('dark')">
                                        <span class="theme-icon">🌙</span>
                                        <span data-i18n="settings.darkMode">深色模式</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 语言设置 -->
                            <div class="settings-section">
                                <div class="settings-section-title" data-i18n="settings.language">语言</div>
                                <div class="language-options">
                                    <div class="language-option" onclick="switchLanguage('zh-CN')">
                                        简体中文
                                    </div>
                                    <div class="language-option" onclick="switchLanguage('zh-TW')">
                                        繁體中文
                                    </div>
                                    <div class="language-option" onclick="switchLanguage('en')">
                                        English
                                    </div>
                                </div>
                            </div>


                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="control-row">
                <div class="control-group">
                    <label data-i18n="controls.intervalType">音程类型</label>
                    <button class="btn-secondary" onclick="openIntervalTypeSettings()" id="intervalTypeSettingsBtn" data-i18n="controls.intervalTypeSettings">音程类型设置</button>
                </div>

                <div class="control-group">
                    <label data-i18n="controls.measures">小节数</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="measures-2" name="measures" value="2">
                            <label for="measures-2" data-i18n="controls.measures2">2小节</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="measures-4" name="measures" value="4" checked="">
                            <label for="measures-4" data-i18n="controls.measures4">4小节</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="measures-8" name="measures" value="8">
                            <label for="measures-8" data-i18n="controls.measures8">8小节</label>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <label data-i18n="controls.key">调号</label>
                    <button class="btn-secondary" onclick="openKeySettings()" id="keySettingsBtn" data-i18n="controls.keySettings">调号设置</button>
                </div>

                <div class="control-group">
                    <label data-i18n="controls.time">拍号</label>
                    <button class="btn-secondary" onclick="openTimeSignatureSettings()" id="timeSignatureSettingsBtn" data-i18n="controls.timeSettings">拍号设置</button>
                </div>

                <div class="control-group">
                    <label data-i18n="controls.clef">谱号</label>
                    <button class="btn-secondary" onclick="openClefSettings()" id="clefSettingsBtn" data-i18n="controls.clefSettings">谱号设置</button>
                </div>
            </div>

            <!-- 新增：音域设置 -->
            <div class="control-row">
                <div class="control-group">
                    <label for="rangeMin" data-i18n="controls.rangeMin">最低音</label>
                    <select id="rangeMin">
                        <option value="33">A1</option>
                        <option value="35">B1</option>
                        <option value="36">C2</option>
                        <option value="38">D2</option>
                        <option value="40">E2</option>
                        <option value="41">F2</option>
                        <option value="43">G2</option>
                        <option value="45">A2</option>
                        <option value="47">B2</option>
                        <option value="48">C3</option>
                        <option value="50">D3</option>
                        <option value="52">E3</option>
                        <option value="53">F3</option>
                        <option value="55">G3</option>
                        <option value="57">A3</option>
                        <option value="59">B3</option>
                        <option value="60" selected="">C4</option>
                        <option value="62">D4</option>
                        <option value="64">E4</option>
                        <option value="65">F4</option>
                        <option value="67">G4</option>
                        <option value="69">A4</option>
                        <option value="71">B4</option>
                        <option value="72">C5</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="rangeMax" data-i18n="controls.rangeMax">最高音</label>
                    <select id="rangeMax">
                        <option value="48">C3</option>
                        <option value="50">D3</option>
                        <option value="52">E3</option>
                        <option value="53">F3</option>
                        <option value="55">G3</option>
                        <option value="57">A3</option>
                        <option value="59">B3</option>
                        <option value="60">C4</option>
                        <option value="62">D4</option>
                        <option value="64">E4</option>
                        <option value="65">F4</option>
                        <option value="67">G4</option>
                        <option value="69">A4</option>
                        <option value="71">B4</option>
                        <option value="72" selected="">C5</option>
                        <option value="74">D5</option>
                        <option value="76">E5</option>
                        <option value="77">F5</option>
                        <option value="79">G5</option>
                        <option value="81">A5</option>
                        <option value="82">B5</option>
                        <option value="83">C6</option>
                        <option value="84">D6</option>
                        <option value="85">E6</option>
                    </select>
                </div>

                <div class="control-group" style="flex: none; width: 140px;">
                    <label for="accidentalRate" data-i18n="controls.accidental">临时记号</label>
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <input type="range" id="accidentalRate" min="0" max="100" value="0" step="10" style="width: 90px;">
                        <span id="accidentalRateValue" style="font-weight: 400; min-width: 30px;">0%</span>
                    </div>
                </div>

                <div class="control-group metronome-group" style="flex: none; width: 160px;">
                    <label for="headerMetronomeBpm" data-i18n="controls.metronome">节拍器</label>
                    <div class="metronome-control">
                        <input type="number" id="headerMetronomeBpm" min="1" max="999" value="60" class="bpm-input-control">
                        <button class="metronome-play-btn" id="headerMetronomeBtn" onclick="toggleMetronome()" title="开始/停止节拍器">
                            🎵
                        </button>
                        <div class="metronome-beat-indicator" id="headerBeatIndicator"></div>
                    </div>
                </div>
            </div>

            <div class="control-row">
                <div class="buttons">
                    <button class="btn-primary" onclick="generateIntervals()" data-i18n="controls.generateInterval">生成音程</button>
                    <div class="button-group">
                        <button class="btn-secondary" onclick="previousInterval()" data-i18n="controls.previous" disabled="" style="opacity: 1;">上一条</button>
                        <button class="btn-secondary" onclick="nextInterval()" data-i18n="controls.next" disabled="" style="opacity: 1;">下一条</button>
                    </div>
                    <div class="button-group">
                        <button class="btn-secondary" id="playIntervalBtn" onclick="directPlayTest()" data-i18n="controls.play">播放</button>
                        <button class="melody-visibility-btn" id="intervalVisibilityBtn" onclick="toggleIntervalVisibility()" title="隐藏/显示音程">
                            👀
                        </button>
                        
                    </div>
                    <div class="button-group">
                        <button class="btn-secondary" onclick="openRhythmSettings()" data-i18n="controls.rhythm">节奏设置</button>
                        <button class="btn-secondary" onclick="openArticulationSettings()" data-i18n="controls.articulation" style="display: none;">演奏技巧</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="score-container" title="点击任意位置生成新音程" style="cursor: pointer;">
            <div id="score" style="cursor: pointer;">
                <div class="empty-score-message">
                    <p data-i18n="score.emptyInterval">点击生成音程开始练习</p>
                </div>
            </div>
        </div>
        
        <!-- Copyright Information -->
        <div style="
            padding: 5px 0;
            text-align: center;
            font-size: 14px;
            color: var(--neutral-dark);
            opacity: 0.7;
            border-top: 1px solid var(--border-color);
            margin-top: 7.5px;
        ">
            <p style="margin: 0; line-height: 1.5;">
                <strong>IC Studio 视奏工具</strong> - 专业级音程视奏生成器
            </p>
            <p style="margin: 8px 0 0 0; font-size: 13px; opacity: 0.8;">
                Copyright © 2025. All rights reserved. Igor Chen - 
                <a href="https://icstudio.club/" target="_blank" style="color: var(--primary-green); text-decoration: none;">icstudio.club</a>
            </p>
        </div>

    </div>

    <!-- 音程类型设置弹窗 -->
    <div id="intervalTypeModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="controls.intervalTypeSettings">音程类型设置</h3>
                <button class="close-btn" onclick="closeIntervalTypeSettings()">×</button>
            </div>
            <div class="modal-body">
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="interval.basicTypes">基本音程类型</h4>
                        <button class="btn-select-all" onclick="selectAllIntervalTypes()" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;" data-i18n="button.selectAll">全选</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-minor2" value="minor2">
                            <span data-i18n="intervalType.minor2nd">小二度</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-major2" value="major2">
                            <span data-i18n="intervalType.major2nd">大二度</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-minor3" value="minor3" checked="">
                            <span data-i18n="intervalType.minor3rd">小三度</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-major3" value="major3" checked="">
                            <span data-i18n="intervalType.major3rd">大三度</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-perfect4" value="perfect4" checked="">
                            <span data-i18n="intervalType.perfect4th">完全四度</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-tritone" value="tritone">
                            <span data-i18n="intervalType.tritone">增四/减五度</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-perfect5" value="perfect5" checked="">
                            <span data-i18n="intervalType.perfect5th">完全五度</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-minor6" value="minor6" checked="">
                            <span data-i18n="intervalType.minor6th">小六度</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-major6" value="major6" checked="">
                            <span data-i18n="intervalType.major6th">大六度</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-minor7" value="minor7">
                            <span data-i18n="intervalType.minor7th">小七度</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-major7" value="major7">
                            <span data-i18n="intervalType.major7th">大七度</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-octave" value="octave">
                            <span data-i18n="intervalType.octave">八度</span>
                        </label>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveIntervalTypeSettings()" data-i18n="button.save">保存设置</button>
                    <button class="btn-secondary" onclick="closeIntervalTypeSettings()" data-i18n="button.cancel">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 节奏设置弹窗 -->
    <div id="rhythmModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="controls.rhythm">节奏设置</h3>
                <button class="close-btn" onclick="closeRhythmSettings()">×</button>
            </div>
            <div class="modal-body">
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="rhythm.basicUnits">基本节奏单位</h4>
                        <button class="btn-select-all" onclick="selectAllRhythms()" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;" data-i18n="button.selectAll">全选</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item" id="rhythm-whole-label" style="display: block;">
                            <input type="checkbox" id="rhythm-whole" value="whole">
                            <span data-i18n="rhythm.whole">全音符</span>
                        </label>
                        <label class="checkbox-item" id="rhythm-dotted-half-label" style="display: none;">
                            <input type="checkbox" id="rhythm-dotted-half" value="half.">
                            <span data-i18n="rhythm.dottedHalf">附点二分音符</span>
                        </label>
                        <label class="checkbox-item" id="rhythm-half-label" style="display: block;">
                            <input type="checkbox" id="rhythm-half" value="half" checked="">
                            <span data-i18n="rhythm.half">二分音符</span>
                        </label>
                        <label class="checkbox-item" id="rhythm-dotted-quarter-label" style="display: none;">
                            <input type="checkbox" id="rhythm-dotted-quarter" value="quarter.">
                            <span data-i18n="rhythm.dottedQuarter">附点四分音符</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="rhythm-quarter" value="quarter" checked="">
                            <span data-i18n="rhythm.quarter">四分音符</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="rhythm-eighth" value="eighth">
                            <span data-i18n="rhythm.eighth">八分音符</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="rhythm-16th" value="16th">
                            <span data-i18n="rhythm.sixteenth">十六分音符</span>
                        </label>
                        <label class="checkbox-item" id="rhythm-triplet-label" style="display: flex;">
                            <input type="checkbox" id="rhythm-triplet" value="triplet">
                            <span data-i18n="rhythm.triplet">三连音</span>
                        </label>
                        <label class="checkbox-item" id="rhythm-duplet-label" style="display: none;">
                            <input type="checkbox" id="rhythm-duplet" value="duplet">
                            <span data-i18n="rhythm.duplet">二连音</span>
                        </label>
                        <label class="checkbox-item" id="rhythm-quadruplet-label" style="display: none;">
                            <input type="checkbox" id="rhythm-quadruplet" value="quadruplet">
                            <span data-i18n="rhythm.quadruplet">四连音</span>
                        </label>
                    </div>
                </div>

                <!-- 高级设置区域 -->
                <div id="rhythmAdvancedSettings" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 2px solid #e9ecef;">
                    <h4 style="margin-bottom: 15px; color: #495057;" data-i18n="rhythm.advancedFreq">高级频率设置</h4>
                    <p style="font-size: 0.9rem; color: #6c757d; margin-bottom: 20px;" data-i18n="rhythm.freqDesc">调整各节奏单位在旋律中的出现频率 (0% = 不使用, 100% = 优先使用)</p>
                    
                    <div class="rhythm-frequency-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="frequency-item" id="freq-whole-item" style="display: block;">
                            <label for="freq-whole" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;" data-i18n="rhythm.freq.whole">全音符频率:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-whole" min="0" max="100" value="10" style="flex: 1;">
                                <span id="freq-whole-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">10%</span>
                            </div>
                        </div>
                        <div class="frequency-item" id="freq-dotted-half-item" style="display: none;">
                            <label for="freq-dotted-half" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;" data-i18n="rhythm.freq.dottedHalf">附点二分音符频率:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-dotted-half" min="0" max="100" value="15" style="flex: 1;">
                                <span id="freq-dotted-half-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">15%</span>
                            </div>
                        </div>
                        <div class="frequency-item" id="freq-half-item" style="display: block;">
                            <label for="freq-half" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;" data-i18n="rhythm.freq.half">二分音符频率:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-half" min="0" max="100" value="30" style="flex: 1;">
                                <span id="freq-half-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">30%</span>
                            </div>
                        </div>
                        <div class="frequency-item" id="freq-dotted-quarter-item" style="display: none;">
                            <label for="freq-dotted-quarter" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;" data-i18n="rhythm.freq.dottedQuarter">附点四分音符频率:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-dotted-quarter" min="0" max="100" value="35" style="flex: 1;">
                                <span id="freq-dotted-quarter-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">35%</span>
                            </div>
                        </div>
                        <div class="frequency-item">
                            <label for="freq-quarter" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;" data-i18n="rhythm.freq.quarter">四分音符频率:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-quarter" min="0" max="100" value="50" style="flex: 1;">
                                <span id="freq-quarter-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">50%</span>
                            </div>
                        </div>
                        <div class="frequency-item">
                            <label for="freq-eighth" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;" data-i18n="rhythm.freq.eighth">八分音符频率:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-eighth" min="0" max="100" value="40" style="flex: 1;">
                                <span id="freq-eighth-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">40%</span>
                            </div>
                        </div>
                        <div class="frequency-item">
                            <label for="freq-16th" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;" data-i18n="rhythm.freq.sixteenth">十六分音符频率:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-16th" min="0" max="100" value="20" style="flex: 1;">
                                <span id="freq-16th-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">20%</span>
                            </div>
                        </div>
                        <div class="frequency-item" id="freq-triplet-item" style="display: block;">
                            <label for="freq-triplet" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;" data-i18n="rhythm.freq.triplet">三连音频率:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-triplet" min="0" max="100" value="15" style="flex: 1;">
                                <span id="freq-triplet-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">15%</span>
                            </div>
                        </div>
                        <div class="frequency-item" id="freq-duplet-item" style="display: none;">
                            <label for="freq-duplet" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;" data-i18n="rhythm.freq.duplet">二连音频率:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-duplet" min="0" max="100" value="30" style="flex: 1;">
                                <span id="freq-duplet-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">30%</span>
                            </div>
                        </div>
                        <div class="frequency-item" id="freq-quadruplet-item" style="display: none;">
                            <label for="freq-quadruplet" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">四连音频率:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-quadruplet" min="0" max="100" value="25" style="flex: 1;">
                                <span id="freq-quadruplet-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">25%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn-secondary" onclick="resetRhythmFrequencies()" style="margin-right: 10px;" data-i18n="button.resetDefault">返回默认</button>
                    </div>
                </div>
                
                <div class="modal-buttons">
                    <button class="btn-secondary" onclick="toggleRhythmAdvancedSettings()" id="rhythmAdvancedBtn" data-i18n="button.advanced">高级设置</button>
                    <button class="btn-primary" onclick="saveRhythmSettings()" data-i18n="button.save">保存设置</button>
                    <button class="btn-secondary" onclick="closeRhythmSettings()" data-i18n="button.cancel">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Articulations 弹窗 -->
    <div id="articulationModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="controls.articulation">演奏技巧</h3>
                <button class="close-btn" onclick="closeArticulationSettings()">×</button>
            </div>
            <div class="modal-body">
                <!-- 基本Articulation技巧 -->
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="articulation.basic.title">基本演奏法 (Basic Articulations)</h4>
                        <button class="btn-select-all" onclick="selectAllBasicArticulations()" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">全选</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item" title="断奏 - 音符时值减半，轻快地演奏">
                            <input type="checkbox" id="art-staccato" value="staccato">
                            <span>Staccato (断奏) •</span>
                        </label>
                        <label class="checkbox-item" title="重音 - 强调某些音符">
                            <input type="checkbox" id="art-accent" value="accent">
                            <span>Accent (重音) &gt;</span>
                        </label>
                        <label class="checkbox-item" title="短倚音 - 快速的装饰音">
                            <input type="checkbox" id="art-acciaccatura" value="acciaccatura">
                            <span>Acciaccatura (短倚音)</span>
                        </label>
                    </div>
                </div>

                <!-- 吉他特有技巧 -->
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4>吉他技巧 (Guitar Techniques)</h4>
                        <button class="btn-select-all" onclick="selectAllGuitarTechniques()" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">全选</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item" title="击弦 - 用左手敲击产生音符">
                            <input type="checkbox" id="gtr-hammer" value="hammer-on">
                            <span>Hammer-on (击弦) H</span>
                        </label>
                        <label class="checkbox-item" title="勾弦 - 用左手勾离产生音符">
                            <input type="checkbox" id="gtr-pull" value="pull-off">
                            <span>Pull-off (勾弦) P</span>
                        </label>
                    </div>
                </div>

                <!-- 高级设置区域 -->
                <div id="articulationAdvancedSettings" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 2px solid #e9ecef;">
                    <h4 style="margin-bottom: 15px; color: #495057;" data-i18n="rhythm.advancedFreq">高级频率设置</h4>
                    <p style="font-size: 0.9rem; color: #6c757d; margin-bottom: 20px;" data-i18n="articulation.freqDesc">调整各演奏法在旋律中的出现频率 (0% = 不使用, 100% = 经常使用)</p>
                    
                    <div style="margin-bottom: 20px;">
                        <h5 style="color: #495057; margin-bottom: 10px;" data-i18n="articulation.basicFreq">基本演奏法频率</h5>
                        <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
                            <div class="frequency-item">
                                <label for="freq-staccato" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">Staccato (断奏) 频率:</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="range" id="freq-staccato" min="0" max="100" value="20" style="flex: 1;">
                                    <span id="freq-staccato-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">20%</span>
                                </div>
                            </div>
                            <div class="frequency-item">
                                <label for="freq-accent" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">Accent (重音) 频率:</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="range" id="freq-accent" min="0" max="100" value="15" style="flex: 1;">
                                    <span id="freq-accent-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">15%</span>
                                </div>
                            </div>
                            <div class="frequency-item">
                                <label for="freq-acciaccatura" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">Acciaccatura (短倚音) 频率:</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="range" id="freq-acciaccatura" min="0" max="100" value="10" style="flex: 1;">
                                    <span id="freq-acciaccatura-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">10%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h5 style="color: #495057; margin-bottom: 10px;">吉他技巧频率</h5>
                        <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
                            <div class="frequency-item">
                                <label for="freq-slur" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">击勾弦频率:</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="range" id="freq-slur" min="0" max="100" value="15" style="flex: 1;">
                                    <span id="freq-slur-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">15%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn-secondary" onclick="resetArticulationFrequencies()" style="margin-right: 10px;">返回默认</button>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-secondary" onclick="toggleArticulationAdvancedSettings()" id="articulationAdvancedBtn" data-i18n="button.advanced">高级设置</button>
                    <button class="btn-primary" onclick="saveArticulationSettings()" data-i18n="button.save">保存设置</button>
                    <button class="btn-secondary" onclick="closeArticulationSettings()" data-i18n="button.cancel">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 调号设置弹窗 -->
    <div id="keySignatureModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>调号设置</h3>
                <button class="close-btn" onclick="closeKeySettings()">×</button>
            </div>
            <div class="modal-body">
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="key.majorSection">大调 (Major)</h4>
                        <button class="btn-select-all" onclick="selectAllMajorKeys()" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;" data-i18n="button.selectAllMajor">全选</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-C" value="C" checked="">
                            <span data-i18n="key.C-major">C 大调 (0#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-G" value="G">
                            <span data-i18n="key.G-major">G 大调 (1#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-D" value="D">
                            <span data-i18n="key.D-major">D 大调 (2#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-A" value="A">
                            <span data-i18n="key.A-major">A 大调 (3#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-E" value="E">
                            <span data-i18n="key.E-major">E 大调 (4#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-B" value="B">
                            <span data-i18n="key.B-major">B 大调 (5#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-F#" value="F#">
                            <span data-i18n="key.Fs-major">F# 大调 (6#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-F" value="F">
                            <span data-i18n="key.F-major">F 大调 (1b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Bb" value="Bb">
                            <span data-i18n="key.Bb-major">Bb 大调 (2b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Eb" value="Eb">
                            <span data-i18n="key.Eb-major">Eb 大调 (3b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Ab" value="Ab">
                            <span data-i18n="key.Ab-major">Ab 大调 (4b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Db" value="Db">
                            <span data-i18n="key.Db-major">Db 大调 (5b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Gb" value="Gb">
                            <span data-i18n="key.Gb-major">Gb 大调 (6b)</span>
                        </label>
                    </div>
                </div>

                <div class="rhythm-section" style="margin-top: 30px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="key.minorSection">小调 (Minor)</h4>
                        <button class="btn-select-all" onclick="selectAllMinorKeys()" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;" data-i18n="button.selectAllMinor">全选</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Am" value="Am">
                            <span data-i18n="key.a-minor">A 小调 (0#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Em" value="Em">
                            <span data-i18n="key.e-minor">E 小调 (1#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Bm" value="Bm">
                            <span data-i18n="key.b-minor">B 小调 (2#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-F#m" value="F#m">
                            <span data-i18n="key.fs-minor">F# 小调 (3#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-C#m" value="C#m">
                            <span data-i18n="key.cs-minor">C# 小调 (4#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-G#m" value="G#m">
                            <span data-i18n="key.gs-minor">G# 小调 (5#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-D#m" value="D#m">
                            <span data-i18n="key.ds-minor">D# 小调 (6#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Dm" value="Dm">
                            <span data-i18n="key.d-minor">D 小调 (1b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Gm" value="Gm">
                            <span data-i18n="key.g-minor">G 小调 (2b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Cm" value="Cm">
                            <span data-i18n="key.c-minor">C 小调 (3b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Fm" value="Fm">
                            <span data-i18n="key.f-minor">F 小调 (4b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Bbm" value="Bbm">
                            <span data-i18n="key.bb-minor">Bb 小调 (5b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Ebm" value="Ebm">
                            <span data-i18n="key.eb-minor">Eb 小调 (6b)</span>
                        </label>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveKeySettings()" data-i18n="button.save">保存设置</button>
                    <button class="btn-secondary" onclick="closeKeySettings()" data-i18n="button.cancel">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 拍号设置弹窗 -->
    <div id="timeSignatureModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="modal.timeSignature.title">拍号设置</h3>
                <button class="close-btn" onclick="closeTimeSignatureSettings()">×</button>
            </div>
            <div class="modal-body">
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="timeSignature.options">拍号选项</h4>
                        <button class="btn-select-all" onclick="selectAllTimeSignatures()" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;" data-i18n="button.selectAll">全选</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="time-2/4" value="2/4">
                            <span data-i18n="time.2-4">2/4 拍</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="time-3/4" value="3/4">
                            <span data-i18n="time.3-4">3/4 拍</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="time-4/4" value="4/4" checked="">
                            <span data-i18n="time.4-4">4/4 拍</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="time-6/8" value="6/8">
                            <span data-i18n="time.6-8">6/8 拍</span>
                        </label>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveTimeSignatureSettings()" data-i18n="button.save">保存设置</button>
                    <button class="btn-secondary" onclick="closeTimeSignatureSettings()" data-i18n="button.cancel">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 音程跨度设置弹窗 -->
    <div id="intervalModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>音程跨度设置</h3>
                <button class="close-btn" onclick="closeIntervalSettings()">×</button>
            </div>
            <div class="modal-body">
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4>最大音程跨度选项</h4>
                        <small style="color: #666; font-size: 12px;">只能选择一个音程作为最大跨度</small>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-1" value="1" onchange="handleIntervalCheckboxChange(this)">
                            <span>小二度</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-2" value="2" onchange="handleIntervalCheckboxChange(this)">
                            <span>大二度</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-3" value="3" onchange="handleIntervalCheckboxChange(this)">
                            <span>小三度</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-4" value="4" onchange="handleIntervalCheckboxChange(this)">
                            <span>大三度</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-5" value="5" onchange="handleIntervalCheckboxChange(this)">
                            <span>完全四度</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-6" value="6" onchange="handleIntervalCheckboxChange(this)">
                            <span>增四度/减五度</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-7" value="7" onchange="handleIntervalCheckboxChange(this)">
                            <span>完全五度</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-8" value="8" onchange="handleIntervalCheckboxChange(this)">
                            <span>小六度</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-9" value="9" onchange="handleIntervalCheckboxChange(this)">
                            <span>大六度</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-10" value="10" onchange="handleIntervalCheckboxChange(this)">
                            <span>小七度</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-11" value="11" onchange="handleIntervalCheckboxChange(this)">
                            <span>大七度</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-12" value="12" checked="" onchange="handleIntervalCheckboxChange(this)">
                            <span>完全八度</span>
                        </label>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveIntervalSettings()" data-i18n="button.save">保存设置</button>
                    <button class="btn-secondary" onclick="closeIntervalSettings()" data-i18n="button.cancel">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 谱号设置弹窗 -->
    <div id="clefModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="modal.clefSettings">谱号设置</h3>
                <button class="close-btn" onclick="closeClefSettings()">×</button>
            </div>
            <div class="modal-body">
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="clef.options">谱号选项</h4>
                        <button class="btn-select-all" onclick="selectAllClefs()" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;" data-i18n="button.selectAll">全选</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="clef-treble" value="treble" checked="">
                            <span data-i18n="clef.treble">高音谱号 (G谱号)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="clef-bass" value="bass">
                            <span data-i18n="clef.bass">低音谱号 (F谱号)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="clef-alto" value="alto">
                            <span data-i18n="clef.alto">中音谱号 (C谱号)</span>
                        </label>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveClefSettings()" data-i18n="button.save">保存设置</button>
                    <button class="btn-secondary" onclick="closeClefSettings()" data-i18n="button.cancel">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- emergency-fix.js removed - not needed for interval generation -->
    
    <!-- 增强的全选切换功能 - 已集成到主代码中 -->
    
    <!-- 主题切换系统 -->
    <script>
        // 页面模式标识
        const pageMode = 'interval';
        
        // 主题切换相关变量和功能
        let currentTheme = localStorage.getItem('preferredTheme') || 'light';
        
        // 主题图标
        const themeIcons = {
            'light': '🌙', // 在light模式显示月亮图标，点击切换到dark
            'dark': '☀️'   // 在dark模式显示太阳图标，点击切换到light
        };
        
        // 切换主题 (保留向后兼容性)
        function toggleTheme() {
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            setTheme(newTheme);
        }
        
        // 设置主题 (新版本，用于设置菜单)
        function setTheme(theme) {
            currentTheme = theme;
            localStorage.setItem('preferredTheme', theme);

            // 设置HTML的data-theme属性
            document.documentElement.setAttribute('data-theme', theme);

            // 触发统一同步系统 (同标签页内实时同步)
            if (window.ICStudioSync) {
                window.ICStudioSync.syncTheme(theme, 'interval-tool');
            }

            // 关闭设置菜单
            closeSettings();

        }
        
        // 应用主题 (保留向后兼容性)
        function switchTheme(theme) {
            currentTheme = theme;
            localStorage.setItem('preferredTheme', theme);
            
            // 设置HTML的data-theme属性
            document.documentElement.setAttribute('data-theme', theme);
            
            // 更新按钮图标 (如果存在旧的主题切换器)
            const themeSwitcher = document.getElementById('themeSwitcher');
            if (themeSwitcher) {
                themeSwitcher.textContent = themeIcons[theme];
            }
            
        }
        
        // 设置菜单控制
        function toggleSettings() {
            const settingsMenu = document.getElementById('settingsMenu');
            const isVisible = settingsMenu.classList.contains('show');
            
            if (isVisible) {
                closeSettings();
            } else {
                openSettings();
            }
        }
        
        function openSettings() {
            const settingsMenu = document.getElementById('settingsMenu');
            settingsMenu.classList.add('show');
            
            // 添加点击外部区域关闭菜单的监听器
            setTimeout(() => {
                document.addEventListener('click', handleClickOutside);
            }, 10);
        }
        
        function closeSettings() {
            const settingsMenu = document.getElementById('settingsMenu');
            settingsMenu.classList.remove('show');
            
            // 移除点击外部区域的监听器
            document.removeEventListener('click', handleClickOutside);
        }
        
        // 功能选择器控制
        function toggleFunctionSelector() {
            const functionMenu = document.getElementById('functionMenu');
            const isVisible = functionMenu.classList.contains('show');
            
            if (isVisible) {
                closeFunctionSelector();
            } else {
                openFunctionSelector();
            }
        }
        
        function openFunctionSelector() {
            const functionMenu = document.getElementById('functionMenu');
            functionMenu.classList.add('show');
            
            // 添加点击外部区域关闭菜单的监听器
            setTimeout(() => {
                document.addEventListener('click', handleFunctionClickOutside);
            }, 10);
        }
        
        function closeFunctionSelector() {
            const functionMenu = document.getElementById('functionMenu');
            functionMenu.classList.remove('show');
            
            // 移除点击外部区域的监听器
            document.removeEventListener('click', handleFunctionClickOutside);
        }
        
        // 处理点击外部区域关闭功能菜单
        function handleFunctionClickOutside(event) {
            const functionSelector = document.querySelector('.function-selector');
            
            if (functionSelector && !functionSelector.contains(event.target)) {
                closeFunctionSelector();
            }
        }
        
        // 当前功能模式
        let currentFunctionMode = 'interval';
        
        // 音程历史记录系统
        let intervalHistory = [];
        let currentIntervalIndex = -1;
        const MAX_HISTORY_SIZE = 50;
        
        // 切换功能
        function switchFunction(mode) {
            if (mode === 'melody') {
                // 导航到旋律视奏页面
                window.location.href = 'melody-generator.html';
            } else if (mode === 'interval') {
                // 已经在音程视奏页面
                closeFunctionSelector();
                console.log('已在音程视奏模式');
            } else if (mode === 'chord') {
                // 导航到和弦视奏页面
                window.location.href = 'chord-generator.html';
            }
        }
        
        // 处理点击外部区域关闭设置菜单
        function handleClickOutside(event) {
            const settingsDropdown = document.querySelector('.settings-dropdown');
            
            if (settingsDropdown && !settingsDropdown.contains(event.target)) {
                closeSettings();
            }
        }

        // 节拍器相关变量和功能
        let metronomeInterval = null;
        let metronomeAudioContext = null;
        let metronomeOscillator = null;
        let isMetronomeRunning = false;
        let metronomeTempo = 60; // 默认60 BPM

        // 🔧 精确同步：记录节拍器启动时间和当前节拍
        let metronomeStartTime = null;
        let metronomeCurrentBeat = 0;
        let metronomeSchedulerInterval = null;

        // 🔧 关键修复：使用与音程播放相同的 AudioContext
        function initializeMetronomeAudio() {
            try {
                // 优先使用音程播放的 AudioContext
                if (window.intervalAudioCtx) {
                    metronomeAudioContext = window.intervalAudioCtx;
                    console.log('🎵 节拍器使用音程的 AudioContext（共享时钟）');
                } else {
                    metronomeAudioContext = new (window.AudioContext || window.webkitAudioContext)();
                    // 反向共享：让音程也使用这个 AudioContext
                    window.intervalAudioCtx = metronomeAudioContext;
                    console.log('🎵 节拍器创建新 AudioContext（共享给音程）');
                }
                return true;
            } catch (error) {
                console.error('❌ Web Audio API 不支持:', error);
                return false;
            }
        }

        // 播放节拍器声音 - 支持精确调度
        function playMetronomeSound(time) {
            if (!metronomeAudioContext) {
                if (!initializeMetronomeAudio()) return;
            }

            try {
                // 恢复音频上下文（用户交互后）
                if (metronomeAudioContext.state === 'suspended') {
                    metronomeAudioContext.resume();
                }

                // 🔧 使用传入的精确时间，如果没有则使用当前时间
                const scheduleTime = time !== undefined ? time : metronomeAudioContext.currentTime;

                const oscillator = metronomeAudioContext.createOscillator();
                const gainNode = metronomeAudioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(metronomeAudioContext.destination);

                // 使用方波和自然音高 (参考NiceChord节拍器)
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(523.25, scheduleTime); // C5音高

                // 设置自然的音量包络 (更好的release time)
                gainNode.gain.setValueAtTime(0.25, scheduleTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, scheduleTime + 0.05);

                oscillator.start(scheduleTime);
                oscillator.stop(scheduleTime + 0.05);

                // 视觉反馈 - 更新header指示器（只在立即播放时）
                if (time === undefined || scheduleTime <= metronomeAudioContext.currentTime + 0.05) {
                    const headerIndicator = document.getElementById('headerBeatIndicator');

                    if (headerIndicator) {
                        headerIndicator.classList.add('beat');
                        setTimeout(() => {
                            headerIndicator.classList.remove('beat');
                        }, 150);
                    }
                }

            } catch (error) {
                console.error('❌ 节拍器声音播放失败:', error);
            }
        }

        // 设置节拍器速度
        function setMetronomeTempo(bpm) {
            metronomeTempo = Math.max(1, Math.min(999, bpm));

            // 同步更新header输入框
            const headerInput = document.getElementById('headerMetronomeBpm');
            if (headerInput) headerInput.value = metronomeTempo;

            // 如果节拍器正在运行，重新启动以应用新速度
            if (isMetronomeRunning) {
                stopMetronome();
                startMetronome();
            }
        }

        // 🔧 精确节拍器调度器 - 使用 Web Audio API 时钟
        function scheduleMetronomeBeat() {
            if (!metronomeAudioContext) {
                if (!initializeMetronomeAudio()) return;
            }

            const beatDuration = 60.0 / metronomeTempo; // 每拍的秒数
            const scheduleAheadTime = 0.2; // 调度未来 200ms 的节拍

            while (metronomeStartTime + metronomeCurrentBeat * beatDuration <
                   metronomeAudioContext.currentTime + scheduleAheadTime) {

                const beatTime = metronomeStartTime + metronomeCurrentBeat * beatDuration;

                // 调度这一拍
                playMetronomeSound(beatTime);

                metronomeCurrentBeat++;
            }
        }

        // 启动节拍器 - 使用精确 Web Audio API 调度
        function startMetronome() {
            const headerInput = document.getElementById('headerMetronomeBpm');
            const tempo = parseInt(headerInput ? headerInput.value : metronomeTempo) || 60;
            metronomeTempo = tempo;

            // 同步更新header输入框
            if (headerInput) headerInput.value = metronomeTempo;

            if (isMetronomeRunning) return;

            if (!metronomeAudioContext) {
                if (!initializeMetronomeAudio()) return;
            }

            // 恢复音频上下文
            if (metronomeAudioContext.state === 'suspended') {
                metronomeAudioContext.resume();
            }

            isMetronomeRunning = true;

            // 🔧 关键修复：使用 AudioContext 时间 0 作为全局节拍网格的起点
            metronomeStartTime = 0; // 全局网格起点

            const beatDuration = 60.0 / metronomeTempo;
            const now = metronomeAudioContext.currentTime;

            // 计算当前应该在第几拍（从时间 0 开始）
            const currentBeatNumber = Math.floor(now / beatDuration);
            const nextBeatNumber = currentBeatNumber + 1;
            const nextBeatTime = nextBeatNumber * beatDuration;

            // 确保下一拍至少在未来 50ms，否则跳过
            const minLookahead = 0.05;
            if (nextBeatTime < now + minLookahead) {
                metronomeCurrentBeat = nextBeatNumber + 1;
            } else {
                metronomeCurrentBeat = nextBeatNumber;
            }

            console.log(`🎵 节拍器对齐全局网格: ${metronomeTempo} BPM, 当前=${now.toFixed(3)}s, 从第${metronomeCurrentBeat}拍开始 (时间=${(metronomeCurrentBeat * beatDuration).toFixed(3)}s)`);

            // 立即调度第一批节拍
            scheduleMetronomeBeat();

            // 🔧 使用更频繁的定时器来检查和调度（25ms），而不是用它来播放声音
            metronomeSchedulerInterval = setInterval(scheduleMetronomeBeat, 25);

            // 更新UI
            updateMetronomeUI();
        }

        // 与播放内容同步的节拍器启动
        function synchronizeMetronomeWithPlayback(interval) {
            const currentTime = performance.now();
            const playbackElapsed = currentTime - window.intervalPlaybackStartTime; // 播放已经过去的时间（毫秒）

            // 🎵 记录节拍器启动时间，用于同步计算
            window.metronomeStartTime = currentTime;

            // 获取播放内容的拍号信息
            const timeSignature = window.intervalPlaybackTimeSignature || { beats: 4, beatType: 4 };
            const beatsPerMeasure = timeSignature.beats;

            // 计算当前在哪一拍（基于四分音符）
            const beatDurationMs = interval; // 每拍的毫秒数
            const currentBeatPosition = (playbackElapsed / beatDurationMs) % beatsPerMeasure;
            const currentBeatNumber = Math.floor(currentBeatPosition) + 1; // 1-based
            const positionInBeat = currentBeatPosition % 1; // 在当前拍内的位置（0-1）

            console.log(`  - 播放已进行: ${(playbackElapsed/1000).toFixed(2)}秒`);
            console.log(`  - 当前拍位置: ${currentBeatPosition.toFixed(3)} (第${currentBeatNumber}拍)`);
            console.log(`  - 拍内位置: ${(positionInBeat*100).toFixed(1)}%`);

            // 计算到下一个整拍的时间
            const timeToNextBeat = (1 - positionInBeat) * beatDurationMs;

            if (timeToNextBeat < 50) {
                // 如果距离下一拍很近（<50ms），立即播放
                playMetronomeSound();

                // 设置定时器从下一拍开始
                metronomeInterval = setInterval(() => {
                    playMetronomeSound();
                }, interval);
            } else {
                // 延迟到下一拍开始

                // 延迟到下一拍
                setTimeout(() => {
                    if (isMetronomeRunning) { // 确保用户没有取消
                        playMetronomeSound();

                        // 设置定时器
                        metronomeInterval = setInterval(() => {
                            playMetronomeSound();
                        }, interval);
                    }
                }, timeToNextBeat);
            }
        }

        // 停止节拍器
        function stopMetronome() {
            if (metronomeInterval) {
                clearInterval(metronomeInterval);
                metronomeInterval = null;
            }

            // 🔧 清除调度器定时器
            if (metronomeSchedulerInterval) {
                clearInterval(metronomeSchedulerInterval);
                metronomeSchedulerInterval = null;
            }

            isMetronomeRunning = false;

            // 重置节拍计数
            metronomeStartTime = null;
            metronomeCurrentBeat = 0;

            updateMetronomeUI();

            console.log('🔇 节拍器已停止');
        }

        // 切换节拍器开关
        function toggleMetronome() {
            if (isMetronomeRunning) {
                stopMetronome();
            } else {
                startMetronome();
            }
        }

        // 更新节拍器UI
        function updateMetronomeUI() {
            const headerToggleBtn = document.getElementById('headerMetronomeBtn');
            
            // 更新header中的按钮
            if (headerToggleBtn) {
                if (isMetronomeRunning) {
                    headerToggleBtn.classList.add('active');
                    headerToggleBtn.textContent = '🎵';
                    headerToggleBtn.title = '停止节拍器';
                } else {
                    headerToggleBtn.classList.remove('active');
                    headerToggleBtn.textContent = '🎵';
                    headerToggleBtn.title = '开始节拍器';
                }
            }
        }

        // 监听header中BPM输入框的变化
        document.addEventListener('DOMContentLoaded', function() {
            const headerSpeedInput = document.getElementById('headerMetronomeBpm');
            
            if (headerSpeedInput) {
                // 实时输入验证
                headerSpeedInput.addEventListener('input', function() {
                    let value = parseInt(this.value);
                    
                    // 限制范围
                    if (value < 1) {
                        this.value = 1;
                        value = 1;
                    } else if (value > 999) {
                        this.value = 999;
                        value = 999;
                    }
                    
                    if (!isNaN(value)) {
                        setMetronomeTempo(value);
                    }
                });
                
                // Enter键确认
                headerSpeedInput.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        this.blur(); // 失去焦点，触发验证
                    }
                });
                
                // 失去焦点时验证
                headerSpeedInput.addEventListener('blur', function() {
                    let value = parseInt(this.value);
                    
                    if (isNaN(value) || value < 1) {
                        this.value = 1;
                        value = 1;
                    } else if (value > 999) {
                        this.value = 999;
                        value = 999;
                    }
                    
                    setMetronomeTempo(value);
                });

                // BPM拖动功能实现
                let isDragging = false;
                let startY = 0;
                let startValue = 0;
                let dragTimeout = null;
                let hasStartedDrag = false;
                
                // 鼠标按下事件
                headerSpeedInput.addEventListener('mousedown', function(event) {
                    // 只处理左键点击
                    if (event.button !== 0) return;
                    
                    startY = event.clientY;
                    startValue = parseInt(this.value) || 60;
                    hasStartedDrag = false;
                    
                    console.log('BPM拖动: 鼠标按下', startValue);
                    
                    // 长按80ms后启动拖动模式
                    dragTimeout = setTimeout(() => {
                        isDragging = true;
                        hasStartedDrag = true;
                        
                        console.log('BPM拖动: 启动拖动模式');
                        
                        // 防止文本选择和默认行为
                        event.preventDefault();
                        document.body.style.userSelect = 'none';
                        document.body.style.webkitUserSelect = 'none';
                        document.body.style.mozUserSelect = 'none';
                        document.body.style.msUserSelect = 'none';
                        
                        // 添加拖动中的视觉反馈
                        this.style.cursor = 'ns-resize';
                        this.classList.add('dragging');
                        this.blur(); // 失去焦点，避免键盘输入干扰
                    }, 80);
                });
                
                // 鼠标移动事件 - 绑定到全局
                const handleMouseMove = function(event) {
                    if (!isDragging || !hasStartedDrag) return;
                    
                    const deltaY = startY - event.clientY; // 向上为正，向下为负
                    const sensitivity = 1; // 拖动灵敏度，每1像素改变1个BPM
                    const newValue = Math.max(1, Math.min(999, startValue + Math.round(deltaY / sensitivity)));
                    
                    console.log('BPM拖动: 移动中', deltaY, newValue);
                    
                    headerSpeedInput.value = newValue;
                    setMetronomeTempo(newValue);
                    
                    // 阻止默认行为
                    event.preventDefault();
                    event.stopPropagation();
                };
                
                // 鼠标释放事件 - 绑定到全局
                const handleMouseUp = function(event) {
                    console.log('BPM拖动: 鼠标释放', isDragging);
                    
                    // 清除长按计时器
                    if (dragTimeout) {
                        clearTimeout(dragTimeout);
                        dragTimeout = null;
                    }
                    
                    if (isDragging && hasStartedDrag) {
                        isDragging = false;
                        hasStartedDrag = false;
                        
                        // 恢复文本选择
                        document.body.style.userSelect = '';
                        document.body.style.webkitUserSelect = '';
                        document.body.style.mozUserSelect = '';
                        document.body.style.msUserSelect = '';
                        
                        // 移除视觉反馈
                        headerSpeedInput.style.cursor = '';
                        headerSpeedInput.classList.remove('dragging');
                        
                        console.log('BPM拖动: 结束拖动模式');
                    }
                };
                
                // 绑定全局事件
                document.addEventListener('mousemove', handleMouseMove, true);
                document.addEventListener('mouseup', handleMouseUp, true);
                
                // 鼠标离开输入框时取消长按
                headerSpeedInput.addEventListener('mouseleave', function(event) {
                    if (dragTimeout && !isDragging) {
                        clearTimeout(dragTimeout);
                        dragTimeout = null;
                        console.log('BPM拖动: 鼠标离开，取消长按');
                    }
                });
                
                // 防止右键菜单干扰
                headerSpeedInput.addEventListener('contextmenu', function(event) {
                    if (isDragging) {
                        event.preventDefault();
                    }
                });
            }
            
            // 监听临时记号滑块变化
            const accidentalSlider = document.getElementById('accidentalRate');
            const accidentalValue = document.getElementById('accidentalRateValue');

            if (accidentalSlider && accidentalValue) {
                accidentalSlider.addEventListener('input', function() {
                    accidentalValue.textContent = this.value + '%';
                });
            }

            // 🎼 智能谱号-音域绑定系统：添加事件监听器
            function initClefRangeBinding() {
                // 统一使用全局 intervalSettings 实例，避免重复创建
                if (typeof window.intervalSettings === 'undefined') {
                    // 如果全局变量不存在，暂时创建，但优先使用已存在的实例
                    if (typeof intervalSettings !== 'undefined') {
                        window.intervalSettings = intervalSettings;
                    } else {
                        window.intervalSettings = new IntervalSettings();
                    }
                }

                // 谱号复选框事件监听
                const clefCheckboxes = document.querySelectorAll('#clefModal input[type="checkbox"]');

                clefCheckboxes.forEach((checkbox, index) => {

                    checkbox.addEventListener('change', function() {

                        if (this.checked) {
                            // 保存当前音域到之前的谱号
                            const currentMin = document.getElementById('rangeMin')?.value;
                            const currentMax = document.getElementById('rangeMax')?.value;
                            if (currentMin && currentMax) {
                                // 找到之前选中的谱号
                                const previouslyChecked = Array.from(clefCheckboxes).find(cb =>
                                    cb !== this && cb.checked
                                );
                                if (previouslyChecked) {
                                    window.intervalSettings.setClefRange(previouslyChecked.value, parseInt(currentMin), parseInt(currentMax));
                                }
                            }

                            // 取消其他谱号选择（确保只选择一个）
                            clefCheckboxes.forEach(cb => {
                                if (cb !== this && cb.checked) {
                                    console.log(`🔄 取消选择谱号: ${cb.value}`);
                                    cb.checked = false;
                                }
                            });

                            // 处理谱号变化
                            window.intervalSettings.onClefChange(this.value);
                        }
                    });
                });

                // 音域选择器事件监听
                const rangeMinSelect = document.getElementById('rangeMin');
                const rangeMaxSelect = document.getElementById('rangeMax');

                if (rangeMinSelect) {
                    rangeMinSelect.addEventListener('change', function() {
                        console.log('🎚️ 最低音发生变化:', this.value);
                        if (window.intervalSettings && typeof window.intervalSettings.onRangeChange === 'function') {
                            window.intervalSettings.onRangeChange();
                        } else {
                            console.warn('⚠️ intervalSettings.onRangeChange 不可用');
                        }
                    });
                }

                if (rangeMaxSelect) {
                    rangeMaxSelect.addEventListener('change', function() {
                        console.log('🎚️ 最高音发生变化:', this.value);
                        if (window.intervalSettings && typeof window.intervalSettings.onRangeChange === 'function') {
                            window.intervalSettings.onRangeChange();
                        } else {
                            console.warn('⚠️ intervalSettings.onRangeChange 不可用');
                        }
                    });
                }

                // 初始化UI：设置当前谱号对应的默认音域
                setTimeout(() => {
                    const currentClef = window.intervalSettings.getClef();
                    console.log(`🔄 页面加载初始化: ${currentClef} 谱号`);

                    // 设置初始谱号记录
                    window.intervalSettings.lastSelectedClef = currentClef;

                    // 确保元素已经完全加载
                    const rangeMinSelect = document.getElementById('rangeMin');
                    const rangeMaxSelect = document.getElementById('rangeMax');

                    if (rangeMinSelect && rangeMaxSelect) {

                        // 🎯 页面加载时总是使用默认音域，不使用保存的设置
                        const defaultRange = window.intervalSettings.getClefDefaultRange(currentClef);

                        rangeMinSelect.value = defaultRange.min.toString();
                        rangeMaxSelect.value = defaultRange.max.toString();

                    } else {
                        console.error('❌ 初始化时无法找到音域选择器');
                    }
                }, 100); // 给DOM一点时间完全初始化


                // 添加测试函数到全局作用域（调试用）
                window.testClefRangeBinding = function() {
                    console.log('🧪 测试谱号-音域绑定功能');
                    const settings = window.intervalSettings;

                    console.log('🧪 测试1: 切换到低音谱号');
                    document.getElementById('clef-bass').checked = true;
                    document.getElementById('clef-treble').checked = false;
                    settings.updateRangeUIForClef('bass');

                    setTimeout(() => {
                        console.log('🧪 测试2: 切换到高音谱号');
                        document.getElementById('clef-treble').checked = true;
                        document.getElementById('clef-bass').checked = false;
                        settings.updateRangeUIForClef('treble');
                    }, 2000);
                };

                // 添加随机选择测试函数
                window.testRandomClefSelection = function() {
                    console.log('🧪 测试随机谱号选择功能');
                    const settings = window.intervalSettings;

                    // 勾选多个谱号
                    document.getElementById('clef-treble').checked = true;
                    document.getElementById('clef-bass').checked = true;
                    document.getElementById('clef-alto').checked = true;

                    console.log('🧪 已勾选所有谱号，开始多次调用getCurrentSettings()');

                    // 多次调用getCurrentSettings()来模拟生成音程
                    for (let i = 0; i < 5; i++) {
                        setTimeout(() => {
                            console.log(`🧪 第${i + 1}次调用getCurrentSettings()`);
                            const currentSettings = settings.getCurrentSettings();
                            console.log(`🧪 本次选中的谱号: ${currentSettings.clef}`);
                        }, i * 1000);
                    }
                };

                // 🎵 添加紧急播放测试功能
                window.emergencyPlayTest = function() {

                    // 创建一个简单的测试音程数据
                    const testProgression = {
                        measures: [
                            {
                                index: 0,
                                lowerVoice: [
                                    { type: 'note', pitch: 'C4', duration: 1.0 }
                                ],
                                upperVoice: [
                                    { type: 'note', pitch: 'E4', duration: 1.0 }
                                ]
                            }
                        ],
                        tempo: 120,
                        timeSignature: { beats: 4, beatType: 4 },
                        keySignature: 'C'
                    };

                    window.currentIntervalProgression = testProgression;

                    try {
                        directPlayTest();
                    } catch (error) {
                        console.error('🎵🚨 播放测试失败:', error);
                    }
                };

                // 🎭 添加隐藏模式测试功能
                window.testHiddenModeWithCountIn = function() {

                    // 开启隐藏模式
                    if (!isIntervalHidden) {
                        toggleIntervalVisibility();
                    }

                    // 创建测试数据
                    const testProgression = {
                        measures: [
                            {
                                index: 0,
                                lowerVoice: [
                                    { type: 'note', pitch: 'C4', duration: 1.0 }
                                ],
                                upperVoice: [
                                    { type: 'note', pitch: 'E4', duration: 1.0 }
                                ]
                            }
                        ],
                        tempo: 120,
                        timeSignature: { beats: 4, beatType: 4 },
                        keySignature: 'C'
                    };

                    window.currentIntervalProgression = testProgression;

                    directPlayTest();
                };
            }

            // 初始化绑定系统
            initClefRangeBinding();
        });
        
        // 初始化主题
        function initializeTheme() {
            switchTheme(currentTheme);
        }
        
        // 页面加载时初始化主题
        document.addEventListener('DOMContentLoaded', function() {
            initializeTheme();
        });
    </script>

    <!-- 多语言系统 -->
    <script>
        // 多语言翻译对象
        const translations = {
            'zh-CN': {
                'app.title': 'IC Studio - 音程视奏生成器',
                'app.subtitle': '专业级乐谱渲染与音乐理论工具',
                'app.melodyMode': '旋律视奏',
                'app.intervalMode': '音程视奏',
                'app.chordMode': '和弦视奏',
                'controls.intervalType': '音程类型',
                'controls.intervalTypeSettings': '音程类型设置',
                'controls.measures': '小节数',
                'controls.measures2': '2小节',
                'controls.measures4': '4小节',
                'controls.measures8': '8小节',
                'controls.key': '调号',
                'controls.keySettings': '调号设置',
                'controls.time': '拍号',
                'controls.timeSettings': '拍号设置',
                'controls.clef': '谱号',
                'controls.clefSettings': '谱号设置',
                'modal.clefSettings': '谱号设置',
                'clef.options': '谱号选项',
                'clef.treble': '高音谱号 (G谱号)',
                'clef.bass': '低音谱号 (F谱号)',
                'clef.alto': '中音谱号 (C谱号)',
                'key.majorSection': '大调 (Major)',
                'key.minorSection': '小调 (Minor)',
                'controls.rangeMin': '最低音',
                'controls.rangeMax': '最高音',
                'controls.accidental': '临时记号',
                'controls.metronome': '节拍器',
                'controls.generateInterval': '生成音程',
                'controls.previous': '上一条',
                'controls.next': '下一条',
                'controls.rhythm': '节奏设置',
                'controls.articulation': '演奏技巧',
                'controls.play': '播放',
                'score.emptyInterval': '点击生成音程开始练习',
                'settings.title': '设置',
                'settings.theme': '主题',
                'settings.language': '语言',
                'settings.lightMode': '浅色模式',
                'settings.darkMode': '深色模式',
                'settings.metronome': '节拍器',
                'settings.tempo': '速度 (BPM)',
                'settings.startMetronome': '开始节拍器',
                'settings.stopMetronome': '停止节拍器',
                // 调号（含升降号数量）
                'key.C-major': 'C 大调 (0#)',
                'key.G-major': 'G 大调 (1#)',
                'key.D-major': 'D 大调 (2#)',
                'key.A-major': 'A 大调 (3#)',
                'key.E-major': 'E 大调 (4#)',
                'key.B-major': 'B 大调 (5#)',
                'key.Fs-major': 'F# 大调 (6#)',
                'key.F-major': 'F 大调 (1b)',
                'key.Bb-major': 'Bb 大调 (2b)',
                'key.Eb-major': 'Eb 大调 (3b)',
                'key.Ab-major': 'Ab 大调 (4b)',
                'key.Db-major': 'Db 大调 (5b)',
                'key.Gb-major': 'Gb 大调 (6b)',
                'key.a-minor': 'A 小调 (0#)',
                'key.e-minor': 'E 小调 (1#)',
                'key.b-minor': 'B 小调 (2#)',
                'key.fs-minor': 'F# 小调 (3#)',
                'key.cs-minor': 'C# 小调 (4#)',
                'key.gs-minor': 'G# 小调 (5#)',
                'key.ds-minor': 'D# 小调 (6#)',
                'key.d-minor': 'D 小调 (1b)',
                'key.g-minor': 'G 小调 (2b)',
                'key.c-minor': 'C 小调 (3b)',
                'key.f-minor': 'F 小调 (4b)',
                'key.bb-minor': 'Bb 小调 (5b)',
                'key.eb-minor': 'Eb 小调 (6b)',
                // 节奏类型
                'rhythm.whole': '全音符',
                'rhythm.dottedHalf': '附点二分音符',
                'rhythm.half': '二分音符',
                'rhythm.dottedQuarter': '附点四分音符',
                'rhythm.quarter': '四分音符',
                'rhythm.eighth': '八分音符',
                'rhythm.sixteenth': '十六分音符',
                'rhythm.triplet': '三连音',
                'rhythm.duplet': '二连音',
                'rhythm.quadruplet': '四连音',
                // 弹窗按钮
                'button.save': '保存设置',
                'button.cancel': '取消',
                'button.close': '关闭',
                'button.selectAll': '全选',
                'button.selectAllMajor': '全选',
                'button.selectAllMinor': '全选',
                'button.advanced': '高级设置',
                'button.hideAdvanced': '隐藏高级设置',
                'button.resetDefault': '返回默认',
                'rhythm.advancedFreq': '高级频率设置',
                'interval.basicTypes': '基本音程类型',
                'rhythm.basicUnits': '基本节奏单位',
                'rhythm.freq.dottedQuarter': '附点四分音符频率:',
                'rhythm.freq.quarter': '四分音符频率:',
                'rhythm.freq.eighth': '八分音符频率:',
                'rhythm.freq.sixteenth': '十六分音符频率:',
                'articulation.basic.title': '基本演奏法 (Basic Articulations)',
                'articulation.freqDesc': '调整各演奏法在旋律中的出现频率 (0% = 不使用, 100% = 经常使用)',
                'articulation.basicFreq': '基本演奏法频率',
                'rhythm.freqDesc': '调整各节奏单位在旋律中的出现频率 (0% = 不使用, 100% = 优先使用)',
                'rhythm.freq.whole': '全音符频率:',
                'rhythm.freq.dottedHalf': '附点二分音符频率:',
                'rhythm.freq.half': '二分音符频率:',
                'rhythm.freq.triplet': '三连音频率:',
                'rhythm.freq.duplet': '二连音频率:',
                // Interval types in type settings
                'intervalType.minor2nd': '小二度',
                'intervalType.major2nd': '大二度',
                'intervalType.minor3rd': '小三度',
                'intervalType.major3rd': '大三度',
                'intervalType.perfect4th': '完全四度',
                'intervalType.tritone': '增四/减五度',
                'intervalType.perfect5th': '完全五度',
                'intervalType.minor6th': '小六度',
                'intervalType.major6th': '大六度',
                'intervalType.minor7th': '小七度',
                'intervalType.major7th': '大七度',
                'intervalType.octave': '八度',
                'modal.timeSignature.title': '拍号设置',
                'timeSignature.options': '拍号选项',
                'time.2-4': '2/4 拍',
                'time.3-4': '3/4 拍',
                'time.4-4': '4/4 拍',
                'time.6-8': '6/8 拍'
            },
            'zh-TW': {
                'app.title': 'IC Studio - 音程視奏生成器',
                'app.subtitle': '專業級樂譜渲染與音樂理論工具',
                'app.melodyMode': '旋律視奏',
                'app.intervalMode': '音程視奏',
                'app.chordMode': '和弦視奏',
                'controls.intervalType': '音程類型',
                'controls.intervalTypeSettings': '音程類型設置',
                'controls.measures': '小節數',
                'controls.measures2': '2小節',
                'controls.measures4': '4小節',
                'controls.measures8': '8小節',
                'controls.key': '調號',
                'controls.keySettings': '調號設置',
                'controls.time': '拍號',
                'controls.timeSettings': '拍號設置',
                'controls.clef': '譜號',
                'controls.clefSettings': '譜號設置',
                'modal.clefSettings': '譜號設置',
                'clef.options': '譜號選項',
                'clef.treble': '高音譜號 (G譜號)',
                'clef.bass': '低音譜號 (F譜號)',
                'clef.alto': '中音譜號 (C譜號)',
                'key.majorSection': '大調 (Major)',
                'key.minorSection': '小調 (Minor)',
                'controls.rangeMin': '最低音',
                'controls.rangeMax': '最高音',
                'controls.accidental': '臨時記號',
                'controls.metronome': '節拍器',
                'controls.generateInterval': '生成音程',
                'controls.previous': '上一條',
                'controls.next': '下一條',
                'controls.rhythm': '節奏設置',
                'controls.articulation': '演奏技巧',
                'controls.play': '播放',
                'score.emptyInterval': '點擊生成音程開始練習',
                'settings.title': '設置',
                'settings.theme': '主題',
                'settings.language': '語言',
                'settings.lightMode': '淺色模式',
                'settings.darkMode': '深色模式',
                'settings.metronome': '節拍器',
                'settings.tempo': '速度 (BPM)',
                'settings.startMetronome': '開始節拍器',
                'settings.stopMetronome': '停止節拍器',
                // 調號（含升降號數量）
                'key.C-major': 'C 大調 (0#)',
                'key.G-major': 'G 大調 (1#)',
                'key.D-major': 'D 大調 (2#)',
                'key.A-major': 'A 大調 (3#)',
                'key.E-major': 'E 大調 (4#)',
                'key.B-major': 'B 大調 (5#)',
                'key.Fs-major': 'F# 大調 (6#)',
                'key.F-major': 'F 大調 (1b)',
                'key.Bb-major': 'Bb 大調 (2b)',
                'key.Eb-major': 'Eb 大調 (3b)',
                'key.Ab-major': 'Ab 大調 (4b)',
                'key.Db-major': 'Db 大調 (5b)',
                'key.Gb-major': 'Gb 大調 (6b)',
                'key.a-minor': 'A 小調 (0#)',
                'key.e-minor': 'E 小調 (1#)',
                'key.b-minor': 'B 小調 (2#)',
                'key.fs-minor': 'F# 小調 (3#)',
                'key.cs-minor': 'C# 小調 (4#)',
                'key.gs-minor': 'G# 小調 (5#)',
                'key.ds-minor': 'D# 小調 (6#)',
                'key.d-minor': 'D 小調 (1b)',
                'key.g-minor': 'G 小調 (2b)',
                'key.c-minor': 'C 小調 (3b)',
                'key.f-minor': 'F 小調 (4b)',
                'key.bb-minor': 'Bb 小調 (5b)',
                'key.eb-minor': 'Eb 小調 (6b)',
                // 節奏類型
                'rhythm.whole': '全音符',
                'rhythm.dottedHalf': '附點二分音符',
                'rhythm.half': '二分音符',
                'rhythm.dottedQuarter': '附點四分音符',
                'rhythm.quarter': '四分音符',
                'rhythm.eighth': '八分音符',
                'rhythm.sixteenth': '十六分音符',
                'rhythm.triplet': '三連音',
                'rhythm.duplet': '二連音',
                'rhythm.quadruplet': '四連音',
                // 彈窗按鈕
                'button.save': '保存設置',
                'button.cancel': '取消',
                'button.close': '關閉',
                'button.selectAll': '全選',
                'button.selectAllMajor': '全選大調',
                'button.selectAllMinor': '全選小調',
                'button.advanced': '高級設置',
                'button.hideAdvanced': '隱藏高級設置',
                'button.resetDefault': '返回默認',
                'rhythm.advancedFreq': '高級頻率設置',
                'interval.basicTypes': '基本音程類型',
                'rhythm.basicUnits': '基本節奏單位',
                'rhythm.freq.dottedQuarter': '附點四分音符頻率:',
                'rhythm.freq.quarter': '四分音符頻率:',
                'rhythm.freq.eighth': '八分音符頻率:',
                'rhythm.freq.sixteenth': '十六分音符頻率:',
                'articulation.basic.title': '基本演奏法 (Basic Articulations)',
                'articulation.freqDesc': '調整各演奏法在旋律中的出現頻率 (0% = 不使用, 100% = 經常使用)',
                'articulation.basicFreq': '基本演奏法頻率',
                'rhythm.freqDesc': '調整各節奏單位在旋律中的出現頻率 (0% = 不使用, 100% = 優先使用)',
                'rhythm.freq.whole': '全音符頻率:',
                'rhythm.freq.dottedHalf': '附點二分音符頻率:',
                'rhythm.freq.half': '二分音符頻率:',
                'rhythm.freq.triplet': '三連音頻率:',
                'rhythm.freq.duplet': '二連音頻率:',
                // Interval types in type settings
                'intervalType.minor2nd': '小二度',
                'intervalType.major2nd': '大二度',
                'intervalType.minor3rd': '小三度',
                'intervalType.major3rd': '大三度',
                'intervalType.perfect4th': '完全四度',
                'intervalType.tritone': '增四/減五度',
                'intervalType.perfect5th': '完全五度',
                'intervalType.minor6th': '小六度',
                'intervalType.major6th': '大六度',
                'intervalType.minor7th': '小七度',
                'intervalType.major7th': '大七度',
                'intervalType.octave': '八度',
                'modal.timeSignature.title': '拍號設置',
                'timeSignature.options': '拍號選項',
                'time.2-4': '2/4 拍',
                'time.3-4': '3/4 拍',
                'time.4-4': '4/4 拍',
                'time.6-8': '6/8 拍'
            },
            'en': {
                'app.title': 'IC Studio - Interval Sight-Reading Generator',
                'app.subtitle': 'Professional Music Score Rendering & Music Theory Tool',
                'app.melodyMode': 'Melody Sight-Reading',
                'app.intervalMode': 'Interval Sight-Reading',
                'app.chordMode': 'Chord Sight-Reading',
                'controls.intervalType': 'Interval Type',
                'controls.intervalTypeSettings': 'Interval Type Settings',
                'controls.measures': 'Measures',
                'controls.measures2': '2 Measures',
                'controls.measures4': '4 Measures',
                'controls.measures8': '8 Measures',
                'controls.key': 'Key Signature',
                'controls.keySettings': 'Key Settings',
                'controls.time': 'Time Signature',
                'controls.timeSettings': 'Time Settings',
                'controls.clef': 'Clef',
                'controls.clefSettings': 'Clef Settings',
                'modal.clefSettings': 'Clef Settings',
                'clef.options': 'Clef Options',
                'clef.treble': 'Treble Clef (G Clef)',
                'clef.bass': 'Bass Clef (F Clef)',
                'clef.alto': 'Alto Clef (C Clef)',
                'key.majorSection': 'Major Keys',
                'key.minorSection': 'Minor Keys',
                'controls.rangeMin': 'Lowest Note',
                'controls.rangeMax': 'Highest Note',
                'controls.accidental': 'Accidentals',
                'controls.metronome': 'Metronome',
                'controls.generateInterval': 'Generate Intervals',
                'controls.previous': 'Previous',
                'controls.next': 'Next',
                'controls.rhythm': 'Rhythm Settings',
                'controls.articulation': 'Articulations',
                'controls.play': 'Play',
                'score.emptyInterval': 'Click Generate Intervals to Start Practice',
                'settings.title': 'Settings',
                'settings.theme': 'Theme',
                'settings.language': 'Language',
                'settings.lightMode': 'Light Mode',
                'settings.darkMode': 'Dark Mode',
                'settings.metronome': 'Metronome',
                'settings.tempo': 'Tempo (BPM)',
                'settings.startMetronome': 'Start Metronome',
                'settings.stopMetronome': 'Stop Metronome',
                // Key signatures (with accidental counts)
                'key.C-major': 'C Major (0#)',
                'key.G-major': 'G Major (1#)',
                'key.D-major': 'D Major (2#)',
                'key.A-major': 'A Major (3#)',
                'key.E-major': 'E Major (4#)',
                'key.B-major': 'B Major (5#)',
                'key.Fs-major': 'F# Major (6#)',
                'key.F-major': 'F Major (1b)',
                'key.Bb-major': 'B♭ Major (2b)',
                'key.Eb-major': 'E♭ Major (3b)',
                'key.Ab-major': 'A♭ Major (4b)',
                'key.Db-major': 'D♭ Major (5b)',
                'key.Gb-major': 'G♭ Major (6b)',
                'key.a-minor': 'A Minor (0#)',
                'key.e-minor': 'E Minor (1#)',
                'key.b-minor': 'B Minor (2#)',
                'key.fs-minor': 'F# Minor (3#)',
                'key.cs-minor': 'C# Minor (4#)',
                'key.gs-minor': 'G# Minor (5#)',
                'key.ds-minor': 'D# Minor (6#)',
                'key.d-minor': 'D Minor (1b)',
                'key.g-minor': 'G Minor (2b)',
                'key.c-minor': 'C Minor (3b)',
                'key.f-minor': 'F Minor (4b)',
                'key.bb-minor': 'B♭ Minor (5b)',
                'key.eb-minor': 'E♭ Minor (6b)',
                // Rhythm types
                'rhythm.whole': 'Whole Note',
                'rhythm.dottedHalf': 'Dotted Half Note',
                'rhythm.half': 'Half Note',
                'rhythm.dottedQuarter': 'Dotted Quarter Note',
                'rhythm.quarter': 'Quarter Note',
                'rhythm.eighth': 'Eighth Note',
                'rhythm.sixteenth': 'Sixteenth Note',
                'rhythm.triplet': 'Triplet',
                'rhythm.duplet': 'Duplet',
                'rhythm.quadruplet': 'Quadruplet',
                // Modal buttons
                'button.save': 'Save Settings',
                'button.cancel': 'Cancel',
                'button.close': 'Close',
                'button.selectAll': 'Select All',
                'button.selectAllMajor': 'Select All Major',
                'button.selectAllMinor': 'Select All Minor',
                'button.advanced': 'Advanced Settings',
                'button.hideAdvanced': 'Hide Advanced Settings',
                'button.resetDefault': 'Reset to Default',
                'rhythm.advancedFreq': 'Advanced Frequency Settings',
                'interval.basicTypes': 'Basic Interval Types',
                'rhythm.basicUnits': 'Basic Rhythm Units',
                'rhythm.freq.dottedQuarter': 'Dotted Quarter Note Frequency:',
                'rhythm.freq.quarter': 'Quarter Note Frequency:',
                'rhythm.freq.eighth': 'Eighth Note Frequency:',
                'rhythm.freq.sixteenth': 'Sixteenth Note Frequency:',
                'articulation.basic.title': 'Basic Articulations',
                'articulation.freqDesc': 'Adjust frequency of each articulation in melody (0% = not used, 100% = frequently used)',
                'articulation.basicFreq': 'Basic Articulation Frequency',
                'rhythm.freqDesc': 'Adjust frequency of each rhythm unit in melody (0% = not used, 100% = prioritized)',
                'rhythm.freq.whole': 'Whole Note Frequency:',
                'rhythm.freq.dottedHalf': 'Dotted Half Note Frequency:',
                'rhythm.freq.half': 'Half Note Frequency:',
                'rhythm.freq.triplet': 'Triplet Frequency:',
                'rhythm.freq.duplet': 'Duplet Frequency:',
                // Interval types in type settings
                'intervalType.minor2nd': 'Minor 2nd',
                'intervalType.major2nd': 'Major 2nd',
                'intervalType.minor3rd': 'Minor 3rd',
                'intervalType.major3rd': 'Major 3rd',
                'intervalType.perfect4th': 'Perfect 4th',
                'intervalType.tritone': 'Tritone (Aug 4th/Dim 5th)',
                'intervalType.perfect5th': 'Perfect 5th',
                'intervalType.minor6th': 'Minor 6th',
                'intervalType.major6th': 'Major 6th',
                'intervalType.minor7th': 'Minor 7th',
                'intervalType.major7th': 'Major 7th',
                'intervalType.octave': 'Octave',
                'modal.timeSignature.title': 'Time Signature Settings',
                'timeSignature.options': 'Time Signature Options',
                'time.2-4': '2/4 Time',
                'time.3-4': '3/4 Time',
                'time.4-4': '4/4 Time',
                'time.6-8': '6/8 Time'
            }
        };

        // 语言切换相关变量
        let currentLanguage = localStorage.getItem('preferredLanguage') || 'zh-CN';
        
        // 语言按钮显示文本
        const languageLabels = {
            'zh-CN': '🌐 简体中文',
            'zh-TW': '🌐 繁體中文',
            'en': '🌐 English'
        };

        // 切换语言
        function switchLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('preferredLanguage', lang);

            // 更新按钮文本 (如果存在旧的语言按钮)
            const languageBtn = document.getElementById('languageBtn');
            if (languageBtn) {
                languageBtn.textContent = languageLabels[lang];
            }

            // 应用翻译
            applyTranslations();

            // 触发统一同步系统 (同标签页内实时同步)
            if (window.ICStudioSync) {
                window.ICStudioSync.syncLanguage(lang, 'interval-tool');
            }

            // 关闭设置菜单
            closeSettings();
            
            console.log(`🌐 语言已切换到: ${lang}`);
        }

        // 应用翻译
        function applyTranslations() {
            const elements = document.querySelectorAll('[data-i18n]');
            const currentTranslations = translations[currentLanguage] || translations['zh-CN'];

            elements.forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (currentTranslations[key]) {
                    // 检查元素是否只包含文本内容（没有子元素）
                    if (element.children.length === 0) {
                        // 只有文本内容，直接替换
                        element.textContent = currentTranslations[key];
                    } else {
                        // 有子元素，需要保留结构，只替换文本节点
                        // 先保存当前的HTML结构
                        const originalHTML = element.innerHTML;
                        // 查找文本节点并替换
                        const textNodes = [];
                        const walker = document.createTreeWalker(
                            element,
                            NodeFilter.SHOW_TEXT,
                            null,
                            false
                        );
                        let node;
                        while (node = walker.nextNode()) {
                            if (node.nodeValue.trim()) {
                                textNodes.push(node);
                            }
                        }

                        // 如果只有一个主要文本节点，替换它
                        if (textNodes.length === 1) {
                            textNodes[0].nodeValue = currentTranslations[key];
                        } else {
                            // 复杂结构，使用textContent作为后备
                            element.textContent = currentTranslations[key];
                        }
                    }
                }
            });
        }

        // 页面加载时初始化语言
        document.addEventListener('DOMContentLoaded', function() {
            // 检查是否有保存的语言偏好
            const savedLanguage = localStorage.getItem('preferredLanguage');

            if (savedLanguage) {
                // 如果有保存的语言偏好，设置当前语言并显示对应语言名称
                currentLanguage = savedLanguage;
                const languageBtn = document.getElementById('languageBtn');
                if (languageBtn) {
                    languageBtn.textContent = languageLabels[currentLanguage];
                }
                console.log(`💾 使用保存的语言: ${savedLanguage}`);
            } else {
                // 如果没有保存的语言偏好，自动检测浏览器语言
                const browserLang = navigator.language || navigator.userLanguage;
                // 检测是否为中文环境（支持 zh, zh-CN, zh-TW, zh-HK）
                const isChinese = browserLang && browserLang.toLowerCase().startsWith('zh');
                currentLanguage = isChinese ? 'zh-CN' : 'en';
                const languageBtn = document.getElementById('languageBtn');
                if (languageBtn) {
                    languageBtn.textContent = '🌐 文/A';
                }
                console.log(`🌍 浏览器语言检测: ${browserLang} → ${currentLanguage}`);
            }

            // 应用翻译
            applyTranslations();

            console.log(`🌐 音程工具初始化语言: ${currentLanguage}`);

            // ============ 跨工具同步监听机制 ============
            // 监听其他工具对localStorage的修改
            window.addEventListener('storage', function(e) {
                if (e.key === 'preferredTheme' && e.newValue !== currentTheme) {
                    console.log(`🔄 音程视奏工具检测到主题变化: ${currentTheme} → ${e.newValue}`);
                    currentTheme = e.newValue;
                    document.documentElement.setAttribute('data-theme', currentTheme);
                }

                if (e.key === 'preferredLanguage' && e.newValue !== currentLanguage) {
                    console.log(`🔄 音程视奏工具检测到语言变化: ${currentLanguage} → ${e.newValue}`);
                    currentLanguage = e.newValue;
                    applyTranslations();
                    console.log(`🌐 音程视奏工具语言已同步为: ${currentLanguage}`);
                }
            });

            console.log('🔗 音程视奏工具localStorage跨工具同步监听已启用');

            // ============ 统一同步系统 ============
            // 创建全局同步函数，支持同标签页内实时同步
            window.ICStudioSync = window.ICStudioSync || {
                tools: new Set(),

                // 注册工具
                registerTool: function(toolName, callbacks) {
                    this.tools.add({
                        name: toolName,
                        onThemeChange: callbacks.onThemeChange,
                        onLanguageChange: callbacks.onLanguageChange
                    });
                    console.log(`🔗 ${toolName} 已注册到统一同步系统`);
                },

                // 同步主题到所有工具
                syncTheme: function(newTheme, fromTool) {
                    console.log(`🔄 统一同步系统: 同步主题 ${newTheme} (来源: ${fromTool})`);
                    this.tools.forEach(tool => {
                        if (tool.name !== fromTool && tool.onThemeChange) {
                            try {
                                tool.onThemeChange(newTheme);
                            } catch (error) {
                                console.warn(`⚠️ ${tool.name} 主题同步失败:`, error);
                            }
                        }
                    });
                },

                // 同步语言到所有工具
                syncLanguage: function(newLanguage, fromTool) {
                    console.log(`🔄 统一同步系统: 同步语言 ${newLanguage} (来源: ${fromTool})`);
                    this.tools.forEach(tool => {
                        if (tool.name !== fromTool && tool.onLanguageChange) {
                            try {
                                tool.onLanguageChange(newLanguage);
                            } catch (error) {
                                console.warn(`⚠️ ${tool.name} 语言同步失败:`, error);
                            }
                        }
                    });
                }
            };

            // 注册音程工具到统一同步系统
            window.ICStudioSync.registerTool('interval-tool', {
                onThemeChange: function(newTheme) {
                    if (currentTheme !== newTheme) {
                        currentTheme = newTheme;
                        document.documentElement.setAttribute('data-theme', currentTheme);
                    }
                },
                onLanguageChange: function(newLanguage) {
                    if (currentLanguage !== newLanguage) {
                        console.log(`🌐 音程工具接收语言同步: ${currentLanguage} → ${newLanguage}`);
                        currentLanguage = newLanguage;
                        applyTranslations();
                    }
                }
            });
        });
    </script>

    <script>
        // 弹窗控制函数
        
        // 节奏设置弹窗
        function openRhythmSettings() {
            document.getElementById('rhythmModal').style.display = 'flex';
        }
        
        function closeRhythmSettings() {
            document.getElementById('rhythmModal').style.display = 'none';
        }
        
        function selectAllRhythms() {
            // 🔥 Fix C: 只选择可见的checkbox，避免勾选隐藏的附点音符选项
            const checkboxes = document.querySelectorAll('#rhythmModal input[type="checkbox"]');

            // 过滤出可见的checkbox
            const visibleCheckboxes = Array.from(checkboxes).filter(cb => {
                const label = cb.closest('.checkbox-item') || cb.closest('label');
                if (!label) return true; // 如果没有父label，默认认为可见
                const styles = window.getComputedStyle(label);
                return styles.display !== 'none' && styles.visibility !== 'hidden';
            });

            const allChecked = visibleCheckboxes.every(cb => cb.checked);

            visibleCheckboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
            });

            console.log(`🔧 全选节奏：${visibleCheckboxes.length}个可见选项，${allChecked ? '取消全选' : '全部选中'}`);
        }
        
        function saveRhythmSettings() {
            // 🎯 收集所有节奏设置和频率设置
            const rhythmSettings = {};
            const frequencySettings = {};

            // 收集基本节奏复选框设置
            const rhythmCheckboxes = document.querySelectorAll('#rhythmModal input[type="checkbox"]');
            rhythmCheckboxes.forEach(checkbox => {
                if (checkbox.id && checkbox.id.startsWith('rhythm-')) {
                    rhythmSettings[checkbox.id] = checkbox.checked;
                }
            });

            // 收集频率滑块设置
            const frequencySliders = document.querySelectorAll('input[type="range"][id^="freq-"]');
            frequencySliders.forEach(slider => {
                frequencySettings[slider.id] = parseInt(slider.value);
            });

            console.log('✅ 节奏设置已保存');

            closeRhythmSettings();
        }
        
        function toggleRhythmAdvancedSettings() {
            const advancedSection = document.getElementById('rhythmAdvancedSettings');
            const button = document.getElementById('rhythmAdvancedBtn');

            if (advancedSection.style.display === 'none' || !advancedSection.style.display) {
                advancedSection.style.display = 'block';
                button.textContent = translations[currentLanguage]['button.hideAdvanced'] || '隐藏高级设置';
            } else {
                advancedSection.style.display = 'none';
                button.textContent = translations[currentLanguage]['button.advanced'] || '高级设置';
            }
        }
        
        function resetRhythmFrequencies() {
            // 重置所有频率滑块到默认值
            const frequencies = {
                'freq-whole': 10,
                'freq-dotted-half': 15,
                'freq-half': 30,
                'freq-dotted-quarter': 35,
                'freq-quarter': 50,
                'freq-eighth': 40,
                'freq-16th': 20,
                'freq-triplet': 15,
                'freq-duplet': 30,
                'freq-quadruplet': 25
            };
            
            for (const [id, defaultValue] of Object.entries(frequencies)) {
                const slider = document.getElementById(id);
                const valueSpan = document.getElementById(id + '-value');
                
                if (slider && valueSpan) {
                    slider.value = defaultValue;
                    valueSpan.textContent = defaultValue + '%';
                }
            }
        }
        
        // Articulations设置弹窗
        function openArticulationSettings() {
            document.getElementById('articulationModal').style.display = 'flex';
        }
        
        function closeArticulationSettings() {
            document.getElementById('articulationModal').style.display = 'none';
        }
        
        function selectAllBasicArticulations() {
            const checkboxes = document.querySelectorAll('#articulationModal .rhythm-section:first-of-type input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
            });
        }
        
        function selectAllGuitarTechniques() {
            const checkboxes = document.querySelectorAll('#articulationModal .rhythm-section:nth-of-type(2) input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
            });
        }
        
        function saveArticulationSettings() {
            console.log('保存演奏技巧设置');
            closeArticulationSettings();
        }
        
        function toggleArticulationAdvancedSettings() {
            const advancedSection = document.getElementById('articulationAdvancedSettings');
            const button = document.getElementById('articulationAdvancedBtn');

            if (advancedSection.style.display === 'none' || !advancedSection.style.display) {
                advancedSection.style.display = 'block';
                button.textContent = translations[currentLanguage]['button.hideAdvanced'] || '隐藏高级设置';
            } else {
                advancedSection.style.display = 'none';
                button.textContent = translations[currentLanguage]['button.advanced'] || '高级设置';
            }
        }
        
        function resetArticulationFrequencies() {
            // 重置所有演奏法频率到默认值
            const frequencies = {
                'freq-staccato': 20,
                'freq-accent': 15,
                'freq-acciaccatura': 10,
                'freq-slur': 15
            };
            
            for (const [id, defaultValue] of Object.entries(frequencies)) {
                const slider = document.getElementById(id);
                const valueSpan = document.getElementById(id + '-value');
                
                if (slider && valueSpan) {
                    slider.value = defaultValue;
                    valueSpan.textContent = defaultValue + '%';
                }
            }
        }
        
        // 调号设置弹窗
        function openKeySettings() {
            document.getElementById('keySignatureModal').style.display = 'flex';
        }
        
        function closeKeySettings() {
            document.getElementById('keySignatureModal').style.display = 'none';
        }
        
        function selectAllMajorKeys() {
            const checkboxes = document.querySelectorAll('#keySignatureModal .rhythm-section:first-of-type input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
            });
        }
        
        function selectAllMinorKeys() {
            const checkboxes = document.querySelectorAll('#keySignatureModal .rhythm-section:nth-of-type(2) input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
            });
        }
        
        function saveKeySettings() {
            console.log('保存调号设置');
            closeKeySettings();
        }
        
        // 拍号设置弹窗
        function openTimeSignatureSettings() {
            document.getElementById('timeSignatureModal').style.display = 'flex';
        }
        
        function closeTimeSignatureSettings() {
            document.getElementById('timeSignatureModal').style.display = 'none';
        }
        
        function selectAllTimeSignatures() {
            const checkboxes = document.querySelectorAll('#timeSignatureModal input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
            });
        }
        
        function saveTimeSignatureSettings() {
            console.log('保存拍号设置');
            updateRhythmVisibilityForTimeSignature();
            closeTimeSignatureSettings();
        }

        // 🎯 根据拍号动态控制节奏选项可见性
        function updateRhythmVisibilityForTimeSignature() {

            // 获取选中的拍号
            const timeSignatureCheckboxes = document.querySelectorAll('#timeSignatureModal input[type="checkbox"]:checked');
            const selectedTimeSignatures = Array.from(timeSignatureCheckboxes).map(cb => cb.value);


            // 检查选择的拍号集合
            const has68TimeSignature = selectedTimeSignatures.includes('6/8');
            const hasSimpleTimeSignature = selectedTimeSignatures.some(v => ['2/4','3/4','4/4'].includes(v));

            // 节奏选项元素
            const rhythmWholeLabel = document.getElementById('rhythm-whole-label');
            const rhythmHalfLabel = document.getElementById('rhythm-half-label');
            const rhythmDottedHalfLabel = document.getElementById('rhythm-dotted-half-label');
            const rhythmDottedQuarterLabel = document.getElementById('rhythm-dotted-quarter-label');
            const rhythmTripletLabel = document.getElementById('rhythm-triplet-label');
            const rhythmDupletLabel = document.getElementById('rhythm-duplet-label');
            const rhythmQuadrupletLabel = document.getElementById('rhythm-quadruplet-label');

            // 对应的频率控制元素
            const freqWholeItem = document.getElementById('freq-whole-item');
            const freqHalfItem = document.getElementById('freq-half-item');
            const freqDottedHalfItem = document.getElementById('freq-dotted-half-item');
            const freqDottedQuarterItem = document.getElementById('freq-dotted-quarter-item');
            const freqTripletItem = document.getElementById('freq-triplet-item');
            const freqDupletItem = document.getElementById('freq-duplet-item');
            const freqQuadrupletItem = document.getElementById('freq-quadruplet-item');

            if (has68TimeSignature && hasSimpleTimeSignature) {

                // 简单拍：显示全音符/二分音符 + 三连音
                if (rhythmWholeLabel) rhythmWholeLabel.style.display = 'block';
                if (rhythmHalfLabel) rhythmHalfLabel.style.display = 'block';
                if (freqWholeItem) freqWholeItem.style.display = 'block';
                if (freqHalfItem) freqHalfItem.style.display = 'block';
                if (rhythmTripletLabel) rhythmTripletLabel.style.display = 'flex';
                if (freqTripletItem) freqTripletItem.style.display = 'block';

                // 6/8：显示附点节奏 + 二连音/四连音
                if (rhythmDottedHalfLabel) rhythmDottedHalfLabel.style.display = 'block';
                if (rhythmDottedQuarterLabel) rhythmDottedQuarterLabel.style.display = 'block';
                if (freqDottedHalfItem) freqDottedHalfItem.style.display = 'block';
                if (freqDottedQuarterItem) freqDottedQuarterItem.style.display = 'block';
                if (rhythmDupletLabel) rhythmDupletLabel.style.display = 'flex';
                if (rhythmQuadrupletLabel) rhythmQuadrupletLabel.style.display = 'flex';
                if (freqDupletItem) freqDupletItem.style.display = 'block';
                if (freqQuadrupletItem) freqQuadrupletItem.style.display = 'block';

                // 🆕 当包含6/8时，默认勾选八分音符与附点四分音符，确保复合拍核心节奏就绪
                const eighthCheckbox = document.getElementById('rhythm-eighth');
                const dottedQuarterCheckbox = document.getElementById('rhythm-dotted-quarter');
                if (eighthCheckbox && !eighthCheckbox.checked) {
                    eighthCheckbox.checked = true;
                    console.log('✅ 6/8已被勾选（与简单拍并存）→ 自动勾选：八分音符');
                }
                if (dottedQuarterCheckbox && !dottedQuarterCheckbox.checked) {
                    dottedQuarterCheckbox.checked = true;
                    console.log('✅ 6/8已被勾选（与简单拍并存）→ 自动勾选：附点四分音符');
                }

            } else if (has68TimeSignature) {

                // 隐藏全音符/二分音符
                if (rhythmWholeLabel) rhythmWholeLabel.style.display = 'none';
                if (rhythmHalfLabel) rhythmHalfLabel.style.display = 'none';
                if (freqWholeItem) freqWholeItem.style.display = 'none';
                if (freqHalfItem) freqHalfItem.style.display = 'none';

                // 显示附点节奏 + 二连音/四连音
                if (rhythmDottedHalfLabel) rhythmDottedHalfLabel.style.display = 'block';
                if (rhythmDottedQuarterLabel) rhythmDottedQuarterLabel.style.display = 'block';
                if (freqDottedHalfItem) freqDottedHalfItem.style.display = 'block';
                if (freqDottedQuarterItem) freqDottedQuarterItem.style.display = 'block';
                if (rhythmDupletLabel) rhythmDupletLabel.style.display = 'flex';
                if (rhythmQuadrupletLabel) rhythmQuadrupletLabel.style.display = 'flex';
                if (freqDupletItem) freqDupletItem.style.display = 'block';
                if (freqQuadrupletItem) freqQuadrupletItem.style.display = 'block';

                // 禁用三连音
                if (rhythmTripletLabel) rhythmTripletLabel.style.display = 'none';
                if (freqTripletItem) freqTripletItem.style.display = 'none';

                // 🆕 6/8拍自动勾选核心节奏类型
                const eighthCheckbox = document.getElementById('rhythm-eighth');
                const dottedQuarterCheckbox = document.getElementById('rhythm-dotted-quarter');
                if (eighthCheckbox && !eighthCheckbox.checked) {
                    eighthCheckbox.checked = true;
                    console.log('✅ 6/8拍自动勾选：八分音符');
                }
                if (dottedQuarterCheckbox && !dottedQuarterCheckbox.checked) {
                    dottedQuarterCheckbox.checked = true;
                    console.log('✅ 6/8拍自动勾选：附点四分音符');
                }

            } else {

                // 显示全音符/二分音符 + 三连音
                if (rhythmWholeLabel) rhythmWholeLabel.style.display = 'block';
                if (rhythmHalfLabel) rhythmHalfLabel.style.display = 'block';
                if (freqWholeItem) freqWholeItem.style.display = 'block';
                if (freqHalfItem) freqHalfItem.style.display = 'block';
                if (rhythmTripletLabel) rhythmTripletLabel.style.display = 'flex';
                if (freqTripletItem) freqTripletItem.style.display = 'block';

                // 隐藏6/8专属
                if (rhythmDottedHalfLabel) rhythmDottedHalfLabel.style.display = 'none';
                if (rhythmDottedQuarterLabel) rhythmDottedQuarterLabel.style.display = 'none';
                if (freqDottedHalfItem) freqDottedHalfItem.style.display = 'none';
                if (freqDottedQuarterItem) freqDottedQuarterItem.style.display = 'none';
                if (rhythmDupletLabel) rhythmDupletLabel.style.display = 'none';
                if (rhythmQuadrupletLabel) rhythmQuadrupletLabel.style.display = 'none';
                if (freqDupletItem) freqDupletItem.style.display = 'none';
                if (freqQuadrupletItem) freqQuadrupletItem.style.display = 'none';
            }
        }
        
        // 音程跨度设置弹窗
        function openIntervalSettings() {
            document.getElementById('intervalModal').style.display = 'flex';
        }
        
        function closeIntervalSettings() {
            document.getElementById('intervalModal').style.display = 'none';
        }
        
        function handleIntervalCheckboxChange(changedCheckbox) {
            // 取消选中其他复选框，确保只有一个被选中
            const checkboxes = document.querySelectorAll('#intervalModal input[type="checkbox"]');
            
            checkboxes.forEach(checkbox => {
                if (checkbox !== changedCheckbox) {
                    checkbox.checked = false;
                }
            });
        }
        
        function saveIntervalSettings() {
            console.log('保存音程跨度设置');
            closeIntervalSettings();
        }
        
        // 谱号设置弹窗
        function openClefSettings() {
            document.getElementById('clefModal').style.display = 'flex';

            // 🎼 在模态框显示后立即添加事件监听器
            setTimeout(() => {
                if (typeof window.addClefChangeListeners === 'function') {
                    window.addClefChangeListeners();
                } else {
                    // 如果全局函数不存在，直接在这里添加监听器
                    const clefCheckboxes = document.querySelectorAll('#clefModal input[type="checkbox"]');

                    clefCheckboxes.forEach(checkbox => {
                        // 移除可能存在的旧监听器
                        checkbox.removeEventListener('change', window.clefChangeHandler);

                        // 添加新的监听器
                        window.clefChangeHandler = function() {

                            // 如果有唯一选中的谱号，立即切换到该谱号的默认音域
                            const checkedClefs = Array.from(clefCheckboxes).filter(cb => cb.checked);

                            if (checkedClefs.length === 1) {
                                const selectedClef = checkedClefs[0].value;

                if (window.intervalSettings && typeof window.intervalSettings.setActiveClef === 'function') {
                    window.intervalSettings.setActiveClef(selectedClef);
                } else if (typeof window.switchToClefRange === 'function') {
                    window.switchToClefRange(selectedClef);
                }
                            } else if (checkedClefs.length > 1) {
                                // 多谱号：将“当前活动谱号”设置为用户最后点击的这个谱号
                                if (this.checked) {
                                    window.currentActiveClef = this.value;
                                    if (typeof window.setRangeForClef === 'function') {
                                        window.setRangeForClef(window.currentActiveClef);
                                    }
                                } else {
                                }
                            } else {
                            }
                        };

                        checkbox.addEventListener('change', window.clefChangeHandler);
                    });
                }
            }, 100); // 等待模态框完全显示
        }
        
        function closeClefSettings() {
            document.getElementById('clefModal').style.display = 'none';
        }
        
        function selectAllClefs() {
            const checkboxes = document.querySelectorAll('#clefModal input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
            });
        }
        
        function saveClefSettings() {
            console.log('保存谱号设置');
            closeClefSettings();
        }
        
        // 音程类型设置
        function openIntervalTypeSettings() {
            document.getElementById('intervalTypeModal').style.display = 'flex';
        }
        
        function closeIntervalTypeSettings() {
            document.getElementById('intervalTypeModal').style.display = 'none';
        }
        
        function selectAllIntervalTypes() {
            const checkboxes = document.querySelectorAll('#intervalTypeModal input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
            });
        }
        
        function saveIntervalTypeSettings() {
            console.log('保存音程类型设置');
            closeIntervalTypeSettings();
        }
        
        // === 音程生成器整合模块 ===
        // 初始化音程生成器实例
        let intervalSettings, intervalGenerator, intervalRenderer;
        
        // 页面加载后初始化所有音程生成器模块
        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log('开始初始化音程生成器模块...');

                console.log('初始化IntervalSettings...');
                intervalSettings = new IntervalSettings();
                window.intervalSettings = intervalSettings; // 统一引用
                console.log('IntervalSettings初始化成功:', !!intervalSettings);

                console.log('初始化IntervalGenerator...');
                intervalGenerator = new IntervalGenerator();
                console.log('IntervalGenerator初始化成功:', !!intervalGenerator);

                console.log('初始化IntervalRenderer...');
                intervalRenderer = new IntervalRenderer();
                console.log('IntervalRenderer初始化成功:', !!intervalRenderer);

                // 初始化导航按钮状态
                updateNavigationButtons();

                // 🎯 初始化节奏可见性（基于默认拍号设置）
                updateRhythmVisibilityForTimeSignature();

            } catch (initError) {
                console.error('❌ 音程生成器模块初始化失败:', initError);
                console.error('错误详情:', initError.stack);

                // 尝试部分初始化
                try {
                    if (!intervalSettings) {
                        intervalSettings = new IntervalSettings();
                        window.intervalSettings = intervalSettings; // 统一引用
                        console.log('补救：IntervalSettings初始化成功');
                    }
                } catch (settingsError) {
                    console.error('IntervalSettings初始化失败:', settingsError);
                }

                try {
                    if (!intervalGenerator) {
                        intervalGenerator = new IntervalGenerator();
                        console.log('补救：IntervalGenerator初始化成功');
                    }
                } catch (generatorError) {
                    console.error('IntervalGenerator初始化失败:', generatorError);
                }

                try {
                    if (!intervalRenderer) {
                        intervalRenderer = new IntervalRenderer();
                        console.log('补救：IntervalRenderer初始化成功');
                    }
                } catch (rendererError) {
                    console.error('IntervalRenderer初始化失败:', rendererError);
                }
            }
        });
        
        // 延迟初始化函数 - 备用机制
        function ensureModulesInitialized() {
            console.log('🔄 执行延迟初始化检查...');

            if (!intervalSettings) {
                try {
                    intervalSettings = new IntervalSettings();
                    window.intervalSettings = intervalSettings; // 统一引用
                } catch (error) {
                    console.error('❌ IntervalSettings延迟初始化失败:', error);
                }
            }

            if (!intervalGenerator) {
                try {
                    intervalGenerator = new IntervalGenerator();
                } catch (error) {
                    console.error('❌ IntervalGenerator延迟初始化失败:', error);
                }
            }

            if (!intervalRenderer) {
                try {
                    intervalRenderer = new IntervalRenderer();
                } catch (error) {
                    console.error('❌ IntervalRenderer延迟初始化失败:', error);
                }
            }
        }

        // 主音程生成函数 - 调用独立模块
        async function generateIntervals() {

            // 🎵 自动暂停当前播放
            if (window.isPlayingInterval) {
                directPlayTest(); // 调用播放函数来切换状态（停止播放）
            }

            try {
                // 🔧 首先尝试延迟初始化（备用机制）
                ensureModulesInitialized();

                // 🔍 检查必要的模块是否已初始化

                if (!intervalSettings) {
                    throw new Error('intervalSettings 模块未初始化');
                }
                if (!intervalGenerator) {
                    throw new Error('intervalGenerator 模块未初始化');
                }
                if (!intervalRenderer) {
                    throw new Error('intervalRenderer 模块未初始化');
                }

                // 获取当前设置参数
                const settings = intervalSettings.getCurrentSettings();

                // 验证设置
                const validation = intervalSettings.validateSettings(settings);

                if (!validation.isValid) {
                    console.error('❌ 设置验证失败:', validation.errors);
                    alert('设置错误: ' + validation.errors.join(', '));
                    return;
                }

                console.log('📊 设置摘要:', intervalSettings.getSettingsSummary(settings));

                // 生成音程进行
                const intervalProgression = intervalGenerator.generateIntervalProgression(settings);

                // 🎵 立即保存当前音程进行数据供播放功能使用
                window.currentIntervalProgression = intervalProgression;

                // 🎯 验证播放数据完整性
                if (intervalProgression?.measures) {
                    intervalProgression.measures.forEach((measure, index) => {
                    });
                } else {
                    console.warn('⚠️ 生成的音程进行数据结构异常');
                }

                // 保存到历史记录
                saveToHistory(intervalProgression, settings);

                // 🎵 使用V4.0渲染器

                try {
                    // 🎨 开始渲染过程

                    // 检查V4.0渲染器是否可用
                    console.log('renderIntervalProgression方法:', typeof window.intervalRenderer?.renderIntervalProgression);

                    if (window.intervalRenderer && typeof window.intervalRenderer.renderIntervalProgression === 'function') {

                        // 使用V4.0渲染器渲染音程进行
                        if (isIntervalHidden){ const scoreEl=document.getElementById('score'); if(scoreEl){ scoreEl.style.opacity='0'; scoreEl.style.filter='blur(10px)'; }}
                        await window.intervalRenderer.renderIntervalProgression(intervalProgression);

                        // 🎭 检查隐藏状态，如果开启隐藏功能则隐藏新生成的音程
                        if (isIntervalHidden) {
                            console.log('👂 隐藏功能已开启，隐藏新生成的音程');
                            applyIntervalHiddenState();
                        }
                    } else {
                        console.error('❌ V4.0渲染器不可用');
                        console.error('渲染器调试信息:');
                        console.error('- window.intervalRenderer:', window.intervalRenderer);
                        console.error('- 类型:', typeof window.intervalRenderer);
                        console.error('- renderIntervalProgression方法:', window.intervalRenderer?.renderIntervalProgression);
                        throw new Error('V4.0渲染器不可用');
                    }
                } catch (renderError) {
                    console.error('❌ V4.0渲染器失败:', renderError);
                    console.error('渲染错误详情:', renderError.stack);
                    console.error('渲染器状态:', {
                        intervalRenderer: window.intervalRenderer,
                        renderMethod: window.intervalRenderer?.renderIntervalProgression,
                        progression: intervalProgression
                    });
                    throw new Error(`V4.0渲染系统失败: ${renderError.message}`);
                }
                
            } catch (error) {
                console.error('❌ 音程生成错误:', error);
                console.error('❌ 错误详情:', error.stack);

                // 提供更详细的错误信息
                let errorMessage = '音程生成失败';
                if (error.message.includes('模块未初始化')) {
                    errorMessage = '系统模块初始化失败，请刷新页面重试';
                } else if (error.message.includes('设置')) {
                    errorMessage = '设置参数有误: ' + error.message;
                } else if (error.message.includes('渲染')) {
                    errorMessage = '乐谱渲染失败: ' + error.message;
                } else if (error.message.includes('OpenSheetMusicDisplay')) {
                    errorMessage = '乐谱显示组件加载失败，请检查网络连接';
                } else {
                    errorMessage = `生成失败: ${error.message}`;
                }

                alert(errorMessage + '\n\n详细信息请查看浏览器控制台');
            }
        }
        
        // 保存音程到历史记录
        function saveToHistory(intervalProgression, settings) {
            // 从当前位置开始截断历史记录（删除之后的记录）
            intervalHistory = intervalHistory.slice(0, currentIntervalIndex + 1);
            
            // 添加新记录
            intervalHistory.push({
                progression: intervalProgression,
                settings: settings,
                timestamp: Date.now()
            });
            
            // 限制历史记录大小
            if (intervalHistory.length > MAX_HISTORY_SIZE) {
                intervalHistory.shift();
            } else {
                currentIntervalIndex++;
            }
            
            // 更新按钮状态
            updateNavigationButtons();
            
            console.log(`💾 保存音程到历史记录，当前索引: ${currentIntervalIndex}, 历史长度: ${intervalHistory.length}`);
        }
        
        // 更新导航按钮状态
        function updateNavigationButtons() {
            const prevBtn = document.querySelector('button[onclick="previousInterval()"]');
            const nextBtn = document.querySelector('button[onclick="nextInterval()"]');

            if (prevBtn) {
                prevBtn.disabled = currentIntervalIndex <= 0;
                // 🎨 移除变淡效果：按钮保持正常外观
                prevBtn.style.opacity = '1';
            }

            if (nextBtn) {
                nextBtn.disabled = currentIntervalIndex >= intervalHistory.length - 1;
                // 🎨 移除变淡效果：按钮保持正常外观
                nextBtn.style.opacity = '1';
            }
        }
        
        // 渲染指定的音程进行
        async function renderIntervalProgression(intervalProgression) {
            try {
                // 🎵 保存当前音程进行数据供播放功能使用
                window.currentIntervalProgression = intervalProgression;

                // 🎯 验证播放数据完整性
                if (intervalProgression?.measures) {
                    intervalProgression.measures.forEach((measure, index) => {
                        measure.lowerVoice.forEach((note, noteIndex) => {
                            if (note.type === 'note') {
                                console.log(`  音符${noteIndex + 1}: pitch="${note.pitch}", duration=${note.duration}, type=${note.type}`);
                            }
                        });
                    });
                }

                // 🎯 使用V4.0渲染器
                if (window.intervalRenderer && typeof window.intervalRenderer.renderIntervalProgression === 'function') {

                    // 使用V4.0渲染器渲染音程进行
                    await window.intervalRenderer.renderIntervalProgression(intervalProgression);
                } else {
                    console.log('❌ V4.0渲染器不可用');
                    throw new Error('V4.0渲染器不可用');
                }
            } catch (renderError) {
                console.warn('V4.0渲染器失败:', renderError);
                alert('音程渲染失败，请重试');
            }
        }
        
        function previousInterval() {
            if (currentIntervalIndex > 0) {
                currentIntervalIndex--;
                const historyItem = intervalHistory[currentIntervalIndex];

                console.log(`⬅️ 显示上一条音程，索引: ${currentIntervalIndex}`);

                // 🎵 更新播放数据
                window.currentIntervalProgression = historyItem.progression;

                // 渲染历史中的音程进行
                renderIntervalProgression(historyItem.progression);

                // 更新按钮状态
                updateNavigationButtons();
            } else {
                console.log('⚠️ 已经是第一条音程');
            }
        }
        
        function nextInterval() {
            if (currentIntervalIndex < intervalHistory.length - 1) {
                currentIntervalIndex++;
                const historyItem = intervalHistory[currentIntervalIndex];

                console.log(`➡️ 显示下一条音程，索引: ${currentIntervalIndex}`);

                // 🎵 更新播放数据
                window.currentIntervalProgression = historyItem.progression;

                // 渲染历史中的音程进行
                renderIntervalProgression(historyItem.progression);

                // 更新按钮状态
                updateNavigationButtons();
            } else {
                console.log('⚠️ 已经是最后一条音程');
            }
        }
        
        // 频率滑块事件监听器（增强版：自动同步勾选框）
        document.addEventListener('DOMContentLoaded', function() {
            // 监听所有频率滑块变化
            const frequencySliders = document.querySelectorAll('input[type="range"][id^="freq-"]');

            frequencySliders.forEach(slider => {
                const valueSpan = document.getElementById(slider.id + '-value');

                if (valueSpan) {
                    slider.addEventListener('input', function() {
                        const frequency = parseInt(this.value);
                        valueSpan.textContent = frequency + '%';

                        // 🔥 自动同步复选框：0%取消勾选，>0%自动勾选
                        const rhythmType = slider.id.replace('freq-', '');
                        const checkbox = document.getElementById('rhythm-' + rhythmType);

                        if (checkbox) {
                            if (frequency === 0) {
                                checkbox.checked = false;
                                console.log('🔄 自动取消勾选 ' + rhythmType + ': 频率为 0%');
                            } else if (!checkbox.checked) {
                                checkbox.checked = true;
                                console.log('🔄 自动勾选 ' + rhythmType + ': 频率为 ' + frequency + '%');
                            }
                        }
                    });
                }
            });
        });

        // 🎼 谱号-音域智能绑定系统事件监听器
        document.addEventListener('DOMContentLoaded', function() {

            // 获取音域控制元素
            const rangeMinSelect = document.getElementById('rangeMin');
            const rangeMaxSelect = document.getElementById('rangeMax');

            if (!rangeMinSelect || !rangeMaxSelect) {
                console.warn('⚠️ 音域选择器未找到');
                return;
            }

            // 🎼 添加谱号选择实时监听 - 立即切换音域（全局函数）
            window.addClefChangeListeners = function() {
                const clefCheckboxes = document.querySelectorAll('#clefModal input[type="checkbox"]');

                if (clefCheckboxes.length === 0) {
                    console.warn('⚠️ 未找到谱号复选框，可能模态框未显示');
                    return;
                }

                clefCheckboxes.forEach(checkbox => {
                    // 移除可能存在的旧监听器
                    if (window.clefChangeHandler) {
                        checkbox.removeEventListener('change', window.clefChangeHandler);
                    }

                    // 创建新的监听器函数
                    window.clefChangeHandler = function() {

                        // 如果有唯一选中的谱号，立即切换到该谱号的默认音域
                        const checkedClefs = Array.from(clefCheckboxes).filter(cb => cb.checked);

                        if (checkedClefs.length === 1) {
                            const selectedClef = checkedClefs[0].value;

                            if (typeof window.switchToClefRange === 'function') {
                                window.switchToClefRange(selectedClef);
                                // 更新当前生成的谱号
                                window.currentGeneratedClef = selectedClef;
                                window.currentActiveClef = selectedClef;

                            }
                        } else if (checkedClefs.length > 1) {
                            // 多个谱号启用：将活动谱号设为最后点击的该项，并加载其会话音域
                            if (this.checked) {
                                const newClef = this.value;
                                if (window.intervalSettings && typeof window.intervalSettings.setActiveClef === 'function') {
                                    window.intervalSettings.setActiveClef(newClef);
                                } else if (typeof window.setRangeForClef === 'function') {
                                    window.setRangeForClef(newClef);
                                }
                            } else {
                            }
                        } else {
                        }
                    };

                    checkbox.addEventListener('change', window.clefChangeHandler);
                });

            };

            // 存储当前生成的谱号（用于绑定用户自定义音域）
            window.currentGeneratedClef = 'treble'; // 默认高音谱号

            // 兼容变量名 - 为用户提供的函数使用
            window.currentActiveClef = window.currentGeneratedClef;

            // 音域记忆系统 - 参考和弦视奏工具设置
            window.clefRangeMemory = {
                'treble': { min: 60, max: 81 },  // C4-A5（高音谱号默认音域）
                'bass': { min: 40, max: 64 },    // E2-E4 (与和弦视奏工具一致)
                'alto': { min: 48, max: 67 }     // C3-G4 (中音谱号合理音域，不影响和弦工具)
            };

            // 保存用户对音域的调整
            function saveRangeForCurrentClef() {
                const rangeMinSelect = document.getElementById('rangeMin');
                const rangeMaxSelect = document.getElementById('rangeMax');

                if (!rangeMinSelect || !rangeMaxSelect) return;

                // 使用当前活跃的谱号
                if (!window.currentActiveClef) return;
                const minV = parseInt(rangeMinSelect.value);
                const maxV = parseInt(rangeMaxSelect.value);
                // 更新会话保存（当前+默认）
                if (window.intervalSettings && typeof window.intervalSettings.setClefRange === 'function') {
                    window.intervalSettings.setClefRange(window.currentActiveClef, minV, maxV);
                }
                // 刷新镜像
                window.clefRangeMemory[window.currentActiveClef] = { min: minV, max: maxV };
                console.log(`💾 保存${window.currentActiveClef}谱号音域(会话+镜像): ${minV}-${maxV}`);
            }

            // 从记忆中加载指定谱号的音域
            function loadRangeForClef(clef) {
                const rangeMinSelect = document.getElementById('rangeMin');
                const rangeMaxSelect = document.getElementById('rangeMax');

                if (!rangeMinSelect || !rangeMaxSelect) return;

                if (window.clefRangeMemory[clef]) {
                    const range = window.clefRangeMemory[clef];
                    rangeMinSelect.value = range.min.toString();
                    rangeMaxSelect.value = range.max.toString();
                    console.log(`📖 加载${clef}谱号音域: ${range.min}-${range.max}`);
                }
            }

            // 初始化音域监听器
            function initRangeListeners() {
                const rangeMinSelect = document.getElementById('rangeMin');
                const rangeMaxSelect = document.getElementById('rangeMax');

                if (rangeMinSelect && rangeMaxSelect) {
                    const handler = () => {
                        try {
                            if (window.intervalSettings && typeof window.intervalSettings.onRangeChange === 'function') {
                                window.intervalSettings.onRangeChange();
                                saveRangeForCurrentClef();
                            }
                        } catch(e){ console.warn('音域onChange失败', e); }
                    };
                    rangeMinSelect.addEventListener('change', handler);
                    rangeMaxSelect.addEventListener('change', handler);
                }
            }

            // 根据谱号设置合适的音域 - 使用 IntervalSettings 会话保存
            function setRangeForClef(clef) {
                const rangeMinSelect = document.getElementById('rangeMin');
                const rangeMaxSelect = document.getElementById('rangeMax');

                if (!rangeMinSelect || !rangeMaxSelect) return;

                // 更新当前活跃谱号
                window.currentActiveClef = clef;
                // 从 IntervalSettings 会话保存获取设置
                try {
                    if (window.intervalSettings && typeof window.intervalSettings.getClefCurrentRange === 'function') {
                        const rangeSettings = window.intervalSettings.getClefCurrentRange(clef);
                        if (rangeSettings) {
                            rangeMinSelect.value = String(rangeSettings.min);
                            rangeMaxSelect.value = String(rangeSettings.max);
                            window.clefRangeMemory[clef] = { min: rangeSettings.min, max: rangeSettings.max };
                            const noteNames = { 36:'C2',40:'E2',48:'C3',50:'D3',55:'G3',60:'C4',64:'E4',67:'G4',71:'B4',72:'C5',81:'A5' };
                            const minNote = noteNames[rangeSettings.min] || `MIDI${rangeSettings.min}`;
                            const maxNote = noteNames[rangeSettings.max] || `MIDI${rangeSettings.max}`;
                        }
                    }
                } catch(e) { console.warn('读取会话音域失败', e); }

                console.log(`🔄 当前活跃谱号已更新为: ${window.currentActiveClef}`);
            }

            // 将函数暴露到全局作用域供外部调用
            window.saveRangeForCurrentClef = saveRangeForCurrentClef;
            window.loadRangeForClef = loadRangeForClef;
            window.initRangeListeners = initRangeListeners;
            window.setRangeForClef = setRangeForClef;

            // 🎯 监听音域变更，自动绑定到当前谱号
            function handleRangeChange() {
                if (!window.intervalSettings) {
                    console.warn('⚠️ intervalSettings 不可用');
                    return;
                }

                const currentClef = window.currentGeneratedClef;
                const minValue = parseInt(rangeMinSelect.value);
                const maxValue = parseInt(rangeMaxSelect.value);


                // 使用用户提供的函数保存音域
                saveRangeForCurrentClef();
            }

            // ⚠️ 已移除冲突的事件监听器，统一使用IntervalSettings系统
            // rangeMinSelect.addEventListener('change', handleRangeChange);
            // rangeMaxSelect.addEventListener('change', handleRangeChange);

            // 🔄 自动切换音域函数（当生成新谱号时调用）- 总是切换到默认音域
            window.switchToClefRange = function(clef) {

                // 更新当前生成的谱号
                window.currentGeneratedClef = clef;
                window.currentActiveClef = clef;

                const rangeMinSelect = document.getElementById('rangeMin');
                const rangeMaxSelect = document.getElementById('rangeMax');

                if (!rangeMinSelect || !rangeMaxSelect) {
                    console.warn('⚠️ 音域选择器控件未找到');
                    return;
                }

                // 🎯 优先使用IntervalSettings保存的音域，如果没有则使用默认音域
                if (window.intervalSettings) {
                    const savedRange = window.intervalSettings.getClefCurrentRange(clef);

                    rangeMinSelect.value = savedRange.min.toString();
                    rangeMaxSelect.value = savedRange.max.toString();

                    // 检查是否为自定义音域
                    const clefSetting = window.intervalSettings.userSettings.clefRanges[clef];
                    const isCustom = clefSetting && clefSetting.hasCustomRange;

                } else {
                    // 回退到默认音域 (更新为新的默认设置)
                    const defaultRanges = {
                        'treble': { min: 60, max: 72 },  // C4-C5
                        'alto': { min: 50, max: 71 },    // D3-B4
                        'bass': { min: 40, max: 64 }     // E2-E4
                    };
                    const range = defaultRanges[clef] || defaultRanges['treble'];

                    rangeMinSelect.value = range.min.toString();
                    rangeMaxSelect.value = range.max.toString();

                }
            };

            // 🚀 初始化新的监听器系统
            window.initRangeListeners();

            // 🚀 初始化：设置为高音谱号的默认音域
            window.setRangeForClef('treble');


            // 🧪 添加测试功能（开发调试用）
            window.testClefRangeSwitching = function() {
                console.log('🧪 开始测试谱号-音域智能切换功能');

                const testClefs = ['treble', 'bass', 'alto'];
                let testIndex = 0;

                function runNextTest() {
                    if (testIndex >= testClefs.length) {
                        alert('谱号-音域切换测试完成！请查看控制台日志查看详细结果。');
                        return;
                    }

                    const clef = testClefs[testIndex];

                    window.switchToClefRange(clef);

                    testIndex++;
                    setTimeout(runNextTest, 1500); // 1.5秒间隔便于观察
                }

                runNextTest();
            };

            // 🔧 添加用户自定义音域测试功能
            window.testUserCustomRange = function() {
                console.log('🧪 开始测试用户自定义音域绑定功能');

                // 模拟用户在高音谱号上自定义音域到F4-F5
                window.switchToClefRange('treble');
                setTimeout(() => {
                    rangeMinSelect.value = '65'; // F4
                    rangeMaxSelect.value = '77'; // F5
                    rangeMinSelect.dispatchEvent(new Event('change'));

                    // 切换到低音谱号，应该显示默认音域
                    setTimeout(() => {
                        window.switchToClefRange('bass');

                        // 再切换回高音谱号，应该显示用户的自定义设置
                        setTimeout(() => {
                            window.switchToClefRange('treble');
                            alert('用户自定义音域测试完成！请查看控制台和音域选择器的变化。');
                        }, 1500);
                    }, 1500);
                }, 1000);
            };

            // 🔍 添加绑定状态查看功能
            window.showClefBindingStatus = function() {
                if (!window.intervalSettings) {
                    alert('❌ intervalSettings 未初始化');
                    return;
                }

                const clefs = ['treble', 'bass', 'alto'];
                const clefNames = { 'treble': '高音谱号', 'bass': '低音谱号', 'alto': '中音谱号' };
                let statusMessage = '🎼 当前谱号-音域绑定状态:\n\n';

                clefs.forEach(clef => {
                    const range = window.intervalSettings.getClefCurrentRange(clef);
                    const name = clefNames[clef];
                    const minNote = window.intervalSettings.midiToNote(range.min);
                    const maxNote = window.intervalSettings.midiToNote(range.max);
                    const isCustom = window.intervalSettings.clefRangeBindings[clef]?.isCustom ? '自定义' : '默认';
                    statusMessage += `${name}: ${minNote}-${maxNote} (${isCustom})\n`;
                });

                statusMessage += `\n当前生成谱号: ${window.currentGeneratedClef || 'treble'}`;
                alert(statusMessage);
            };


            // 🧪 添加完整工作流程测试
            window.testCompleteWorkflow = function() {
                console.group('🎼 完整谱号-音域绑定工作流程测试');
                console.log('测试场景：验证每个谱号的默认音域和用户自定义绑定');

                let testStep = 1;

                function logStep(description) {
                }

                // 步骤1: 验证默认音域
                logStep('验证各谱号默认音域');
                console.log('• 高音谱号默认: C4-C5 (MIDI 60-72)');
                console.log('• 低音谱号默认: E2-E4 (MIDI 40-64)');
                console.log('• 中音谱号默认: D3-B4 (MIDI 50-71)');

                // 步骤2: 测试低音谱号自动切换
                logStep('测试低音谱号自动音域切换');
                window.switchToClefRange('bass');
                const bassRange = window.intervalSettings.getClefCurrentRange('bass');

                // 步骤3: 模拟用户自定义低音谱号音域
                setTimeout(() => {
                    logStep('模拟用户自定义低音谱号音域 (改为F2-F4)');
                    const rangeMinSelect = document.getElementById('rangeMin');
                    const rangeMaxSelect = document.getElementById('rangeMax');
                    rangeMinSelect.value = '41'; // F2
                    rangeMaxSelect.value = '65'; // F4
                    rangeMinSelect.dispatchEvent(new Event('change'));

                    // 步骤4: 切换到中音谱号验证独立性
                    setTimeout(() => {
                        logStep('切换到中音谱号，验证音域独立性');
                        window.switchToClefRange('alto');
                        const altoRange = window.intervalSettings.getClefCurrentRange('alto');

                        // 步骤5: 切换回低音谱号验证用户自定义保持
                        setTimeout(() => {
                            logStep('切换回低音谱号，验证用户自定义音域已保存');
                            window.switchToClefRange('bass');
                            const customBassRange = window.intervalSettings.getClefCurrentRange('bass');

                            console.log('核心逻辑验证:');
                            console.groupEnd();

                            alert('✅ 完整工作流程测试完成！\n请查看控制台详细日志。');
                        }, 1500);
                    }, 1500);
                }, 1000);
            };

            // 🧪 添加新逻辑测试
            window.testNewLogic = function() {
                console.group('🎼 测试新的音程生成逻辑');
                console.log('测试场景：验证"生成后根据实际谱号切换音域"的逻辑');

                // 手动设置一个特定音域
                const rangeMinSelect = document.getElementById('rangeMin');
                const rangeMaxSelect = document.getElementById('rangeMax');
                rangeMinSelect.value = '55'; // G3
                rangeMaxSelect.value = '67'; // G4

                // 选择所有谱号让系统随机选择
                const trebleCheckbox = document.getElementById('clef-treble');
                const bassCheckbox = document.getElementById('clef-bass');
                const altoCheckbox = document.getElementById('clef-alto');

                if (trebleCheckbox) trebleCheckbox.checked = true;
                if (bassCheckbox) bassCheckbox.checked = true;
                if (altoCheckbox) altoCheckbox.checked = true;

                console.log('1. 音程是否使用当前的 G3-G4 音域');
                console.log('2. 生成后UI是否切换到实际生成谱号的默认音域');

                // 生成音程
                setTimeout(() => {
                    if (typeof window.generateIntervals === 'function') {
                        window.generateIntervals().then(() => {
                            // 检查最终音域UI
                            setTimeout(() => {
                                const finalMin = document.getElementById('rangeMin').value;
                                const finalMax = document.getElementById('rangeMax').value;
                                console.groupEnd();
                            }, 500);
                        }).catch(error => {
                            console.error('❌ 生成失败:', error);
                            console.groupEnd();
                        });
                    }
                }, 1000);
            };

            // 🧪 测试谱号模态框监听器绑定
            window.testModalListeners = function() {
                console.group('🎼 测试谱号模态框监听器绑定');
                console.log('测试场景：打开谱号设置模态框，检查事件监听器是否正确绑定');

                // 打开谱号设置模态框
                openClefSettings();

                // 等待模态框完全显示和监听器绑定
                setTimeout(() => {
                    const clefCheckboxes = document.querySelectorAll('#clefModal input[type="checkbox"]');

                    if (clefCheckboxes.length > 0) {

                        // 测试手动触发事件
                        const trebleCheckbox = document.getElementById('clef-treble');
                        const bassCheckbox = document.getElementById('clef-bass');

                        if (trebleCheckbox && bassCheckbox) {
                            trebleCheckbox.checked = false;
                            bassCheckbox.checked = true;

                            // 手动触发change事件
                            bassCheckbox.dispatchEvent(new Event('change'));

                            setTimeout(() => {
                                const rangeMin = document.getElementById('rangeMin').value;
                                const rangeMax = document.getElementById('rangeMax').value;
                                const minNote = window.intervalSettings.midiToNote(parseInt(rangeMin));
                                const maxNote = window.intervalSettings.midiToNote(parseInt(rangeMax));
                                console.log(`期望音域: E2-E4 (MIDI: 40-64)`);

                                bassCheckbox.checked = false;
                                trebleCheckbox.checked = true;
                                trebleCheckbox.dispatchEvent(new Event('change'));

                                setTimeout(() => {
                                    const newRangeMin = document.getElementById('rangeMin').value;
                                    const newRangeMax = document.getElementById('rangeMax').value;
                                    const newMinNote = window.intervalSettings.midiToNote(parseInt(newRangeMin));
                                    const newMaxNote = window.intervalSettings.midiToNote(parseInt(newRangeMax));
                                    console.log(`期望音域: C4-C5 (MIDI: 60-72)`);

                                    console.groupEnd();

                                    alert('✅ 模态框监听器测试完成！\n请查看控制台查看详细结果。');
                                }, 300);
                            }, 300);
                        } else {
                            console.error('❌ 未找到高音谱号或低音谱号复选框');
                            console.groupEnd();
                        }
                    } else {
                        console.error('❌ 模态框中未找到谱号复选框');
                        console.groupEnd();
                    }
                }, 200); // 等待监听器绑定完成
            };

            // 🧪 添加实时谱号切换测试
            window.testRealtimeClefSwitching = function() {
                console.group('🎼 测试实时谱号切换功能');
                console.log('测试场景：手动勾选/取消勾选谱号，验证音域是否立即更新');

                // 显示当前状态
                const rangeMin = document.getElementById('rangeMin').value;
                const rangeMax = document.getElementById('rangeMax').value;

                // 获取所有谱号复选框
                const trebleCheckbox = document.getElementById('clef-treble');
                const bassCheckbox = document.getElementById('clef-bass');
                const altoCheckbox = document.getElementById('clef-alto');

                if (trebleCheckbox && bassCheckbox && altoCheckbox) {
                    // 步骤1：清除所有选择，然后只选择低音谱号
                    trebleCheckbox.checked = false;
                    altoCheckbox.checked = false;
                    bassCheckbox.checked = true;
                    bassCheckbox.dispatchEvent(new Event('change')); // 触发change事件

                    setTimeout(() => {
                        const newMin = document.getElementById('rangeMin').value;
                        const newMax = document.getElementById('rangeMax').value;

                        // 步骤2：切换到高音谱号
                        bassCheckbox.checked = false;
                        trebleCheckbox.checked = true;
                        trebleCheckbox.dispatchEvent(new Event('change'));

                        setTimeout(() => {
                            const trebleMin = document.getElementById('rangeMin').value;
                            const trebleMax = document.getElementById('rangeMax').value;

                            // 步骤3：切换到中音谱号
                            trebleCheckbox.checked = false;
                            altoCheckbox.checked = true;
                            altoCheckbox.dispatchEvent(new Event('change'));

                            setTimeout(() => {
                                const altoMin = document.getElementById('rangeMin').value;
                                const altoMax = document.getElementById('rangeMax').value;

                                console.groupEnd();

                                alert('✅ 实时谱号切换测试完成！\n音域应该根据谱号选择立即更新。\n请查看控制台详细日志。');
                            }, 300);
                        }, 300);
                    }, 300);
                } else {
                    console.error('❌ 未找到谱号复选框');
                    console.groupEnd();
                }
            };

            // 🧪 测试简化后的音域设置逻辑
            window.testSimplifiedRangeSetting = function() {
                console.group('🎼 测试简化后的音域设置逻辑');
                console.log('测试场景：每次生成后，音域无条件设置为生成谱号的默认音域');

                let testCount = 0;
                const maxTests = 3;

                function runSingleTest() {
                    testCount++;

                    // 显示生成前状态
                    const beforeMin = document.getElementById('rangeMin').value;
                    const beforeMax = document.getElementById('rangeMax').value;
                    const beforeMinNote = window.intervalSettings.midiToNote(parseInt(beforeMin));
                    const beforeMaxNote = window.intervalSettings.midiToNote(parseInt(beforeMax));
                    console.log(`生成前音域: ${beforeMinNote}-${beforeMaxNote} (MIDI: ${beforeMin}-${beforeMax})`);

                    // 确保选择了多个谱号
                    const trebleCheckbox = document.getElementById('clef-treble');
                    const bassCheckbox = document.getElementById('clef-bass');
                    const altoCheckbox = document.getElementById('clef-alto');

                    if (trebleCheckbox) trebleCheckbox.checked = true;
                    if (bassCheckbox) bassCheckbox.checked = true;
                    if (altoCheckbox) altoCheckbox.checked = true;

                    // 生成音程

                    if (typeof window.generateIntervals === 'function') {
                        window.generateIntervals().then(() => {
                            // 等待音域设置完成
                            setTimeout(() => {
                                const afterMin = document.getElementById('rangeMin').value;
                                const afterMax = document.getElementById('rangeMax').value;
                                const afterMinNote = window.intervalSettings.midiToNote(parseInt(afterMin));
                                const afterMaxNote = window.intervalSettings.midiToNote(parseInt(afterMax));
                                const generatedClef = window.currentActiveClef;

                                console.log(`生成后音域: ${afterMinNote}-${afterMaxNote} (MIDI: ${afterMin}-${afterMax})`);
                                console.log(`生成的谱号: ${generatedClef}`);

                                // 验证音域是否匹配
                                const expectedRanges = {
                                    'treble': { min: 60, max: 72, name: 'C4-C5' },
                                    'bass': { min: 40, max: 64, name: 'E2-E4' },
                                    'alto': { min: 48, max: 67, name: 'C3-G4' }
                                };

                                const expected = expectedRanges[generatedClef];
                                if (expected &&
                                    parseInt(afterMin) === expected.min &&
                                    parseInt(afterMax) === expected.max) {
                                } else {
                                    console.log(`❌ 音域不匹配，期望: ${expected ? expected.name : '未知'}，实际: ${afterMinNote}-${afterMaxNote}`);
                                }

                                // 继续下一次测试或结束
                                if (testCount < maxTests) {
                                    setTimeout(() => runSingleTest(), 1000);
                                } else {
                                    console.log('核心验证：每次生成后音域都应该自动设置为该次生成谱号的默认音域');
                                    console.groupEnd();

                                    alert(`✅ 简化逻辑测试完成！\n进行了${maxTests}次测试，请查看控制台了解详细结果。\n每次生成后音域都应该设置为对应谱号的默认音域。`);
                                }
                            }, 800); // 等待音域设置完成
                        }).catch(error => {
                            console.error('❌ 生成失败:', error);
                            console.groupEnd();
                        });
                    } else {
                        console.error('❌ generateIntervals 函数不存在');
                        console.groupEnd();
                    }
                }

                // 开始第一次测试
                runSingleTest();
            };

            // 🧪 测试生成时谱号变化的音域自动调整
            window.testGeneratedClefSwitching = function() {
                console.group('🎼 测试生成时谱号变化的音域自动调整');
                console.log('测试场景：生成音程时如果谱号变化，音域应立即调整');

                // 显示初始状态
                const initialMin = document.getElementById('rangeMin').value;
                const initialMax = document.getElementById('rangeMax').value;
                const initialMinNote = window.intervalSettings.midiToNote(parseInt(initialMin));
                const initialMaxNote = window.intervalSettings.midiToNote(parseInt(initialMax));

                // 选择多个谱号让系统随机选择
                const trebleCheckbox = document.getElementById('clef-treble');
                const bassCheckbox = document.getElementById('clef-bass');
                const altoCheckbox = document.getElementById('clef-alto');

                // 确保选择了多个谱号
                if (trebleCheckbox) trebleCheckbox.checked = true;
                if (bassCheckbox) bassCheckbox.checked = true;
                if (altoCheckbox) altoCheckbox.checked = true;


                // 生成音程

                if (typeof window.generateIntervals === 'function') {
                    window.generateIntervals().then(() => {
                        // 等待一段时间确保音域调整完成
                        setTimeout(() => {
                            const finalMin = document.getElementById('rangeMin').value;
                            const finalMax = document.getElementById('rangeMax').value;
                            const finalMinNote = window.intervalSettings.midiToNote(parseInt(finalMin));
                            const finalMaxNote = window.intervalSettings.midiToNote(parseInt(finalMax));


                            // 检查音域是否匹配谱号
                            const expectedRanges = {
                                'treble': { min: 60, max: 72, name: 'C4-C5' },
                                'bass': { min: 40, max: 64, name: 'E2-E4' },
                                'alto': { min: 48, max: 67, name: 'C3-G4' }
                            };

                            const currentClef = window.currentActiveClef;
                            const expectedRange = expectedRanges[currentClef];

                            if (expectedRange &&
                                parseInt(finalMin) === expectedRange.min &&
                                parseInt(finalMax) === expectedRange.max) {
                            } else {
                                console.log(`⚠️ 音域不匹配预期，当前: ${finalMinNote}-${finalMaxNote}，期望: ${expectedRange ? expectedRange.name : '未知'}`);
                            }

                            console.groupEnd();

                            alert('✅ 生成时谱号变化测试完成！\n请查看控制台了解详细结果。\n如果生成的谱号发生变化，音域应该自动调整。');
                        }, 1000); // 等待音域调整完成
                    }).catch(error => {
                        console.error('❌ 生成失败:', error);
                        console.groupEnd();
                    });
                } else {
                    console.error('❌ generateIntervals 函数不存在');
                    console.groupEnd();
                }
            };

            // 🧪 添加生成时音域切换测试
            window.testGenerationSwitching = function() {
                console.group('🎼 测试音程生成时的自动音域切换');
                console.log('测试场景：选择不同谱号并生成音程，验证音域是否自动切换');

                // 模拟选择低音谱号并生成
                const bassCheckbox = document.getElementById('clef-bass');
                const trebleCheckbox = document.getElementById('clef-treble');
                const altoCheckbox = document.getElementById('clef-alto');

                // 清除所有选择
                if (trebleCheckbox) trebleCheckbox.checked = false;
                if (altoCheckbox) altoCheckbox.checked = false;
                if (bassCheckbox) {
                    bassCheckbox.checked = true;

                    // 显示当前音域
                    const rangeMin = document.getElementById('rangeMin').value;
                    const rangeMax = document.getElementById('rangeMax').value;

                    console.log('💡 或者在控制台运行 generateIntervals() 来触发生成');

                    // 自动触发生成测试
                    setTimeout(() => {
                        if (typeof window.generateIntervals === 'function') {
                            window.generateIntervals();
                        }
                    }, 2000);
                } else {
                    console.warn('⚠️ 未找到低音谱号复选框');
                }

                console.groupEnd();
            };

            // 🧪 测试用户提供的音域保存函数
            window.testUserFunctions = function() {
                console.group('🧪 测试用户提供的音域保存函数');
                console.log('测试场景：验证 saveRangeForCurrentClef() 和 loadRangeForClef() 函数');

                // 步骤1：切换到低音谱号
                window.switchToClefRange('bass');
                console.log(`当前活跃谱号: ${window.currentActiveClef}`);

                // 步骤2：修改音域
                setTimeout(() => {
                    const rangeMinSelect = document.getElementById('rangeMin');
                    const rangeMaxSelect = document.getElementById('rangeMax');
                    rangeMinSelect.value = '41'; // F2
                    rangeMaxSelect.value = '65'; // F4

                    // 步骤3：调用用户函数保存
                    window.saveRangeForCurrentClef();

                    // 步骤4：检查内存状态
                    console.log('clefRangeMemory:', window.clefRangeMemory);

                    // 步骤5：切换到其他谱号再切换回来测试加载
                    setTimeout(() => {
                        window.switchToClefRange('treble');

                        setTimeout(() => {
                            window.currentActiveClef = 'bass';
                            window.loadRangeForClef('bass');

                            const finalMin = document.getElementById('rangeMin').value;
                            const finalMax = document.getElementById('rangeMax').value;

                            console.groupEnd();
                        }, 1000);
                    }, 1000);
                }, 1000);
            };

            // 🧪 测试完整的新函数系统
            window.testNewFunctionSystem = function() {
                console.group('🧪 测试完整的新函数系统');
                console.log('测试场景：验证所有新添加的用户函数');

                console.log('测试各谱号的默认音域设置...');

                // 测试高音谱号
                window.setRangeForClef('treble');
                let currentMin = document.getElementById('rangeMin').value;
                let currentMax = document.getElementById('rangeMax').value;

                setTimeout(() => {
                    // 测试低音谱号
                    window.setRangeForClef('bass');
                    currentMin = document.getElementById('rangeMin').value;
                    currentMax = document.getElementById('rangeMax').value;

                    setTimeout(() => {
                        // 测试中音谱号
                        window.setRangeForClef('alto');
                        currentMin = document.getElementById('rangeMin').value;
                        currentMax = document.getElementById('rangeMax').value;

                        setTimeout(() => {

                            // 修改中音谱号音域并保存 (测试自定义音域)
                            document.getElementById('rangeMin').value = '45'; // A2
                            document.getElementById('rangeMax').value = '69'; // A4

                            // 手动保存
                            window.saveRangeForCurrentClef();

                            // 切换到其他谱号
                            window.setRangeForClef('treble');
                            console.log('🔄 切换到高音谱号');

                            // 切换回中音谱号验证记忆
                            setTimeout(() => {
                                window.setRangeForClef('alto');
                                const finalMin = document.getElementById('rangeMin').value;
                                const finalMax = document.getElementById('rangeMax').value;

                                console.log('clefRangeMemory:', window.clefRangeMemory);

                                console.groupEnd();
                            }, 1000);
                        }, 1000);
                    }, 1000);
                }, 1000);
            };

            // 🧪 测试用户的具体需求 - 生成后自动切换到默认音域
            window.testUserRequirement = function() {
                console.group('🎯 测试用户具体需求：生成后自动切换到谱号默认音域');
                console.log('需求验证：生成音程 → 使用当前音域 → 生成后切换到实际谱号的默认音域');

                // 步骤1：手动设置一个非默认音域
                const rangeMinSelect = document.getElementById('rangeMin');
                const rangeMaxSelect = document.getElementById('rangeMax');
                rangeMinSelect.value = '53'; // F3
                rangeMaxSelect.value = '65'; // F4

                // 步骤2：选择所有谱号让系统随机选择
                const trebleCheckbox = document.getElementById('clef-treble');
                const bassCheckbox = document.getElementById('clef-bass');
                const altoCheckbox = document.getElementById('clef-alto');

                if (trebleCheckbox) trebleCheckbox.checked = true;
                if (bassCheckbox) bassCheckbox.checked = true;
                if (altoCheckbox) altoCheckbox.checked = true;

                // 步骤3：生成音程
                console.log('预期结果：');
                console.log('1. 音程使用当前的 F3-F4 音域生成');
                console.log('2. 生成完成后UI自动切换到实际生成谱号的默认音域');
                console.log('3. 例如生成了低音谱号，UI应切换到 E2-E4');

                setTimeout(() => {
                    if (typeof window.generateIntervals === 'function') {
                        window.generateIntervals().then(() => {
                            // 检查生成后的音域UI
                            setTimeout(() => {
                                const finalMin = document.getElementById('rangeMin').value;
                                const finalMax = document.getElementById('rangeMax').value;
                                const minNote = window.intervalSettings.midiToNote(parseInt(finalMin));
                                const maxNote = window.intervalSettings.midiToNote(parseInt(finalMax));


                                // 判断是否切换到了正确的默认音域
                                const expectedRanges = {
                                    'treble': '60-72', // C4-C5
                                    'bass': '40-64',   // E2-E4
                                    'alto': '48-67'    // C3-G4
                                };

                                const currentRange = `${finalMin}-${finalMax}`;
                                const matchedClef = Object.keys(expectedRanges).find(clef =>
                                    expectedRanges[clef] === currentRange
                                );

                                if (matchedClef) {
                                } else {
                                    console.log(`⚠️ UI音域 ${currentRange} 不匹配任何默认音域`);
                                }

                                console.groupEnd();
                            }, 500);
                        }).catch(error => {
                            console.error('❌ 生成失败:', error);
                            console.groupEnd();
                        });
                    }
                }, 1000);
            };

            // 🧪 开发者控制台说明
            console.group('🎼 谱号-音域智能绑定系统测试指南');
            console.log('可用测试函数:');
            console.log('• testUserFunctions() - 🆕 测试用户提供的音域保存函数');
            console.log('• testNewLogic() - 🆕 测试新的音程生成逻辑');
            console.log('• testGenerationSwitching() - 测试生成时自动音域切换');
            console.log('• testClefRangeSwitching() - 测试自动音域切换');
            console.log('• testUserCustomRange() - 测试用户自定义音域绑定');
            console.log('• showClefBindingStatus() - 查看当前绑定状态');
            console.log('• switchToClefRange("treble"|"bass"|"alto") - 手动切换谱号');
            console.log('• saveRangeForCurrentClef() - 保存当前谱号的音域设置');
            console.log('• loadRangeForClef(clef) - 加载指定谱号的音域设置');
            console.log('• initRangeListeners() - 初始化音域监听器');
            console.log('• setRangeForClef(clef) - 根据谱号设置合适的音域');
            console.log('• 高音谱号默认: C4-C5 (60-72) ← 与和弦视奏工具一致');
            console.log('• 低音谱号默认: E2-E4 (40-64) ← 与和弦视奏工具一致');
            console.log('• 中音谱号默认: C3-G4 (48-67) ← 合理的中音谱号音域');
            console.log('• 生成音程使用当前UI音域设置');
            console.log('• 生成完成后→根据实际生成的谱号切换音域UI');
            console.log('• 用户调整音域→自动绑定到当前谱号，成为该谱号固定音域');
            console.log('• 各谱号音域完全独立，互不影响');
            console.groupEnd();
        });

        // 重写模态框关闭函数以重置全选状态
        const originalCloseRhythmSettings = window.closeRhythmSettings;
        const originalCloseArticulationSettings = window.closeArticulationSettings;
        const originalCloseKeySettings = window.closeKeySettings;
        const originalCloseTimeSignatureSettings = window.closeTimeSignatureSettings;
        const originalCloseIntervalSettings = window.closeIntervalSettings;
        const originalCloseClefSettings = window.closeClefSettings;

        if (typeof originalCloseRhythmSettings === 'function') {
            window.closeRhythmSettings = function() {
                originalCloseRhythmSettings();
                if (typeof resetSelectAllStates === 'function') resetSelectAllStates();
            };
        }

        if (typeof originalCloseArticulationSettings === 'function') {
            window.closeArticulationSettings = function() {
                originalCloseArticulationSettings();
                if (typeof resetSelectAllStates === 'function') resetSelectAllStates();
            };
        }

        if (typeof originalCloseKeySettings === 'function') {
            window.closeKeySettings = function() {
                originalCloseKeySettings();
                if (typeof resetSelectAllStates === 'function') resetSelectAllStates();
            };
        }

        if (typeof originalCloseTimeSignatureSettings === 'function') {
            window.closeTimeSignatureSettings = function() {
                originalCloseTimeSignatureSettings();
                if (typeof resetSelectAllStates === 'function') resetSelectAllStates();
            };
        }

        if (typeof originalCloseIntervalSettings === 'function') {
            window.closeIntervalSettings = function() {
                originalCloseIntervalSettings();
                if (typeof resetSelectAllStates === 'function') resetSelectAllStates();
            };
        }

        if (typeof originalCloseClefSettings === 'function') {
            window.closeClefSettings = function() {
                originalCloseClefSettings();
                if (typeof resetSelectAllStates === 'function') resetSelectAllStates();
            };
        }

        // 动态隐藏包含特定文本的SVG元素
        function hideTitleAndInstrumentElements() {
            // 等待一会儿让OSMD渲染完成
            setTimeout(() => {
                const scoreDiv = document.getElementById('score');
                if (scoreDiv) {
                    // 查找所有SVG text元素
                    const textElements = scoreDiv.querySelectorAll('svg text');
                    textElements.forEach(element => {
                        const text = element.textContent || element.innerText;
                        if (text && (
                            text.includes('Piano') || 
                            text.includes('Untitled') || 
                            text.includes('Untitled Score') ||
                            text.trim() === 'Piano' ||
                            text.trim() === 'Untitled Score'
                        )) {
                            element.style.display = 'none';
                            element.style.visibility = 'hidden';
                            console.log('隐藏文本元素:', text);
                        }
                    });
                    
                    // 也检查其他可能的元素
                    const allElements = scoreDiv.querySelectorAll('*');
                    allElements.forEach(element => {
                        const text = element.textContent || element.innerText;
                        if (text && element.tagName !== 'SCRIPT' && (
                            text.trim() === 'Piano' ||
                            text.trim() === 'Untitled Score'
                        )) {
                            element.style.display = 'none';
                            element.style.visibility = 'hidden';
                            console.log('隐藏元素:', element.tagName, text);
                        }
                    });
                }
            }, 500);
        }
        
        // 清除空谱子提示信息
        function clearEmptyScoreMessage() {
            const scoreDiv = document.getElementById('score');
            if (scoreDiv) {
                const emptyMessage = scoreDiv.querySelector('.empty-score-message');
                if (emptyMessage) {
                    emptyMessage.remove();
                }
            }
        }

        // 监听OSMD渲染完成
        const originalGenerateIntervals = window.generateIntervals;
        if (originalGenerateIntervals) {
            window.generateIntervals = function(...args) {
                // 🎵 自动停止当前播放
                if (typeof window.isPlayingInterval !== 'undefined' && window.isPlayingInterval) {
                    window.isPlayingInterval = false;
                    if (window.intervalScheduledSounds) {
                        window.intervalScheduledSounds.forEach(sound => {
                            try {
                                if (sound.oscillator) sound.oscillator.stop();
                                if (sound.source) sound.source.stop();
                                if (sound.element) {
                                    sound.element.pause();
                                    sound.element.src = '';
                                }
                            } catch (e) {}
                        });
                        window.intervalScheduledSounds = [];
                    }
                    // 更新播放按钮状态
                    const playBtn = document.getElementById('playIntervalBtn');
                    if (playBtn) {
                        playBtn.innerHTML = '播放';
                    }
                }

                // 清除空谱子提示信息
                clearEmptyScoreMessage();

                const result = originalGenerateIntervals.apply(this, args);
                hideTitleAndInstrumentElements();
                return result;
            };
        }

        // 包装 previousInterval 和 nextInterval，添加停止播放逻辑
        const originalPreviousInterval = window.previousInterval;
        if (originalPreviousInterval) {
            window.previousInterval = function(...args) {
                if (typeof window.isPlayingInterval !== 'undefined' && window.isPlayingInterval) {
                    window.isPlayingInterval = false;
                    if (window.intervalScheduledSounds) {
                        window.intervalScheduledSounds.forEach(sound => {
                            try {
                                if (sound.oscillator) sound.oscillator.stop();
                                if (sound.source) sound.source.stop();
                                if (sound.element) {
                                    sound.element.pause();
                                    sound.element.src = '';
                                }
                            } catch (e) {}
                        });
                        window.intervalScheduledSounds = [];
                    }
                    const playBtn = document.getElementById('playIntervalBtn');
                    if (playBtn) {
                        playBtn.innerHTML = '播放';
                    }
                }
                return originalPreviousInterval.apply(this, args);
            };
        }

        const originalNextInterval = window.nextInterval;
        if (originalNextInterval) {
            window.nextInterval = function(...args) {
                if (typeof window.isPlayingInterval !== 'undefined' && window.isPlayingInterval) {
                    window.isPlayingInterval = false;
                    if (window.intervalScheduledSounds) {
                        window.intervalScheduledSounds.forEach(sound => {
                            try {
                                if (sound.oscillator) sound.oscillator.stop();
                                if (sound.source) sound.source.stop();
                                if (sound.element) {
                                    sound.element.pause();
                                    sound.element.src = '';
                                }
                            } catch (e) {}
                        });
                        window.intervalScheduledSounds = [];
                    }
                    const playBtn = document.getElementById('playIntervalBtn');
                    if (playBtn) {
                        playBtn.innerHTML = '播放';
                    }
                }
                return originalNextInterval.apply(this, args);
            };
        }

        // 页面加载完成后也执行一次
        document.addEventListener('DOMContentLoaded', () => {
            hideTitleAndInstrumentElements();
            // 定期检查
            setInterval(hideTitleAndInstrumentElements, 2000);
            
            // 添加点击容器触发生成音程功能
            const scoreContainer = document.querySelector('.score-container');
            if (scoreContainer) {
                // 添加点击事件监听器
                scoreContainer.addEventListener('click', function(event) {
                    // 确保 generateIntervals 函数存在
                    if (typeof generateIntervals === 'function') {
                        generateIntervals();
                    } else {
                        console.warn('generateIntervals 函数未找到');
                    }
                });
                
                // 添加鼠标悬停样式提示
                scoreContainer.style.cursor = 'pointer';
                scoreContainer.title = '点击任意位置生成新音程';
                
            } else {
                console.warn('未找到 .score-container 元素');
            }
        });

        // ======================================
        // 🎵 音程播放模式和隐藏模式功能（从旋律视奏工具复制）
        // ======================================

        // 隐藏模式变量和函数
        var isIntervalHidden = false;

        /**
         * 🎭 应用音程隐藏状态到当前乐谱
         */
        function applyIntervalHiddenState() {
            const scoreElement = document.getElementById('score');
            if (!scoreElement) return;

            const svgElements = scoreElement.querySelectorAll('svg');
            if (isIntervalHidden) {
                // 同步隐藏容器与SVG，避免渲染前后状态不一致
                scoreElement.style.opacity = '0';
                scoreElement.style.filter = 'blur(10px)';

                svgElements.forEach(svg => {
                    svg.classList.add('melody-hidden');
                    svg.style.opacity = '0';
                    svg.style.filter = 'blur(10px)';
                });
                console.log('👂 已应用隐藏状态到音程');
            } else {
                // 清除容器与SVG上的隐藏样式，确保可见
                scoreElement.style.opacity = '1';
                scoreElement.style.filter = 'none';

                svgElements.forEach(svg => {
                    svg.classList.remove('melody-hidden');
                    svg.style.opacity = '1';
                    svg.style.filter = 'none';
                });
                console.log('👀 已应用显示状态到音程');
            }
        }

        /**
         * 🎭 更新隐藏按钮的状态
         */
        function updateVisibilityButton() {
            const visibilityBtn = document.getElementById('intervalVisibilityBtn');
            if (!visibilityBtn) return;

            if (isIntervalHidden) {
                visibilityBtn.innerHTML = '👂';
                visibilityBtn.title = '显示音程';
                visibilityBtn.classList.add('hidden-state');
            } else {
                visibilityBtn.innerHTML = '👀';
                visibilityBtn.title = '隐藏音程';
                visibilityBtn.classList.remove('hidden-state');
            }
        }

        function toggleIntervalVisibility() {
            isIntervalHidden = !isIntervalHidden;
            console.log(`🎭 切换隐藏状态: ${isIntervalHidden ? '隐藏' : '显示'}`);

            // 应用新状态
            applyIntervalHiddenState();
            updateVisibilityButton();
        }

        // 播放模式变量和函数
        window.isPlayingInterval = false;
        window.intervalAudioCtx = null;
        window.intervalScheduledSounds = [];
        window.intervalPlaybackStartTime = null; // 播放开始的实际时间（Performance.now()）
        window.intervalPlaybackTempo = 60; // 当前播放的tempo
        window.intervalPlaybackTimeSignature = { beats: 4, beatType: 4 }; // 当前播放的拍号
        window.intervalMetronomeSyncTimeout = null; // 节拍器同步的 setTimeout ID

        function directPlayTest() {

            // 🔍 调试：检查当前数据状态
            if (window.currentIntervalProgression) {
                console.log('🔍 当前数据状态:', {
                    measures: window.currentIntervalProgression.measures?.length || 0,
                    tempo: window.currentIntervalProgression.tempo,
                    firstMeasureExists: !!window.currentIntervalProgression.measures?.[0],
                    firstMeasureLowerVoice: window.currentIntervalProgression.measures?.[0]?.lowerVoice?.length || 0,
                    firstMeasureUpperVoice: window.currentIntervalProgression.measures?.[0]?.upperVoice?.length || 0
                });
            }

            if (window.isPlayingInterval) {
                // 停止播放
                window.isPlayingInterval = false;
                // 🎵 清除播放状态变量
                window.intervalPlaybackStartTime = null;
                window.intervalPlaybackTempo = 60;
                window.intervalPlaybackTimeSignature = { beats: 4, beatType: 4 };

                // 🔧 清除节拍器同步的 setTimeout（如果存在）
                if (window.intervalMetronomeSyncTimeout) {
                    clearTimeout(window.intervalMetronomeSyncTimeout);
                    window.intervalMetronomeSyncTimeout = null;
                    console.log('⏹️ 已清除节拍器同步定时器');
                }

                // 停止所有调度的播放
                if (window.intervalScheduledSounds) {
                    window.intervalScheduledSounds.forEach(sound => {
                        try {
                            // 处理振荡器节点（合成器回退）
                            if (sound.oscillator) {
                                sound.oscillator.stop();
                            }
                            // 处理采样器的 BufferSource 节点
                            if (sound.source) {
                                sound.source.stop();
                            }
                            // 处理 HTMLAudioElement（file:// 协议下的回退）
                            if (sound.element) {
                                sound.element.pause();
                                sound.element.src = '';
                            }
                        } catch (e) {
                            // 节点可能已经停止，忽略错误
                        }
                    });
                    window.intervalScheduledSounds = [];
                }
                updatePlayButton();
                console.log('⏹️ 停止音程播放');
                return;
            }

            try {
                // 🎯 修复：初始化调度音频数组
                if (!window.intervalScheduledSounds) {
                    window.intervalScheduledSounds = [];
                }

                // 🎯 修复：增强的AudioContext初始化和错误处理
                if (!window.intervalAudioCtx) {
                    const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                    if (!AudioContextClass) {
                        throw new Error('您的浏览器不支持Web Audio API，无法播放音频');
                    }
                    window.intervalAudioCtx = new AudioContextClass();
                    console.log('🎹 创建了新的AudioContext，状态:', window.intervalAudioCtx.state);
                }

                // 🎯 修复：强制恢复AudioContext状态，增加用户交互检查
                if (window.intervalAudioCtx.state === 'suspended') {
                    console.log('🎹 AudioContext被暂停，尝试恢复...');
                    window.intervalAudioCtx.resume().then(() => {
                        console.log('🎹 AudioContext已恢复，状态:', window.intervalAudioCtx.state);
                        startIntervalPlayback();
                    }).catch(resumeError => {
                        console.error('❌ AudioContext恢复失败:', resumeError);
                        alert('音频上下文恢复失败，请刷新页面后重试');
                    });
                } else {
                    console.log('🎹 AudioContext已准备就绪，状态:', window.intervalAudioCtx.state);
                    startIntervalPlayback();
                }

            } catch (error) {
                console.error('❌ 音程播放初始化失败:', error);
                window.isPlayingInterval = false;
                updatePlayButton();
                alert('播放初始化失败：' + error.message);
            }
        }

        function startIntervalPlayback() {
            // 🎯 修复：增强的数据验证和错误处理

            if (!window.currentIntervalProgression) {
                console.warn('⚠️ 没有找到音程进行数据');
                alert('请先生成音程再播放');
                return;
            }


            if (!window.currentIntervalProgression.measures || window.currentIntervalProgression.measures.length === 0) {
                console.warn('⚠️ 音程进行数据中没有小节');
                alert('音程数据不完整，请重新生成');
                return;
            }

            // 验证第一个小节是否有有效的音符数据
            const firstMeasure = window.currentIntervalProgression.measures[0];

            if (!firstMeasure.lowerVoice || !firstMeasure.upperVoice ||
                firstMeasure.lowerVoice.length === 0 || firstMeasure.upperVoice.length === 0) {
                console.warn('⚠️ 音程进行数据中没有有效的音符');
                alert('音程数据不完整，请重新生成');
                return;
            }

            // 验证音符的pitch字段
            let validNoteCount = 0;
            firstMeasure.lowerVoice.forEach((note, index) => {
                if (note.type === 'note' && note.pitch) {
                    validNoteCount++;
                }
            });

            firstMeasure.upperVoice.forEach((note, index) => {
                if (note.type === 'note' && note.pitch) {
                    validNoteCount++;
                }
            });


            if (validNoteCount === 0) {
                console.warn('⚠️ 没有找到有效的音符数据');
                alert('音程数据中没有有效音符，请重新生成');
                return;
            }

            console.log('📊 播放数据统计:', {
                measures: window.currentIntervalProgression.measures.length,
                firstMeasureNotes: firstMeasure.lowerVoice.length,
                validNotes: validNoteCount,
                tempo: window.currentIntervalProgression.tempo || 120
            });

            window.isPlayingInterval = true;
            // 🎵 记录播放开始时间和参数，用于节拍器同步
            window.intervalPlaybackStartTime = performance.now();
            window.intervalPlaybackTempo = parseInt(document.getElementById('headerMetronomeBpm')?.value) || 60;
            window.intervalPlaybackTimeSignature = window.currentIntervalProgression.timeSignature || { beats: 4, beatType: 4 };

            updatePlayButton();

            // 🎵 检查隐藏模式（隐藏模式需要count-in）
            if (isIntervalHidden) {
                if (isMetronomeRunning) {
                    handleHiddenModeWithMetronome(window.currentIntervalProgression);
                } else {
                    playCountIn(window.currentIntervalProgression);
                }
                return;
            }

            // 🔧 智能播放时间：节拍器开启时对齐网格，关闭时立即响应

            // 确保 AudioContext 已初始化
            if (!window.intervalAudioCtx) {
                window.intervalAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }

            // 获取当前速度
            let tempo = 60;
            if (typeof getCurrentTempo === 'function') {
                tempo = getCurrentTempo();
            } else if (typeof metronomeTempo !== 'undefined') {
                tempo = metronomeTempo;
            }

            const beatDuration = 60.0 / tempo;
            const now = window.intervalAudioCtx.currentTime;
            let startTime;

            if (typeof isMetronomeRunning !== 'undefined' && isMetronomeRunning) {
                // 🎵 节拍器开启 - 对齐全局网格确保同步
                const currentBeatNumber = Math.floor(now / beatDuration);
                let nextBeatNumber = currentBeatNumber + 1;
                startTime = nextBeatNumber * beatDuration;

                // 安全检查：确保 startTime 至少在未来 50ms
                const minLookahead = 0.05;
                if (startTime < now + minLookahead) {
                    nextBeatNumber++;
                    startTime = nextBeatNumber * beatDuration;
                    console.log(`⚠️ 时间太近，跳到下一拍 (第${nextBeatNumber}拍)`);
                }

                console.log(`🎵 节拍器开启 - 同步到全局网格: BPM=${tempo}, 当前=${now.toFixed(3)}s, 播放=${startTime.toFixed(3)}s (第${nextBeatNumber}拍)`);
            } else {
                // 🚀 节拍器关闭 - 立即播放，响应迅速
                startTime = now + 0.1;
                console.log(`🚀 节拍器未开启 - 立即播放: BPM=${tempo}, 当前=${now.toFixed(3)}s, 播放=${startTime.toFixed(3)}s`);
            }

            playIntervalProgression(window.currentIntervalProgression, startTime);
        }

        function updatePlayButton() {
            const playBtn = document.getElementById('playIntervalBtn');
            if (playBtn) {
                if (window.isPlayingInterval) {
                    playBtn.innerHTML = '停止';
                    playBtn.classList.add('playing');
                } else {
                    playBtn.innerHTML = '播放';
                    playBtn.classList.remove('playing');
                }
            }
        }

        /**
         * 🎭🎵 处理隐藏模式 + 节拍器组合的特殊逻辑
         * @param {Object} progression - 音程进行数据
         */
        function handleHiddenModeWithMetronome(progression) {

            // 第一步：暂停节拍器
            const wasMetronomeRunning = isMetronomeRunning;
            if (wasMetronomeRunning) {
                stopMetronome();
            }

            // 第二步：播放count-in
            playCountInWithMetronomeRestart(progression, wasMetronomeRunning);
        }

        /**
         * 🗑️ 已弃用：旧的同步逻辑（使用modulo方式）
         * 现在使用全局节拍网格，所有播放总是对齐，不需要这个函数
         */
        // function playIntervalProgressionWithMetronomeSync(progression) { ... }

        /**
         * 🎭🎵 播放count-in并在结束后重新启动节拍器
         * @param {Object} progression - 音程进行数据
         * @param {boolean} shouldRestartMetronome - 是否需要重新启动节拍器
         */
        function playCountInWithMetronomeRestart(progression, shouldRestartMetronome) {

            // 获取当前节拍器速度
            const headerInput = document.getElementById('headerMetronomeBpm');
            const currentTempo = parseInt(headerInput ? headerInput.value : 60) || 60;
            const tempo = currentTempo;
            const timeSignature = progression.timeSignature || { beats: 4, beatType: 4 };
            const beatDuration = 60 / tempo; // 每拍的秒数

            // 计算count-in的总时长
            let countInBeats, actualBeatDuration;
            if (timeSignature.beats === 6 && timeSignature.beatType === 8) {
                countInBeats = 2;
                actualBeatDuration = beatDuration * 3;
            } else if (timeSignature.beats === 9 && timeSignature.beatType === 8) {
                countInBeats = 3;
                actualBeatDuration = beatDuration * 3;
            } else if (timeSignature.beats === 12 && timeSignature.beatType === 8) {
                countInBeats = 4;
                actualBeatDuration = beatDuration * 3;
            } else {
                countInBeats = timeSignature.beats;
                actualBeatDuration = beatDuration;
            }

            const countInDuration = countInBeats * actualBeatDuration * 1000; // 转换为毫秒

            console.log(`   - 拍数: ${countInBeats}拍`);
            console.log(`   - 每拍时长: ${actualBeatDuration.toFixed(2)}秒`);
            console.log(`   - 总时长: ${countInDuration.toFixed(2)}ms`);
            console.log(`   - 完成后重启节拍器: ${shouldRestartMetronome}`);

            // 播放count-in，但不由内部自动启动播放；由回调统一调度
            playCountIn(progression, {
                autoStart: false,
                onFinish: ({ playbackStartAt }) => {
                    if (shouldRestartMetronome) {
                        window.metronomeStartTime = performance.now();
                        startMetronome();
                    } else {
                    }
                    playIntervalProgression(progression, playbackStartAt);
                }
            });
        }

        /**
         * 🎵 播放count-in（打拍子）
         * @param {Object} progression - 音程进行数据
         */
        function playCountIn(progression, options = {}) {

            const { autoStart = true, onFinish = null } = options;

            // 🎵 修复：使用当前节拍器的tempo而不是生成时的tempo
            const headerInput = document.getElementById('headerMetronomeBpm');
            const currentTempo = parseInt(headerInput ? headerInput.value : 60) || 60;
            const tempo = currentTempo;
            const timeSignature = progression.timeSignature || { beats: 4, beatType: 4 };
            const beatDuration = 60 / tempo; // 每拍的秒数

            // 根据拍号确定count-in的拍数
            let countInBeats, actualBeatDuration;

            if (timeSignature.beats === 6 && timeSignature.beatType === 8) {
                // 6/8拍：感受为2个大拍，每拍为附点四分音符
                countInBeats = 2;
                actualBeatDuration = beatDuration * 3; // 3个八分音符 = 1个附点四分音符
            } else if (timeSignature.beats === 9 && timeSignature.beatType === 8) {
                // 9/8拍：感受为3个大拍
                countInBeats = 3;
                actualBeatDuration = beatDuration * 3;
            } else if (timeSignature.beats === 12 && timeSignature.beatType === 8) {
                // 12/8拍：感受为4个大拍
                countInBeats = 4;
                actualBeatDuration = beatDuration * 3;
            } else {
                // 其他拍号：按原始拍数
                countInBeats = timeSignature.beats;
                actualBeatDuration = beatDuration;
            }

            if (!window.intervalAudioCtx) {
                console.error('❌ AudioContext不可用');
                return;
            }

            // 以AudioContext时间为基准，避免setTimeout漂移
            const baseTime = window.intervalAudioCtx.currentTime + 0.1;
            let currentTime = baseTime;

            // 初始化采样器（若可用）
            try {
                if (!window.__icSamplePlayer && window.ICSamplePlayer) {
                    window.__icSamplePlayer = new ICSamplePlayer({ rootPath: 'assets/samples/piano-ogg' });
                    window.__icSamplePlayer.load();
                }
            } catch (_) {}

            // 播放每一拍的click声
            for (let beat = 1; beat <= countInBeats; beat++) {
                // 第一拍音调更高，其他拍音调较低
                const frequency = beat === 1 ? 800 : 600;
                const duration = 0.1; // click声的持续时间
                const beatTime = currentTime + (beat - 1) * actualBeatDuration;


                // 直接调度click声到AudioContext
                playClickSound(frequency, beatTime, duration);
            }

            // count-in结束后的精确播放时间（加入少量裕量以确保click尾音结束）
            const totalCountInDuration = countInBeats * actualBeatDuration;
            const playbackStartAt = baseTime + totalCountInDuration + 0.05;
            const delayMs = Math.max(0, (playbackStartAt - window.intervalAudioCtx.currentTime) * 1000);
            setTimeout(() => {
                if (window.isPlayingInterval) { // 确保还在播放状态
                    if (typeof onFinish === 'function') {
                        try { onFinish({ playbackStartAt, countInBeats, actualBeatDuration }); } catch (e) { console.warn('onFinish回调异常:', e); }
                    }
                    if (autoStart) {
                        playIntervalProgression(progression, playbackStartAt);
                    }
                }
            }, delayMs);
        }

        /**
         * 🎵 播放click声
         * @param {number} frequency - 频率
         * @param {number} startTime - 开始时间
         * @param {number} duration - 持续时间
         */
        function playClickSound(frequency, startTime, duration) {
            try {
                const oscillator = window.intervalAudioCtx.createOscillator();
                const gainNode = window.intervalAudioCtx.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(window.intervalAudioCtx.destination);

                oscillator.frequency.setValueAtTime(frequency, startTime);
                oscillator.type = 'square'; // 方波产生更清脆的click声

                // 音量包络：快速起始，快速衰减
                gainNode.gain.setValueAtTime(0, startTime);
                gainNode.gain.linearRampToValueAtTime(0.3, startTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, startTime + duration);

                oscillator.start(startTime);
                oscillator.stop(startTime + duration);

                // 保存到调度列表用于停止
                if (!window.intervalScheduledSounds) {
                    window.intervalScheduledSounds = [];
                }
                window.intervalScheduledSounds.push({ oscillator, gainNode });

            } catch (error) {
                console.error('❌ 播放click声失败:', error);
            }
        }

        function playIntervalProgression(progression, audioStartAt = null) {
            if (!progression || !progression.measures) {
                console.warn('⚠️ 无效的音程进行数据');
                window.isPlayingInterval = false;
                updatePlayButton();
                return;
            }

            // 🎯 详细验证播放数据

            // 验证每个小节的数据完整性
            let hasValidNotes = false;
            progression.measures.forEach((measure, measureIndex) => {
                console.log(`小节 ${measureIndex + 1}:`, {
                    lowerVoiceCount: measure.lowerVoice?.length || 0,
                    upperVoiceCount: measure.upperVoice?.length || 0
                });

                if (measure.lowerVoice && measure.upperVoice) {
                    measure.lowerVoice.forEach((note, noteIndex) => {
                        const upperNote = measure.upperVoice[noteIndex];
                        if (note && upperNote) {
                            console.log(`  音符${noteIndex + 1}:`, {
                                lower: { type: note.type, pitch: note.pitch, duration: note.duration },
                                upper: { type: upperNote.type, pitch: upperNote.pitch, duration: upperNote.duration }
                            });
                            if (note.type === 'note' && upperNote.type === 'note' && note.pitch && upperNote.pitch) {
                                hasValidNotes = true;
                            }
                        }
                    });
                }
            });

            if (!hasValidNotes) {
                console.error('❌ 播放数据中没有找到有效的音符');
                alert('播放数据不完整，请重新生成音程');
                window.isPlayingInterval = false;
                updatePlayButton();
                return;
            }

            // 🎵 修复：使用当前节拍器的tempo而不是生成时的tempo
            const headerInput = document.getElementById('headerMetronomeBpm');
            const currentTempo = parseInt(headerInput ? headerInput.value : 60) || 60;
            const tempo = currentTempo;
            const beatDuration = 60 / tempo; // 每拍的秒数
            const timeSignature = progression.timeSignature || { beats: 4, beatType: 4 };

            // 若提供了绝对AudioContext起始时间，则严格对齐；否则采用当前时间+0.1s
            let currentTime = audioStartAt ? Math.max(audioStartAt, window.intervalAudioCtx.currentTime + 0.02)
                                           : window.intervalAudioCtx.currentTime + 0.1; // 稍微延迟开始
            let totalPlaybackDuration = 0;

            progression.measures.forEach((measure, measureIndex) => {

                // 播放小节中的每个音符
                for (let i = 0; i < measure.lowerVoice.length; i++) {
                    const lowerNote = measure.lowerVoice[i];
                    const upperNote = measure.upperVoice[i];


                    if (lowerNote.type === 'note' && upperNote.type === 'note') {
                        // 检查音高字段
                        if (!lowerNote.pitch || !upperNote.pitch) {
                            console.error(`❌ 音高缺失: lower.pitch=${lowerNote.pitch}, upper.pitch=${upperNote.pitch}`);
                            continue;
                        }

                        // 计算音符持续时间
                        const noteDuration = getNoteDurationInSeconds(lowerNote.duration, beatDuration);

                        // 播放音程（和弦）
                        playIntervalChord([lowerNote.pitch, upperNote.pitch], currentTime, noteDuration);

                        currentTime += noteDuration;
                        totalPlaybackDuration += noteDuration;
                    } else if (lowerNote.type === 'rest') {
                        // 休止符：只推进时间，不播放声音
                        const restDuration = getNoteDurationInSeconds(lowerNote.duration, beatDuration);
                        currentTime += restDuration;
                        totalPlaybackDuration += restDuration;
                    }
                }
            });


            // 🎯 改进播放结束回调，添加清理逻辑
            const playbackEndTime = (totalPlaybackDuration + 0.5) * 1000; // 增加0.5秒缓冲时间
            setTimeout(() => {
                if (window.isPlayingInterval) {
                    window.isPlayingInterval = false;
                    // 🎵 清除播放状态变量
                    window.intervalPlaybackStartTime = null;
                    window.intervalPlaybackTempo = 60;
                    window.intervalPlaybackTimeSignature = { beats: 4, beatType: 4 };

                    // 清理调度的音频
                    if (window.intervalScheduledSounds) {
                        window.intervalScheduledSounds = [];
                    }
                    updatePlayButton();
                }
            }, playbackEndTime);
        }

        function playIntervalChord(pitches, startTime, duration) {
            if (!window.intervalAudioCtx) {
                console.error('❌ AudioContext不可用');
                return;
            }


            pitches.forEach((pitch, index) => {
                const frequency = pitchToFrequency(pitch);
                if (frequency) {
                    try {
                        if (window.__icSamplePlayer && window.__icSamplePlayer.ready) {
                            const midi = Math.round(69 + 12 * Math.log2(frequency / 440));
                            const playResult = window.__icSamplePlayer.scheduleAtExternalContext(window.intervalAudioCtx, startTime, midi, duration, 0.8);
                            // 保存返回值以便停止时使用
                            if (playResult) {
                                if (!window.intervalScheduledSounds) window.intervalScheduledSounds = [];
                                window.intervalScheduledSounds.push(playResult);
                            }
                        } else {
                            const oscillator = window.intervalAudioCtx.createOscillator();
                            const gainNode = window.intervalAudioCtx.createGain();
                            oscillator.connect(gainNode);
                            gainNode.connect(window.intervalAudioCtx.destination);
                            oscillator.frequency.setValueAtTime(frequency, startTime);
                            oscillator.type = 'sine';
                            const volume = 0.15;
                            gainNode.gain.setValueAtTime(0, startTime);
                            gainNode.gain.linearRampToValueAtTime(volume, startTime + 0.02);
                            gainNode.gain.setValueAtTime(volume * 0.8, startTime + duration - 0.05);
                            gainNode.gain.linearRampToValueAtTime(0, startTime + duration);
                            oscillator.start(startTime);
                            oscillator.stop(startTime + duration);
                            if (!window.intervalScheduledSounds) window.intervalScheduledSounds = [];
                            window.intervalScheduledSounds.push({ oscillator, gainNode });
                        }
                    } catch (error) {
                        console.error(`❌ 播放音符 ${pitch} 失败:`, error);
                    }
                } else {
                    console.warn(`⚠️ 无法解析音高: ${pitch}`);
                }
            });
        }

        function pitchToFrequency(pitch) {
            // 🎯 增强调试和错误处理

            if (!pitch || typeof pitch !== 'string') {
                console.error(`❌ 无效音高格式: ${pitch}`);
                return null;
            }

            // 解析音高 (如 "C4", "F#5")
            const match = pitch.match(/^([A-G])([#b]?)(\d+)$/);
            if (!match) {
                console.error(`❌ 音高解析失败: "${pitch}" 不匹配预期格式`);
                return null;
            }

            const [, note, accidental, octave] = match;
            const octaveNum = parseInt(octave);

            // C4 = MIDI 60 = 261.63 Hz
            const noteMap = { 'C': 0, 'D': 2, 'E': 4, 'F': 5, 'G': 7, 'A': 9, 'B': 11 };
            let midiNote = noteMap[note] + (octaveNum * 12) + 12; // C0 = MIDI 12

            if (accidental === '#') midiNote += 1;
            else if (accidental === 'b') midiNote -= 1;

            // MIDI note to frequency: f = 440 * 2^((n-69)/12)
            const frequency = 440 * Math.pow(2, (midiNote - 69) / 12);

            // 🎯 修复：添加频率范围验证
            if (frequency < 20 || frequency > 20000) {
                console.warn(`⚠️ 频率超出人耳听觉范围: ${frequency.toFixed(2)}Hz`);
            }

            return frequency;
        }

        // 🎯 添加播放测试函数
        function testAudioPlayback() {
            console.log('🧪 测试音频播放功能');
            try {
                const testFreq = pitchToFrequency('C4');
                console.log('🧪 测试频率:', testFreq);

                if (window.intervalAudioCtx && testFreq) {
                    const osc = window.intervalAudioCtx.createOscillator();
                    const gain = window.intervalAudioCtx.createGain();

                    osc.connect(gain);
                    gain.connect(window.intervalAudioCtx.destination);

                    osc.frequency.value = testFreq;
                    gain.gain.value = 0.1;

                    osc.start();
                    osc.stop(window.intervalAudioCtx.currentTime + 0.5);

                    console.log('🧪 测试音符已播放');
                    return true;
                }
            } catch (error) {
                console.error('❌ 音频测试失败:', error);
                return false;
            }
        }

        // 🎯 添加播放测试功能
        function testPlaybackSystem() {
            console.log('🧪 测试播放系统...');

            // 创建简单的测试数据
            const testProgression = {
                measures: [{
                    lowerVoice: [
                        { type: 'note', pitch: 'C4', duration: 1.0 },
                        { type: 'note', pitch: 'D4', duration: 1.0 }
                    ],
                    upperVoice: [
                        { type: 'note', pitch: 'E4', duration: 1.0 },
                        { type: 'note', pitch: 'F4', duration: 1.0 }
                    ]
                }],
                tempo: 120,
                timeSignature: { beats: 4, beatType: 4 }
            };

            // 保存测试数据
            window.currentIntervalProgression = testProgression;
            console.log('🧪 测试数据已保存');

            // 尝试播放
            if (window.intervalAudioCtx) {
                directPlayTest();
            } else {
                console.log('🧪 初始化音频上下文后再试播放...');
                directPlayTest();
            }
        }

        // 为调试添加全局函数
        window.testPlaybackSystem = testPlaybackSystem;
        window.testAudioPlayback = testAudioPlayback;

        function getNoteDurationInSeconds(duration, beatDuration) {
            // 🎯 修复：处理数字类型的duration
            let durationValue;
            if (typeof duration === 'number') {
                durationValue = duration;
            } else {
                const durationMap = {
                    'whole': 4.0,
                    'half.': 3.0,  // 附点二分音符
                    'half': 2.0,
                    'quarter.': 1.5,  // 附点四分音符
                    'quarter': 1.0,
                    'eighth': 0.5,
                    '16th': 0.25,
                    'triplet': 2/3  // 🎯 修复：四分三连音每个音符 = 2/3拍
                };
                durationValue = durationMap[duration] || 1.0;
            }

            const result = durationValue * beatDuration;
            return result;
        }

        // 🔧 页面卸载时清理V4.0渲染器资源
        window.addEventListener('beforeunload', function() {
            if (window.intervalRenderer && typeof window.intervalRenderer.clear === 'function') {
                try {
                    window.intervalRenderer.clear();
                } catch (cleanupError) {
                    console.warn('⚠️ V4.0渲染器清理时出错:', cleanupError);
                }
            }
        });


        // 🎯 通用弹窗外部点击关闭功能
        function initializeModalClickOutsideToClose() {
            const modalIds = [
                'intervalTypeModal',
                'rhythmModal',
                'articulationModal',
                'keySignatureModal',
                'timeSignatureModal',
                'intervalModal',
                'clefModal'
            ];

            modalIds.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.addEventListener('click', function(event) {
                        // 只有当点击的是弹窗背景（modal容器本身）时才关闭
                        if (event.target === modal) {

                            // 根据弹窗类型调用相应的关闭函数
                            switch(modalId) {
                                case 'intervalTypeModal':
                                    if (typeof closeIntervalTypeSettings === 'function') {
                                        closeIntervalTypeSettings();
                                    }
                                    break;
                                case 'rhythmModal':
                                    if (typeof saveRhythmSettings === 'function') {
                                        console.log('💾 外部点击：自动保存节奏设置');
                                        saveRhythmSettings();
                                    } else if (typeof closeRhythmSettings === 'function') {
                                        closeRhythmSettings();
                                    }
                                    break;
                                case 'articulationModal':
                                    if (typeof closeArticulationSettings === 'function') {
                                        closeArticulationSettings();
                                    }
                                    break;
                                case 'keySignatureModal':
                                    if (typeof closeKeySettings === 'function') {
                                        closeKeySettings();
                                    }
                                    break;
                                case 'timeSignatureModal':
                                    if (typeof saveTimeSignatureSettings === 'function') {
                                        console.log('💾 外部点击：自动保存拍号设置');
                                        saveTimeSignatureSettings();
                                    } else if (typeof closeTimeSignatureSettings === 'function') {
                                        closeTimeSignatureSettings();
                                    }
                                    break;
                                case 'intervalModal':
                                    if (typeof closeIntervalSettings === 'function') {
                                        closeIntervalSettings();
                                    }
                                    break;
                                case 'clefModal':
                                    if (typeof closeClefSettings === 'function') {
                                        closeClefSettings();
                                    }
                                    break;
                                default:
                                    // 通用关闭方法
                                    modal.style.display = 'none';
                            }
                        }
                    });
                }
            });
        }

        // 在页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeModalClickOutsideToClose();
        });
    </script>

    <!-- 音程容器点击生成功能 -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const scoreContainer = document.getElementById('score');

            if (scoreContainer) {
                // 添加点击事件监听器
                scoreContainer.addEventListener('click', function(event) {
                    // 检查点击的不是按钮或其他交互元素
                    const targetElement = event.target;
                    const isInteractiveElement = targetElement.tagName === 'BUTTON' ||
                                                 targetElement.tagName === 'A' ||
                                                 targetElement.closest('button') ||
                                                 targetElement.closest('a');

                    // 如果点击的不是交互元素，触发生成
                    if (!isInteractiveElement && typeof generateIntervals === 'function') {
                        console.log('🖱️ 容器点击触发生成音程');
                        generateIntervals();
                    }
                });

                // 添加指针样式提示（可点击）
                scoreContainer.style.cursor = 'pointer';

                console.log('✅ 音程容器点击生成功能已启用');
            } else {
                console.warn('⚠️ 未找到 score 容器，无法启用点击生成功能');
            }
        });

        // ⌨️ 全局键盘快捷键
        document.addEventListener('keydown', function(e) {
            // 如果在输入框、文本框或模态框输入中，不触发快捷键
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                return;
            }

            // 检查是否有模态框打开（避免在设置中触发）
            const hasOpenModal = document.querySelector('.modal:not([style*="display: none"])');
            if (hasOpenModal) {
                return;
            }

            const key = e.key.toLowerCase();

            switch(key) {
                case 'p':
                    // 播放/暂停播放
                    e.preventDefault();
                    if (typeof directPlayTest === 'function') {
                        directPlayTest();
                        console.log('⌨️ 快捷键: P - 播放/暂停');
                    }
                    break;

                case 'arrowleft':
                    // 上一条
                    e.preventDefault();
                    if (typeof previousInterval === 'function') {
                        previousInterval();
                        console.log('⌨️ 快捷键: ← - 上一条');
                    }
                    break;

                case 'arrowright':
                    // 下一条
                    e.preventDefault();
                    if (typeof nextInterval === 'function') {
                        nextInterval();
                        console.log('⌨️ 快捷键: → - 下一条');
                    }
                    break;

                case ' ':
                    // 生成（空格键）
                    e.preventDefault();
                    if (typeof generateIntervals === 'function') {
                        generateIntervals();
                        console.log('⌨️ 快捷键: Space - 生成音程');
                    }
                    break;

                case 'h':
                    // 隐藏/显示
                    e.preventDefault();
                    if (typeof toggleIntervalVisibility === 'function') {
                        toggleIntervalVisibility();
                        console.log('⌨️ 快捷键: H - 隐藏/显示');
                    }
                    break;

                case 'c':
                    // 节拍器开关
                    e.preventDefault();
                    if (typeof toggleMetronome === 'function') {
                        toggleMetronome();
                        console.log('⌨️ 快捷键: C - 节拍器开关');
                    }
                    break;
            }
        });

        console.log('⌨️ 音程视奏工具快捷键已启用: P=播放 ←→=导航 Space=生成 H=隐藏 C=节拍器');
    </script>

    <!-- 🛡️ 试用保护系统脚本 -->
    <script src="/js/trial-limiter.js?v=20250909"></script>
    <script src="/js/advanced-trial-protection.js?v=20250920"></script>
    <script src="/js/melody-counter-system.js?v=20250920"></script>
    <script src="/js/integrated-trial-manager.js?v=20250920"></script>

</body></html>
