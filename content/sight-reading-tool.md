---
title: "IC 视奏工具"
slug: /sight-reading-tool/
description: 专业级视奏旋律生成器，助力音乐学习者快速提升读谱技能！
image: images/sight-reading-tool.png
categories:
weight: 3
tags:
  - web
draft: false
---

# IC Studio - 专业级视奏旋律生成器

![IC Studio 视奏完整界面](/images/sight-reading-tool-interface.png)

## ✨ 核心特色
- **智能生成逻辑**：旋律虽由算法随机生成，但并非完全无序；它们保持**平衡的旋律线条**与**音乐性**，确保练习曲目既有挑战也具备可听性。 
- **专业乐谱渲染**：基于 OpenSheetMusicDisplay引擎，提供出版级别的清晰乐谱显示。

![生成的乐谱示例](/images/sight-reading-tool-score-example.png)

- **完全自定义**：支持调号、音域、节奏类型、音程跨度、临时记号等多维度个性化设置。

![IC Studio 视奏工具完整界面](/images/sight-reading-tool-full-interface.png)

## 🎹 专业功能
- **24 个大小调支持**：涵盖所有常见调性，以及小调中的**自然小调**、**和声小调**与**旋律小调**的变化处理。  
- **丰富节奏选择**：从全音符到十六分音符，囊括附点、三连音等复杂节奏。

![节奏设置详细配置](/images/sight-reading-tool-rhythm-settings.png)  
- **音程跨度控制**：自由设定旋律的跳进与级进范围，匹配不同学习阶段。  
- **临时记号系统**：智能插入升降号，增加音乐表现力与挑战性。  
- **吉他技巧支持**：重音、断奏、短倚音、击弦、勾弦全面涵盖。

![演奏技巧详细设置](/images/sight-reading-tool-articulations.png)

- **全拍号支持**：完整覆盖 4/4、3/4、6/8等常用拍号，每种拍号皆有独特节奏模式。
- **内置节拍器**：无需额外工具，即可在练习时保持稳定的节奏感。 

## 🔮 未来功能

- **音程视奏**：随机生成有音乐性以及旋律线条的音程，帮助你熟悉指板音程逻辑。
- **和弦视奏**：随机生成 [Guitar voicings](/guitar-voicings/)（三和弦，drop 2，drop 3，shell voicings等），提高你视奏和弦的能力。
- **低音生成器**：随机生成一串低音，可以用来练习四部和声，和弦写作。（之后我会单独出一期视频讲解）
- **和弦进行生成器**：随机生成一串**和弦代号**，乐手可以根据和弦代号自行配和声。
（现在购买可以在未来免费解锁以下功能，之后出了这些功能之后会涨价）
 
## 👩‍🎓 适用人群
- **音乐学生 / 自学者**：快速提升视奏水平。
- **音乐教师**：高效生成教学素材，轻松定制个性化练习内容。

## 🎯 立即行动 
⚡ **早鸟价 48.00¥**（截止于10月01日）—— 现在购买可在未来**免费解锁**更进阶的功能！

<div style="display: flex; gap: 30px; margin: 30px auto; max-width: 1000px; align-items: flex-start; flex-wrap: wrap;">

<div style="flex: 1; min-width: 300px; padding: 25px; background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%); border-radius: 16px; box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1); border: 2px solid #e6edff; text-align: center;">
<div style="margin-bottom: 20px;">
<h3 style="color: #4a5568; margin-bottom: 6px; font-size: 20px;">国内用户购买</h3>
<p style="color: #718096; font-size: 14px; margin: 0;">支持 7 天无理由退款</p>
</div>
<div style="display: flex; gap: 15px; align-items: stretch; justify-content: center;">
<div style="flex: 1; display: flex; flex-direction: column;">
<a href="/tools/sight-reading-generator.html" target="_blank" style="display: block; background: #f8f9fa; color: #667eea; padding: 15px 20px; border: 2px solid #667eea; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 15px; transition: all 0.3s ease; margin-bottom: 8px; text-align: center; flex-grow: 1; min-height: 50px; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='#667eea'; this.style.color='white';" onmouseout="this.style.background='#f8f9fa'; this.style.color='#667eea';">免费试用</a>
<p style="color: #888; font-size: 12px; margin: 0; text-align: center; line-height: 1.3;">10分钟体验<br/>已购用户直接使用</p>
</div>
<div style="flex: 1; display: flex; flex-direction: column;">
<button id="zpay-btn" onclick="window.createZPayment()" style="background: linear-gradient(135deg, #1677FF 0%, #00A0E9 100%); color: white; padding: 15px 20px; border: none; border-radius: 8px; font-weight: 600; font-size: 15px; box-shadow: 0 4px 15px rgba(22, 119, 255, 0.3); transition: all 0.3s ease; cursor: pointer; margin-bottom: 8px; width: 100%; text-align: center; flex-grow: 1; min-height: 50px;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 20px rgba(22, 119, 255, 0.4)';" onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 4px 15px rgba(22, 119, 255, 0.3)';">支付宝支付</button>
<p style="color: #888; font-size: 12px; margin: 0; text-align: center; line-height: 1.3;">¥48.00<br/>早鸟价</p>
</div>
</div>

<!-- 访问码验证区域 -->
<div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #e6edff;">
    <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;">已有访问码？立即使用</h3>
    <p style="color: #888; font-size: 12px; margin: 6; text-align: center; line-height: 1;">可下载电脑软件&查询订单号</p>
    <div style="display: flex; gap: 10px; align-items: center;">
        <input type="text" id="access-code-input" placeholder="输入访问码(11-12位)" 
               style="flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; text-transform: uppercase; transition: border-color 0.3s ease;"
               maxlength="12" oninput="handleInputChange()" onkeyup="handleInputChange()" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#ddd'">
        <button id="verify-btn" onclick="handleVerifyClick()" 
                style="padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: not-allowed; font-weight: 600; font-size: 14px; transition: all 0.3s ease; opacity: 1;"
                onmousedown="this.style.opacity='0.3'; this.style.transform='scale(0.98)'"
                onmouseup="this.style.transform='scale(1)'; setTimeout(() => { this.style.opacity='1'; }, 100)"
                onmouseleave="this.style.transform='scale(1)'; setTimeout(() => { this.style.opacity='1'; }, 100)">
            验证
        </button>
    </div>
    <div id="verify-result" style="margin-top: 15px; font-size: 14px; text-align: center;"></div>
</div>

</div>

<iframe src="https://icstudio3.gumroad.com/l/sight-reading-tools" frameborder="0" width="370" height=500" style="border:0;"></iframe>

</div>

## ❓ 常见问题 FAQ

<div style="max-width: 800px; margin: 30px auto; background: #f9f9f9; padding: 30px; border-radius: 12px;">

### 忘记访问码了怎么办？

 <div style="background: #fff3e0; padding: 20px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #ff9800;">
如果您忘记了访问码，可以通过您的订单号找回：

<div style="margin: 15px 0; text-align: center;">
<button id="recover-access-code-btn" style="
  background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
  color: white;
  border: none;
  padding: 12px 30px;
  border-radius: 8px;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 20px rgba(33, 150, 243, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(33, 150, 243, 0.3)'">
🔍 通过订单号找回访问码
</button>
</div> 

**说明：**
- 订单号或者商家订单号可在支付宝的**账单记录**里找到。
- **商家订单号**格式如 `IC17575395673154298`
- **订单号**格式如 `2025097832001480241441480505`
</div>

### 如何退款？

<div style="background: #e8f5e8; padding: 20px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #4caf50;">
我们理解您可能会遇到各种情况，因此提供 <strong>7天无理由退款政策</strong>：


**退款条件：**
- 购买后7天内可申请退款
- 超过7天不支持退款

**在线退款：**
<div style="margin: 15px 0; text-align: center;">
<button id="refund-btn" style="
  background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
  color: white;
  border: none;
  padding: 12px 30px;
  border-radius: 8px;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(245, 101, 101, 0.3);
" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 20px rgba(245, 101, 101, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(245, 101, 101, 0.3)'">
申请在线退款
</button>
</div>
</div>

### 有其他问题？欢迎联系我！
<div style="background: #e3f2fd; padding: 20px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #2196f3;">
如果您在使用过程中遇到以下任何问题，欢迎通过下面的联系方式联系我，我会尽快为您解决：

- 使用工具时有遇到bug
- 找回访问码不能正常工作
- 退款按钮不能正常工作
- 询问任何其他关于产品的咨询

**联系方式：**
- 邮箱：**service@icstudio.club**  
- 联系页面：[点此访问](/contact/)
- 所有信息将在最多 48 小时内回复
</div>

</div>

<!-- 简化脚本 -->
<!-- CloudBase SDK -->
<script src="https://imgcache.qq.com/qcloud/cloudbase-js-sdk/1.5.0/cloudbase.full.js"></script>

<!-- 统一支付成功处理器 -->
<script src="/js/payment-success-handler.js?v=20250909"></script>

<!-- 试用系统 -->
<script src="/js/trial-limiter.js?v=20250909"></script>
<script src="/js/cloudbase-api.js?v=20250909"></script>

<!-- 支付状态管理器 -->
<script src="/js/payment-state-manager.js?v=20250909"></script>

<!-- 下载处理函数 -->
<script>
function downloadFile(url, filename) {
    console.log('🔽 开始下载文件:', filename);
    console.log('🔗 原始URL:', url);
    
    // 构建完整URL
    const fullUrl = new URL(url, window.location.origin).href;
    console.log('📍 完整URL:', fullUrl);
    
    // 创建临时下载链接元素
    const downloadLink = document.createElement('a');
    downloadLink.href = fullUrl;
    downloadLink.download = filename;
    downloadLink.style.display = 'none';
    
    // 添加到页面
    document.body.appendChild(downloadLink);
    
    try {
        // 触发下载
        downloadLink.click();
        console.log('✅ 下载已启动:', filename);
        showDownloadNotification(filename);
    } catch (error) {
        console.error('❌ 下载失败:', error);
        // 降级到直接打开
        window.open(fullUrl, '_blank');
        showDownloadNotification(filename);
    }
    
    // 清理临时元素
    setTimeout(() => {
        if (downloadLink.parentNode) {
            document.body.removeChild(downloadLink);
        }
    }, 100);
}

function showDownloadNotification(message, type = 'success') {
    // 创建临时通知
    const notification = document.createElement('div');
    const bgColor = type === 'success' ? '#22c55e' : '#ef4444';
    
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${bgColor};
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        z-index: 10000;
        font-size: 14px;
        font-weight: 600;
    `;
    
    if (type === 'success') {
        notification.innerHTML = `🔽 正在下载 ${message}...`;
    } else {
        notification.innerHTML = `❌ ${message}`;
    }
    
    document.body.appendChild(notification);
    
    // 3秒后移除通知
    setTimeout(() => {
        if (notification.parentNode) {
            notification.style.opacity = '0';
            notification.style.transition = 'opacity 0.3s ease';
            setTimeout(() => {
                if (notification.parentNode) {
                    document.body.removeChild(notification);
                }
            }, 300);
        }
    }, 3000);
}

function copyAccessCode(accessCode) {
    console.log('📋 复制访问码:', accessCode);
    
    // 使用现代的Clipboard API
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(accessCode).then(() => {
            showCopyNotification('访问码已复制到剪贴板');
        }).catch(err => {
            console.error('复制失败:', err);
            fallbackCopyTextToClipboard(accessCode);
        });
    } else {
        // 降级方案
        fallbackCopyTextToClipboard(accessCode);
    }
}

function fallbackCopyTextToClipboard(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.top = '0';
    textArea.style.left = '0';
    textArea.style.position = 'fixed';
    
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        const successful = document.execCommand('copy');
        if (successful) {
            showCopyNotification('访问码已复制到剪贴板');
        } else {
            showCopyNotification('复制失败，请手动复制', 'error');
        }
    } catch (err) {
        console.error('Fallback复制失败:', err);
        showCopyNotification('复制失败，请手动复制', 'error');
    }
    
    document.body.removeChild(textArea);
}

function showCopyNotification(message, type = 'success') {
    const notification = document.createElement('div');
    const bgColor = type === 'success' ? '#22c55e' : '#ef4444';
    
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${bgColor};
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        z-index: 10000;
        font-size: 14px;
        font-weight: 600;
    `;
    notification.innerHTML = `📋 ${message}`;
    
    document.body.appendChild(notification);
    
    // 2秒后移除通知
    setTimeout(() => {
        if (notification.parentNode) {
            notification.style.opacity = '0';
            notification.style.transition = 'opacity 0.3s ease';
            setTimeout(() => {
                if (notification.parentNode) {
                    document.body.removeChild(notification);
                }
            }, 300);
        }
    }, 2000);
}

// 访问码验证相关函数
function handleInputChange() {
    const input = document.getElementById('access-code-input');
    const btn = document.getElementById('verify-btn');
    
    if (input.value.trim().length >= 8) {
        btn.style.cursor = 'pointer';
        btn.style.opacity = '1';
        btn.style.background = '#667eea';
    } else {
        btn.style.cursor = 'not-allowed';
        btn.style.opacity = '0.7';
        btn.style.background = '#999';
    }
}

async function handleVerifyClick() {
    const input = document.getElementById('access-code-input');
    const btn = document.getElementById('verify-btn');
    const resultDiv = document.getElementById('verify-result');
    
    const accessCode = input.value.trim().toUpperCase();
    
    if (accessCode.length < 8) {
        resultDiv.innerHTML = '<div style="color: #e74c3c; background: #ffeaa7; padding: 10px; border-radius: 8px;">❌ 请输入有效的访问码</div>';
        return;
    }
    
    // 显示验证中状态
    const originalText = btn.innerHTML;
    btn.innerHTML = '验证中...';
    btn.disabled = true;
    
    try {
        // 调用CloudBase验证函数（复用支付成功时的checkOrderDetails）
        const response = await fetch('https://cloud1-4g1r5ho01a0cfd85-1377702774.ap-shanghai.app.tcloudbase.com/checkOrderDetails', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Request-Source': 'IC-Studio-Access-Verify'
            },
            body: JSON.stringify({
                access_code: accessCode
            })
        });
        
        const result = await response.json();
        console.log('🔍 访问码验证结果:', result);
        
        if (result.success && result.order_data) {
            const orderData = result.order_data;
            
            // 显示验证成功信息和下载选项
            resultDiv.innerHTML = `
                <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; border: 1px solid #4caf50;">
                    <div style="color: #2e7d32; font-weight: bold; margin-bottom: 10px;">
                        ✅ 访问码验证成功！
                    </div>
                    <div style="font-size: 12px; color: #666; margin-bottom: 15px;">
                        订单号：${orderData.orderNumber}<br>
                        购买时间：${new Date(orderData.paymentTime).toLocaleString()}
                    </div>
                    
                    <!-- 下载选项 -->
                    <div style="margin-top: 15px;">
                        <div style="font-weight: bold; margin-bottom: 10px; color: #17a2b8;">
                            📦 下载安装包
                        </div>
                        <button id="show-download-panel-btn" onclick="toggleDownloadPanel()" style="
                            background: #17a2b8;
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 6px;
                            cursor: pointer;
                            font-weight: 600;
                            font-size: 13px;
                            width: 100%;
                            margin-bottom: 10px;
                        ">
                            💻 选择安装包
                        </button>
                        
                        <!-- 下载面板（初始隐藏） -->
                        <div id="download-panel" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 6px; margin-top: 10px;">
                            <div style="text-align: left;">
                                <!-- Windows -->
                                <div style="margin-bottom: 10px;">
                                    <div style="font-weight: bold; font-size: 12px; margin-bottom: 5px; color: #dc3545;">
                                        🖥️ Windows
                                    </div>
                                    <button class="download-platform-btn" data-platform="windows-exe" style="
                                        margin: 2px 3px 2px 0;
                                        padding: 6px 10px;
                                        background: #dc3545;
                                        color: white;
                                        border: none;
                                        border-radius: 4px;
                                        cursor: pointer;
                                        font-size: 10px;
                                        font-weight: 500;
                                    ">
                                        标准版 (140.9MB)
                                    </button>
                                    <button class="download-platform-btn" data-platform="windows-x64" style="
                                        margin: 2px 3px 2px 0;
                                        padding: 6px 10px;
                                        background: #dc3545;
                                        color: white;
                                        border: none;
                                        border-radius: 4px;
                                        cursor: pointer;
                                        font-size: 10px;
                                        font-weight: 500;
                                    ">
                                        优化版 (73.2MB)
                                    </button>
                                </div>
                                
                                <!-- macOS -->
                                <div style="margin-bottom: 10px;">
                                    <div style="font-weight: bold; font-size: 12px; margin-bottom: 5px; color: #6f42c1;">
                                        🍎 macOS
                                    </div>
                                    <button class="download-platform-btn" data-platform="macos-x64-dmg" style="
                                        margin: 2px 3px 2px 0;
                                        padding: 6px 10px;
                                        background: #6f42c1;
                                        color: white;
                                        border: none;
                                        border-radius: 4px;
                                        cursor: pointer;
                                        font-size: 10px;
                                        font-weight: 500;
                                    ">
                                        Intel (DMG)
                                    </button>
                                    <button class="download-platform-btn" data-platform="macos-x64-zip" style="
                                        margin: 2px 3px 2px 0;
                                        padding: 6px 10px;
                                        background: #6f42c1;
                                        color: white;
                                        border: none;
                                        border-radius: 4px;
                                        cursor: pointer;
                                        font-size: 10px;
                                        font-weight: 500;
                                    ">
                                        Intel (ZIP)
                                    </button>
                                    <button class="download-platform-btn" data-platform="macos-arm64-zip" style="
                                        margin: 2px 3px 2px 0;
                                        padding: 6px 10px;
                                        background: #6f42c1;
                                        color: white;
                                        border: none;
                                        border-radius: 4px;
                                        cursor: pointer;
                                        font-size: 10px;
                                        font-weight: 500;
                                    ">
                                        M1/M2/M3 (ZIP)
                                    </button>
                                </div>
                                
                                <!-- Linux -->
                                <div style="margin-bottom: 5px;">
                                    <div style="font-weight: bold; font-size: 12px; margin-bottom: 5px; color: #fd7e14;">
                                        🐧 Linux
                                    </div>
                                    <button class="download-platform-btn" data-platform="linux-deb" style="
                                        margin: 2px 3px 2px 0;
                                        padding: 6px 10px;
                                        background: #fd7e14;
                                        color: white;
                                        border: none;
                                        border-radius: 4px;
                                        cursor: pointer;
                                        font-size: 10px;
                                        font-weight: 500;
                                    ">
                                        DEB包 (70.3MB)
                                    </button>
                                    <button class="download-platform-btn" data-platform="linux-appimage" style="
                                        margin: 2px 3px 2px 0;
                                        padding: 6px 10px;
                                        background: #fd7e14;
                                        color: white;
                                        border: none;
                                        border-radius: 4px;
                                        cursor: pointer;
                                        font-size: 10px;
                                        font-weight: 500;
                                    ">
                                        AppImage (77.6MB)
                                    </button>
                                </div>
                                
                                <div style="font-size: 9px; color: #6c757d; margin-top: 8px; line-height: 1.3;">
                                    💡 <strong>芯片选择说明：</strong><br>
                                    • Intel 芯片 Mac 选择 x64 版本<br>
                                    • Apple Silicon (M1/M2/M3) 选择 arm64 版本
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 绑定下载按钮事件
            bindDownloadEvents(accessCode);
            
        } else {
            resultDiv.innerHTML = `<div style="color: #e74c3c; background: #ffeaa7; padding: 10px; border-radius: 8px;">❌ ${result.error || '访问码无效或已失效'}</div>`;
        }
        
    } catch (error) {
        console.error('❌ 验证失败:', error);
        resultDiv.innerHTML = '<div style="color: #e74c3c; background: #ffeaa7; padding: 10px; border-radius: 8px;">❌ 验证失败，请检查网络连接</div>';
    }
    
    // 恢复按钮状态
    btn.innerHTML = originalText;
    btn.disabled = false;
}

function toggleDownloadPanel() {
    const panel = document.getElementById('download-panel');
    const btn = document.getElementById('show-download-panel-btn');
    
    if (panel.style.display === 'none') {
        panel.style.display = 'block';
        btn.innerHTML = '📦 收起选项';
    } else {
        panel.style.display = 'none';
        btn.innerHTML = '💻 选择安装包';
    }
}

function bindDownloadEvents(accessCode) {
    // 绑定所有下载按钮
    document.querySelectorAll('.download-platform-btn').forEach(btn => {
        btn.onclick = async function() {
            const platform = this.getAttribute('data-platform');
            const originalText = this.innerHTML;
            this.innerHTML = '⏳ 获取...';
            
            try {
                console.log(`📥 开始下载 ${platform} 版本`);
                
                // 调用下载云函数
                const response = await fetch('https://cloud1-4g1r5ho01a0cfd85-1377702774.ap-shanghai.app.tcloudbase.com/downloadInstaller', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Request-Source': 'IC-Studio-Access-Verify'
                    },
                    body: JSON.stringify({
                        access_code: accessCode,
                        platform: platform
                    })
                });
                
                const result = await response.json();
                console.log('📥 下载响应:', result);
                
                if (result.success && result.data && result.data.download_url) {
                    // 创建下载链接
                    const link = document.createElement('a');
                    link.href = result.data.download_url;
                    link.download = result.data.package_info.name;
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // 显示成功状态
                    this.innerHTML = '✅ 下载中';
                    console.log(`🎉 ${result.data.package_info.name} 下载已开始`);
                    
                    showDownloadNotification(result.data.package_info.name);
                    
                } else {
                    throw new Error(result.error || '获取下载链接失败');
                }
            } catch (error) {
                console.error('❌ 下载失败:', error);
                this.innerHTML = '❌ 失败';
                showDownloadNotification('下载失败：' + error.message, 'error');
            }
            
            // 3秒后恢复按钮文本
            setTimeout(() => {
                this.innerHTML = originalText;
            }, 3000);
        };
    });
}

// 绑定弹窗下载按钮事件
function bindPopupDownloadEvents(accessCode) {
    document.querySelectorAll('.popup-download-btn').forEach(btn => {
        btn.onclick = async function() {
            const platform = this.getAttribute('data-platform');
            const originalText = this.innerHTML;
            this.innerHTML = '⏳ 获取链接...';
            this.disabled = true;
            
            try {
                console.log(`📥 弹窗下载 ${platform} 版本`);
                
                // 调用CloudBase downloadInstaller服务
                const response = await fetch('https://cloud1-4g1r5ho01a0cfd85-1377702774.ap-shanghai.app.tcloudbase.com/downloadInstaller', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Request-Source': 'IC-Studio-Success-Popup'
                    },
                    body: JSON.stringify({
                        access_code: accessCode,
                        platform: platform
                    })
                });
                
                const result = await response.json();
                console.log('📥 弹窗下载响应:', result);
                
                if (result.success && result.data && result.data.download_url) {
                    // 创建下载链接
                    const link = document.createElement('a');
                    link.href = result.data.download_url;
                    link.download = result.data.package_info.name;
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // 显示成功状态
                    this.innerHTML = '✅ 下载开始';
                    console.log(`🎉 弹窗下载成功: ${result.data.package_info.name}`);
                    
                    showDownloadNotification(result.data.package_info.name);
                    
                } else {
                    throw new Error(result.error || '获取下载链接失败');
                }
            } catch (error) {
                console.error('❌ 弹窗下载失败:', error);
                this.innerHTML = '❌ 下载失败';
                showDownloadNotification('下载失败：' + error.message, 'error');
            }
            
            // 3秒后恢复按钮状态
            setTimeout(() => {
                this.innerHTML = originalText;
                this.disabled = false;
            }, 3000);
        };
    });
}
</script>

<!-- Z-Pay 简化页面跳转支付实现 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="/js/new-refund-handler.js?v=2.0.0"></script>
<script src="/js/zpay-simple.js?v=1.0.9"></script>

<!-- 支付宝账号查找访问码功能 -->
<script src="/js/alipay-lookup.js?v=1.0.1"></script>

<!-- 试用状态显示区域 -->
<div id="trial-status" style="margin: 20px 0; padding: 15px; border-radius: 8px; background: #f8f9fa; display: none;"></div>

<!-- 调试下载测试 -->

<!-- 样式定义 -->
<style>
.trial-expired {
  text-align: center;
  background: #fff5f5;
  border: 2px solid #fed7d7;
  padding: 20px;
  border-radius: 8px;
}

.trial-expired h3 {
  color: #c53030;
  margin-bottom: 10px;
}

.trial-welcome {
  text-align: center;
  background: #f0fff4;
  border: 2px solid #9ae6b4;
  padding: 20px;
  border-radius: 8px;
}

.trial-welcome h3 {
  color: #2f855a;
  margin-bottom: 10px;
}

.trial-active {
  text-align: center;
  background: #ebf8ff;
  border: 2px solid #90cdf4;
  padding: 15px;
  border-radius: 8px;
}

.trial-active h3 {
  color: #2b6cb0;
  margin-bottom: 10px;
}

.trial-active .warning {
  color: #d69e2e;
  font-weight: 500;
  margin-top: 10px;
}

.upgrade-options {
  margin-top: 20px;
}

.upgrade-btn {
  display: inline-block;
  background: linear-gradient(135deg, #1677FF 0%, #00A0E9 100%);
  color: white !important;
  padding: 15px 30px;
  border-radius: 12px;
  text-decoration: none !important;
  font-weight: 600;
  box-shadow: 0 8px 25px rgba(22, 119, 255, 0.3);
  transition: all 0.3s ease;
}

.upgrade-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 35px rgba(22, 119, 255, 0.4);
}

.upgrade-btn.primary {
  font-size: 16px;
}

.note {
  font-size: 12px;
  color: #666;
  margin-top: 10px;
}

.trial-warning-popup {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
}

.warning-content {
  background: white;
  padding: 30px;
  border-radius: 12px;
  max-width: 400px;
  text-align: center;
  box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
}

.warning-buttons {
  margin-top: 20px;
  display: flex;
  gap: 15px;
  justify-content: center;
}

.btn-secondary, .btn-primary {
  padding: 10px 20px;
  border-radius: 6px;
  text-decoration: none;
  font-weight: 500;
  cursor: pointer;
  border: none;
  transition: all 0.3s ease;
}

.btn-secondary {
  background: #f7fafc;
  color: #2d3748;
  border: 1px solid #e2e8f0;
}

.btn-primary {
  background: #667eea;
  color: white;
}

.btn-secondary:hover {
  background: #edf2f7;
}

.btn-primary:hover {
  background: #5a6fd8;
}

/* 响应式设计 */
@media (max-width: 768px) {
  .trial-warning-popup .warning-content {
    margin: 20px;
    padding: 20px;
  }
  
  .warning-buttons {
    flex-direction: column;
  }
}
</style>

<script>
// 页面加载完成后显示试用状态
document.addEventListener('DOMContentLoaded', function() {
  const statusElement = document.getElementById('trial-status');
  if (statusElement) {
    statusElement.style.display = 'block';
  }
  
});



// 显示状态信息
function showStatus(message, type) {
  console.log(`[状态] ${message} (类型: ${type})`);
  // 可以在这里添加更多的状态显示逻辑
}

// 等待Z-Pay支付系统完全加载
document.addEventListener('DOMContentLoaded', function() {
  console.log('✅ 页面加载完成，支付系统已就绪');
  
  // 检查支付回调参数
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get('out_trade_no') || urlParams.get('trade_no')) {
    console.log('🎉 检测到支付回调');
    // 这里可以处理支付成功后的逻辑
    if (window.showUnifiedPaymentSuccess) {
      const accessCode = generateRandomCode();
      window.showUnifiedPaymentSuccess(accessCode, 'zpay-success');
    }
  }
  
  // 检查Z-Pay支付系统是否加载
  if (typeof window.createZPayment === 'function') {
    console.log('✅ Z-Pay支付系统已加载');
  } else {
    console.warn('⚠️ Z-Pay支付系统未加载');
  }
});

// 生成随机访问码
function generateRandomCode() {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let code = '';
  for (let i = 0; i < 12; i++) {
    code += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return code;
}

// 处理输入变化（借鉴 sight-reading-generator.html 的风格）
function handleInputChange() {
    const input = document.getElementById('access-code-input');
    const button = document.getElementById('verify-btn');
    
    if (input && button) {
        const code = input.value.trim();
        const isValid = code.length >= 11 && code.length <= 12 && /^[A-Z0-9]+$/.test(code);
        
        // 修改透明度逻辑：输入框为空或有效时都保持完全不透明
        button.dataset.valid = isValid;
        button.style.opacity = '1'; // 始终保持完全不透明
        button.style.cursor = isValid ? 'pointer' : 'not-allowed';
        button.style.background = '#667eea';
        
        console.log('🔄 输入变化处理:', { code, isValid });
    }
}

// 处理验证按钮点击
function handleVerifyClick() {
    console.log('🎯 验证按钮被点击');
    const button = document.getElementById('verify-btn');
    
    if (!button) {
        console.error('❌ 找不到验证按钮');
        return;
    }
    
    const isValid = button.dataset.valid === 'true';
    console.log('🔍 按钮状态检查:', { isValid });
    
    if (!isValid) {
        console.log('⚠️ 按钮处于禁用状态，不执行验证');
        const resultDiv = document.getElementById('verify-result');
        if (resultDiv) {
            resultDiv.innerHTML = '<span style="color: #e74c3c;">❌ 请输入有效的11-12位访问码</span>';
        }
        return;
    }
    
    // 执行验证
    console.log('✅ 开始执行访问码验证');
    verifyAccessCodeWithServer();
}

// 保持旧函数兼容性
function updateVerifyButton() {
    handleInputChange();
}

// 测试验证功能
function testVerifyFunction() {
    console.log('🧪 测试验证功能...');
    const input = document.getElementById('access-code-input');
    const resultDiv = document.getElementById('verify-result');
    
    if (input && resultDiv) {
        input.value = 'VTTBY9XCFTQY';
        handleInputChange(); // 更新按钮状态
        resultDiv.innerHTML = '<span style="color: #27ae60;">🧪 测试模式 - 访问码已填入，按钮现在应该可以点击了</span>';
        console.log('✅ 已填入测试访问码，按钮状态已更新');
        
        // 给出明确的测试说明
        setTimeout(() => {
            resultDiv.innerHTML = '<span style="color: #3498db;">💡 现在点击"验证"按钮测试功能</span>';
        }, 2000);
    }
}

// 使用服务器端验证访问码
async function verifyAccessCodeWithServer() {
    const input = document.getElementById('access-code-input');
    const resultDiv = document.getElementById('verify-result');
    const button = document.getElementById('verify-btn');
    
    if (!input || !resultDiv) {
        console.error('❌ 找不到必要的页面元素');
        return;
    }
    
    const code = input.value.trim().toUpperCase();
    if (!code) {
        resultDiv.innerHTML = '<span style="color: #e74c3c;">❌ 请输入访问码</span>';
        return;
    }
    
    if (code.length !== 12 && code.length !== 11) {
        resultDiv.innerHTML = '<span style="color: #e74c3c;">❌ 访问码必须是11-12位</span>';
        return;
    }
    
    if (!/^[A-Z0-9]+$/.test(code)) {
        resultDiv.innerHTML = '<span style="color: #e74c3c;">❌ 访问码只能包含字母和数字</span>';
        return;
    }

    // 禁用按钮防止重复点击
    button.disabled = true;
    button.style.opacity = '0.5';
    resultDiv.innerHTML = '<span style="color: #3498db;">🔄 正在验证访问码...</span>';

    try {
        // 等待 PaymentStateManager 加载
        if (!window.paymentManager) {
            resultDiv.innerHTML = '<span style="color: #f39c12;">⏳ 正在加载验证系统...</span>';
            
            // 等待最多5秒让PaymentStateManager加载
            let attempts = 0;
            while (!window.paymentManager && attempts < 50) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            if (!window.paymentManager) {
                throw new Error('验证系统加载超时，请刷新页面重试');
            }
        }
        
        console.log('🔍 使用 PaymentStateManager 验证访问码:', code);
        resultDiv.innerHTML = '<span style="color: #3498db;">🔄 正在服务器验证...</span>';
        
        const result = await window.paymentManager.verifyAccessCode(code, true);
        
        if (result.success) {
            console.log('✅ 访问码验证成功:', result.data);
            resultDiv.innerHTML = '<span style="color: #27ae60;">✅ 访问码验证成功！</span>';
            
            // 重新启用按钮
            button.disabled = false;
            button.style.opacity = '1';
            
            // 延迟显示弹窗，让用户看到成功消息
            setTimeout(() => {
                showPaymentSuccessPopup(code, result.data);
            }, 800);
            
        } else {
            console.log('❌ 访问码验证失败:', result.error);
            resultDiv.innerHTML = `<span style="color: #e74c3c;">❌ ${result.error}</span>`;
            button.disabled = false;
            button.style.opacity = '1';
        }
    } catch (error) {
        console.error('验证访问码失败:', error);
        resultDiv.innerHTML = `<span style="color: #e74c3c;">❌ ${error.message || '验证失败，请稍后重试'}</span>`;
        button.disabled = false;
        button.style.opacity = '1';
    }
}

// 显示支付成功弹窗
function showPaymentSuccessPopup(accessCode, orderData) {
    // 创建弹窗HTML
    const popup = document.createElement('div');
    popup.id = 'success-popup';
    popup.innerHTML = `
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;">
            <div style="background: white; padding: 40px; border-radius: 16px; max-width: 500px; width: 90%; text-align: center; box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);">
                <div style="margin-bottom: 30px;">
                    <div style="width: 80px; height: 80px; background: #4CAF50; border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 48px;">✓</div>
                    <h2 style="color: #333; margin-bottom: 10px;">🎉 访问验证成功！</h2>
                    <p style="color: #666; font-size: 16px; margin-bottom: 0;">您的访问码已验证，现在可以使用完整版功能</p>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 30px; text-align: left;">
                    <h3 style="color: #333; margin-bottom: 15px; text-align: center;">📋 验证信息</h3>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center;">
                        <span style="color: #666;">访问码：</span>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-family: monospace; font-weight: bold; background: #f1f5f9; padding: 4px 8px; border-radius: 4px; border: 1px solid #e2e8f0;">${accessCode}</span>
                            <button onclick="copyAccessCode('${accessCode}')" 
                                    style="background: #3b82f6; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s ease;"
                                    onmouseover="this.style.background='#2563eb'"
                                    onmouseout="this.style.background='#3b82f6'"
                                    title="复制访问码">
                                📋
                            </button>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="color: #666;">产品：</span>
                        <span>${orderData.product_name || 'IC Studio 视奏工具'}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="color: #666;">验证时间：</span>
                        <span>${new Date().toLocaleString()}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #666;">订单号：</span>
                        <span style="font-family: monospace; background: #f1f5f9; padding: 4px 8px; border-radius: 4px; border: 1px solid #e2e8f0;">${(orderData.order_info?.out_trade_no) || (orderData.order_info?.order_id) || orderData.out_trade_no || orderData.order_id || orderData.orderId || '暂无'}</span>
                    </div>
                </div>

                <div style="margin-bottom: 30px;">
                    <h3 style="color: #333; margin-bottom: 20px;">📦 下载安装包</h3>
                    <div style="display: grid; gap: 10px;">
                        <button class="popup-download-btn" data-platform="windows-x64"
                               style="display: block; background: #f0f9ff; color: #1e40af; padding: 12px 20px; border: 2px solid #93c5fd; border-radius: 8px; text-decoration: none; font-weight: 600; transition: all 0.3s ease; cursor: pointer; border: none; width: 100%;"
                               onmouseover="this.style.background='#1e40af'; this.style.color='white';" 
                               onmouseout="this.style.background='#f0f9ff'; this.style.color='#1e40af';">
                            💻 Windows x64 (73.2MB)
                        </button>
                        <button class="popup-download-btn" data-platform="macos-x64-dmg"
                               style="display: block; background: #f0fdf4; color: #166534; padding: 12px 20px; border: 2px solid #86efac; border-radius: 8px; text-decoration: none; font-weight: 600; transition: all 0.3s ease; cursor: pointer; border: none; width: 100%;"
                               onmouseover="this.style.background='#166534'; this.style.color='white';" 
                               onmouseout="this.style.background='#f0fdf4'; this.style.color='#166534';">
                            🍎 macOS Intel (DMG - 86.2MB)
                        </button>
                        <button class="popup-download-btn" data-platform="macos-arm64-zip"
                               style="display: block; background: #fef3c7; color: #92400e; padding: 12px 20px; border: 2px solid #fbbf24; border-radius: 8px; text-decoration: none; font-weight: 600; transition: all 0.3s ease; cursor: pointer; border: none; width: 100%;"
                               onmouseover="this.style.background='#92400e'; this.style.color='white';" 
                               onmouseout="this.style.background='#fef3c7'; this.style.color='#92400e';">
                            🍎 macOS Apple Silicon (ZIP - 86.6MB)
                        </button>
                        <button class="popup-download-btn" data-platform="linux-appimage"
                               style="display: block; background: #ede9fe; color: #6b21a8; padding: 12px 20px; border: 2px solid #c084fc; border-radius: 8px; text-decoration: none; font-weight: 600; transition: all 0.3s ease; cursor: pointer; border: none; width: 100%;"
                               onmouseover="this.style.background='#6b21a8'; this.style.color='white';" 
                               onmouseout="this.style.background='#ede9fe'; this.style.color='#6b21a8';">
                            🐧 Linux (AppImage - 77.6MB)
                        </button>
                    </div>
                    <p style="font-size: 12px; color: #888; margin-top: 15px;">下载完成后，使用以上访问码激活完整版功能</p>
                </div>

                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button onclick="closeSuccessPopup()" 
                            style="padding: 15px 30px; background: #f8f9fa; color: #333; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;"
                            onmouseover="this.style.background='#e2e8f0'" 
                            onmouseout="this.style.background='#f8f9fa'">
                        稍后使用
                    </button>
                    <button onclick="goToSightReadingTool()" 
                            style="padding: 15px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); transition: all 0.3s ease;"
                            onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.4)'" 
                            onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.3)'">
                        🚀 开始使用
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(popup);
    
    // 绑定弹窗下载按钮事件
    bindPopupDownloadEvents(accessCode);
}

// 关闭成功弹窗
function closeSuccessPopup() {
    const popup = document.getElementById('success-popup');
    if (popup) {
        popup.remove();
    }
}

// 前往视奏工具页面
function goToSightReadingTool() {
    closeSuccessPopup();
    // 跳转到完整版视奏工具页面
    window.open('/tools/sight-reading-generator.html', '_blank');
}

// 确保所有功能在DOM加载后就绪
document.addEventListener('DOMContentLoaded', function() {
    console.log('🔧 IC Studio 视奏工具页面初始化开始...');
    
    // 检查关键元素
    const input = document.getElementById('access-code-input');
    const button = document.getElementById('verify-btn');
    const resultDiv = document.getElementById('verify-result');
    
    if (!input || !button || !resultDiv) {
        console.error('❌ 关键页面元素缺失');
        return;
    }
    
    console.log('✅ 页面元素检查通过');
    
    // 确保按钮初始状态正确
    handleInputChange();
    
    // 检查PaymentStateManager状态
    function checkPaymentManager() {
        if (window.paymentManager) {
            console.log('✅ PaymentStateManager 已就绪');
            
            // 检查是否有已支付状态
            const hasPaid = window.paymentManager.hasPaidAccess();
            if (hasPaid) {
                console.log('🎉 检测到已支付状态');
                const accessCode = window.paymentManager.getCurrentAccessCode();
                if (accessCode) {
                    console.log('💡 当前访问码:', accessCode);
                }
            }
        } else {
            console.log('⏳ 等待 PaymentStateManager 加载...');
            setTimeout(checkPaymentManager, 500);
        }
    }
    
    // 延迟检查PaymentStateManager（给脚本加载时间）
    setTimeout(checkPaymentManager, 1000);
    
    console.log('🎯 访问码验证功能已初始化完成');
    console.log('💡 现在可以输入有效的访问码进行验证了');
    console.log('🧪 测试功能: testVerifyFunction() - 自动填入测试访问码');
});

// 退款功能已移至 /js/refund-handler.js

// 暴露测试函数到全局作用域
window.testVerifyFunction = testVerifyFunction;

// 测试函数已移至 refund-handler.js

</script>