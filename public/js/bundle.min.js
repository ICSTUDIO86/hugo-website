/**
 * IC è§†å¥å·¥å…· - è®¾å¤‡çº§åˆ«è¯•ç”¨é™åˆ¶
 * æ¯å°è®¾å¤‡é™åˆ¶è¯•ç”¨ 10 åˆ†é’Ÿ
 */

class TrialLimiter {
  constructor() {
    this.storageKey = 'ic-sight-reading-trial';
    this.trialDuration = 10 * 60 * 1000; // 10 åˆ†é’Ÿï¼ˆæ¯«ç§’ï¼‰
    this.deviceId = this.generateDeviceId();
    this.warningShown = false;
  }

  // ç”Ÿæˆè®¾å¤‡å”¯ä¸€æ ‡è¯†ï¼ˆå¢å¼ºç‰ˆï¼‰
  generateDeviceId() {
    let deviceId = localStorage.getItem('ic-device-id');
    if (!deviceId) {
      // å¢å¼ºçš„è®¾å¤‡æŒ‡çº¹
      const fingerprint = this.generateDeviceFingerprint();
      deviceId = this.hashCode(fingerprint).toString(36);
      
      // å¤šå±‚å­˜å‚¨é˜²æŠ¤
      localStorage.setItem('ic-device-id', deviceId);
      sessionStorage.setItem('ic-device-id-session', deviceId);
      
      // è®¾ç½®ä¸€ä¸ªéšè—çš„ cookie ä½œä¸ºå¤‡ç”¨éªŒè¯
      document.cookie = `ic_device_backup=${deviceId}; path=/; max-age=${365*24*60*60}; SameSite=Strict`;
    }
    return deviceId;
  }

  // ç”Ÿæˆå¢å¼ºçš„è®¾å¤‡æŒ‡çº¹
  generateDeviceFingerprint() {
    const fp = [];
    
    // åŸºç¡€æµè§ˆå™¨ä¿¡æ¯
    fp.push(navigator.userAgent);
    fp.push(navigator.language);
    fp.push(navigator.languages?.join(',') || 'unknown');
    fp.push(navigator.platform);
    fp.push(navigator.cookieEnabled);
    
    // å±å¹•ä¿¡æ¯
    fp.push(screen.width + 'x' + screen.height);
    fp.push(screen.colorDepth);
    fp.push(screen.pixelDepth);
    fp.push(window.devicePixelRatio || 'unknown');
    
    // æ—¶åŒºå’Œåœ°ç†ä¿¡æ¯
    fp.push(Intl.DateTimeFormat().resolvedOptions().timeZone);
    fp.push(new Date().getTimezoneOffset());
    
    // ç¡¬ä»¶ä¿¡æ¯
    fp.push(navigator.hardwareConcurrency || 'unknown');
    fp.push(navigator.maxTouchPoints || 0);
    fp.push(navigator.deviceMemory || 'unknown');
    
    // WebGL æŒ‡çº¹
    const webglFingerprint = this.getWebGLFingerprint();
    fp.push(webglFingerprint);
    
    // Canvas æŒ‡çº¹
    const canvasFingerprint = this.getCanvasFingerprint();
    fp.push(canvasFingerprint);
    
    // éŸ³é¢‘ä¸Šä¸‹æ–‡æŒ‡çº¹
    const audioFingerprint = this.getAudioFingerprint();
    fp.push(audioFingerprint);
    
    return fp.join('|');
  }

  // Canvas æŒ‡çº¹
  getCanvasFingerprint() {
    try {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      
      // ç»˜åˆ¶å¤æ‚å›¾å½¢
      ctx.textBaseline = 'top';
      ctx.font = '14px Arial';
      ctx.fillStyle = '#f60';
      ctx.fillRect(125, 1, 62, 20);
      ctx.fillStyle = '#069';
      ctx.fillText('IC Studio ğŸµ', 2, 15);
      ctx.fillStyle = 'rgba(102, 204, 0, 0.7)';
      ctx.fillText('Device Fingerprint', 4, 45);
      
      // æ·»åŠ ä¸€äº›å‡ ä½•å›¾å½¢
      ctx.globalCompositeOperation = 'multiply';
      ctx.fillStyle = 'rgb(255,0,255)';
      ctx.beginPath();
      ctx.arc(50, 50, 50, 0, Math.PI * 2, true);
      ctx.closePath();
      ctx.fill();
      
      return canvas.toDataURL().slice(-50); // åªå–æœ€å50ä¸ªå­—ç¬¦
    } catch (e) {
      return 'canvas_error';
    }
  }

  // WebGL æŒ‡çº¹
  getWebGLFingerprint() {
    try {
      const canvas = document.createElement('canvas');
      const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
      
      if (!gl) return 'no_webgl';
      
      const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
      if (debugInfo) {
        const vendor = gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL);
        const renderer = gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL);
        return `${vendor}_${renderer}`;
      }
      
      return gl.getParameter(gl.VERSION);
    } catch (e) {
      return 'webgl_error';
    }
  }

  // éŸ³é¢‘ä¸Šä¸‹æ–‡æŒ‡çº¹
  getAudioFingerprint() {
    try {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const analyser = audioContext.createAnalyser();
      const gainNode = audioContext.createGain();
      
      oscillator.type = 'triangle';
      oscillator.frequency.value = 10000;
      gainNode.gain.value = 0.05;
      
      oscillator.connect(analyser);
      analyser.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.start();
      
      const frequencyData = new Uint8Array(analyser.frequencyBinCount);
      analyser.getByteFrequencyData(frequencyData);
      
      oscillator.stop();
      audioContext.close();
      
      return frequencyData.slice(0, 30).join(',');
    } catch (e) {
      return 'audio_error';
    }
  }

  // ç®€å•å“ˆå¸Œå‡½æ•°
  hashCode(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
      const char = str.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash = hash & hash; // è½¬æ¢ä¸º32ä½æ•´æ•°
    }
    return Math.abs(hash);
  }

  // æ£€æŸ¥è¯•ç”¨çŠ¶æ€ï¼ˆå¢å¼ºé˜²ä½œå¼Šç‰ˆæœ¬ï¼‰
  checkTrialStatus() {
    const trialData = this.getTrialData();
    const now = Date.now();

    // æ£€æŸ¥æ˜¯å¦åœ¨è±å…æœŸå†…
    const exemptTime = localStorage.getItem('ic-anticheat-exempt');
    const inExemptPeriod = exemptTime && (Date.now() - parseInt(exemptTime) < 5 * 60 * 1000);
    
    // åªæœ‰åœ¨éè±å…æœŸå†…æ‰è¿›è¡Œåä½œå¼Šæ£€æµ‹
    if (!inExemptPeriod && this.detectCheating(trialData)) {
      console.warn('ğŸš¨ æ£€æµ‹åˆ°æ½œåœ¨çš„ä½œå¼Šè¡Œä¸º');
      return { 
        allowed: false, 
        remaining: 0,
        expired: true,
        reason: 'security_violation'
      };
    }

    if (!trialData.startTime) {
      // é¦–æ¬¡ä½¿ç”¨ï¼Œè®°å½•å¼€å§‹æ—¶é—´
      this.startTrial();
      return { 
        allowed: true, 
        remaining: this.trialDuration,
        isFirstTime: true,
        inExemptPeriod 
      };
    }

    const elapsed = now - trialData.startTime;
    const remaining = Math.max(0, this.trialDuration - elapsed);

    // éªŒè¯æ—¶é—´åˆç†æ€§
    if (elapsed < 0) {
      console.warn('ğŸš¨ æ£€æµ‹åˆ°æ—¶é—´å¼‚å¸¸');
      this.startTrial(); // é‡æ–°å¼€å§‹
      return { 
        allowed: true, 
        remaining: this.trialDuration,
        isFirstTime: true,
        inExemptPeriod 
      };
    }

    // å¦‚æœåœ¨è±å…æœŸå†…ï¼Œå³ä½¿è¯•ç”¨æ—¶é—´åˆ°äº†ä¹Ÿå…è®¸ç»§ç»­ä½¿ç”¨
    if (remaining <= 0 && !inExemptPeriod) {
      // è®°å½•è¯•ç”¨ç»“æŸ
      this.recordTrialEnd();
      return { 
        allowed: false, 
        remaining: 0,
        expired: true,
        inExemptPeriod 
      };
    }

    // å¦‚æœåœ¨è±å…æœŸå†…ä¸”è¯•ç”¨æ—¶é—´åˆ°äº†ï¼Œæ˜¾ç¤ºä¸ºå‰©ä½™æ—¶é—´ä½†å…è®¸ç»§ç»­ä½¿ç”¨
    if (remaining <= 0 && inExemptPeriod) {
      console.log('ğŸ›¡ï¸ è±å…æœŸå†…ï¼Œå»¶é•¿è¯•ç”¨æ—¶é—´');
      return {
        allowed: true,
        remaining: 60000, // æ˜¾ç¤ºè¿˜æœ‰1åˆ†é’Ÿï¼Œå®é™…åœ¨è±å…æœŸå†…
        inExemptPeriod,
        exemptMode: true
      };
    }

    return { 
      allowed: true, 
      remaining,
      elapsed,
      inExemptPeriod 
    };
  }

  // åä½œå¼Šæ£€æµ‹
  detectCheating(trialData) {
    try {
      // æ£€æŸ¥è±å…æœŸï¼ˆé¿å…é‡ç½®åè¯¯åˆ¤ï¼‰
      const exemptTime = localStorage.getItem('ic-anticheat-exempt');
      
      if (exemptTime) {
        const exemptStart = parseInt(exemptTime);
        const exemptDuration = 5 * 60 * 1000; // 5åˆ†é’Ÿè±å…æœŸ
        const timeElapsed = Date.now() - exemptStart;
        
        if (timeElapsed < exemptDuration) {
          return false; // è±å…æœŸå†…ï¼Œè·³è¿‡æ£€æµ‹
        } else {
          // è±å…æœŸç»“æŸï¼Œæ¸…ç†æ ‡è®°
          localStorage.removeItem('ic-anticheat-exempt');
        }
      }
      // æ£€æµ‹1ï¼šéªŒè¯è®¾å¤‡IDä¸€è‡´æ€§
      const currentDeviceId = this.generateDeviceId();
      if (trialData.deviceId && trialData.deviceId !== currentDeviceId) {
        console.log('âš ï¸ è®¾å¤‡IDä¸åŒ¹é…:', { stored: trialData.deviceId, current: currentDeviceId });
        return true;
      }

      // æ£€æµ‹2ï¼šæ£€æŸ¥å¤šé‡å­˜å‚¨ä¸€è‡´æ€§
      const sessionId = sessionStorage.getItem('ic-device-id-session');
      const cookieId = this.getCookieValue('ic_device_backup');
      if (sessionId && sessionId !== currentDeviceId) {
        return true;
      }
      if (cookieId && cookieId !== currentDeviceId) {
        return true;
      }

      // æ£€æµ‹3ï¼šæ—¶é—´ç¯¡æ”¹æ£€æµ‹
      if (trialData.startTime && trialData.startTime > Date.now()) {
        console.warn('âš ï¸ æ£€æµ‹åˆ°æœªæ¥æ—¶é—´æˆ³');
        return true;
      }

      // æ£€æµ‹4ï¼šé¢‘ç¹é‡ç½®æ£€æµ‹
      const resetCount = parseInt(localStorage.getItem('ic-reset-count') || '0');
      if (resetCount > 3) {
        console.warn('âš ï¸ é¢‘ç¹é‡ç½®æ£€æµ‹');
        return true;
      }

      return false;
    } catch (error) {
      console.error('åä½œå¼Šæ£€æµ‹å¼‚å¸¸:', error);
      return false;
    }
  }

  // è·å–Cookieå€¼
  getCookieValue(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
  }

  // è®°å½•è¯•ç”¨ç»“æŸ
  recordTrialEnd() {
    const endData = {
      endTime: Date.now(),
      deviceId: this.deviceId,
      userAgent: navigator.userAgent.slice(0, 100)
    };
    localStorage.setItem('ic-trial-end', JSON.stringify(endData));
  }

  // å¼€å§‹è¯•ç”¨
  startTrial() {
    const trialData = {
      deviceId: this.deviceId,
      startTime: Date.now(),
      version: '1.0'
    };
    localStorage.setItem(this.storageKey, JSON.stringify(trialData));
  }

  // è·å–è¯•ç”¨æ•°æ®
  getTrialData() {
    try {
      const data = localStorage.getItem(this.storageKey);
      return data ? JSON.parse(data) : {};
    } catch (error) {
      console.error('è¯»å–è¯•ç”¨æ•°æ®å¤±è´¥:', error);
      return {};
    }
  }

  // æ ¼å¼åŒ–å‰©ä½™æ—¶é—´
  formatTime(milliseconds) {
    const minutes = Math.floor(milliseconds / 60000);
    const seconds = Math.floor((milliseconds % 60000) / 1000);
    return `${minutes}:${seconds.toString().padStart(2, '0')}`;
  }

  // æ˜¾ç¤ºè¯•ç”¨çŠ¶æ€ - å®Œå…¨é‡æ„é¿å…æ¸…ç©ºè¾“å…¥æ¡†
  showTrialStatus(status) {
    const statusElement = document.getElementById('trial-status');
    if (!statusElement) return;
  
    // ã€æ–°æ–¹æ¡ˆã€‘ä½¿ç”¨ç‹¬ç«‹çš„çŠ¶æ€æ˜¾ç¤ºå’Œè¾“å…¥åŒºåŸŸï¼Œé¿å…HTMLé‡æ–°ç”Ÿæˆ
    this.updateTrialStatusDisplay(status);
    this.ensureAccessCodeArea();
  }

  // æ›´æ–°è¯•ç”¨çŠ¶æ€æ˜¾ç¤ºï¼ˆä¸å½±å“è¾“å…¥æ¡†ï¼‰
  updateTrialStatusDisplay(status) {
    const statusElement = document.getElementById('trial-status');
    if (!statusElement) return;

    // æŸ¥æ‰¾æˆ–åˆ›å»ºçŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ
    let statusDisplayDiv = statusElement.querySelector('#trial-status-display');
    if (!statusDisplayDiv) {
      statusDisplayDiv = document.createElement('div');
      statusDisplayDiv.id = 'trial-status-display';
      statusElement.appendChild(statusDisplayDiv);
    }

    // åªæ›´æ–°çŠ¶æ€æ˜¾ç¤ºå†…å®¹ï¼Œä¸è§¦ç¢°è¾“å…¥åŒºåŸŸ
    let statusContent = '';
    
    if (status.inExemptPeriod) {
      const remaining = this.formatTime(status.remaining);
      statusContent = `
        <div class="trial-active">
          <h3>â° è¯•ç”¨å‰©ä½™æ—¶é—´ï¼š<strong>${remaining}</strong></h3>
        </div>
      `;
    } else if (status.expired) {
      statusContent = `
        <div class="trial-expired">
          <h3 style="color: #e74c3c;">ğŸ˜” å…è´¹è¯•ç”¨æ—¶é—´å·²ç”¨å®Œ</h3>
          <p style="color: #e74c3c;">æ¯å°è®¾å¤‡å¯å…è´¹è¯•ç”¨ 10 åˆ†é’Ÿ</p>
        </div>
      `;
    } else if (status.isFirstTime) {
      statusContent = `
        <div class="trial-welcome">
          <h3>ğŸ‰ æ¬¢è¿è¯•ç”¨ IC è§†å¥å·¥å…·ï¼</h3>
          <p>æ‚¨æœ‰ <strong>10 åˆ†é’Ÿ</strong> çš„å…è´¹è¯•ç”¨æ—¶é—´</p>
        </div>
      `;
    } else {
      const remaining = this.formatTime(status.remaining);
      statusContent = `
        <div class="trial-active">
          <h3>â° è¯•ç”¨å‰©ä½™æ—¶é—´ï¼š<strong>${remaining}</strong></h3>
        </div>
      `;
    }

    statusDisplayDiv.innerHTML = statusContent;
  }

  // ç¡®ä¿è®¿é—®ç åŒºåŸŸå­˜åœ¨ï¼ˆåªåˆ›å»ºä¸€æ¬¡ï¼Œä¸é‡å¤åˆ›å»ºï¼‰
  ensureAccessCodeArea() {
    const statusElement = document.getElementById('trial-status');
    if (!statusElement) return;

    // æ£€æŸ¥æ˜¯å¦å·²æœ‰è®¿é—®ç åŒºåŸŸ
    let accessCodeDiv = statusElement.querySelector('#access-code-area');
    if (accessCodeDiv) {
      return; // å·²å­˜åœ¨ï¼Œä¸éœ€è¦é‡æ–°åˆ›å»º
    }

    // åˆ›å»ºè®¿é—®ç åŒºåŸŸï¼ˆåªåˆ›å»ºä¸€æ¬¡ï¼‰
    accessCodeDiv = document.createElement('div');
    accessCodeDiv.id = 'access-code-area';
    accessCodeDiv.style.marginTop = '20px';
    
    accessCodeDiv.innerHTML = `
      <h3 style="color: #667eea; margin-bottom: 10px;">è¾“å…¥è®¿é—®ç </h3>
      <div style="display: flex; gap: 10px; align-items: center;">
        <input type="text" id="access-code-input" placeholder="è¾“å…¥è®¿é—®ç (11-12ä½)" 
               style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; text-transform: uppercase;"
               maxlength="12">
        <button onclick="directVerifyCode()" 
                style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
          éªŒè¯
        </button>
      </div>
      <div id="verify-result" style="margin-top: 10px; font-size: 14px;"></div>
      <div style="text-align: center;">
        <button id="forgot-code-btn" 
                onclick="showForgotCodeDialog()" 
                style="background: none; border: none; color: #888; font-size: 14px; text-decoration: underline; cursor: pointer; padding: 8px; transition: color 0.3s ease;"
                onmouseover="this.style.color='#667eea';"
                onmouseout="this.style.color='#888';">
          å¿˜è®°è®¿é—®ç ï¼Ÿç‚¹å‡»æ‰¾å›
        </button>
      </div>
    `;

    statusElement.appendChild(accessCodeDiv);
    console.log('âœ… è®¿é—®ç è¾“å…¥åŒºåŸŸå·²åˆ›å»ºï¼ˆä¸€æ¬¡æ€§ï¼‰');
  }

  // åˆå§‹åŒ–è¯•ç”¨é™åˆ¶å™¨
  async init() {
    const status = this.checkTrialStatus();
    
    // æœåŠ¡å™¨ç«¯éªŒè¯ï¼ˆå¦‚æœæœ‰CloudBase APIï¼‰
    if (window.cloudbaseAPI && status.allowed) {
      try {
        await this.validateTrialWithServer();
      } catch (error) {
        console.warn('æœåŠ¡å™¨ç«¯éªŒè¯å¤±è´¥:', error.message);
      }
    }
    
    if (!status.allowed) {
      this.blockAccess(status.reason);
      return false;
    }

    // ç¡®ä¿è¯•ç”¨æœŸé—´å·¥å…·å¯ç”¨ - å»¶è¿Ÿè°ƒç”¨ç¡®ä¿DOMå®Œå…¨åŠ è½½
    setTimeout(() => {
      this.ensureToolAccess();
      console.log('ğŸ”„ é¡µé¢åŠ è½½åè‡ªåŠ¨å¯ç”¨è¯•ç”¨å·¥å…·');
    }, 100);
    
    this.showTrialStatus(status);
    this.startTimer(status.remaining);
    return true;
  }

  // æœåŠ¡å™¨ç«¯è¯•ç”¨éªŒè¯
  async validateTrialWithServer() {
    try {
      const trialData = this.getTrialData();
      const validationData = {
        action: 'validate_trial',
        device_id: this.deviceId,
        trial_start: trialData.startTime,
        user_agent: navigator.userAgent.slice(0, 100),
        timestamp: Date.now()
      };

      // è°ƒç”¨æœåŠ¡å™¨éªŒè¯
      const result = await window.cloudbaseAPI.httpRequest('/validate-trial', validationData);
      
      if (result.code !== 200) {
        console.warn('æœåŠ¡å™¨ç«¯è¯•ç”¨éªŒè¯å¤±è´¥:', result.message);
        // å¯ä»¥æ ¹æ®éœ€è¦å†³å®šæ˜¯å¦å¼ºåˆ¶ç»“æŸè¯•ç”¨
      }
    } catch (error) {
      console.error('æœåŠ¡å™¨ç«¯éªŒè¯å¼‚å¸¸:', error);
    }
  }

  // ç¡®ä¿å·¥å…·åœ¨è¯•ç”¨æœŸé—´å¯ç”¨
  ensureToolAccess() {
    console.log('ğŸ”“ ç¡®ä¿è§†å¥å·¥å…·åœ¨è¯•ç”¨æœŸé—´å®Œå…¨å¯ç”¨');
    
    // 1. ç¡®ä¿å·¥å…·ç•Œé¢å¯è§
    const toolContainer = document.querySelector('.sight-reading-tool');
    if (toolContainer) {
      toolContainer.style.display = 'block';
      toolContainer.style.opacity = '1';
      toolContainer.style.pointerEvents = 'auto';
      console.log('âœ… è§†å¥å·¥å…·ç•Œé¢å·²å¯ç”¨');
    }
    
    // 2. ç¡®ä¿ç”ŸæˆæŒ‰é’®å¯ç”¨å¹¶æ¢å¤æ­£å¸¸æ–‡æœ¬
    const generateBtn = document.getElementById('generateBtn') || 
                       document.querySelector('button[onclick*="generateMelody"]') ||
                       document.querySelector('button.btn-primary');
    if (generateBtn) {
      generateBtn.disabled = false;
      generateBtn.style.opacity = '1';
      generateBtn.style.cursor = 'pointer';
      generateBtn.style.pointerEvents = 'auto';
      generateBtn.removeAttribute('disabled');
      
      // æ¢å¤æŒ‰é’®æ­£å¸¸æ–‡æœ¬
      generateBtn.textContent = 'ç”Ÿæˆæ—‹å¾‹';
      generateBtn.innerHTML = 'ç”Ÿæˆæ—‹å¾‹';
      
      console.log('âœ… ç”ŸæˆæŒ‰é’®å·²å®Œå…¨å¯ç”¨ï¼Œæ–‡æœ¬å·²æ¢å¤ä¸º"ç”Ÿæˆæ—‹å¾‹"');
    } else {
      console.log('âŒ æœªæ‰¾åˆ°ç”ŸæˆæŒ‰é’®');
    }
    
    // 3. ç¡®ä¿æ‰€æœ‰è¾“å…¥æ§ä»¶å¯ç”¨
    const allInputs = document.querySelectorAll('input, select, button, textarea');
    allInputs.forEach(input => {
      if (input.id !== 'generateBtn') { // é¿å…é‡å¤å¤„ç†
        input.disabled = false;
        input.style.opacity = '1';
        input.style.pointerEvents = 'auto';
      }
    });
    console.log('âœ… æ‰€æœ‰è¾“å…¥æ§ä»¶å·²å¯ç”¨');
    
    // 4. ç§»é™¤å¯èƒ½çš„è®¿é—®é™åˆ¶è¦†ç›–å±‚
    const overlays = document.querySelectorAll('.access-overlay, .trial-overlay, .premium-overlay');
    overlays.forEach(overlay => overlay.remove());
    
    // 5. ç¡®ä¿æ²¡æœ‰å…¨å±€æƒé™æ£€æŸ¥å‡½æ•°é˜»æ­¢ä½¿ç”¨
    if (window.checkFullAccess) {
      // ä¸´æ—¶è¦†ç›–æƒé™æ£€æŸ¥ï¼Œåœ¨è¯•ç”¨æœŸé—´è¿”å› true
      const originalCheck = window.checkFullAccess;
      window.checkFullAccess = function() {
        // å¦‚æœåœ¨è±å…æœŸå†…ï¼Œè¿”å› true å…è®¸ä½¿ç”¨
        const exemptTime = localStorage.getItem('ic-anticheat-exempt');
        if (exemptTime && (Date.now() - parseInt(exemptTime) < 5 * 60 * 1000)) {
          return true;
        }
        // å¦åˆ™æ£€æŸ¥è¯•ç”¨çŠ¶æ€
        if (window.trialLimiter) {
          const status = window.trialLimiter.checkTrialStatus();
          return status.allowed;
        }
        return originalCheck();
      };
      console.log('âœ… æƒé™æ£€æŸ¥å·²è°ƒæ•´ä¸ºæ”¯æŒè¯•ç”¨æ¨¡å¼');
    }
    
    // 6. éšè—æ”¯ä»˜åŒºåŸŸï¼ˆè¯•ç”¨æœŸé—´ä¸éœ€è¦æ˜¾ç¤ºï¼‰
    const paymentSection = document.getElementById('zpay-container');
    if (paymentSection) {
      paymentSection.style.display = 'none';
    }
    
    // 7. éšè—è®¿é—®ç è¾“å…¥åŒºåŸŸï¼ˆè¯•ç”¨æœŸé—´ä¸éœ€è¦æ˜¾ç¤ºï¼‰
    const accessCodeContainer = document.getElementById('access-code-container');
    if (accessCodeContainer) {
      accessCodeContainer.style.display = 'none';
    }
    
    console.log('ğŸ‰ è¯•ç”¨å·¥å…·å®Œå…¨å¯ç”¨çŠ¶æ€å·²ç¡®ä¿');
  }

  // é˜»æ­¢è®¿é—®
  blockAccess() {
    console.log('ğŸš« è¯•ç”¨æ—¶é—´å·²ç»“æŸï¼Œé˜»æ­¢å·¥å…·è®¿é—®');
    
    // ä¿®æ”¹ç”ŸæˆæŒ‰é’®ä¸ºè¯•ç”¨ç»“æŸçŠ¶æ€
    const generateBtn = document.getElementById('generateBtn') || 
                       document.querySelector('button[onclick*="generateMelody"]') ||
                       document.querySelector('button.btn-primary');
    if (generateBtn) {
      generateBtn.disabled = true;
      generateBtn.textContent = 'è¯•ç”¨å·²ç»“æŸ';
      generateBtn.innerHTML = 'è¯•ç”¨å·²ç»“æŸ';
      generateBtn.style.opacity = '0.5';
      generateBtn.style.cursor = 'not-allowed';
      console.log('ğŸš« ç”ŸæˆæŒ‰é’®å·²è®¾ç½®ä¸º"è¯•ç”¨å·²ç»“æŸ"');
    }
    
    // éšè—å·¥å…·ç•Œé¢
    const toolContainer = document.querySelector('.sight-reading-tool');
    if (toolContainer) {
      toolContainer.style.display = 'none';
    }

    // æ˜¾ç¤ºè´­ä¹°æç¤º
    this.showTrialStatus({ expired: true });
    
    // æ˜¾ç¤ºæ”¯ä»˜åŒºåŸŸ
    const paymentSection = document.getElementById('zpay-container');
    if (paymentSection) {
      paymentSection.style.display = 'block';
      // æ»šåŠ¨åˆ°è´­ä¹°åŒºåŸŸ
      setTimeout(() => {
        paymentSection.scrollIntoView({ behavior: 'smooth' });
      }, 1000);
    }
  }

  // å¯åŠ¨å®šæ—¶å™¨
  startTimer(remaining) {
    const timer = setInterval(() => {
      const status = this.checkTrialStatus();
      
      if (!status.allowed) {
        clearInterval(timer);
        this.blockAccess();
        return;
      }

      // ã€ä¿®å¤ã€‘å‡å°‘æ›´æ–°é¢‘ç‡ï¼Œé¿å…è¿‡åº¦å¹²æ‰°ç”¨æˆ·è¾“å…¥
      this.showTrialStatus(status);

      // è­¦å‘ŠåŠŸèƒ½å·²ç§»é™¤
    }, 3000); // æ”¹ä¸ºæ¯3ç§’æ›´æ–°ä¸€æ¬¡ï¼Œå‡å°‘å¹²æ‰°
    
    // å¯åŠ¨å®šæ—¶å™¨æ—¶ä¹Ÿç¡®ä¿å·¥å…·å¯ç”¨
    setTimeout(() => {
      this.ensureToolAccess();
      console.log('ğŸ”„ å®šæ—¶å™¨å¯åŠ¨åå†æ¬¡ç¡®ä¿å·¥å…·å¯ç”¨');
    }, 500);
  }

  // æ˜¾ç¤ºè­¦å‘Šæç¤º
  showWarning() {
    const warning = document.createElement('div');
    warning.className = 'trial-warning-popup';
    warning.innerHTML = `
      <div class="warning-content">
        <h3>âš ï¸ è¯•ç”¨æ—¶é—´å³å°†ç»“æŸ</h3>
        <p>è¿˜å‰©ä¸åˆ° 5 åˆ†é’Ÿçš„è¯•ç”¨æ—¶é—´</p>
        <p>è´­ä¹°å®Œæ•´ç‰ˆå¯æ°¸ä¹…ä½¿ç”¨æ‰€æœ‰åŠŸèƒ½</p>
        <div class="warning-buttons">
          <button onclick="this.parentElement.parentElement.parentElement.remove()" class="btn-secondary">ç»§ç»­è¯•ç”¨</button>
          <a href="#zpay-container" onclick="this.parentElement.parentElement.parentElement.remove()" class="btn-primary">ç«‹å³è´­ä¹°</a>
        </div>
      </div>
    `;
    
    document.body.appendChild(warning);
    
    // 3ç§’åè‡ªåŠ¨å…³é—­
    setTimeout(() => {
      if (warning.parentElement) {
        warning.remove();
      }
    }, 10000);
  }
}

// å…¨å±€å®ä¾‹
window.trialLimiter = new TrialLimiter();

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
  if (window.location.pathname.includes('sight-reading-generator') || 
      document.querySelector('.sight-reading-tool')) {
    
    // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„è®¿é—®ç ï¼Œå¦‚æœæœ‰åˆ™è·³è¿‡è¯•ç”¨é™åˆ¶
    const hasValidAccess = window.checkFullAccess && window.checkFullAccess();
    if (!hasValidAccess) {
      console.log('ğŸ”„ å¯åŠ¨è¯•ç”¨é™åˆ¶å™¨...');
      window.trialLimiter.init();
      
      // é¢å¤–çš„å»¶è¿Ÿç¡®ä¿ï¼Œé˜²æ­¢å…¶ä»–ä»£ç å¹²æ‰°
      setTimeout(() => {
        const status = window.trialLimiter.checkTrialStatus();
        if (status.allowed) {
          window.trialLimiter.ensureToolAccess();
          console.log('ğŸ›¡ï¸ é¡µé¢åŠ è½½å®Œæˆåå†æ¬¡ç¡®ä¿è¯•ç”¨å·¥å…·å¯ç”¨');
        }
      }, 1000);
      
      // å†æ¬¡ç¡®ä¿ - é˜²æ­¢UIç®¡ç†å™¨ç­‰å…¶ä»–ä»£ç å¹²æ‰°
      setTimeout(() => {
        const status = window.trialLimiter.checkTrialStatus();
        if (status.allowed) {
          window.trialLimiter.ensureToolAccess();
          console.log('ğŸ” æœ€ç»ˆç¡®ä¿è¯•ç”¨å·¥å…·å¯ç”¨çŠ¶æ€');
        }
      }, 2000);
      
    } else {
      console.log('âœ… æ£€æµ‹åˆ°æœ‰æ•ˆè®¿é—®ç ï¼Œè·³è¿‡è¯•ç”¨é™åˆ¶');
    }
  }
});/**
 * IC Studio è§†å¥å·¥å…· - ä»˜è´¹ç”¨æˆ·ç•Œé¢ç®¡ç†å™¨
 * ç¡®ä¿ä»˜è´¹ç”¨æˆ·è·å¾—å¹²å‡€çš„ç•Œé¢ä½“éªŒï¼Œæœªä»˜è´¹ç”¨æˆ·å—åˆ°æ­£ç¡®é™åˆ¶
 */

class PremiumUIManager {
  constructor() {
    this.version = '1.0.0-20250107';
    console.log('ğŸ¨ ä»˜è´¹ç”¨æˆ·ç•Œé¢ç®¡ç†å™¨åˆå§‹åŒ–', 'v' + this.version);
    
    this.init();
  }

  // åˆå§‹åŒ–ç®¡ç†å™¨
  init() {
    // ç­‰å¾…DOMåŠ è½½å®Œæˆ
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => this.setupUI());
    } else {
      this.setupUI();
    }
  }

  // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æœ‰æ•ˆçš„è®¿é—®ç ï¼ˆå¢å¼ºéªŒè¯ï¼‰
  hasValidAccessCode() {
    try {
      const accessData = localStorage.getItem('ic-premium-access');
      if (!accessData) return false;

      const data = JSON.parse(accessData);
      if (!data || !data.code || data.code.length !== 12) return false;

      // æ£€æŸ¥æ˜¯å¦è¿‡æœŸï¼ˆæ°¸ä¹…è®¿é—®ç ä¸ä¼šè¿‡æœŸï¼‰
      if (data.expiresAt && data.expiresAt !== null && Date.now() > data.expiresAt) {
        return false;
      }

      // ã€ä¿®å¤ã€‘ä¼˜å…ˆä¿¡ä»»æœåŠ¡å™¨éªŒè¯ï¼Œåªåœ¨æ˜ç¡®æ£€æµ‹åˆ°æµ‹è¯•å‰ç¼€æ—¶æ‰æ‹’ç»
      if (!data.serverVerified) {
        const hasObviousTestPrefix = ['TEST', 'DEMO', 'FORCE', 'BACKUP', 'EMERGENCY'].some(prefix => data.code.startsWith(prefix));
        if (hasObviousTestPrefix) {
          console.warn('âš ï¸ æ£€æµ‹åˆ°æµ‹è¯•è®¿é—®ç å‰ç¼€:', data.code);
          localStorage.removeItem('ic-premium-access');
          return false;
        }
        // å…¶ä»–æƒ…å†µä¸‹ä¿¡ä»»è®¿é—®ç ï¼Œç‰¹åˆ«æ˜¯Stripeç­‰æ­£å¸¸æ”¯ä»˜ç”Ÿæˆçš„è®¿é—®ç 
        console.log('â„¹ï¸ è®¿é—®ç æœªç»å‰ç«¯éªŒè¯ä½†æ ¼å¼æ­£å¸¸ï¼Œå…è®¸ä½¿ç”¨:', data.code);
      }

      console.log('âœ… æ£€æµ‹åˆ°æœ‰æ•ˆè®¿é—®ç :', data.code);
      return true;
    } catch (error) {
      console.error('è®¿é—®ç æ£€æŸ¥å¤±è´¥:', error);
      return false;
    }
  }

  // éªŒè¯è®¿é—®ç æ¨¡å¼æ˜¯å¦ä¸ºçœŸå®è´­ä¹°ç”Ÿæˆçš„
  isValidCodePattern(code) {
    // ã€ä¿®å¤ã€‘æ”¾å®½éªŒè¯é€»è¾‘ï¼Œåªæ’é™¤æ˜æ˜¾çš„æµ‹è¯•å‰ç¼€ï¼Œä¿ç•™Stripeç­‰åˆæ³•å‰ç¼€
    const testPrefixes = ['TEST', 'DEMO', 'FORCE', 'BACKUP', 'EMERGENCY'];
    
    const hasTestPrefix = testPrefixes.some(prefix => code.startsWith(prefix));
    if (hasTestPrefix) {
      console.warn('âš ï¸ æ£€æµ‹åˆ°æµ‹è¯•è®¿é—®ç å‰ç¼€:', code);
      return false;
    }

    // å¦‚æœæ˜¯11-12ä½çš„å­—æ¯æ•°å­—ç»„åˆï¼Œè®¤ä¸ºæ˜¯æœ‰æ•ˆçš„
    if (/^[A-Z0-9]{11,12}$/.test(code)) {
      return true;
    }

    return false;
  }

  // è®¾ç½®UIç•Œé¢
  setupUI() {
    // é¦–å…ˆæ¸…ç†æµ‹è¯•è®¿é—®ç 
    this.cleanupTestAccessCodes();
    
    const hasAccess = this.hasValidAccessCode();
    console.log('ğŸ¨ è®¾ç½®UIç•Œé¢ï¼Œç”¨æˆ·çŠ¶æ€:', hasAccess ? 'ä»˜è´¹ç”¨æˆ·' : 'å…è´¹ç”¨æˆ·');

    if (hasAccess) {
      this.setupPremiumUI();
    } else {
      this.setupTrialUI();
    }
  }

  // ä¸ºä»˜è´¹ç”¨æˆ·è®¾ç½®å¹²å‡€çš„ç•Œé¢
  setupPremiumUI() {
    console.log('ğŸŒŸ è®¾ç½®ä»˜è´¹ç”¨æˆ·å¹²å‡€ç•Œé¢');

    // 1. éšè—æ”¯ä»˜åŒºåŸŸ
    const zpayContainer = document.getElementById('zpay-container');
    if (zpayContainer) {
      zpayContainer.style.display = 'none';
      console.log('âœ… éšè—æ”¯ä»˜åŒºåŸŸ');
    }

    // 2. éšè—è®¿é—®ç è¾“å…¥åŒºåŸŸ
    const accessCodeContainer = document.getElementById('access-code-container');
    if (accessCodeContainer) {
      accessCodeContainer.style.display = 'none';
      console.log('âœ… éšè—è®¿é—®ç è¾“å…¥åŒºåŸŸ');
    }

    // 3. éšè—è¯•ç”¨çŠ¶æ€ä¿¡æ¯
    const trialStatus = document.getElementById('trial-status');
    if (trialStatus) {
      trialStatus.style.display = 'none';
      console.log('âœ… éšè—è¯•ç”¨çŠ¶æ€ä¿¡æ¯');
    }

    // 4. ã€å¢å¼ºã€‘ç§»é™¤æ‰€æœ‰è¯•ç”¨ç›¸å…³çš„è­¦å‘Šæ¶ˆæ¯å’Œå…ƒç´ 
    this.removeTrialMessages();
    this.removeAllTrialElements();

    // 5. ç¡®ä¿åŠŸèƒ½æŒ‰é’®æ­£å¸¸æ˜¾ç¤º
    this.enableAllFeatures();

    // 6. æ˜¾ç¤ºä»˜è´¹ç”¨æˆ·æ¬¢è¿ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
    this.showPremiumWelcome();

    // 7. ã€æ–°å¢ã€‘å®Œå…¨åœç”¨è¯•ç”¨é™åˆ¶å™¨
    this.disableTrialLimiter();

    console.log('âœ¨ ä»˜è´¹ç”¨æˆ·å¹²å‡€ç•Œé¢è®¾ç½®å®Œæˆ');
  }

  // ä¸ºå…è´¹ç”¨æˆ·è®¾ç½®è¯•ç”¨ç•Œé¢
  setupTrialUI() {
    console.log('â° è®¾ç½®å…è´¹ç”¨æˆ·è¯•ç”¨ç•Œé¢');

    // ä¸å¼ºåˆ¶æ‰§è¡Œè¯•ç”¨é™åˆ¶ï¼Œè®© trialLimiter è‡ªå·±ç®¡ç†è¯•ç”¨çŠ¶æ€
    // this.enforceTrialLimits();
    
    // æ˜¾ç¤ºæ”¯ä»˜åŒºåŸŸå’Œè®¿é—®ç è¾“å…¥ï¼ˆå¦‚æœè¿˜åœ¨è¯•ç”¨æœŸå†…ï¼‰
    this.showPaymentOptions();
  }

  // ç§»é™¤æ‰€æœ‰è¯•ç”¨ç›¸å…³æ¶ˆæ¯
  removeTrialMessages() {
    const messagesToRemove = [
      'å…è´¹è¯•ç”¨æ—¶é—´å·²ç”¨å®Œ',
      'æ°¸è¿œæ¿€æ´»æˆåŠŸ',
      'å·²è´­ä¹°è¯·è¾“å…¥è®¿é—®ç ',
      'trial',
      'expired',
      'activate'
    ];

    // æŸ¥æ‰¾å¹¶éšè—åŒ…å«è¿™äº›å…³é”®è¯çš„å…ƒç´ 
    document.querySelectorAll('*').forEach(element => {
      if (element.innerText) {
        const text = element.innerText.toLowerCase();
        if (messagesToRemove.some(msg => text.includes(msg.toLowerCase()))) {
          // ä¸æ˜¯æ ¸å¿ƒåŠŸèƒ½æŒ‰é’®æ‰éšè—
          if (!element.closest('.controls') && !element.closest('.header')) {
            element.style.display = 'none';
            console.log('âœ… éšè—è¯•ç”¨ç›¸å…³æ¶ˆæ¯:', element.innerText.substring(0, 50));
          }
        }
      }
    });
  }

  // å¯ç”¨æ‰€æœ‰åŠŸèƒ½
  enableAllFeatures() {
    // ç¡®ä¿ç”ŸæˆæŒ‰é’®å¯ç”¨
    const generateBtn = document.getElementById('generate-btn') || 
                       document.querySelector('[onclick*="generateMelody"]') ||
                       document.querySelector('button[onclick*="generate"]');
    
    if (generateBtn) {
      generateBtn.disabled = false;
      generateBtn.style.opacity = '1';
      generateBtn.style.pointerEvents = 'auto';
      console.log('âœ… ç”ŸæˆæŒ‰é’®å·²å¯ç”¨');
    }

    // ç§»é™¤ä»»ä½•åŠŸèƒ½é™åˆ¶
    if (window.trialLimiter) {
      // é‡å†™è¯•ç”¨é™åˆ¶å™¨çš„æ£€æŸ¥æ–¹æ³•
      window.trialLimiter.checkAccess = function() {
        return { allowed: true, remaining: Infinity };
      };
      console.log('âœ… è¯•ç”¨é™åˆ¶å·²ç§»é™¤');
    }
  }

  // æ˜¾ç¤ºä»˜è´¹ç”¨æˆ·æ¬¢è¿ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
  showPremiumWelcome() {
    const header = document.querySelector('.header');
    if (header && !header.querySelector('.premium-status')) {
      const welcomeElement = document.createElement('div');
      welcomeElement.className = 'premium-status';
      welcomeElement.style.cssText = `
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
        display: inline-block;
        margin-bottom: 10px;
      `;
      welcomeElement.innerHTML = 'âœ¨ é«˜çº§ç‰ˆå·²æ¿€æ´»';
      
      header.insertBefore(welcomeElement, header.firstChild);
      console.log('âœ… æ˜¾ç¤ºä»˜è´¹ç”¨æˆ·çŠ¶æ€');
    }
  }

  // å¼ºåˆ¶æ‰§è¡Œè¯•ç”¨é™åˆ¶
  enforceTrialLimits() {
    if (!window.trialLimiter) return;

    const trialStatus = window.trialLimiter.checkTrialStatus();
    if (!trialStatus.allowed) {
      console.log('â° è¯•ç”¨æ—¶é—´å·²ç»“æŸï¼Œæ˜¾ç¤ºå‡çº§é€‰é¡¹');
      
      // ç¦ç”¨ç”ŸæˆåŠŸèƒ½
      const generateBtn = document.getElementById('generate-btn') || 
                         document.querySelector('[onclick*="generateMelody"]');
      if (generateBtn) {
        generateBtn.disabled = true;
        generateBtn.style.opacity = '0.5';
      }

      // æ˜¾ç¤ºè¯•ç”¨ç»“æŸæ¶ˆæ¯
      this.showTrialExpiredMessage();
    }
  }

  // æ˜¾ç¤ºè¯•ç”¨ç»“æŸæ¶ˆæ¯
  showTrialExpiredMessage() {
    const trialStatus = document.getElementById('trial-status');
    if (trialStatus) {
      trialStatus.innerHTML = `
        <div style="background: #fff5f5; padding: 15px; border-radius: 8px; border: 2px solid #e74c3c; text-align: center;">
          <h3 style="color: #e74c3c; margin: 0 0 10px 0;">â° å…è´¹è¯•ç”¨æ—¶é—´å·²ç»“æŸ</h3>
          <p style="margin: 0; color: #666;">æ¯å°è®¾å¤‡å¯å…è´¹è¯•ç”¨ 10 åˆ†é’Ÿ</p>
        </div>
      `;
      trialStatus.style.display = 'block';
    }
  }

  // æ˜¾ç¤ºæ”¯ä»˜é€‰é¡¹
  showPaymentOptions() {
    const zpayContainer = document.getElementById('zpay-container');
    if (zpayContainer) {
      zpayContainer.style.display = 'block';
      console.log('âœ… æ˜¾ç¤ºæ”¯ä»˜é€‰é¡¹');
    }

    const accessCodeContainer = document.getElementById('access-code-container');
    if (accessCodeContainer) {
      accessCodeContainer.style.display = 'block';
      console.log('âœ… æ˜¾ç¤ºè®¿é—®ç è¾“å…¥');
    }
  }

  // é‡æ–°æ£€æŸ¥å¹¶æ›´æ–°UIï¼ˆç”¨äºè®¿é—®ç éªŒè¯åï¼‰
  refreshUI() {
    console.log('ğŸ”„ åˆ·æ–°UIçŠ¶æ€');
    // å…ˆæ¸…ç†æµ‹è¯•è®¿é—®ç å†æ›´æ–°UI
    this.cleanupTestAccessCodes();
    this.setupUI();
  }

  // æ¸…ç†æ‰€æœ‰æµ‹è¯•å’Œåº”æ€¥è®¿é—®ç 
  cleanupTestAccessCodes() {
    try {
      const accessData = localStorage.getItem('ic-premium-access');
      if (accessData) {
        const data = JSON.parse(accessData);
        if (data && data.code && !this.isValidCodePattern(data.code)) {
          console.log('ğŸ§¹ æ¸…ç†æµ‹è¯•è®¿é—®ç :', data.code);
          localStorage.removeItem('ic-premium-access');
        }
      }
    } catch (error) {
      console.error('æ¸…ç†è®¿é—®ç æ—¶å‡ºé”™:', error);
    }
  }

  // ã€æ–°å¢ã€‘ç§»é™¤æ‰€æœ‰è¯•ç”¨ç›¸å…³çš„DOMå…ƒç´ 
  removeAllTrialElements() {
    console.log('ğŸ§¹ ç§»é™¤æ‰€æœ‰è¯•ç”¨ç›¸å…³å…ƒç´ ');
    
    // ç§»é™¤è¯•ç”¨è¦†ç›–å±‚
    const overlays = document.querySelectorAll('.trial-overlay, .access-overlay, .premium-overlay');
    overlays.forEach(overlay => {
      overlay.remove();
      console.log('âœ… ç§»é™¤è¦†ç›–å±‚:', overlay.className);
    });
    
    // éšè—åŒ…å«è¯•ç”¨ä¿¡æ¯çš„å…ƒç´ 
    const trialElements = document.querySelectorAll('[id*="trial"], [class*="trial"]');
    trialElements.forEach(element => {
      if (!element.closest('.controls') && !element.closest('.header')) {
        element.style.display = 'none';
        console.log('âœ… éšè—è¯•ç”¨å…ƒç´ :', element.id || element.className);
      }
    });
    
    // ç§»é™¤è¯•ç”¨æ—¶é—´æ˜¾ç¤º
    const timeDisplays = document.querySelectorAll('.trial-active, .trial-expired, .trial-welcome');
    timeDisplays.forEach(display => {
      display.remove();
      console.log('âœ… ç§»é™¤è¯•ç”¨æ—¶é—´æ˜¾ç¤º');
    });
  }

  // ã€æ–°å¢ã€‘å®Œå…¨åœç”¨è¯•ç”¨é™åˆ¶å™¨
  disableTrialLimiter() {
    console.log('ğŸ”“ å®Œå…¨åœç”¨è¯•ç”¨é™åˆ¶å™¨');
    
    if (window.trialLimiter) {
      // é‡å†™è¯•ç”¨é™åˆ¶å™¨çš„æ£€æŸ¥æ–¹æ³•
      window.trialLimiter.checkTrialStatus = function() {
        return { 
          allowed: true, 
          remaining: Infinity,
          unlimited: true,
          premium: true
        };
      };
      
      window.trialLimiter.init = function() {
        console.log('ğŸ”“ è¯•ç”¨é™åˆ¶å™¨å·²è¢«ä»˜è´¹ç‰ˆæœ¬ç¦ç”¨');
        return true;
      };
      
      window.trialLimiter.blockAccess = function() {
        console.log('ğŸ”“ è®¿é—®é˜»æ­¢è¢«ä»˜è´¹ç‰ˆæœ¬å¿½ç•¥');
        return;
      };
      
      console.log('âœ… è¯•ç”¨é™åˆ¶å™¨å·²å®Œå…¨åœç”¨');
    }
  }

  // ä¿®å¤è®¿é—®æ§åˆ¶é€»è¾‘ï¼ˆç§»é™¤å¼ºåˆ¶è§£é”ï¼‰
  fixAccessControl() {
    console.log('ğŸ”§ ä¿®å¤è®¿é—®æ§åˆ¶é€»è¾‘');

    // æ¢å¤æ­£ç¡®çš„è®¿é—®æ£€æŸ¥å‡½æ•°
    if (window.checkFullAccess) {
      window.checkFullAccess = () => {
        return this.hasValidAccessCode();
      };
      console.log('âœ… è®¿é—®æ§åˆ¶å·²ä¿®å¤');
    }

    // æ¢å¤æ­£ç¡®çš„ç”Ÿæˆå‡½æ•°ä¿æŠ¤
    if (window.originalGenerateMelody && window.generateMelody) {
      const originalFunction = window.originalGenerateMelody;
      window.generateMelody = function() {
        // æ£€æŸ¥æƒé™
        if (!window.premiumUIManager.hasValidAccessCode()) {
          // æ£€æŸ¥è¯•ç”¨çŠ¶æ€
          if (window.trialLimiter) {
            const trialStatus = window.trialLimiter.checkAccess();
            if (!trialStatus.allowed) {
              alert('â° å…è´¹è¯•ç”¨æ—¶é—´å·²ç”¨å®Œï¼\n\næ¯å°è®¾å¤‡å¯å…è´¹è¯•ç”¨10åˆ†é’Ÿã€‚\nè¯·è´­ä¹°å®Œæ•´ç‰ˆç»§ç»­ä½¿ç”¨æ‰€æœ‰åŠŸèƒ½ã€‚');
              
              // æ˜¾ç¤ºæ”¯ä»˜åŒºåŸŸ
              const paymentSection = document.getElementById('zpay-container');
              if (paymentSection) {
                paymentSection.style.display = 'block';
              }
              return;
            }
          }
        }
        
        // æ‰§è¡ŒåŸå§‹å‡½æ•°
        return originalFunction.apply(this, arguments);
      };
      console.log('âœ… ç”Ÿæˆå‡½æ•°ä¿æŠ¤å·²ä¿®å¤');
    }
  }
}

// å…¨å±€å®ä¾‹åŒ–
window.premiumUIManager = new PremiumUIManager();

// é¡µé¢åŠ è½½å®Œæˆåä¿®å¤è®¿é—®æ§åˆ¶
document.addEventListener('DOMContentLoaded', function() {
  if (window.premiumUIManager) {
    window.premiumUIManager.fixAccessControl();
  }
});

// ä¸ºå…¶ä»–è„šæœ¬æä¾›åˆ·æ–°UIçš„æ–¹æ³•
window.refreshPremiumUI = function() {
  if (window.premiumUIManager) {
    window.premiumUIManager.refreshUI();
  }
};

// æä¾›è°ƒè¯•ç”¨çš„æ¸…ç†å‡½æ•°
window.cleanupAllTestCodes = function() {
  console.log('ğŸ§¹ æ‰‹åŠ¨æ¸…ç†æ‰€æœ‰æµ‹è¯•è®¿é—®ç ');
  localStorage.removeItem('ic-premium-access');
  localStorage.removeItem('ic-verified-user');
  localStorage.removeItem('ic-full-access');
  
  if (window.premiumUIManager) {
    window.premiumUIManager.refreshUI();
  }
  console.log('âœ… å·²æ¸…ç†æ‰€æœ‰æµ‹è¯•è®¿é—®ç ï¼ŒUIå·²åˆ·æ–°');
};/**
 * IC è§†å¥å·¥å…· - Cloudbase API å®¢æˆ·ç«¯ (æ··åˆæ¶æ„ç‰ˆæœ¬)
 * ä¸“ä¸º GitHub Pages + Cloudbase åç«¯æ¶æ„è®¾è®¡
 */

class CloudbaseAPI {
  constructor() {
    // Cloudbase API é…ç½®
    this.config = {
      envId: 'cloud1-4g1r5ho01a0cfd85',
      region: 'ap-shanghai',
      // ç›´æ¥è°ƒç”¨äº‘å‡½æ•°HTTP APIï¼Œä¸ä½¿ç”¨SDK
      apiBaseUrl: 'https://cloud1-4g1r5ho01a0cfd85.service.tcloudbase.com'
    };
    
    // ç”Ÿäº§æ¨¡å¼æ§åˆ¶
    this.isTestMode = false; // ç”Ÿäº§æ¨¡å¼
    this.forceTestMode = false; // ç”Ÿäº§æ¨¡å¼ï¼Œå…è®¸è°ƒç”¨çœŸå®API
    this.version = '2.0.1-20250107'; // ç‰ˆæœ¬æ ‡è¯†ï¼Œä¸æ”¯ä»˜ç³»ç»ŸåŒæ­¥
    
    console.log('ğŸ”— CloudbaseAPI åˆå§‹åŒ– - æ··åˆæ¶æ„æ¨¡å¼', this.isTestMode ? '(å¼ºåˆ¶æµ‹è¯•æ¨¡å¼)' : '(ç”Ÿäº§æ¨¡å¼)', 'v' + this.version);
    
    // è®¾ç½®å…¨å±€ç‰ˆæœ¬æ ‡è¯†
    window.cloudbaseApiVersion = this.version;
  }

  // HTTPè¯·æ±‚å°è£… - ç”Ÿäº§æ¨¡å¼ï¼ˆç›´è¿CloudBaseï¼‰
  async httpRequest(endpoint, data = {}, method = 'POST') {
    const url = `${this.config.apiBaseUrl}${endpoint}`;
    
    console.log('ğŸš€ ç”Ÿäº§æ¨¡å¼ - CloudBase APIè¯·æ±‚:', { url, method, data });
    
    try {
      const response = await fetch(url, {
        method: method,
        headers: {
          'Content-Type': 'application/json',
          'X-Request-Source': 'IC-Studio-Production',
          'X-API-Version': this.version
        },
        mode: 'cors',
        body: method === 'GET' ? undefined : JSON.stringify(data)
      });

      if (!response.ok) {
        throw new Error(`CloudBase APIé”™è¯¯ ${response.status}: ${response.statusText}`);
      }

      const result = await response.json();
      console.log('âœ… CloudBase APIå“åº”:', result);
      return result;
      
    } catch (error) {
      console.error(`ğŸš¨ CloudBase APIè¯·æ±‚å¤±è´¥ [${endpoint}]:`, error);
      
      // ç”Ÿäº§ç¯å¢ƒé™çº§å¤„ç† - ç¡®ä¿ç”¨æˆ·ä½“éªŒä¸å—å½±å“
      console.log('ğŸš¨ CloudBase API è¯·æ±‚å¤±è´¥ï¼Œä½†ä¸ä½¿ç”¨åº”æ€¥å¤„ç†');
      console.log('ğŸ” é”™è¯¯è¯¦æƒ…:', error.message);
      console.log('ğŸ” è¯·æ±‚URL:', `${this.config.apiBaseUrl}${endpoint}`);
      
      // ä¸å†ä½¿ç”¨åº”æ€¥å¤„ç†ï¼Œè®©çœŸå®é”™è¯¯ä¼ æ’­ä¸Šå»
      // è¿™æ ·å‰ç«¯å¯ä»¥çœ‹åˆ°çœŸæ­£çš„ç½‘ç»œé”™è¯¯ï¼Œè€Œä¸æ˜¯è¢«åº”æ€¥å¤„ç†æ©ç›–
      
      // å…¶ä»–æƒ…å†µæŠ›å‡ºé”™è¯¯
      throw error;
    }
  }
  
  // åˆ‡æ¢åˆ°ç”Ÿäº§æ¨¡å¼ï¼ˆç®¡ç†å‘˜åŠŸèƒ½ï¼‰
  enableProductionMode() {
    this.isTestMode = false;
    this.forceTestMode = false;
    console.log('ğŸš€ å·²åˆ‡æ¢åˆ°ç”Ÿäº§æ¨¡å¼ - å°†è°ƒç”¨çœŸå®API');
    localStorage.setItem('ic-api-mode', 'production');
  }
  
  // åˆ‡æ¢åˆ°æµ‹è¯•æ¨¡å¼
  enableTestMode() {
    this.isTestMode = true;
    this.forceTestMode = true;
    console.log('ğŸ§ª å·²åˆ‡æ¢åˆ°æµ‹è¯•æ¨¡å¼ - å°†ä½¿ç”¨æ¨¡æ‹ŸAPI');
    localStorage.setItem('ic-api-mode', 'test');
  }
  
  // è·å–å½“å‰æ¨¡å¼
  getCurrentMode() {
    return this.isTestMode ? 'test' : 'production';
  }

  // éªŒè¯è®¿é—®ç  - CloudBase æ•°æ®åº“éªŒè¯
  async verifyAccessCode(code) {
    console.log('ğŸ” CloudBaseè®¿é—®ç éªŒè¯:', code);
    
    // åŸºæœ¬æ ¼å¼æ£€æŸ¥ï¼ˆ11-12ä½å­—æ¯æ•°å­—ç»„åˆï¼‰
    if (!code || (code.length !== 12 && code.length !== 11)) {
      console.log('âŒ è®¿é—®ç æ ¼å¼æ— æ•ˆ:', code);
      return { valid: false, error: 'è®¿é—®ç æ ¼å¼æ— æ•ˆï¼Œè¯·è¾“å…¥11-12ä½è®¿é—®ç ' };
    }
    
    // æ£€æŸ¥æ˜¯å¦åªåŒ…å«å­—æ¯æ•°å­—
    if (!/^[A-Z0-9]+$/.test(code.toUpperCase())) {
      console.log('âŒ è®¿é—®ç æ ¼å¼é”™è¯¯ï¼šåªèƒ½åŒ…å«å­—æ¯æ•°å­—', code);
      return { valid: false, error: 'è®¿é—®ç æ ¼å¼æ— æ•ˆï¼Œåªèƒ½åŒ…å«å­—æ¯å’Œæ•°å­—' };
    }
    
    try {
      // è°ƒç”¨CloudBaseäº‘å‡½æ•°éªŒè¯è®¿é—®ç 
      const result = await this.httpRequest('/verify-access-code', {
        code: code.toUpperCase(),
        deviceId: window.trialLimiter?.deviceId || 'unknown',
        timestamp: Date.now()
      });
      
      console.log('ğŸ“¥ CloudBaseéªŒè¯ç»“æœ:', result);
      
      if (result.success) {
        console.log('âœ… CloudBaseéªŒè¯æˆåŠŸ:', result.data.code);
        
        // ä¿å­˜å¹¶æ¿€æ´»è®¿é—®æƒé™
        this.saveValidAccessCode(result.data.code, result.data);
        this.ensurePersistentAccess(result.data.code);
        this.removeTrialRestrictions();
        
        return { 
          valid: true, 
          data: result.data
        };
      } else {
        console.log('âŒ CloudBaseéªŒè¯å¤±è´¥:', result.message);
        return { 
          valid: false, 
          error: result.message || 'è®¿é—®ç æ— æ•ˆæˆ–å·²è¿‡æœŸ' 
        };
      }
      
    } catch (error) {
      console.error('âŒ CloudBaseéªŒè¯é”™è¯¯:', error);
      return { 
        valid: false, 
        error: 'éªŒè¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•' 
      };
    }
  }

  // ç”Ÿæˆè®¿é—®ç ï¼ˆæ”¯ä»˜æˆåŠŸåè°ƒç”¨ï¼‰- ç”Ÿäº§æ¨¡å¼CloudBase API
  async generateAccessCode(paymentData) {
    try {
      console.log('ğŸš€ CloudBaseç”Ÿæˆè®¿é—®ç è¯·æ±‚:', paymentData);
      
      // è°ƒç”¨CloudBaseäº‘å‡½æ•°ç”Ÿæˆè®¿é—®ç 
      const result = await this.httpRequest('/generate-access-code', {
        orderId: paymentData.orderId,
        paymentMethod: paymentData.paymentMethod,
        amount: paymentData.amount,
        merchantId: paymentData.merchantId,
        transactionId: paymentData.transactionId,
        deviceId: window.trialLimiter?.deviceId || 'unknown',
        timestamp: Date.now(),
        source: 'ic-studio-production'
      });
      
      console.log('ğŸ“¥ CloudBase APIè¿”å›ç»“æœ:', result);

      // å¤„ç†æ–°çš„ç®€åŒ–å“åº”æ ¼å¼
      if (result.success && result.accessCode) {
        console.log('âœ… CloudBaseè®¿é—®ç ç”ŸæˆæˆåŠŸ:', result.accessCode);
        return { 
          success: true, 
          accessCode: result.accessCode 
        };
      } else if (result.code === 200 && result.data && result.data.accessCode) {
        // å…¼å®¹æ—§æ ¼å¼
        console.log('âœ… CloudBaseè®¿é—®ç ç”ŸæˆæˆåŠŸ (æ—§æ ¼å¼):', result.data.accessCode);
        return { 
          success: true, 
          accessCode: result.data.accessCode 
        };
      } else {
        console.error('âŒ CloudBaseè®¿é—®ç ç”Ÿæˆå¤±è´¥:', result);
        return { 
          success: false, 
          error: result.message || 'CloudBaseç”Ÿæˆè®¿é—®ç å¤±è´¥' 
        };
      }
    } catch (error) {
      console.error('ğŸš¨ CloudBaseç”Ÿæˆè®¿é—®ç å¼‚å¸¸:', error);
      // httpRequestæ–¹æ³•ä¸­å·²ç»åŒ…å«äº†é™çº§å¤„ç†
      throw error;
    }
  }

  // å¤„ç†æ”¯ä»˜å›è°ƒï¼ˆå†…éƒ¨ä½¿ç”¨ï¼‰
  async handlePaymentCallback(callbackData) {
    try {
      const result = await this.httpRequest('/zpay-callback', callbackData);
      return result;
    } catch (error) {
      console.error('æ”¯ä»˜å›è°ƒå¤„ç†å¤±è´¥:', error);
      throw error;
    }
  }

  // ä¿å­˜æœ‰æ•ˆçš„è®¿é—®ç åˆ°æœ¬åœ°
  saveValidAccessCode(code, data = {}) {
    const accessData = {
      code: code,
      activatedAt: Date.now(),
      deviceId: window.trialLimiter?.deviceId || 'unknown',
      expiresAt: data.expires_at || null, // æ°¸ä¸è¿‡æœŸ
      version: '2.0-hybrid'
    };
    
    localStorage.setItem('ic-premium-access', JSON.stringify(accessData));
    console.log('âœ… è®¿é—®ç å·²ä¿å­˜åˆ°æœ¬åœ°ï¼ˆæ°¸ä¹…æœ‰æ•ˆï¼‰');
  }

  // æ£€æŸ¥æœ¬åœ°æ˜¯å¦æœ‰æœ‰æ•ˆè®¿é—®ç 
  getLocalAccessCode() {
    try {
      const data = localStorage.getItem('ic-premium-access');
      return data ? JSON.parse(data) : null;
    } catch (error) {
      console.error('è¯»å–æœ¬åœ°è®¿é—®ç å¤±è´¥:', error);
      return null;
    }
  }

  // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰å®Œæ•´ç‰ˆæƒé™
  async hasFullAccess() {
    const localAccess = this.getLocalAccessCode();
    
    if (!localAccess) {
      return { hasAccess: false, reason: 'no-code' };
    }

    // æ£€æŸ¥æ˜¯å¦è¿‡æœŸï¼ˆæ°¸ä¹…è®¿é—®ç ä¸ä¼šè¿‡æœŸï¼‰
    if (localAccess.expiresAt && localAccess.expiresAt !== null && Date.now() > localAccess.expiresAt) {
      localStorage.removeItem('ic-premium-access');
      return { hasAccess: false, reason: 'expired' };
    }

    // åœ¨çº¿éªŒè¯è®¿é—®ç 
    const verification = await this.verifyAccessCode(localAccess.code);
    
    if (verification.valid) {
      return { hasAccess: true, accessData: localAccess };
    } else {
      // è®¿é—®ç æ— æ•ˆï¼Œæ¸…é™¤æœ¬åœ°æ•°æ®
      localStorage.removeItem('ic-premium-access');
      return { 
        hasAccess: false, 
        reason: 'invalid-code', 
        error: verification.error 
      };
    }
  }

  // åˆå§‹åŒ–è®¿é—®ç è¾“å…¥ç•Œé¢
  initAccessCodeInput() {
    const container = document.getElementById('access-code-container');
    if (!container) return;

    // ä¸å†åˆ›å»ºé‡å¤çš„è®¿é—®ç ç•Œé¢ï¼Œä½¿ç”¨HTMLä¸­å·²æœ‰çš„zpay-containerä¸­çš„è¾“å…¥æ¡†

    // ç›‘å¬è¾“å…¥æ¡†å˜åŒ–ï¼Œè‡ªåŠ¨æ ¼å¼åŒ–
    const input = document.getElementById('access-code');
    input?.addEventListener('input', function(e) {
      e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
    });

    // ç›‘å¬å›è½¦é”®
    input?.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        cloudbaseAPI.handleAccessCodeSubmit();
      }
    });
  }

  // å¤„ç†è®¿é—®ç æäº¤ - CloudBase æ•°æ®åº“éªŒè¯
  async handleAccessCodeSubmit() {
    const input = document.getElementById('access-code');
    const resultDiv = document.getElementById('access-code-result');
    const button = document.getElementById('verify-code-btn');
    
    if (!input || !resultDiv) {
      console.log('ğŸ” CloudBase: è¾“å…¥å…ƒç´ æœªæ‰¾åˆ°ï¼Œå°è¯•å…¼å®¹å¤„ç†');
      // å…¼å®¹æ€§å¤„ç†ï¼šå°è¯•æŸ¥æ‰¾å…¶ä»–å¯èƒ½çš„è¾“å…¥æ¡†
      const altInput = document.getElementById('access-code-input');
      const altResultDiv = document.getElementById('verify-result');
      
      if (altInput && altResultDiv) {
        this.handleAlternativeAccessCodeSubmit(altInput, altResultDiv);
      }
      return;
    }

    const code = input.value.trim().toUpperCase();
    console.log('ğŸ” CloudBaseå¤„ç†è®¿é—®ç æäº¤:', code);
    
    if (!code || (code.length !== 12 && code.length !== 11)) {
      resultDiv.innerHTML = '<p style="color: #e74c3c;">âš ï¸ è¯·è¾“å…¥æœ‰æ•ˆçš„11-12ä½è®¿é—®ç </p>';
      return;
    }

    // æ˜¾ç¤ºéªŒè¯ä¸­çŠ¶æ€
    if (button) {
      button.textContent = 'éªŒè¯ä¸­...';
      button.disabled = true;
    }
    resultDiv.innerHTML = '<p style="color: #3498db;">ğŸ”„ æ­£åœ¨éªŒè¯è®¿é—®ç ...</p>';

    try {
      // è°ƒç”¨ CloudBase æ•°æ®åº“éªŒè¯
      console.log('ğŸš€ è°ƒç”¨ CloudBase æ•°æ®åº“éªŒè¯è®¿é—®ç :', code);
      const result = await this.verifyAccessCode(code);
      
      if (result.valid) {
        console.log('âœ… CloudBase éªŒè¯æˆåŠŸ:', code);
        resultDiv.innerHTML = '<p style="color: #27ae60;">âœ… éªŒè¯æˆåŠŸï¼é¡µé¢å³å°†åˆ·æ–°...</p>';
        
        setTimeout(() => {
          console.log('ğŸ”„ CloudBaseè§¦å‘é¡µé¢åˆ·æ–°');
          window.location.reload();
        }, 1500);
        
      } else {
        console.log('âŒ CloudBase éªŒè¯å¤±è´¥:', result.error);
        resultDiv.innerHTML = `<p style="color: #e74c3c;">âŒ ${result.error}</p>`;
        
        if (button) {
          button.textContent = 'éªŒè¯';
          button.disabled = false;
        }
      }
      
    } catch (error) {
      console.error('âŒ è®¿é—®ç éªŒè¯å¼‚å¸¸:', error);
      resultDiv.innerHTML = '<p style="color: #e74c3c;">âŒ éªŒè¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</p>';
      
      if (button) {
        button.textContent = 'éªŒè¯';
        button.disabled = false;
      }
    }
  }

  // å¤„ç†å¤‡ç”¨è®¿é—®ç è¾“å…¥ï¼ˆå…¼å®¹é¡µé¢ä¸­çš„å…¶ä»–è¾“å…¥æ¡†ï¼‰
  async handleAlternativeAccessCodeSubmit(input, resultDiv) {
    const code = input.value.trim().toUpperCase();
    console.log('ğŸ” CloudBaseå¤‡ç”¨å¤„ç†è®¿é—®ç :', code);
    
    if (!code || (code.length !== 12 && code.length !== 11)) {
      resultDiv.innerHTML = '<p style="color: #e74c3c;">âš ï¸ è¯·è¾“å…¥æœ‰æ•ˆçš„11-12ä½è®¿é—®ç </p>';
      return;
    }

    resultDiv.innerHTML = '<p style="color: #3498db;">ğŸ”„ æ­£åœ¨éªŒè¯è®¿é—®ç ...</p>';
    
    try {
      // è°ƒç”¨ CloudBase æ•°æ®åº“éªŒè¯
      console.log('ğŸš€ å¤‡ç”¨æ–¹å¼è°ƒç”¨ CloudBase æ•°æ®åº“éªŒè¯:', code);
      const result = await this.verifyAccessCode(code);
      
      if (result.valid) {
        console.log('âœ… å¤‡ç”¨éªŒè¯æˆåŠŸ:', code);
        resultDiv.innerHTML = '<p style="color: #27ae60;">âœ… éªŒè¯æˆåŠŸï¼é¡µé¢å³å°†åˆ·æ–°...</p>';
        
        setTimeout(() => {
          window.location.reload();
        }, 1500);
        
      } else {
        console.log('âŒ å¤‡ç”¨éªŒè¯å¤±è´¥:', result.error);
        resultDiv.innerHTML = `<p style="color: #e74c3c;">âŒ ${result.error}</p>`;
      }
      
    } catch (error) {
      console.error('âŒ å¤‡ç”¨è®¿é—®ç éªŒè¯å¼‚å¸¸:', error);
      resultDiv.innerHTML = '<p style="color: #e74c3c;">âŒ éªŒè¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</p>';
    }
  }

  // ç¡®ä¿è®¿é—®æƒé™æŒä¹…åŒ–
  ensurePersistentAccess(code) {
    // å¤šé‡å­˜å‚¨æœºåˆ¶
    localStorage.setItem('ic-verified-user', 'true');
    localStorage.setItem('ic-access-timestamp', Date.now().toString());
    sessionStorage.setItem('ic-session-verified', 'true');
    
    // è®¾ç½®é•¿æœŸcookie
    document.cookie = `ic_premium_access=${code}; path=/; max-age=${365*24*60*60}; SameSite=Strict`;
    
    console.log('ğŸ”’ è®¿é—®æƒé™å·²å¤šé‡æŒä¹…åŒ–');
  }

  // ç§»é™¤è¯•ç”¨é™åˆ¶
  removeTrialRestrictions() {
    // æ¸…é™¤è¯•ç”¨ç›¸å…³çš„localStorage
    localStorage.removeItem('ic-sight-reading-trial');
    localStorage.removeItem('trial-start-time');
    localStorage.removeItem('trial-used-time');
    
    // è®¾ç½®å®Œæ•´ç‰ˆæ ‡è®°
    localStorage.setItem('ic-full-access', 'true');
    
    console.log('ğŸ—‘ï¸ è¯•ç”¨é™åˆ¶å·²ç§»é™¤');
  }

  // æµ‹è¯•è®¿é—®ç éªŒè¯ï¼ˆè°ƒè¯•ç”¨ï¼‰
  async testVerification(code = 'DEMODZLVQITL') {
    console.log('ğŸ§ª å¼€å§‹æµ‹è¯•è®¿é—®ç éªŒè¯...');
    try {
      const result = await this.verifyAccessCode(code);
      console.log('ğŸ§ª æµ‹è¯•ç»“æœ:', result);
      return result;
    } catch (error) {
      console.error('ğŸ§ª æµ‹è¯•å¤±è´¥:', error);
      return { valid: false, error: error.message };
    }
  }

  // ç”Ÿæˆå®Œå…¨éšæœºçš„11-12ä½è®¿é—®ç 
  generateRandomAccessCode() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    const length = Math.random() < 0.5 ? 11 : 12; // éšæœºé€‰æ‹©11ä½æˆ–12ä½
    let code = '';
    
    for (let i = 0; i < length; i++) {
      code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    
    return code;
  }

  // è·å–å½“å‰ç¯å¢ƒä¿¡æ¯
  getEnvironmentInfo() {
    return {
      architecture: 'hybrid',
      frontend: 'github-pages',
      backend: 'cloudbase',
      apiEndpoint: this.config.apiBaseUrl,
      version: '2.0'
    };
  }
}

// å…¨å±€å®ä¾‹ - ä½¿ç”¨æ–°çš„å‘½åé¿å…å†²çª
window.cloudbaseAPI = new CloudbaseAPI();

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', async function() {
  console.log('ğŸš€ æ··åˆæ¶æ„åˆå§‹åŒ–:', cloudbaseAPI.getEnvironmentInfo());
  
  // æ£€æŸ¥å½“å‰é¡µé¢çš„å®Œæ•´ç‰ˆæƒé™
  const accessResult = await cloudbaseAPI.hasFullAccess();
  console.log('ğŸ” æƒé™æ£€æŸ¥ç»“æœ:', accessResult);
  
  // åœ¨è¯•ç”¨é¡µé¢æ ¹æ®æƒé™çŠ¶æ€å†³å®šæ˜¾ç¤ºå†…å®¹
  if (window.location.pathname.includes('sight-reading-generator')) {
    if (accessResult.hasAccess) {
      console.log('âœ… æ£€æµ‹åˆ°å®Œæ•´ç‰ˆæƒé™ï¼Œéšè—æ‰€æœ‰ä»˜è´¹ç›¸å…³å†…å®¹');
      
      // éšè—è¯•ç”¨çŠ¶æ€åŒºåŸŸ
      const statusDiv = document.getElementById('trial-status');
      if (statusDiv) {
        statusDiv.style.display = 'none';
      }
      
      // éšè—æ”¯ä»˜åŒºåŸŸ
      const zpayContainer = document.getElementById('zpay-container');
      if (zpayContainer) {
        zpayContainer.style.display = 'none';
      }
      
      // éšè—è®¿é—®ç è¾“å…¥åŒºåŸŸ
      const accessCodeContainer = document.getElementById('access-code-container');
      if (accessCodeContainer) {
        accessCodeContainer.style.display = 'none';
      }
      
    } else {
      // åªæœ‰åœ¨æ²¡æœ‰æƒé™æ—¶æ‰æ˜¾ç¤ºè®¿é—®ç è¾“å…¥
      console.log('ğŸ”‘ æ˜¾ç¤ºè®¿é—®ç è¾“å…¥åŒºåŸŸ');
      cloudbaseAPI.initAccessCodeInput();
    }
  }
  
  // åœ¨æ”¯ä»˜é¡µé¢ä¹Ÿæ£€æŸ¥æƒé™
  if (window.location.pathname.includes('sight-reading-tool')) {
    if (accessResult.hasAccess) {
      console.log('âœ… ç”¨æˆ·å·²æœ‰å®Œæ•´ç‰ˆæƒé™');
      // å¯ä»¥éšè—æ”¯ä»˜åŒºåŸŸæˆ–æ˜¾ç¤ºå·²æ¿€æ´»çŠ¶æ€
    }
  }
  
  // æ£€æŸ¥æ˜¯å¦åœ¨å®Œæ•´ç‰ˆé¡µé¢éœ€è¦éªŒè¯æƒé™
  if (window.location.pathname.includes('premium-sight-reading')) {
    if (!accessResult.hasAccess && !window.location.search.includes('verified=true')) {
      alert('âš ï¸ éœ€è¦æœ‰æ•ˆçš„è®¿é—®ç æ‰èƒ½ä½¿ç”¨å®Œæ•´ç‰ˆåŠŸèƒ½');
      window.location.href = '/tools/sight-reading-generator.html';
    }
  }
});

// å¯¼å‡ºAPIå®ä¾‹ä¾›å…¶ä»–è„šæœ¬ä½¿ç”¨
if (typeof module !== 'undefined' && module.exports) {
  module.exports = CloudbaseAPI;
}/**
 * IC Studio - æ€§èƒ½ä¼˜åŒ–å™¨
 * æ™ºèƒ½èµ„æºåŠ è½½å’Œæ€§èƒ½ç›‘æ§ç³»ç»Ÿ
 */

class PerformanceOptimizer {
  constructor() {
    this.config = {
      // CDN é…ç½®
      cdnEndpoints: [
        'https://cdn.jsdelivr.net',
        'https://unpkg.com',
        'https://cdnjs.cloudflare.com'
      ],
      
      // æ€§èƒ½é˜ˆå€¼
      thresholds: {
        largeResourceSize: 500 * 1024, // 500KB
        slowLoadTime: 3000, // 3ç§’
        criticalRenderTime: 1000 // 1ç§’
      },
      
      // ç¼“å­˜ç­–ç•¥
      cacheStrategy: {
        images: 86400000, // 24å°æ—¶
        scripts: 604800000, // 7å¤©
        styles: 604800000, // 7å¤©
        fonts: 2592000000 // 30å¤©
      }
    };
    
    this.metrics = {
      loadTimes: {},
      resourceSizes: {},
      cacheHits: 0,
      cacheMisses: 0
    };
    
    this.init();
  }
  
  init() {
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => this.onDOMReady());
    } else {
      this.onDOMReady();
    }
    
    // çª—å£åŠ è½½å®Œæˆååˆ†ææ€§èƒ½
    window.addEventListener('load', () => this.analyzePerformance());
  }
  
  onDOMReady() {
    this.optimizeImages();
    this.optimizeResourceLoading();
    this.setupIntersectionObserver();
    this.preloadCriticalResources();
  }
  
  // å›¾ç‰‡ä¼˜åŒ–
  optimizeImages() {
    const images = document.querySelectorAll('img');
    
    images.forEach(img => {
      // æ·»åŠ æ‡’åŠ è½½
      if (!img.loading) {
        img.loading = 'lazy';
      }
      
      // å“åº”å¼å›¾ç‰‡ä¼˜åŒ–
      this.optimizeImageSrc(img);
      
      // å›¾ç‰‡åŠ è½½é”™è¯¯å¤„ç†
      img.onerror = () => this.handleImageError(img);
    });
  }
  
  optimizeImageSrc(img) {
    const src = img.src || img.dataset.src;
    if (!src) return;
    
    // æ£€æµ‹è®¾å¤‡åƒç´ å¯†åº¦
    const devicePixelRatio = window.devicePixelRatio || 1;
    const viewportWidth = window.innerWidth;
    
    // æ ¹æ®è®¾å¤‡é€‰æ‹©åˆé€‚çš„å›¾ç‰‡å°ºå¯¸
    let optimizedSrc = src;
    
    // å¦‚æœæ˜¯é«˜å¯†åº¦å±å¹•ï¼Œä½¿ç”¨ 2x å›¾ç‰‡
    if (devicePixelRatio > 1 && src.includes('/images/')) {
      optimizedSrc = src.replace('/images/', '/images/2x/');
    }
    
    // å°å±å¹•è®¾å¤‡ä½¿ç”¨è¾ƒå°å°ºå¯¸
    if (viewportWidth < 768 && src.includes('/images/')) {
      optimizedSrc = src.replace('/images/', '/images/mobile/');
    }
    
    // æ£€æŸ¥ä¼˜åŒ–åçš„å›¾ç‰‡æ˜¯å¦å­˜åœ¨
    this.checkImageExists(optimizedSrc).then(exists => {
      if (exists) {
        img.src = optimizedSrc;
      }
    });
  }
  
  checkImageExists(src) {
    return new Promise(resolve => {
      const img = new Image();
      img.onload = () => resolve(true);
      img.onerror = () => resolve(false);
      img.src = src;
    });
  }
  
  handleImageError(img) {
    // å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶çš„å¤‡ç”¨æ–¹æ¡ˆ
    console.warn('Image failed to load:', img.src);
    
    // å°è¯•ä»å¤‡ç”¨ CDN åŠ è½½
    if (img.src.includes('cdn.jsdelivr.net')) {
      img.src = img.src.replace('cdn.jsdelivr.net', 'unpkg.com');
    } else if (img.src.includes('unpkg.com')) {
      // æœ€åå›é€€åˆ°æœ¬åœ°èµ„æº
      const localSrc = img.src.replace(/https:\/\/[^\/]+/, '');
      img.src = localSrc;
    }
  }
  
  // èµ„æºåŠ è½½ä¼˜åŒ–
  optimizeResourceLoading() {
    // é¢„åŠ è½½å…³é”®èµ„æº
    this.preloadCriticalResources();
    
    // å»¶è¿ŸåŠ è½½éå…³é”®èµ„æº
    this.deferNonCriticalResources();
    
    // èµ„æºä¼˜å…ˆçº§ç®¡ç†
    this.manageResourcePriority();
  }
  
  preloadCriticalResources() {
    const criticalResources = [
      { href: '/css/critical.css', as: 'style' },
      { href: '/js/trial-limiter.js', as: 'script' },
      { href: '/images/ICLOGO.png', as: 'image' }
    ];
    
    criticalResources.forEach(resource => {
      if (!document.querySelector(`link[href="${resource.href}"]`)) {
        const link = document.createElement('link');
        link.rel = 'preload';
        link.href = resource.href;
        link.as = resource.as;
        
        if (resource.as === 'script') {
          link.crossOrigin = 'anonymous';
        }
        
        document.head.appendChild(link);
      }
    });
  }
  
  deferNonCriticalResources() {
    // å»¶è¿ŸåŠ è½½ç¬¬ä¸‰æ–¹è„šæœ¬
    const deferredScripts = [
      'https://cdn.jsdelivr.net/npm/opensheetmusicdisplay@1.8.5/build/opensheetmusicdisplay.min.js'
    ];
    
    // ç­‰å¾…å…³é”®æ¸²æŸ“å®Œæˆåå†åŠ è½½
    setTimeout(() => {
      deferredScripts.forEach(src => {
        if (!document.querySelector(`script[src="${src}"]`)) {
          const script = document.createElement('script');
          script.src = src;
          script.async = true;
          script.defer = true;
          document.head.appendChild(script);
        }
      });
    }, 1000);
  }
  
  manageResourcePriority() {
    // ä¸ºå…³é”®èµ„æºè®¾ç½®é«˜ä¼˜å…ˆçº§
    const criticalLinks = document.querySelectorAll('link[rel="stylesheet"], link[rel="preload"]');
    criticalLinks.forEach(link => {
      if (!link.importance) {
        link.importance = 'high';
      }
    });
    
    // ä¸ºéå…³é”®èµ„æºè®¾ç½®ä½ä¼˜å…ˆçº§
    const nonCriticalScripts = document.querySelectorAll('script[async]:not([data-critical])');
    nonCriticalScripts.forEach(script => {
      script.importance = 'low';
    });
  }
  
  // è®¾ç½® Intersection Observer ç”¨äºæ‡’åŠ è½½
  setupIntersectionObserver() {
    if (!('IntersectionObserver' in window)) return;
    
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          this.loadLazyElement(entry.target);
          observer.unobserve(entry.target);
        }
      });
    }, {
      rootMargin: '50px 0px',
      threshold: 0.1
    });
    
    // è§‚å¯Ÿéœ€è¦æ‡’åŠ è½½çš„å…ƒç´ 
    const lazyElements = document.querySelectorAll('[data-lazy]');
    lazyElements.forEach(element => observer.observe(element));
  }
  
  loadLazyElement(element) {
    const src = element.dataset.src;
    const type = element.dataset.lazy;
    
    switch (type) {
      case 'image':
        element.src = src;
        element.classList.remove('lazy-loading');
        break;
      case 'iframe':
        element.src = src;
        break;
      case 'script':
        this.loadScript(src);
        break;
    }
  }
  
  loadScript(src) {
    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = src;
      script.async = true;
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }
  
  // æ€§èƒ½åˆ†æ
  analyzePerformance() {
    if (!('performance' in window)) return;
    
    // è·å–æ€§èƒ½æŒ‡æ ‡
    const perfData = performance.getEntriesByType('navigation')[0];
    const paintData = performance.getEntriesByType('paint');
    
    this.metrics.navigationTiming = {
      dns: perfData.domainLookupEnd - perfData.domainLookupStart,
      tcp: perfData.connectEnd - perfData.connectStart,
      ssl: perfData.connectEnd - perfData.secureConnectionStart,
      ttfb: perfData.responseStart - perfData.requestStart,
      download: perfData.responseEnd - perfData.responseStart,
      domParsing: perfData.domContentLoadedEventStart - perfData.responseEnd,
      resourceLoading: perfData.loadEventStart - perfData.domContentLoadedEventEnd,
      total: perfData.loadEventEnd - perfData.navigationStart
    };
    
    // Core Web Vitals
    this.measureWebVitals();
    
    // èµ„æºåŠ è½½åˆ†æ
    this.analyzeResourceLoading();
    
    // å‘é€æ€§èƒ½æŠ¥å‘Š
    this.sendPerformanceReport();
  }
  
  measureWebVitals() {
    // First Contentful Paint
    const fcp = performance.getEntriesByName('first-contentful-paint')[0];
    if (fcp) {
      this.metrics.fcp = fcp.startTime;
    }
    
    // Largest Contentful Paint (éœ€è¦ PerformanceObserver)
    if ('PerformanceObserver' in window) {
      new PerformanceObserver((list) => {
        const entries = list.getEntries();
        const lastEntry = entries[entries.length - 1];
        this.metrics.lcp = lastEntry.startTime;
      }).observe({ entryTypes: ['largest-contentful-paint'] });
      
      // First Input Delay
      new PerformanceObserver((list) => {
        const entries = list.getEntries();
        entries.forEach(entry => {
          this.metrics.fid = entry.processingStart - entry.startTime;
        });
      }).observe({ entryTypes: ['first-input'] });
    }
  }
  
  analyzeResourceLoading() {
    const resources = performance.getEntriesByType('resource');
    
    resources.forEach(resource => {
      const size = resource.transferSize || resource.encodedBodySize || 0;
      const loadTime = resource.responseEnd - resource.startTime;
      
      this.metrics.resourceSizes[resource.name] = size;
      this.metrics.loadTimes[resource.name] = loadTime;
      
      // æ£€æŸ¥æ˜¯å¦æœ‰æ€§èƒ½é—®é¢˜
      if (size > this.config.thresholds.largeResourceSize) {
        console.warn('Large resource detected:', resource.name, size + ' bytes');
      }
      
      if (loadTime > this.config.thresholds.slowLoadTime) {
        console.warn('Slow resource loading:', resource.name, loadTime + ' ms');
      }
    });
  }
  
  sendPerformanceReport() {
    // åªåœ¨ç”Ÿäº§ç¯å¢ƒå‘é€æŠ¥å‘Š
    if (window.location.hostname === 'localhost') return;
    
    const report = {
      url: window.location.href,
      userAgent: navigator.userAgent,
      timestamp: Date.now(),
      metrics: this.metrics,
      viewport: {
        width: window.innerWidth,
        height: window.innerHeight,
        pixelRatio: window.devicePixelRatio
      },
      connection: navigator.connection ? {
        effectiveType: navigator.connection.effectiveType,
        downlink: navigator.connection.downlink,
        rtt: navigator.connection.rtt
      } : null
    };
    
    // å‘é€åˆ°æ€§èƒ½ç›‘æ§æœåŠ¡
    this.sendToAnalytics(report);
  }
  
  sendToAnalytics(data) {
    // ä½¿ç”¨ sendBeacon API å‘é€æ•°æ®
    if ('sendBeacon' in navigator) {
      const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
      navigator.sendBeacon('/api/performance', blob);
    } else {
      // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ fetch
      fetch('/api/performance', {
        method: 'POST',
        body: JSON.stringify(data),
        headers: {
          'Content-Type': 'application/json'
        },
        keepalive: true
      }).catch(error => {
        console.warn('Failed to send performance data:', error);
      });
    }
  }
  
  // ä¼˜åŒ–å»ºè®®
  getOptimizationSuggestions() {
    const suggestions = [];
    
    // æ£€æŸ¥å›¾ç‰‡ä¼˜åŒ–
    const images = document.querySelectorAll('img');
    const unoptimizedImages = Array.from(images).filter(img => 
      !img.loading || img.loading !== 'lazy'
    );
    
    if (unoptimizedImages.length > 0) {
      suggestions.push(`Found ${unoptimizedImages.length} images without lazy loading`);
    }
    
    // æ£€æŸ¥æœªä½¿ç”¨çš„ CSS
    const stylesheets = document.querySelectorAll('link[rel="stylesheet"]');
    if (stylesheets.length > 5) {
      suggestions.push('Consider consolidating CSS files');
    }
    
    // æ£€æŸ¥é˜»å¡èµ„æº
    const blockingScripts = document.querySelectorAll('script:not([async]):not([defer])');
    if (blockingScripts.length > 0) {
      suggestions.push(`Found ${blockingScripts.length} render-blocking scripts`);
    }
    
    return suggestions;
  }
}

// è‡ªåŠ¨åˆå§‹åŒ–æ€§èƒ½ä¼˜åŒ–å™¨
const performanceOptimizerInstance = new PerformanceOptimizer();

// æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸä¾›è°ƒè¯•ä½¿ç”¨
window.performanceOptimizer = performanceOptimizerInstance;

// å¯¼å‡ºä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨
if (typeof module !== 'undefined' && module.exports) {
  module.exports = PerformanceOptimizer;
}/**
 * IC Studio è®¿é—®ç éªŒè¯å¢å¼ºå™¨
 * åœ¨è®¿é—®ç éªŒè¯æˆåŠŸåæä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ
 */

(function() {
  console.log('ğŸ”§ è®¿é—®ç éªŒè¯å¢å¼ºå™¨åŠ è½½');

  // ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆ
  document.addEventListener('DOMContentLoaded', function() {
    enhanceAccessCodeFlow();
  });

  // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿å…¶ä»–è„šæœ¬éƒ½å·²åŠ è½½
  setTimeout(enhanceAccessCodeFlow, 1000);

  function enhanceAccessCodeFlow() {
    console.log('âœ¨ å¼€å§‹å¢å¼ºè®¿é—®ç éªŒè¯æµç¨‹');

    // 1. å¢å¼ºç›´æ¥éªŒè¯å‡½æ•° - è°ƒç”¨ CloudBase API
    if (window.directVerifyCode) {
      const originalDirectVerify = window.directVerifyCode;
      window.directVerifyCode = async function() {
        console.log('ğŸš€ å¢å¼ºç‰ˆè®¿é—®ç ç›´æ¥éªŒè¯ - è°ƒç”¨ CloudBase API');
        
        const input = document.getElementById('access-code-input');
        const resultDiv = document.getElementById('verify-result');
        
        if (!input || !resultDiv) {
          console.error('âŒ æ‰¾ä¸åˆ°è®¿é—®ç è¾“å…¥å…ƒç´ ');
          return;
        }
        
        const code = input.value.trim().toUpperCase();
        
        if (!code) {
          resultDiv.innerHTML = '<span style="color: #e74c3c;">âŒ è¯·è¾“å…¥è®¿é—®ç </span>';
          return;
        }
        
        if (!code || (code.length !== 12 && code.length !== 11)) {
          resultDiv.innerHTML = '<span style="color: #e74c3c;">âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„11-12ä½è®¿é—®ç </span>';
          return;
        }
        
        resultDiv.innerHTML = '<span style="color: #3498db;">ğŸ”„ æ­£åœ¨éªŒè¯è®¿é—®ç ...</span>';
        
        try {
          // è°ƒç”¨ CloudBase API è¿›è¡ŒæœåŠ¡å™¨ç«¯éªŒè¯
          if (window.cloudbaseAPI && window.cloudbaseAPI.verifyAccessCode) {
            console.log('ğŸš€ ä½¿ç”¨ CloudBase API éªŒè¯è®¿é—®ç ');
            const result = await window.cloudbaseAPI.verifyAccessCode(code);
            
            if (result.valid) {
              console.log('âœ… CloudBase éªŒè¯æˆåŠŸ:', code);
              resultDiv.innerHTML = '<span style="color: #27ae60;">âœ… éªŒè¯æˆåŠŸï¼æ­£åœ¨æ›´æ–°ç•Œé¢...</span>';
              
              // ç«‹å³æ›´æ–°UIè€Œä¸åˆ·æ–°é¡µé¢
              if (window.premiumUIManager) {
                window.premiumUIManager.refreshUI();
                console.log('âœ… UIå·²åˆ·æ–°ï¼Œæ— éœ€é‡è½½é¡µé¢');
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯åæ¸…ç†è¾“å…¥
                setTimeout(() => {
                  input.value = '';
                  resultDiv.innerHTML = '<span style="color: #27ae60;">âœ… é«˜çº§åŠŸèƒ½å·²æ¿€æ´»</span>';
                }, 1000);
                
              } else {
                // å¤‡ç”¨ï¼šé¡µé¢åˆ·æ–°
                console.log('âš ï¸ UIç®¡ç†å™¨æœªæ‰¾åˆ°ï¼Œæ‰§è¡Œé¡µé¢åˆ·æ–°');
                setTimeout(() => {
                  window.location.reload();
                }, 1500);
              }
              
            } else {
              console.log('âŒ CloudBase éªŒè¯å¤±è´¥:', result.error);
              resultDiv.innerHTML = `<span style="color: #e74c3c;">âŒ ${result.error}</span>`;
            }
          } else {
            // å¤‡ç”¨æ–¹æ¡ˆï¼šè°ƒç”¨é¡µé¢ä¸Šçš„ verifyAccessCodeWithServer å‡½æ•°
            console.log('âš ï¸ CloudBase API ä¸å¯ç”¨ï¼Œä½¿ç”¨å¤‡ç”¨éªŒè¯');
            if (window.verifyAccessCodeWithServer) {
              await window.verifyAccessCodeWithServer();
            } else {
              resultDiv.innerHTML = '<span style="color: #e74c3c;">âŒ éªŒè¯ç³»ç»Ÿä¸å¯ç”¨</span>';
            }
          }
          
        } catch (error) {
          console.error('âŒ éªŒè¯è¿‡ç¨‹å¤±è´¥:', error);
          resultDiv.innerHTML = '<span style="color: #e74c3c;">âŒ éªŒè¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</span>';
        }
      };
      
      console.log('âœ… directVerifyCode å‡½æ•°å·²å¢å¼º');
    }

    // 2. å¢å¼ºä¸€èˆ¬éªŒè¯å‡½æ•° - è°ƒç”¨ CloudBase API
    if (window.verifyAccessCode) {
      const originalVerifyAccessCode = window.verifyAccessCode;
      window.verifyAccessCode = async function() {
        console.log('ğŸ” å¢å¼ºç‰ˆè®¿é—®ç éªŒè¯ - è°ƒç”¨ CloudBase API');
        
        const input = document.getElementById('access-code-input');
        const resultDiv = document.getElementById('verify-result');
        
        if (!input || !resultDiv) {
          console.error('âŒ æ‰¾ä¸åˆ°è®¿é—®ç è¾“å…¥å…ƒç´ ');
          return;
        }
        
        const code = input.value.trim().toUpperCase();
        
        if (!code) {
          resultDiv.innerHTML = '<span style="color: #e74c3c;">âŒ è¯·è¾“å…¥è®¿é—®ç </span>';
          return;
        }
        
        if (!code || (code.length !== 12 && code.length !== 11)) {
          resultDiv.innerHTML = '<span style="color: #e74c3c;">âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„11-12ä½è®¿é—®ç </span>';
          return;
        }
        
        resultDiv.innerHTML = '<span style="color: #3498db;">ğŸ”„ æ­£åœ¨éªŒè¯è®¿é—®ç ...</span>';
        
        try {
          // è°ƒç”¨ CloudBase API è¿›è¡ŒæœåŠ¡å™¨ç«¯éªŒè¯
          if (window.cloudbaseAPI && window.cloudbaseAPI.verifyAccessCode) {
            console.log('ğŸš€ ä½¿ç”¨ CloudBase API éªŒè¯è®¿é—®ç ');
            const result = await window.cloudbaseAPI.verifyAccessCode(code);
            
            if (result.valid) {
              console.log('âœ… CloudBase éªŒè¯æˆåŠŸ:', code);
              resultDiv.innerHTML = '<span style="color: #27ae60;">âœ… éªŒè¯æˆåŠŸï¼æ­£åœ¨æ¿€æ´»é«˜çº§åŠŸèƒ½...</span>';
              
              // ç«‹å³æ›´æ–°UI
              if (window.premiumUIManager) {
                setTimeout(() => {
                  window.premiumUIManager.refreshUI();
                  resultDiv.innerHTML = '<span style="color: #27ae60;">âœ¨ é«˜çº§åŠŸèƒ½å·²æˆåŠŸæ¿€æ´»</span>';
                  input.value = '';
                }, 1000);
              } else {
                // å¤‡ç”¨æ–¹æ¡ˆ
                setTimeout(() => {
                  window.location.reload();
                }, 2000);
              }
            } else {
              console.log('âŒ CloudBase éªŒè¯å¤±è´¥:', result.error);
              resultDiv.innerHTML = `<span style="color: #e74c3c;">âŒ ${result.error}</span>`;
            }
          } else {
            // å¤‡ç”¨æ–¹æ¡ˆï¼šè°ƒç”¨é¡µé¢ä¸Šçš„ verifyAccessCodeWithServer å‡½æ•°
            console.log('âš ï¸ CloudBase API ä¸å¯ç”¨ï¼Œä½¿ç”¨å¤‡ç”¨éªŒè¯');
            if (window.verifyAccessCodeWithServer) {
              await window.verifyAccessCodeWithServer();
            } else {
              resultDiv.innerHTML = '<span style="color: #e74c3c;">âŒ éªŒè¯ç³»ç»Ÿä¸å¯ç”¨</span>';
            }
          }
          
        } catch (error) {
          console.error('âŒ éªŒè¯è¿‡ç¨‹å¤±è´¥:', error);
          resultDiv.innerHTML = '<span style="color: #e74c3c;">âŒ éªŒè¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</span>';
        }
      };
      
      console.log('âœ… verifyAccessCode å‡½æ•°å·²å¢å¼º');
    }

    // 3. æä¾›å…¨å±€é‡ç½®å‡½æ•°
    window.resetToTrialMode = function() {
      console.log('ğŸ”„ é‡ç½®ä¸ºè¯•ç”¨æ¨¡å¼');
      
      localStorage.removeItem('ic-premium-access');
      localStorage.removeItem('ic-full-access');
      localStorage.removeItem('ic-verified-user');
      
      if (window.premiumUIManager) {
        window.premiumUIManager.refreshUI();
        console.log('âœ… å·²åˆ‡æ¢åˆ°è¯•ç”¨æ¨¡å¼UI');
      } else {
        window.location.reload();
      }
    };

    // 4. æä¾›å…¨å±€å‡çº§å‡½æ•°
    window.upgradeToFullVersion = function(customCode) {
      // ç”Ÿæˆå®Œå…¨éšæœºçš„11-12ä½è®¿é—®ç 
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      const length = Math.random() < 0.5 ? 11 : 12;
      let randomCode = '';
      for (let i = 0; i < length; i++) {
        randomCode += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      const code = customCode || randomCode;
      
      const accessData = {
        code: code,
        activatedAt: Date.now(),
        deviceId: 'manual-upgrade',
        expiresAt: null,
        version: '2.0-manual-upgrade'
      };
      
      localStorage.setItem('ic-premium-access', JSON.stringify(accessData));
      console.log('âœ… æ‰‹åŠ¨å‡çº§å®Œæˆ:', code);
      
      if (window.premiumUIManager) {
        window.premiumUIManager.refreshUI();
        alert(`âœ… å‡çº§æˆåŠŸï¼\nè®¿é—®ç : ${code}\n\né«˜çº§åŠŸèƒ½å·²æ¿€æ´»`);
      } else {
        alert(`âœ… å‡çº§æˆåŠŸï¼\nè®¿é—®ç : ${code}\n\né¡µé¢å°†åˆ·æ–°ä»¥æ¿€æ´»åŠŸèƒ½`);
        setTimeout(() => window.location.reload(), 1000);
      }
    };

    // 5. æä¾›å…¨å±€é‡ç½®ä¸ºæ–°ç”¨æˆ·å‡½æ•°
    window.resetToFreshUser = function() {
      console.log('ğŸ”„ é‡ç½®ä¸ºå…¨æ–°ç”¨æˆ·çŠ¶æ€');
      
      try {
        // æ¸…ç†æ‰€æœ‰å­˜å‚¨çš„ç”¨æˆ·æ•°æ®
        localStorage.removeItem('ic-premium-access');
        localStorage.removeItem('ic-full-access');
        localStorage.removeItem('ic-verified-user');
        localStorage.removeItem('ic-sight-reading-trial');
        localStorage.removeItem('ic-device-id');
        localStorage.removeItem('ic-trial-end');
        localStorage.removeItem('ic-reset-count');
        localStorage.removeItem('ic-anticheat-exempt');
        
        // æ¸…ç†ä¼šè¯å­˜å‚¨
        sessionStorage.removeItem('ic-device-id-session');
        
        // æ¸…ç†cookie
        document.cookie = 'ic_device_backup=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
        
        console.log('âœ… å·²æ¸…ç†æ‰€æœ‰ç”¨æˆ·æ•°æ®');
        
        // åˆ·æ–°UIçŠ¶æ€
        if (window.premiumUIManager) {
          window.premiumUIManager.refreshUI();
          console.log('âœ… UIå·²é‡ç½®ä¸ºè¯•ç”¨æ¨¡å¼');
        }
        
        // é‡æ–°åˆå§‹åŒ–è¯•ç”¨é™åˆ¶å™¨
        if (window.trialLimiter) {
          // ç­‰å¾…ä¸€ä¸‹å†é‡æ–°åˆå§‹åŒ–ï¼Œç¡®ä¿æ•°æ®æ¸…ç†å®Œæˆ
          setTimeout(() => {
            window.trialLimiter.init();
            console.log('âœ… è¯•ç”¨é™åˆ¶å™¨å·²é‡æ–°åˆå§‹åŒ–');
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            alert('âœ… ç”¨æˆ·çŠ¶æ€å·²é‡ç½®ä¸ºå…¨æ–°çŠ¶æ€ï¼\nç°åœ¨å¯ä»¥é‡æ–°å¼€å§‹10åˆ†é’Ÿè¯•ç”¨ã€‚');
          }, 500);
        }
        
        // æ¸…ç†è®¿é—®ç è¾“å…¥åŒºåŸŸçš„æ˜¾ç¤ºçŠ¶æ€
        const accessContainer = document.getElementById('access-code-container');
        const accessInput = document.getElementById('access-code-input');
        const verifyResult = document.getElementById('verify-result');
        
        if (accessContainer && accessContainer.innerHTML.includes('é«˜çº§åŠŸèƒ½å·²æ¿€æ´»')) {
          // æ¢å¤åŸå§‹çš„è®¿é—®ç è¾“å…¥ç•Œé¢
          window.location.reload();
        }
        
        if (accessInput) {
          accessInput.value = '';
        }
        
        if (verifyResult) {
          verifyResult.innerHTML = '';
        }
        
      } catch (error) {
        console.error('âŒ é‡ç½®è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯:', error);
        alert('âš ï¸ é‡ç½®è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œå»ºè®®æ‰‹åŠ¨åˆ·æ–°é¡µé¢');
      }
    };

    // 6. æä¾›å¿«é€Ÿæµ‹è¯•å‡½æ•°
    window.testAccessCode = function(code) {
      code = code || 'J71YRYSV9K6W'; // ä½¿ç”¨å·²çŸ¥çš„æµ‹è¯•è®¿é—®ç 
      
      console.log(`ğŸ§ª æµ‹è¯•è®¿é—®ç : ${code}`);
      
      const input = document.getElementById('access-code-input');
      if (input) {
        input.value = code;
        // è§¦å‘éªŒè¯æŒ‰é’®æ›´æ–°
        if (window.updateVerifyButton) {
          window.updateVerifyButton();
        }
        
        // æ¨¡æ‹Ÿç‚¹å‡»éªŒè¯
        setTimeout(() => {
          if (window.verifyAccessCodeWithServer) {
            window.verifyAccessCodeWithServer();
          }
        }, 500);
      } else {
        console.error('âŒ æ‰¾ä¸åˆ°è®¿é—®ç è¾“å…¥æ¡†');
        alert('è¯·å…ˆæ‰“å¼€åŒ…å«è®¿é—®ç è¾“å…¥æ¡†çš„é¡µé¢');
      }
    };

    // 7. æä¾›è°ƒè¯•è¾…åŠ©å‡½æ•°
    window.debugAccessSystem = function() {
      console.log('ğŸ” è®¿é—®ç³»ç»Ÿè°ƒè¯•ä¿¡æ¯:');
      console.log('ğŸ’¾ LocalStorageæ•°æ®:');
      console.log('  - ic-premium-access:', localStorage.getItem('ic-premium-access'));
      console.log('  - ic-sight-reading-trial:', localStorage.getItem('ic-sight-reading-trial'));
      console.log('  - ic-device-id:', localStorage.getItem('ic-device-id'));
      
      console.log('ğŸ¯ å…¨å±€å‡½æ•°çŠ¶æ€:');
      console.log('  - verifyAccessCodeWithServer:', typeof window.verifyAccessCodeWithServer);
      console.log('  - updateVerifyButton:', typeof window.updateVerifyButton);
      console.log('  - trialLimiter:', !!window.trialLimiter);
      console.log('  - premiumUIManager:', !!window.premiumUIManager);
      
      console.log('ğŸ”§ å½“å‰è¯•ç”¨çŠ¶æ€:');
      if (window.trialLimiter) {
        const status = window.trialLimiter.checkTrialStatus();
        console.log('  - å…è®¸ä½¿ç”¨:', status.allowed);
        console.log('  - å‰©ä½™æ—¶é—´:', status.remaining);
        console.log('  - æ˜¯å¦è¿‡æœŸ:', status.expired);
      }
      
      return {
        localStorage: {
          premiumAccess: localStorage.getItem('ic-premium-access'),
          trial: localStorage.getItem('ic-sight-reading-trial'),
          deviceId: localStorage.getItem('ic-device-id')
        },
        functions: {
          verifyServer: typeof window.verifyAccessCodeWithServer,
          updateButton: typeof window.updateVerifyButton,
          trialLimiter: !!window.trialLimiter,
          uiManager: !!window.premiumUIManager
        },
        trialStatus: window.trialLimiter ? window.trialLimiter.checkTrialStatus() : null
      };
    };

    console.log('ğŸ‰ è®¿é—®ç éªŒè¯å¢å¼ºå®Œæˆ');
    console.log('ğŸ’¡ å¯ç”¨çš„è°ƒè¯•å‘½ä»¤:');
    console.log('  - resetToFreshUser() - é‡ç½®ä¸ºå…¨æ–°ç”¨æˆ·');
    console.log('  - testAccessCode() - æµ‹è¯•å·²çŸ¥è®¿é—®ç ');
    console.log('  - debugAccessSystem() - æ˜¾ç¤ºç³»ç»Ÿè°ƒè¯•ä¿¡æ¯');
  }

})();