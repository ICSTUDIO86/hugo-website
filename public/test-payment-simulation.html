<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨¡æ‹Ÿæ”¯ä»˜æµ‹è¯• - CloudBaseæ•°æ®å†™å…¥</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 15px;
            margin-bottom: 30px;
        }
        .test-flow {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }
        .step {
            flex: 1;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
            transition: all 0.3s ease;
        }
        .step.active {
            background: #667eea;
            color: white;
            transform: scale(1.05);
        }
        .step.completed {
            background: #48bb78;
            color: white;
        }
        .step h3 {
            margin: 0 0 10px 0;
            font-size: 18px;
        }
        .step p {
            margin: 0;
            font-size: 14px;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            transition: background 0.3s ease;
        }
        button:hover {
            background: #5a67d8;
        }
        button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }
        .result-box {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            background: #c6f6d5;
            border: 2px solid #48bb78;
            color: #22543d;
        }
        .error {
            background: #fed7d7;
            border: 2px solid #fc8181;
            color: #742a2a;
        }
        .info {
            background: #e9ecef;
            border: 2px solid #adb5bd;
            color: #495057;
        }
        .access-code-display {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            padding: 20px;
            background: #f0f4ff;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
            letter-spacing: 2px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-indicator.pending {
            background: #fbbf24;
        }
        .status-indicator.success {
            background: #34d399;
        }
        .status-indicator.error {
            background: #f87171;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª æ¨¡æ‹Ÿæ”¯ä»˜æµ‹è¯• - CloudBaseæ•°æ®å†™å…¥éªŒè¯</h1>
        
        <div class="test-flow">
            <div class="step" id="step1">
                <h3>æ­¥éª¤ 1</h3>
                <p>åˆ›å»ºæµ‹è¯•è®¢å•</p>
            </div>
            <div class="step" id="step2">
                <h3>æ­¥éª¤ 2</h3>
                <p>æ¨¡æ‹Ÿæ”¯ä»˜å›è°ƒ</p>
            </div>
            <div class="step" id="step3">
                <h3>æ­¥éª¤ 3</h3>
                <p>ç”Ÿæˆè®¿é—®ç </p>
            </div>
            <div class="step" id="step4">
                <h3>æ­¥éª¤ 4</h3>
                <p>éªŒè¯è®¿é—®ç </p>
            </div>
        </div>

        <div style="text-align: center; margin: 30px 0;">
            <button onclick="startSimulation()">ğŸš€ å¼€å§‹æ¨¡æ‹Ÿæ”¯ä»˜æµç¨‹</button>
            <button onclick="testDirectGenerate()">âš¡ ç›´æ¥ç”Ÿæˆè®¿é—®ç æµ‹è¯•</button>
            <button onclick="clearResults()">ğŸ—‘ï¸ æ¸…ç©ºç»“æœ</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        const API_BASE = 'https://cloud1-4g1r5ho01a0cfd85.service.tcloudbase.com';
        let generatedAccessCode = null;
        let currentOrderId = null;
        
        function log(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const msgDiv = document.createElement('div');
            msgDiv.className = `result-box ${type}`;
            msgDiv.innerHTML = `<span class="status-indicator ${type}"></span>${new Date().toLocaleTimeString()} - ${message}`;
            resultsDiv.appendChild(msgDiv);
            console.log(message);
        }
        
        function updateStep(stepNum, status) {
            const step = document.getElementById(`step${stepNum}`);
            step.className = `step ${status}`;
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
            for (let i = 1; i <= 4; i++) {
                updateStep(i, '');
            }
            generatedAccessCode = null;
            currentOrderId = null;
        }
        
        async function startSimulation() {
            clearResults();
            log('========== å¼€å§‹æ¨¡æ‹Ÿæ”¯ä»˜æµç¨‹ ==========', 'info');
            
            // æ­¥éª¤1: åˆ›å»ºè®¢å•
            updateStep(1, 'active');
            currentOrderId = 'SIM-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            const deviceId = 'test-device-' + Math.random().toString(36).substr(2, 9);
            
            log(`åˆ›å»ºæ¨¡æ‹Ÿè®¢å•: ${currentOrderId}`, 'info');
            log(`è®¾å¤‡ID: ${deviceId}`, 'info');
            
            // æ¨¡æ‹Ÿåœ¨æ•°æ®åº“ä¸­åˆ›å»ºè®¢å•ï¼ˆå®é™…éœ€è¦äº‘å‡½æ•°æ”¯æŒï¼‰
            const orderData = {
                orderId: currentOrderId,
                amount: 99.00,
                currency: 'CNY',
                status: 'paid', // æ¨¡æ‹Ÿå·²æ”¯ä»˜
                deviceId: deviceId,
                paymentMethod: 'simulation',
                createdAt: new Date().toISOString(),
                paidAt: new Date().toISOString()
            };
            
            log(`è®¢å•æ•°æ®: \n${JSON.stringify(orderData, null, 2)}`, 'info');
            updateStep(1, 'completed');
            
            await delay(1000);
            
            // æ­¥éª¤2: æ¨¡æ‹Ÿæ”¯ä»˜å›è°ƒ
            updateStep(2, 'active');
            log('æ¨¡æ‹ŸZ-payæ”¯ä»˜å›è°ƒ...', 'info');
            
            // è¿™é‡Œåº”è¯¥è°ƒç”¨ zpay-callback å‡½æ•°ï¼Œä½†å®ƒéœ€è¦çœŸå®çš„æ”¯ä»˜æ•°æ®
            // æ‰€ä»¥æˆ‘ä»¬è·³è¿‡è¿™ä¸€æ­¥ï¼Œç›´æ¥è¿›è¡Œæ­¥éª¤3
            
            log('âš ï¸ è·³è¿‡æ”¯ä»˜å›è°ƒï¼ˆéœ€è¦äº‘å‡½æ•°æ”¯æŒæ¨¡æ‹Ÿæ¨¡å¼ï¼‰', 'info');
            updateStep(2, 'completed');
            
            await delay(1000);
            
            // æ­¥éª¤3: ç”Ÿæˆè®¿é—®ç 
            updateStep(3, 'active');
            log('è°ƒç”¨ generate-access-code API...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/generate-access-code`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Request-Source': 'IC-Studio-Simulation'
                    },
                    body: JSON.stringify({
                        orderId: currentOrderId,
                        deviceId: deviceId,
                        paymentMethod: 'simulation',
                        amount: 99.00,
                        timestamp: Date.now()
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    generatedAccessCode = result.accessCode;
                    log(`âœ… è®¿é—®ç ç”ŸæˆæˆåŠŸï¼`, 'success');
                    
                    // æ˜¾ç¤ºè®¿é—®ç 
                    const codeDisplay = document.createElement('div');
                    codeDisplay.className = 'access-code-display';
                    codeDisplay.innerHTML = `è®¿é—®ç : ${generatedAccessCode}`;
                    document.getElementById('results').appendChild(codeDisplay);
                    
                    updateStep(3, 'completed');
                } else {
                    log(`âŒ ç”Ÿæˆè®¿é—®ç å¤±è´¥: ${result.message}`, 'error');
                    log(`è¯¦ç»†ä¿¡æ¯: ${JSON.stringify(result, null, 2)}`, 'error');
                    updateStep(3, 'error');
                    
                    // æä¾›è§£å†³æ–¹æ¡ˆ
                    log('\nğŸ’¡ å¤±è´¥åŸå› åˆ†æï¼š', 'info');
                    log('1. äº‘å‡½æ•°éœ€è¦éªŒè¯è®¢å•æ˜¯å¦å­˜åœ¨ä¸”å·²æ”¯ä»˜', 'info');
                    log('2. å½“å‰çš„ generate-access-code å‡½æ•°éœ€è¦çœŸå®çš„è®¢å•è®°å½•', 'info');
                    log('3. å»ºè®®åˆ›å»ºä¸€ä¸ªæµ‹è¯•æ¨¡å¼ï¼Œè·³è¿‡è®¢å•éªŒè¯', 'info');
                    return;
                }
            } catch (error) {
                log(`âŒ APIè°ƒç”¨å¤±è´¥: ${error.message}`, 'error');
                updateStep(3, 'error');
                return;
            }
            
            await delay(1000);
            
            // æ­¥éª¤4: éªŒè¯è®¿é—®ç 
            updateStep(4, 'active');
            log('éªŒè¯ç”Ÿæˆçš„è®¿é—®ç ...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/verify-access-code`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Request-Source': 'IC-Studio-Simulation'
                    },
                    body: JSON.stringify({
                        code: generatedAccessCode,
                        deviceId: deviceId,
                        timestamp: Date.now()
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    log(`âœ… è®¿é—®ç éªŒè¯æˆåŠŸï¼`, 'success');
                    log(`éªŒè¯ç»“æœ: ${JSON.stringify(result.data, null, 2)}`, 'success');
                    updateStep(4, 'completed');
                    
                    log('\nğŸ‰ å®Œæ•´æµç¨‹æµ‹è¯•æˆåŠŸï¼CloudBaseæ•°æ®å†™å…¥æ­£å¸¸å·¥ä½œï¼', 'success');
                } else {
                    log(`âŒ è®¿é—®ç éªŒè¯å¤±è´¥: ${result.message}`, 'error');
                    updateStep(4, 'error');
                }
            } catch (error) {
                log(`âŒ éªŒè¯APIè°ƒç”¨å¤±è´¥: ${error.message}`, 'error');
                updateStep(4, 'error');
            }
        }
        
        async function testDirectGenerate() {
            clearResults();
            log('========== ç›´æ¥ç”Ÿæˆè®¿é—®ç æµ‹è¯• ==========', 'info');
            log('å°è¯•åˆ›å»ºä¸€ä¸ªæµ‹è¯•è®¿é—®ç ï¼ˆç»•è¿‡è®¢å•éªŒè¯ï¼‰...', 'info');
            
            // è¿™éœ€è¦äº‘å‡½æ•°æ”¯æŒæµ‹è¯•æ¨¡å¼
            const testData = {
                orderId: 'TEST-DIRECT-' + Date.now(),
                deviceId: 'test-direct-device',
                paymentMethod: 'test',
                amount: 0,
                timestamp: Date.now(),
                testMode: true // æ ‡è®°ä¸ºæµ‹è¯•æ¨¡å¼
            };
            
            try {
                const response = await fetch(`${API_BASE}/generate-access-code`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Request-Source': 'IC-Studio-Test',
                        'X-Test-Mode': 'true' // æ·»åŠ æµ‹è¯•æ¨¡å¼æ ‡å¤´
                    },
                    body: JSON.stringify(testData)
                });
                
                const result = await response.json();
                log(`å“åº”: ${JSON.stringify(result, null, 2)}`, result.success ? 'success' : 'error');
                
                if (!result.success) {
                    log('\nğŸ’¡ å»ºè®®ï¼šéœ€è¦åœ¨äº‘å‡½æ•°ä¸­æ·»åŠ æµ‹è¯•æ¨¡å¼æ”¯æŒ', 'info');
                    log('å¯ä»¥é€šè¿‡æ£€æŸ¥ X-Test-Mode æ ‡å¤´æ¥è·³è¿‡è®¢å•éªŒè¯', 'info');
                }
            } catch (error) {
                log(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåçš„æç¤º
        window.addEventListener('load', () => {
            log('æ¨¡æ‹Ÿæ”¯ä»˜æµ‹è¯•å·¥å…·å·²å°±ç»ª', 'info');
            log('ç‚¹å‡»"å¼€å§‹æ¨¡æ‹Ÿæ”¯ä»˜æµç¨‹"æŒ‰é’®è¿›è¡Œæµ‹è¯•', 'info');
            log(`APIç«¯ç‚¹: ${API_BASE}`, 'info');
        });
    </script>
</body>
</html>