<!DOCTYPE html>
<!--
    IC Studio è§†å¥å·¥å…· - ä¸“ä¸šçº§è§†å¥æ—‹å¾‹ç”Ÿæˆå™¨
    Professional Music Sight-Reading Tool
    
    Copyright Â© 2025. All rights reserved. Igor Chen - icstudio.club
    
    Author: Igor Chen
    Website: https://icstudio.club
    Email: service@icstudio.club
    
    This software provides professional-grade sight-reading melody generation
    with advanced music theory features and Apple-inspired design.
-->
<html lang="zh-CN"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IC Studio è§†å¥å·¥å…· - ä¸“ä¸šçº§è§†å¥æ—‹å¾‹ç”Ÿæˆå™¨</title>
    
    <!-- Favicon - å¤šç§æ ¼å¼æ”¯æŒ -->
    <link rel="icon" type="image/svg+xml" href="sight-reading-icon.svg">
    <link rel="alternate icon" href="sight-reading-icon.svg">
    <link rel="shortcut icon" type="image/svg+xml" href="sight-reading-icon.svg">
    <link rel="apple-touch-icon" href="sight-reading-icon.svg">
    <link rel="mask-icon" href="sight-reading-icon.svg" color="#007AFF">
    
    <!-- Preconnect to external domains -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net">

    <!-- Umami Analytics -->
    <script defer src="https://cloud.umami.is/script.js" data-website-id="24f8b47e-5590-49d6-a19e-4c34929d6741"></script>

    <!-- Early Access Check - æ—©æœŸæƒé™æ£€æŸ¥ï¼Œé˜²æ­¢è¯•ç”¨ç•Œé¢é—ªçƒ -->
    <script>
        (function() {
            // æ—©æœŸæƒé™æ£€æŸ¥å‡½æ•°
            function hasValidAccessCode() {
                try {
                    const accessData = localStorage.getItem('ic-premium-access');
                    if (!accessData) return false;

                    const data = JSON.parse(accessData);
                    if (!data || !data.code || data.code.length !== 12) return false;

                    // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
                    if (data.expiresAt && data.expiresAt !== null && Date.now() > data.expiresAt) {
                        return false;
                    }

                    // æ£€æŸ¥æµ‹è¯•å‰ç¼€
                    if (!data.serverVerified) {
                        const hasObviousTestPrefix = ['TEST', 'DEMO', 'FORCE', 'BACKUP', 'EMERGENCY'].some(prefix => data.code.startsWith(prefix));
                        if (hasObviousTestPrefix) {
                            localStorage.removeItem('ic-premium-access');
                            return false;
                        }
                    }

                    return true;
                } catch (error) {
                    return false;
                }
            }

            // æ£€æŸ¥å…¶ä»–æƒé™æ ‡è®°
            function hasOtherAccessMarkers() {
                return localStorage.getItem('ic-verified-user') === 'true' ||
                       localStorage.getItem('ic-full-access') === 'true' ||
                       localStorage.getItem('ic-sight-reading-license');
            }

            // è®¾ç½®å…¨å±€æƒé™çŠ¶æ€
            window.IC_PREMIUM_USER = hasValidAccessCode() || hasOtherAccessMarkers();

            if (window.IC_PREMIUM_USER) {
                console.log('ğŸš€ æ—©æœŸæ£€æµ‹ï¼šå®Œæ•´ç‰ˆç”¨æˆ·ï¼Œå°†éšè—è¯•ç”¨ç•Œé¢');

                // æ·»åŠ CSSæ¥ç«‹å³éšè—è¯•ç”¨ç›¸å…³å…ƒç´ 
                const style = document.createElement('style');
                style.textContent = `
                    #trial-status,
                    #zpay-container,
                    #access-code-container,
                    .trial-only,
                    .trial-warning,
                    .trial-limit {
                        display: none !important;
                    }
                `;
                document.head.appendChild(style);

                // è®¾ç½®æ ‡è®°ä¾›åç»­è„šæœ¬ä½¿ç”¨
                window.IC_EARLY_PREMIUM_DETECTED = true;
            } else {
                console.log('ğŸ’¡ æ—©æœŸæ£€æµ‹ï¼šæ™®é€šç”¨æˆ·ï¼Œæ˜¾ç¤ºè¯•ç”¨ç•Œé¢');
                window.IC_EARLY_PREMIUM_DETECTED = false;
            }
        })();
    </script>

    <!-- Critical CSS - Inlined for faster loading and fallback -->
    <style>
        /* å®Œæ•´çš„å…³é”®æ ·å¼ - ç¡®ä¿é¡µé¢åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½èƒ½æ­£å¸¸æ˜¾ç¤º */
        :root {
            --primary-blue: #007AFF;
            --secondary-blue: #5AC8FA;
            --neutral-white: #FFFFFF;
            --neutral-light: #F2F2F7;
            --neutral-medium: #C7C7CC;
            --neutral-dark: #8E8E93;
            --neutral-black: #1D1D1F;
            --accent-green: #34C759;
            --accent-orange: #FF9500;
            --background-blur: rgba(255, 255, 255, 0.8);
            --card-shadow: rgba(0, 0, 0, 0.04);
            --border-color: rgba(0, 0, 0, 0.06);
            --body-bg: #f5f5f7;
            --font-system: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }
        [data-theme="dark"] {
            --primary-blue: #0A84FF;
            --neutral-white: #2C2C2E;
            --neutral-light: #3A3A3C;
            --neutral-medium: #48484A;
            --neutral-dark: #8E8E93;
            --neutral-black: #F2F2F7;
            --accent-green: #32D74B;
            --accent-orange: #FF9F0A;
            --background-blur: rgba(44, 44, 46, 0.8);
            --card-shadow: rgba(0, 0, 0, 0.4);
            --border-color: rgba(255, 255, 255, 0.1);
            --body-bg: #1C1C1E;
        }
        body {
            font-family: var(--font-system);
            background: var(--body-bg);
            color: var(--neutral-black);
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background: var(--neutral-white);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 20px var(--card-shadow);
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            font-size: 18px;
        }
        /* å…³é”®ç»„ä»¶æ ·å¼ - ç¡®ä¿åŸºæœ¬å¸ƒå±€å§‹ç»ˆæ­£å¸¸ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #ffffff;
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: 18px;
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 32px var(--card-shadow);
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            z-index: 1;
            border-top: 8px solid #007bff58;
        }
        .header {
            background: #007bff05;
            color: #1d1d1f;
            padding: 40px 30px;
            text-align: center;
            border-bottom: 1px solid #d2d2d7;
        }
        .header h1 {
            font-family: var(--font-system);
            font-size: 3.2rem;
            margin-bottom: 12px;
            font-weight: 400;
            letter-spacing: -0.03em;
            line-height: 1.1;
            color: #1d1d1f;
        }
        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            padding: 30px;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        }
        .control-section {
            background: #ffffff;
            padding: 22px;
            border-radius: 14px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
            border: 1px solid rgba(0, 0, 0, 0.04);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .control-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.08);
            border-color: rgba(0, 122, 255, 0.1);
        }
        .primary-button {
            width: 100%;
            background: linear-gradient(135deg, #007aff 0%, #5ac8fa 100%);
            color: #FFFFFF;
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 0 4px 15px rgba(0, 122, 255, 0.25);
            position: relative;
            overflow: hidden;
        }
        .primary-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 122, 255, 0.35);
        }
        select, input {
            width: 100%;
            padding: 14px 18px;
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 400;
            color: #1d1d1f;
            background: #ffffff;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.02);
        }
        select:focus, input:focus {
            outline: none;
            border-color: #007aff;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15);
            transform: translateY(-1px);
        }
        #scoreContainer {
            margin: 30px;
            padding: 40px;
            background: #ffffff;
            border-radius: 14px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(0, 0, 0, 0.04);
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            color: #6e6e73;
            letter-spacing: -0.01em;
        }
    </style>
    
    <!-- ä¸»æ ·å¼æ–‡ä»¶ - ä½¿ç”¨ç»å¯¹è·¯å¾„ç¡®ä¿å¼ºåˆ¶åˆ·æ–°æ—¶èƒ½æ­£ç¡®åŠ è½½ -->
    <link rel="stylesheet" href="/tools/apple-ui-styles.css?v=20250908">
    
    <!-- å­—ä½“æ–‡ä»¶ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/inter@5.0.16/400.css">
    
    <!-- OpenSheetMusicDisplay from CDN -->
    <script async src="https://cdn.jsdelivr.net/npm/opensheetmusicdisplay@1.8.5/build/opensheetmusicdisplay.min.js"></script>

    <!-- OSMD Loader Fix - ç¡®ä¿åº“æ­£ç¡®åŠ è½½ -->
    <script src="js/osmd-loader-fix.js"></script>
    <script src="js/osmd-quick-fix.js"></script>

    <!-- Umami Analytics -->
    <script defer src="https://cloud.umami.is/script.js" data-website-id="24f8b47e-5590-49d6-a19e-4c34929d6741"></script>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div style="text-align: center;">
            <div>æ­£åœ¨åŠ è½½ IC Studio è§†å¥å·¥å…·...</div>
            <div style="font-size: 14px; margin-top: 10px; opacity: 0.7;">è¯·ç¨å€™ç‰‡åˆ»</div>
        </div>
    </div>
    
    <!-- Immediate loading hide script -->
    <script>
    (function() {
        console.log('ğŸš€ Immediate loading hide script started');
        
        // Hide loading after 1 second, no matter what
        setTimeout(function() {
            var loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                console.log('âš¡ Force hiding loading overlay (1 second timer)');
                loadingOverlay.style.opacity = '0';
                loadingOverlay.style.transition = 'opacity 0.3s ease';
                setTimeout(function() {
                    loadingOverlay.style.display = 'none';
                    console.log('âœ… Loading overlay forcefully hidden');
                }, 300);
            }
        }, 1000);
        
        // Emergency fallback - hide after 500ms
        setTimeout(function() {
            var loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay && loadingOverlay.style.display !== 'none') {
                console.log('ğŸ†˜ Emergency fallback - hiding loading overlay');
                loadingOverlay.style.display = 'none';
            }
        }, 500);
    })();
    </script>
    
    <!-- Trial Timer Removed - Now Using Counter System -->
    
    <!-- Premium Access Verification -->
    <!-- Premium overlay removed - integrated trial system replaces this -->

    <div class="container">
        <!-- è¯•ç”¨çŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ -->
        <div id="trial-status" style="margin: 20px 0; padding: 15px; border-radius: 8px; background: #f8f9fa;"></div>
        
        <!-- æ”¯ä»˜åŒºåŸŸ -->
        <div id="zpay-container" style="display: none; margin: 20px 0; padding: 20px; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <!-- éšè—æ”¯ä»˜æŒ‰é’®éƒ¨åˆ† -->
            <div id="payment-section" style="display: none;">
                <h3 style="color: #667eea; margin-bottom: 15px;">è´­ä¹°å®Œæ•´ç‰ˆ</h3>
                
                <!-- ä½¿ç”¨æ¡æ¬¾ç¡®è®¤ -->
                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea;">
                    <label style="display: flex; align-items: flex-start; cursor: pointer; font-size: 14px; color: #555;">
                        <input type="checkbox" id="terms-checkbox" onchange="togglePaymentButton()" style="margin-right: 10px; margin-top: 3px; transform: scale(1.2);">
                        <span>æˆ‘å·²é˜…è¯»å¹¶åŒæ„ <a href="#" onclick="showTermsDialog()" style="color: #667eea; text-decoration: none;">ã€Šä½¿ç”¨æ¡æ¬¾ã€‹</a> å’Œ <a href="#" onclick="showPrivacyDialog()" style="color: #667eea; text-decoration: none;">ã€Šéšç§æ”¿ç­–ã€‹</a></span>
                    </label>
                </div>
                
                <div id="payment-button-container" style="display: none;">
                    <button id="zpay-btn" onclick="window.createZPayment()" style="display: inline-block; background: linear-gradient(135deg, #1677FF 0%, #00A0E9 100%); color: white; padding: 15px 30px; border: none; border-radius: 12px; font-weight: 600; font-size: 16px; box-shadow: 0 8px 25px rgba(22, 119, 255, 0.3); cursor: pointer;">
                        æ”¯ä»˜å® ï¿¥48.00 (æ—©é¸Ÿä»·)
                    </button>
                    <p style="font-size: 14px; color: #888; margin-top: 15px;">*ä½¿ç”¨æ”¯ä»˜å®å®‰å…¨æ”¯ä»˜ï¼Œæ”¯ä»˜æˆåŠŸåç«‹å³è·å¾—ä¸“å±è®¿é—®ç *</p>
                </div>
            </div>
            
            <!-- è®¿é—®ç éªŒè¯åŒºåŸŸ -->
            <div style="margin-top: 20px;">
                <h3 style="color: #667eea; margin-bottom: 10px;">è¾“å…¥è®¿é—®ç </h3>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="access-code-input" placeholder="è¾“å…¥è®¿é—®ç (11-12ä½)" 
                           style="flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; text-transform: uppercase; transition: border-color 0.3s ease;"
                           maxlength="12" oninput="handleInputChange()" onkeyup="handleInputChange()" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#ddd'">
                    <button onclick="handleVerifyClick()" id="verify-btn"
                            style="padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: not-allowed; font-weight: 600; font-size: 14px; transition: all 0.3s ease; opacity: 1;"
                            onmousedown="this.style.opacity='0.3'; this.style.transform='scale(0.98)'"
                            onmouseup="this.style.transform='scale(1)'; setTimeout(() => { this.style.opacity='1'; }, 100)"
                            onmouseleave="this.style.transform='scale(1)'; setTimeout(() => { this.style.opacity='1'; }, 100)">
                        éªŒè¯
                    </button>
                </div>
                <div id="verify-result" style="margin-top: 10px; font-size: 14px;"></div>
                <!-- å¿˜è®°è®¿é—®ç åŠŸèƒ½å·²ç§»é™¤ï¼Œè¯·å‚è€ƒFAQ -->
            </div>
        </div>
        <div class="header">
            <div class="header-content">
                <div class="header-text">
                    <h1 data-i18n="app.title">IC Studio - è§†å¥æ—‹å¾‹ç”Ÿæˆå™¨</h1>
                    <p data-i18n="app.subtitle">ä¸“ä¸šçº§ä¹è°±æ¸²æŸ“ä¸éŸ³ä¹ç†è®ºå·¥å…·</p>
                </div>
                <div class="header-controls">
                    <div class="settings-dropdown">
                        <button class="settings-btn" id="settingsBtn" onclick="toggleSettings()">
                            <span data-i18n="settings.title">è®¾ç½®</span>
                        </button>
                        <div class="settings-menu" id="settingsMenu">
                            <!-- ä¸»é¢˜è®¾ç½® -->
                            <div class="settings-section">
                                <div class="settings-section-title" data-i18n="settings.theme">ä¸»é¢˜</div>
                                <div class="theme-options">
                                    <div class="theme-option" onclick="setTheme('light')">
                                        <span data-i18n="settings.lightMode">æµ…è‰²æ¨¡å¼</span>
                                    </div>
                                    <div class="theme-option" onclick="setTheme('dark')">
                                        <span data-i18n="settings.darkMode">æ·±è‰²æ¨¡å¼</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- è¯­è¨€è®¾ç½® -->
                            <div class="settings-section">
                                <div class="settings-section-title" data-i18n="settings.language">è¯­è¨€</div>
                                <div class="language-options">
                                    <div class="language-option" onclick="switchLanguage('zh-CN')">
                                        ğŸ‡¨ğŸ‡³ ç®€ä½“ä¸­æ–‡
                                    </div>
                                    <div class="language-option" onclick="switchLanguage('zh-TW')">
                                        ğŸ‡¹ğŸ‡¼ ç¹é«”ä¸­æ–‡
                                    </div>
                                    <div class="language-option" onclick="switchLanguage('en')">
                                        ğŸ‡ºğŸ‡¸ English
                                    </div>
                                </div>
                            </div>


                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="control-row">
                <div class="control-group">
                    <label data-i18n="controls.interval">éŸ³ç¨‹è·¨åº¦</label>
                    <button class="btn-secondary" onclick="openIntervalSettings()" id="intervalSettingsBtn" data-i18n="controls.intervalSettings">
                        éŸ³ç¨‹è®¾ç½®
                    </button>
                </div>

                <div class="control-group">
                    <label data-i18n="controls.measures">å°èŠ‚æ•°</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="measures-2" name="measures" value="2">
                            <label for="measures-2" data-i18n="controls.measures2">2å°èŠ‚</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="measures-4" name="measures" value="4" checked="">
                            <label for="measures-4" data-i18n="controls.measures4">4å°èŠ‚</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="measures-8" name="measures" value="8">
                            <label for="measures-8" data-i18n="controls.measures8">8å°èŠ‚</label>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <label data-i18n="controls.key">è°ƒå·</label>
                    <button class="btn-secondary" onclick="openKeySettings()" id="keySettingsBtn" data-i18n="controls.keySettings">
                        è°ƒå·è®¾ç½®
                    </button>
                </div>

                <div class="control-group">
                    <label data-i18n="controls.time">æ‹å·</label>
                    <button class="btn-secondary" onclick="openTimeSignatureSettings()" id="timeSignatureSettingsBtn" data-i18n="controls.timeSettings">
                        æ‹å·è®¾ç½®
                    </button>
                </div>

                <div class="control-group">
                    <label data-i18n="controls.clef">è°±å·</label>
                    <button class="btn-secondary" onclick="openClefSettings()" id="clefSettingsBtn" data-i18n="controls.clefSettings">
                        è°±å·è®¾ç½®
                    </button>
                </div>
            </div>

            <!-- æ–°å¢ï¼šéŸ³åŸŸè®¾ç½® -->
            <div class="control-row">
                <div class="control-group">
                    <label for="rangeMin" data-i18n="controls.rangeMin">æœ€ä½éŸ³</label>
                    <select id="rangeMin">
                        <option value="33">A1</option>
                        <option value="35">B1</option>
                        <option value="36">C2</option>
                        <option value="38">D2</option>
                        <option value="40">E2</option>
                        <option value="41">F2</option>
                        <option value="43">G2</option>
                        <option value="45">A2</option>
                        <option value="47">B2</option>
                        <option value="48">C3</option>
                        <option value="50">D3</option>
                        <option value="52">E3</option>
                        <option value="53">F3</option>
                        <option value="55">G3</option>
                        <option value="57">A3</option>
                        <option value="59">B3</option>
                        <option value="60" selected="">C4</option>
                        <option value="62">D4</option>
                        <option value="64">E4</option>
                        <option value="65">F4</option>
                        <option value="67">G4</option>
                        <option value="69">A4</option>
                        <option value="71">B4</option>
                        <option value="72">C5</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="rangeMax" data-i18n="controls.rangeMax">æœ€é«˜éŸ³</label>
                    <select id="rangeMax">
                        <option value="48">C3</option>
                        <option value="50">D3</option>
                        <option value="52">E3</option>
                        <option value="53">F3</option>
                        <option value="55">G3</option>
                        <option value="57">A3</option>
                        <option value="59">B3</option>
                        <option value="60">C4</option>
                        <option value="62">D4</option>
                        <option value="64">E4</option>
                        <option value="65">F4</option>
                        <option value="67">G4</option>
                        <option value="69">A4</option>
                        <option value="71">B4</option>
                        <option value="72">C5</option>
                        <option value="74">D5</option>
                        <option value="76">E5</option>
                        <option value="77">F5</option>
                        <option value="79">G5</option>
                        <option value="81" selected="">A5</option>
                        <option value="82">B5</option>
                        <option value="83">C6</option>
                        <option value="84">D6</option>
                        <option value="85">E6</option>
                    </select>
                </div>

                <div class="control-group" style="flex: none; width: 140px;">
                    <label for="accidentalRate" data-i18n="controls.accidental">ä¸´æ—¶è®°å·</label>
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <input type="range" id="accidentalRate" min="0" max="100" value="0" step="10" style="width: 90px;">
                        <span id="accidentalRateValue" style="font-weight: 400; min-width: 30px;">0%</span>
                    </div>
                </div>

                <div class="control-group metronome-group" style="flex: none; width: 160px;">
                    <label for="headerMetronomeBpm" data-i18n="controls.metronome">èŠ‚æ‹å™¨</label>
                    <div class="metronome-control">
                        <input type="number" id="headerMetronomeBpm" min="1" max="999" value="60" class="bpm-input-control">
                        <button class="metronome-play-btn" id="headerMetronomeBtn" onclick="toggleMetronome()" title="å¼€å§‹/åœæ­¢èŠ‚æ‹å™¨">
                            ğŸµ
                        </button>
                        <div class="metronome-beat-indicator" id="headerBeatIndicator"></div>
                    </div>
                </div>
            </div>

            <div class="control-row">
                <div class="buttons">
                    <button class="btn-primary" onclick="generateMelody()" data-i18n="controls.generate">
                        ç”Ÿæˆæ—‹å¾‹
                    </button>
                    <div class="button-group">
                        <button class="btn-secondary" onclick="previousMelody()" data-i18n="controls.previous">
                            ä¸Šä¸€æ¡
                        </button>
                        <button class="btn-secondary" onclick="nextMelody()" data-i18n="controls.next">
                            ä¸‹ä¸€æ¡
                        </button>
                    </div>
                    <div class="button-group">
                        <button class="btn-secondary" onclick="openRhythmSettings()" data-i18n="controls.rhythm">
                            èŠ‚å¥è®¾ç½®
                        </button>
                        <button class="btn-secondary" onclick="openArticulationSettings()" data-i18n="controls.articulation">
                            æ¼”å¥æŠ€å·§
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="score-container">
            <div id="score">
                <div class="empty-score-message">
                    <p data-i18n="score.empty">ç‚¹å‡»ç”Ÿæˆæ—‹å¾‹å¼€å§‹ç»ƒä¹ </p>
                </div>
            </div>
        </div>
        
        <!-- Copyright Information -->
        <div style="
            padding: 5px 0;
            text-align: center;
            font-size: 14px;
            color: var(--neutral-dark);
            opacity: 0.7;
            border-top: 1px solid var(--border-color);
            margin-top: 7.5px;
        ">
            <p style="margin: 0; line-height: 1.5;">
                <strong>IC Studio è§†å¥å·¥å…·</strong> - ä¸“ä¸šçº§è§†å¥æ—‹å¾‹ç”Ÿæˆå™¨
            </p>
            <p style="margin: 8px 0 0 0; font-size: 13px; opacity: 0.8;">
                Copyright Â© 2025. All rights reserved. Igor Chen - 
                <a href="https://icstudio.club" target="_blank" style="color: var(--primary-blue); text-decoration: none;">icstudio.club</a>
            </p>
        </div>

    </div>

    <!-- èŠ‚å¥è®¾ç½®å¼¹çª— -->
    <div id="rhythmModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>èŠ‚å¥è®¾ç½®</h3>
                <button class="close-btn" onclick="closeRhythmSettings()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4>åŸºæœ¬èŠ‚å¥å•ä½</h4>
                        <button class="btn-select-all" onclick="selectAllRhythms()" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">å…¨é€‰</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item" id="rhythm-whole-label">
                            <input type="checkbox" id="rhythm-whole" value="whole">
                            <span>å…¨éŸ³ç¬¦</span>
                        </label>
                        <label class="checkbox-item" id="rhythm-dotted-half-label" style="display: none;">
                            <input type="checkbox" id="rhythm-dotted-half" value="half.">
                            <span>é™„ç‚¹äºŒåˆ†éŸ³ç¬¦</span>
                        </label>
                        <label class="checkbox-item" id="rhythm-half-label">
                            <input type="checkbox" id="rhythm-half" value="half" checked="">
                            <span>äºŒåˆ†éŸ³ç¬¦</span>
                        </label>
                        <label class="checkbox-item" id="rhythm-dotted-quarter-label" style="display: none;">
                            <input type="checkbox" id="rhythm-dotted-quarter" value="quarter.">
                            <span>é™„ç‚¹å››åˆ†éŸ³ç¬¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="rhythm-quarter" value="quarter" checked="">
                            <span>å››åˆ†éŸ³ç¬¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="rhythm-eighth" value="eighth" checked="">
                            <span>å…«åˆ†éŸ³ç¬¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="rhythm-16th" value="16th">
                            <span>åå…­åˆ†éŸ³ç¬¦</span>
                        </label>
                        <label class="checkbox-item" id="rhythm-triplet-label" style="display: flex;">
                            <input type="checkbox" id="rhythm-triplet" value="triplet">
                            <span>ä¸‰è¿éŸ³</span>
                        </label>
                        <label class="checkbox-item" id="rhythm-duplet-label" style="display: none;">
                            <input type="checkbox" id="rhythm-duplet" value="duplet">
                            <span>äºŒè¿éŸ³</span>
                        </label>
                        <label class="checkbox-item" id="rhythm-quadruplet-label" style="display: none;">
                            <input type="checkbox" id="rhythm-quadruplet" value="quadruplet">
                            <span>å››è¿éŸ³</span>
                        </label>
                    </div>
                </div>
                
                <!-- é«˜çº§è®¾ç½®åŒºåŸŸ -->
                <div id="rhythmAdvancedSettings" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 2px solid #e9ecef;">
                    <h4 style="margin-bottom: 15px; color: #495057;">é«˜çº§é¢‘ç‡è®¾ç½®</h4>
                    <p style="font-size: 0.9rem; color: #6c757d; margin-bottom: 20px;">è°ƒæ•´å„èŠ‚å¥å•ä½åœ¨æ—‹å¾‹ä¸­çš„å‡ºç°é¢‘ç‡ (0% = ä¸ä½¿ç”¨, 100% = ä¼˜å…ˆä½¿ç”¨)</p>
                    
                    <div class="rhythm-frequency-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="frequency-item" id="freq-whole-item">
                            <label for="freq-whole" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">å…¨éŸ³ç¬¦é¢‘ç‡:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-whole" min="0" max="100" value="10" style="flex: 1;">
                                <span id="freq-whole-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">10%</span>
                            </div>
                        </div>
                        <div class="frequency-item" id="freq-dotted-half-item" style="display: none;">
                            <label for="freq-dotted-half" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">é™„ç‚¹äºŒåˆ†éŸ³ç¬¦é¢‘ç‡:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-dotted-half" min="0" max="100" value="15" style="flex: 1;">
                                <span id="freq-dotted-half-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">15%</span>
                            </div>
                        </div>
                        <div class="frequency-item" id="freq-half-item">
                            <label for="freq-half" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">äºŒåˆ†éŸ³ç¬¦é¢‘ç‡:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-half" min="0" max="100" value="30" style="flex: 1;">
                                <span id="freq-half-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">30%</span>
                            </div>
                        </div>
                        <div class="frequency-item" id="freq-dotted-quarter-item" style="display: none;">
                            <label for="freq-dotted-quarter" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">é™„ç‚¹å››åˆ†éŸ³ç¬¦é¢‘ç‡:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-dotted-quarter" min="0" max="100" value="35" style="flex: 1;">
                                <span id="freq-dotted-quarter-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">35%</span>
                            </div>
                        </div>
                        <div class="frequency-item">
                            <label for="freq-quarter" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">å››åˆ†éŸ³ç¬¦é¢‘ç‡:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-quarter" min="0" max="100" value="50" style="flex: 1;">
                                <span id="freq-quarter-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">50%</span>
                            </div>
                        </div>
                        <div class="frequency-item">
                            <label for="freq-eighth" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">å…«åˆ†éŸ³ç¬¦é¢‘ç‡:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-eighth" min="0" max="100" value="40" style="flex: 1;">
                                <span id="freq-eighth-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">40%</span>
                            </div>
                        </div>
                        <div class="frequency-item">
                            <label for="freq-16th" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">åå…­åˆ†éŸ³ç¬¦é¢‘ç‡:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-16th" min="0" max="100" value="20" style="flex: 1;">
                                <span id="freq-16th-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">20%</span>
                            </div>
                        </div>
                        <div class="frequency-item" id="freq-triplet-item">
                            <label for="freq-triplet" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">ä¸‰è¿éŸ³é¢‘ç‡:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-triplet" min="0" max="100" value="15" style="flex: 1;">
                                <span id="freq-triplet-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">15%</span>
                            </div>
                        </div>
                        <div class="frequency-item" id="freq-duplet-item" style="display: none;">
                            <label for="freq-duplet" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">äºŒè¿éŸ³é¢‘ç‡:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-duplet" min="0" max="100" value="30" style="flex: 1;">
                                <span id="freq-duplet-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">30%</span>
                            </div>
                        </div>
                        <div class="frequency-item" id="freq-quadruplet-item" style="display: none;">
                            <label for="freq-quadruplet" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">å››è¿éŸ³é¢‘ç‡:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-quadruplet" min="0" max="100" value="25" style="flex: 1;">
                                <span id="freq-quadruplet-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">25%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn-secondary" onclick="resetRhythmFrequencies()" style="margin-right: 10px;">è¿”å›é»˜è®¤</button>
                    </div>
                </div>
                
                <div class="modal-buttons">
                    <button class="btn-secondary" onclick="toggleRhythmAdvancedSettings()" id="rhythmAdvancedBtn">é«˜çº§è®¾ç½®</button>
                    <button class="btn-primary" onclick="saveRhythmSettings()">ä¿å­˜è®¾ç½®</button>
                    <button class="btn-secondary" onclick="closeRhythmSettings()">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Articulations å¼¹çª— -->
    <div id="articulationModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Articulations</h3>
                <button class="close-btn" onclick="closeArticulationSettings()">Ã—</button>
            </div>
            <div class="modal-body">
                <!-- åŸºæœ¬ArticulationæŠ€å·§ -->
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4>åŸºæœ¬æ¼”å¥æ³• (Basic Articulations)</h4>
                        <button class="btn-select-all" onclick="selectAllBasicArticulations()" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">å…¨é€‰</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item" title="æ–­å¥ - éŸ³ç¬¦æ—¶å€¼å‡åŠï¼Œè½»å¿«åœ°æ¼”å¥">
                            <input type="checkbox" id="art-staccato" value="staccato">
                            <span>Staccato (æ–­å¥) â€¢</span>
                        </label>
                        <label class="checkbox-item" title="é‡éŸ³ - å¼ºè°ƒæŸäº›éŸ³ç¬¦">
                            <input type="checkbox" id="art-accent" value="accent">
                            <span>Accent (é‡éŸ³) &gt;</span>
                        </label>
                        <label class="checkbox-item" title="çŸ­å€šéŸ³ - å¿«é€Ÿçš„è£…é¥°éŸ³">
                            <input type="checkbox" id="art-acciaccatura" value="acciaccatura">
                            <span>Acciaccatura (çŸ­å€šéŸ³)</span>
                        </label>
                    </div>
                </div>


                <!-- å‰ä»–ç‰¹æœ‰æŠ€å·§ -->
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4>å‰ä»–æŠ€å·§ (Guitar Techniques)</h4>
                        <button class="btn-select-all" onclick="selectAllGuitarTechniques()" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">å…¨é€‰</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item" title="å‡»å¼¦ - ç”¨å·¦æ‰‹æ•²å‡»äº§ç”ŸéŸ³ç¬¦">
                            <input type="checkbox" id="gtr-hammer" value="hammer-on">
                            <span>Hammer-on (å‡»å¼¦) H</span>
                        </label>
                        <label class="checkbox-item" title="å‹¾å¼¦ - ç”¨å·¦æ‰‹å‹¾ç¦»äº§ç”ŸéŸ³ç¬¦">
                            <input type="checkbox" id="gtr-pull" value="pull-off">
                            <span>Pull-off (å‹¾å¼¦) P</span>
                        </label>
                        <!-- æš‚æ—¶éšè—glissandoç›¸å…³é€‰é¡¹ï¼Œå› ä¸ºOSMDä¸æ”¯æŒæ¸²æŸ“ -->
                        <label class="checkbox-item" title="æ»‘éŸ³ - åœ¨å“æ ¼é—´æ»‘åŠ¨ï¼ˆæ³¨ï¼šOSMDæš‚ä¸æ”¯æŒæ¸²æŸ“ï¼‰" style="display: none;">
                            <input type="checkbox" id="gtr-glissando" value="glissando">
                            <span>Glissando (æ»‘éŸ³) /</span>
                        </label>
                        <label class="checkbox-item" title="æ»‘å…¥ - ä»ä¸‹æ–¹æ»‘å…¥ä¸»éŸ³ï¼ˆæ³¨ï¼šOSMDæš‚ä¸æ”¯æŒæ¸²æŸ“ï¼‰" style="display: none;">
                            <input type="checkbox" id="gtr-slide-in" value="slide-in">
                            <span>Slide In (æ»‘å…¥)</span>
                        </label>
                        <label class="checkbox-item" title="æ»‘å‡º - ä»ä¸»éŸ³æ»‘å‡ºï¼ˆæ³¨ï¼šOSMDæš‚ä¸æ”¯æŒæ¸²æŸ“ï¼‰" style="display: none;">
                            <input type="checkbox" id="gtr-slide-out" value="slide-out">
                            <span>Slide Out (æ»‘å‡º)</span>
                        </label>
                    </div>
                </div>

                <!-- æš‚æ—¶éšè—glissandoç›¸å…³è¯´æ˜ -->
                <div style="padding: 10px 20px; color: #666; font-size: 12px; border-top: 1px solid #eee; margin-top: 10px; display: none;">
                    <small>* æ³¨ï¼šæ ‡æœ‰æ˜Ÿå·çš„æŠ€å·§ï¼ˆGlissandoã€Slide In/Outï¼‰ç”±äºOSMDæ¸²æŸ“å¼•æ“é™åˆ¶ï¼Œæš‚æ—¶ä¼šæ˜¾ç¤ºä¸ºæ–‡æœ¬æç¤ºã€‚</small>
                </div>

                <!-- é«˜çº§è®¾ç½®åŒºåŸŸ -->
                <div id="articulationAdvancedSettings" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 2px solid #e9ecef;">
                    <h4 style="margin-bottom: 15px; color: #495057;">é«˜çº§é¢‘ç‡è®¾ç½®</h4>
                    <p style="font-size: 0.9rem; color: #6c757d; margin-bottom: 20px;">è°ƒæ•´å„æ¼”å¥æ³•åœ¨æ—‹å¾‹ä¸­çš„å‡ºç°é¢‘ç‡ (0% = ä¸ä½¿ç”¨, 100% = ç»å¸¸ä½¿ç”¨)</p>
                    
                    <div style="margin-bottom: 20px;">
                        <h5 style="color: #495057; margin-bottom: 10px;">åŸºæœ¬æ¼”å¥æ³•é¢‘ç‡</h5>
                        <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
                            <div class="frequency-item">
                                <label for="freq-staccato" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">Staccato (æ–­å¥) é¢‘ç‡:</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="range" id="freq-staccato" min="0" max="100" value="20" style="flex: 1;">
                                    <span id="freq-staccato-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">20%</span>
                                </div>
                            </div>
                            <div class="frequency-item">
                                <label for="freq-accent" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">Accent (é‡éŸ³) é¢‘ç‡:</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="range" id="freq-accent" min="0" max="100" value="15" style="flex: 1;">
                                    <span id="freq-accent-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">15%</span>
                                </div>
                            </div>
                            <div class="frequency-item">
                                <label for="freq-acciaccatura" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">Acciaccatura (çŸ­å€šéŸ³) é¢‘ç‡:</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="range" id="freq-acciaccatura" min="0" max="100" value="10" style="flex: 1;">
                                    <span id="freq-acciaccatura-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">10%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h5 style="color: #495057; margin-bottom: 10px;">å‰ä»–æŠ€å·§é¢‘ç‡</h5>
                        <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
                            <div class="frequency-item">
                                <label for="freq-slur" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">å‡»å‹¾å¼¦é¢‘ç‡:</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="range" id="freq-slur" min="0" max="100" value="15" style="flex: 1;">
                                    <span id="freq-slur-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">15%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn-secondary" onclick="resetArticulationFrequencies()" style="margin-right: 10px;">è¿”å›é»˜è®¤</button>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-secondary" onclick="toggleArticulationAdvancedSettings()" id="articulationAdvancedBtn">é«˜çº§è®¾ç½®</button>
                    <button class="btn-primary" onclick="saveArticulationSettings()">ä¿å­˜è®¾ç½®</button>
                    <button class="btn-secondary" onclick="closeArticulationSettings()">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- è°ƒå·è®¾ç½®å¼¹çª— -->
    <div id="keySignatureModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>è°ƒå·è®¾ç½®</h3>
                <button class="close-btn" onclick="closeKeySettings()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4>å¤§è°ƒ (Major)</h4>
                        <button class="btn-select-all" onclick="selectAllMajorKeys()" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">å…¨é€‰å¤§è°ƒ</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-C" value="C" checked>
                            <span>C å¤§è°ƒ</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-G" value="G">
                            <span>G å¤§è°ƒ (1#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-D" value="D">
                            <span>D å¤§è°ƒ (2#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-A" value="A">
                            <span>A å¤§è°ƒ (3#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-E" value="E">
                            <span>E å¤§è°ƒ (4#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-B" value="B">
                            <span>B å¤§è°ƒ (5#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-F#" value="F#">
                            <span>F# å¤§è°ƒ (6#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-F" value="F">
                            <span>F å¤§è°ƒ (1b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Bb" value="Bb">
                            <span>Bb å¤§è°ƒ (2b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Eb" value="Eb">
                            <span>Eb å¤§è°ƒ (3b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Ab" value="Ab">
                            <span>Ab å¤§è°ƒ (4b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Db" value="Db">
                            <span>Db å¤§è°ƒ (5b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Gb" value="Gb">
                            <span>Gb å¤§è°ƒ (6b)</span>
                        </label>
                    </div>
                </div>

                <div class="rhythm-section" style="margin-top: 30px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4>å°è°ƒ (Minor)</h4>
                        <button class="btn-select-all" onclick="selectAllMinorKeys()" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">å…¨é€‰å°è°ƒ</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Am" value="Am">
                            <span>A å°è°ƒ</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Em" value="Em">
                            <span>E å°è°ƒ (1#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Bm" value="Bm">
                            <span>B å°è°ƒ (2#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-F#m" value="F#m">
                            <span>F# å°è°ƒ (3#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-C#m" value="C#m">
                            <span>C# å°è°ƒ (4#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-G#m" value="G#m">
                            <span>G# å°è°ƒ (5#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-D#m" value="D#m">
                            <span>D# å°è°ƒ (6#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Dm" value="Dm">
                            <span>D å°è°ƒ (1b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Gm" value="Gm">
                            <span>G å°è°ƒ (2b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Cm" value="Cm">
                            <span>C å°è°ƒ (3b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Fm" value="Fm">
                            <span>F å°è°ƒ (4b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Bbm" value="Bbm">
                            <span>Bb å°è°ƒ (5b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Ebm" value="Ebm">
                            <span>Eb å°è°ƒ (6b)</span>
                        </label>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveKeySettings()">ä¿å­˜è®¾ç½®</button>
                    <button class="btn-secondary" onclick="closeKeySettings()">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ‹å·è®¾ç½®å¼¹çª— -->
    <div id="timeSignatureModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ‹å·è®¾ç½®</h3>
                <button class="close-btn" onclick="closeTimeSignatureSettings()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4>æ‹å·é€‰é¡¹</h4>
                        <button class="btn-select-all" onclick="selectAllTimeSignatures()" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">å…¨é€‰</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="time-2/4" value="2/4">
                            <span>2/4 æ‹</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="time-3/4" value="3/4">
                            <span>3/4 æ‹</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="time-4/4" value="4/4" checked>
                            <span>4/4 æ‹</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="time-6/8" value="6/8">
                            <span>6/8 æ‹</span>
                        </label>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveTimeSignatureSettings()">ä¿å­˜è®¾ç½®</button>
                    <button class="btn-secondary" onclick="closeTimeSignatureSettings()">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- éŸ³ç¨‹è·¨åº¦è®¾ç½®å¼¹çª— -->
    <div id="intervalModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>éŸ³ç¨‹è·¨åº¦è®¾ç½®</h3>
                <button class="close-btn" onclick="closeIntervalSettings()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4>æœ€å¤§éŸ³ç¨‹è·¨åº¦é€‰é¡¹</h4>
                        <small style="color: #666; font-size: 12px;">åªèƒ½é€‰æ‹©ä¸€ä¸ªéŸ³ç¨‹ä½œä¸ºæœ€å¤§è·¨åº¦</small>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-1" value="1" onchange="handleIntervalCheckboxChange(this)">
                            <span>å°äºŒåº¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-2" value="2" onchange="handleIntervalCheckboxChange(this)">
                            <span>å¤§äºŒåº¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-3" value="3" onchange="handleIntervalCheckboxChange(this)">
                            <span>å°ä¸‰åº¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-4" value="4" onchange="handleIntervalCheckboxChange(this)">
                            <span>å¤§ä¸‰åº¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-5" value="5" onchange="handleIntervalCheckboxChange(this)">
                            <span>å®Œå…¨å››åº¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-6" value="6" onchange="handleIntervalCheckboxChange(this)">
                            <span>å¢å››åº¦/å‡äº”åº¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-7" value="7" onchange="handleIntervalCheckboxChange(this)">
                            <span>å®Œå…¨äº”åº¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-8" value="8" onchange="handleIntervalCheckboxChange(this)">
                            <span>å°å…­åº¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-9" value="9" onchange="handleIntervalCheckboxChange(this)">
                            <span>å¤§å…­åº¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-10" value="10" onchange="handleIntervalCheckboxChange(this)">
                            <span>å°ä¸ƒåº¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-11" value="11" onchange="handleIntervalCheckboxChange(this)">
                            <span>å¤§ä¸ƒåº¦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-12" value="12" checked onchange="handleIntervalCheckboxChange(this)">
                            <span>å®Œå…¨å…«åº¦</span>
                        </label>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveIntervalSettings()">ä¿å­˜è®¾ç½®</button>
                    <button class="btn-secondary" onclick="closeIntervalSettings()">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- è°±å·è®¾ç½®å¼¹çª— -->
    <div id="clefModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>è°±å·è®¾ç½®</h3>
                <button class="close-btn" onclick="closeClefSettings()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4>è°±å·é€‰é¡¹</h4>
                        <button class="btn-select-all" onclick="selectAllClefs()" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">å…¨é€‰</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="clef-treble" value="treble" checked>
                            <span>é«˜éŸ³è°±å· (Gè°±å·)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="clef-bass" value="bass">
                            <span>ä½éŸ³è°±å· (Fè°±å·)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="clef-alto" value="alto">
                            <span>ä¸­éŸ³è°±å· (Cè°±å·)</span>
                        </label>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveClefSettings()">ä¿å­˜è®¾ç½®</button>
                    <button class="btn-secondary" onclick="closeClefSettings()">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <script src="js/minor-scale-spelling.js?v=20250908"></script>
    <script src="js/sight-reading-final.js?v=20250908"></script>
    <script src="js/minor-alterations.js?v=20250908"></script>
    <script src="js/emergency-fix.js?v=20250908"></script>
    
    <!-- å¢å¼ºçš„å…¨é€‰åˆ‡æ¢åŠŸèƒ½ -->
    <script src="enhanced-select-all.js?v=20250908"></script>
    
    <!-- ä¸»é¢˜åˆ‡æ¢ç³»ç»Ÿ -->
    <script>
        // ä¸»é¢˜åˆ‡æ¢ç›¸å…³å˜é‡å’ŒåŠŸèƒ½
        let currentTheme = localStorage.getItem('preferredTheme') || 'light';
        
        // ä¸»é¢˜å›¾æ ‡
        const themeIcons = {
            'light': 'æ·±è‰²', // åœ¨lightæ¨¡å¼æ˜¾ç¤ºæ·±è‰²é€‰é¡¹
            'dark': 'æµ…è‰²'   // åœ¨darkæ¨¡å¼æ˜¾ç¤ºæµ…è‰²é€‰é¡¹
        };
        
        // åˆ‡æ¢ä¸»é¢˜ (ä¿ç•™å‘åå…¼å®¹æ€§)
        function toggleTheme() {
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            setTheme(newTheme);
        }
        
        // è®¾ç½®ä¸»é¢˜ (æ–°ç‰ˆæœ¬ï¼Œç”¨äºè®¾ç½®èœå•)
        function setTheme(theme) {
            currentTheme = theme;
            localStorage.setItem('preferredTheme', theme);
            
            // è®¾ç½®HTMLçš„data-themeå±æ€§
            document.documentElement.setAttribute('data-theme', theme);
            
            // å…³é—­è®¾ç½®èœå•
            closeSettings();
            
            console.log(`ğŸ¨ ä¸»é¢˜å·²è®¾ç½®ä¸º: ${theme}`);
        }
        
        // åº”ç”¨ä¸»é¢˜ (ä¿ç•™å‘åå…¼å®¹æ€§)
        function switchTheme(theme) {
            currentTheme = theme;
            localStorage.setItem('preferredTheme', theme);
            
            // è®¾ç½®HTMLçš„data-themeå±æ€§
            document.documentElement.setAttribute('data-theme', theme);
            
            // æ›´æ–°æŒ‰é’®å›¾æ ‡ (å¦‚æœå­˜åœ¨æ—§çš„ä¸»é¢˜åˆ‡æ¢å™¨)
            const themeSwitcher = document.getElementById('themeSwitcher');
            if (themeSwitcher) {
                themeSwitcher.textContent = themeIcons[theme];
            }
            
            console.log(`ğŸ¨ ä¸»é¢˜å·²åˆ‡æ¢åˆ°: ${theme}`);
        }
        
        // è®¾ç½®èœå•æ§åˆ¶
        function toggleSettings() {
            const settingsMenu = document.getElementById('settingsMenu');
            const isVisible = settingsMenu.classList.contains('show');
            
            if (isVisible) {
                closeSettings();
            } else {
                openSettings();
            }
        }
        
        function openSettings() {
            const settingsMenu = document.getElementById('settingsMenu');
            settingsMenu.classList.add('show');
            
            // æ·»åŠ ç‚¹å‡»å¤–éƒ¨åŒºåŸŸå…³é—­èœå•çš„ç›‘å¬å™¨
            setTimeout(() => {
                document.addEventListener('click', handleClickOutside);
            }, 10);
        }
        
        function closeSettings() {
            const settingsMenu = document.getElementById('settingsMenu');
            settingsMenu.classList.remove('show');
            
            // ç§»é™¤ç‚¹å‡»å¤–éƒ¨åŒºåŸŸçš„ç›‘å¬å™¨
            document.removeEventListener('click', handleClickOutside);
        }
        
        // å¤„ç†ç‚¹å‡»å¤–éƒ¨åŒºåŸŸå…³é—­è®¾ç½®èœå•
        function handleClickOutside(event) {
            const settingsDropdown = document.querySelector('.settings-dropdown');
            
            if (settingsDropdown && !settingsDropdown.contains(event.target)) {
                closeSettings();
            }
        }

        // èŠ‚æ‹å™¨ç›¸å…³å˜é‡å’ŒåŠŸèƒ½
        let metronomeInterval = null;
        let metronomeAudioContext = null;
        let metronomeOscillator = null;
        let isMetronomeRunning = false;
        let metronomeTempo = 60; // é»˜è®¤60 BPM

        // åˆå§‹åŒ–Web Audio API
        function initializeMetronomeAudio() {
            try {
                metronomeAudioContext = new (window.AudioContext || window.webkitAudioContext)();
                console.log('ğŸµ èŠ‚æ‹å™¨éŸ³é¢‘åˆå§‹åŒ–æˆåŠŸ');
                return true;
            } catch (error) {
                console.error('âŒ Web Audio API ä¸æ”¯æŒ:', error);
                return false;
            }
        }

        // æ’­æ”¾èŠ‚æ‹å™¨å£°éŸ³
        function playMetronomeSound() {
            if (!metronomeAudioContext) {
                if (!initializeMetronomeAudio()) return;
            }

            try {
                // æ¢å¤éŸ³é¢‘ä¸Šä¸‹æ–‡ï¼ˆç”¨æˆ·äº¤äº’åï¼‰
                if (metronomeAudioContext.state === 'suspended') {
                    metronomeAudioContext.resume();
                }

                const oscillator = metronomeAudioContext.createOscillator();
                const gainNode = metronomeAudioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(metronomeAudioContext.destination);
                
                // è®¾ç½®éŸ³è°ƒ (é«˜éŸ³è°ƒçš„å˜€å—’å£°)
                oscillator.frequency.setValueAtTime(800, metronomeAudioContext.currentTime);
                
                // è®¾ç½®éŸ³é‡åŒ…ç»œ
                gainNode.gain.setValueAtTime(0, metronomeAudioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.3, metronomeAudioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.01, metronomeAudioContext.currentTime + 0.1);
                
                oscillator.start(metronomeAudioContext.currentTime);
                oscillator.stop(metronomeAudioContext.currentTime + 0.1);

                // è§†è§‰åé¦ˆ - æ›´æ–°headeræŒ‡ç¤ºå™¨
                const headerIndicator = document.getElementById('headerBeatIndicator');
                
                if (headerIndicator) {
                    headerIndicator.classList.add('beat');
                    setTimeout(() => {
                        headerIndicator.classList.remove('beat');
                    }, 150);
                }
                
            } catch (error) {
                console.error('âŒ èŠ‚æ‹å™¨å£°éŸ³æ’­æ”¾å¤±è´¥:', error);
            }
        }

        // è®¾ç½®èŠ‚æ‹å™¨é€Ÿåº¦
        function setMetronomeTempo(bpm) {
            metronomeTempo = Math.max(1, Math.min(999, bpm));
            
            // åŒæ­¥æ›´æ–°headerè¾“å…¥æ¡†
            const headerInput = document.getElementById('headerMetronomeBpm');
            if (headerInput) headerInput.value = metronomeTempo;
            
            // å¦‚æœèŠ‚æ‹å™¨æ­£åœ¨è¿è¡Œï¼Œé‡æ–°å¯åŠ¨ä»¥åº”ç”¨æ–°é€Ÿåº¦
            if (isMetronomeRunning) {
                stopMetronome();
                startMetronome();
            }
            
            console.log(`ğŸµ èŠ‚æ‹å™¨é€Ÿåº¦è®¾ç½®ä¸º: ${metronomeTempo} BPM`);
        }

        // å¯åŠ¨èŠ‚æ‹å™¨
        function startMetronome() {
            const headerInput = document.getElementById('headerMetronomeBpm');
            const tempo = parseInt(headerInput ? headerInput.value : metronomeTempo) || 60;
            setMetronomeTempo(tempo);
            
            if (isMetronomeRunning) return;
            
            const interval = 60000 / metronomeTempo; // è®¡ç®—é—´éš”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
            
            isMetronomeRunning = true;
            
            // ç«‹å³æ’­æ”¾ç¬¬ä¸€æ‹
            playMetronomeSound();
            
            // è®¾ç½®å®šæ—¶å™¨
            metronomeInterval = setInterval(() => {
                playMetronomeSound();
            }, interval);
            
            // æ›´æ–°UI
            updateMetronomeUI();
            
            console.log(`ğŸµ èŠ‚æ‹å™¨å·²å¯åŠ¨: ${metronomeTempo} BPM`);
        }

        // åœæ­¢èŠ‚æ‹å™¨
        function stopMetronome() {
            if (metronomeInterval) {
                clearInterval(metronomeInterval);
                metronomeInterval = null;
            }
            
            isMetronomeRunning = false;
            updateMetronomeUI();
            
            console.log('ğŸµ èŠ‚æ‹å™¨å·²åœæ­¢');
        }

        // åˆ‡æ¢èŠ‚æ‹å™¨å¼€å…³
        function toggleMetronome() {
            if (isMetronomeRunning) {
                stopMetronome();
            } else {
                startMetronome();
            }
        }

        // æ›´æ–°èŠ‚æ‹å™¨UI
        function updateMetronomeUI() {
            const headerToggleBtn = document.getElementById('headerMetronomeBtn');
            
            // æ›´æ–°headerä¸­çš„æŒ‰é’®
            if (headerToggleBtn) {
                if (isMetronomeRunning) {
                    headerToggleBtn.classList.add('active');
                    headerToggleBtn.textContent = 'â¸ï¸';
                    headerToggleBtn.title = 'åœæ­¢èŠ‚æ‹å™¨';
                } else {
                    headerToggleBtn.classList.remove('active');
                    headerToggleBtn.textContent = 'ğŸµ';
                    headerToggleBtn.title = 'å¼€å§‹èŠ‚æ‹å™¨';
                }
            }
        }

        // ç›‘å¬headerä¸­BPMè¾“å…¥æ¡†çš„å˜åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            const headerSpeedInput = document.getElementById('headerMetronomeBpm');
            
            if (headerSpeedInput) {
                // å®æ—¶è¾“å…¥éªŒè¯
                headerSpeedInput.addEventListener('input', function() {
                    let value = parseInt(this.value);
                    
                    // é™åˆ¶èŒƒå›´
                    if (value < 1) {
                        this.value = 1;
                        value = 1;
                    } else if (value > 999) {
                        this.value = 999;
                        value = 999;
                    }
                    
                    if (!isNaN(value)) {
                        setMetronomeTempo(value);
                    }
                });
                
                // Enteré”®ç¡®è®¤
                headerSpeedInput.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        this.blur(); // å¤±å»ç„¦ç‚¹ï¼Œè§¦å‘éªŒè¯
                    }
                });
                
                // å¤±å»ç„¦ç‚¹æ—¶éªŒè¯
                headerSpeedInput.addEventListener('blur', function() {
                    let value = parseInt(this.value);
                    
                    if (isNaN(value) || value < 1) {
                        this.value = 1;
                        value = 1;
                    } else if (value > 999) {
                        this.value = 999;
                        value = 999;
                    }
                    
                    setMetronomeTempo(value);
                });

                // BPMæ‹–åŠ¨åŠŸèƒ½å®ç°
                let isDragging = false;
                let startY = 0;
                let startValue = 0;
                let dragTimeout = null;
                let hasStartedDrag = false;
                
                // é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶
                headerSpeedInput.addEventListener('mousedown', function(event) {
                    // åªå¤„ç†å·¦é”®ç‚¹å‡»
                    if (event.button !== 0) return;
                    
                    startY = event.clientY;
                    startValue = parseInt(this.value) || 60;
                    hasStartedDrag = false;
                    
                    console.log('BPMæ‹–åŠ¨: é¼ æ ‡æŒ‰ä¸‹', startValue);
                    
                    // é•¿æŒ‰80msåå¯åŠ¨æ‹–åŠ¨æ¨¡å¼
                    dragTimeout = setTimeout(() => {
                        isDragging = true;
                        hasStartedDrag = true;
                        
                        console.log('BPMæ‹–åŠ¨: å¯åŠ¨æ‹–åŠ¨æ¨¡å¼');
                        
                        // é˜²æ­¢æ–‡æœ¬é€‰æ‹©å’Œé»˜è®¤è¡Œä¸º
                        event.preventDefault();
                        document.body.style.userSelect = 'none';
                        document.body.style.webkitUserSelect = 'none';
                        document.body.style.mozUserSelect = 'none';
                        document.body.style.msUserSelect = 'none';
                        
                        // æ·»åŠ æ‹–åŠ¨ä¸­çš„è§†è§‰åé¦ˆ
                        this.style.cursor = 'ns-resize';
                        this.classList.add('dragging');
                        this.blur(); // å¤±å»ç„¦ç‚¹ï¼Œé¿å…é”®ç›˜è¾“å…¥å¹²æ‰°
                    }, 80);
                });
                
                // é¼ æ ‡ç§»åŠ¨äº‹ä»¶ - ç»‘å®šåˆ°å…¨å±€
                const handleMouseMove = function(event) {
                    if (!isDragging || !hasStartedDrag) return;
                    
                    const deltaY = startY - event.clientY; // å‘ä¸Šä¸ºæ­£ï¼Œå‘ä¸‹ä¸ºè´Ÿ
                    const sensitivity = 1; // æ‹–åŠ¨çµæ•åº¦ï¼Œæ¯1åƒç´ æ”¹å˜1ä¸ªBPM
                    const newValue = Math.max(1, Math.min(999, startValue + Math.round(deltaY / sensitivity)));
                    
                    console.log('BPMæ‹–åŠ¨: ç§»åŠ¨ä¸­', deltaY, newValue);
                    
                    headerSpeedInput.value = newValue;
                    setMetronomeTempo(newValue);
                    
                    // é˜»æ­¢é»˜è®¤è¡Œä¸º
                    event.preventDefault();
                    event.stopPropagation();
                };
                
                // é¼ æ ‡é‡Šæ”¾äº‹ä»¶ - ç»‘å®šåˆ°å…¨å±€
                const handleMouseUp = function(event) {
                    console.log('BPMæ‹–åŠ¨: é¼ æ ‡é‡Šæ”¾', isDragging);
                    
                    // æ¸…é™¤é•¿æŒ‰è®¡æ—¶å™¨
                    if (dragTimeout) {
                        clearTimeout(dragTimeout);
                        dragTimeout = null;
                    }
                    
                    if (isDragging && hasStartedDrag) {
                        isDragging = false;
                        hasStartedDrag = false;
                        
                        // æ¢å¤æ–‡æœ¬é€‰æ‹©
                        document.body.style.userSelect = '';
                        document.body.style.webkitUserSelect = '';
                        document.body.style.mozUserSelect = '';
                        document.body.style.msUserSelect = '';
                        
                        // ç§»é™¤è§†è§‰åé¦ˆ
                        headerSpeedInput.style.cursor = '';
                        headerSpeedInput.classList.remove('dragging');
                        
                        console.log('BPMæ‹–åŠ¨: ç»“æŸæ‹–åŠ¨æ¨¡å¼');
                    }
                };
                
                // ç»‘å®šå…¨å±€äº‹ä»¶
                document.addEventListener('mousemove', handleMouseMove, true);
                document.addEventListener('mouseup', handleMouseUp, true);
                
                // é¼ æ ‡ç¦»å¼€è¾“å…¥æ¡†æ—¶å–æ¶ˆé•¿æŒ‰
                headerSpeedInput.addEventListener('mouseleave', function(event) {
                    if (dragTimeout && !isDragging) {
                        clearTimeout(dragTimeout);
                        dragTimeout = null;
                        console.log('BPMæ‹–åŠ¨: é¼ æ ‡ç¦»å¼€ï¼Œå–æ¶ˆé•¿æŒ‰');
                    }
                });
                
                // é˜²æ­¢å³é”®èœå•å¹²æ‰°
                headerSpeedInput.addEventListener('contextmenu', function(event) {
                    if (isDragging) {
                        event.preventDefault();
                    }
                });
            }
        });
        
        // åˆå§‹åŒ–ä¸»é¢˜
        function initializeTheme() {
            switchTheme(currentTheme);
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–ä¸»é¢˜
        document.addEventListener('DOMContentLoaded', function() {
            initializeTheme();
        });
    </script>

    <!-- å¤šè¯­è¨€ç³»ç»Ÿ -->
    <script>
        // å¤šè¯­è¨€ç¿»è¯‘å¯¹è±¡
        const translations = {
            'zh-CN': {
                'app.title': 'IC Studio - è§†å¥æ—‹å¾‹ç”Ÿæˆå™¨',
                'app.subtitle': 'ä¸“ä¸šçº§ä¹è°±æ¸²æŸ“ä¸éŸ³ä¹ç†è®ºå·¥å…·',
                'controls.interval': 'éŸ³ç¨‹è·¨åº¦',
                'controls.intervalSettings': 'éŸ³ç¨‹è®¾ç½®',
                'controls.measures': 'å°èŠ‚æ•°',
                'controls.measures2': '2å°èŠ‚',
                'controls.measures4': '4å°èŠ‚',
                'controls.measures8': '8å°èŠ‚',
                'controls.key': 'è°ƒå·',
                'controls.keySettings': 'è°ƒå·è®¾ç½®',
                'controls.time': 'æ‹å·',
                'controls.timeSettings': 'æ‹å·è®¾ç½®',
                'controls.clef': 'è°±å·',
                'controls.clefSettings': 'è°±å·è®¾ç½®',
                'controls.rangeMin': 'æœ€ä½éŸ³',
                'controls.rangeMax': 'æœ€é«˜éŸ³',
                'controls.accidental': 'ä¸´æ—¶è®°å·',
                'controls.metronome': 'èŠ‚æ‹å™¨',
                'controls.generate': 'ç”Ÿæˆæ—‹å¾‹',
                'controls.previous': 'ä¸Šä¸€æ¡',
                'controls.next': 'ä¸‹ä¸€æ¡',
                'controls.rhythm': 'èŠ‚å¥è®¾ç½®',
                'controls.articulation': 'æ¼”å¥æŠ€å·§',
                'score.empty': 'ç‚¹å‡»ç”Ÿæˆæ—‹å¾‹å¼€å§‹ç»ƒä¹ ',
                'settings.title': 'è®¾ç½®',
                'settings.theme': 'ä¸»é¢˜',
                'settings.language': 'è¯­è¨€',
                'settings.lightMode': 'æµ…è‰²æ¨¡å¼',
                'settings.darkMode': 'æ·±è‰²æ¨¡å¼',
                'settings.metronome': 'èŠ‚æ‹å™¨',
                'settings.tempo': 'é€Ÿåº¦ (BPM)',
                'settings.startMetronome': 'å¼€å§‹èŠ‚æ‹å™¨',
                'settings.stopMetronome': 'åœæ­¢èŠ‚æ‹å™¨'
            },
            'zh-TW': {
                'app.title': 'IC Studio - è¦–å¥æ—‹å¾‹ç”Ÿæˆå™¨',
                'app.subtitle': 'å°ˆæ¥­ç´šæ¨‚è­œæ¸²æŸ“èˆ‡éŸ³æ¨‚ç†è«–å·¥å…·',
                'controls.interval': 'éŸ³ç¨‹è·¨åº¦',
                'controls.intervalSettings': 'éŸ³ç¨‹è¨­ç½®',
                'controls.measures': 'å°ç¯€æ•¸',
                'controls.measures2': '2å°ç¯€',
                'controls.measures4': '4å°ç¯€',
                'controls.measures8': '8å°ç¯€',
                'controls.key': 'èª¿è™Ÿ',
                'controls.keySettings': 'èª¿è™Ÿè¨­ç½®',
                'controls.time': 'æ‹è™Ÿ',
                'controls.timeSettings': 'æ‹è™Ÿè¨­ç½®',
                'controls.clef': 'è­œè™Ÿ',
                'controls.clefSettings': 'è­œè™Ÿè¨­ç½®',
                'controls.rangeMin': 'æœ€ä½éŸ³',
                'controls.rangeMax': 'æœ€é«˜éŸ³',
                'controls.accidental': 'è‡¨æ™‚è¨˜è™Ÿ',
                'controls.metronome': 'ç¯€æ‹å™¨',
                'controls.generate': 'ç”Ÿæˆæ—‹å¾‹',
                'controls.previous': 'ä¸Šä¸€æ¢',
                'controls.next': 'ä¸‹ä¸€æ¢',
                'controls.rhythm': 'ç¯€å¥è¨­ç½®',
                'controls.articulation': 'æ¼”å¥æŠ€å·§',
                'score.empty': 'é»æ“Šç”Ÿæˆæ—‹å¾‹é–‹å§‹ç·´ç¿’',
                'settings.title': 'è¨­ç½®',
                'settings.theme': 'ä¸»é¡Œ',
                'settings.language': 'èªè¨€',
                'settings.lightMode': 'æ·ºè‰²æ¨¡å¼',
                'settings.darkMode': 'æ·±è‰²æ¨¡å¼',
                'settings.metronome': 'ç¯€æ‹å™¨',
                'settings.tempo': 'é€Ÿåº¦ (BPM)',
                'settings.startMetronome': 'é–‹å§‹ç¯€æ‹å™¨',
                'settings.stopMetronome': 'åœæ­¢ç¯€æ‹å™¨'
            },
            'en': {
                'app.title': 'IC Studio - Sight-Reading Generator',
                'app.subtitle': 'Professional Music Score Rendering & Music Theory Tool',
                'controls.interval': 'Interval Range',
                'controls.intervalSettings': 'Interval Settings',
                'controls.measures': 'Measures',
                'controls.measures2': '2 Measures',
                'controls.measures4': '4 Measures',
                'controls.measures8': '8 Measures',
                'controls.key': 'Key Signature',
                'controls.keySettings': 'Key Settings',
                'controls.time': 'Time Signature',
                'controls.timeSettings': 'Time Settings',
                'controls.clef': 'Clef',
                'controls.clefSettings': 'Clef Settings',
                'controls.rangeMin': 'Lowest Note',
                'controls.rangeMax': 'Highest Note',
                'controls.accidental': 'Accidentals',
                'controls.metronome': 'Metronome',
                'controls.generate': 'Generate Melody',
                'controls.previous': 'Previous',
                'controls.next': 'Next',
                'controls.rhythm': 'Rhythm Settings',
                'controls.articulation': 'Articulations',
                'score.empty': 'Click Generate Melody to Start Practice',
                'settings.title': 'Settings',
                'settings.theme': 'Theme',
                'settings.language': 'Language',
                'settings.lightMode': 'Light Mode',
                'settings.darkMode': 'Dark Mode',
                'settings.metronome': 'Metronome',
                'settings.tempo': 'Tempo (BPM)',
                'settings.startMetronome': 'Start Metronome',
                'settings.stopMetronome': 'Stop Metronome'
            }
        };

        // è¯­è¨€åˆ‡æ¢ç›¸å…³å˜é‡
        let currentLanguage = localStorage.getItem('preferredLanguage') || 'zh-CN';
        
        // è¯­è¨€æŒ‰é’®æ˜¾ç¤ºæ–‡æœ¬
        const languageLabels = {
            'zh-CN': 'ğŸŒ ç®€ä½“ä¸­æ–‡',
            'zh-TW': 'ğŸŒ ç¹é«”ä¸­æ–‡',
            'en': 'ğŸŒ English'
        };


        // åˆ‡æ¢è¯­è¨€
        function switchLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('preferredLanguage', lang);
            
            // æ›´æ–°æŒ‰é’®æ–‡æœ¬ (å¦‚æœå­˜åœ¨æ—§çš„è¯­è¨€æŒ‰é’®)
            const languageBtn = document.getElementById('languageBtn');
            if (languageBtn) {
                languageBtn.textContent = languageLabels[lang];
            }
            
            // åº”ç”¨ç¿»è¯‘
            applyTranslations();
            
            // å…³é—­è®¾ç½®èœå•
            closeSettings();
            
            console.log(`ğŸŒ è¯­è¨€å·²åˆ‡æ¢åˆ°: ${lang}`);
        }

        // åº”ç”¨ç¿»è¯‘
        function applyTranslations() {
            const elements = document.querySelectorAll('[data-i18n]');
            const currentTranslations = translations[currentLanguage] || translations['zh-CN'];
            
            elements.forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (currentTranslations[key]) {
                    element.textContent = currentTranslations[key];
                }
            });
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–è¯­è¨€
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„è¯­è¨€åå¥½
            const savedLanguage = localStorage.getItem('preferredLanguage');
            
            if (savedLanguage) {
                // å¦‚æœæœ‰ä¿å­˜çš„è¯­è¨€åå¥½ï¼Œè®¾ç½®å½“å‰è¯­è¨€å¹¶æ˜¾ç¤ºå¯¹åº”è¯­è¨€åç§°
                currentLanguage = savedLanguage;
                document.getElementById('languageBtn').textContent = languageLabels[currentLanguage];
            } else {
                // å¦‚æœæ²¡æœ‰ä¿å­˜çš„è¯­è¨€åå¥½ï¼Œæ˜¾ç¤ºé»˜è®¤çš„ ğŸŒ æ–‡/A
                document.getElementById('languageBtn').textContent = 'ğŸŒ æ–‡/A';
            }
            
            // åº”ç”¨ç¿»è¯‘
            applyTranslations();
            
            console.log(`ğŸŒ åˆå§‹åŒ–è¯­è¨€: ${currentLanguage}`);
        });
    </script>

    <script>
        // é‡å†™æ¨¡æ€æ¡†å…³é—­å‡½æ•°ä»¥é‡ç½®å…¨é€‰çŠ¶æ€
        const originalCloseRhythmSettings = window.closeRhythmSettings;
        const originalCloseArticulationSettings = window.closeArticulationSettings;
        const originalCloseKeySettings = window.closeKeySettings;
        const originalCloseTimeSignatureSettings = window.closeTimeSignatureSettings;
        const originalCloseIntervalSettings = window.closeIntervalSettings;
        const originalCloseClefSettings = window.closeClefSettings;

        if (typeof originalCloseRhythmSettings === 'function') {
            window.closeRhythmSettings = function() {
                originalCloseRhythmSettings();
                if (typeof resetSelectAllStates === 'function') resetSelectAllStates();
            };
        }

        if (typeof originalCloseArticulationSettings === 'function') {
            window.closeArticulationSettings = function() {
                originalCloseArticulationSettings();
                if (typeof resetSelectAllStates === 'function') resetSelectAllStates();
            };
        }

        if (typeof originalCloseKeySettings === 'function') {
            window.closeKeySettings = function() {
                originalCloseKeySettings();
                if (typeof resetSelectAllStates === 'function') resetSelectAllStates();
            };
        }

        if (typeof originalCloseTimeSignatureSettings === 'function') {
            window.closeTimeSignatureSettings = function() {
                originalCloseTimeSignatureSettings();
                if (typeof resetSelectAllStates === 'function') resetSelectAllStates();
            };
        }

        if (typeof originalCloseIntervalSettings === 'function') {
            window.closeIntervalSettings = function() {
                originalCloseIntervalSettings();
                if (typeof resetSelectAllStates === 'function') resetSelectAllStates();
            };
        }

        if (typeof originalCloseClefSettings === 'function') {
            window.closeClefSettings = function() {
                originalCloseClefSettings();
                if (typeof resetSelectAllStates === 'function') resetSelectAllStates();
            };
        }

        // åŠ¨æ€éšè—åŒ…å«ç‰¹å®šæ–‡æœ¬çš„SVGå…ƒç´ 
        function hideTitleAndInstrumentElements() {
            // ç­‰å¾…ä¸€ä¼šå„¿è®©OSMDæ¸²æŸ“å®Œæˆ
            setTimeout(() => {
                const scoreDiv = document.getElementById('score');
                if (scoreDiv) {
                    // æŸ¥æ‰¾æ‰€æœ‰SVG textå…ƒç´ 
                    const textElements = scoreDiv.querySelectorAll('svg text');
                    textElements.forEach(element => {
                        const text = element.textContent || element.innerText;
                        if (text && (
                            text.includes('Piano') || 
                            text.includes('Untitled') || 
                            text.includes('Untitled Score') ||
                            text.trim() === 'Piano' ||
                            text.trim() === 'Untitled Score'
                        )) {
                            element.style.display = 'none';
                            element.style.visibility = 'hidden';
                            console.log('éšè—æ–‡æœ¬å…ƒç´ :', text);
                        }
                    });
                    
                    // ä¹Ÿæ£€æŸ¥å…¶ä»–å¯èƒ½çš„å…ƒç´ 
                    const allElements = scoreDiv.querySelectorAll('*');
                    allElements.forEach(element => {
                        const text = element.textContent || element.innerText;
                        if (text && element.tagName !== 'SCRIPT' && (
                            text.trim() === 'Piano' ||
                            text.trim() === 'Untitled Score'
                        )) {
                            element.style.display = 'none';
                            element.style.visibility = 'hidden';
                            console.log('éšè—å…ƒç´ :', element.tagName, text);
                        }
                    });
                }
            }, 500);
        }
        
        // æ¸…é™¤ç©ºè°±å­æç¤ºä¿¡æ¯
        function clearEmptyScoreMessage() {
            const scoreDiv = document.getElementById('score');
            if (scoreDiv) {
                const emptyMessage = scoreDiv.querySelector('.empty-score-message');
                if (emptyMessage) {
                    emptyMessage.remove();
                }
            }
        }

        // ç›‘å¬OSMDæ¸²æŸ“å®Œæˆ - ä¸´æ—¶ç¦ç”¨æ‰€æœ‰é‡å†™
        /*
        const originalGenerateMelody = window.generateMelody;
        if (originalGenerateMelody) {
            window.generateMelody = function(...args) {
                // æ¸…é™¤ç©ºè°±å­æç¤ºä¿¡æ¯
                clearEmptyScoreMessage();
                
                const result = originalGenerateMelody.apply(this, args);
                hideTitleAndInstrumentElements();
                return result;
            };
        }
        */
        
        // é¡µé¢åŠ è½½å®Œæˆåä¹Ÿæ‰§è¡Œä¸€æ¬¡
        document.addEventListener('DOMContentLoaded', () => {
            hideTitleAndInstrumentElements();
            // å®šæœŸæ£€æŸ¥
            setInterval(hideTitleAndInstrumentElements, 2000);
        });
    </script>


    <!-- Trial Management Script Removed - Now Using Counter System -->
    <script>
        console.log("âš¡ æ—¶é—´é™åˆ¶ç³»ç»Ÿå·²ç§»é™¤ï¼Œç°åœ¨ä½¿ç”¨è®¡æ•°å™¨ç³»ç»Ÿç®¡ç†");
        // ç§»é™¤æ‰€æœ‰è¯•ç”¨ç›¸å…³çš„localStorageæ•°æ®
        localStorage.removeItem("ic_studio_trial_data");
        localStorage.removeItem("trial-start-time");
        localStorage.removeItem("trial-used-time");
        localStorage.removeItem("trial-end-time");
        console.log("ğŸ§¹ å·²æ¸…ç†æ‰€æœ‰æ—¶é—´ç›¸å…³å­˜å‚¨æ•°æ®");
    </script>
    <!-- å…¨å±€é”™è¯¯æ‹¦æˆªå™¨ - å¿…é¡»æœ€å…ˆåŠ è½½ -->
    <script src="/js/global-error-interceptor.js?v=20250908"></script>
    
    <!-- è‡ªåŠ¨å¡«å……è®¿é—®ç è„šæœ¬ -->
    <script>
        // æ£€æŸ¥æ˜¯å¦éœ€è¦è‡ªåŠ¨å¡«å……è®¿é—®ç 
        function checkAutoFillAccessCode() {
            const accessData = localStorage.getItem('ic-premium-access');
            if (accessData) {
                try {
                    const data = JSON.parse(accessData);
                    if (data && data.autoFill && data.code) {
                        console.log('ğŸ¯ æ£€æµ‹åˆ°è‡ªåŠ¨å¡«å……æ ‡è®°ï¼Œå‡†å¤‡å¡«å…¥è®¿é—®ç :', data.code);
                        
                        // å»¶è¿Ÿæ‰§è¡Œç¡®ä¿DOMå·²åŠ è½½
                        setTimeout(() => {
                            const accessInput = document.getElementById('access-code-input');
                            const verifyResult = document.getElementById('verify-result');
                            
                            if (accessInput && verifyResult) {
                                // è‡ªåŠ¨å¡«å…¥è®¿é—®ç 
                                accessInput.value = data.code;
                                console.log('âœ… è®¿é—®ç å·²è‡ªåŠ¨å¡«å…¥:', data.code);
                                
                                // æ¸…é™¤è‡ªåŠ¨å¡«å……æ ‡è®°
                                data.autoFill = false;
                                localStorage.setItem('ic-premium-access', JSON.stringify(data));
                                
                                // è‡ªåŠ¨è§¦å‘éªŒè¯
                                verifyResult.innerHTML = '<span style="color: #3498db;">ğŸ¯ è‡ªåŠ¨éªŒè¯è®¿é—®ç ä¸­...</span>';
                                
                                setTimeout(() => {
                                    if (window.directVerifyCode) {
                                        directVerifyCode();
                                        console.log('âœ… è‡ªåŠ¨éªŒè¯è®¿é—®ç å·²è§¦å‘');
                                    } else {
                                        console.log('âš ï¸ directVerifyCodeå‡½æ•°æœªæ‰¾åˆ°ï¼Œæ‰‹åŠ¨å¤„ç†éªŒè¯');
                                        // æ‰‹åŠ¨éªŒè¯é€»è¾‘
                                        const accessData = {
                                            code: data.code,
                                            activatedAt: Date.now(),
                                            deviceId: 'auto-fill-' + Date.now(),
                                            expiresAt: null,
                                            version: '2.0-auto-fill',
                                            source: 'auto-fill'
                                        };
                                        localStorage.setItem('ic-premium-access', JSON.stringify(accessData));
                                        verifyResult.innerHTML = '<span style="color: #27ae60;">âœ… è®¿é—®ç è‡ªåŠ¨éªŒè¯æˆåŠŸï¼</span>';
                                        
                                        // éšè—æ”¯ä»˜ç›¸å…³åŒºåŸŸ
                                        const zpayContainer = document.getElementById('zpay-container');
                                        if (zpayContainer) zpayContainer.style.display = 'none';
                                        
                                        const accessCodeContainer = document.getElementById('access-code-container');
                                        if (accessCodeContainer) accessCodeContainer.style.display = 'none';
                                        
                                        setTimeout(() => {
                                            window.location.reload();
                                        }, 1500);
                                    }
                                }, 500);
                                
                            } else {
                                console.log('âš ï¸ è®¿é—®ç è¾“å…¥æ¡†æœªæ‰¾åˆ°ï¼Œå»¶è¿Ÿé‡è¯•');
                                setTimeout(checkAutoFillAccessCode, 1000);
                            }
                        }, 100);
                    }
                } catch (e) {
                    console.log('âš ï¸ è®¿é—®ç æ•°æ®è§£æå¤±è´¥:', e);
                }
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥
        document.addEventListener('DOMContentLoaded', checkAutoFillAccessCode);
        
        // é¢å¤–çš„å»¶è¿Ÿæ£€æŸ¥ï¼ˆç¡®ä¿æ‰€æœ‰è„šæœ¬åŠ è½½å®Œæ¯•ï¼‰
        setTimeout(checkAutoFillAccessCode, 1000);
    </script>
    
    <!-- 20æ¡æ—‹å¾‹ä¸¥æ ¼è®¡æ•°ç³»ç»Ÿ - å¿…é¡»æœ€å…ˆåŠ è½½ä»¥æ‹¦æˆªgenerateMelody -->
    <script src="/js/melody-counter-system.js?v=20250113-fix"></script>

    <!-- è¯•ç”¨é™åˆ¶å™¨ (å·²ç§»é™¤æ—¶é—´é™åˆ¶ï¼Œç°åœ¨ä½¿ç”¨è®¡æ•°å™¨ç³»ç»Ÿ) -->
    <script src="/js/trial-limiter.js?v=20250114"></script>

    <!-- ä»˜è´¹ç”¨æˆ·ç•Œé¢ç®¡ç†å™¨ -->
    <script src="/js/premium-ui-manager.js?v=20250908"></script>
    
    <!-- æ”¯ä»˜çŠ¶æ€ç®¡ç†å™¨ - è§£å†³éªŒè¯ä¸ä¸€è‡´å’ŒçŠ¶æ€æŒä¹…åŒ–é—®é¢˜ -->
    <script src="/js/payment-state-manager.js?v=20250909"></script>
    
    <!-- è®¿é—®ç éªŒè¯å¢å¼ºå™¨ -->
    <script src="/js/access-code-enhancer.js?v=20250909"></script>
    
    <!-- ç¡®ä¿å…¨å±€å‡½æ•°å¯ç”¨çš„å¤‡ç”¨è„šæœ¬ -->
    <script>
    // ã€å¢å¼ºã€‘ä¿æŠ¤è®¿é—®ç è¾“å…¥æ¡†ä¸è¢«æ„å¤–æ¸…ç©ºæˆ–æ›¿æ¢
    function protectAccessCodeInput() {
        const input = document.getElementById('access-code-input');
        if (input && !input.hasAttribute('data-protected')) {
            input.setAttribute('data-protected', 'true');
            
            // å¤‡ä»½å½“å‰å€¼
            let userValue = input.value;
            let isUserTyping = false;
            let protectionActive = true;
            
            // ç›‘å¬ç”¨æˆ·è¾“å…¥äº‹ä»¶
            input.addEventListener('input', function() {
                isUserTyping = true;
                userValue = this.value;
                console.log('ğŸ“ ç”¨æˆ·è¾“å…¥è®¿é—®ç :', userValue);
            });
            
            input.addEventListener('focus', function() {
                isUserTyping = true;
                console.log('ğŸ¯ ç”¨æˆ·èšç„¦è®¿é—®ç è¾“å…¥æ¡†');
            });
            
            input.addEventListener('blur', function() {
                setTimeout(() => { isUserTyping = false; }, 1000);
                console.log('ğŸ‘¤ ç”¨æˆ·ç¦»å¼€è®¿é—®ç è¾“å…¥æ¡†');
            });
            
            // ç›‘å¬DOMå˜åŒ–ï¼Œé˜²æ­¢æ•´ä¸ªè¾“å…¥æ¡†è¢«æ›¿æ¢
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList') {
                        // æ£€æŸ¥è®¿é—®ç è¾“å…¥æ¡†æ˜¯å¦è¿˜å­˜åœ¨
                        const currentInput = document.getElementById('access-code-input');
                        if (!currentInput && protectionActive) {
                            console.log('âš ï¸ è®¿é—®ç è¾“å…¥æ¡†è¢«ç§»é™¤ï¼Œå°è¯•æ¢å¤');
                            setTimeout(protectAccessCodeInput, 100);
                        } else if (currentInput && currentInput !== input && protectionActive) {
                            console.log('âš ï¸ è®¿é—®ç è¾“å…¥æ¡†è¢«æ›¿æ¢ï¼Œæ¢å¤ç”¨æˆ·æ•°æ®');
                            if (userValue) {
                                currentInput.value = userValue;
                                console.log('âœ… å·²æ¢å¤ç”¨æˆ·è¾“å…¥:', userValue);
                            }
                            setTimeout(protectAccessCodeInput, 100);
                        }
                    }
                });
            });
            
            // å¼€å§‹è§‚å¯ŸDOMå˜åŒ–
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
            
            // é‡å†™valueå±æ€§ä¿æŠ¤
            const originalDescriptor = Object.getOwnPropertyDescriptor(HTMLInputElement.prototype, 'value');
            Object.defineProperty(input, 'value', {
                get: function() {
                    return originalDescriptor.get.call(this);
                },
                set: function(newValue) {
                    // å¦‚æœç”¨æˆ·æ­£åœ¨è¾“å…¥ä¸”æ–°å€¼ä¸ºç©ºï¼Œåˆ™ä¿æŠ¤ç”¨æˆ·æ•°æ®
                    if (isUserTyping && newValue === '' && userValue !== '') {
                        console.log('ğŸ›¡ï¸ é˜»æ­¢æ¸…ç©ºç”¨æˆ·æ­£åœ¨è¾“å…¥çš„è®¿é—®ç :', userValue);
                        return;
                    }
                    // å¦‚æœä¸æ˜¯ç”¨æˆ·è¾“å…¥ä¸”æœ‰å¤‡ä»½å€¼ï¼Œè¯¢é—®æ˜¯å¦æ¢å¤
                    if (!isUserTyping && newValue === '' && userValue !== '') {
                        console.log('ğŸ”„ æ£€æµ‹åˆ°è¾“å…¥æ¡†è¢«æ¸…ç©ºï¼Œä¿æŒç”¨æˆ·æ•°æ®:', userValue);
                        originalDescriptor.set.call(this, userValue);
                        return;
                    }
                    originalDescriptor.set.call(this, newValue);
                },
                configurable: true
            });
            
            // é¡µé¢å¸è½½æ—¶æ¸…ç†
            window.addEventListener('beforeunload', function() {
                protectionActive = false;
                observer.disconnect();
            });
            
            console.log('ğŸ›¡ï¸ å¢å¼ºç‰ˆè®¿é—®ç è¾“å…¥æ¡†ä¿æŠ¤å·²å¯ç”¨');
        }
    }
    
    // è°ƒè¯•åŠŸèƒ½ï¼šç›‘æ§è®¿é—®ç è¾“å…¥æ¡†çš„æ‰€æœ‰å˜åŒ–
    function debugAccessCodeInput() {
        const input = document.getElementById('access-code-input');
        if (input && !input.hasAttribute('data-debug')) {
            input.setAttribute('data-debug', 'true');
            
            // ç›‘æ§æ‰€æœ‰å¯èƒ½çš„äº‹ä»¶
            ['input', 'change', 'keydown', 'keyup', 'focus', 'blur', 'select'].forEach(eventType => {
                input.addEventListener(eventType, function(e) {
                    console.log(`ğŸ” è®¿é—®ç è¾“å…¥æ¡†äº‹ä»¶ [${eventType}]:`, this.value, e);
                });
            });
            
            // ç›‘æ§valueå±æ€§è¢«ç›´æ¥è®¾ç½®
            const originalDescriptor = Object.getOwnPropertyDescriptor(HTMLInputElement.prototype, 'value');
            if (originalDescriptor && !input.hasAttribute('data-value-monitored')) {
                input.setAttribute('data-value-monitored', 'true');
                
                Object.defineProperty(input, 'value', {
                    get: function() {
                        const value = originalDescriptor.get.call(this);
                        console.log('ğŸ” è¯»å–è®¿é—®ç è¾“å…¥æ¡†å€¼:', value);
                        return value;
                    },
                    set: function(newValue) {
                        const oldValue = originalDescriptor.get.call(this);
                        console.log('ğŸ” è®¾ç½®è®¿é—®ç è¾“å…¥æ¡†å€¼:', oldValue, '=>', newValue);
                        console.trace('è°ƒç”¨å †æ ˆ:');
                        originalDescriptor.set.call(this, newValue);
                    },
                    configurable: true
                });
            }
            
            console.log('ğŸ” è®¿é—®ç è¾“å…¥æ¡†è°ƒè¯•ç›‘æ§å·²å¯ç”¨');
        }
    }
    
    // é¡µé¢åŠ è½½åå¯ç”¨ä¿æŠ¤å’Œè°ƒè¯•
    document.addEventListener('DOMContentLoaded', function() {
        protectAccessCodeInput();
        debugAccessCodeInput();
    });
    
    // å®šæœŸæ£€æŸ¥å¹¶ä¿æŠ¤ï¼ˆå‡å°‘é¢‘ç‡ï¼‰- ä¸´æ—¶ç¦ç”¨ï¼Œé¿å…å¹²æ‰°éªŒè¯
    // setInterval(function() {
    //     protectAccessCodeInput();
    //     debugAccessCodeInput();
    // }, 3000);
    
    // å¤‡ç”¨é‡ç½®å‡½æ•°ï¼Œç¡®ä¿æ§åˆ¶å°å¯ç”¨
    if (!window.resetToFreshUser) {
        window.resetToFreshUser = function() {
            console.log('ğŸ”„ ä½¿ç”¨å¤‡ç”¨é‡ç½®å‡½æ•°');
            
            try {
                // æ¸…ç†æ‰€æœ‰å­˜å‚¨çš„ç”¨æˆ·æ•°æ®
                localStorage.removeItem('ic-premium-access');
                localStorage.removeItem('ic-full-access');
                localStorage.removeItem('ic-verified-user');
                localStorage.removeItem('ic-sight-reading-trial');
                localStorage.removeItem('ic-device-id');
                localStorage.removeItem('ic-trial-end');
                localStorage.removeItem('ic-reset-count');
                localStorage.removeItem('ic-anticheat-exempt');
                
                // æ¸…ç†ä¼šè¯å­˜å‚¨
                sessionStorage.removeItem('ic-device-id-session');
                
                // æ¸…ç†cookie
                document.cookie = 'ic_device_backup=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                
                console.log('âœ… å·²æ¸…ç†æ‰€æœ‰ç”¨æˆ·æ•°æ®');
                
                // åˆ·æ–°é¡µé¢é‡æ–°å¼€å§‹
                window.location.reload();
                
            } catch (error) {
                console.error('âŒ é‡ç½®è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯:', error);
                alert('âš ï¸ é‡ç½®è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œå»ºè®®æ‰‹åŠ¨åˆ·æ–°é¡µé¢');
            }
        };
    }
    
    // ç¡®ä¿å…¶ä»–å¸¸ç”¨å‡½æ•°ä¹Ÿå¯ç”¨
    if (!window.debugAccessSystem) {
        window.debugAccessSystem = function() {
            console.log('ğŸ” è®¿é—®ç³»ç»Ÿè°ƒè¯•ä¿¡æ¯:');
            console.log('ğŸ’¾ LocalStorageæ•°æ®:');
            console.log('  - ic-premium-access:', localStorage.getItem('ic-premium-access'));
            console.log('  - ic-sight-reading-trial:', localStorage.getItem('ic-sight-reading-trial'));
            console.log('  - ic-device-id:', localStorage.getItem('ic-device-id'));
            
            console.log('ğŸ”§ ç³»ç»ŸçŠ¶æ€:');
            console.log('  - cloudbaseAPI:', !!window.cloudbaseAPI);
            console.log('  - trialLimiter:', !!window.trialLimiter);
            console.log('  - premiumUIManager:', !!window.premiumUIManager);
            
            return {
                localStorage: {
                    premiumAccess: localStorage.getItem('ic-premium-access'),
                    trial: localStorage.getItem('ic-sight-reading-trial'),
                    deviceId: localStorage.getItem('ic-device-id')
                },
                functions: {
                    resetToFreshUser: typeof window.resetToFreshUser,
                    trialLimiter: !!window.trialLimiter,
                    uiManager: !!window.premiumUIManager,
                    cloudbaseAPI: !!window.cloudbaseAPI
                }
            };
        };
    }
    
    // ã€æ–°å¢ã€‘ç®€åŒ–çš„è®¿é—®ç æµ‹è¯•å‡½æ•°
    if (!window.testAccessCodeDirect) {
        window.testAccessCodeDirect = async function(code) {
            if (!code) {
                console.error('âŒ è¯·æä¾›è®¿é—®ç ï¼Œä¾‹å¦‚: testAccessCodeDirect("ABC123456789")');
                return;
            }
            
            console.log('ğŸ§ª ç›´æ¥æµ‹è¯•è®¿é—®ç éªŒè¯:', code);
            
            try {
                if (!window.cloudbaseAPI) {
                    console.error('âŒ CloudBase APIæœªåˆå§‹åŒ–');
                    return { error: 'CloudBase APIæœªåˆå§‹åŒ–' };
                }
                
                console.log('ğŸ”„ å¼€å§‹éªŒè¯...');
                const result = await window.cloudbaseAPI.verifyAccessCode(code);
                
                console.log('ğŸ“¥ éªŒè¯ç»“æœ:', result);
                
                if (result && result.valid) {
                    console.log('âœ… éªŒè¯æˆåŠŸï¼ä¿å­˜åˆ°localStorage...');
                    
                    const accessData = {
                        code: result.data.code,
                        activatedAt: Date.now(),
                        deviceId: window.trialLimiter?.deviceId || 'test',
                        expiresAt: result.data.expiresAt,
                        version: '3.0-test',
                        purchaseDate: result.data.purchaseDate,
                        features: result.data.features || ['sight-reading-tool']
                    };
                    
                    localStorage.setItem('ic-premium-access', JSON.stringify(accessData));
                    console.log('âœ… å·²ä¿å­˜è®¿é—®ç ï¼Œ2ç§’ååˆ·æ–°é¡µé¢...');
                    
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                    
                    return { success: true, data: accessData };
                } else {
                    console.log('âŒ éªŒè¯å¤±è´¥:', result?.error || 'æœªçŸ¥é”™è¯¯');
                    return { success: false, error: result?.error || 'éªŒè¯å¤±è´¥' };
                }
                
            } catch (error) {
                console.error('âŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
                return { success: false, error: error.message };
            }
        };
    }
    
    // ã€ä¸´æ—¶è°ƒè¯•ã€‘æ£€æŸ¥è®¿é—®ç éªŒè¯å‡½æ•°çŠ¶æ€
    window.debugVerificationSystem = function() {
        console.log('ğŸ” è®¿é—®ç éªŒè¯ç³»ç»Ÿè°ƒè¯•:');
        
        if (window.cloudbaseAPI) {
            console.log('âœ… CloudBase APIå·²åŠ è½½');
            console.log('APIç‰ˆæœ¬:', window.cloudbaseAPI.version);
            console.log('APIæ¨¡å¼:', window.cloudbaseAPI.getCurrentMode ? window.cloudbaseAPI.getCurrentMode() : 'æœªçŸ¥');
            
            // æµ‹è¯•ä¸€ä¸ª12ä½éšæœºè®¿é—®ç 
            const testCode = 'AB8X3KL9MN12';
            console.log('ğŸ§ª æµ‹è¯•éšæœºè®¿é—®ç æ ¼å¼éªŒè¯:', testCode);
            
            // æ£€æŸ¥åº”æ€¥éªŒè¯é€»è¾‘
            try {
                const isValidFormat = /^[A-Z0-9]{11,12}$/.test(testCode);
                console.log('æ ¼å¼éªŒè¯ç»“æœ:', isValidFormat);
                
                if (window.cloudbaseAPI.verifyAccessCode) {
                    console.log('å¼€å§‹APIéªŒè¯æµ‹è¯•...');
                    window.cloudbaseAPI.verifyAccessCode(testCode).then(result => {
                        console.log('APIéªŒè¯ç»“æœ:', result);
                    }).catch(error => {
                        console.log('APIéªŒè¯é”™è¯¯:', error);
                    });
                }
            } catch (error) {
                console.error('è°ƒè¯•è¿‡ç¨‹å‡ºé”™:', error);
            }
        } else {
            console.error('âŒ CloudBase APIæœªåŠ è½½');
        }
    };
    </script>
    
    <!-- é›†æˆç»Ÿä¸€æ”¯ä»˜ç³»ç»Ÿ -->
    <script src="/js/cloudbase-api.js?v=20250908"></script>
    <script src="/js/payment-success-handler.js?v=20250910"></script>
    <script src="/js/zpay-simple.js?v=1.0.0"></script>
    
    <!-- æµ‹è¯•æ”¯ä»˜æ³¨å…¥å™¨ï¼ˆä»…åœ¨å¼€å‘ç¯å¢ƒï¼‰ -->
    <script src="/js/test-payment-injector.js?v=20250908"></script>
    
    <!-- ä½¿ç”¨æ¡æ¬¾å¼¹çª— -->
    <div id="terms-dialog" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 30px; border-radius: 16px; max-width: 600px; max-height: 80vh; overflow-y: auto; margin: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.3);">
            <h3 style="color: #2d3748; margin-bottom: 20px; text-align: center;">ğŸ“œ ä½¿ç”¨æ¡æ¬¾</h3>
            <div style="line-height: 1.6; color: #4a5568; font-size: 14px;">
                <h4>1. æœåŠ¡è¯´æ˜</h4>
                <p>IC Studio è§†å¥å·¥å…·ä¸ºç”¨æˆ·æä¾›ä¸“ä¸šçº§è§†å¥æ—‹å¾‹ç”ŸæˆæœåŠ¡ã€‚</p>
                
                <h4>2. è´­ä¹°åŠä½¿ç”¨</h4>
                <p>ä¸€æ¬¡æ€§è´­ä¹°ï¼Œæ°¸ä¹…ä½¿ç”¨ã€‚æ”¯ä»˜æˆåŠŸåç«‹å³è·å¾—è®¿é—®ç ã€‚</p>
                
                <h4>3. é€€æ¬¾æ”¿ç­–</h4>
                <p>æ”¯æŒ<strong>7å¤©æ— ç†ç”±é€€æ¬¾</strong>ï¼Œè¶…è¿‡æœŸé™ä¸æ”¯æŒé€€æ¬¾ã€‚</p>
                
                <h4>4. éšç§ä¿æŠ¤</h4>
                <p>æˆ‘ä»¬ä¸¥æ ¼ä¿æŠ¤æ‚¨çš„ä¸ªäººä¿¡æ¯ï¼Œä¸ä¼šæ³„éœ²ç»™ç¬¬ä¸‰æ–¹ã€‚</p>
                
                <h4>5. è”ç³»æ–¹å¼</h4>
                <p>å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‘é‚®ä»¶è‡³ service@icstudio.club</p>
            </div>
            <div style="text-align: center; margin-top: 25px;">
                <button onclick="closeTermsDialog()" style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                    å…³é—­
                </button>
            </div>
        </div>
    </div>
    
    <!-- éšç§æ”¿ç­–å¼¹çª— -->
    <div id="privacy-dialog" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 30px; border-radius: 16px; max-width: 600px; max-height: 80vh; overflow-y: auto; margin: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.3);">
            <h3 style="color: #2d3748; margin-bottom: 20px; text-align: center;">ğŸ”’ éšç§æ”¿ç­–</h3>
            <div style="line-height: 1.6; color: #4a5568; font-size: 14px;">
                <h4>1. ä¿¡æ¯æ”¶é›†</h4>
                <p>æˆ‘ä»¬åªæ”¶é›†å¿…è¦çš„äº¤æ˜“ä¿¡æ¯ï¼Œä¸ä¼šæ”¶é›†ä¸æœåŠ¡æ— å…³çš„ä¸ªäººä¿¡æ¯ã€‚</p>
                
                <h4>2. ä¿¡æ¯ä½¿ç”¨</h4>
                <p>æ‚¨çš„ä¿¡æ¯ä»…ç”¨äºæä¾›æœåŠ¡å’Œå®¢æˆ·æ”¯æŒã€‚</p>
                
                <h4>3. ä¿¡æ¯ä¿æŠ¤</h4>
                <p>æˆ‘ä»¬é‡‡ç”¨ä¸šç•Œæ ‡å‡†çš„å®‰å…¨æªæ–½ä¿æŠ¤æ‚¨çš„ä¿¡æ¯ã€‚</p>
                
                <h4>4. ä¿¡æ¯å…±äº«</h4>
                <p>é™¤æ³•å¾‹è¦æ±‚å¤–ï¼Œæˆ‘ä»¬ä¸ä¼šä¸ç¬¬ä¸‰æ–¹å…±äº«æ‚¨çš„ä¿¡æ¯ã€‚</p>
            </div>
            <div style="text-align: center; margin-top: 25px;">
                <button onclick="closePrivacyDialog()" style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                    å…³é—­
                </button>
            </div>
        </div>
    </div>

    <script>
        // è®¿é—®ç è¾“å…¥éªŒè¯æŒ‰é’®çŠ¶æ€æ›´æ–°
        function updateVerifyButton() {
            const input = document.getElementById('access-code-input');
            const button = document.getElementById('verify-btn');
            
            if (input && button) {
                const code = input.value.trim();
                const isValid = code.length === 12 && /^[A-Z0-9]{12}$/.test(code);
                
                button.disabled = !isValid;
                button.style.opacity = isValid ? '1' : '0.5';
                button.style.cursor = isValid ? 'pointer' : 'not-allowed';
            }
        }

        // å¤„ç†è¾“å…¥å˜åŒ–
        function handleInputChange() {
            const input = document.getElementById('access-code-input');
            const button = document.getElementById('verify-btn');
            
            if (input && button) {
                const code = input.value.trim();
                const isValid = code.length >= 11 && code.length <= 12 && /^[A-Z0-9]+$/.test(code);
                
                button.dataset.valid = isValid;
                button.style.opacity = '1'; // å§‹ç»ˆä¿æŒå®Œå…¨ä¸é€æ˜
                button.style.cursor = isValid ? 'pointer' : 'not-allowed';
                button.style.background = '#667eea';
                
                console.log('ğŸ”„ è¾“å…¥å˜åŒ–å¤„ç†:', { code, isValid });
            }
        }

        // å¤„ç†éªŒè¯æŒ‰é’®ç‚¹å‡»
        function handleVerifyClick() {
            console.log('ğŸ¯ éªŒè¯æŒ‰é’®è¢«ç‚¹å‡»');
            const button = document.getElementById('verify-btn');
            
            if (!button) {
                console.error('âŒ æ‰¾ä¸åˆ°éªŒè¯æŒ‰é’®');
                return;
            }
            
            const isValid = button.dataset.valid === 'true';
            console.log('ğŸ” æŒ‰é’®çŠ¶æ€æ£€æŸ¥:', { isValid });
            
            if (!isValid) {
                console.log('âš ï¸ æŒ‰é’®å¤„äºç¦ç”¨çŠ¶æ€ï¼Œä¸æ‰§è¡ŒéªŒè¯');
                const resultDiv = document.getElementById('verify-result');
                if (resultDiv) {
                    resultDiv.innerHTML = '<span style="color: #e74c3c;">âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„11-12ä½è®¿é—®ç </span>';
                }
                return;
            }
            
            // æ‰§è¡ŒéªŒè¯
            console.log('âœ… å¼€å§‹æ‰§è¡Œè®¿é—®ç éªŒè¯');
            verifyAccessCodeWithServer();
        }

        // ä½¿ç”¨æœåŠ¡å™¨ç«¯éªŒè¯è®¿é—®ç 
        async function verifyAccessCodeWithServer() {
            const input = document.getElementById('access-code-input');
            const resultDiv = document.getElementById('verify-result');
            const button = document.getElementById('verify-btn');
            
            if (!input || !resultDiv) {
                console.error('âŒ æ‰¾ä¸åˆ°å¿…è¦çš„é¡µé¢å…ƒç´ ');
                return;
            }
            
            const code = input.value.trim().toUpperCase();
            if (!code) {
                resultDiv.innerHTML = '<span style="color: #e74c3c;">âŒ è¯·è¾“å…¥è®¿é—®ç </span>';
                return;
            }
            
            if (code.length !== 12 && code.length !== 11) {
                resultDiv.innerHTML = '<span style="color: #e74c3c;">âŒ è®¿é—®ç å¿…é¡»æ˜¯11-12ä½</span>';
                return;
            }
            
            if (!/^[A-Z0-9]+$/.test(code)) {
                resultDiv.innerHTML = '<span style="color: #e74c3c;">âŒ è®¿é—®ç åªèƒ½åŒ…å«å­—æ¯å’Œæ•°å­—</span>';
                return;
            }

            // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
            button.disabled = true;
            button.style.opacity = '0.5';
            resultDiv.innerHTML = '<span style="color: #3498db;">ğŸ”„ æ­£åœ¨éªŒè¯è®¿é—®ç ...</span>';

            try {
                // ç­‰å¾… PaymentStateManager åŠ è½½
                if (!window.paymentManager) {
                    resultDiv.innerHTML = '<span style="color: #f39c12;">â³ æ­£åœ¨åŠ è½½éªŒè¯ç³»ç»Ÿ...</span>';
                    
                    // ç­‰å¾…æœ€å¤š5ç§’è®©PaymentStateManageråŠ è½½
                    let attempts = 0;
                    while (!window.paymentManager && attempts < 50) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        attempts++;
                    }
                    
                    if (!window.paymentManager) {
                        throw new Error('éªŒè¯ç³»ç»ŸåŠ è½½è¶…æ—¶ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                    }
                }
                
                console.log('ğŸ” ä½¿ç”¨ PaymentStateManager éªŒè¯è®¿é—®ç :', code);
                resultDiv.innerHTML = '<span style="color: #3498db;">ğŸ”„ æ­£åœ¨æœåŠ¡å™¨éªŒè¯...</span>';
                
                const result = await window.paymentManager.verifyAccessCode(code, true);
                
                if (result.success) {
                    console.log('âœ… è®¿é—®ç éªŒè¯æˆåŠŸ:', result.data);
                    resultDiv.innerHTML = '<span style="color: #27ae60;">âœ… è®¿é—®ç éªŒè¯æˆåŠŸï¼</span>';
                    
                    // é‡æ–°å¯ç”¨æŒ‰é’®
                    button.disabled = false;
                    button.style.opacity = '1';
                    
                    // å»¶è¿Ÿæ˜¾ç¤ºå¼¹çª—ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æˆåŠŸæ¶ˆæ¯
                    setTimeout(() => {
                        showPaymentSuccessPopup(code, result.data);
                    }, 800);
                    
                } else {
                    console.log('âŒ è®¿é—®ç éªŒè¯å¤±è´¥:', result.error);
                    resultDiv.innerHTML = `<span style="color: #e74c3c;">âŒ ${result.error}</span>`;
                    button.disabled = false;
                    button.style.opacity = '1';
                }
            } catch (error) {
                console.error('éªŒè¯è®¿é—®ç å¤±è´¥:', error);
                resultDiv.innerHTML = `<span style="color: #e74c3c;">âŒ ${error.message || 'éªŒè¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•'}</span>`;
                button.disabled = false;
                button.style.opacity = '1';
            }
        }

        // ===== æ”¯ä»˜æˆåŠŸå¼¹çª—ç›¸å…³å‡½æ•° =====
        function showPaymentSuccessPopup(accessCode, orderData) {
            // åˆ›å»ºå¼¹çª—HTML
            const popup = document.createElement('div');
            popup.id = 'success-popup';
            popup.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;">
                    <div style="background: white; padding: 40px; border-radius: 16px; max-width: 500px; width: 90%; text-align: center; box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);">
                        <div style="margin-bottom: 30px;">
                            <div style="width: 80px; height: 80px; background: #4CAF50; border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 48px;">âœ“</div>
                            <h2 style="color: #333; margin-bottom: 10px;">ğŸ‰ è®¿é—®éªŒè¯æˆåŠŸï¼</h2>
                            <p style="color: #666; font-size: 16px; margin-bottom: 0;">æ‚¨çš„è®¿é—®ç å·²éªŒè¯ï¼Œç°åœ¨å¯ä»¥ä½¿ç”¨å®Œæ•´ç‰ˆåŠŸèƒ½</p>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 30px; text-align: left;">
                            <h3 style="color: #333; margin-bottom: 15px; text-align: center;">ğŸ“‹ éªŒè¯ä¿¡æ¯</h3>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center;">
                                <span style="color: #666;">è®¿é—®ç ï¼š</span>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-family: monospace; font-weight: bold; background: #f1f5f9; padding: 4px 8px; border-radius: 4px; border: 1px solid #e2e8f0;">${accessCode}</span>
                                    <button onclick="copyAccessCode('${accessCode}')" 
                                            style="background: #3b82f6; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s ease;"
                                            onmouseover="this.style.background='#2563eb'"
                                            onmouseout="this.style.background='#3b82f6'"
                                            title="å¤åˆ¶è®¿é—®ç ">
                                        ğŸ“‹
                                    </button>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span style="color: #666;">äº§å“ï¼š</span>
                                <span>${orderData.product_name || 'IC Studio è§†å¥å·¥å…·'}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #666;">éªŒè¯æ—¶é—´ï¼š</span>
                                <span>${new Date().toLocaleString()}</span>
                            </div>
                        </div>

                        <div style="margin-bottom: 30px;">
                            <h3 style="color: #333; margin-bottom: 20px;">ğŸ“¦ ä¸‹è½½èµ„æº</h3>
                            <div style="display: grid; gap: 10px;">
                                <a href="javascript:void(0)" onclick="downloadFile('/software-packages/IC Studio è§†å¥å·¥å…·-1.0.0-mac-x64.dmg', 'IC Studio è§†å¥å·¥å…·-1.0.0-mac-x64.dmg')"
                                   style="display: block; background: #f0f9ff; color: #1e40af; padding: 12px 20px; border: 2px solid #93c5fd; border-radius: 8px; text-decoration: none; font-weight: 600; transition: all 0.3s ease; cursor: pointer;"
                                   onmouseover="this.style.background='#1e40af'; this.style.color='white';" 
                                   onmouseout="this.style.background='#f0f9ff'; this.style.color='#1e40af';">
                                    ğŸ Macç‰ˆæœ¬ (DMG)
                                </a>
                                <a href="javascript:void(0)" onclick="downloadFile('/software-packages/IC Studio è§†å¥å·¥å…·-1.0.0-win-x64.exe', 'IC Studio è§†å¥å·¥å…·-1.0.0-win-x64.exe')"
                                   style="display: block; background: #f0fdf4; color: #166534; padding: 12px 20px; border: 2px solid #86efac; border-radius: 8px; text-decoration: none; font-weight: 600; transition: all 0.3s ease; cursor: pointer;"
                                   onmouseover="this.style.background='#166534'; this.style.color='white';" 
                                   onmouseout="this.style.background='#f0fdf4'; this.style.color='#166534';">
                                    ğŸ’» Windowsç‰ˆæœ¬ (EXE)
                                </a>
                                <a href="javascript:void(0)" onclick="downloadFile('/software-packages/IC Studio è§†å¥å·¥å…·-1.0.0-linux-x86_64.AppImage', 'IC Studio è§†å¥å·¥å…·-1.0.0-linux-x86_64.AppImage')"
                                   style="display: block; background: #fef3c7; color: #92400e; padding: 12px 20px; border: 2px solid #fbbf24; border-radius: 8px; text-decoration: none; font-weight: 600; transition: all 0.3s ease; cursor: pointer;"
                                   onmouseover="this.style.background='#92400e'; this.style.color='white';" 
                                   onmouseout="this.style.background='#fef3c7'; this.style.color='#92400e';">
                                    ğŸ§ Linuxç‰ˆæœ¬ (AppImage)
                                </a>
                            </div>
                            <p style="font-size: 12px; color: #888; margin-top: 15px;">ä¸‹è½½å®Œæˆåï¼Œä½¿ç”¨ä»¥ä¸Šè®¿é—®ç æ¿€æ´»å®Œæ•´ç‰ˆåŠŸèƒ½</p>
                        </div>

                        <div style="display: flex; gap: 15px; justify-content: center;">
                            <button onclick="closeSuccessPopup()" 
                                    style="padding: 15px 30px; background: #f8f9fa; color: #333; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;"
                                    onmouseover="this.style.background='#e2e8f0'" 
                                    onmouseout="this.style.background='#f8f9fa'">
                                å…³é—­å¼¹çª—
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(popup);
        }

        // å…³é—­æˆåŠŸå¼¹çª—
        function closeSuccessPopup() {
            const popup = document.getElementById('success-popup');
            if (popup) {
                popup.remove();
            }

            // Command+R é£æ ¼çš„é¡µé¢åˆ·æ–°
            // æ·»åŠ è½»å¾®çš„è§†è§‰åé¦ˆï¼Œç„¶åæ‰§è¡Œåˆ·æ–°
            document.body.style.opacity = '0.95';
            document.body.style.transition = 'opacity 0.1s ease';

            setTimeout(() => {
                // å¼ºåˆ¶åˆ·æ–°é¡µé¢ï¼Œç±»ä¼¼ Command+R çš„æ•ˆæœ
                window.location.reload(true);
            }, 100);
        }

        // å¤åˆ¶è®¿é—®ç åŠŸèƒ½
        function copyAccessCode(accessCode) {
            console.log('ğŸ“‹ å¤åˆ¶è®¿é—®ç :', accessCode);
            
            // ä½¿ç”¨ç°ä»£çš„Clipboard API
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(accessCode).then(() => {
                    showCopyNotification('è®¿é—®ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                }).catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    fallbackCopyTextToClipboard(accessCode);
                });
            } else {
                // é™çº§æ–¹æ¡ˆ
                fallbackCopyTextToClipboard(accessCode);
            }
        }

        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.top = '0';
            textArea.style.left = '0';
            textArea.style.position = 'fixed';
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopyNotification('è®¿é—®ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                } else {
                    showCopyNotification('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
                }
            } catch (err) {
                console.error('é™çº§å¤åˆ¶å¤±è´¥:', err);
                showCopyNotification('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            }
            
            document.body.removeChild(textArea);
        }

        function showCopyNotification(message, type = 'success') {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? '#22c55e' : '#ef4444';
            
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${bgColor};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                z-index: 10000;
                font-size: 14px;
                font-weight: 600;
            `;
            
            if (type === 'success') {
                notification.innerHTML = `ğŸ”½ ${message}`;
            } else {
                notification.innerHTML = `âŒ ${message}`;
            }
            
            document.body.appendChild(notification);
            
            // 3ç§’åç§»é™¤é€šçŸ¥
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.opacity = '0';
                    notification.style.transition = 'opacity 0.3s ease';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            document.body.removeChild(notification);
                        }
                    }, 300);
                }
            }, 3000);
        }

        // ä¸‹è½½æ–‡ä»¶åŠŸèƒ½
        function downloadFile(url, filename) {
            console.log('ğŸ”½ å¼€å§‹ä¸‹è½½æ–‡ä»¶:', filename);
            console.log('ğŸ”— åŸå§‹URL:', url);
            
            // æ„å»ºå®Œæ•´URL
            const fullUrl = new URL(url, window.location.origin).href;
            console.log('ğŸ“ å®Œæ•´URL:', fullUrl);
            
            // åˆ›å»ºä¸´æ—¶ä¸‹è½½é“¾æ¥å…ƒç´ 
            const downloadLink = document.createElement('a');
            downloadLink.href = fullUrl;
            downloadLink.download = filename;
            downloadLink.style.display = 'none';
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(downloadLink);
            
            try {
                // è§¦å‘ä¸‹è½½
                downloadLink.click();
                console.log('âœ… ä¸‹è½½å·²å¯åŠ¨:', filename);
                showDownloadNotification(filename);
            } catch (error) {
                console.error('âŒ ä¸‹è½½å¤±è´¥:', error);
                // é™çº§åˆ°ç›´æ¥æ‰“å¼€
                window.open(fullUrl, '_blank');
                showDownloadNotification(filename);
            }
            
            // æ¸…ç†ä¸´æ—¶å…ƒç´ 
            setTimeout(() => {
                if (downloadLink.parentNode) {
                    document.body.removeChild(downloadLink);
                }
            }, 100);
        }

        function showDownloadNotification(message, type = 'success') {
            // åˆ›å»ºä¸´æ—¶é€šçŸ¥
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? '#22c55e' : '#ef4444';
            
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 20px;
                background: ${bgColor};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                z-index: 10000;
                font-size: 14px;
                font-weight: 600;
            `;
            
            if (type === 'success') {
                notification.innerHTML = `ğŸ”½ æ­£åœ¨ä¸‹è½½ ${message}...`;
            } else {
                notification.innerHTML = `âŒ ${message}`;
            }
            
            document.body.appendChild(notification);
            
            // 3ç§’åç§»é™¤é€šçŸ¥
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.opacity = '0';
                    notification.style.transition = 'opacity 0.3s ease';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            document.body.removeChild(notification);
                        }
                    }, 300);
                }
            }, 3000);
        }

        // ä½¿ç”¨æ¡æ¬¾å’Œéšç§æ”¿ç­–ç›¸å…³å‡½æ•°
        function togglePaymentButton() {
            const checkbox = document.getElementById('terms-checkbox');
            const buttonContainer = document.getElementById('payment-button-container');
            
            if (checkbox && buttonContainer) {
                buttonContainer.style.display = checkbox.checked ? 'block' : 'none';
            }
        }

        function showTermsDialog() {
            const dialog = document.getElementById('terms-dialog');
            if (dialog) {
                dialog.style.display = 'flex';
            }
        }

        function closeTermsDialog() {
            const dialog = document.getElementById('terms-dialog');
            if (dialog) {
                dialog.style.display = 'none';
            }
        }

        function showPrivacyDialog() {
            const dialog = document.getElementById('privacy-dialog');
            if (dialog) {
                dialog.style.display = 'flex';
            }
        }

        function closePrivacyDialog() {
            const dialog = document.getElementById('privacy-dialog');
            if (dialog) {
                dialog.style.display = 'none';
            }
        }

        // ç‚¹å‡»å¯¹è¯æ¡†å¤–éƒ¨å…³é—­
        document.addEventListener('click', function(event) {
            const termsDialog = document.getElementById('terms-dialog');
            const privacyDialog = document.getElementById('privacy-dialog');
            
            if (event.target === termsDialog) {
                closeTermsDialog();
            }
            if (event.target === privacyDialog) {
                closePrivacyDialog();
            }
        });

        // ğŸ§ª æµ‹è¯•å‡½æ•°ï¼šç«‹å³æ˜¾ç¤ºæ”¯ä»˜ç•Œé¢ï¼ˆç”¨äºæµ‹è¯•ä½¿ç”¨æ¡æ¬¾åŠŸèƒ½ï¼‰
        window.showPaymentInterface = function() {
            console.log('ğŸ§ª æµ‹è¯•ï¼šæ˜¾ç¤ºæ”¯ä»˜ç•Œé¢');
            
            // æ˜¾ç¤ºæ”¯ä»˜å®¹å™¨
            const zpayContainer = document.getElementById('zpay-container');
            if (zpayContainer) {
                zpayContainer.style.display = 'block';
            }
            
            // æ˜¾ç¤ºæ”¯ä»˜åŒºåŸŸ
            const paymentSection = document.getElementById('payment-section');
            if (paymentSection) {
                paymentSection.style.display = 'block';
            }
            
            console.log('âœ… æ”¯ä»˜ç•Œé¢å·²æ˜¾ç¤ºï¼Œç°åœ¨æ‚¨å¯ä»¥æµ‹è¯•ä½¿ç”¨æ¡æ¬¾ç¡®è®¤åŠŸèƒ½äº†ï¼');
            console.log('ğŸ’¡ å‹¾é€‰"æˆ‘å·²é˜…è¯»å¹¶åŒæ„"å¤é€‰æ¡†åï¼Œæ”¯ä»˜æŒ‰é’®å°†ä¼šæ˜¾ç¤º');
        };

        // æ–°å¢ï¼šè·³è¿‡è¯•ç”¨é˜¶æ®µä½†æ˜¾ç¤ºè´­ä¹°é¡µé¢çš„å‡½æ•°
        // å°†å‡½æ•°æå‡åˆ°å…¨å±€ä½œç”¨åŸŸç¡®ä¿æ§åˆ¶å°å¯è®¿é—®
        window.showPurchaseMode = function showPurchaseMode() {
            console.log('ğŸ›’ è¿›å…¥è´­ä¹°æ¨¡å¼ï¼ˆè·³è¿‡è¯•ç”¨ï¼‰');
            
            try {
                // 1. åœæ­¢è¯•ç”¨è®¡æ—¶å™¨
                if (window.trialLimiter) {
                    // è®¾ç½®è¯•ç”¨ä¸ºè¿‡æœŸçŠ¶æ€ï¼Œä½†ä¸å®Œå…¨é˜»æ­¢åŠŸèƒ½
                    window.trialLimiter.isTrialActive = false;
                }
                
                // 2. éšè—è¯•ç”¨è®¡æ—¶å™¨
                const trialTimer = document.getElementById('trialTimer');
                if (trialTimer) {
                    trialTimer.style.display = 'none';
                }
                
                // 3. æ˜¾ç¤ºè¯•ç”¨ç»“æŸçŠ¶æ€
                const trialStatus = document.getElementById('trial-status');
                if (trialStatus) {
                    trialStatus.innerHTML = `
                        <div style="background: #fff8e1; padding: 20px; border-radius: 12px; border: 2px solid #ffb74d; text-align: center;">
                            <h3 style="color: #ef6c00; margin-bottom: 15px;">ğŸ›’ è´­ä¹°å®Œæ•´ç‰ˆè§£é”æ‰€æœ‰åŠŸèƒ½</h3>
                            <p style="color: #ef6c00; margin-bottom: 0;">ç°åœ¨å¯ä»¥è´­ä¹°å®Œæ•´ç‰ˆæˆ–è¾“å…¥è®¿é—®ç ç«‹å³è§£é”</p>
                        </div>
                    `;
                    trialStatus.style.display = 'block';
                }
                
                // 4. æ˜¾ç¤ºè®¿é—®ç è¾“å…¥åŒºåŸŸ
                const accessCodeContainer = document.getElementById('access-code-container');
                if (accessCodeContainer) {
                    accessCodeContainer.style.display = 'block';
                }
                
                // 5. æ˜¾ç¤ºæ”¯ä»˜åŒºåŸŸ
                const zpayContainer = document.getElementById('zpay-container');
                if (zpayContainer) {
                    zpayContainer.style.display = 'block';
                    zpayContainer.scrollIntoView({ behavior: 'smooth' });
                }
                
                // 6. ç¦ç”¨ç”ŸæˆæŒ‰é’®ï¼Œæ˜¾ç¤ºéœ€è¦è´­ä¹°
                const generateBtn = document.getElementById('generateBtn') || 
                                   document.querySelector('button[onclick*="generateMelody"]') ||
                                   document.querySelector('button.btn-primary');
                if (generateBtn) {
                    generateBtn.disabled = true;
                    generateBtn.style.opacity = '0.6';
                    generateBtn.textContent = 'è¯·è´­ä¹°å®Œæ•´ç‰ˆæˆ–è¾“å…¥è®¿é—®ç ';
                    generateBtn.style.cursor = 'not-allowed';
                }
                
                alert('ğŸ›’ å·²è¿›å…¥è´­ä¹°æ¨¡å¼ï¼\n\næ‚¨å¯ä»¥ï¼š\nâ€¢ è´­ä¹°å®Œæ•´ç‰ˆè·å¾—æ°¸ä¹…è®¿é—®æƒ\nâ€¢ è¾“å…¥è®¿é—®ç ç«‹å³è§£é”åŠŸèƒ½');
                
                console.log('âœ… è´­ä¹°æ¨¡å¼å·²æ¿€æ´»');
                
            } catch (error) {
                console.error('âŒ è¿›å…¥è´­ä¹°æ¨¡å¼å¤±è´¥:', error);
                alert('âš ï¸ åˆ‡æ¢åˆ°è´­ä¹°æ¨¡å¼æ—¶å‡ºç°é”™è¯¯');
            }
        }

        console.log('ğŸ‰ è®¿é—®ç åŠŸèƒ½å·²åŠ è½½');
        console.log('ğŸ’¡ å¯ç”¨çš„å‘½ä»¤:');
        console.log('  - showPurchaseMode() - è·³è¿‡è¯•ç”¨ï¼Œæ˜¾ç¤ºè´­ä¹°é¡µé¢');
        console.log('  - updateVerifyButton() - æ›´æ–°éªŒè¯æŒ‰é’®çŠ¶æ€');
        console.log('  - verifyAccessCodeWithServer() - éªŒè¯è®¿é—®ç ');
    </script>

    <!-- ç¡®ä¿20æ¡æ—‹å¾‹è®¡æ•°ç³»ç»Ÿæ­£ç¡®åˆå§‹åŒ– -->
    <script>
    // ç­‰å¾…æ‰€æœ‰è„šæœ¬åŠ è½½å®Œæˆååˆå§‹åŒ–è®¡æ•°ç³»ç»Ÿ
    window.addEventListener('load', function() {
        setTimeout(function() {
            console.log('ğŸ¯ å¼ºåˆ¶åˆå§‹åŒ–20æ¡æ—‹å¾‹è®¡æ•°ç³»ç»Ÿ...');

            // å¦‚æœè®¡æ•°ç³»ç»Ÿå­˜åœ¨ä½†æœªåˆå§‹åŒ–ï¼Œæ‰‹åŠ¨åˆå§‹åŒ–
            if (window.melodyCounterSystem && !window.melodyCounterSystem.initialized) {
                window.melodyCounterSystem.init();
            }

            // å¦‚æœgenerateMelodyè¿˜æœªè¢«åŒ…è£…ï¼Œæ‰‹åŠ¨åŒ…è£…
            if (window.generateMelody && window.melodyCounterSystem && !window.melodyCounterSystem.originalGenerateMelody) {
                console.log('ğŸ“¦ æ‰‹åŠ¨åŒ…è£…generateMelodyå‡½æ•°...');
                window.melodyCounterSystem.wrapGenerateMelodyFunction();
            }

            // è·³è¿‡è‡ªåŠ¨æ¿€æ´»æ£€æŸ¥ï¼Œè®©ç”¨æˆ·æ­£å¸¸ä½¿ç”¨è¯•ç”¨ç‰ˆ
            console.log('ğŸ” è·³è¿‡è‡ªåŠ¨æ¿€æ´»æ£€æŸ¥ï¼Œä¿æŒè¯•ç”¨ç‰ˆçŠ¶æ€');

            console.log('âœ… è®¡æ•°ç³»ç»Ÿæ£€æŸ¥å®Œæˆ');
        }, 2000); // å»¶è¿Ÿ2ç§’ç¡®ä¿æ‰€æœ‰è„šæœ¬éƒ½åŠ è½½å®Œæˆ
    });
    </script>

</body></html>