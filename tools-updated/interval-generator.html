<!DOCTYPE html>
<!-- saved from url=(0269)file:///Users/igorchen/Downloads/IC%20Studio/IC%20%E8%A7%86%E5%A5%8F%E5%B7%A5%E5%85%B7%20%E7%AC%AC%E4%B8%80%E7%89%88%20(%E5%B7%B2%E4%B8%8A%E6%9E%B6)%20%E9%9F%B3%E7%A8%8B%E4%BF%AE%E5%A4%8D%E4%B8%AD%202/%E9%9F%B3%E7%A8%8B%E8%A7%86%E5%A5%8F%E7%94%9F%E6%88%90%E5%99%A8.html -->
<html lang="zh-CN" data-theme="light"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IC ËßÜÂ•èÂ∑•ÂÖ∑</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com/">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="">
    <link href="./IC Èü≥Á®ãËßÜÂ•èÂ∑•ÂÖ∑_files/css2" rel="stylesheet">
    
    <!-- OpenSheetMusicDisplay -->
    <script src="./IC Èü≥Á®ãËßÜÂ•èÂ∑•ÂÖ∑_files/opensheetmusicdisplay.min.js"></script>

    <!-- Èü≥Á®ãÁîüÊàêÂô®Ê®°Âùó -->
    <script src="./IC Èü≥Á®ãËßÜÂ•èÂ∑•ÂÖ∑_files/interval-settings.js"></script>
    <!-- üéµ Â∞èË∞ÉÁ≥ªÁªüÊ®°ÂùóÔºà‰ªéÊóãÂæãÂ∑•ÂÖ∑ËøÅÁßªÔºå2025-10-09Ôºâ -->
    <script src="./IC Èü≥Á®ãËßÜÂ•èÂ∑•ÂÖ∑_files/minor-scale-spelling.js"></script>
    <script src="./IC Èü≥Á®ãËßÜÂ•èÂ∑•ÂÖ∑_files/minor-alterations.js"></script>
    <!-- Ê†∏ÂøÉÁîüÊàêÂô® -->
    <script src="./IC Èü≥Á®ãËßÜÂ•èÂ∑•ÂÖ∑_files/interval-generator.js"></script>
    <script src="./IC Èü≥Á®ãËßÜÂ•èÂ∑•ÂÖ∑_files/interval-renderer.js"></script>
    <!-- V4.0ÈõÜÊàêËÑöÊú¨ -->
    <script src="./IC Èü≥Á®ãËßÜÂ•èÂ∑•ÂÖ∑_files/interval-generator-v4-integration.js"></script>
    
    <link rel="stylesheet" href="./IC Èü≥Á®ãËßÜÂ•èÂ∑•ÂÖ∑_files/apple-ui-styles-green.css">
    <script src="assets/js/sample-player.js?v=6"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function(){
        try {
          if (!window.__icSamplePlayer && window.ICSamplePlayer) {
            window.__icSamplePlayer = new ICSamplePlayer({ rootPath: 'assets/samples/piano-ogg-full' });
            window.__icSamplePlayer.load();
          }
        } catch(e) { console.warn('ÈááÊ†∑Âô®ÂàùÂßãÂåñÂ§±Ë¥•:', e); }
      });
    </script>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="header-text">
                    <h1 data-i18n="app.title">IC Studio - Èü≥Á®ãËßÜÂ•èÁîüÊàêÂô®</h1>
                    <p data-i18n="app.subtitle">‰∏ì‰∏öÁ∫ß‰πêË∞±Ê∏≤Êüì‰∏éÈü≥‰πêÁêÜËÆ∫Â∑•ÂÖ∑</p>
                </div>
                <div class="header-controls">
                    <div class="function-selector">
                        <button class="function-btn" id="functionBtn" onclick="toggleFunctionSelector()">
                            üéº <span id="currentFunction" data-i18n="app.intervalMode">Èü≥Á®ãËßÜÂ•è</span>
                        </button>
                        <div class="function-menu" id="functionMenu">
                            <div class="function-option" onclick="switchFunction('melody')">
                                <span class="function-icon">üéµ</span>
                                <span data-i18n="app.melodyMode">ÊóãÂæãËßÜÂ•è</span>
                            </div>
                            <div class="function-option" onclick="switchFunction('interval')">
                                <span class="function-icon">üéº</span>
                                <span data-i18n="app.intervalMode">Èü≥Á®ãËßÜÂ•è</span>
                            </div>
                            <div class="function-option" onclick="switchFunction('chord')">
                                <span class="function-icon">üéπ</span>
                                <span data-i18n="app.chordMode">ÂíåÂº¶ËßÜÂ•è</span>
                            </div>
                        </div>
                    </div>
                    <div class="settings-dropdown">
                        <button class="settings-btn" id="settingsBtn" onclick="toggleSettings()">
                            ‚öôÔ∏è <span data-i18n="settings.title">ËÆæÁΩÆ</span>
                        </button>
                        <div class="settings-menu" id="settingsMenu">
                            <!-- ‰∏ªÈ¢òËÆæÁΩÆ -->
                            <div class="settings-section">
                                <div class="settings-section-title" data-i18n="settings.theme">‰∏ªÈ¢ò</div>
                                <div class="theme-options">
                                    <div class="theme-option" onclick="setTheme('light')">
                                        <span class="theme-icon">‚òÄÔ∏è</span>
                                        <span data-i18n="settings.lightMode">ÊµÖËâ≤Ê®°Âºè</span>
                                    </div>
                                    <div class="theme-option" onclick="setTheme('dark')">
                                        <span class="theme-icon">üåô</span>
                                        <span data-i18n="settings.darkMode">Ê∑±Ëâ≤Ê®°Âºè</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ËØ≠Ë®ÄËÆæÁΩÆ -->
                            <div class="settings-section">
                                <div class="settings-section-title" data-i18n="settings.language">ËØ≠Ë®Ä</div>
                                <div class="language-options">
                                    <div class="language-option" onclick="switchLanguage('zh-CN')">
                                        ÁÆÄ‰Ωì‰∏≠Êñá
                                    </div>
                                    <div class="language-option" onclick="switchLanguage('zh-TW')">
                                        ÁπÅÈ´î‰∏≠Êñá
                                    </div>
                                    <div class="language-option" onclick="switchLanguage('en')">
                                        English
                                    </div>
                                </div>
                            </div>


                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="control-row">
                <div class="control-group">
                    <label data-i18n="controls.intervalType">Èü≥Á®ãÁ±ªÂûã</label>
                    <button class="btn-secondary" onclick="openIntervalTypeSettings()" id="intervalTypeSettingsBtn" data-i18n="controls.intervalTypeSettings">Èü≥Á®ãÁ±ªÂûãËÆæÁΩÆ</button>
                </div>

                <div class="control-group">
                    <label data-i18n="controls.measures">Â∞èËäÇÊï∞</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="measures-2" name="measures" value="2">
                            <label for="measures-2" data-i18n="controls.measures2">2Â∞èËäÇ</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="measures-4" name="measures" value="4" checked="">
                            <label for="measures-4" data-i18n="controls.measures4">4Â∞èËäÇ</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="measures-8" name="measures" value="8">
                            <label for="measures-8" data-i18n="controls.measures8">8Â∞èËäÇ</label>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <label data-i18n="controls.key">Ë∞ÉÂè∑</label>
                    <button class="btn-secondary" onclick="openKeySettings()" id="keySettingsBtn" data-i18n="controls.keySettings">Ë∞ÉÂè∑ËÆæÁΩÆ</button>
                </div>

                <div class="control-group">
                    <label data-i18n="controls.time">ÊãçÂè∑</label>
                    <button class="btn-secondary" onclick="openTimeSignatureSettings()" id="timeSignatureSettingsBtn" data-i18n="controls.timeSettings">ÊãçÂè∑ËÆæÁΩÆ</button>
                </div>

                <div class="control-group">
                    <label data-i18n="controls.clef">Ë∞±Âè∑</label>
                    <button class="btn-secondary" onclick="openClefSettings()" id="clefSettingsBtn" data-i18n="controls.clefSettings">Ë∞±Âè∑ËÆæÁΩÆ</button>
                </div>
            </div>

            <!-- Êñ∞Â¢ûÔºöÈü≥ÂüüËÆæÁΩÆ -->
            <div class="control-row">
                <div class="control-group">
                    <label for="rangeMin" data-i18n="controls.rangeMin">ÊúÄ‰ΩéÈü≥</label>
                    <select id="rangeMin">
                        <option value="33">A1</option>
                        <option value="35">B1</option>
                        <option value="36">C2</option>
                        <option value="38">D2</option>
                        <option value="40">E2</option>
                        <option value="41">F2</option>
                        <option value="43">G2</option>
                        <option value="45">A2</option>
                        <option value="47">B2</option>
                        <option value="48">C3</option>
                        <option value="50">D3</option>
                        <option value="52">E3</option>
                        <option value="53">F3</option>
                        <option value="55">G3</option>
                        <option value="57">A3</option>
                        <option value="59">B3</option>
                        <option value="60" selected="">C4</option>
                        <option value="62">D4</option>
                        <option value="64">E4</option>
                        <option value="65">F4</option>
                        <option value="67">G4</option>
                        <option value="69">A4</option>
                        <option value="71">B4</option>
                        <option value="72">C5</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="rangeMax" data-i18n="controls.rangeMax">ÊúÄÈ´òÈü≥</label>
                    <select id="rangeMax">
                        <option value="48">C3</option>
                        <option value="50">D3</option>
                        <option value="52">E3</option>
                        <option value="53">F3</option>
                        <option value="55">G3</option>
                        <option value="57">A3</option>
                        <option value="59">B3</option>
                        <option value="60">C4</option>
                        <option value="62">D4</option>
                        <option value="64">E4</option>
                        <option value="65">F4</option>
                        <option value="67">G4</option>
                        <option value="69">A4</option>
                        <option value="71">B4</option>
                        <option value="72" selected="">C5</option>
                        <option value="74">D5</option>
                        <option value="76">E5</option>
                        <option value="77">F5</option>
                        <option value="79">G5</option>
                        <option value="81">A5</option>
                        <option value="82">B5</option>
                        <option value="83">C6</option>
                        <option value="84">D6</option>
                        <option value="85">E6</option>
                    </select>
                </div>

                <div class="control-group" style="flex: none; width: 140px;">
                    <label for="accidentalRate" data-i18n="controls.accidental">‰∏¥Êó∂ËÆ∞Âè∑</label>
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <input type="range" id="accidentalRate" min="0" max="100" value="0" step="10" style="width: 90px;">
                        <span id="accidentalRateValue" style="font-weight: 400; min-width: 30px;">0%</span>
                    </div>
                </div>

                <div class="control-group metronome-group" style="flex: none; width: 160px;">
                    <label for="headerMetronomeBpm" data-i18n="controls.metronome">ËäÇÊãçÂô®</label>
                    <div class="metronome-control">
                        <input type="number" id="headerMetronomeBpm" min="1" max="999" value="60" class="bpm-input-control">
                        <button class="metronome-play-btn" id="headerMetronomeBtn" onclick="toggleMetronome()" title="ÂºÄÂßã/ÂÅúÊ≠¢ËäÇÊãçÂô®">
                            üéµ
                        </button>
                        <div class="metronome-beat-indicator" id="headerBeatIndicator"></div>
                    </div>
                </div>
            </div>

            <div class="control-row">
                <div class="buttons">
                    <button class="btn-primary" onclick="generateIntervals()" data-i18n="controls.generateInterval">ÁîüÊàêÈü≥Á®ã</button>
                    <div class="button-group">
                        <button class="btn-secondary" onclick="previousInterval()" data-i18n="controls.previous" disabled="" style="opacity: 1;">‰∏ä‰∏ÄÊù°</button>
                        <button class="btn-secondary" onclick="nextInterval()" data-i18n="controls.next" disabled="" style="opacity: 1;">‰∏ã‰∏ÄÊù°</button>
                    </div>
                    <div class="button-group">
                        <button class="btn-secondary" id="playIntervalBtn" onclick="directPlayTest()" data-i18n="controls.play">Êí≠Êîæ</button>
                        <button class="melody-visibility-btn" id="intervalVisibilityBtn" onclick="toggleIntervalVisibility()" title="ÈöêËóè/ÊòæÁ§∫Èü≥Á®ã">
                            üëÄ
                        </button>
                        
                    </div>
                    <div class="button-group">
                        <button class="btn-secondary" onclick="openRhythmSettings()" data-i18n="controls.rhythm">ËäÇÂ•èËÆæÁΩÆ</button>
                        <button class="btn-secondary" onclick="openArticulationSettings()" data-i18n="controls.articulation" style="display: none;">ÊºîÂ•èÊäÄÂ∑ß</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="score-container" title="ÁÇπÂáª‰ªªÊÑè‰ΩçÁΩÆÁîüÊàêÊñ∞Èü≥Á®ã" style="cursor: pointer;">
            <div id="score" style="cursor: pointer;">
                <div class="empty-score-message">
                    <p data-i18n="score.emptyInterval">ÁÇπÂáªÁîüÊàêÈü≥Á®ãÂºÄÂßãÁªÉ‰π†</p>
                </div>
            </div>
        </div>
        
        <!-- Copyright Information -->
        <div style="
            padding: 5px 0;
            text-align: center;
            font-size: 14px;
            color: var(--neutral-dark);
            opacity: 0.7;
            border-top: 1px solid var(--border-color);
            margin-top: 7.5px;
        ">
            <p style="margin: 0; line-height: 1.5;">
                <strong>IC Studio ËßÜÂ•èÂ∑•ÂÖ∑</strong> - ‰∏ì‰∏öÁ∫ßÈü≥Á®ãËßÜÂ•èÁîüÊàêÂô®
            </p>
            <p style="margin: 8px 0 0 0; font-size: 13px; opacity: 0.8;">
                Copyright ¬© 2025. All rights reserved. Igor Chen - 
                <a href="https://icstudio.club/" target="_blank" style="color: var(--primary-green); text-decoration: none;">icstudio.club</a>
            </p>
        </div>

    </div>

    <!-- Èü≥Á®ãÁ±ªÂûãËÆæÁΩÆÂºπÁ™ó -->
    <div id="intervalTypeModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="controls.intervalTypeSettings">Èü≥Á®ãÁ±ªÂûãËÆæÁΩÆ</h3>
                <button class="close-btn" onclick="closeIntervalTypeSettings()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="interval.basicTypes">Âü∫Êú¨Èü≥Á®ãÁ±ªÂûã</h4>
                        <button class="btn-select-all" onclick="selectAllIntervalTypes()" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;" data-i18n="button.selectAll">ÂÖ®ÈÄâ</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-minor2" value="minor2">
                            <span data-i18n="intervalType.minor2nd">Â∞è‰∫åÂ∫¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-major2" value="major2">
                            <span data-i18n="intervalType.major2nd">Â§ß‰∫åÂ∫¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-minor3" value="minor3" checked="">
                            <span data-i18n="intervalType.minor3rd">Â∞è‰∏âÂ∫¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-major3" value="major3" checked="">
                            <span data-i18n="intervalType.major3rd">Â§ß‰∏âÂ∫¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-perfect4" value="perfect4" checked="">
                            <span data-i18n="intervalType.perfect4th">ÂÆåÂÖ®ÂõõÂ∫¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-tritone" value="tritone">
                            <span data-i18n="intervalType.tritone">Â¢ûÂõõ/Âáè‰∫îÂ∫¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-perfect5" value="perfect5" checked="">
                            <span data-i18n="intervalType.perfect5th">ÂÆåÂÖ®‰∫îÂ∫¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-minor6" value="minor6" checked="">
                            <span data-i18n="intervalType.minor6th">Â∞èÂÖ≠Â∫¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-major6" value="major6" checked="">
                            <span data-i18n="intervalType.major6th">Â§ßÂÖ≠Â∫¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-minor7" value="minor7">
                            <span data-i18n="intervalType.minor7th">Â∞è‰∏ÉÂ∫¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-major7" value="major7">
                            <span data-i18n="intervalType.major7th">Â§ß‰∏ÉÂ∫¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-octave" value="octave">
                            <span data-i18n="intervalType.octave">ÂÖ´Â∫¶</span>
                        </label>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveIntervalTypeSettings()" data-i18n="button.save">‰øùÂ≠òËÆæÁΩÆ</button>
                    <button class="btn-secondary" onclick="closeIntervalTypeSettings()" data-i18n="button.cancel">ÂèñÊ∂à</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ËäÇÂ•èËÆæÁΩÆÂºπÁ™ó -->
    <div id="rhythmModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="controls.rhythm">ËäÇÂ•èËÆæÁΩÆ</h3>
                <button class="close-btn" onclick="closeRhythmSettings()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="rhythm.basicUnits">Âü∫Êú¨ËäÇÂ•èÂçï‰Ωç</h4>
                        <button class="btn-select-all" onclick="selectAllRhythms()" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;" data-i18n="button.selectAll">ÂÖ®ÈÄâ</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item" id="rhythm-whole-label" style="display: block;">
                            <input type="checkbox" id="rhythm-whole" value="whole">
                            <span data-i18n="rhythm.whole">ÂÖ®Èü≥Á¨¶</span>
                        </label>
                        <label class="checkbox-item" id="rhythm-dotted-half-label" style="display: none;">
                            <input type="checkbox" id="rhythm-dotted-half" value="half.">
                            <span data-i18n="rhythm.dottedHalf">ÈôÑÁÇπ‰∫åÂàÜÈü≥Á¨¶</span>
                        </label>
                        <label class="checkbox-item" id="rhythm-half-label" style="display: block;">
                            <input type="checkbox" id="rhythm-half" value="half" checked="">
                            <span data-i18n="rhythm.half">‰∫åÂàÜÈü≥Á¨¶</span>
                        </label>
                        <label class="checkbox-item" id="rhythm-dotted-quarter-label" style="display: none;">
                            <input type="checkbox" id="rhythm-dotted-quarter" value="quarter.">
                            <span data-i18n="rhythm.dottedQuarter">ÈôÑÁÇπÂõõÂàÜÈü≥Á¨¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="rhythm-quarter" value="quarter" checked="">
                            <span data-i18n="rhythm.quarter">ÂõõÂàÜÈü≥Á¨¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="rhythm-eighth" value="eighth">
                            <span data-i18n="rhythm.eighth">ÂÖ´ÂàÜÈü≥Á¨¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="rhythm-16th" value="16th">
                            <span data-i18n="rhythm.sixteenth">ÂçÅÂÖ≠ÂàÜÈü≥Á¨¶</span>
                        </label>
                        <label class="checkbox-item" id="rhythm-triplet-label" style="display: flex;">
                            <input type="checkbox" id="rhythm-triplet" value="triplet">
                            <span data-i18n="rhythm.triplet">‰∏âËøûÈü≥</span>
                        </label>
                        <label class="checkbox-item" id="rhythm-duplet-label" style="display: none;">
                            <input type="checkbox" id="rhythm-duplet" value="duplet">
                            <span data-i18n="rhythm.duplet">‰∫åËøûÈü≥</span>
                        </label>
                        <label class="checkbox-item" id="rhythm-quadruplet-label" style="display: none;">
                            <input type="checkbox" id="rhythm-quadruplet" value="quadruplet">
                            <span data-i18n="rhythm.quadruplet">ÂõõËøûÈü≥</span>
                        </label>
                    </div>
                </div>

                <!-- È´òÁ∫ßËÆæÁΩÆÂå∫Âüü -->
                <div id="rhythmAdvancedSettings" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 2px solid #e9ecef;">
                    <h4 style="margin-bottom: 15px; color: #495057;" data-i18n="rhythm.advancedFreq">È´òÁ∫ßÈ¢ëÁéáËÆæÁΩÆ</h4>
                    <p style="font-size: 0.9rem; color: #6c757d; margin-bottom: 20px;" data-i18n="rhythm.freqDesc">Ë∞ÉÊï¥ÂêÑËäÇÂ•èÂçï‰ΩçÂú®ÊóãÂæã‰∏≠ÁöÑÂá∫Áé∞È¢ëÁéá (0% = ‰∏ç‰ΩøÁî®, 100% = ‰ºòÂÖà‰ΩøÁî®)</p>
                    
                    <div class="rhythm-frequency-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="frequency-item" id="freq-whole-item" style="display: block;">
                            <label for="freq-whole" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;" data-i18n="rhythm.freq.whole">ÂÖ®Èü≥Á¨¶È¢ëÁéá:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-whole" min="0" max="100" value="10" style="flex: 1;">
                                <span id="freq-whole-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">10%</span>
                            </div>
                        </div>
                        <div class="frequency-item" id="freq-dotted-half-item" style="display: none;">
                            <label for="freq-dotted-half" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;" data-i18n="rhythm.freq.dottedHalf">ÈôÑÁÇπ‰∫åÂàÜÈü≥Á¨¶È¢ëÁéá:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-dotted-half" min="0" max="100" value="15" style="flex: 1;">
                                <span id="freq-dotted-half-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">15%</span>
                            </div>
                        </div>
                        <div class="frequency-item" id="freq-half-item" style="display: block;">
                            <label for="freq-half" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;" data-i18n="rhythm.freq.half">‰∫åÂàÜÈü≥Á¨¶È¢ëÁéá:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-half" min="0" max="100" value="30" style="flex: 1;">
                                <span id="freq-half-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">30%</span>
                            </div>
                        </div>
                        <div class="frequency-item" id="freq-dotted-quarter-item" style="display: none;">
                            <label for="freq-dotted-quarter" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;" data-i18n="rhythm.freq.dottedQuarter">ÈôÑÁÇπÂõõÂàÜÈü≥Á¨¶È¢ëÁéá:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-dotted-quarter" min="0" max="100" value="35" style="flex: 1;">
                                <span id="freq-dotted-quarter-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">35%</span>
                            </div>
                        </div>
                        <div class="frequency-item">
                            <label for="freq-quarter" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;" data-i18n="rhythm.freq.quarter">ÂõõÂàÜÈü≥Á¨¶È¢ëÁéá:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-quarter" min="0" max="100" value="50" style="flex: 1;">
                                <span id="freq-quarter-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">50%</span>
                            </div>
                        </div>
                        <div class="frequency-item">
                            <label for="freq-eighth" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;" data-i18n="rhythm.freq.eighth">ÂÖ´ÂàÜÈü≥Á¨¶È¢ëÁéá:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-eighth" min="0" max="100" value="40" style="flex: 1;">
                                <span id="freq-eighth-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">40%</span>
                            </div>
                        </div>
                        <div class="frequency-item">
                            <label for="freq-16th" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;" data-i18n="rhythm.freq.sixteenth">ÂçÅÂÖ≠ÂàÜÈü≥Á¨¶È¢ëÁéá:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-16th" min="0" max="100" value="20" style="flex: 1;">
                                <span id="freq-16th-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">20%</span>
                            </div>
                        </div>
                        <div class="frequency-item" id="freq-triplet-item" style="display: block;">
                            <label for="freq-triplet" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;" data-i18n="rhythm.freq.triplet">‰∏âËøûÈü≥È¢ëÁéá:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-triplet" min="0" max="100" value="15" style="flex: 1;">
                                <span id="freq-triplet-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">15%</span>
                            </div>
                        </div>
                        <div class="frequency-item" id="freq-duplet-item" style="display: none;">
                            <label for="freq-duplet" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;" data-i18n="rhythm.freq.duplet">‰∫åËøûÈü≥È¢ëÁéá:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-duplet" min="0" max="100" value="30" style="flex: 1;">
                                <span id="freq-duplet-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">30%</span>
                            </div>
                        </div>
                        <div class="frequency-item" id="freq-quadruplet-item" style="display: none;">
                            <label for="freq-quadruplet" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">ÂõõËøûÈü≥È¢ëÁéá:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="freq-quadruplet" min="0" max="100" value="25" style="flex: 1;">
                                <span id="freq-quadruplet-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">25%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn-secondary" onclick="resetRhythmFrequencies()" style="margin-right: 10px;" data-i18n="button.resetDefault">ËøîÂõûÈªòËÆ§</button>
                    </div>
                </div>
                
                <div class="modal-buttons">
                    <button class="btn-secondary" onclick="toggleRhythmAdvancedSettings()" id="rhythmAdvancedBtn" data-i18n="button.advanced">È´òÁ∫ßËÆæÁΩÆ</button>
                    <button class="btn-primary" onclick="saveRhythmSettings()" data-i18n="button.save">‰øùÂ≠òËÆæÁΩÆ</button>
                    <button class="btn-secondary" onclick="closeRhythmSettings()" data-i18n="button.cancel">ÂèñÊ∂à</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Articulations ÂºπÁ™ó -->
    <div id="articulationModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="controls.articulation">ÊºîÂ•èÊäÄÂ∑ß</h3>
                <button class="close-btn" onclick="closeArticulationSettings()">√ó</button>
            </div>
            <div class="modal-body">
                <!-- Âü∫Êú¨ArticulationÊäÄÂ∑ß -->
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="articulation.basic.title">Âü∫Êú¨ÊºîÂ•èÊ≥ï (Basic Articulations)</h4>
                        <button class="btn-select-all" onclick="selectAllBasicArticulations()" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">ÂÖ®ÈÄâ</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item" title="Êñ≠Â•è - Èü≥Á¨¶Êó∂ÂÄºÂáèÂçäÔºåËΩªÂø´Âú∞ÊºîÂ•è">
                            <input type="checkbox" id="art-staccato" value="staccato">
                            <span>Staccato (Êñ≠Â•è) ‚Ä¢</span>
                        </label>
                        <label class="checkbox-item" title="ÈáçÈü≥ - Âº∫Ë∞ÉÊüê‰∫õÈü≥Á¨¶">
                            <input type="checkbox" id="art-accent" value="accent">
                            <span>Accent (ÈáçÈü≥) &gt;</span>
                        </label>
                        <label class="checkbox-item" title="Áü≠ÂÄöÈü≥ - Âø´ÈÄüÁöÑË£ÖÈ•∞Èü≥">
                            <input type="checkbox" id="art-acciaccatura" value="acciaccatura">
                            <span>Acciaccatura (Áü≠ÂÄöÈü≥)</span>
                        </label>
                    </div>
                </div>

                <!-- Âêâ‰ªñÁâπÊúâÊäÄÂ∑ß -->
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4>Âêâ‰ªñÊäÄÂ∑ß (Guitar Techniques)</h4>
                        <button class="btn-select-all" onclick="selectAllGuitarTechniques()" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">ÂÖ®ÈÄâ</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item" title="ÂáªÂº¶ - Áî®Â∑¶ÊâãÊï≤Âáª‰∫ßÁîüÈü≥Á¨¶">
                            <input type="checkbox" id="gtr-hammer" value="hammer-on">
                            <span>Hammer-on (ÂáªÂº¶) H</span>
                        </label>
                        <label class="checkbox-item" title="ÂãæÂº¶ - Áî®Â∑¶ÊâãÂãæÁ¶ª‰∫ßÁîüÈü≥Á¨¶">
                            <input type="checkbox" id="gtr-pull" value="pull-off">
                            <span>Pull-off (ÂãæÂº¶) P</span>
                        </label>
                    </div>
                </div>

                <!-- È´òÁ∫ßËÆæÁΩÆÂå∫Âüü -->
                <div id="articulationAdvancedSettings" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 2px solid #e9ecef;">
                    <h4 style="margin-bottom: 15px; color: #495057;" data-i18n="rhythm.advancedFreq">È´òÁ∫ßÈ¢ëÁéáËÆæÁΩÆ</h4>
                    <p style="font-size: 0.9rem; color: #6c757d; margin-bottom: 20px;" data-i18n="articulation.freqDesc">Ë∞ÉÊï¥ÂêÑÊºîÂ•èÊ≥ïÂú®ÊóãÂæã‰∏≠ÁöÑÂá∫Áé∞È¢ëÁéá (0% = ‰∏ç‰ΩøÁî®, 100% = ÁªèÂ∏∏‰ΩøÁî®)</p>
                    
                    <div style="margin-bottom: 20px;">
                        <h5 style="color: #495057; margin-bottom: 10px;" data-i18n="articulation.basicFreq">Âü∫Êú¨ÊºîÂ•èÊ≥ïÈ¢ëÁéá</h5>
                        <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
                            <div class="frequency-item">
                                <label for="freq-staccato" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">Staccato (Êñ≠Â•è) È¢ëÁéá:</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="range" id="freq-staccato" min="0" max="100" value="20" style="flex: 1;">
                                    <span id="freq-staccato-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">20%</span>
                                </div>
                            </div>
                            <div class="frequency-item">
                                <label for="freq-accent" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">Accent (ÈáçÈü≥) È¢ëÁéá:</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="range" id="freq-accent" min="0" max="100" value="15" style="flex: 1;">
                                    <span id="freq-accent-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">15%</span>
                                </div>
                            </div>
                            <div class="frequency-item">
                                <label for="freq-acciaccatura" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">Acciaccatura (Áü≠ÂÄöÈü≥) È¢ëÁéá:</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="range" id="freq-acciaccatura" min="0" max="100" value="10" style="flex: 1;">
                                    <span id="freq-acciaccatura-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">10%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h5 style="color: #495057; margin-bottom: 10px;">Âêâ‰ªñÊäÄÂ∑ßÈ¢ëÁéá</h5>
                        <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
                            <div class="frequency-item">
                                <label for="freq-slur" style="font-size: 0.9rem; color: #495057; margin-bottom: 5px;">ÂáªÂãæÂº¶È¢ëÁéá:</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="range" id="freq-slur" min="0" max="100" value="15" style="flex: 1;">
                                    <span id="freq-slur-value" style="min-width: 40px; font-size: 0.9rem; font-weight: 600; color: #667eea;">15%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn-secondary" onclick="resetArticulationFrequencies()" style="margin-right: 10px;">ËøîÂõûÈªòËÆ§</button>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-secondary" onclick="toggleArticulationAdvancedSettings()" id="articulationAdvancedBtn" data-i18n="button.advanced">È´òÁ∫ßËÆæÁΩÆ</button>
                    <button class="btn-primary" onclick="saveArticulationSettings()" data-i18n="button.save">‰øùÂ≠òËÆæÁΩÆ</button>
                    <button class="btn-secondary" onclick="closeArticulationSettings()" data-i18n="button.cancel">ÂèñÊ∂à</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ë∞ÉÂè∑ËÆæÁΩÆÂºπÁ™ó -->
    <div id="keySignatureModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Ë∞ÉÂè∑ËÆæÁΩÆ</h3>
                <button class="close-btn" onclick="closeKeySettings()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="key.majorSection">Â§ßË∞É (Major)</h4>
                        <button class="btn-select-all" onclick="selectAllMajorKeys()" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;" data-i18n="button.selectAllMajor">ÂÖ®ÈÄâ</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-C" value="C" checked="">
                            <span data-i18n="key.C-major">C Â§ßË∞É (0#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-G" value="G">
                            <span data-i18n="key.G-major">G Â§ßË∞É (1#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-D" value="D">
                            <span data-i18n="key.D-major">D Â§ßË∞É (2#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-A" value="A">
                            <span data-i18n="key.A-major">A Â§ßË∞É (3#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-E" value="E">
                            <span data-i18n="key.E-major">E Â§ßË∞É (4#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-B" value="B">
                            <span data-i18n="key.B-major">B Â§ßË∞É (5#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-F#" value="F#">
                            <span data-i18n="key.Fs-major">F# Â§ßË∞É (6#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-F" value="F">
                            <span data-i18n="key.F-major">F Â§ßË∞É (1b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Bb" value="Bb">
                            <span data-i18n="key.Bb-major">Bb Â§ßË∞É (2b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Eb" value="Eb">
                            <span data-i18n="key.Eb-major">Eb Â§ßË∞É (3b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Ab" value="Ab">
                            <span data-i18n="key.Ab-major">Ab Â§ßË∞É (4b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Db" value="Db">
                            <span data-i18n="key.Db-major">Db Â§ßË∞É (5b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Gb" value="Gb">
                            <span data-i18n="key.Gb-major">Gb Â§ßË∞É (6b)</span>
                        </label>
                    </div>
                </div>

                <div class="rhythm-section" style="margin-top: 30px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="key.minorSection">Â∞èË∞É (Minor)</h4>
                        <button class="btn-select-all" onclick="selectAllMinorKeys()" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;" data-i18n="button.selectAllMinor">ÂÖ®ÈÄâ</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Am" value="Am">
                            <span data-i18n="key.a-minor">A Â∞èË∞É (0#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Em" value="Em">
                            <span data-i18n="key.e-minor">E Â∞èË∞É (1#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Bm" value="Bm">
                            <span data-i18n="key.b-minor">B Â∞èË∞É (2#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-F#m" value="F#m">
                            <span data-i18n="key.fs-minor">F# Â∞èË∞É (3#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-C#m" value="C#m">
                            <span data-i18n="key.cs-minor">C# Â∞èË∞É (4#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-G#m" value="G#m">
                            <span data-i18n="key.gs-minor">G# Â∞èË∞É (5#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-D#m" value="D#m">
                            <span data-i18n="key.ds-minor">D# Â∞èË∞É (6#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Dm" value="Dm">
                            <span data-i18n="key.d-minor">D Â∞èË∞É (1b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Gm" value="Gm">
                            <span data-i18n="key.g-minor">G Â∞èË∞É (2b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Cm" value="Cm">
                            <span data-i18n="key.c-minor">C Â∞èË∞É (3b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Fm" value="Fm">
                            <span data-i18n="key.f-minor">F Â∞èË∞É (4b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Bbm" value="Bbm">
                            <span data-i18n="key.bb-minor">Bb Â∞èË∞É (5b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Ebm" value="Ebm">
                            <span data-i18n="key.eb-minor">Eb Â∞èË∞É (6b)</span>
                        </label>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveKeySettings()" data-i18n="button.save">‰øùÂ≠òËÆæÁΩÆ</button>
                    <button class="btn-secondary" onclick="closeKeySettings()" data-i18n="button.cancel">ÂèñÊ∂à</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ÊãçÂè∑ËÆæÁΩÆÂºπÁ™ó -->
    <div id="timeSignatureModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="modal.timeSignature.title">ÊãçÂè∑ËÆæÁΩÆ</h3>
                <button class="close-btn" onclick="closeTimeSignatureSettings()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="timeSignature.options">ÊãçÂè∑ÈÄâÈ°π</h4>
                        <button class="btn-select-all" onclick="selectAllTimeSignatures()" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;" data-i18n="button.selectAll">ÂÖ®ÈÄâ</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="time-2/4" value="2/4">
                            <span data-i18n="time.2-4">2/4 Êãç</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="time-3/4" value="3/4">
                            <span data-i18n="time.3-4">3/4 Êãç</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="time-4/4" value="4/4" checked="">
                            <span data-i18n="time.4-4">4/4 Êãç</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="time-6/8" value="6/8">
                            <span data-i18n="time.6-8">6/8 Êãç</span>
                        </label>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveTimeSignatureSettings()" data-i18n="button.save">‰øùÂ≠òËÆæÁΩÆ</button>
                    <button class="btn-secondary" onclick="closeTimeSignatureSettings()" data-i18n="button.cancel">ÂèñÊ∂à</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Èü≥Á®ãË∑®Â∫¶ËÆæÁΩÆÂºπÁ™ó -->
    <div id="intervalModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Èü≥Á®ãË∑®Â∫¶ËÆæÁΩÆ</h3>
                <button class="close-btn" onclick="closeIntervalSettings()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4>ÊúÄÂ§ßÈü≥Á®ãË∑®Â∫¶ÈÄâÈ°π</h4>
                        <small style="color: #666; font-size: 12px;">Âè™ËÉΩÈÄâÊã©‰∏Ä‰∏™Èü≥Á®ã‰Ωú‰∏∫ÊúÄÂ§ßË∑®Â∫¶</small>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-1" value="1" onchange="handleIntervalCheckboxChange(this)">
                            <span>Â∞è‰∫åÂ∫¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-2" value="2" onchange="handleIntervalCheckboxChange(this)">
                            <span>Â§ß‰∫åÂ∫¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-3" value="3" onchange="handleIntervalCheckboxChange(this)">
                            <span>Â∞è‰∏âÂ∫¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-4" value="4" onchange="handleIntervalCheckboxChange(this)">
                            <span>Â§ß‰∏âÂ∫¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-5" value="5" onchange="handleIntervalCheckboxChange(this)">
                            <span>ÂÆåÂÖ®ÂõõÂ∫¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-6" value="6" onchange="handleIntervalCheckboxChange(this)">
                            <span>Â¢ûÂõõÂ∫¶/Âáè‰∫îÂ∫¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-7" value="7" onchange="handleIntervalCheckboxChange(this)">
                            <span>ÂÆåÂÖ®‰∫îÂ∫¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-8" value="8" onchange="handleIntervalCheckboxChange(this)">
                            <span>Â∞èÂÖ≠Â∫¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-9" value="9" onchange="handleIntervalCheckboxChange(this)">
                            <span>Â§ßÂÖ≠Â∫¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-10" value="10" onchange="handleIntervalCheckboxChange(this)">
                            <span>Â∞è‰∏ÉÂ∫¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-11" value="11" onchange="handleIntervalCheckboxChange(this)">
                            <span>Â§ß‰∏ÉÂ∫¶</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="interval-12" value="12" checked="" onchange="handleIntervalCheckboxChange(this)">
                            <span>ÂÆåÂÖ®ÂÖ´Â∫¶</span>
                        </label>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveIntervalSettings()" data-i18n="button.save">‰øùÂ≠òËÆæÁΩÆ</button>
                    <button class="btn-secondary" onclick="closeIntervalSettings()" data-i18n="button.cancel">ÂèñÊ∂à</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ë∞±Âè∑ËÆæÁΩÆÂºπÁ™ó -->
    <div id="clefModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="modal.clefSettings">Ë∞±Âè∑ËÆæÁΩÆ</h3>
                <button class="close-btn" onclick="closeClefSettings()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="clef.options">Ë∞±Âè∑ÈÄâÈ°π</h4>
                        <button class="btn-select-all" onclick="selectAllClefs()" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;" data-i18n="button.selectAll">ÂÖ®ÈÄâ</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="clef-treble" value="treble" checked="">
                            <span data-i18n="clef.treble">È´òÈü≥Ë∞±Âè∑ (GË∞±Âè∑)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="clef-bass" value="bass">
                            <span data-i18n="clef.bass">‰ΩéÈü≥Ë∞±Âè∑ (FË∞±Âè∑)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="clef-alto" value="alto">
                            <span data-i18n="clef.alto">‰∏≠Èü≥Ë∞±Âè∑ (CË∞±Âè∑)</span>
                        </label>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveClefSettings()" data-i18n="button.save">‰øùÂ≠òËÆæÁΩÆ</button>
                    <button class="btn-secondary" onclick="closeClefSettings()" data-i18n="button.cancel">ÂèñÊ∂à</button>
                </div>
            </div>
        </div>
    </div>

    <!-- emergency-fix.js removed - not needed for interval generation -->
    
    <!-- Â¢ûÂº∫ÁöÑÂÖ®ÈÄâÂàáÊç¢ÂäüËÉΩ - Â∑≤ÈõÜÊàêÂà∞‰∏ª‰ª£Á†Å‰∏≠ -->
    
    <!-- ‰∏ªÈ¢òÂàáÊç¢Á≥ªÁªü -->
    <script>
        // È°µÈù¢Ê®°ÂºèÊ†áËØÜ
        const pageMode = 'interval';
        
        // ‰∏ªÈ¢òÂàáÊç¢Áõ∏ÂÖ≥ÂèòÈáèÂíåÂäüËÉΩ
        let currentTheme = localStorage.getItem('preferredTheme') || 'light';
        
        // ‰∏ªÈ¢òÂõæÊ†á
        const themeIcons = {
            'light': 'üåô', // Âú®lightÊ®°ÂºèÊòæÁ§∫Êúà‰∫ÆÂõæÊ†áÔºåÁÇπÂáªÂàáÊç¢Âà∞dark
            'dark': '‚òÄÔ∏è'   // Âú®darkÊ®°ÂºèÊòæÁ§∫Â§™Èò≥ÂõæÊ†áÔºåÁÇπÂáªÂàáÊç¢Âà∞light
        };
        
        // ÂàáÊç¢‰∏ªÈ¢ò (‰øùÁïôÂêëÂêéÂÖºÂÆπÊÄß)
        function toggleTheme() {
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            setTheme(newTheme);
        }
        
        // ËÆæÁΩÆ‰∏ªÈ¢ò (Êñ∞ÁâàÊú¨ÔºåÁî®‰∫éËÆæÁΩÆËèúÂçï)
        function setTheme(theme) {
            currentTheme = theme;
            localStorage.setItem('preferredTheme', theme);

            // ËÆæÁΩÆHTMLÁöÑdata-themeÂ±ûÊÄß
            document.documentElement.setAttribute('data-theme', theme);

            // Ëß¶ÂèëÁªü‰∏ÄÂêåÊ≠•Á≥ªÁªü (ÂêåÊ†áÁ≠æÈ°µÂÜÖÂÆûÊó∂ÂêåÊ≠•)
            if (window.ICStudioSync) {
                window.ICStudioSync.syncTheme(theme, 'interval-tool');
            }

            // ÂÖ≥Èó≠ËÆæÁΩÆËèúÂçï
            closeSettings();

        }
        
        // Â∫îÁî®‰∏ªÈ¢ò (‰øùÁïôÂêëÂêéÂÖºÂÆπÊÄß)
        function switchTheme(theme) {
            currentTheme = theme;
            localStorage.setItem('preferredTheme', theme);
            
            // ËÆæÁΩÆHTMLÁöÑdata-themeÂ±ûÊÄß
            document.documentElement.setAttribute('data-theme', theme);
            
            // Êõ¥Êñ∞ÊåâÈíÆÂõæÊ†á (Â¶ÇÊûúÂ≠òÂú®ÊóßÁöÑ‰∏ªÈ¢òÂàáÊç¢Âô®)
            const themeSwitcher = document.getElementById('themeSwitcher');
            if (themeSwitcher) {
                themeSwitcher.textContent = themeIcons[theme];
            }
            
        }
        
        // ËÆæÁΩÆËèúÂçïÊéßÂà∂
        function toggleSettings() {
            const settingsMenu = document.getElementById('settingsMenu');
            const isVisible = settingsMenu.classList.contains('show');
            
            if (isVisible) {
                closeSettings();
            } else {
                openSettings();
            }
        }
        
        function openSettings() {
            const settingsMenu = document.getElementById('settingsMenu');
            settingsMenu.classList.add('show');
            
            // Ê∑ªÂä†ÁÇπÂáªÂ§ñÈÉ®Âå∫ÂüüÂÖ≥Èó≠ËèúÂçïÁöÑÁõëÂê¨Âô®
            setTimeout(() => {
                document.addEventListener('click', handleClickOutside);
            }, 10);
        }
        
        function closeSettings() {
            const settingsMenu = document.getElementById('settingsMenu');
            settingsMenu.classList.remove('show');
            
            // ÁßªÈô§ÁÇπÂáªÂ§ñÈÉ®Âå∫ÂüüÁöÑÁõëÂê¨Âô®
            document.removeEventListener('click', handleClickOutside);
        }
        
        // ÂäüËÉΩÈÄâÊã©Âô®ÊéßÂà∂
        function toggleFunctionSelector() {
            const functionMenu = document.getElementById('functionMenu');
            const isVisible = functionMenu.classList.contains('show');
            
            if (isVisible) {
                closeFunctionSelector();
            } else {
                openFunctionSelector();
            }
        }
        
        function openFunctionSelector() {
            const functionMenu = document.getElementById('functionMenu');
            functionMenu.classList.add('show');
            
            // Ê∑ªÂä†ÁÇπÂáªÂ§ñÈÉ®Âå∫ÂüüÂÖ≥Èó≠ËèúÂçïÁöÑÁõëÂê¨Âô®
            setTimeout(() => {
                document.addEventListener('click', handleFunctionClickOutside);
            }, 10);
        }
        
        function closeFunctionSelector() {
            const functionMenu = document.getElementById('functionMenu');
            functionMenu.classList.remove('show');
            
            // ÁßªÈô§ÁÇπÂáªÂ§ñÈÉ®Âå∫ÂüüÁöÑÁõëÂê¨Âô®
            document.removeEventListener('click', handleFunctionClickOutside);
        }
        
        // Â§ÑÁêÜÁÇπÂáªÂ§ñÈÉ®Âå∫ÂüüÂÖ≥Èó≠ÂäüËÉΩËèúÂçï
        function handleFunctionClickOutside(event) {
            const functionSelector = document.querySelector('.function-selector');
            
            if (functionSelector && !functionSelector.contains(event.target)) {
                closeFunctionSelector();
            }
        }
        
        // ÂΩìÂâçÂäüËÉΩÊ®°Âºè
        let currentFunctionMode = 'interval';
        
        // Èü≥Á®ãÂéÜÂè≤ËÆ∞ÂΩïÁ≥ªÁªü
        let intervalHistory = [];
        let currentIntervalIndex = -1;
        const MAX_HISTORY_SIZE = 50;
        
        // ÂàáÊç¢ÂäüËÉΩ
        function switchFunction(mode) {
            if (mode === 'melody') {
                // ÂØºËà™Âà∞ÊóãÂæãËßÜÂ•èÈ°µÈù¢
                window.location.href = 'IC ÊóãÂæãËßÜÂ•èÂ∑•ÂÖ∑.html';
            } else if (mode === 'interval') {
                // Â∑≤ÁªèÂú®Èü≥Á®ãËßÜÂ•èÈ°µÈù¢
                closeFunctionSelector();
                console.log('Â∑≤Âú®Èü≥Á®ãËßÜÂ•èÊ®°Âºè');
            } else if (mode === 'chord') {
                // ÂØºËà™Âà∞ÂíåÂº¶ËßÜÂ•èÈ°µÈù¢
                window.location.href = 'IC ÂíåÂº¶ËßÜÂ•èÂ∑•ÂÖ∑.html';
            }
        }
        
        // Â§ÑÁêÜÁÇπÂáªÂ§ñÈÉ®Âå∫ÂüüÂÖ≥Èó≠ËÆæÁΩÆËèúÂçï
        function handleClickOutside(event) {
            const settingsDropdown = document.querySelector('.settings-dropdown');
            
            if (settingsDropdown && !settingsDropdown.contains(event.target)) {
                closeSettings();
            }
        }

        // ËäÇÊãçÂô®Áõ∏ÂÖ≥ÂèòÈáèÂíåÂäüËÉΩ
        let metronomeInterval = null;
        let metronomeAudioContext = null;
        let metronomeOscillator = null;
        let isMetronomeRunning = false;
        let metronomeTempo = 60; // ÈªòËÆ§60 BPM

        // üîß Á≤æÁ°ÆÂêåÊ≠•ÔºöËÆ∞ÂΩïËäÇÊãçÂô®ÂêØÂä®Êó∂Èó¥ÂíåÂΩìÂâçËäÇÊãç
        let metronomeStartTime = null;
        let metronomeCurrentBeat = 0;
        let metronomeSchedulerInterval = null;

        // üîß ÂÖ≥ÈîÆ‰øÆÂ§çÔºö‰ΩøÁî®‰∏éÈü≥Á®ãÊí≠ÊîæÁõ∏ÂêåÁöÑ AudioContext
        function initializeMetronomeAudio() {
            try {
                // ‰ºòÂÖà‰ΩøÁî®Èü≥Á®ãÊí≠ÊîæÁöÑ AudioContext
                if (window.intervalAudioCtx) {
                    metronomeAudioContext = window.intervalAudioCtx;
                    console.log('üéµ ËäÇÊãçÂô®‰ΩøÁî®Èü≥Á®ãÁöÑ AudioContextÔºàÂÖ±‰∫´Êó∂ÈíüÔºâ');
                } else {
                    metronomeAudioContext = new (window.AudioContext || window.webkitAudioContext)();
                    // ÂèçÂêëÂÖ±‰∫´ÔºöËÆ©Èü≥Á®ã‰πü‰ΩøÁî®Ëøô‰∏™ AudioContext
                    window.intervalAudioCtx = metronomeAudioContext;
                    console.log('üéµ ËäÇÊãçÂô®ÂàõÂª∫Êñ∞ AudioContextÔºàÂÖ±‰∫´ÁªôÈü≥Á®ãÔºâ');
                }
                return true;
            } catch (error) {
                console.error('‚ùå Web Audio API ‰∏çÊîØÊåÅ:', error);
                return false;
            }
        }

        // Êí≠ÊîæËäÇÊãçÂô®Â£∞Èü≥ - ÊîØÊåÅÁ≤æÁ°ÆË∞ÉÂ∫¶
        function playMetronomeSound(time) {
            if (!metronomeAudioContext) {
                if (!initializeMetronomeAudio()) return;
            }

            try {
                // ÊÅ¢Â§çÈü≥È¢ë‰∏ä‰∏ãÊñáÔºàÁî®Êà∑‰∫§‰∫íÂêéÔºâ
                if (metronomeAudioContext.state === 'suspended') {
                    metronomeAudioContext.resume();
                }

                // üîß ‰ΩøÁî®‰º†ÂÖ•ÁöÑÁ≤æÁ°ÆÊó∂Èó¥ÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàô‰ΩøÁî®ÂΩìÂâçÊó∂Èó¥
                const scheduleTime = time !== undefined ? time : metronomeAudioContext.currentTime;

                const oscillator = metronomeAudioContext.createOscillator();
                const gainNode = metronomeAudioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(metronomeAudioContext.destination);

                // ‰ΩøÁî®ÊñπÊ≥¢ÂíåËá™ÁÑ∂Èü≥È´ò (ÂèÇËÄÉNiceChordËäÇÊãçÂô®)
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(523.25, scheduleTime); // C5Èü≥È´ò

                // ËÆæÁΩÆËá™ÁÑ∂ÁöÑÈü≥ÈáèÂåÖÁªú (Êõ¥Â•ΩÁöÑrelease time)
                gainNode.gain.setValueAtTime(0.25, scheduleTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, scheduleTime + 0.05);

                oscillator.start(scheduleTime);
                oscillator.stop(scheduleTime + 0.05);

                // ËßÜËßâÂèçÈ¶à - Êõ¥Êñ∞headerÊåáÁ§∫Âô®ÔºàÂè™Âú®Á´ãÂç≥Êí≠ÊîæÊó∂Ôºâ
                if (time === undefined || scheduleTime <= metronomeAudioContext.currentTime + 0.05) {
                    const headerIndicator = document.getElementById('headerBeatIndicator');

                    if (headerIndicator) {
                        headerIndicator.classList.add('beat');
                        setTimeout(() => {
                            headerIndicator.classList.remove('beat');
                        }, 150);
                    }
                }

            } catch (error) {
                console.error('‚ùå ËäÇÊãçÂô®Â£∞Èü≥Êí≠ÊîæÂ§±Ë¥•:', error);
            }
        }

        // ËÆæÁΩÆËäÇÊãçÂô®ÈÄüÂ∫¶
        function setMetronomeTempo(bpm) {
            metronomeTempo = Math.max(1, Math.min(999, bpm));

            // ÂêåÊ≠•Êõ¥Êñ∞headerËæìÂÖ•Ê°Ü
            const headerInput = document.getElementById('headerMetronomeBpm');
            if (headerInput) headerInput.value = metronomeTempo;

            // Â¶ÇÊûúËäÇÊãçÂô®Ê≠£Âú®ËøêË°åÔºåÈáçÊñ∞ÂêØÂä®‰ª•Â∫îÁî®Êñ∞ÈÄüÂ∫¶
            if (isMetronomeRunning) {
                stopMetronome();
                startMetronome();
            }
        }

        // üîß Á≤æÁ°ÆËäÇÊãçÂô®Ë∞ÉÂ∫¶Âô® - ‰ΩøÁî® Web Audio API Êó∂Èíü
        function scheduleMetronomeBeat() {
            if (!metronomeAudioContext) {
                if (!initializeMetronomeAudio()) return;
            }

            const beatDuration = 60.0 / metronomeTempo; // ÊØèÊãçÁöÑÁßíÊï∞
            const scheduleAheadTime = 0.2; // Ë∞ÉÂ∫¶Êú™Êù• 200ms ÁöÑËäÇÊãç

            while (metronomeStartTime + metronomeCurrentBeat * beatDuration <
                   metronomeAudioContext.currentTime + scheduleAheadTime) {

                const beatTime = metronomeStartTime + metronomeCurrentBeat * beatDuration;

                // Ë∞ÉÂ∫¶Ëøô‰∏ÄÊãç
                playMetronomeSound(beatTime);

                metronomeCurrentBeat++;
            }
        }

        // ÂêØÂä®ËäÇÊãçÂô® - ‰ΩøÁî®Á≤æÁ°Æ Web Audio API Ë∞ÉÂ∫¶
        function startMetronome() {
            const headerInput = document.getElementById('headerMetronomeBpm');
            const tempo = parseInt(headerInput ? headerInput.value : metronomeTempo) || 60;
            metronomeTempo = tempo;

            // ÂêåÊ≠•Êõ¥Êñ∞headerËæìÂÖ•Ê°Ü
            if (headerInput) headerInput.value = metronomeTempo;

            if (isMetronomeRunning) return;

            if (!metronomeAudioContext) {
                if (!initializeMetronomeAudio()) return;
            }

            // ÊÅ¢Â§çÈü≥È¢ë‰∏ä‰∏ãÊñá
            if (metronomeAudioContext.state === 'suspended') {
                metronomeAudioContext.resume();
            }

            isMetronomeRunning = true;

            // üîß ÂÖ≥ÈîÆ‰øÆÂ§çÔºö‰ΩøÁî® AudioContext Êó∂Èó¥ 0 ‰Ωú‰∏∫ÂÖ®Â±ÄËäÇÊãçÁΩëÊ†ºÁöÑËµ∑ÁÇπ
            metronomeStartTime = 0; // ÂÖ®Â±ÄÁΩëÊ†ºËµ∑ÁÇπ

            const beatDuration = 60.0 / metronomeTempo;
            const now = metronomeAudioContext.currentTime;

            // ËÆ°ÁÆóÂΩìÂâçÂ∫îËØ•Âú®Á¨¨Âá†ÊãçÔºà‰ªéÊó∂Èó¥ 0 ÂºÄÂßãÔºâ
            const currentBeatNumber = Math.floor(now / beatDuration);
            const nextBeatNumber = currentBeatNumber + 1;
            const nextBeatTime = nextBeatNumber * beatDuration;

            // Á°Æ‰øù‰∏ã‰∏ÄÊãçËá≥Â∞ëÂú®Êú™Êù• 50msÔºåÂê¶ÂàôË∑≥Ëøá
            const minLookahead = 0.05;
            if (nextBeatTime < now + minLookahead) {
                metronomeCurrentBeat = nextBeatNumber + 1;
            } else {
                metronomeCurrentBeat = nextBeatNumber;
            }

            console.log(`üéµ ËäÇÊãçÂô®ÂØπÈΩêÂÖ®Â±ÄÁΩëÊ†º: ${metronomeTempo} BPM, ÂΩìÂâç=${now.toFixed(3)}s, ‰ªéÁ¨¨${metronomeCurrentBeat}ÊãçÂºÄÂßã (Êó∂Èó¥=${(metronomeCurrentBeat * beatDuration).toFixed(3)}s)`);

            // Á´ãÂç≥Ë∞ÉÂ∫¶Á¨¨‰∏ÄÊâπËäÇÊãç
            scheduleMetronomeBeat();

            // üîß ‰ΩøÁî®Êõ¥È¢ëÁπÅÁöÑÂÆöÊó∂Âô®Êù•Ê£ÄÊü•ÂíåË∞ÉÂ∫¶Ôºà25msÔºâÔºåËÄå‰∏çÊòØÁî®ÂÆÉÊù•Êí≠ÊîæÂ£∞Èü≥
            metronomeSchedulerInterval = setInterval(scheduleMetronomeBeat, 25);

            // Êõ¥Êñ∞UI
            updateMetronomeUI();
        }

        // ‰∏éÊí≠ÊîæÂÜÖÂÆπÂêåÊ≠•ÁöÑËäÇÊãçÂô®ÂêØÂä®
        function synchronizeMetronomeWithPlayback(interval) {
            const currentTime = performance.now();
            const playbackElapsed = currentTime - window.intervalPlaybackStartTime; // Êí≠ÊîæÂ∑≤ÁªèËøáÂéªÁöÑÊó∂Èó¥ÔºàÊØ´ÁßíÔºâ

            // üéµ ËÆ∞ÂΩïËäÇÊãçÂô®ÂêØÂä®Êó∂Èó¥ÔºåÁî®‰∫éÂêåÊ≠•ËÆ°ÁÆó
            window.metronomeStartTime = currentTime;

            // Ëé∑ÂèñÊí≠ÊîæÂÜÖÂÆπÁöÑÊãçÂè∑‰ø°ÊÅØ
            const timeSignature = window.intervalPlaybackTimeSignature || { beats: 4, beatType: 4 };
            const beatsPerMeasure = timeSignature.beats;

            // ËÆ°ÁÆóÂΩìÂâçÂú®Âì™‰∏ÄÊãçÔºàÂü∫‰∫éÂõõÂàÜÈü≥Á¨¶Ôºâ
            const beatDurationMs = interval; // ÊØèÊãçÁöÑÊØ´ÁßíÊï∞
            const currentBeatPosition = (playbackElapsed / beatDurationMs) % beatsPerMeasure;
            const currentBeatNumber = Math.floor(currentBeatPosition) + 1; // 1-based
            const positionInBeat = currentBeatPosition % 1; // Âú®ÂΩìÂâçÊãçÂÜÖÁöÑ‰ΩçÁΩÆÔºà0-1Ôºâ

            console.log(`  - Êí≠ÊîæÂ∑≤ËøõË°å: ${(playbackElapsed/1000).toFixed(2)}Áßí`);
            console.log(`  - ÂΩìÂâçÊãç‰ΩçÁΩÆ: ${currentBeatPosition.toFixed(3)} (Á¨¨${currentBeatNumber}Êãç)`);
            console.log(`  - ÊãçÂÜÖ‰ΩçÁΩÆ: ${(positionInBeat*100).toFixed(1)}%`);

            // ËÆ°ÁÆóÂà∞‰∏ã‰∏Ä‰∏™Êï¥ÊãçÁöÑÊó∂Èó¥
            const timeToNextBeat = (1 - positionInBeat) * beatDurationMs;

            if (timeToNextBeat < 50) {
                // Â¶ÇÊûúË∑ùÁ¶ª‰∏ã‰∏ÄÊãçÂæàËøëÔºà<50msÔºâÔºåÁ´ãÂç≥Êí≠Êîæ
                playMetronomeSound();

                // ËÆæÁΩÆÂÆöÊó∂Âô®‰ªé‰∏ã‰∏ÄÊãçÂºÄÂßã
                metronomeInterval = setInterval(() => {
                    playMetronomeSound();
                }, interval);
            } else {
                // Âª∂ËøüÂà∞‰∏ã‰∏ÄÊãçÂºÄÂßã

                // Âª∂ËøüÂà∞‰∏ã‰∏ÄÊãç
                setTimeout(() => {
                    if (isMetronomeRunning) { // Á°Æ‰øùÁî®Êà∑Ê≤°ÊúâÂèñÊ∂à
                        playMetronomeSound();

                        // ËÆæÁΩÆÂÆöÊó∂Âô®
                        metronomeInterval = setInterval(() => {
                            playMetronomeSound();
                        }, interval);
                    }
                }, timeToNextBeat);
            }
        }

        // ÂÅúÊ≠¢ËäÇÊãçÂô®
        function stopMetronome() {
            if (metronomeInterval) {
                clearInterval(metronomeInterval);
                metronomeInterval = null;
            }

            // üîß Ê∏ÖÈô§Ë∞ÉÂ∫¶Âô®ÂÆöÊó∂Âô®
            if (metronomeSchedulerInterval) {
                clearInterval(metronomeSchedulerInterval);
                metronomeSchedulerInterval = null;
            }

            isMetronomeRunning = false;

            // ÈáçÁΩÆËäÇÊãçËÆ°Êï∞
            metronomeStartTime = null;
            metronomeCurrentBeat = 0;

            updateMetronomeUI();

            console.log('üîá ËäÇÊãçÂô®Â∑≤ÂÅúÊ≠¢');
        }

        // ÂàáÊç¢ËäÇÊãçÂô®ÂºÄÂÖ≥
        function toggleMetronome() {
            if (isMetronomeRunning) {
                stopMetronome();
            } else {
                startMetronome();
            }
        }

        // Êõ¥Êñ∞ËäÇÊãçÂô®UI
        function updateMetronomeUI() {
            const headerToggleBtn = document.getElementById('headerMetronomeBtn');
            
            // Êõ¥Êñ∞header‰∏≠ÁöÑÊåâÈíÆ
            if (headerToggleBtn) {
                if (isMetronomeRunning) {
                    headerToggleBtn.classList.add('active');
                    headerToggleBtn.textContent = 'üéµ';
                    headerToggleBtn.title = 'ÂÅúÊ≠¢ËäÇÊãçÂô®';
                } else {
                    headerToggleBtn.classList.remove('active');
                    headerToggleBtn.textContent = 'üéµ';
                    headerToggleBtn.title = 'ÂºÄÂßãËäÇÊãçÂô®';
                }
            }
        }

        // ÁõëÂê¨header‰∏≠BPMËæìÂÖ•Ê°ÜÁöÑÂèòÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            const headerSpeedInput = document.getElementById('headerMetronomeBpm');
            
            if (headerSpeedInput) {
                // ÂÆûÊó∂ËæìÂÖ•È™åËØÅ
                headerSpeedInput.addEventListener('input', function() {
                    let value = parseInt(this.value);
                    
                    // ÈôêÂà∂ËåÉÂõ¥
                    if (value < 1) {
                        this.value = 1;
                        value = 1;
                    } else if (value > 999) {
                        this.value = 999;
                        value = 999;
                    }
                    
                    if (!isNaN(value)) {
                        setMetronomeTempo(value);
                    }
                });
                
                // EnterÈîÆÁ°ÆËÆ§
                headerSpeedInput.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        this.blur(); // Â§±ÂéªÁÑ¶ÁÇπÔºåËß¶ÂèëÈ™åËØÅ
                    }
                });
                
                // Â§±ÂéªÁÑ¶ÁÇπÊó∂È™åËØÅ
                headerSpeedInput.addEventListener('blur', function() {
                    let value = parseInt(this.value);
                    
                    if (isNaN(value) || value < 1) {
                        this.value = 1;
                        value = 1;
                    } else if (value > 999) {
                        this.value = 999;
                        value = 999;
                    }
                    
                    setMetronomeTempo(value);
                });

                // BPMÊãñÂä®ÂäüËÉΩÂÆûÁé∞
                let isDragging = false;
                let startY = 0;
                let startValue = 0;
                let dragTimeout = null;
                let hasStartedDrag = false;
                
                // Èº†Ê†áÊåâ‰∏ã‰∫ã‰ª∂
                headerSpeedInput.addEventListener('mousedown', function(event) {
                    // Âè™Â§ÑÁêÜÂ∑¶ÈîÆÁÇπÂáª
                    if (event.button !== 0) return;
                    
                    startY = event.clientY;
                    startValue = parseInt(this.value) || 60;
                    hasStartedDrag = false;
                    
                    console.log('BPMÊãñÂä®: Èº†Ê†áÊåâ‰∏ã', startValue);
                    
                    // ÈïøÊåâ80msÂêéÂêØÂä®ÊãñÂä®Ê®°Âºè
                    dragTimeout = setTimeout(() => {
                        isDragging = true;
                        hasStartedDrag = true;
                        
                        console.log('BPMÊãñÂä®: ÂêØÂä®ÊãñÂä®Ê®°Âºè');
                        
                        // Èò≤Ê≠¢ÊñáÊú¨ÈÄâÊã©ÂíåÈªòËÆ§Ë°å‰∏∫
                        event.preventDefault();
                        document.body.style.userSelect = 'none';
                        document.body.style.webkitUserSelect = 'none';
                        document.body.style.mozUserSelect = 'none';
                        document.body.style.msUserSelect = 'none';
                        
                        // Ê∑ªÂä†ÊãñÂä®‰∏≠ÁöÑËßÜËßâÂèçÈ¶à
                        this.style.cursor = 'ns-resize';
                        this.classList.add('dragging');
                        this.blur(); // Â§±ÂéªÁÑ¶ÁÇπÔºåÈÅøÂÖçÈîÆÁõòËæìÂÖ•Âπ≤Êâ∞
                    }, 80);
                });
                
                // Èº†Ê†áÁßªÂä®‰∫ã‰ª∂ - ÁªëÂÆöÂà∞ÂÖ®Â±Ä
                const handleMouseMove = function(event) {
                    if (!isDragging || !hasStartedDrag) return;
                    
                    const deltaY = startY - event.clientY; // Âêë‰∏ä‰∏∫Ê≠£ÔºåÂêë‰∏ã‰∏∫Ë¥ü
                    const sensitivity = 1; // ÊãñÂä®ÁÅµÊïèÂ∫¶ÔºåÊØè1ÂÉèÁ¥†ÊîπÂèò1‰∏™BPM
                    const newValue = Math.max(1, Math.min(999, startValue + Math.round(deltaY / sensitivity)));
                    
                    console.log('BPMÊãñÂä®: ÁßªÂä®‰∏≠', deltaY, newValue);
                    
                    headerSpeedInput.value = newValue;
                    setMetronomeTempo(newValue);
                    
                    // ÈòªÊ≠¢ÈªòËÆ§Ë°å‰∏∫
                    event.preventDefault();
                    event.stopPropagation();
                };
                
                // Èº†Ê†áÈáäÊîæ‰∫ã‰ª∂ - ÁªëÂÆöÂà∞ÂÖ®Â±Ä
                const handleMouseUp = function(event) {
                    console.log('BPMÊãñÂä®: Èº†Ê†áÈáäÊîæ', isDragging);
                    
                    // Ê∏ÖÈô§ÈïøÊåâËÆ°Êó∂Âô®
                    if (dragTimeout) {
                        clearTimeout(dragTimeout);
                        dragTimeout = null;
                    }
                    
                    if (isDragging && hasStartedDrag) {
                        isDragging = false;
                        hasStartedDrag = false;
                        
                        // ÊÅ¢Â§çÊñáÊú¨ÈÄâÊã©
                        document.body.style.userSelect = '';
                        document.body.style.webkitUserSelect = '';
                        document.body.style.mozUserSelect = '';
                        document.body.style.msUserSelect = '';
                        
                        // ÁßªÈô§ËßÜËßâÂèçÈ¶à
                        headerSpeedInput.style.cursor = '';
                        headerSpeedInput.classList.remove('dragging');
                        
                        console.log('BPMÊãñÂä®: ÁªìÊùüÊãñÂä®Ê®°Âºè');
                    }
                };
                
                // ÁªëÂÆöÂÖ®Â±Ä‰∫ã‰ª∂
                document.addEventListener('mousemove', handleMouseMove, true);
                document.addEventListener('mouseup', handleMouseUp, true);
                
                // Èº†Ê†áÁ¶ªÂºÄËæìÂÖ•Ê°ÜÊó∂ÂèñÊ∂àÈïøÊåâ
                headerSpeedInput.addEventListener('mouseleave', function(event) {
                    if (dragTimeout && !isDragging) {
                        clearTimeout(dragTimeout);
                        dragTimeout = null;
                        console.log('BPMÊãñÂä®: Èº†Ê†áÁ¶ªÂºÄÔºåÂèñÊ∂àÈïøÊåâ');
                    }
                });
                
                // Èò≤Ê≠¢Âè≥ÈîÆËèúÂçïÂπ≤Êâ∞
                headerSpeedInput.addEventListener('contextmenu', function(event) {
                    if (isDragging) {
                        event.preventDefault();
                    }
                });
            }
            
            // ÁõëÂê¨‰∏¥Êó∂ËÆ∞Âè∑ÊªëÂùóÂèòÂåñ
            const accidentalSlider = document.getElementById('accidentalRate');
            const accidentalValue = document.getElementById('accidentalRateValue');

            if (accidentalSlider && accidentalValue) {
                accidentalSlider.addEventListener('input', function() {
                    accidentalValue.textContent = this.value + '%';
                });
            }

            // üéº Êô∫ËÉΩË∞±Âè∑-Èü≥ÂüüÁªëÂÆöÁ≥ªÁªüÔºöÊ∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®
            function initClefRangeBinding() {
                // Áªü‰∏Ä‰ΩøÁî®ÂÖ®Â±Ä intervalSettings ÂÆû‰æãÔºåÈÅøÂÖçÈáçÂ§çÂàõÂª∫
                if (typeof window.intervalSettings === 'undefined') {
                    // Â¶ÇÊûúÂÖ®Â±ÄÂèòÈáè‰∏çÂ≠òÂú®ÔºåÊöÇÊó∂ÂàõÂª∫Ôºå‰ΩÜ‰ºòÂÖà‰ΩøÁî®Â∑≤Â≠òÂú®ÁöÑÂÆû‰æã
                    if (typeof intervalSettings !== 'undefined') {
                        window.intervalSettings = intervalSettings;
                    } else {
                        window.intervalSettings = new IntervalSettings();
                    }
                }

                // Ë∞±Âè∑Â§çÈÄâÊ°Ü‰∫ã‰ª∂ÁõëÂê¨
                const clefCheckboxes = document.querySelectorAll('#clefModal input[type="checkbox"]');

                clefCheckboxes.forEach((checkbox, index) => {

                    checkbox.addEventListener('change', function() {

                        if (this.checked) {
                            // ‰øùÂ≠òÂΩìÂâçÈü≥ÂüüÂà∞‰πãÂâçÁöÑË∞±Âè∑
                            const currentMin = document.getElementById('rangeMin')?.value;
                            const currentMax = document.getElementById('rangeMax')?.value;
                            if (currentMin && currentMax) {
                                // ÊâæÂà∞‰πãÂâçÈÄâ‰∏≠ÁöÑË∞±Âè∑
                                const previouslyChecked = Array.from(clefCheckboxes).find(cb =>
                                    cb !== this && cb.checked
                                );
                                if (previouslyChecked) {
                                    window.intervalSettings.setClefRange(previouslyChecked.value, parseInt(currentMin), parseInt(currentMax));
                                }
                            }

                            // ÂèñÊ∂àÂÖ∂‰ªñË∞±Âè∑ÈÄâÊã©ÔºàÁ°Æ‰øùÂè™ÈÄâÊã©‰∏Ä‰∏™Ôºâ
                            clefCheckboxes.forEach(cb => {
                                if (cb !== this && cb.checked) {
                                    console.log(`üîÑ ÂèñÊ∂àÈÄâÊã©Ë∞±Âè∑: ${cb.value}`);
                                    cb.checked = false;
                                }
                            });

                            // Â§ÑÁêÜË∞±Âè∑ÂèòÂåñ
                            window.intervalSettings.onClefChange(this.value);
                        }
                    });
                });

                // Èü≥ÂüüÈÄâÊã©Âô®‰∫ã‰ª∂ÁõëÂê¨
                const rangeMinSelect = document.getElementById('rangeMin');
                const rangeMaxSelect = document.getElementById('rangeMax');

                if (rangeMinSelect) {
                    rangeMinSelect.addEventListener('change', function() {
                        console.log('üéöÔ∏è ÊúÄ‰ΩéÈü≥ÂèëÁîüÂèòÂåñ:', this.value);
                        if (window.intervalSettings && typeof window.intervalSettings.onRangeChange === 'function') {
                            window.intervalSettings.onRangeChange();
                        } else {
                            console.warn('‚ö†Ô∏è intervalSettings.onRangeChange ‰∏çÂèØÁî®');
                        }
                    });
                }

                if (rangeMaxSelect) {
                    rangeMaxSelect.addEventListener('change', function() {
                        console.log('üéöÔ∏è ÊúÄÈ´òÈü≥ÂèëÁîüÂèòÂåñ:', this.value);
                        if (window.intervalSettings && typeof window.intervalSettings.onRangeChange === 'function') {
                            window.intervalSettings.onRangeChange();
                        } else {
                            console.warn('‚ö†Ô∏è intervalSettings.onRangeChange ‰∏çÂèØÁî®');
                        }
                    });
                }

                // ÂàùÂßãÂåñUIÔºöËÆæÁΩÆÂΩìÂâçË∞±Âè∑ÂØπÂ∫îÁöÑÈªòËÆ§Èü≥Âüü
                setTimeout(() => {
                    const currentClef = window.intervalSettings.getClef();
                    console.log(`üîÑ È°µÈù¢Âä†ËΩΩÂàùÂßãÂåñ: ${currentClef} Ë∞±Âè∑`);

                    // ËÆæÁΩÆÂàùÂßãË∞±Âè∑ËÆ∞ÂΩï
                    window.intervalSettings.lastSelectedClef = currentClef;

                    // Á°Æ‰øùÂÖÉÁ¥†Â∑≤ÁªèÂÆåÂÖ®Âä†ËΩΩ
                    const rangeMinSelect = document.getElementById('rangeMin');
                    const rangeMaxSelect = document.getElementById('rangeMax');

                    if (rangeMinSelect && rangeMaxSelect) {

                        // üéØ È°µÈù¢Âä†ËΩΩÊó∂ÊÄªÊòØ‰ΩøÁî®ÈªòËÆ§Èü≥ÂüüÔºå‰∏ç‰ΩøÁî®‰øùÂ≠òÁöÑËÆæÁΩÆ
                        const defaultRange = window.intervalSettings.getClefDefaultRange(currentClef);

                        rangeMinSelect.value = defaultRange.min.toString();
                        rangeMaxSelect.value = defaultRange.max.toString();

                    } else {
                        console.error('‚ùå ÂàùÂßãÂåñÊó∂Êó†Ê≥ïÊâæÂà∞Èü≥ÂüüÈÄâÊã©Âô®');
                    }
                }, 100); // ÁªôDOM‰∏ÄÁÇπÊó∂Èó¥ÂÆåÂÖ®ÂàùÂßãÂåñ


                // Ê∑ªÂä†ÊµãËØïÂáΩÊï∞Âà∞ÂÖ®Â±Ä‰ΩúÁî®ÂüüÔºàË∞ÉËØïÁî®Ôºâ
                window.testClefRangeBinding = function() {
                    console.log('üß™ ÊµãËØïË∞±Âè∑-Èü≥ÂüüÁªëÂÆöÂäüËÉΩ');
                    const settings = window.intervalSettings;

                    console.log('üß™ ÊµãËØï1: ÂàáÊç¢Âà∞‰ΩéÈü≥Ë∞±Âè∑');
                    document.getElementById('clef-bass').checked = true;
                    document.getElementById('clef-treble').checked = false;
                    settings.updateRangeUIForClef('bass');

                    setTimeout(() => {
                        console.log('üß™ ÊµãËØï2: ÂàáÊç¢Âà∞È´òÈü≥Ë∞±Âè∑');
                        document.getElementById('clef-treble').checked = true;
                        document.getElementById('clef-bass').checked = false;
                        settings.updateRangeUIForClef('treble');
                    }, 2000);
                };

                // Ê∑ªÂä†ÈöèÊú∫ÈÄâÊã©ÊµãËØïÂáΩÊï∞
                window.testRandomClefSelection = function() {
                    console.log('üß™ ÊµãËØïÈöèÊú∫Ë∞±Âè∑ÈÄâÊã©ÂäüËÉΩ');
                    const settings = window.intervalSettings;

                    // ÂãæÈÄâÂ§ö‰∏™Ë∞±Âè∑
                    document.getElementById('clef-treble').checked = true;
                    document.getElementById('clef-bass').checked = true;
                    document.getElementById('clef-alto').checked = true;

                    console.log('üß™ Â∑≤ÂãæÈÄâÊâÄÊúâË∞±Âè∑ÔºåÂºÄÂßãÂ§öÊ¨°Ë∞ÉÁî®getCurrentSettings()');

                    // Â§öÊ¨°Ë∞ÉÁî®getCurrentSettings()Êù•Ê®°ÊãüÁîüÊàêÈü≥Á®ã
                    for (let i = 0; i < 5; i++) {
                        setTimeout(() => {
                            console.log(`üß™ Á¨¨${i + 1}Ê¨°Ë∞ÉÁî®getCurrentSettings()`);
                            const currentSettings = settings.getCurrentSettings();
                            console.log(`üß™ Êú¨Ê¨°ÈÄâ‰∏≠ÁöÑË∞±Âè∑: ${currentSettings.clef}`);
                        }, i * 1000);
                    }
                };

                // üéµ Ê∑ªÂä†Á¥ßÊÄ•Êí≠ÊîæÊµãËØïÂäüËÉΩ
                window.emergencyPlayTest = function() {

                    // ÂàõÂª∫‰∏Ä‰∏™ÁÆÄÂçïÁöÑÊµãËØïÈü≥Á®ãÊï∞ÊçÆ
                    const testProgression = {
                        measures: [
                            {
                                index: 0,
                                lowerVoice: [
                                    { type: 'note', pitch: 'C4', duration: 1.0 }
                                ],
                                upperVoice: [
                                    { type: 'note', pitch: 'E4', duration: 1.0 }
                                ]
                            }
                        ],
                        tempo: 120,
                        timeSignature: { beats: 4, beatType: 4 },
                        keySignature: 'C'
                    };

                    window.currentIntervalProgression = testProgression;

                    try {
                        directPlayTest();
                    } catch (error) {
                        console.error('üéµüö® Êí≠ÊîæÊµãËØïÂ§±Ë¥•:', error);
                    }
                };

                // üé≠ Ê∑ªÂä†ÈöêËóèÊ®°ÂºèÊµãËØïÂäüËÉΩ
                window.testHiddenModeWithCountIn = function() {

                    // ÂºÄÂêØÈöêËóèÊ®°Âºè
                    if (!isIntervalHidden) {
                        toggleIntervalVisibility();
                    }

                    // ÂàõÂª∫ÊµãËØïÊï∞ÊçÆ
                    const testProgression = {
                        measures: [
                            {
                                index: 0,
                                lowerVoice: [
                                    { type: 'note', pitch: 'C4', duration: 1.0 }
                                ],
                                upperVoice: [
                                    { type: 'note', pitch: 'E4', duration: 1.0 }
                                ]
                            }
                        ],
                        tempo: 120,
                        timeSignature: { beats: 4, beatType: 4 },
                        keySignature: 'C'
                    };

                    window.currentIntervalProgression = testProgression;

                    directPlayTest();
                };
            }

            // ÂàùÂßãÂåñÁªëÂÆöÁ≥ªÁªü
            initClefRangeBinding();
        });
        
        // ÂàùÂßãÂåñ‰∏ªÈ¢ò
        function initializeTheme() {
            switchTheme(currentTheme);
        }
        
        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ‰∏ªÈ¢ò
        document.addEventListener('DOMContentLoaded', function() {
            initializeTheme();
        });
    </script>

    <!-- Â§öËØ≠Ë®ÄÁ≥ªÁªü -->
    <script>
        // Â§öËØ≠Ë®ÄÁøªËØëÂØπË±°
        const translations = {
            'zh-CN': {
                'app.title': 'IC Studio - Èü≥Á®ãËßÜÂ•èÁîüÊàêÂô®',
                'app.subtitle': '‰∏ì‰∏öÁ∫ß‰πêË∞±Ê∏≤Êüì‰∏éÈü≥‰πêÁêÜËÆ∫Â∑•ÂÖ∑',
                'app.melodyMode': 'ÊóãÂæãËßÜÂ•è',
                'app.intervalMode': 'Èü≥Á®ãËßÜÂ•è',
                'app.chordMode': 'ÂíåÂº¶ËßÜÂ•è',
                'controls.intervalType': 'Èü≥Á®ãÁ±ªÂûã',
                'controls.intervalTypeSettings': 'Èü≥Á®ãÁ±ªÂûãËÆæÁΩÆ',
                'controls.measures': 'Â∞èËäÇÊï∞',
                'controls.measures2': '2Â∞èËäÇ',
                'controls.measures4': '4Â∞èËäÇ',
                'controls.measures8': '8Â∞èËäÇ',
                'controls.key': 'Ë∞ÉÂè∑',
                'controls.keySettings': 'Ë∞ÉÂè∑ËÆæÁΩÆ',
                'controls.time': 'ÊãçÂè∑',
                'controls.timeSettings': 'ÊãçÂè∑ËÆæÁΩÆ',
                'controls.clef': 'Ë∞±Âè∑',
                'controls.clefSettings': 'Ë∞±Âè∑ËÆæÁΩÆ',
                'modal.clefSettings': 'Ë∞±Âè∑ËÆæÁΩÆ',
                'clef.options': 'Ë∞±Âè∑ÈÄâÈ°π',
                'clef.treble': 'È´òÈü≥Ë∞±Âè∑ (GË∞±Âè∑)',
                'clef.bass': '‰ΩéÈü≥Ë∞±Âè∑ (FË∞±Âè∑)',
                'clef.alto': '‰∏≠Èü≥Ë∞±Âè∑ (CË∞±Âè∑)',
                'key.majorSection': 'Â§ßË∞É (Major)',
                'key.minorSection': 'Â∞èË∞É (Minor)',
                'controls.rangeMin': 'ÊúÄ‰ΩéÈü≥',
                'controls.rangeMax': 'ÊúÄÈ´òÈü≥',
                'controls.accidental': '‰∏¥Êó∂ËÆ∞Âè∑',
                'controls.metronome': 'ËäÇÊãçÂô®',
                'controls.generateInterval': 'ÁîüÊàêÈü≥Á®ã',
                'controls.previous': '‰∏ä‰∏ÄÊù°',
                'controls.next': '‰∏ã‰∏ÄÊù°',
                'controls.rhythm': 'ËäÇÂ•èËÆæÁΩÆ',
                'controls.articulation': 'ÊºîÂ•èÊäÄÂ∑ß',
                'controls.play': 'Êí≠Êîæ',
                'score.emptyInterval': 'ÁÇπÂáªÁîüÊàêÈü≥Á®ãÂºÄÂßãÁªÉ‰π†',
                'settings.title': 'ËÆæÁΩÆ',
                'settings.theme': '‰∏ªÈ¢ò',
                'settings.language': 'ËØ≠Ë®Ä',
                'settings.lightMode': 'ÊµÖËâ≤Ê®°Âºè',
                'settings.darkMode': 'Ê∑±Ëâ≤Ê®°Âºè',
                'settings.metronome': 'ËäÇÊãçÂô®',
                'settings.tempo': 'ÈÄüÂ∫¶ (BPM)',
                'settings.startMetronome': 'ÂºÄÂßãËäÇÊãçÂô®',
                'settings.stopMetronome': 'ÂÅúÊ≠¢ËäÇÊãçÂô®',
                // Ë∞ÉÂè∑ÔºàÂê´ÂçáÈôçÂè∑Êï∞ÈáèÔºâ
                'key.C-major': 'C Â§ßË∞É (0#)',
                'key.G-major': 'G Â§ßË∞É (1#)',
                'key.D-major': 'D Â§ßË∞É (2#)',
                'key.A-major': 'A Â§ßË∞É (3#)',
                'key.E-major': 'E Â§ßË∞É (4#)',
                'key.B-major': 'B Â§ßË∞É (5#)',
                'key.Fs-major': 'F# Â§ßË∞É (6#)',
                'key.F-major': 'F Â§ßË∞É (1b)',
                'key.Bb-major': 'Bb Â§ßË∞É (2b)',
                'key.Eb-major': 'Eb Â§ßË∞É (3b)',
                'key.Ab-major': 'Ab Â§ßË∞É (4b)',
                'key.Db-major': 'Db Â§ßË∞É (5b)',
                'key.Gb-major': 'Gb Â§ßË∞É (6b)',
                'key.a-minor': 'A Â∞èË∞É (0#)',
                'key.e-minor': 'E Â∞èË∞É (1#)',
                'key.b-minor': 'B Â∞èË∞É (2#)',
                'key.fs-minor': 'F# Â∞èË∞É (3#)',
                'key.cs-minor': 'C# Â∞èË∞É (4#)',
                'key.gs-minor': 'G# Â∞èË∞É (5#)',
                'key.ds-minor': 'D# Â∞èË∞É (6#)',
                'key.d-minor': 'D Â∞èË∞É (1b)',
                'key.g-minor': 'G Â∞èË∞É (2b)',
                'key.c-minor': 'C Â∞èË∞É (3b)',
                'key.f-minor': 'F Â∞èË∞É (4b)',
                'key.bb-minor': 'Bb Â∞èË∞É (5b)',
                'key.eb-minor': 'Eb Â∞èË∞É (6b)',
                // ËäÇÂ•èÁ±ªÂûã
                'rhythm.whole': 'ÂÖ®Èü≥Á¨¶',
                'rhythm.dottedHalf': 'ÈôÑÁÇπ‰∫åÂàÜÈü≥Á¨¶',
                'rhythm.half': '‰∫åÂàÜÈü≥Á¨¶',
                'rhythm.dottedQuarter': 'ÈôÑÁÇπÂõõÂàÜÈü≥Á¨¶',
                'rhythm.quarter': 'ÂõõÂàÜÈü≥Á¨¶',
                'rhythm.eighth': 'ÂÖ´ÂàÜÈü≥Á¨¶',
                'rhythm.sixteenth': 'ÂçÅÂÖ≠ÂàÜÈü≥Á¨¶',
                'rhythm.triplet': '‰∏âËøûÈü≥',
                'rhythm.duplet': '‰∫åËøûÈü≥',
                'rhythm.quadruplet': 'ÂõõËøûÈü≥',
                // ÂºπÁ™óÊåâÈíÆ
                'button.save': '‰øùÂ≠òËÆæÁΩÆ',
                'button.cancel': 'ÂèñÊ∂à',
                'button.close': 'ÂÖ≥Èó≠',
                'button.selectAll': 'ÂÖ®ÈÄâ',
                'button.selectAllMajor': 'ÂÖ®ÈÄâ',
                'button.selectAllMinor': 'ÂÖ®ÈÄâ',
                'button.advanced': 'È´òÁ∫ßËÆæÁΩÆ',
                'button.hideAdvanced': 'ÈöêËóèÈ´òÁ∫ßËÆæÁΩÆ',
                'button.resetDefault': 'ËøîÂõûÈªòËÆ§',
                'rhythm.advancedFreq': 'È´òÁ∫ßÈ¢ëÁéáËÆæÁΩÆ',
                'interval.basicTypes': 'Âü∫Êú¨Èü≥Á®ãÁ±ªÂûã',
                'rhythm.basicUnits': 'Âü∫Êú¨ËäÇÂ•èÂçï‰Ωç',
                'rhythm.freq.dottedQuarter': 'ÈôÑÁÇπÂõõÂàÜÈü≥Á¨¶È¢ëÁéá:',
                'rhythm.freq.quarter': 'ÂõõÂàÜÈü≥Á¨¶È¢ëÁéá:',
                'rhythm.freq.eighth': 'ÂÖ´ÂàÜÈü≥Á¨¶È¢ëÁéá:',
                'rhythm.freq.sixteenth': 'ÂçÅÂÖ≠ÂàÜÈü≥Á¨¶È¢ëÁéá:',
                'articulation.basic.title': 'Âü∫Êú¨ÊºîÂ•èÊ≥ï (Basic Articulations)',
                'articulation.freqDesc': 'Ë∞ÉÊï¥ÂêÑÊºîÂ•èÊ≥ïÂú®ÊóãÂæã‰∏≠ÁöÑÂá∫Áé∞È¢ëÁéá (0% = ‰∏ç‰ΩøÁî®, 100% = ÁªèÂ∏∏‰ΩøÁî®)',
                'articulation.basicFreq': 'Âü∫Êú¨ÊºîÂ•èÊ≥ïÈ¢ëÁéá',
                'rhythm.freqDesc': 'Ë∞ÉÊï¥ÂêÑËäÇÂ•èÂçï‰ΩçÂú®ÊóãÂæã‰∏≠ÁöÑÂá∫Áé∞È¢ëÁéá (0% = ‰∏ç‰ΩøÁî®, 100% = ‰ºòÂÖà‰ΩøÁî®)',
                'rhythm.freq.whole': 'ÂÖ®Èü≥Á¨¶È¢ëÁéá:',
                'rhythm.freq.dottedHalf': 'ÈôÑÁÇπ‰∫åÂàÜÈü≥Á¨¶È¢ëÁéá:',
                'rhythm.freq.half': '‰∫åÂàÜÈü≥Á¨¶È¢ëÁéá:',
                'rhythm.freq.triplet': '‰∏âËøûÈü≥È¢ëÁéá:',
                'rhythm.freq.duplet': '‰∫åËøûÈü≥È¢ëÁéá:',
                // Interval types in type settings
                'intervalType.minor2nd': 'Â∞è‰∫åÂ∫¶',
                'intervalType.major2nd': 'Â§ß‰∫åÂ∫¶',
                'intervalType.minor3rd': 'Â∞è‰∏âÂ∫¶',
                'intervalType.major3rd': 'Â§ß‰∏âÂ∫¶',
                'intervalType.perfect4th': 'ÂÆåÂÖ®ÂõõÂ∫¶',
                'intervalType.tritone': 'Â¢ûÂõõ/Âáè‰∫îÂ∫¶',
                'intervalType.perfect5th': 'ÂÆåÂÖ®‰∫îÂ∫¶',
                'intervalType.minor6th': 'Â∞èÂÖ≠Â∫¶',
                'intervalType.major6th': 'Â§ßÂÖ≠Â∫¶',
                'intervalType.minor7th': 'Â∞è‰∏ÉÂ∫¶',
                'intervalType.major7th': 'Â§ß‰∏ÉÂ∫¶',
                'intervalType.octave': 'ÂÖ´Â∫¶',
                'modal.timeSignature.title': 'ÊãçÂè∑ËÆæÁΩÆ',
                'timeSignature.options': 'ÊãçÂè∑ÈÄâÈ°π',
                'time.2-4': '2/4 Êãç',
                'time.3-4': '3/4 Êãç',
                'time.4-4': '4/4 Êãç',
                'time.6-8': '6/8 Êãç'
            },
            'zh-TW': {
                'app.title': 'IC Studio - Èü≥Á®ãË¶ñÂ•èÁîüÊàêÂô®',
                'app.subtitle': 'Â∞àÊ•≠Á¥öÊ®ÇË≠úÊ∏≤ÊüìËàáÈü≥Ê®ÇÁêÜË´ñÂ∑•ÂÖ∑',
                'app.melodyMode': 'ÊóãÂæãË¶ñÂ•è',
                'app.intervalMode': 'Èü≥Á®ãË¶ñÂ•è',
                'app.chordMode': 'ÂíåÂº¶Ë¶ñÂ•è',
                'controls.intervalType': 'Èü≥Á®ãÈ°ûÂûã',
                'controls.intervalTypeSettings': 'Èü≥Á®ãÈ°ûÂûãË®≠ÁΩÆ',
                'controls.measures': 'Â∞èÁØÄÊï∏',
                'controls.measures2': '2Â∞èÁØÄ',
                'controls.measures4': '4Â∞èÁØÄ',
                'controls.measures8': '8Â∞èÁØÄ',
                'controls.key': 'Ë™øËôü',
                'controls.keySettings': 'Ë™øËôüË®≠ÁΩÆ',
                'controls.time': 'ÊãçËôü',
                'controls.timeSettings': 'ÊãçËôüË®≠ÁΩÆ',
                'controls.clef': 'Ë≠úËôü',
                'controls.clefSettings': 'Ë≠úËôüË®≠ÁΩÆ',
                'modal.clefSettings': 'Ë≠úËôüË®≠ÁΩÆ',
                'clef.options': 'Ë≠úËôüÈÅ∏È†Ö',
                'clef.treble': 'È´òÈü≥Ë≠úËôü (GË≠úËôü)',
                'clef.bass': '‰ΩéÈü≥Ë≠úËôü (FË≠úËôü)',
                'clef.alto': '‰∏≠Èü≥Ë≠úËôü (CË≠úËôü)',
                'key.majorSection': 'Â§ßË™ø (Major)',
                'key.minorSection': 'Â∞èË™ø (Minor)',
                'controls.rangeMin': 'ÊúÄ‰ΩéÈü≥',
                'controls.rangeMax': 'ÊúÄÈ´òÈü≥',
                'controls.accidental': 'Ëá®ÊôÇË®òËôü',
                'controls.metronome': 'ÁØÄÊãçÂô®',
                'controls.generateInterval': 'ÁîüÊàêÈü≥Á®ã',
                'controls.previous': '‰∏ä‰∏ÄÊ¢ù',
                'controls.next': '‰∏ã‰∏ÄÊ¢ù',
                'controls.rhythm': 'ÁØÄÂ•èË®≠ÁΩÆ',
                'controls.articulation': 'ÊºîÂ•èÊäÄÂ∑ß',
                'controls.play': 'Êí≠Êîæ',
                'score.emptyInterval': 'ÈªûÊìäÁîüÊàêÈü≥Á®ãÈñãÂßãÁ∑¥Áøí',
                'settings.title': 'Ë®≠ÁΩÆ',
                'settings.theme': '‰∏ªÈ°å',
                'settings.language': 'Ë™ûË®Ä',
                'settings.lightMode': 'Ê∑∫Ëâ≤Ê®°Âºè',
                'settings.darkMode': 'Ê∑±Ëâ≤Ê®°Âºè',
                'settings.metronome': 'ÁØÄÊãçÂô®',
                'settings.tempo': 'ÈÄüÂ∫¶ (BPM)',
                'settings.startMetronome': 'ÈñãÂßãÁØÄÊãçÂô®',
                'settings.stopMetronome': 'ÂÅúÊ≠¢ÁØÄÊãçÂô®',
                // Ë™øËôüÔºàÂê´ÂçáÈôçËôüÊï∏ÈáèÔºâ
                'key.C-major': 'C Â§ßË™ø (0#)',
                'key.G-major': 'G Â§ßË™ø (1#)',
                'key.D-major': 'D Â§ßË™ø (2#)',
                'key.A-major': 'A Â§ßË™ø (3#)',
                'key.E-major': 'E Â§ßË™ø (4#)',
                'key.B-major': 'B Â§ßË™ø (5#)',
                'key.Fs-major': 'F# Â§ßË™ø (6#)',
                'key.F-major': 'F Â§ßË™ø (1b)',
                'key.Bb-major': 'Bb Â§ßË™ø (2b)',
                'key.Eb-major': 'Eb Â§ßË™ø (3b)',
                'key.Ab-major': 'Ab Â§ßË™ø (4b)',
                'key.Db-major': 'Db Â§ßË™ø (5b)',
                'key.Gb-major': 'Gb Â§ßË™ø (6b)',
                'key.a-minor': 'A Â∞èË™ø (0#)',
                'key.e-minor': 'E Â∞èË™ø (1#)',
                'key.b-minor': 'B Â∞èË™ø (2#)',
                'key.fs-minor': 'F# Â∞èË™ø (3#)',
                'key.cs-minor': 'C# Â∞èË™ø (4#)',
                'key.gs-minor': 'G# Â∞èË™ø (5#)',
                'key.ds-minor': 'D# Â∞èË™ø (6#)',
                'key.d-minor': 'D Â∞èË™ø (1b)',
                'key.g-minor': 'G Â∞èË™ø (2b)',
                'key.c-minor': 'C Â∞èË™ø (3b)',
                'key.f-minor': 'F Â∞èË™ø (4b)',
                'key.bb-minor': 'Bb Â∞èË™ø (5b)',
                'key.eb-minor': 'Eb Â∞èË™ø (6b)',
                // ÁØÄÂ•èÈ°ûÂûã
                'rhythm.whole': 'ÂÖ®Èü≥Á¨¶',
                'rhythm.dottedHalf': 'ÈôÑÈªû‰∫åÂàÜÈü≥Á¨¶',
                'rhythm.half': '‰∫åÂàÜÈü≥Á¨¶',
                'rhythm.dottedQuarter': 'ÈôÑÈªûÂõõÂàÜÈü≥Á¨¶',
                'rhythm.quarter': 'ÂõõÂàÜÈü≥Á¨¶',
                'rhythm.eighth': 'ÂÖ´ÂàÜÈü≥Á¨¶',
                'rhythm.sixteenth': 'ÂçÅÂÖ≠ÂàÜÈü≥Á¨¶',
                'rhythm.triplet': '‰∏âÈÄ£Èü≥',
                'rhythm.duplet': '‰∫åÈÄ£Èü≥',
                'rhythm.quadruplet': 'ÂõõÈÄ£Èü≥',
                // ÂΩàÁ™óÊåâÈàï
                'button.save': '‰øùÂ≠òË®≠ÁΩÆ',
                'button.cancel': 'ÂèñÊ∂à',
                'button.close': 'ÈóúÈñâ',
                'button.selectAll': 'ÂÖ®ÈÅ∏',
                'button.selectAllMajor': 'ÂÖ®ÈÅ∏Â§ßË™ø',
                'button.selectAllMinor': 'ÂÖ®ÈÅ∏Â∞èË™ø',
                'button.advanced': 'È´òÁ¥öË®≠ÁΩÆ',
                'button.hideAdvanced': 'Èö±ËóèÈ´òÁ¥öË®≠ÁΩÆ',
                'button.resetDefault': 'ËøîÂõûÈªòË™ç',
                'rhythm.advancedFreq': 'È´òÁ¥öÈ†ªÁéáË®≠ÁΩÆ',
                'interval.basicTypes': 'Âü∫Êú¨Èü≥Á®ãÈ°ûÂûã',
                'rhythm.basicUnits': 'Âü∫Êú¨ÁØÄÂ•èÂñÆ‰Ωç',
                'rhythm.freq.dottedQuarter': 'ÈôÑÈªûÂõõÂàÜÈü≥Á¨¶È†ªÁéá:',
                'rhythm.freq.quarter': 'ÂõõÂàÜÈü≥Á¨¶È†ªÁéá:',
                'rhythm.freq.eighth': 'ÂÖ´ÂàÜÈü≥Á¨¶È†ªÁéá:',
                'rhythm.freq.sixteenth': 'ÂçÅÂÖ≠ÂàÜÈü≥Á¨¶È†ªÁéá:',
                'articulation.basic.title': 'Âü∫Êú¨ÊºîÂ•èÊ≥ï (Basic Articulations)',
                'articulation.freqDesc': 'Ë™øÊï¥ÂêÑÊºîÂ•èÊ≥ïÂú®ÊóãÂæã‰∏≠ÁöÑÂá∫ÁèæÈ†ªÁéá (0% = ‰∏ç‰ΩøÁî®, 100% = Á∂ìÂ∏∏‰ΩøÁî®)',
                'articulation.basicFreq': 'Âü∫Êú¨ÊºîÂ•èÊ≥ïÈ†ªÁéá',
                'rhythm.freqDesc': 'Ë™øÊï¥ÂêÑÁØÄÂ•èÂñÆ‰ΩçÂú®ÊóãÂæã‰∏≠ÁöÑÂá∫ÁèæÈ†ªÁéá (0% = ‰∏ç‰ΩøÁî®, 100% = ÂÑ™ÂÖà‰ΩøÁî®)',
                'rhythm.freq.whole': 'ÂÖ®Èü≥Á¨¶È†ªÁéá:',
                'rhythm.freq.dottedHalf': 'ÈôÑÈªû‰∫åÂàÜÈü≥Á¨¶È†ªÁéá:',
                'rhythm.freq.half': '‰∫åÂàÜÈü≥Á¨¶È†ªÁéá:',
                'rhythm.freq.triplet': '‰∏âÈÄ£Èü≥È†ªÁéá:',
                'rhythm.freq.duplet': '‰∫åÈÄ£Èü≥È†ªÁéá:',
                // Interval types in type settings
                'intervalType.minor2nd': 'Â∞è‰∫åÂ∫¶',
                'intervalType.major2nd': 'Â§ß‰∫åÂ∫¶',
                'intervalType.minor3rd': 'Â∞è‰∏âÂ∫¶',
                'intervalType.major3rd': 'Â§ß‰∏âÂ∫¶',
                'intervalType.perfect4th': 'ÂÆåÂÖ®ÂõõÂ∫¶',
                'intervalType.tritone': 'Â¢ûÂõõ/Ê∏õ‰∫îÂ∫¶',
                'intervalType.perfect5th': 'ÂÆåÂÖ®‰∫îÂ∫¶',
                'intervalType.minor6th': 'Â∞èÂÖ≠Â∫¶',
                'intervalType.major6th': 'Â§ßÂÖ≠Â∫¶',
                'intervalType.minor7th': 'Â∞è‰∏ÉÂ∫¶',
                'intervalType.major7th': 'Â§ß‰∏ÉÂ∫¶',
                'intervalType.octave': 'ÂÖ´Â∫¶',
                'modal.timeSignature.title': 'ÊãçËôüË®≠ÁΩÆ',
                'timeSignature.options': 'ÊãçËôüÈÅ∏È†Ö',
                'time.2-4': '2/4 Êãç',
                'time.3-4': '3/4 Êãç',
                'time.4-4': '4/4 Êãç',
                'time.6-8': '6/8 Êãç'
            },
            'en': {
                'app.title': 'IC Studio - Interval Sight-Reading Generator',
                'app.subtitle': 'Professional Music Score Rendering & Music Theory Tool',
                'app.melodyMode': 'Melody Sight-Reading',
                'app.intervalMode': 'Interval Sight-Reading',
                'app.chordMode': 'Chord Sight-Reading',
                'controls.intervalType': 'Interval Type',
                'controls.intervalTypeSettings': 'Interval Type Settings',
                'controls.measures': 'Measures',
                'controls.measures2': '2 Measures',
                'controls.measures4': '4 Measures',
                'controls.measures8': '8 Measures',
                'controls.key': 'Key Signature',
                'controls.keySettings': 'Key Settings',
                'controls.time': 'Time Signature',
                'controls.timeSettings': 'Time Settings',
                'controls.clef': 'Clef',
                'controls.clefSettings': 'Clef Settings',
                'modal.clefSettings': 'Clef Settings',
                'clef.options': 'Clef Options',
                'clef.treble': 'Treble Clef (G Clef)',
                'clef.bass': 'Bass Clef (F Clef)',
                'clef.alto': 'Alto Clef (C Clef)',
                'key.majorSection': 'Major Keys',
                'key.minorSection': 'Minor Keys',
                'controls.rangeMin': 'Lowest Note',
                'controls.rangeMax': 'Highest Note',
                'controls.accidental': 'Accidentals',
                'controls.metronome': 'Metronome',
                'controls.generateInterval': 'Generate Intervals',
                'controls.previous': 'Previous',
                'controls.next': 'Next',
                'controls.rhythm': 'Rhythm Settings',
                'controls.articulation': 'Articulations',
                'controls.play': 'Play',
                'score.emptyInterval': 'Click Generate Intervals to Start Practice',
                'settings.title': 'Settings',
                'settings.theme': 'Theme',
                'settings.language': 'Language',
                'settings.lightMode': 'Light Mode',
                'settings.darkMode': 'Dark Mode',
                'settings.metronome': 'Metronome',
                'settings.tempo': 'Tempo (BPM)',
                'settings.startMetronome': 'Start Metronome',
                'settings.stopMetronome': 'Stop Metronome',
                // Key signatures (with accidental counts)
                'key.C-major': 'C Major (0#)',
                'key.G-major': 'G Major (1#)',
                'key.D-major': 'D Major (2#)',
                'key.A-major': 'A Major (3#)',
                'key.E-major': 'E Major (4#)',
                'key.B-major': 'B Major (5#)',
                'key.Fs-major': 'F# Major (6#)',
                'key.F-major': 'F Major (1b)',
                'key.Bb-major': 'B‚ô≠ Major (2b)',
                'key.Eb-major': 'E‚ô≠ Major (3b)',
                'key.Ab-major': 'A‚ô≠ Major (4b)',
                'key.Db-major': 'D‚ô≠ Major (5b)',
                'key.Gb-major': 'G‚ô≠ Major (6b)',
                'key.a-minor': 'A Minor (0#)',
                'key.e-minor': 'E Minor (1#)',
                'key.b-minor': 'B Minor (2#)',
                'key.fs-minor': 'F# Minor (3#)',
                'key.cs-minor': 'C# Minor (4#)',
                'key.gs-minor': 'G# Minor (5#)',
                'key.ds-minor': 'D# Minor (6#)',
                'key.d-minor': 'D Minor (1b)',
                'key.g-minor': 'G Minor (2b)',
                'key.c-minor': 'C Minor (3b)',
                'key.f-minor': 'F Minor (4b)',
                'key.bb-minor': 'B‚ô≠ Minor (5b)',
                'key.eb-minor': 'E‚ô≠ Minor (6b)',
                // Rhythm types
                'rhythm.whole': 'Whole Note',
                'rhythm.dottedHalf': 'Dotted Half Note',
                'rhythm.half': 'Half Note',
                'rhythm.dottedQuarter': 'Dotted Quarter Note',
                'rhythm.quarter': 'Quarter Note',
                'rhythm.eighth': 'Eighth Note',
                'rhythm.sixteenth': 'Sixteenth Note',
                'rhythm.triplet': 'Triplet',
                'rhythm.duplet': 'Duplet',
                'rhythm.quadruplet': 'Quadruplet',
                // Modal buttons
                'button.save': 'Save Settings',
                'button.cancel': 'Cancel',
                'button.close': 'Close',
                'button.selectAll': 'Select All',
                'button.selectAllMajor': 'Select All Major',
                'button.selectAllMinor': 'Select All Minor',
                'button.advanced': 'Advanced Settings',
                'button.hideAdvanced': 'Hide Advanced Settings',
                'button.resetDefault': 'Reset to Default',
                'rhythm.advancedFreq': 'Advanced Frequency Settings',
                'interval.basicTypes': 'Basic Interval Types',
                'rhythm.basicUnits': 'Basic Rhythm Units',
                'rhythm.freq.dottedQuarter': 'Dotted Quarter Note Frequency:',
                'rhythm.freq.quarter': 'Quarter Note Frequency:',
                'rhythm.freq.eighth': 'Eighth Note Frequency:',
                'rhythm.freq.sixteenth': 'Sixteenth Note Frequency:',
                'articulation.basic.title': 'Basic Articulations',
                'articulation.freqDesc': 'Adjust frequency of each articulation in melody (0% = not used, 100% = frequently used)',
                'articulation.basicFreq': 'Basic Articulation Frequency',
                'rhythm.freqDesc': 'Adjust frequency of each rhythm unit in melody (0% = not used, 100% = prioritized)',
                'rhythm.freq.whole': 'Whole Note Frequency:',
                'rhythm.freq.dottedHalf': 'Dotted Half Note Frequency:',
                'rhythm.freq.half': 'Half Note Frequency:',
                'rhythm.freq.triplet': 'Triplet Frequency:',
                'rhythm.freq.duplet': 'Duplet Frequency:',
                // Interval types in type settings
                'intervalType.minor2nd': 'Minor 2nd',
                'intervalType.major2nd': 'Major 2nd',
                'intervalType.minor3rd': 'Minor 3rd',
                'intervalType.major3rd': 'Major 3rd',
                'intervalType.perfect4th': 'Perfect 4th',
                'intervalType.tritone': 'Tritone (Aug 4th/Dim 5th)',
                'intervalType.perfect5th': 'Perfect 5th',
                'intervalType.minor6th': 'Minor 6th',
                'intervalType.major6th': 'Major 6th',
                'intervalType.minor7th': 'Minor 7th',
                'intervalType.major7th': 'Major 7th',
                'intervalType.octave': 'Octave',
                'modal.timeSignature.title': 'Time Signature Settings',
                'timeSignature.options': 'Time Signature Options',
                'time.2-4': '2/4 Time',
                'time.3-4': '3/4 Time',
                'time.4-4': '4/4 Time',
                'time.6-8': '6/8 Time'
            }
        };

        // ËØ≠Ë®ÄÂàáÊç¢Áõ∏ÂÖ≥ÂèòÈáè
        let currentLanguage = localStorage.getItem('preferredLanguage') || 'zh-CN';
        
        // ËØ≠Ë®ÄÊåâÈíÆÊòæÁ§∫ÊñáÊú¨
        const languageLabels = {
            'zh-CN': 'üåê ÁÆÄ‰Ωì‰∏≠Êñá',
            'zh-TW': 'üåê ÁπÅÈ´î‰∏≠Êñá',
            'en': 'üåê English'
        };

        // ÂàáÊç¢ËØ≠Ë®Ä
        function switchLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('preferredLanguage', lang);

            // Êõ¥Êñ∞ÊåâÈíÆÊñáÊú¨ (Â¶ÇÊûúÂ≠òÂú®ÊóßÁöÑËØ≠Ë®ÄÊåâÈíÆ)
            const languageBtn = document.getElementById('languageBtn');
            if (languageBtn) {
                languageBtn.textContent = languageLabels[lang];
            }

            // Â∫îÁî®ÁøªËØë
            applyTranslations();

            // Ëß¶ÂèëÁªü‰∏ÄÂêåÊ≠•Á≥ªÁªü (ÂêåÊ†áÁ≠æÈ°µÂÜÖÂÆûÊó∂ÂêåÊ≠•)
            if (window.ICStudioSync) {
                window.ICStudioSync.syncLanguage(lang, 'interval-tool');
            }

            // ÂÖ≥Èó≠ËÆæÁΩÆËèúÂçï
            closeSettings();
            
            console.log(`üåê ËØ≠Ë®ÄÂ∑≤ÂàáÊç¢Âà∞: ${lang}`);
        }

        // Â∫îÁî®ÁøªËØë
        function applyTranslations() {
            const elements = document.querySelectorAll('[data-i18n]');
            const currentTranslations = translations[currentLanguage] || translations['zh-CN'];

            elements.forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (currentTranslations[key]) {
                    // Ê£ÄÊü•ÂÖÉÁ¥†ÊòØÂê¶Âè™ÂåÖÂê´ÊñáÊú¨ÂÜÖÂÆπÔºàÊ≤°ÊúâÂ≠êÂÖÉÁ¥†Ôºâ
                    if (element.children.length === 0) {
                        // Âè™ÊúâÊñáÊú¨ÂÜÖÂÆπÔºåÁõ¥Êé•ÊõøÊç¢
                        element.textContent = currentTranslations[key];
                    } else {
                        // ÊúâÂ≠êÂÖÉÁ¥†ÔºåÈúÄË¶Å‰øùÁïôÁªìÊûÑÔºåÂè™ÊõøÊç¢ÊñáÊú¨ËäÇÁÇπ
                        // ÂÖà‰øùÂ≠òÂΩìÂâçÁöÑHTMLÁªìÊûÑ
                        const originalHTML = element.innerHTML;
                        // Êü•ÊâæÊñáÊú¨ËäÇÁÇπÂπ∂ÊõøÊç¢
                        const textNodes = [];
                        const walker = document.createTreeWalker(
                            element,
                            NodeFilter.SHOW_TEXT,
                            null,
                            false
                        );
                        let node;
                        while (node = walker.nextNode()) {
                            if (node.nodeValue.trim()) {
                                textNodes.push(node);
                            }
                        }

                        // Â¶ÇÊûúÂè™Êúâ‰∏Ä‰∏™‰∏ªË¶ÅÊñáÊú¨ËäÇÁÇπÔºåÊõøÊç¢ÂÆÉ
                        if (textNodes.length === 1) {
                            textNodes[0].nodeValue = currentTranslations[key];
                        } else {
                            // Â§çÊùÇÁªìÊûÑÔºå‰ΩøÁî®textContent‰Ωú‰∏∫ÂêéÂ§á
                            element.textContent = currentTranslations[key];
                        }
                    }
                }
            });
        }

        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñËØ≠Ë®Ä
        document.addEventListener('DOMContentLoaded', function() {
            // Ê£ÄÊü•ÊòØÂê¶Êúâ‰øùÂ≠òÁöÑËØ≠Ë®ÄÂÅèÂ•Ω
            const savedLanguage = localStorage.getItem('preferredLanguage');

            if (savedLanguage) {
                // Â¶ÇÊûúÊúâ‰øùÂ≠òÁöÑËØ≠Ë®ÄÂÅèÂ•ΩÔºåËÆæÁΩÆÂΩìÂâçËØ≠Ë®ÄÂπ∂ÊòæÁ§∫ÂØπÂ∫îËØ≠Ë®ÄÂêçÁß∞
                currentLanguage = savedLanguage;
                const languageBtn = document.getElementById('languageBtn');
                if (languageBtn) {
                    languageBtn.textContent = languageLabels[currentLanguage];
                }
            } else {
                // Â¶ÇÊûúÊ≤°Êúâ‰øùÂ≠òÁöÑËØ≠Ë®ÄÂÅèÂ•ΩÔºåÊòæÁ§∫ÈªòËÆ§ÁöÑ üåê Êñá/A
                const languageBtn = document.getElementById('languageBtn');
                if (languageBtn) {
                    languageBtn.textContent = 'üåê Êñá/A';
                }
            }

            // Â∫îÁî®ÁøªËØë
            applyTranslations();

            console.log(`üåê ÂàùÂßãÂåñËØ≠Ë®Ä: ${currentLanguage}`);

            // ============ Ë∑®Â∑•ÂÖ∑ÂêåÊ≠•ÁõëÂê¨Êú∫Âà∂ ============
            // ÁõëÂê¨ÂÖ∂‰ªñÂ∑•ÂÖ∑ÂØπlocalStorageÁöÑ‰øÆÊîπ
            window.addEventListener('storage', function(e) {
                if (e.key === 'preferredTheme' && e.newValue !== currentTheme) {
                    console.log(`üîÑ Èü≥Á®ãËßÜÂ•èÂ∑•ÂÖ∑Ê£ÄÊµãÂà∞‰∏ªÈ¢òÂèòÂåñ: ${currentTheme} ‚Üí ${e.newValue}`);
                    currentTheme = e.newValue;
                    document.documentElement.setAttribute('data-theme', currentTheme);
                }

                if (e.key === 'preferredLanguage' && e.newValue !== currentLanguage) {
                    console.log(`üîÑ Èü≥Á®ãËßÜÂ•èÂ∑•ÂÖ∑Ê£ÄÊµãÂà∞ËØ≠Ë®ÄÂèòÂåñ: ${currentLanguage} ‚Üí ${e.newValue}`);
                    currentLanguage = e.newValue;
                    applyTranslations();
                    console.log(`üåê Èü≥Á®ãËßÜÂ•èÂ∑•ÂÖ∑ËØ≠Ë®ÄÂ∑≤ÂêåÊ≠•‰∏∫: ${currentLanguage}`);
                }
            });

            console.log('üîó Èü≥Á®ãËßÜÂ•èÂ∑•ÂÖ∑localStorageË∑®Â∑•ÂÖ∑ÂêåÊ≠•ÁõëÂê¨Â∑≤ÂêØÁî®');

            // ============ Áªü‰∏ÄÂêåÊ≠•Á≥ªÁªü ============
            // ÂàõÂª∫ÂÖ®Â±ÄÂêåÊ≠•ÂáΩÊï∞ÔºåÊîØÊåÅÂêåÊ†áÁ≠æÈ°µÂÜÖÂÆûÊó∂ÂêåÊ≠•
            window.ICStudioSync = window.ICStudioSync || {
                tools: new Set(),

                // Ê≥®ÂÜåÂ∑•ÂÖ∑
                registerTool: function(toolName, callbacks) {
                    this.tools.add({
                        name: toolName,
                        onThemeChange: callbacks.onThemeChange,
                        onLanguageChange: callbacks.onLanguageChange
                    });
                    console.log(`üîó ${toolName} Â∑≤Ê≥®ÂÜåÂà∞Áªü‰∏ÄÂêåÊ≠•Á≥ªÁªü`);
                },

                // ÂêåÊ≠•‰∏ªÈ¢òÂà∞ÊâÄÊúâÂ∑•ÂÖ∑
                syncTheme: function(newTheme, fromTool) {
                    console.log(`üîÑ Áªü‰∏ÄÂêåÊ≠•Á≥ªÁªü: ÂêåÊ≠•‰∏ªÈ¢ò ${newTheme} (Êù•Ê∫ê: ${fromTool})`);
                    this.tools.forEach(tool => {
                        if (tool.name !== fromTool && tool.onThemeChange) {
                            try {
                                tool.onThemeChange(newTheme);
                            } catch (error) {
                                console.warn(`‚ö†Ô∏è ${tool.name} ‰∏ªÈ¢òÂêåÊ≠•Â§±Ë¥•:`, error);
                            }
                        }
                    });
                },

                // ÂêåÊ≠•ËØ≠Ë®ÄÂà∞ÊâÄÊúâÂ∑•ÂÖ∑
                syncLanguage: function(newLanguage, fromTool) {
                    console.log(`üîÑ Áªü‰∏ÄÂêåÊ≠•Á≥ªÁªü: ÂêåÊ≠•ËØ≠Ë®Ä ${newLanguage} (Êù•Ê∫ê: ${fromTool})`);
                    this.tools.forEach(tool => {
                        if (tool.name !== fromTool && tool.onLanguageChange) {
                            try {
                                tool.onLanguageChange(newLanguage);
                            } catch (error) {
                                console.warn(`‚ö†Ô∏è ${tool.name} ËØ≠Ë®ÄÂêåÊ≠•Â§±Ë¥•:`, error);
                            }
                        }
                    });
                }
            };

            // Ê≥®ÂÜåÈü≥Á®ãÂ∑•ÂÖ∑Âà∞Áªü‰∏ÄÂêåÊ≠•Á≥ªÁªü
            window.ICStudioSync.registerTool('interval-tool', {
                onThemeChange: function(newTheme) {
                    if (currentTheme !== newTheme) {
                        currentTheme = newTheme;
                        document.documentElement.setAttribute('data-theme', currentTheme);
                    }
                },
                onLanguageChange: function(newLanguage) {
                    if (currentLanguage !== newLanguage) {
                        console.log(`üåê Èü≥Á®ãÂ∑•ÂÖ∑Êé•Êî∂ËØ≠Ë®ÄÂêåÊ≠•: ${currentLanguage} ‚Üí ${newLanguage}`);
                        currentLanguage = newLanguage;
                        applyTranslations();
                    }
                }
            });
        });
    </script>

    <script>
        // ÂºπÁ™óÊéßÂà∂ÂáΩÊï∞
        
        // ËäÇÂ•èËÆæÁΩÆÂºπÁ™ó
        function openRhythmSettings() {
            document.getElementById('rhythmModal').style.display = 'flex';
        }
        
        function closeRhythmSettings() {
            document.getElementById('rhythmModal').style.display = 'none';
        }
        
        function selectAllRhythms() {
            // üî• Fix C: Âè™ÈÄâÊã©ÂèØËßÅÁöÑcheckboxÔºåÈÅøÂÖçÂãæÈÄâÈöêËóèÁöÑÈôÑÁÇπÈü≥Á¨¶ÈÄâÈ°π
            const checkboxes = document.querySelectorAll('#rhythmModal input[type="checkbox"]');

            // ËøáÊª§Âá∫ÂèØËßÅÁöÑcheckbox
            const visibleCheckboxes = Array.from(checkboxes).filter(cb => {
                const label = cb.closest('.checkbox-item') || cb.closest('label');
                if (!label) return true; // Â¶ÇÊûúÊ≤°ÊúâÁà∂labelÔºåÈªòËÆ§ËÆ§‰∏∫ÂèØËßÅ
                const styles = window.getComputedStyle(label);
                return styles.display !== 'none' && styles.visibility !== 'hidden';
            });

            const allChecked = visibleCheckboxes.every(cb => cb.checked);

            visibleCheckboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
            });

            console.log(`üîß ÂÖ®ÈÄâËäÇÂ•èÔºö${visibleCheckboxes.length}‰∏™ÂèØËßÅÈÄâÈ°πÔºå${allChecked ? 'ÂèñÊ∂àÂÖ®ÈÄâ' : 'ÂÖ®ÈÉ®ÈÄâ‰∏≠'}`);
        }
        
        function saveRhythmSettings() {
            // üéØ Êî∂ÈõÜÊâÄÊúâËäÇÂ•èËÆæÁΩÆÂíåÈ¢ëÁéáËÆæÁΩÆ
            const rhythmSettings = {};
            const frequencySettings = {};

            // Êî∂ÈõÜÂü∫Êú¨ËäÇÂ•èÂ§çÈÄâÊ°ÜËÆæÁΩÆ
            const rhythmCheckboxes = document.querySelectorAll('#rhythmModal input[type="checkbox"]');
            rhythmCheckboxes.forEach(checkbox => {
                if (checkbox.id && checkbox.id.startsWith('rhythm-')) {
                    rhythmSettings[checkbox.id] = checkbox.checked;
                }
            });

            // Êî∂ÈõÜÈ¢ëÁéáÊªëÂùóËÆæÁΩÆ
            const frequencySliders = document.querySelectorAll('input[type="range"][id^="freq-"]');
            frequencySliders.forEach(slider => {
                frequencySettings[slider.id] = parseInt(slider.value);
            });

            console.log('‚úÖ ËäÇÂ•èËÆæÁΩÆÂ∑≤‰øùÂ≠ò');

            closeRhythmSettings();
        }
        
        function toggleRhythmAdvancedSettings() {
            const advancedSection = document.getElementById('rhythmAdvancedSettings');
            const button = document.getElementById('rhythmAdvancedBtn');

            if (advancedSection.style.display === 'none' || !advancedSection.style.display) {
                advancedSection.style.display = 'block';
                button.textContent = translations[currentLanguage]['button.hideAdvanced'] || 'ÈöêËóèÈ´òÁ∫ßËÆæÁΩÆ';
            } else {
                advancedSection.style.display = 'none';
                button.textContent = translations[currentLanguage]['button.advanced'] || 'È´òÁ∫ßËÆæÁΩÆ';
            }
        }
        
        function resetRhythmFrequencies() {
            // ÈáçÁΩÆÊâÄÊúâÈ¢ëÁéáÊªëÂùóÂà∞ÈªòËÆ§ÂÄº
            const frequencies = {
                'freq-whole': 10,
                'freq-dotted-half': 15,
                'freq-half': 30,
                'freq-dotted-quarter': 35,
                'freq-quarter': 50,
                'freq-eighth': 40,
                'freq-16th': 20,
                'freq-triplet': 15,
                'freq-duplet': 30,
                'freq-quadruplet': 25
            };
            
            for (const [id, defaultValue] of Object.entries(frequencies)) {
                const slider = document.getElementById(id);
                const valueSpan = document.getElementById(id + '-value');
                
                if (slider && valueSpan) {
                    slider.value = defaultValue;
                    valueSpan.textContent = defaultValue + '%';
                }
            }
        }
        
        // ArticulationsËÆæÁΩÆÂºπÁ™ó
        function openArticulationSettings() {
            document.getElementById('articulationModal').style.display = 'flex';
        }
        
        function closeArticulationSettings() {
            document.getElementById('articulationModal').style.display = 'none';
        }
        
        function selectAllBasicArticulations() {
            const checkboxes = document.querySelectorAll('#articulationModal .rhythm-section:first-of-type input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
            });
        }
        
        function selectAllGuitarTechniques() {
            const checkboxes = document.querySelectorAll('#articulationModal .rhythm-section:nth-of-type(2) input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
            });
        }
        
        function saveArticulationSettings() {
            console.log('‰øùÂ≠òÊºîÂ•èÊäÄÂ∑ßËÆæÁΩÆ');
            closeArticulationSettings();
        }
        
        function toggleArticulationAdvancedSettings() {
            const advancedSection = document.getElementById('articulationAdvancedSettings');
            const button = document.getElementById('articulationAdvancedBtn');

            if (advancedSection.style.display === 'none' || !advancedSection.style.display) {
                advancedSection.style.display = 'block';
                button.textContent = translations[currentLanguage]['button.hideAdvanced'] || 'ÈöêËóèÈ´òÁ∫ßËÆæÁΩÆ';
            } else {
                advancedSection.style.display = 'none';
                button.textContent = translations[currentLanguage]['button.advanced'] || 'È´òÁ∫ßËÆæÁΩÆ';
            }
        }
        
        function resetArticulationFrequencies() {
            // ÈáçÁΩÆÊâÄÊúâÊºîÂ•èÊ≥ïÈ¢ëÁéáÂà∞ÈªòËÆ§ÂÄº
            const frequencies = {
                'freq-staccato': 20,
                'freq-accent': 15,
                'freq-acciaccatura': 10,
                'freq-slur': 15
            };
            
            for (const [id, defaultValue] of Object.entries(frequencies)) {
                const slider = document.getElementById(id);
                const valueSpan = document.getElementById(id + '-value');
                
                if (slider && valueSpan) {
                    slider.value = defaultValue;
                    valueSpan.textContent = defaultValue + '%';
                }
            }
        }
        
        // Ë∞ÉÂè∑ËÆæÁΩÆÂºπÁ™ó
        function openKeySettings() {
            document.getElementById('keySignatureModal').style.display = 'flex';
        }
        
        function closeKeySettings() {
            document.getElementById('keySignatureModal').style.display = 'none';
        }
        
        function selectAllMajorKeys() {
            const checkboxes = document.querySelectorAll('#keySignatureModal .rhythm-section:first-of-type input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
            });
        }
        
        function selectAllMinorKeys() {
            const checkboxes = document.querySelectorAll('#keySignatureModal .rhythm-section:nth-of-type(2) input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
            });
        }
        
        function saveKeySettings() {
            console.log('‰øùÂ≠òË∞ÉÂè∑ËÆæÁΩÆ');
            closeKeySettings();
        }
        
        // ÊãçÂè∑ËÆæÁΩÆÂºπÁ™ó
        function openTimeSignatureSettings() {
            document.getElementById('timeSignatureModal').style.display = 'flex';
        }
        
        function closeTimeSignatureSettings() {
            document.getElementById('timeSignatureModal').style.display = 'none';
        }
        
        function selectAllTimeSignatures() {
            const checkboxes = document.querySelectorAll('#timeSignatureModal input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
            });
        }
        
        function saveTimeSignatureSettings() {
            console.log('‰øùÂ≠òÊãçÂè∑ËÆæÁΩÆ');
            updateRhythmVisibilityForTimeSignature();
            closeTimeSignatureSettings();
        }

        // üéØ Ê†πÊçÆÊãçÂè∑Âä®ÊÄÅÊéßÂà∂ËäÇÂ•èÈÄâÈ°πÂèØËßÅÊÄß
        function updateRhythmVisibilityForTimeSignature() {

            // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑÊãçÂè∑
            const timeSignatureCheckboxes = document.querySelectorAll('#timeSignatureModal input[type="checkbox"]:checked');
            const selectedTimeSignatures = Array.from(timeSignatureCheckboxes).map(cb => cb.value);


            // Ê£ÄÊü•ÈÄâÊã©ÁöÑÊãçÂè∑ÈõÜÂêà
            const has68TimeSignature = selectedTimeSignatures.includes('6/8');
            const hasSimpleTimeSignature = selectedTimeSignatures.some(v => ['2/4','3/4','4/4'].includes(v));

            // ËäÇÂ•èÈÄâÈ°πÂÖÉÁ¥†
            const rhythmWholeLabel = document.getElementById('rhythm-whole-label');
            const rhythmHalfLabel = document.getElementById('rhythm-half-label');
            const rhythmDottedHalfLabel = document.getElementById('rhythm-dotted-half-label');
            const rhythmDottedQuarterLabel = document.getElementById('rhythm-dotted-quarter-label');
            const rhythmTripletLabel = document.getElementById('rhythm-triplet-label');
            const rhythmDupletLabel = document.getElementById('rhythm-duplet-label');
            const rhythmQuadrupletLabel = document.getElementById('rhythm-quadruplet-label');

            // ÂØπÂ∫îÁöÑÈ¢ëÁéáÊéßÂà∂ÂÖÉÁ¥†
            const freqWholeItem = document.getElementById('freq-whole-item');
            const freqHalfItem = document.getElementById('freq-half-item');
            const freqDottedHalfItem = document.getElementById('freq-dotted-half-item');
            const freqDottedQuarterItem = document.getElementById('freq-dotted-quarter-item');
            const freqTripletItem = document.getElementById('freq-triplet-item');
            const freqDupletItem = document.getElementById('freq-duplet-item');
            const freqQuadrupletItem = document.getElementById('freq-quadruplet-item');

            if (has68TimeSignature && hasSimpleTimeSignature) {

                // ÁÆÄÂçïÊãçÔºöÊòæÁ§∫ÂÖ®Èü≥Á¨¶/‰∫åÂàÜÈü≥Á¨¶ + ‰∏âËøûÈü≥
                if (rhythmWholeLabel) rhythmWholeLabel.style.display = 'block';
                if (rhythmHalfLabel) rhythmHalfLabel.style.display = 'block';
                if (freqWholeItem) freqWholeItem.style.display = 'block';
                if (freqHalfItem) freqHalfItem.style.display = 'block';
                if (rhythmTripletLabel) rhythmTripletLabel.style.display = 'flex';
                if (freqTripletItem) freqTripletItem.style.display = 'block';

                // 6/8ÔºöÊòæÁ§∫ÈôÑÁÇπËäÇÂ•è + ‰∫åËøûÈü≥/ÂõõËøûÈü≥
                if (rhythmDottedHalfLabel) rhythmDottedHalfLabel.style.display = 'block';
                if (rhythmDottedQuarterLabel) rhythmDottedQuarterLabel.style.display = 'block';
                if (freqDottedHalfItem) freqDottedHalfItem.style.display = 'block';
                if (freqDottedQuarterItem) freqDottedQuarterItem.style.display = 'block';
                if (rhythmDupletLabel) rhythmDupletLabel.style.display = 'flex';
                if (rhythmQuadrupletLabel) rhythmQuadrupletLabel.style.display = 'flex';
                if (freqDupletItem) freqDupletItem.style.display = 'block';
                if (freqQuadrupletItem) freqQuadrupletItem.style.display = 'block';

                // üÜï ÂΩìÂåÖÂê´6/8Êó∂ÔºåÈªòËÆ§ÂãæÈÄâÂÖ´ÂàÜÈü≥Á¨¶‰∏éÈôÑÁÇπÂõõÂàÜÈü≥Á¨¶ÔºåÁ°Æ‰øùÂ§çÂêàÊãçÊ†∏ÂøÉËäÇÂ•èÂ∞±Áª™
                const eighthCheckbox = document.getElementById('rhythm-eighth');
                const dottedQuarterCheckbox = document.getElementById('rhythm-dotted-quarter');
                if (eighthCheckbox && !eighthCheckbox.checked) {
                    eighthCheckbox.checked = true;
                    console.log('‚úÖ 6/8Â∑≤Ë¢´ÂãæÈÄâÔºà‰∏éÁÆÄÂçïÊãçÂπ∂Â≠òÔºâ‚Üí Ëá™Âä®ÂãæÈÄâÔºöÂÖ´ÂàÜÈü≥Á¨¶');
                }
                if (dottedQuarterCheckbox && !dottedQuarterCheckbox.checked) {
                    dottedQuarterCheckbox.checked = true;
                    console.log('‚úÖ 6/8Â∑≤Ë¢´ÂãæÈÄâÔºà‰∏éÁÆÄÂçïÊãçÂπ∂Â≠òÔºâ‚Üí Ëá™Âä®ÂãæÈÄâÔºöÈôÑÁÇπÂõõÂàÜÈü≥Á¨¶');
                }

            } else if (has68TimeSignature) {

                // ÈöêËóèÂÖ®Èü≥Á¨¶/‰∫åÂàÜÈü≥Á¨¶
                if (rhythmWholeLabel) rhythmWholeLabel.style.display = 'none';
                if (rhythmHalfLabel) rhythmHalfLabel.style.display = 'none';
                if (freqWholeItem) freqWholeItem.style.display = 'none';
                if (freqHalfItem) freqHalfItem.style.display = 'none';

                // ÊòæÁ§∫ÈôÑÁÇπËäÇÂ•è + ‰∫åËøûÈü≥/ÂõõËøûÈü≥
                if (rhythmDottedHalfLabel) rhythmDottedHalfLabel.style.display = 'block';
                if (rhythmDottedQuarterLabel) rhythmDottedQuarterLabel.style.display = 'block';
                if (freqDottedHalfItem) freqDottedHalfItem.style.display = 'block';
                if (freqDottedQuarterItem) freqDottedQuarterItem.style.display = 'block';
                if (rhythmDupletLabel) rhythmDupletLabel.style.display = 'flex';
                if (rhythmQuadrupletLabel) rhythmQuadrupletLabel.style.display = 'flex';
                if (freqDupletItem) freqDupletItem.style.display = 'block';
                if (freqQuadrupletItem) freqQuadrupletItem.style.display = 'block';

                // Á¶ÅÁî®‰∏âËøûÈü≥
                if (rhythmTripletLabel) rhythmTripletLabel.style.display = 'none';
                if (freqTripletItem) freqTripletItem.style.display = 'none';

                // üÜï 6/8ÊãçËá™Âä®ÂãæÈÄâÊ†∏ÂøÉËäÇÂ•èÁ±ªÂûã
                const eighthCheckbox = document.getElementById('rhythm-eighth');
                const dottedQuarterCheckbox = document.getElementById('rhythm-dotted-quarter');
                if (eighthCheckbox && !eighthCheckbox.checked) {
                    eighthCheckbox.checked = true;
                    console.log('‚úÖ 6/8ÊãçËá™Âä®ÂãæÈÄâÔºöÂÖ´ÂàÜÈü≥Á¨¶');
                }
                if (dottedQuarterCheckbox && !dottedQuarterCheckbox.checked) {
                    dottedQuarterCheckbox.checked = true;
                    console.log('‚úÖ 6/8ÊãçËá™Âä®ÂãæÈÄâÔºöÈôÑÁÇπÂõõÂàÜÈü≥Á¨¶');
                }

            } else {

                // ÊòæÁ§∫ÂÖ®Èü≥Á¨¶/‰∫åÂàÜÈü≥Á¨¶ + ‰∏âËøûÈü≥
                if (rhythmWholeLabel) rhythmWholeLabel.style.display = 'block';
                if (rhythmHalfLabel) rhythmHalfLabel.style.display = 'block';
                if (freqWholeItem) freqWholeItem.style.display = 'block';
                if (freqHalfItem) freqHalfItem.style.display = 'block';
                if (rhythmTripletLabel) rhythmTripletLabel.style.display = 'flex';
                if (freqTripletItem) freqTripletItem.style.display = 'block';

                // ÈöêËóè6/8‰∏ìÂ±û
                if (rhythmDottedHalfLabel) rhythmDottedHalfLabel.style.display = 'none';
                if (rhythmDottedQuarterLabel) rhythmDottedQuarterLabel.style.display = 'none';
                if (freqDottedHalfItem) freqDottedHalfItem.style.display = 'none';
                if (freqDottedQuarterItem) freqDottedQuarterItem.style.display = 'none';
                if (rhythmDupletLabel) rhythmDupletLabel.style.display = 'none';
                if (rhythmQuadrupletLabel) rhythmQuadrupletLabel.style.display = 'none';
                if (freqDupletItem) freqDupletItem.style.display = 'none';
                if (freqQuadrupletItem) freqQuadrupletItem.style.display = 'none';
            }
        }
        
        // Èü≥Á®ãË∑®Â∫¶ËÆæÁΩÆÂºπÁ™ó
        function openIntervalSettings() {
            document.getElementById('intervalModal').style.display = 'flex';
        }
        
        function closeIntervalSettings() {
            document.getElementById('intervalModal').style.display = 'none';
        }
        
        function handleIntervalCheckboxChange(changedCheckbox) {
            // ÂèñÊ∂àÈÄâ‰∏≠ÂÖ∂‰ªñÂ§çÈÄâÊ°ÜÔºåÁ°Æ‰øùÂè™Êúâ‰∏Ä‰∏™Ë¢´ÈÄâ‰∏≠
            const checkboxes = document.querySelectorAll('#intervalModal input[type="checkbox"]');
            
            checkboxes.forEach(checkbox => {
                if (checkbox !== changedCheckbox) {
                    checkbox.checked = false;
                }
            });
        }
        
        function saveIntervalSettings() {
            console.log('‰øùÂ≠òÈü≥Á®ãË∑®Â∫¶ËÆæÁΩÆ');
            closeIntervalSettings();
        }
        
        // Ë∞±Âè∑ËÆæÁΩÆÂºπÁ™ó
        function openClefSettings() {
            document.getElementById('clefModal').style.display = 'flex';

            // üéº Âú®Ê®°ÊÄÅÊ°ÜÊòæÁ§∫ÂêéÁ´ãÂç≥Ê∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®
            setTimeout(() => {
                if (typeof window.addClefChangeListeners === 'function') {
                    window.addClefChangeListeners();
                } else {
                    // Â¶ÇÊûúÂÖ®Â±ÄÂáΩÊï∞‰∏çÂ≠òÂú®ÔºåÁõ¥Êé•Âú®ËøôÈáåÊ∑ªÂä†ÁõëÂê¨Âô®
                    const clefCheckboxes = document.querySelectorAll('#clefModal input[type="checkbox"]');

                    clefCheckboxes.forEach(checkbox => {
                        // ÁßªÈô§ÂèØËÉΩÂ≠òÂú®ÁöÑÊóßÁõëÂê¨Âô®
                        checkbox.removeEventListener('change', window.clefChangeHandler);

                        // Ê∑ªÂä†Êñ∞ÁöÑÁõëÂê¨Âô®
                        window.clefChangeHandler = function() {

                            // Â¶ÇÊûúÊúâÂîØ‰∏ÄÈÄâ‰∏≠ÁöÑË∞±Âè∑ÔºåÁ´ãÂç≥ÂàáÊç¢Âà∞ËØ•Ë∞±Âè∑ÁöÑÈªòËÆ§Èü≥Âüü
                            const checkedClefs = Array.from(clefCheckboxes).filter(cb => cb.checked);

                            if (checkedClefs.length === 1) {
                                const selectedClef = checkedClefs[0].value;

                if (window.intervalSettings && typeof window.intervalSettings.setActiveClef === 'function') {
                    window.intervalSettings.setActiveClef(selectedClef);
                } else if (typeof window.switchToClefRange === 'function') {
                    window.switchToClefRange(selectedClef);
                }
                            } else if (checkedClefs.length > 1) {
                                // Â§öË∞±Âè∑ÔºöÂ∞Ü‚ÄúÂΩìÂâçÊ¥ªÂä®Ë∞±Âè∑‚ÄùËÆæÁΩÆ‰∏∫Áî®Êà∑ÊúÄÂêéÁÇπÂáªÁöÑËøô‰∏™Ë∞±Âè∑
                                if (this.checked) {
                                    window.currentActiveClef = this.value;
                                    if (typeof window.setRangeForClef === 'function') {
                                        window.setRangeForClef(window.currentActiveClef);
                                    }
                                } else {
                                }
                            } else {
                            }
                        };

                        checkbox.addEventListener('change', window.clefChangeHandler);
                    });
                }
            }, 100); // Á≠âÂæÖÊ®°ÊÄÅÊ°ÜÂÆåÂÖ®ÊòæÁ§∫
        }
        
        function closeClefSettings() {
            document.getElementById('clefModal').style.display = 'none';
        }
        
        function selectAllClefs() {
            const checkboxes = document.querySelectorAll('#clefModal input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
            });
        }
        
        function saveClefSettings() {
            console.log('‰øùÂ≠òË∞±Âè∑ËÆæÁΩÆ');
            closeClefSettings();
        }
        
        // Èü≥Á®ãÁ±ªÂûãËÆæÁΩÆ
        function openIntervalTypeSettings() {
            document.getElementById('intervalTypeModal').style.display = 'flex';
        }
        
        function closeIntervalTypeSettings() {
            document.getElementById('intervalTypeModal').style.display = 'none';
        }
        
        function selectAllIntervalTypes() {
            const checkboxes = document.querySelectorAll('#intervalTypeModal input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
            });
        }
        
        function saveIntervalTypeSettings() {
            console.log('‰øùÂ≠òÈü≥Á®ãÁ±ªÂûãËÆæÁΩÆ');
            closeIntervalTypeSettings();
        }
        
        // === Èü≥Á®ãÁîüÊàêÂô®Êï¥ÂêàÊ®°Âùó ===
        // ÂàùÂßãÂåñÈü≥Á®ãÁîüÊàêÂô®ÂÆû‰æã
        let intervalSettings, intervalGenerator, intervalRenderer;
        
        // È°µÈù¢Âä†ËΩΩÂêéÂàùÂßãÂåñÊâÄÊúâÈü≥Á®ãÁîüÊàêÂô®Ê®°Âùó
        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log('ÂºÄÂßãÂàùÂßãÂåñÈü≥Á®ãÁîüÊàêÂô®Ê®°Âùó...');

                console.log('ÂàùÂßãÂåñIntervalSettings...');
                intervalSettings = new IntervalSettings();
                window.intervalSettings = intervalSettings; // Áªü‰∏ÄÂºïÁî®
                console.log('IntervalSettingsÂàùÂßãÂåñÊàêÂäü:', !!intervalSettings);

                console.log('ÂàùÂßãÂåñIntervalGenerator...');
                intervalGenerator = new IntervalGenerator();
                console.log('IntervalGeneratorÂàùÂßãÂåñÊàêÂäü:', !!intervalGenerator);

                console.log('ÂàùÂßãÂåñIntervalRenderer...');
                intervalRenderer = new IntervalRenderer();
                console.log('IntervalRendererÂàùÂßãÂåñÊàêÂäü:', !!intervalRenderer);

                // ÂàùÂßãÂåñÂØºËà™ÊåâÈíÆÁä∂ÊÄÅ
                updateNavigationButtons();

                // üéØ ÂàùÂßãÂåñËäÇÂ•èÂèØËßÅÊÄßÔºàÂü∫‰∫éÈªòËÆ§ÊãçÂè∑ËÆæÁΩÆÔºâ
                updateRhythmVisibilityForTimeSignature();

            } catch (initError) {
                console.error('‚ùå Èü≥Á®ãÁîüÊàêÂô®Ê®°ÂùóÂàùÂßãÂåñÂ§±Ë¥•:', initError);
                console.error('ÈîôËØØËØ¶ÊÉÖ:', initError.stack);

                // Â∞ùËØïÈÉ®ÂàÜÂàùÂßãÂåñ
                try {
                    if (!intervalSettings) {
                        intervalSettings = new IntervalSettings();
                        window.intervalSettings = intervalSettings; // Áªü‰∏ÄÂºïÁî®
                        console.log('Ë°•ÊïëÔºöIntervalSettingsÂàùÂßãÂåñÊàêÂäü');
                    }
                } catch (settingsError) {
                    console.error('IntervalSettingsÂàùÂßãÂåñÂ§±Ë¥•:', settingsError);
                }

                try {
                    if (!intervalGenerator) {
                        intervalGenerator = new IntervalGenerator();
                        console.log('Ë°•ÊïëÔºöIntervalGeneratorÂàùÂßãÂåñÊàêÂäü');
                    }
                } catch (generatorError) {
                    console.error('IntervalGeneratorÂàùÂßãÂåñÂ§±Ë¥•:', generatorError);
                }

                try {
                    if (!intervalRenderer) {
                        intervalRenderer = new IntervalRenderer();
                        console.log('Ë°•ÊïëÔºöIntervalRendererÂàùÂßãÂåñÊàêÂäü');
                    }
                } catch (rendererError) {
                    console.error('IntervalRendererÂàùÂßãÂåñÂ§±Ë¥•:', rendererError);
                }
            }
        });
        
        // Âª∂ËøüÂàùÂßãÂåñÂáΩÊï∞ - Â§áÁî®Êú∫Âà∂
        function ensureModulesInitialized() {
            console.log('üîÑ ÊâßË°åÂª∂ËøüÂàùÂßãÂåñÊ£ÄÊü•...');

            if (!intervalSettings) {
                try {
                    intervalSettings = new IntervalSettings();
                    window.intervalSettings = intervalSettings; // Áªü‰∏ÄÂºïÁî®
                } catch (error) {
                    console.error('‚ùå IntervalSettingsÂª∂ËøüÂàùÂßãÂåñÂ§±Ë¥•:', error);
                }
            }

            if (!intervalGenerator) {
                try {
                    intervalGenerator = new IntervalGenerator();
                } catch (error) {
                    console.error('‚ùå IntervalGeneratorÂª∂ËøüÂàùÂßãÂåñÂ§±Ë¥•:', error);
                }
            }

            if (!intervalRenderer) {
                try {
                    intervalRenderer = new IntervalRenderer();
                } catch (error) {
                    console.error('‚ùå IntervalRendererÂª∂ËøüÂàùÂßãÂåñÂ§±Ë¥•:', error);
                }
            }
        }

        // ‰∏ªÈü≥Á®ãÁîüÊàêÂáΩÊï∞ - Ë∞ÉÁî®Áã¨Á´ãÊ®°Âùó
        async function generateIntervals() {

            // üéµ Ëá™Âä®ÊöÇÂÅúÂΩìÂâçÊí≠Êîæ
            if (window.isPlayingInterval) {
                directPlayTest(); // Ë∞ÉÁî®Êí≠ÊîæÂáΩÊï∞Êù•ÂàáÊç¢Áä∂ÊÄÅÔºàÂÅúÊ≠¢Êí≠ÊîæÔºâ
            }

            try {
                // üîß È¶ñÂÖàÂ∞ùËØïÂª∂ËøüÂàùÂßãÂåñÔºàÂ§áÁî®Êú∫Âà∂Ôºâ
                ensureModulesInitialized();

                // üîç Ê£ÄÊü•ÂøÖË¶ÅÁöÑÊ®°ÂùóÊòØÂê¶Â∑≤ÂàùÂßãÂåñ

                if (!intervalSettings) {
                    throw new Error('intervalSettings Ê®°ÂùóÊú™ÂàùÂßãÂåñ');
                }
                if (!intervalGenerator) {
                    throw new Error('intervalGenerator Ê®°ÂùóÊú™ÂàùÂßãÂåñ');
                }
                if (!intervalRenderer) {
                    throw new Error('intervalRenderer Ê®°ÂùóÊú™ÂàùÂßãÂåñ');
                }

                // Ëé∑ÂèñÂΩìÂâçËÆæÁΩÆÂèÇÊï∞
                const settings = intervalSettings.getCurrentSettings();

                // È™åËØÅËÆæÁΩÆ
                const validation = intervalSettings.validateSettings(settings);

                if (!validation.isValid) {
                    console.error('‚ùå ËÆæÁΩÆÈ™åËØÅÂ§±Ë¥•:', validation.errors);
                    alert('ËÆæÁΩÆÈîôËØØ: ' + validation.errors.join(', '));
                    return;
                }

                console.log('üìä ËÆæÁΩÆÊëòË¶Å:', intervalSettings.getSettingsSummary(settings));

                // ÁîüÊàêÈü≥Á®ãËøõË°å
                const intervalProgression = intervalGenerator.generateIntervalProgression(settings);

                // üéµ Á´ãÂç≥‰øùÂ≠òÂΩìÂâçÈü≥Á®ãËøõË°åÊï∞ÊçÆ‰æõÊí≠ÊîæÂäüËÉΩ‰ΩøÁî®
                window.currentIntervalProgression = intervalProgression;

                // üéØ È™åËØÅÊí≠ÊîæÊï∞ÊçÆÂÆåÊï¥ÊÄß
                if (intervalProgression?.measures) {
                    intervalProgression.measures.forEach((measure, index) => {
                    });
                } else {
                    console.warn('‚ö†Ô∏è ÁîüÊàêÁöÑÈü≥Á®ãËøõË°åÊï∞ÊçÆÁªìÊûÑÂºÇÂ∏∏');
                }

                // ‰øùÂ≠òÂà∞ÂéÜÂè≤ËÆ∞ÂΩï
                saveToHistory(intervalProgression, settings);

                // üéµ ‰ΩøÁî®V4.0Ê∏≤ÊüìÂô®

                try {
                    // üé® ÂºÄÂßãÊ∏≤ÊüìËøáÁ®ã

                    // Ê£ÄÊü•V4.0Ê∏≤ÊüìÂô®ÊòØÂê¶ÂèØÁî®
                    console.log('renderIntervalProgressionÊñπÊ≥ï:', typeof window.intervalRenderer?.renderIntervalProgression);

                    if (window.intervalRenderer && typeof window.intervalRenderer.renderIntervalProgression === 'function') {

                        // ‰ΩøÁî®V4.0Ê∏≤ÊüìÂô®Ê∏≤ÊüìÈü≥Á®ãËøõË°å
                        if (isIntervalHidden){ const scoreEl=document.getElementById('score'); if(scoreEl){ scoreEl.style.opacity='0'; scoreEl.style.filter='blur(10px)'; }}
                        await window.intervalRenderer.renderIntervalProgression(intervalProgression);

                        // üé≠ Ê£ÄÊü•ÈöêËóèÁä∂ÊÄÅÔºåÂ¶ÇÊûúÂºÄÂêØÈöêËóèÂäüËÉΩÂàôÈöêËóèÊñ∞ÁîüÊàêÁöÑÈü≥Á®ã
                        if (isIntervalHidden) {
                            console.log('üëÇ ÈöêËóèÂäüËÉΩÂ∑≤ÂºÄÂêØÔºåÈöêËóèÊñ∞ÁîüÊàêÁöÑÈü≥Á®ã');
                            applyIntervalHiddenState();
                        }
                    } else {
                        console.error('‚ùå V4.0Ê∏≤ÊüìÂô®‰∏çÂèØÁî®');
                        console.error('Ê∏≤ÊüìÂô®Ë∞ÉËØï‰ø°ÊÅØ:');
                        console.error('- window.intervalRenderer:', window.intervalRenderer);
                        console.error('- Á±ªÂûã:', typeof window.intervalRenderer);
                        console.error('- renderIntervalProgressionÊñπÊ≥ï:', window.intervalRenderer?.renderIntervalProgression);
                        throw new Error('V4.0Ê∏≤ÊüìÂô®‰∏çÂèØÁî®');
                    }
                } catch (renderError) {
                    console.error('‚ùå V4.0Ê∏≤ÊüìÂô®Â§±Ë¥•:', renderError);
                    console.error('Ê∏≤ÊüìÈîôËØØËØ¶ÊÉÖ:', renderError.stack);
                    console.error('Ê∏≤ÊüìÂô®Áä∂ÊÄÅ:', {
                        intervalRenderer: window.intervalRenderer,
                        renderMethod: window.intervalRenderer?.renderIntervalProgression,
                        progression: intervalProgression
                    });
                    throw new Error(`V4.0Ê∏≤ÊüìÁ≥ªÁªüÂ§±Ë¥•: ${renderError.message}`);
                }
                
            } catch (error) {
                console.error('‚ùå Èü≥Á®ãÁîüÊàêÈîôËØØ:', error);
                console.error('‚ùå ÈîôËØØËØ¶ÊÉÖ:', error.stack);

                // Êèê‰æõÊõ¥ËØ¶ÁªÜÁöÑÈîôËØØ‰ø°ÊÅØ
                let errorMessage = 'Èü≥Á®ãÁîüÊàêÂ§±Ë¥•';
                if (error.message.includes('Ê®°ÂùóÊú™ÂàùÂßãÂåñ')) {
                    errorMessage = 'Á≥ªÁªüÊ®°ÂùóÂàùÂßãÂåñÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï';
                } else if (error.message.includes('ËÆæÁΩÆ')) {
                    errorMessage = 'ËÆæÁΩÆÂèÇÊï∞ÊúâËØØ: ' + error.message;
                } else if (error.message.includes('Ê∏≤Êüì')) {
                    errorMessage = '‰πêË∞±Ê∏≤ÊüìÂ§±Ë¥•: ' + error.message;
                } else if (error.message.includes('OpenSheetMusicDisplay')) {
                    errorMessage = '‰πêË∞±ÊòæÁ§∫ÁªÑ‰ª∂Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•';
                } else {
                    errorMessage = `ÁîüÊàêÂ§±Ë¥•: ${error.message}`;
                }

                alert(errorMessage + '\n\nËØ¶ÁªÜ‰ø°ÊÅØËØ∑Êü•ÁúãÊµèËßàÂô®ÊéßÂà∂Âè∞');
            }
        }
        
        // ‰øùÂ≠òÈü≥Á®ãÂà∞ÂéÜÂè≤ËÆ∞ÂΩï
        function saveToHistory(intervalProgression, settings) {
            // ‰ªéÂΩìÂâç‰ΩçÁΩÆÂºÄÂßãÊà™Êñ≠ÂéÜÂè≤ËÆ∞ÂΩïÔºàÂà†Èô§‰πãÂêéÁöÑËÆ∞ÂΩïÔºâ
            intervalHistory = intervalHistory.slice(0, currentIntervalIndex + 1);
            
            // Ê∑ªÂä†Êñ∞ËÆ∞ÂΩï
            intervalHistory.push({
                progression: intervalProgression,
                settings: settings,
                timestamp: Date.now()
            });
            
            // ÈôêÂà∂ÂéÜÂè≤ËÆ∞ÂΩïÂ§ßÂ∞è
            if (intervalHistory.length > MAX_HISTORY_SIZE) {
                intervalHistory.shift();
            } else {
                currentIntervalIndex++;
            }
            
            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            updateNavigationButtons();
            
            console.log(`üíæ ‰øùÂ≠òÈü≥Á®ãÂà∞ÂéÜÂè≤ËÆ∞ÂΩïÔºåÂΩìÂâçÁ¥¢Âºï: ${currentIntervalIndex}, ÂéÜÂè≤ÈïøÂ∫¶: ${intervalHistory.length}`);
        }
        
        // Êõ¥Êñ∞ÂØºËà™ÊåâÈíÆÁä∂ÊÄÅ
        function updateNavigationButtons() {
            const prevBtn = document.querySelector('button[onclick="previousInterval()"]');
            const nextBtn = document.querySelector('button[onclick="nextInterval()"]');

            if (prevBtn) {
                prevBtn.disabled = currentIntervalIndex <= 0;
                // üé® ÁßªÈô§ÂèòÊ∑°ÊïàÊûúÔºöÊåâÈíÆ‰øùÊåÅÊ≠£Â∏∏Â§ñËßÇ
                prevBtn.style.opacity = '1';
            }

            if (nextBtn) {
                nextBtn.disabled = currentIntervalIndex >= intervalHistory.length - 1;
                // üé® ÁßªÈô§ÂèòÊ∑°ÊïàÊûúÔºöÊåâÈíÆ‰øùÊåÅÊ≠£Â∏∏Â§ñËßÇ
                nextBtn.style.opacity = '1';
            }
        }
        
        // Ê∏≤ÊüìÊåáÂÆöÁöÑÈü≥Á®ãËøõË°å
        async function renderIntervalProgression(intervalProgression) {
            try {
                // üéµ ‰øùÂ≠òÂΩìÂâçÈü≥Á®ãËøõË°åÊï∞ÊçÆ‰æõÊí≠ÊîæÂäüËÉΩ‰ΩøÁî®
                window.currentIntervalProgression = intervalProgression;

                // üéØ È™åËØÅÊí≠ÊîæÊï∞ÊçÆÂÆåÊï¥ÊÄß
                if (intervalProgression?.measures) {
                    intervalProgression.measures.forEach((measure, index) => {
                        measure.lowerVoice.forEach((note, noteIndex) => {
                            if (note.type === 'note') {
                                console.log(`  Èü≥Á¨¶${noteIndex + 1}: pitch="${note.pitch}", duration=${note.duration}, type=${note.type}`);
                            }
                        });
                    });
                }

                // üéØ ‰ΩøÁî®V4.0Ê∏≤ÊüìÂô®
                if (window.intervalRenderer && typeof window.intervalRenderer.renderIntervalProgression === 'function') {

                    // ‰ΩøÁî®V4.0Ê∏≤ÊüìÂô®Ê∏≤ÊüìÈü≥Á®ãËøõË°å
                    await window.intervalRenderer.renderIntervalProgression(intervalProgression);
                } else {
                    console.log('‚ùå V4.0Ê∏≤ÊüìÂô®‰∏çÂèØÁî®');
                    throw new Error('V4.0Ê∏≤ÊüìÂô®‰∏çÂèØÁî®');
                }
            } catch (renderError) {
                console.warn('V4.0Ê∏≤ÊüìÂô®Â§±Ë¥•:', renderError);
                alert('Èü≥Á®ãÊ∏≤ÊüìÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        }
        
        function previousInterval() {
            if (currentIntervalIndex > 0) {
                currentIntervalIndex--;
                const historyItem = intervalHistory[currentIntervalIndex];

                console.log(`‚¨ÖÔ∏è ÊòæÁ§∫‰∏ä‰∏ÄÊù°Èü≥Á®ãÔºåÁ¥¢Âºï: ${currentIntervalIndex}`);

                // üéµ Êõ¥Êñ∞Êí≠ÊîæÊï∞ÊçÆ
                window.currentIntervalProgression = historyItem.progression;

                // Ê∏≤ÊüìÂéÜÂè≤‰∏≠ÁöÑÈü≥Á®ãËøõË°å
                renderIntervalProgression(historyItem.progression);

                // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
                updateNavigationButtons();
            } else {
                console.log('‚ö†Ô∏è Â∑≤ÁªèÊòØÁ¨¨‰∏ÄÊù°Èü≥Á®ã');
            }
        }
        
        function nextInterval() {
            if (currentIntervalIndex < intervalHistory.length - 1) {
                currentIntervalIndex++;
                const historyItem = intervalHistory[currentIntervalIndex];

                console.log(`‚û°Ô∏è ÊòæÁ§∫‰∏ã‰∏ÄÊù°Èü≥Á®ãÔºåÁ¥¢Âºï: ${currentIntervalIndex}`);

                // üéµ Êõ¥Êñ∞Êí≠ÊîæÊï∞ÊçÆ
                window.currentIntervalProgression = historyItem.progression;

                // Ê∏≤ÊüìÂéÜÂè≤‰∏≠ÁöÑÈü≥Á®ãËøõË°å
                renderIntervalProgression(historyItem.progression);

                // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
                updateNavigationButtons();
            } else {
                console.log('‚ö†Ô∏è Â∑≤ÁªèÊòØÊúÄÂêé‰∏ÄÊù°Èü≥Á®ã');
            }
        }
        
        // È¢ëÁéáÊªëÂùó‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºàÂ¢ûÂº∫ÁâàÔºöËá™Âä®ÂêåÊ≠•ÂãæÈÄâÊ°ÜÔºâ
        document.addEventListener('DOMContentLoaded', function() {
            // ÁõëÂê¨ÊâÄÊúâÈ¢ëÁéáÊªëÂùóÂèòÂåñ
            const frequencySliders = document.querySelectorAll('input[type="range"][id^="freq-"]');

            frequencySliders.forEach(slider => {
                const valueSpan = document.getElementById(slider.id + '-value');

                if (valueSpan) {
                    slider.addEventListener('input', function() {
                        const frequency = parseInt(this.value);
                        valueSpan.textContent = frequency + '%';

                        // üî• Ëá™Âä®ÂêåÊ≠•Â§çÈÄâÊ°ÜÔºö0%ÂèñÊ∂àÂãæÈÄâÔºå>0%Ëá™Âä®ÂãæÈÄâ
                        const rhythmType = slider.id.replace('freq-', '');
                        const checkbox = document.getElementById('rhythm-' + rhythmType);

                        if (checkbox) {
                            if (frequency === 0) {
                                checkbox.checked = false;
                                console.log('üîÑ Ëá™Âä®ÂèñÊ∂àÂãæÈÄâ ' + rhythmType + ': È¢ëÁéá‰∏∫ 0%');
                            } else if (!checkbox.checked) {
                                checkbox.checked = true;
                                console.log('üîÑ Ëá™Âä®ÂãæÈÄâ ' + rhythmType + ': È¢ëÁéá‰∏∫ ' + frequency + '%');
                            }
                        }
                    });
                }
            });
        });

        // üéº Ë∞±Âè∑-Èü≥ÂüüÊô∫ËÉΩÁªëÂÆöÁ≥ªÁªü‰∫ã‰ª∂ÁõëÂê¨Âô®
        document.addEventListener('DOMContentLoaded', function() {

            // Ëé∑ÂèñÈü≥ÂüüÊéßÂà∂ÂÖÉÁ¥†
            const rangeMinSelect = document.getElementById('rangeMin');
            const rangeMaxSelect = document.getElementById('rangeMax');

            if (!rangeMinSelect || !rangeMaxSelect) {
                console.warn('‚ö†Ô∏è Èü≥ÂüüÈÄâÊã©Âô®Êú™ÊâæÂà∞');
                return;
            }

            // üéº Ê∑ªÂä†Ë∞±Âè∑ÈÄâÊã©ÂÆûÊó∂ÁõëÂê¨ - Á´ãÂç≥ÂàáÊç¢Èü≥ÂüüÔºàÂÖ®Â±ÄÂáΩÊï∞Ôºâ
            window.addClefChangeListeners = function() {
                const clefCheckboxes = document.querySelectorAll('#clefModal input[type="checkbox"]');

                if (clefCheckboxes.length === 0) {
                    console.warn('‚ö†Ô∏è Êú™ÊâæÂà∞Ë∞±Âè∑Â§çÈÄâÊ°ÜÔºåÂèØËÉΩÊ®°ÊÄÅÊ°ÜÊú™ÊòæÁ§∫');
                    return;
                }

                clefCheckboxes.forEach(checkbox => {
                    // ÁßªÈô§ÂèØËÉΩÂ≠òÂú®ÁöÑÊóßÁõëÂê¨Âô®
                    if (window.clefChangeHandler) {
                        checkbox.removeEventListener('change', window.clefChangeHandler);
                    }

                    // ÂàõÂª∫Êñ∞ÁöÑÁõëÂê¨Âô®ÂáΩÊï∞
                    window.clefChangeHandler = function() {

                        // Â¶ÇÊûúÊúâÂîØ‰∏ÄÈÄâ‰∏≠ÁöÑË∞±Âè∑ÔºåÁ´ãÂç≥ÂàáÊç¢Âà∞ËØ•Ë∞±Âè∑ÁöÑÈªòËÆ§Èü≥Âüü
                        const checkedClefs = Array.from(clefCheckboxes).filter(cb => cb.checked);

                        if (checkedClefs.length === 1) {
                            const selectedClef = checkedClefs[0].value;

                            if (typeof window.switchToClefRange === 'function') {
                                window.switchToClefRange(selectedClef);
                                // Êõ¥Êñ∞ÂΩìÂâçÁîüÊàêÁöÑË∞±Âè∑
                                window.currentGeneratedClef = selectedClef;
                                window.currentActiveClef = selectedClef;

                            }
                        } else if (checkedClefs.length > 1) {
                            // Â§ö‰∏™Ë∞±Âè∑ÂêØÁî®ÔºöÂ∞ÜÊ¥ªÂä®Ë∞±Âè∑ËÆæ‰∏∫ÊúÄÂêéÁÇπÂáªÁöÑËØ•È°πÔºåÂπ∂Âä†ËΩΩÂÖ∂‰ºöËØùÈü≥Âüü
                            if (this.checked) {
                                const newClef = this.value;
                                if (window.intervalSettings && typeof window.intervalSettings.setActiveClef === 'function') {
                                    window.intervalSettings.setActiveClef(newClef);
                                } else if (typeof window.setRangeForClef === 'function') {
                                    window.setRangeForClef(newClef);
                                }
                            } else {
                            }
                        } else {
                        }
                    };

                    checkbox.addEventListener('change', window.clefChangeHandler);
                });

            };

            // Â≠òÂÇ®ÂΩìÂâçÁîüÊàêÁöÑË∞±Âè∑ÔºàÁî®‰∫éÁªëÂÆöÁî®Êà∑Ëá™ÂÆö‰πâÈü≥ÂüüÔºâ
            window.currentGeneratedClef = 'treble'; // ÈªòËÆ§È´òÈü≥Ë∞±Âè∑

            // ÂÖºÂÆπÂèòÈáèÂêç - ‰∏∫Áî®Êà∑Êèê‰æõÁöÑÂáΩÊï∞‰ΩøÁî®
            window.currentActiveClef = window.currentGeneratedClef;

            // Èü≥ÂüüËÆ∞ÂøÜÁ≥ªÁªü - ÂèÇËÄÉÂíåÂº¶ËßÜÂ•èÂ∑•ÂÖ∑ËÆæÁΩÆ
            window.clefRangeMemory = {
                'treble': { min: 60, max: 81 },  // C4-A5ÔºàÈ´òÈü≥Ë∞±Âè∑ÈªòËÆ§Èü≥ÂüüÔºâ
                'bass': { min: 40, max: 64 },    // E2-E4 (‰∏éÂíåÂº¶ËßÜÂ•èÂ∑•ÂÖ∑‰∏ÄËá¥)
                'alto': { min: 48, max: 67 }     // C3-G4 (‰∏≠Èü≥Ë∞±Âè∑ÂêàÁêÜÈü≥ÂüüÔºå‰∏çÂΩ±ÂìçÂíåÂº¶Â∑•ÂÖ∑)
            };

            // ‰øùÂ≠òÁî®Êà∑ÂØπÈü≥ÂüüÁöÑË∞ÉÊï¥
            function saveRangeForCurrentClef() {
                const rangeMinSelect = document.getElementById('rangeMin');
                const rangeMaxSelect = document.getElementById('rangeMax');

                if (!rangeMinSelect || !rangeMaxSelect) return;

                // ‰ΩøÁî®ÂΩìÂâçÊ¥ªË∑ÉÁöÑË∞±Âè∑
                if (!window.currentActiveClef) return;
                const minV = parseInt(rangeMinSelect.value);
                const maxV = parseInt(rangeMaxSelect.value);
                // Êõ¥Êñ∞‰ºöËØù‰øùÂ≠òÔºàÂΩìÂâç+ÈªòËÆ§Ôºâ
                if (window.intervalSettings && typeof window.intervalSettings.setClefRange === 'function') {
                    window.intervalSettings.setClefRange(window.currentActiveClef, minV, maxV);
                }
                // Âà∑Êñ∞ÈïúÂÉè
                window.clefRangeMemory[window.currentActiveClef] = { min: minV, max: maxV };
                console.log(`üíæ ‰øùÂ≠ò${window.currentActiveClef}Ë∞±Âè∑Èü≥Âüü(‰ºöËØù+ÈïúÂÉè): ${minV}-${maxV}`);
            }

            // ‰ªéËÆ∞ÂøÜ‰∏≠Âä†ËΩΩÊåáÂÆöË∞±Âè∑ÁöÑÈü≥Âüü
            function loadRangeForClef(clef) {
                const rangeMinSelect = document.getElementById('rangeMin');
                const rangeMaxSelect = document.getElementById('rangeMax');

                if (!rangeMinSelect || !rangeMaxSelect) return;

                if (window.clefRangeMemory[clef]) {
                    const range = window.clefRangeMemory[clef];
                    rangeMinSelect.value = range.min.toString();
                    rangeMaxSelect.value = range.max.toString();
                    console.log(`üìñ Âä†ËΩΩ${clef}Ë∞±Âè∑Èü≥Âüü: ${range.min}-${range.max}`);
                }
            }

            // ÂàùÂßãÂåñÈü≥ÂüüÁõëÂê¨Âô®
            function initRangeListeners() {
                const rangeMinSelect = document.getElementById('rangeMin');
                const rangeMaxSelect = document.getElementById('rangeMax');

                if (rangeMinSelect && rangeMaxSelect) {
                    const handler = () => {
                        try {
                            if (window.intervalSettings && typeof window.intervalSettings.onRangeChange === 'function') {
                                window.intervalSettings.onRangeChange();
                                saveRangeForCurrentClef();
                            }
                        } catch(e){ console.warn('Èü≥ÂüüonChangeÂ§±Ë¥•', e); }
                    };
                    rangeMinSelect.addEventListener('change', handler);
                    rangeMaxSelect.addEventListener('change', handler);
                }
            }

            // Ê†πÊçÆË∞±Âè∑ËÆæÁΩÆÂêàÈÄÇÁöÑÈü≥Âüü - ‰ΩøÁî® IntervalSettings ‰ºöËØù‰øùÂ≠ò
            function setRangeForClef(clef) {
                const rangeMinSelect = document.getElementById('rangeMin');
                const rangeMaxSelect = document.getElementById('rangeMax');

                if (!rangeMinSelect || !rangeMaxSelect) return;

                // Êõ¥Êñ∞ÂΩìÂâçÊ¥ªË∑ÉË∞±Âè∑
                window.currentActiveClef = clef;
                // ‰ªé IntervalSettings ‰ºöËØù‰øùÂ≠òËé∑ÂèñËÆæÁΩÆ
                try {
                    if (window.intervalSettings && typeof window.intervalSettings.getClefCurrentRange === 'function') {
                        const rangeSettings = window.intervalSettings.getClefCurrentRange(clef);
                        if (rangeSettings) {
                            rangeMinSelect.value = String(rangeSettings.min);
                            rangeMaxSelect.value = String(rangeSettings.max);
                            window.clefRangeMemory[clef] = { min: rangeSettings.min, max: rangeSettings.max };
                            const noteNames = { 36:'C2',40:'E2',48:'C3',50:'D3',55:'G3',60:'C4',64:'E4',67:'G4',71:'B4',72:'C5',81:'A5' };
                            const minNote = noteNames[rangeSettings.min] || `MIDI${rangeSettings.min}`;
                            const maxNote = noteNames[rangeSettings.max] || `MIDI${rangeSettings.max}`;
                        }
                    }
                } catch(e) { console.warn('ËØªÂèñ‰ºöËØùÈü≥ÂüüÂ§±Ë¥•', e); }

                console.log(`üîÑ ÂΩìÂâçÊ¥ªË∑ÉË∞±Âè∑Â∑≤Êõ¥Êñ∞‰∏∫: ${window.currentActiveClef}`);
            }

            // Â∞ÜÂáΩÊï∞Êö¥Èú≤Âà∞ÂÖ®Â±Ä‰ΩúÁî®Âüü‰æõÂ§ñÈÉ®Ë∞ÉÁî®
            window.saveRangeForCurrentClef = saveRangeForCurrentClef;
            window.loadRangeForClef = loadRangeForClef;
            window.initRangeListeners = initRangeListeners;
            window.setRangeForClef = setRangeForClef;

            // üéØ ÁõëÂê¨Èü≥ÂüüÂèòÊõ¥ÔºåËá™Âä®ÁªëÂÆöÂà∞ÂΩìÂâçË∞±Âè∑
            function handleRangeChange() {
                if (!window.intervalSettings) {
                    console.warn('‚ö†Ô∏è intervalSettings ‰∏çÂèØÁî®');
                    return;
                }

                const currentClef = window.currentGeneratedClef;
                const minValue = parseInt(rangeMinSelect.value);
                const maxValue = parseInt(rangeMaxSelect.value);


                // ‰ΩøÁî®Áî®Êà∑Êèê‰æõÁöÑÂáΩÊï∞‰øùÂ≠òÈü≥Âüü
                saveRangeForCurrentClef();
            }

            // ‚ö†Ô∏è Â∑≤ÁßªÈô§ÂÜ≤Á™ÅÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºåÁªü‰∏Ä‰ΩøÁî®IntervalSettingsÁ≥ªÁªü
            // rangeMinSelect.addEventListener('change', handleRangeChange);
            // rangeMaxSelect.addEventListener('change', handleRangeChange);

            // üîÑ Ëá™Âä®ÂàáÊç¢Èü≥ÂüüÂáΩÊï∞ÔºàÂΩìÁîüÊàêÊñ∞Ë∞±Âè∑Êó∂Ë∞ÉÁî®Ôºâ- ÊÄªÊòØÂàáÊç¢Âà∞ÈªòËÆ§Èü≥Âüü
            window.switchToClefRange = function(clef) {

                // Êõ¥Êñ∞ÂΩìÂâçÁîüÊàêÁöÑË∞±Âè∑
                window.currentGeneratedClef = clef;
                window.currentActiveClef = clef;

                const rangeMinSelect = document.getElementById('rangeMin');
                const rangeMaxSelect = document.getElementById('rangeMax');

                if (!rangeMinSelect || !rangeMaxSelect) {
                    console.warn('‚ö†Ô∏è Èü≥ÂüüÈÄâÊã©Âô®Êéß‰ª∂Êú™ÊâæÂà∞');
                    return;
                }

                // üéØ ‰ºòÂÖà‰ΩøÁî®IntervalSettings‰øùÂ≠òÁöÑÈü≥ÂüüÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàô‰ΩøÁî®ÈªòËÆ§Èü≥Âüü
                if (window.intervalSettings) {
                    const savedRange = window.intervalSettings.getClefCurrentRange(clef);

                    rangeMinSelect.value = savedRange.min.toString();
                    rangeMaxSelect.value = savedRange.max.toString();

                    // Ê£ÄÊü•ÊòØÂê¶‰∏∫Ëá™ÂÆö‰πâÈü≥Âüü
                    const clefSetting = window.intervalSettings.userSettings.clefRanges[clef];
                    const isCustom = clefSetting && clefSetting.hasCustomRange;

                } else {
                    // ÂõûÈÄÄÂà∞ÈªòËÆ§Èü≥Âüü (Êõ¥Êñ∞‰∏∫Êñ∞ÁöÑÈªòËÆ§ËÆæÁΩÆ)
                    const defaultRanges = {
                        'treble': { min: 60, max: 72 },  // C4-C5
                        'alto': { min: 50, max: 71 },    // D3-B4
                        'bass': { min: 40, max: 64 }     // E2-E4
                    };
                    const range = defaultRanges[clef] || defaultRanges['treble'];

                    rangeMinSelect.value = range.min.toString();
                    rangeMaxSelect.value = range.max.toString();

                }
            };

            // üöÄ ÂàùÂßãÂåñÊñ∞ÁöÑÁõëÂê¨Âô®Á≥ªÁªü
            window.initRangeListeners();

            // üöÄ ÂàùÂßãÂåñÔºöËÆæÁΩÆ‰∏∫È´òÈü≥Ë∞±Âè∑ÁöÑÈªòËÆ§Èü≥Âüü
            window.setRangeForClef('treble');


            // üß™ Ê∑ªÂä†ÊµãËØïÂäüËÉΩÔºàÂºÄÂèëË∞ÉËØïÁî®Ôºâ
            window.testClefRangeSwitching = function() {
                console.log('üß™ ÂºÄÂßãÊµãËØïË∞±Âè∑-Èü≥ÂüüÊô∫ËÉΩÂàáÊç¢ÂäüËÉΩ');

                const testClefs = ['treble', 'bass', 'alto'];
                let testIndex = 0;

                function runNextTest() {
                    if (testIndex >= testClefs.length) {
                        alert('Ë∞±Âè∑-Èü≥ÂüüÂàáÊç¢ÊµãËØïÂÆåÊàêÔºÅËØ∑Êü•ÁúãÊéßÂà∂Âè∞Êó•ÂøóÊü•ÁúãËØ¶ÁªÜÁªìÊûú„ÄÇ');
                        return;
                    }

                    const clef = testClefs[testIndex];

                    window.switchToClefRange(clef);

                    testIndex++;
                    setTimeout(runNextTest, 1500); // 1.5ÁßíÈó¥Èöî‰æø‰∫éËßÇÂØü
                }

                runNextTest();
            };

            // üîß Ê∑ªÂä†Áî®Êà∑Ëá™ÂÆö‰πâÈü≥ÂüüÊµãËØïÂäüËÉΩ
            window.testUserCustomRange = function() {
                console.log('üß™ ÂºÄÂßãÊµãËØïÁî®Êà∑Ëá™ÂÆö‰πâÈü≥ÂüüÁªëÂÆöÂäüËÉΩ');

                // Ê®°ÊãüÁî®Êà∑Âú®È´òÈü≥Ë∞±Âè∑‰∏äËá™ÂÆö‰πâÈü≥ÂüüÂà∞F4-F5
                window.switchToClefRange('treble');
                setTimeout(() => {
                    rangeMinSelect.value = '65'; // F4
                    rangeMaxSelect.value = '77'; // F5
                    rangeMinSelect.dispatchEvent(new Event('change'));

                    // ÂàáÊç¢Âà∞‰ΩéÈü≥Ë∞±Âè∑ÔºåÂ∫îËØ•ÊòæÁ§∫ÈªòËÆ§Èü≥Âüü
                    setTimeout(() => {
                        window.switchToClefRange('bass');

                        // ÂÜçÂàáÊç¢ÂõûÈ´òÈü≥Ë∞±Âè∑ÔºåÂ∫îËØ•ÊòæÁ§∫Áî®Êà∑ÁöÑËá™ÂÆö‰πâËÆæÁΩÆ
                        setTimeout(() => {
                            window.switchToClefRange('treble');
                            alert('Áî®Êà∑Ëá™ÂÆö‰πâÈü≥ÂüüÊµãËØïÂÆåÊàêÔºÅËØ∑Êü•ÁúãÊéßÂà∂Âè∞ÂíåÈü≥ÂüüÈÄâÊã©Âô®ÁöÑÂèòÂåñ„ÄÇ');
                        }, 1500);
                    }, 1500);
                }, 1000);
            };

            // üîç Ê∑ªÂä†ÁªëÂÆöÁä∂ÊÄÅÊü•ÁúãÂäüËÉΩ
            window.showClefBindingStatus = function() {
                if (!window.intervalSettings) {
                    alert('‚ùå intervalSettings Êú™ÂàùÂßãÂåñ');
                    return;
                }

                const clefs = ['treble', 'bass', 'alto'];
                const clefNames = { 'treble': 'È´òÈü≥Ë∞±Âè∑', 'bass': '‰ΩéÈü≥Ë∞±Âè∑', 'alto': '‰∏≠Èü≥Ë∞±Âè∑' };
                let statusMessage = 'üéº ÂΩìÂâçË∞±Âè∑-Èü≥ÂüüÁªëÂÆöÁä∂ÊÄÅ:\n\n';

                clefs.forEach(clef => {
                    const range = window.intervalSettings.getClefCurrentRange(clef);
                    const name = clefNames[clef];
                    const minNote = window.intervalSettings.midiToNote(range.min);
                    const maxNote = window.intervalSettings.midiToNote(range.max);
                    const isCustom = window.intervalSettings.clefRangeBindings[clef]?.isCustom ? 'Ëá™ÂÆö‰πâ' : 'ÈªòËÆ§';
                    statusMessage += `${name}: ${minNote}-${maxNote} (${isCustom})\n`;
                });

                statusMessage += `\nÂΩìÂâçÁîüÊàêË∞±Âè∑: ${window.currentGeneratedClef || 'treble'}`;
                alert(statusMessage);
            };


            // üß™ Ê∑ªÂä†ÂÆåÊï¥Â∑•‰ΩúÊµÅÁ®ãÊµãËØï
            window.testCompleteWorkflow = function() {
                console.group('üéº ÂÆåÊï¥Ë∞±Âè∑-Èü≥ÂüüÁªëÂÆöÂ∑•‰ΩúÊµÅÁ®ãÊµãËØï');
                console.log('ÊµãËØïÂú∫ÊôØÔºöÈ™åËØÅÊØè‰∏™Ë∞±Âè∑ÁöÑÈªòËÆ§Èü≥ÂüüÂíåÁî®Êà∑Ëá™ÂÆö‰πâÁªëÂÆö');

                let testStep = 1;

                function logStep(description) {
                }

                // Ê≠•È™§1: È™åËØÅÈªòËÆ§Èü≥Âüü
                logStep('È™åËØÅÂêÑË∞±Âè∑ÈªòËÆ§Èü≥Âüü');
                console.log('‚Ä¢ È´òÈü≥Ë∞±Âè∑ÈªòËÆ§: C4-C5 (MIDI 60-72)');
                console.log('‚Ä¢ ‰ΩéÈü≥Ë∞±Âè∑ÈªòËÆ§: E2-E4 (MIDI 40-64)');
                console.log('‚Ä¢ ‰∏≠Èü≥Ë∞±Âè∑ÈªòËÆ§: D3-B4 (MIDI 50-71)');

                // Ê≠•È™§2: ÊµãËØï‰ΩéÈü≥Ë∞±Âè∑Ëá™Âä®ÂàáÊç¢
                logStep('ÊµãËØï‰ΩéÈü≥Ë∞±Âè∑Ëá™Âä®Èü≥ÂüüÂàáÊç¢');
                window.switchToClefRange('bass');
                const bassRange = window.intervalSettings.getClefCurrentRange('bass');

                // Ê≠•È™§3: Ê®°ÊãüÁî®Êà∑Ëá™ÂÆö‰πâ‰ΩéÈü≥Ë∞±Âè∑Èü≥Âüü
                setTimeout(() => {
                    logStep('Ê®°ÊãüÁî®Êà∑Ëá™ÂÆö‰πâ‰ΩéÈü≥Ë∞±Âè∑Èü≥Âüü (Êîπ‰∏∫F2-F4)');
                    const rangeMinSelect = document.getElementById('rangeMin');
                    const rangeMaxSelect = document.getElementById('rangeMax');
                    rangeMinSelect.value = '41'; // F2
                    rangeMaxSelect.value = '65'; // F4
                    rangeMinSelect.dispatchEvent(new Event('change'));

                    // Ê≠•È™§4: ÂàáÊç¢Âà∞‰∏≠Èü≥Ë∞±Âè∑È™åËØÅÁã¨Á´ãÊÄß
                    setTimeout(() => {
                        logStep('ÂàáÊç¢Âà∞‰∏≠Èü≥Ë∞±Âè∑ÔºåÈ™åËØÅÈü≥ÂüüÁã¨Á´ãÊÄß');
                        window.switchToClefRange('alto');
                        const altoRange = window.intervalSettings.getClefCurrentRange('alto');

                        // Ê≠•È™§5: ÂàáÊç¢Âõû‰ΩéÈü≥Ë∞±Âè∑È™åËØÅÁî®Êà∑Ëá™ÂÆö‰πâ‰øùÊåÅ
                        setTimeout(() => {
                            logStep('ÂàáÊç¢Âõû‰ΩéÈü≥Ë∞±Âè∑ÔºåÈ™åËØÅÁî®Êà∑Ëá™ÂÆö‰πâÈü≥ÂüüÂ∑≤‰øùÂ≠ò');
                            window.switchToClefRange('bass');
                            const customBassRange = window.intervalSettings.getClefCurrentRange('bass');

                            console.log('Ê†∏ÂøÉÈÄªËæëÈ™åËØÅ:');
                            console.groupEnd();

                            alert('‚úÖ ÂÆåÊï¥Â∑•‰ΩúÊµÅÁ®ãÊµãËØïÂÆåÊàêÔºÅ\nËØ∑Êü•ÁúãÊéßÂà∂Âè∞ËØ¶ÁªÜÊó•Âøó„ÄÇ');
                        }, 1500);
                    }, 1500);
                }, 1000);
            };

            // üß™ Ê∑ªÂä†Êñ∞ÈÄªËæëÊµãËØï
            window.testNewLogic = function() {
                console.group('üéº ÊµãËØïÊñ∞ÁöÑÈü≥Á®ãÁîüÊàêÈÄªËæë');
                console.log('ÊµãËØïÂú∫ÊôØÔºöÈ™åËØÅ"ÁîüÊàêÂêéÊ†πÊçÆÂÆûÈôÖË∞±Âè∑ÂàáÊç¢Èü≥Âüü"ÁöÑÈÄªËæë');

                // ÊâãÂä®ËÆæÁΩÆ‰∏Ä‰∏™ÁâπÂÆöÈü≥Âüü
                const rangeMinSelect = document.getElementById('rangeMin');
                const rangeMaxSelect = document.getElementById('rangeMax');
                rangeMinSelect.value = '55'; // G3
                rangeMaxSelect.value = '67'; // G4

                // ÈÄâÊã©ÊâÄÊúâË∞±Âè∑ËÆ©Á≥ªÁªüÈöèÊú∫ÈÄâÊã©
                const trebleCheckbox = document.getElementById('clef-treble');
                const bassCheckbox = document.getElementById('clef-bass');
                const altoCheckbox = document.getElementById('clef-alto');

                if (trebleCheckbox) trebleCheckbox.checked = true;
                if (bassCheckbox) bassCheckbox.checked = true;
                if (altoCheckbox) altoCheckbox.checked = true;

                console.log('1. Èü≥Á®ãÊòØÂê¶‰ΩøÁî®ÂΩìÂâçÁöÑ G3-G4 Èü≥Âüü');
                console.log('2. ÁîüÊàêÂêéUIÊòØÂê¶ÂàáÊç¢Âà∞ÂÆûÈôÖÁîüÊàêË∞±Âè∑ÁöÑÈªòËÆ§Èü≥Âüü');

                // ÁîüÊàêÈü≥Á®ã
                setTimeout(() => {
                    if (typeof window.generateIntervals === 'function') {
                        window.generateIntervals().then(() => {
                            // Ê£ÄÊü•ÊúÄÁªàÈü≥ÂüüUI
                            setTimeout(() => {
                                const finalMin = document.getElementById('rangeMin').value;
                                const finalMax = document.getElementById('rangeMax').value;
                                console.groupEnd();
                            }, 500);
                        }).catch(error => {
                            console.error('‚ùå ÁîüÊàêÂ§±Ë¥•:', error);
                            console.groupEnd();
                        });
                    }
                }, 1000);
            };

            // üß™ ÊµãËØïË∞±Âè∑Ê®°ÊÄÅÊ°ÜÁõëÂê¨Âô®ÁªëÂÆö
            window.testModalListeners = function() {
                console.group('üéº ÊµãËØïË∞±Âè∑Ê®°ÊÄÅÊ°ÜÁõëÂê¨Âô®ÁªëÂÆö');
                console.log('ÊµãËØïÂú∫ÊôØÔºöÊâìÂºÄË∞±Âè∑ËÆæÁΩÆÊ®°ÊÄÅÊ°ÜÔºåÊ£ÄÊü•‰∫ã‰ª∂ÁõëÂê¨Âô®ÊòØÂê¶Ê≠£Á°ÆÁªëÂÆö');

                // ÊâìÂºÄË∞±Âè∑ËÆæÁΩÆÊ®°ÊÄÅÊ°Ü
                openClefSettings();

                // Á≠âÂæÖÊ®°ÊÄÅÊ°ÜÂÆåÂÖ®ÊòæÁ§∫ÂíåÁõëÂê¨Âô®ÁªëÂÆö
                setTimeout(() => {
                    const clefCheckboxes = document.querySelectorAll('#clefModal input[type="checkbox"]');

                    if (clefCheckboxes.length > 0) {

                        // ÊµãËØïÊâãÂä®Ëß¶Âèë‰∫ã‰ª∂
                        const trebleCheckbox = document.getElementById('clef-treble');
                        const bassCheckbox = document.getElementById('clef-bass');

                        if (trebleCheckbox && bassCheckbox) {
                            trebleCheckbox.checked = false;
                            bassCheckbox.checked = true;

                            // ÊâãÂä®Ëß¶Âèëchange‰∫ã‰ª∂
                            bassCheckbox.dispatchEvent(new Event('change'));

                            setTimeout(() => {
                                const rangeMin = document.getElementById('rangeMin').value;
                                const rangeMax = document.getElementById('rangeMax').value;
                                const minNote = window.intervalSettings.midiToNote(parseInt(rangeMin));
                                const maxNote = window.intervalSettings.midiToNote(parseInt(rangeMax));
                                console.log(`ÊúüÊúõÈü≥Âüü: E2-E4 (MIDI: 40-64)`);

                                bassCheckbox.checked = false;
                                trebleCheckbox.checked = true;
                                trebleCheckbox.dispatchEvent(new Event('change'));

                                setTimeout(() => {
                                    const newRangeMin = document.getElementById('rangeMin').value;
                                    const newRangeMax = document.getElementById('rangeMax').value;
                                    const newMinNote = window.intervalSettings.midiToNote(parseInt(newRangeMin));
                                    const newMaxNote = window.intervalSettings.midiToNote(parseInt(newRangeMax));
                                    console.log(`ÊúüÊúõÈü≥Âüü: C4-C5 (MIDI: 60-72)`);

                                    console.groupEnd();

                                    alert('‚úÖ Ê®°ÊÄÅÊ°ÜÁõëÂê¨Âô®ÊµãËØïÂÆåÊàêÔºÅ\nËØ∑Êü•ÁúãÊéßÂà∂Âè∞Êü•ÁúãËØ¶ÁªÜÁªìÊûú„ÄÇ');
                                }, 300);
                            }, 300);
                        } else {
                            console.error('‚ùå Êú™ÊâæÂà∞È´òÈü≥Ë∞±Âè∑Êàñ‰ΩéÈü≥Ë∞±Âè∑Â§çÈÄâÊ°Ü');
                            console.groupEnd();
                        }
                    } else {
                        console.error('‚ùå Ê®°ÊÄÅÊ°Ü‰∏≠Êú™ÊâæÂà∞Ë∞±Âè∑Â§çÈÄâÊ°Ü');
                        console.groupEnd();
                    }
                }, 200); // Á≠âÂæÖÁõëÂê¨Âô®ÁªëÂÆöÂÆåÊàê
            };

            // üß™ Ê∑ªÂä†ÂÆûÊó∂Ë∞±Âè∑ÂàáÊç¢ÊµãËØï
            window.testRealtimeClefSwitching = function() {
                console.group('üéº ÊµãËØïÂÆûÊó∂Ë∞±Âè∑ÂàáÊç¢ÂäüËÉΩ');
                console.log('ÊµãËØïÂú∫ÊôØÔºöÊâãÂä®ÂãæÈÄâ/ÂèñÊ∂àÂãæÈÄâË∞±Âè∑ÔºåÈ™åËØÅÈü≥ÂüüÊòØÂê¶Á´ãÂç≥Êõ¥Êñ∞');

                // ÊòæÁ§∫ÂΩìÂâçÁä∂ÊÄÅ
                const rangeMin = document.getElementById('rangeMin').value;
                const rangeMax = document.getElementById('rangeMax').value;

                // Ëé∑ÂèñÊâÄÊúâË∞±Âè∑Â§çÈÄâÊ°Ü
                const trebleCheckbox = document.getElementById('clef-treble');
                const bassCheckbox = document.getElementById('clef-bass');
                const altoCheckbox = document.getElementById('clef-alto');

                if (trebleCheckbox && bassCheckbox && altoCheckbox) {
                    // Ê≠•È™§1ÔºöÊ∏ÖÈô§ÊâÄÊúâÈÄâÊã©ÔºåÁÑ∂ÂêéÂè™ÈÄâÊã©‰ΩéÈü≥Ë∞±Âè∑
                    trebleCheckbox.checked = false;
                    altoCheckbox.checked = false;
                    bassCheckbox.checked = true;
                    bassCheckbox.dispatchEvent(new Event('change')); // Ëß¶Âèëchange‰∫ã‰ª∂

                    setTimeout(() => {
                        const newMin = document.getElementById('rangeMin').value;
                        const newMax = document.getElementById('rangeMax').value;

                        // Ê≠•È™§2ÔºöÂàáÊç¢Âà∞È´òÈü≥Ë∞±Âè∑
                        bassCheckbox.checked = false;
                        trebleCheckbox.checked = true;
                        trebleCheckbox.dispatchEvent(new Event('change'));

                        setTimeout(() => {
                            const trebleMin = document.getElementById('rangeMin').value;
                            const trebleMax = document.getElementById('rangeMax').value;

                            // Ê≠•È™§3ÔºöÂàáÊç¢Âà∞‰∏≠Èü≥Ë∞±Âè∑
                            trebleCheckbox.checked = false;
                            altoCheckbox.checked = true;
                            altoCheckbox.dispatchEvent(new Event('change'));

                            setTimeout(() => {
                                const altoMin = document.getElementById('rangeMin').value;
                                const altoMax = document.getElementById('rangeMax').value;

                                console.groupEnd();

                                alert('‚úÖ ÂÆûÊó∂Ë∞±Âè∑ÂàáÊç¢ÊµãËØïÂÆåÊàêÔºÅ\nÈü≥ÂüüÂ∫îËØ•Ê†πÊçÆË∞±Âè∑ÈÄâÊã©Á´ãÂç≥Êõ¥Êñ∞„ÄÇ\nËØ∑Êü•ÁúãÊéßÂà∂Âè∞ËØ¶ÁªÜÊó•Âøó„ÄÇ');
                            }, 300);
                        }, 300);
                    }, 300);
                } else {
                    console.error('‚ùå Êú™ÊâæÂà∞Ë∞±Âè∑Â§çÈÄâÊ°Ü');
                    console.groupEnd();
                }
            };

            // üß™ ÊµãËØïÁÆÄÂåñÂêéÁöÑÈü≥ÂüüËÆæÁΩÆÈÄªËæë
            window.testSimplifiedRangeSetting = function() {
                console.group('üéº ÊµãËØïÁÆÄÂåñÂêéÁöÑÈü≥ÂüüËÆæÁΩÆÈÄªËæë');
                console.log('ÊµãËØïÂú∫ÊôØÔºöÊØèÊ¨°ÁîüÊàêÂêéÔºåÈü≥ÂüüÊó†Êù°‰ª∂ËÆæÁΩÆ‰∏∫ÁîüÊàêË∞±Âè∑ÁöÑÈªòËÆ§Èü≥Âüü');

                let testCount = 0;
                const maxTests = 3;

                function runSingleTest() {
                    testCount++;

                    // ÊòæÁ§∫ÁîüÊàêÂâçÁä∂ÊÄÅ
                    const beforeMin = document.getElementById('rangeMin').value;
                    const beforeMax = document.getElementById('rangeMax').value;
                    const beforeMinNote = window.intervalSettings.midiToNote(parseInt(beforeMin));
                    const beforeMaxNote = window.intervalSettings.midiToNote(parseInt(beforeMax));
                    console.log(`ÁîüÊàêÂâçÈü≥Âüü: ${beforeMinNote}-${beforeMaxNote} (MIDI: ${beforeMin}-${beforeMax})`);

                    // Á°Æ‰øùÈÄâÊã©‰∫ÜÂ§ö‰∏™Ë∞±Âè∑
                    const trebleCheckbox = document.getElementById('clef-treble');
                    const bassCheckbox = document.getElementById('clef-bass');
                    const altoCheckbox = document.getElementById('clef-alto');

                    if (trebleCheckbox) trebleCheckbox.checked = true;
                    if (bassCheckbox) bassCheckbox.checked = true;
                    if (altoCheckbox) altoCheckbox.checked = true;

                    // ÁîüÊàêÈü≥Á®ã

                    if (typeof window.generateIntervals === 'function') {
                        window.generateIntervals().then(() => {
                            // Á≠âÂæÖÈü≥ÂüüËÆæÁΩÆÂÆåÊàê
                            setTimeout(() => {
                                const afterMin = document.getElementById('rangeMin').value;
                                const afterMax = document.getElementById('rangeMax').value;
                                const afterMinNote = window.intervalSettings.midiToNote(parseInt(afterMin));
                                const afterMaxNote = window.intervalSettings.midiToNote(parseInt(afterMax));
                                const generatedClef = window.currentActiveClef;

                                console.log(`ÁîüÊàêÂêéÈü≥Âüü: ${afterMinNote}-${afterMaxNote} (MIDI: ${afterMin}-${afterMax})`);
                                console.log(`ÁîüÊàêÁöÑË∞±Âè∑: ${generatedClef}`);

                                // È™åËØÅÈü≥ÂüüÊòØÂê¶ÂåπÈÖç
                                const expectedRanges = {
                                    'treble': { min: 60, max: 72, name: 'C4-C5' },
                                    'bass': { min: 40, max: 64, name: 'E2-E4' },
                                    'alto': { min: 48, max: 67, name: 'C3-G4' }
                                };

                                const expected = expectedRanges[generatedClef];
                                if (expected &&
                                    parseInt(afterMin) === expected.min &&
                                    parseInt(afterMax) === expected.max) {
                                } else {
                                    console.log(`‚ùå Èü≥Âüü‰∏çÂåπÈÖçÔºåÊúüÊúõ: ${expected ? expected.name : 'Êú™Áü•'}ÔºåÂÆûÈôÖ: ${afterMinNote}-${afterMaxNote}`);
                                }

                                // ÁªßÁª≠‰∏ã‰∏ÄÊ¨°ÊµãËØïÊàñÁªìÊùü
                                if (testCount < maxTests) {
                                    setTimeout(() => runSingleTest(), 1000);
                                } else {
                                    console.log('Ê†∏ÂøÉÈ™åËØÅÔºöÊØèÊ¨°ÁîüÊàêÂêéÈü≥ÂüüÈÉΩÂ∫îËØ•Ëá™Âä®ËÆæÁΩÆ‰∏∫ËØ•Ê¨°ÁîüÊàêË∞±Âè∑ÁöÑÈªòËÆ§Èü≥Âüü');
                                    console.groupEnd();

                                    alert(`‚úÖ ÁÆÄÂåñÈÄªËæëÊµãËØïÂÆåÊàêÔºÅ\nËøõË°å‰∫Ü${maxTests}Ê¨°ÊµãËØïÔºåËØ∑Êü•ÁúãÊéßÂà∂Âè∞‰∫ÜËß£ËØ¶ÁªÜÁªìÊûú„ÄÇ\nÊØèÊ¨°ÁîüÊàêÂêéÈü≥ÂüüÈÉΩÂ∫îËØ•ËÆæÁΩÆ‰∏∫ÂØπÂ∫îË∞±Âè∑ÁöÑÈªòËÆ§Èü≥Âüü„ÄÇ`);
                                }
                            }, 800); // Á≠âÂæÖÈü≥ÂüüËÆæÁΩÆÂÆåÊàê
                        }).catch(error => {
                            console.error('‚ùå ÁîüÊàêÂ§±Ë¥•:', error);
                            console.groupEnd();
                        });
                    } else {
                        console.error('‚ùå generateIntervals ÂáΩÊï∞‰∏çÂ≠òÂú®');
                        console.groupEnd();
                    }
                }

                // ÂºÄÂßãÁ¨¨‰∏ÄÊ¨°ÊµãËØï
                runSingleTest();
            };

            // üß™ ÊµãËØïÁîüÊàêÊó∂Ë∞±Âè∑ÂèòÂåñÁöÑÈü≥ÂüüËá™Âä®Ë∞ÉÊï¥
            window.testGeneratedClefSwitching = function() {
                console.group('üéº ÊµãËØïÁîüÊàêÊó∂Ë∞±Âè∑ÂèòÂåñÁöÑÈü≥ÂüüËá™Âä®Ë∞ÉÊï¥');
                console.log('ÊµãËØïÂú∫ÊôØÔºöÁîüÊàêÈü≥Á®ãÊó∂Â¶ÇÊûúË∞±Âè∑ÂèòÂåñÔºåÈü≥ÂüüÂ∫îÁ´ãÂç≥Ë∞ÉÊï¥');

                // ÊòæÁ§∫ÂàùÂßãÁä∂ÊÄÅ
                const initialMin = document.getElementById('rangeMin').value;
                const initialMax = document.getElementById('rangeMax').value;
                const initialMinNote = window.intervalSettings.midiToNote(parseInt(initialMin));
                const initialMaxNote = window.intervalSettings.midiToNote(parseInt(initialMax));

                // ÈÄâÊã©Â§ö‰∏™Ë∞±Âè∑ËÆ©Á≥ªÁªüÈöèÊú∫ÈÄâÊã©
                const trebleCheckbox = document.getElementById('clef-treble');
                const bassCheckbox = document.getElementById('clef-bass');
                const altoCheckbox = document.getElementById('clef-alto');

                // Á°Æ‰øùÈÄâÊã©‰∫ÜÂ§ö‰∏™Ë∞±Âè∑
                if (trebleCheckbox) trebleCheckbox.checked = true;
                if (bassCheckbox) bassCheckbox.checked = true;
                if (altoCheckbox) altoCheckbox.checked = true;


                // ÁîüÊàêÈü≥Á®ã

                if (typeof window.generateIntervals === 'function') {
                    window.generateIntervals().then(() => {
                        // Á≠âÂæÖ‰∏ÄÊÆµÊó∂Èó¥Á°Æ‰øùÈü≥ÂüüË∞ÉÊï¥ÂÆåÊàê
                        setTimeout(() => {
                            const finalMin = document.getElementById('rangeMin').value;
                            const finalMax = document.getElementById('rangeMax').value;
                            const finalMinNote = window.intervalSettings.midiToNote(parseInt(finalMin));
                            const finalMaxNote = window.intervalSettings.midiToNote(parseInt(finalMax));


                            // Ê£ÄÊü•Èü≥ÂüüÊòØÂê¶ÂåπÈÖçË∞±Âè∑
                            const expectedRanges = {
                                'treble': { min: 60, max: 72, name: 'C4-C5' },
                                'bass': { min: 40, max: 64, name: 'E2-E4' },
                                'alto': { min: 48, max: 67, name: 'C3-G4' }
                            };

                            const currentClef = window.currentActiveClef;
                            const expectedRange = expectedRanges[currentClef];

                            if (expectedRange &&
                                parseInt(finalMin) === expectedRange.min &&
                                parseInt(finalMax) === expectedRange.max) {
                            } else {
                                console.log(`‚ö†Ô∏è Èü≥Âüü‰∏çÂåπÈÖçÈ¢ÑÊúüÔºåÂΩìÂâç: ${finalMinNote}-${finalMaxNote}ÔºåÊúüÊúõ: ${expectedRange ? expectedRange.name : 'Êú™Áü•'}`);
                            }

                            console.groupEnd();

                            alert('‚úÖ ÁîüÊàêÊó∂Ë∞±Âè∑ÂèòÂåñÊµãËØïÂÆåÊàêÔºÅ\nËØ∑Êü•ÁúãÊéßÂà∂Âè∞‰∫ÜËß£ËØ¶ÁªÜÁªìÊûú„ÄÇ\nÂ¶ÇÊûúÁîüÊàêÁöÑË∞±Âè∑ÂèëÁîüÂèòÂåñÔºåÈü≥ÂüüÂ∫îËØ•Ëá™Âä®Ë∞ÉÊï¥„ÄÇ');
                        }, 1000); // Á≠âÂæÖÈü≥ÂüüË∞ÉÊï¥ÂÆåÊàê
                    }).catch(error => {
                        console.error('‚ùå ÁîüÊàêÂ§±Ë¥•:', error);
                        console.groupEnd();
                    });
                } else {
                    console.error('‚ùå generateIntervals ÂáΩÊï∞‰∏çÂ≠òÂú®');
                    console.groupEnd();
                }
            };

            // üß™ Ê∑ªÂä†ÁîüÊàêÊó∂Èü≥ÂüüÂàáÊç¢ÊµãËØï
            window.testGenerationSwitching = function() {
                console.group('üéº ÊµãËØïÈü≥Á®ãÁîüÊàêÊó∂ÁöÑËá™Âä®Èü≥ÂüüÂàáÊç¢');
                console.log('ÊµãËØïÂú∫ÊôØÔºöÈÄâÊã©‰∏çÂêåË∞±Âè∑Âπ∂ÁîüÊàêÈü≥Á®ãÔºåÈ™åËØÅÈü≥ÂüüÊòØÂê¶Ëá™Âä®ÂàáÊç¢');

                // Ê®°ÊãüÈÄâÊã©‰ΩéÈü≥Ë∞±Âè∑Âπ∂ÁîüÊàê
                const bassCheckbox = document.getElementById('clef-bass');
                const trebleCheckbox = document.getElementById('clef-treble');
                const altoCheckbox = document.getElementById('clef-alto');

                // Ê∏ÖÈô§ÊâÄÊúâÈÄâÊã©
                if (trebleCheckbox) trebleCheckbox.checked = false;
                if (altoCheckbox) altoCheckbox.checked = false;
                if (bassCheckbox) {
                    bassCheckbox.checked = true;

                    // ÊòæÁ§∫ÂΩìÂâçÈü≥Âüü
                    const rangeMin = document.getElementById('rangeMin').value;
                    const rangeMax = document.getElementById('rangeMax').value;

                    console.log('üí° ÊàñËÄÖÂú®ÊéßÂà∂Âè∞ËøêË°å generateIntervals() Êù•Ëß¶ÂèëÁîüÊàê');

                    // Ëá™Âä®Ëß¶ÂèëÁîüÊàêÊµãËØï
                    setTimeout(() => {
                        if (typeof window.generateIntervals === 'function') {
                            window.generateIntervals();
                        }
                    }, 2000);
                } else {
                    console.warn('‚ö†Ô∏è Êú™ÊâæÂà∞‰ΩéÈü≥Ë∞±Âè∑Â§çÈÄâÊ°Ü');
                }

                console.groupEnd();
            };

            // üß™ ÊµãËØïÁî®Êà∑Êèê‰æõÁöÑÈü≥Âüü‰øùÂ≠òÂáΩÊï∞
            window.testUserFunctions = function() {
                console.group('üß™ ÊµãËØïÁî®Êà∑Êèê‰æõÁöÑÈü≥Âüü‰øùÂ≠òÂáΩÊï∞');
                console.log('ÊµãËØïÂú∫ÊôØÔºöÈ™åËØÅ saveRangeForCurrentClef() Âíå loadRangeForClef() ÂáΩÊï∞');

                // Ê≠•È™§1ÔºöÂàáÊç¢Âà∞‰ΩéÈü≥Ë∞±Âè∑
                window.switchToClefRange('bass');
                console.log(`ÂΩìÂâçÊ¥ªË∑ÉË∞±Âè∑: ${window.currentActiveClef}`);

                // Ê≠•È™§2Ôºö‰øÆÊîπÈü≥Âüü
                setTimeout(() => {
                    const rangeMinSelect = document.getElementById('rangeMin');
                    const rangeMaxSelect = document.getElementById('rangeMax');
                    rangeMinSelect.value = '41'; // F2
                    rangeMaxSelect.value = '65'; // F4

                    // Ê≠•È™§3ÔºöË∞ÉÁî®Áî®Êà∑ÂáΩÊï∞‰øùÂ≠ò
                    window.saveRangeForCurrentClef();

                    // Ê≠•È™§4ÔºöÊ£ÄÊü•ÂÜÖÂ≠òÁä∂ÊÄÅ
                    console.log('clefRangeMemory:', window.clefRangeMemory);

                    // Ê≠•È™§5ÔºöÂàáÊç¢Âà∞ÂÖ∂‰ªñË∞±Âè∑ÂÜçÂàáÊç¢ÂõûÊù•ÊµãËØïÂä†ËΩΩ
                    setTimeout(() => {
                        window.switchToClefRange('treble');

                        setTimeout(() => {
                            window.currentActiveClef = 'bass';
                            window.loadRangeForClef('bass');

                            const finalMin = document.getElementById('rangeMin').value;
                            const finalMax = document.getElementById('rangeMax').value;

                            console.groupEnd();
                        }, 1000);
                    }, 1000);
                }, 1000);
            };

            // üß™ ÊµãËØïÂÆåÊï¥ÁöÑÊñ∞ÂáΩÊï∞Á≥ªÁªü
            window.testNewFunctionSystem = function() {
                console.group('üß™ ÊµãËØïÂÆåÊï¥ÁöÑÊñ∞ÂáΩÊï∞Á≥ªÁªü');
                console.log('ÊµãËØïÂú∫ÊôØÔºöÈ™åËØÅÊâÄÊúâÊñ∞Ê∑ªÂä†ÁöÑÁî®Êà∑ÂáΩÊï∞');

                console.log('ÊµãËØïÂêÑË∞±Âè∑ÁöÑÈªòËÆ§Èü≥ÂüüËÆæÁΩÆ...');

                // ÊµãËØïÈ´òÈü≥Ë∞±Âè∑
                window.setRangeForClef('treble');
                let currentMin = document.getElementById('rangeMin').value;
                let currentMax = document.getElementById('rangeMax').value;

                setTimeout(() => {
                    // ÊµãËØï‰ΩéÈü≥Ë∞±Âè∑
                    window.setRangeForClef('bass');
                    currentMin = document.getElementById('rangeMin').value;
                    currentMax = document.getElementById('rangeMax').value;

                    setTimeout(() => {
                        // ÊµãËØï‰∏≠Èü≥Ë∞±Âè∑
                        window.setRangeForClef('alto');
                        currentMin = document.getElementById('rangeMin').value;
                        currentMax = document.getElementById('rangeMax').value;

                        setTimeout(() => {

                            // ‰øÆÊîπ‰∏≠Èü≥Ë∞±Âè∑Èü≥ÂüüÂπ∂‰øùÂ≠ò (ÊµãËØïËá™ÂÆö‰πâÈü≥Âüü)
                            document.getElementById('rangeMin').value = '45'; // A2
                            document.getElementById('rangeMax').value = '69'; // A4

                            // ÊâãÂä®‰øùÂ≠ò
                            window.saveRangeForCurrentClef();

                            // ÂàáÊç¢Âà∞ÂÖ∂‰ªñË∞±Âè∑
                            window.setRangeForClef('treble');
                            console.log('üîÑ ÂàáÊç¢Âà∞È´òÈü≥Ë∞±Âè∑');

                            // ÂàáÊç¢Âõû‰∏≠Èü≥Ë∞±Âè∑È™åËØÅËÆ∞ÂøÜ
                            setTimeout(() => {
                                window.setRangeForClef('alto');
                                const finalMin = document.getElementById('rangeMin').value;
                                const finalMax = document.getElementById('rangeMax').value;

                                console.log('clefRangeMemory:', window.clefRangeMemory);

                                console.groupEnd();
                            }, 1000);
                        }, 1000);
                    }, 1000);
                }, 1000);
            };

            // üß™ ÊµãËØïÁî®Êà∑ÁöÑÂÖ∑‰ΩìÈúÄÊ±Ç - ÁîüÊàêÂêéËá™Âä®ÂàáÊç¢Âà∞ÈªòËÆ§Èü≥Âüü
            window.testUserRequirement = function() {
                console.group('üéØ ÊµãËØïÁî®Êà∑ÂÖ∑‰ΩìÈúÄÊ±ÇÔºöÁîüÊàêÂêéËá™Âä®ÂàáÊç¢Âà∞Ë∞±Âè∑ÈªòËÆ§Èü≥Âüü');
                console.log('ÈúÄÊ±ÇÈ™åËØÅÔºöÁîüÊàêÈü≥Á®ã ‚Üí ‰ΩøÁî®ÂΩìÂâçÈü≥Âüü ‚Üí ÁîüÊàêÂêéÂàáÊç¢Âà∞ÂÆûÈôÖË∞±Âè∑ÁöÑÈªòËÆ§Èü≥Âüü');

                // Ê≠•È™§1ÔºöÊâãÂä®ËÆæÁΩÆ‰∏Ä‰∏™ÈùûÈªòËÆ§Èü≥Âüü
                const rangeMinSelect = document.getElementById('rangeMin');
                const rangeMaxSelect = document.getElementById('rangeMax');
                rangeMinSelect.value = '53'; // F3
                rangeMaxSelect.value = '65'; // F4

                // Ê≠•È™§2ÔºöÈÄâÊã©ÊâÄÊúâË∞±Âè∑ËÆ©Á≥ªÁªüÈöèÊú∫ÈÄâÊã©
                const trebleCheckbox = document.getElementById('clef-treble');
                const bassCheckbox = document.getElementById('clef-bass');
                const altoCheckbox = document.getElementById('clef-alto');

                if (trebleCheckbox) trebleCheckbox.checked = true;
                if (bassCheckbox) bassCheckbox.checked = true;
                if (altoCheckbox) altoCheckbox.checked = true;

                // Ê≠•È™§3ÔºöÁîüÊàêÈü≥Á®ã
                console.log('È¢ÑÊúüÁªìÊûúÔºö');
                console.log('1. Èü≥Á®ã‰ΩøÁî®ÂΩìÂâçÁöÑ F3-F4 Èü≥ÂüüÁîüÊàê');
                console.log('2. ÁîüÊàêÂÆåÊàêÂêéUIËá™Âä®ÂàáÊç¢Âà∞ÂÆûÈôÖÁîüÊàêË∞±Âè∑ÁöÑÈªòËÆ§Èü≥Âüü');
                console.log('3. ‰æãÂ¶ÇÁîüÊàê‰∫Ü‰ΩéÈü≥Ë∞±Âè∑ÔºåUIÂ∫îÂàáÊç¢Âà∞ E2-E4');

                setTimeout(() => {
                    if (typeof window.generateIntervals === 'function') {
                        window.generateIntervals().then(() => {
                            // Ê£ÄÊü•ÁîüÊàêÂêéÁöÑÈü≥ÂüüUI
                            setTimeout(() => {
                                const finalMin = document.getElementById('rangeMin').value;
                                const finalMax = document.getElementById('rangeMax').value;
                                const minNote = window.intervalSettings.midiToNote(parseInt(finalMin));
                                const maxNote = window.intervalSettings.midiToNote(parseInt(finalMax));


                                // Âà§Êñ≠ÊòØÂê¶ÂàáÊç¢Âà∞‰∫ÜÊ≠£Á°ÆÁöÑÈªòËÆ§Èü≥Âüü
                                const expectedRanges = {
                                    'treble': '60-72', // C4-C5
                                    'bass': '40-64',   // E2-E4
                                    'alto': '48-67'    // C3-G4
                                };

                                const currentRange = `${finalMin}-${finalMax}`;
                                const matchedClef = Object.keys(expectedRanges).find(clef =>
                                    expectedRanges[clef] === currentRange
                                );

                                if (matchedClef) {
                                } else {
                                    console.log(`‚ö†Ô∏è UIÈü≥Âüü ${currentRange} ‰∏çÂåπÈÖç‰ªª‰ΩïÈªòËÆ§Èü≥Âüü`);
                                }

                                console.groupEnd();
                            }, 500);
                        }).catch(error => {
                            console.error('‚ùå ÁîüÊàêÂ§±Ë¥•:', error);
                            console.groupEnd();
                        });
                    }
                }, 1000);
            };

            // üß™ ÂºÄÂèëËÄÖÊéßÂà∂Âè∞ËØ¥Êòé
            console.group('üéº Ë∞±Âè∑-Èü≥ÂüüÊô∫ËÉΩÁªëÂÆöÁ≥ªÁªüÊµãËØïÊåáÂçó');
            console.log('ÂèØÁî®ÊµãËØïÂáΩÊï∞:');
            console.log('‚Ä¢ testUserFunctions() - üÜï ÊµãËØïÁî®Êà∑Êèê‰æõÁöÑÈü≥Âüü‰øùÂ≠òÂáΩÊï∞');
            console.log('‚Ä¢ testNewLogic() - üÜï ÊµãËØïÊñ∞ÁöÑÈü≥Á®ãÁîüÊàêÈÄªËæë');
            console.log('‚Ä¢ testGenerationSwitching() - ÊµãËØïÁîüÊàêÊó∂Ëá™Âä®Èü≥ÂüüÂàáÊç¢');
            console.log('‚Ä¢ testClefRangeSwitching() - ÊµãËØïËá™Âä®Èü≥ÂüüÂàáÊç¢');
            console.log('‚Ä¢ testUserCustomRange() - ÊµãËØïÁî®Êà∑Ëá™ÂÆö‰πâÈü≥ÂüüÁªëÂÆö');
            console.log('‚Ä¢ showClefBindingStatus() - Êü•ÁúãÂΩìÂâçÁªëÂÆöÁä∂ÊÄÅ');
            console.log('‚Ä¢ switchToClefRange("treble"|"bass"|"alto") - ÊâãÂä®ÂàáÊç¢Ë∞±Âè∑');
            console.log('‚Ä¢ saveRangeForCurrentClef() - ‰øùÂ≠òÂΩìÂâçË∞±Âè∑ÁöÑÈü≥ÂüüËÆæÁΩÆ');
            console.log('‚Ä¢ loadRangeForClef(clef) - Âä†ËΩΩÊåáÂÆöË∞±Âè∑ÁöÑÈü≥ÂüüËÆæÁΩÆ');
            console.log('‚Ä¢ initRangeListeners() - ÂàùÂßãÂåñÈü≥ÂüüÁõëÂê¨Âô®');
            console.log('‚Ä¢ setRangeForClef(clef) - Ê†πÊçÆË∞±Âè∑ËÆæÁΩÆÂêàÈÄÇÁöÑÈü≥Âüü');
            console.log('‚Ä¢ È´òÈü≥Ë∞±Âè∑ÈªòËÆ§: C4-C5 (60-72) ‚Üê ‰∏éÂíåÂº¶ËßÜÂ•èÂ∑•ÂÖ∑‰∏ÄËá¥');
            console.log('‚Ä¢ ‰ΩéÈü≥Ë∞±Âè∑ÈªòËÆ§: E2-E4 (40-64) ‚Üê ‰∏éÂíåÂº¶ËßÜÂ•èÂ∑•ÂÖ∑‰∏ÄËá¥');
            console.log('‚Ä¢ ‰∏≠Èü≥Ë∞±Âè∑ÈªòËÆ§: C3-G4 (48-67) ‚Üê ÂêàÁêÜÁöÑ‰∏≠Èü≥Ë∞±Âè∑Èü≥Âüü');
            console.log('‚Ä¢ ÁîüÊàêÈü≥Á®ã‰ΩøÁî®ÂΩìÂâçUIÈü≥ÂüüËÆæÁΩÆ');
            console.log('‚Ä¢ ÁîüÊàêÂÆåÊàêÂêé‚ÜíÊ†πÊçÆÂÆûÈôÖÁîüÊàêÁöÑË∞±Âè∑ÂàáÊç¢Èü≥ÂüüUI');
            console.log('‚Ä¢ Áî®Êà∑Ë∞ÉÊï¥Èü≥Âüü‚ÜíËá™Âä®ÁªëÂÆöÂà∞ÂΩìÂâçË∞±Âè∑ÔºåÊàê‰∏∫ËØ•Ë∞±Âè∑Âõ∫ÂÆöÈü≥Âüü');
            console.log('‚Ä¢ ÂêÑË∞±Âè∑Èü≥ÂüüÂÆåÂÖ®Áã¨Á´ãÔºå‰∫í‰∏çÂΩ±Âìç');
            console.groupEnd();
        });

        // ÈáçÂÜôÊ®°ÊÄÅÊ°ÜÂÖ≥Èó≠ÂáΩÊï∞‰ª•ÈáçÁΩÆÂÖ®ÈÄâÁä∂ÊÄÅ
        const originalCloseRhythmSettings = window.closeRhythmSettings;
        const originalCloseArticulationSettings = window.closeArticulationSettings;
        const originalCloseKeySettings = window.closeKeySettings;
        const originalCloseTimeSignatureSettings = window.closeTimeSignatureSettings;
        const originalCloseIntervalSettings = window.closeIntervalSettings;
        const originalCloseClefSettings = window.closeClefSettings;

        if (typeof originalCloseRhythmSettings === 'function') {
            window.closeRhythmSettings = function() {
                originalCloseRhythmSettings();
                if (typeof resetSelectAllStates === 'function') resetSelectAllStates();
            };
        }

        if (typeof originalCloseArticulationSettings === 'function') {
            window.closeArticulationSettings = function() {
                originalCloseArticulationSettings();
                if (typeof resetSelectAllStates === 'function') resetSelectAllStates();
            };
        }

        if (typeof originalCloseKeySettings === 'function') {
            window.closeKeySettings = function() {
                originalCloseKeySettings();
                if (typeof resetSelectAllStates === 'function') resetSelectAllStates();
            };
        }

        if (typeof originalCloseTimeSignatureSettings === 'function') {
            window.closeTimeSignatureSettings = function() {
                originalCloseTimeSignatureSettings();
                if (typeof resetSelectAllStates === 'function') resetSelectAllStates();
            };
        }

        if (typeof originalCloseIntervalSettings === 'function') {
            window.closeIntervalSettings = function() {
                originalCloseIntervalSettings();
                if (typeof resetSelectAllStates === 'function') resetSelectAllStates();
            };
        }

        if (typeof originalCloseClefSettings === 'function') {
            window.closeClefSettings = function() {
                originalCloseClefSettings();
                if (typeof resetSelectAllStates === 'function') resetSelectAllStates();
            };
        }

        // Âä®ÊÄÅÈöêËóèÂåÖÂê´ÁâπÂÆöÊñáÊú¨ÁöÑSVGÂÖÉÁ¥†
        function hideTitleAndInstrumentElements() {
            // Á≠âÂæÖ‰∏Ä‰ºöÂÑøËÆ©OSMDÊ∏≤ÊüìÂÆåÊàê
            setTimeout(() => {
                const scoreDiv = document.getElementById('score');
                if (scoreDiv) {
                    // Êü•ÊâæÊâÄÊúâSVG textÂÖÉÁ¥†
                    const textElements = scoreDiv.querySelectorAll('svg text');
                    textElements.forEach(element => {
                        const text = element.textContent || element.innerText;
                        if (text && (
                            text.includes('Piano') || 
                            text.includes('Untitled') || 
                            text.includes('Untitled Score') ||
                            text.trim() === 'Piano' ||
                            text.trim() === 'Untitled Score'
                        )) {
                            element.style.display = 'none';
                            element.style.visibility = 'hidden';
                            console.log('ÈöêËóèÊñáÊú¨ÂÖÉÁ¥†:', text);
                        }
                    });
                    
                    // ‰πüÊ£ÄÊü•ÂÖ∂‰ªñÂèØËÉΩÁöÑÂÖÉÁ¥†
                    const allElements = scoreDiv.querySelectorAll('*');
                    allElements.forEach(element => {
                        const text = element.textContent || element.innerText;
                        if (text && element.tagName !== 'SCRIPT' && (
                            text.trim() === 'Piano' ||
                            text.trim() === 'Untitled Score'
                        )) {
                            element.style.display = 'none';
                            element.style.visibility = 'hidden';
                            console.log('ÈöêËóèÂÖÉÁ¥†:', element.tagName, text);
                        }
                    });
                }
            }, 500);
        }
        
        // Ê∏ÖÈô§Á©∫Ë∞±Â≠êÊèêÁ§∫‰ø°ÊÅØ
        function clearEmptyScoreMessage() {
            const scoreDiv = document.getElementById('score');
            if (scoreDiv) {
                const emptyMessage = scoreDiv.querySelector('.empty-score-message');
                if (emptyMessage) {
                    emptyMessage.remove();
                }
            }
        }

        // ÁõëÂê¨OSMDÊ∏≤ÊüìÂÆåÊàê
        const originalGenerateIntervals = window.generateIntervals;
        if (originalGenerateIntervals) {
            window.generateIntervals = function(...args) {
                // üéµ Ëá™Âä®ÂÅúÊ≠¢ÂΩìÂâçÊí≠Êîæ
                if (typeof window.isPlayingInterval !== 'undefined' && window.isPlayingInterval) {
                    window.isPlayingInterval = false;
                    if (window.intervalScheduledSounds) {
                        window.intervalScheduledSounds.forEach(sound => {
                            try {
                                if (sound.oscillator) sound.oscillator.stop();
                                if (sound.source) sound.source.stop();
                                if (sound.element) {
                                    sound.element.pause();
                                    sound.element.src = '';
                                }
                            } catch (e) {}
                        });
                        window.intervalScheduledSounds = [];
                    }
                    // Êõ¥Êñ∞Êí≠ÊîæÊåâÈíÆÁä∂ÊÄÅ
                    const playBtn = document.getElementById('playIntervalBtn');
                    if (playBtn) {
                        playBtn.innerHTML = 'Êí≠Êîæ';
                    }
                }

                // Ê∏ÖÈô§Á©∫Ë∞±Â≠êÊèêÁ§∫‰ø°ÊÅØ
                clearEmptyScoreMessage();

                const result = originalGenerateIntervals.apply(this, args);
                hideTitleAndInstrumentElements();
                return result;
            };
        }

        // ÂåÖË£Ö previousInterval Âíå nextIntervalÔºåÊ∑ªÂä†ÂÅúÊ≠¢Êí≠ÊîæÈÄªËæë
        const originalPreviousInterval = window.previousInterval;
        if (originalPreviousInterval) {
            window.previousInterval = function(...args) {
                if (typeof window.isPlayingInterval !== 'undefined' && window.isPlayingInterval) {
                    window.isPlayingInterval = false;
                    if (window.intervalScheduledSounds) {
                        window.intervalScheduledSounds.forEach(sound => {
                            try {
                                if (sound.oscillator) sound.oscillator.stop();
                                if (sound.source) sound.source.stop();
                                if (sound.element) {
                                    sound.element.pause();
                                    sound.element.src = '';
                                }
                            } catch (e) {}
                        });
                        window.intervalScheduledSounds = [];
                    }
                    const playBtn = document.getElementById('playIntervalBtn');
                    if (playBtn) {
                        playBtn.innerHTML = 'Êí≠Êîæ';
                    }
                }
                return originalPreviousInterval.apply(this, args);
            };
        }

        const originalNextInterval = window.nextInterval;
        if (originalNextInterval) {
            window.nextInterval = function(...args) {
                if (typeof window.isPlayingInterval !== 'undefined' && window.isPlayingInterval) {
                    window.isPlayingInterval = false;
                    if (window.intervalScheduledSounds) {
                        window.intervalScheduledSounds.forEach(sound => {
                            try {
                                if (sound.oscillator) sound.oscillator.stop();
                                if (sound.source) sound.source.stop();
                                if (sound.element) {
                                    sound.element.pause();
                                    sound.element.src = '';
                                }
                            } catch (e) {}
                        });
                        window.intervalScheduledSounds = [];
                    }
                    const playBtn = document.getElementById('playIntervalBtn');
                    if (playBtn) {
                        playBtn.innerHTML = 'Êí≠Êîæ';
                    }
                }
                return originalNextInterval.apply(this, args);
            };
        }

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêé‰πüÊâßË°å‰∏ÄÊ¨°
        document.addEventListener('DOMContentLoaded', () => {
            hideTitleAndInstrumentElements();
            // ÂÆöÊúüÊ£ÄÊü•
            setInterval(hideTitleAndInstrumentElements, 2000);
            
            // Ê∑ªÂä†ÁÇπÂáªÂÆπÂô®Ëß¶ÂèëÁîüÊàêÈü≥Á®ãÂäüËÉΩ
            const scoreContainer = document.querySelector('.score-container');
            if (scoreContainer) {
                // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂ÁõëÂê¨Âô®
                scoreContainer.addEventListener('click', function(event) {
                    // Á°Æ‰øù generateIntervals ÂáΩÊï∞Â≠òÂú®
                    if (typeof generateIntervals === 'function') {
                        generateIntervals();
                    } else {
                        console.warn('generateIntervals ÂáΩÊï∞Êú™ÊâæÂà∞');
                    }
                });
                
                // Ê∑ªÂä†Èº†Ê†áÊÇ¨ÂÅúÊ†∑ÂºèÊèêÁ§∫
                scoreContainer.style.cursor = 'pointer';
                scoreContainer.title = 'ÁÇπÂáª‰ªªÊÑè‰ΩçÁΩÆÁîüÊàêÊñ∞Èü≥Á®ã';
                
            } else {
                console.warn('Êú™ÊâæÂà∞ .score-container ÂÖÉÁ¥†');
            }
        });

        // ======================================
        // üéµ Èü≥Á®ãÊí≠ÊîæÊ®°ÂºèÂíåÈöêËóèÊ®°ÂºèÂäüËÉΩÔºà‰ªéÊóãÂæãËßÜÂ•èÂ∑•ÂÖ∑Â§çÂà∂Ôºâ
        // ======================================

        // ÈöêËóèÊ®°ÂºèÂèòÈáèÂíåÂáΩÊï∞
        var isIntervalHidden = false;

        /**
         * üé≠ Â∫îÁî®Èü≥Á®ãÈöêËóèÁä∂ÊÄÅÂà∞ÂΩìÂâç‰πêË∞±
         */
        function applyIntervalHiddenState() {
            const scoreElement = document.getElementById('score');
            if (!scoreElement) return;

            const svgElements = scoreElement.querySelectorAll('svg');
            if (isIntervalHidden) {
                // ÂêåÊ≠•ÈöêËóèÂÆπÂô®‰∏éSVGÔºåÈÅøÂÖçÊ∏≤ÊüìÂâçÂêéÁä∂ÊÄÅ‰∏ç‰∏ÄËá¥
                scoreElement.style.opacity = '0';
                scoreElement.style.filter = 'blur(10px)';

                svgElements.forEach(svg => {
                    svg.classList.add('melody-hidden');
                    svg.style.opacity = '0';
                    svg.style.filter = 'blur(10px)';
                });
                console.log('üëÇ Â∑≤Â∫îÁî®ÈöêËóèÁä∂ÊÄÅÂà∞Èü≥Á®ã');
            } else {
                // Ê∏ÖÈô§ÂÆπÂô®‰∏éSVG‰∏äÁöÑÈöêËóèÊ†∑ÂºèÔºåÁ°Æ‰øùÂèØËßÅ
                scoreElement.style.opacity = '1';
                scoreElement.style.filter = 'none';

                svgElements.forEach(svg => {
                    svg.classList.remove('melody-hidden');
                    svg.style.opacity = '1';
                    svg.style.filter = 'none';
                });
                console.log('üëÄ Â∑≤Â∫îÁî®ÊòæÁ§∫Áä∂ÊÄÅÂà∞Èü≥Á®ã');
            }
        }

        /**
         * üé≠ Êõ¥Êñ∞ÈöêËóèÊåâÈíÆÁöÑÁä∂ÊÄÅ
         */
        function updateVisibilityButton() {
            const visibilityBtn = document.getElementById('intervalVisibilityBtn');
            if (!visibilityBtn) return;

            if (isIntervalHidden) {
                visibilityBtn.innerHTML = 'üëÇ';
                visibilityBtn.title = 'ÊòæÁ§∫Èü≥Á®ã';
                visibilityBtn.classList.add('hidden-state');
            } else {
                visibilityBtn.innerHTML = 'üëÄ';
                visibilityBtn.title = 'ÈöêËóèÈü≥Á®ã';
                visibilityBtn.classList.remove('hidden-state');
            }
        }

        function toggleIntervalVisibility() {
            isIntervalHidden = !isIntervalHidden;
            console.log(`üé≠ ÂàáÊç¢ÈöêËóèÁä∂ÊÄÅ: ${isIntervalHidden ? 'ÈöêËóè' : 'ÊòæÁ§∫'}`);

            // Â∫îÁî®Êñ∞Áä∂ÊÄÅ
            applyIntervalHiddenState();
            updateVisibilityButton();
        }

        // Êí≠ÊîæÊ®°ÂºèÂèòÈáèÂíåÂáΩÊï∞
        window.isPlayingInterval = false;
        window.intervalAudioCtx = null;
        window.intervalScheduledSounds = [];
        window.intervalPlaybackStartTime = null; // Êí≠ÊîæÂºÄÂßãÁöÑÂÆûÈôÖÊó∂Èó¥ÔºàPerformance.now()Ôºâ
        window.intervalPlaybackTempo = 60; // ÂΩìÂâçÊí≠ÊîæÁöÑtempo
        window.intervalPlaybackTimeSignature = { beats: 4, beatType: 4 }; // ÂΩìÂâçÊí≠ÊîæÁöÑÊãçÂè∑
        window.intervalMetronomeSyncTimeout = null; // ËäÇÊãçÂô®ÂêåÊ≠•ÁöÑ setTimeout ID

        function directPlayTest() {

            // üîç Ë∞ÉËØïÔºöÊ£ÄÊü•ÂΩìÂâçÊï∞ÊçÆÁä∂ÊÄÅ
            if (window.currentIntervalProgression) {
                console.log('üîç ÂΩìÂâçÊï∞ÊçÆÁä∂ÊÄÅ:', {
                    measures: window.currentIntervalProgression.measures?.length || 0,
                    tempo: window.currentIntervalProgression.tempo,
                    firstMeasureExists: !!window.currentIntervalProgression.measures?.[0],
                    firstMeasureLowerVoice: window.currentIntervalProgression.measures?.[0]?.lowerVoice?.length || 0,
                    firstMeasureUpperVoice: window.currentIntervalProgression.measures?.[0]?.upperVoice?.length || 0
                });
            }

            if (window.isPlayingInterval) {
                // ÂÅúÊ≠¢Êí≠Êîæ
                window.isPlayingInterval = false;
                // üéµ Ê∏ÖÈô§Êí≠ÊîæÁä∂ÊÄÅÂèòÈáè
                window.intervalPlaybackStartTime = null;
                window.intervalPlaybackTempo = 60;
                window.intervalPlaybackTimeSignature = { beats: 4, beatType: 4 };

                // üîß Ê∏ÖÈô§ËäÇÊãçÂô®ÂêåÊ≠•ÁöÑ setTimeoutÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
                if (window.intervalMetronomeSyncTimeout) {
                    clearTimeout(window.intervalMetronomeSyncTimeout);
                    window.intervalMetronomeSyncTimeout = null;
                    console.log('‚èπÔ∏è Â∑≤Ê∏ÖÈô§ËäÇÊãçÂô®ÂêåÊ≠•ÂÆöÊó∂Âô®');
                }

                // ÂÅúÊ≠¢ÊâÄÊúâË∞ÉÂ∫¶ÁöÑÊí≠Êîæ
                if (window.intervalScheduledSounds) {
                    window.intervalScheduledSounds.forEach(sound => {
                        try {
                            // Â§ÑÁêÜÊåØËç°Âô®ËäÇÁÇπÔºàÂêàÊàêÂô®ÂõûÈÄÄÔºâ
                            if (sound.oscillator) {
                                sound.oscillator.stop();
                            }
                            // Â§ÑÁêÜÈááÊ†∑Âô®ÁöÑ BufferSource ËäÇÁÇπ
                            if (sound.source) {
                                sound.source.stop();
                            }
                            // Â§ÑÁêÜ HTMLAudioElementÔºàfile:// ÂçèËÆÆ‰∏ãÁöÑÂõûÈÄÄÔºâ
                            if (sound.element) {
                                sound.element.pause();
                                sound.element.src = '';
                            }
                        } catch (e) {
                            // ËäÇÁÇπÂèØËÉΩÂ∑≤ÁªèÂÅúÊ≠¢ÔºåÂøΩÁï•ÈîôËØØ
                        }
                    });
                    window.intervalScheduledSounds = [];
                }
                updatePlayButton();
                console.log('‚èπÔ∏è ÂÅúÊ≠¢Èü≥Á®ãÊí≠Êîæ');
                return;
            }

            try {
                // üéØ ‰øÆÂ§çÔºöÂàùÂßãÂåñË∞ÉÂ∫¶Èü≥È¢ëÊï∞ÁªÑ
                if (!window.intervalScheduledSounds) {
                    window.intervalScheduledSounds = [];
                }

                // üéØ ‰øÆÂ§çÔºöÂ¢ûÂº∫ÁöÑAudioContextÂàùÂßãÂåñÂíåÈîôËØØÂ§ÑÁêÜ
                if (!window.intervalAudioCtx) {
                    const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                    if (!AudioContextClass) {
                        throw new Error('ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅWeb Audio APIÔºåÊó†Ê≥ïÊí≠ÊîæÈü≥È¢ë');
                    }
                    window.intervalAudioCtx = new AudioContextClass();
                    console.log('üéπ ÂàõÂª∫‰∫ÜÊñ∞ÁöÑAudioContextÔºåÁä∂ÊÄÅ:', window.intervalAudioCtx.state);
                }

                // üéØ ‰øÆÂ§çÔºöÂº∫Âà∂ÊÅ¢Â§çAudioContextÁä∂ÊÄÅÔºåÂ¢ûÂä†Áî®Êà∑‰∫§‰∫íÊ£ÄÊü•
                if (window.intervalAudioCtx.state === 'suspended') {
                    console.log('üéπ AudioContextË¢´ÊöÇÂÅúÔºåÂ∞ùËØïÊÅ¢Â§ç...');
                    window.intervalAudioCtx.resume().then(() => {
                        console.log('üéπ AudioContextÂ∑≤ÊÅ¢Â§çÔºåÁä∂ÊÄÅ:', window.intervalAudioCtx.state);
                        startIntervalPlayback();
                    }).catch(resumeError => {
                        console.error('‚ùå AudioContextÊÅ¢Â§çÂ§±Ë¥•:', resumeError);
                        alert('Èü≥È¢ë‰∏ä‰∏ãÊñáÊÅ¢Â§çÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÂêéÈáçËØï');
                    });
                } else {
                    console.log('üéπ AudioContextÂ∑≤ÂáÜÂ§áÂ∞±Áª™ÔºåÁä∂ÊÄÅ:', window.intervalAudioCtx.state);
                    startIntervalPlayback();
                }

            } catch (error) {
                console.error('‚ùå Èü≥Á®ãÊí≠ÊîæÂàùÂßãÂåñÂ§±Ë¥•:', error);
                window.isPlayingInterval = false;
                updatePlayButton();
                alert('Êí≠ÊîæÂàùÂßãÂåñÂ§±Ë¥•Ôºö' + error.message);
            }
        }

        function startIntervalPlayback() {
            // üéØ ‰øÆÂ§çÔºöÂ¢ûÂº∫ÁöÑÊï∞ÊçÆÈ™åËØÅÂíåÈîôËØØÂ§ÑÁêÜ

            if (!window.currentIntervalProgression) {
                console.warn('‚ö†Ô∏è Ê≤°ÊúâÊâæÂà∞Èü≥Á®ãËøõË°åÊï∞ÊçÆ');
                alert('ËØ∑ÂÖàÁîüÊàêÈü≥Á®ãÂÜçÊí≠Êîæ');
                return;
            }


            if (!window.currentIntervalProgression.measures || window.currentIntervalProgression.measures.length === 0) {
                console.warn('‚ö†Ô∏è Èü≥Á®ãËøõË°åÊï∞ÊçÆ‰∏≠Ê≤°ÊúâÂ∞èËäÇ');
                alert('Èü≥Á®ãÊï∞ÊçÆ‰∏çÂÆåÊï¥ÔºåËØ∑ÈáçÊñ∞ÁîüÊàê');
                return;
            }

            // È™åËØÅÁ¨¨‰∏Ä‰∏™Â∞èËäÇÊòØÂê¶ÊúâÊúâÊïàÁöÑÈü≥Á¨¶Êï∞ÊçÆ
            const firstMeasure = window.currentIntervalProgression.measures[0];

            if (!firstMeasure.lowerVoice || !firstMeasure.upperVoice ||
                firstMeasure.lowerVoice.length === 0 || firstMeasure.upperVoice.length === 0) {
                console.warn('‚ö†Ô∏è Èü≥Á®ãËøõË°åÊï∞ÊçÆ‰∏≠Ê≤°ÊúâÊúâÊïàÁöÑÈü≥Á¨¶');
                alert('Èü≥Á®ãÊï∞ÊçÆ‰∏çÂÆåÊï¥ÔºåËØ∑ÈáçÊñ∞ÁîüÊàê');
                return;
            }

            // È™åËØÅÈü≥Á¨¶ÁöÑpitchÂ≠óÊÆµ
            let validNoteCount = 0;
            firstMeasure.lowerVoice.forEach((note, index) => {
                if (note.type === 'note' && note.pitch) {
                    validNoteCount++;
                }
            });

            firstMeasure.upperVoice.forEach((note, index) => {
                if (note.type === 'note' && note.pitch) {
                    validNoteCount++;
                }
            });


            if (validNoteCount === 0) {
                console.warn('‚ö†Ô∏è Ê≤°ÊúâÊâæÂà∞ÊúâÊïàÁöÑÈü≥Á¨¶Êï∞ÊçÆ');
                alert('Èü≥Á®ãÊï∞ÊçÆ‰∏≠Ê≤°ÊúâÊúâÊïàÈü≥Á¨¶ÔºåËØ∑ÈáçÊñ∞ÁîüÊàê');
                return;
            }

            console.log('üìä Êí≠ÊîæÊï∞ÊçÆÁªüËÆ°:', {
                measures: window.currentIntervalProgression.measures.length,
                firstMeasureNotes: firstMeasure.lowerVoice.length,
                validNotes: validNoteCount,
                tempo: window.currentIntervalProgression.tempo || 120
            });

            window.isPlayingInterval = true;
            // üéµ ËÆ∞ÂΩïÊí≠ÊîæÂºÄÂßãÊó∂Èó¥ÂíåÂèÇÊï∞ÔºåÁî®‰∫éËäÇÊãçÂô®ÂêåÊ≠•
            window.intervalPlaybackStartTime = performance.now();
            window.intervalPlaybackTempo = parseInt(document.getElementById('headerMetronomeBpm')?.value) || 60;
            window.intervalPlaybackTimeSignature = window.currentIntervalProgression.timeSignature || { beats: 4, beatType: 4 };

            updatePlayButton();

            // üéµ Ê£ÄÊü•ÈöêËóèÊ®°ÂºèÔºàÈöêËóèÊ®°ÂºèÈúÄË¶Åcount-inÔºâ
            if (isIntervalHidden) {
                if (isMetronomeRunning) {
                    handleHiddenModeWithMetronome(window.currentIntervalProgression);
                } else {
                    playCountIn(window.currentIntervalProgression);
                }
                return;
            }

            // üîß Êô∫ËÉΩÊí≠ÊîæÊó∂Èó¥ÔºöËäÇÊãçÂô®ÂºÄÂêØÊó∂ÂØπÈΩêÁΩëÊ†ºÔºåÂÖ≥Èó≠Êó∂Á´ãÂç≥ÂìçÂ∫î

            // Á°Æ‰øù AudioContext Â∑≤ÂàùÂßãÂåñ
            if (!window.intervalAudioCtx) {
                window.intervalAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }

            // Ëé∑ÂèñÂΩìÂâçÈÄüÂ∫¶
            let tempo = 60;
            if (typeof getCurrentTempo === 'function') {
                tempo = getCurrentTempo();
            } else if (typeof metronomeTempo !== 'undefined') {
                tempo = metronomeTempo;
            }

            const beatDuration = 60.0 / tempo;
            const now = window.intervalAudioCtx.currentTime;
            let startTime;

            if (typeof isMetronomeRunning !== 'undefined' && isMetronomeRunning) {
                // üéµ ËäÇÊãçÂô®ÂºÄÂêØ - ÂØπÈΩêÂÖ®Â±ÄÁΩëÊ†ºÁ°Æ‰øùÂêåÊ≠•
                const currentBeatNumber = Math.floor(now / beatDuration);
                let nextBeatNumber = currentBeatNumber + 1;
                startTime = nextBeatNumber * beatDuration;

                // ÂÆâÂÖ®Ê£ÄÊü•ÔºöÁ°Æ‰øù startTime Ëá≥Â∞ëÂú®Êú™Êù• 50ms
                const minLookahead = 0.05;
                if (startTime < now + minLookahead) {
                    nextBeatNumber++;
                    startTime = nextBeatNumber * beatDuration;
                    console.log(`‚ö†Ô∏è Êó∂Èó¥Â§™ËøëÔºåË∑≥Âà∞‰∏ã‰∏ÄÊãç (Á¨¨${nextBeatNumber}Êãç)`);
                }

                console.log(`üéµ ËäÇÊãçÂô®ÂºÄÂêØ - ÂêåÊ≠•Âà∞ÂÖ®Â±ÄÁΩëÊ†º: BPM=${tempo}, ÂΩìÂâç=${now.toFixed(3)}s, Êí≠Êîæ=${startTime.toFixed(3)}s (Á¨¨${nextBeatNumber}Êãç)`);
            } else {
                // üöÄ ËäÇÊãçÂô®ÂÖ≥Èó≠ - Á´ãÂç≥Êí≠ÊîæÔºåÂìçÂ∫îËøÖÈÄü
                startTime = now + 0.1;
                console.log(`üöÄ ËäÇÊãçÂô®Êú™ÂºÄÂêØ - Á´ãÂç≥Êí≠Êîæ: BPM=${tempo}, ÂΩìÂâç=${now.toFixed(3)}s, Êí≠Êîæ=${startTime.toFixed(3)}s`);
            }

            playIntervalProgression(window.currentIntervalProgression, startTime);
        }

        function updatePlayButton() {
            const playBtn = document.getElementById('playIntervalBtn');
            if (playBtn) {
                if (window.isPlayingInterval) {
                    playBtn.innerHTML = 'ÂÅúÊ≠¢';
                    playBtn.classList.add('playing');
                } else {
                    playBtn.innerHTML = 'Êí≠Êîæ';
                    playBtn.classList.remove('playing');
                }
            }
        }

        /**
         * üé≠üéµ Â§ÑÁêÜÈöêËóèÊ®°Âºè + ËäÇÊãçÂô®ÁªÑÂêàÁöÑÁâπÊÆäÈÄªËæë
         * @param {Object} progression - Èü≥Á®ãËøõË°åÊï∞ÊçÆ
         */
        function handleHiddenModeWithMetronome(progression) {

            // Á¨¨‰∏ÄÊ≠•ÔºöÊöÇÂÅúËäÇÊãçÂô®
            const wasMetronomeRunning = isMetronomeRunning;
            if (wasMetronomeRunning) {
                stopMetronome();
            }

            // Á¨¨‰∫åÊ≠•ÔºöÊí≠Êîæcount-in
            playCountInWithMetronomeRestart(progression, wasMetronomeRunning);
        }

        /**
         * üóëÔ∏è Â∑≤ÂºÉÁî®ÔºöÊóßÁöÑÂêåÊ≠•ÈÄªËæëÔºà‰ΩøÁî®moduloÊñπÂºèÔºâ
         * Áé∞Âú®‰ΩøÁî®ÂÖ®Â±ÄËäÇÊãçÁΩëÊ†ºÔºåÊâÄÊúâÊí≠ÊîæÊÄªÊòØÂØπÈΩêÔºå‰∏çÈúÄË¶ÅËøô‰∏™ÂáΩÊï∞
         */
        // function playIntervalProgressionWithMetronomeSync(progression) { ... }

        /**
         * üé≠üéµ Êí≠Êîæcount-inÂπ∂Âú®ÁªìÊùüÂêéÈáçÊñ∞ÂêØÂä®ËäÇÊãçÂô®
         * @param {Object} progression - Èü≥Á®ãËøõË°åÊï∞ÊçÆ
         * @param {boolean} shouldRestartMetronome - ÊòØÂê¶ÈúÄË¶ÅÈáçÊñ∞ÂêØÂä®ËäÇÊãçÂô®
         */
        function playCountInWithMetronomeRestart(progression, shouldRestartMetronome) {

            // Ëé∑ÂèñÂΩìÂâçËäÇÊãçÂô®ÈÄüÂ∫¶
            const headerInput = document.getElementById('headerMetronomeBpm');
            const currentTempo = parseInt(headerInput ? headerInput.value : 60) || 60;
            const tempo = currentTempo;
            const timeSignature = progression.timeSignature || { beats: 4, beatType: 4 };
            const beatDuration = 60 / tempo; // ÊØèÊãçÁöÑÁßíÊï∞

            // ËÆ°ÁÆócount-inÁöÑÊÄªÊó∂Èïø
            let countInBeats, actualBeatDuration;
            if (timeSignature.beats === 6 && timeSignature.beatType === 8) {
                countInBeats = 2;
                actualBeatDuration = beatDuration * 3;
            } else if (timeSignature.beats === 9 && timeSignature.beatType === 8) {
                countInBeats = 3;
                actualBeatDuration = beatDuration * 3;
            } else if (timeSignature.beats === 12 && timeSignature.beatType === 8) {
                countInBeats = 4;
                actualBeatDuration = beatDuration * 3;
            } else {
                countInBeats = timeSignature.beats;
                actualBeatDuration = beatDuration;
            }

            const countInDuration = countInBeats * actualBeatDuration * 1000; // ËΩ¨Êç¢‰∏∫ÊØ´Áßí

            console.log(`   - ÊãçÊï∞: ${countInBeats}Êãç`);
            console.log(`   - ÊØèÊãçÊó∂Èïø: ${actualBeatDuration.toFixed(2)}Áßí`);
            console.log(`   - ÊÄªÊó∂Èïø: ${countInDuration.toFixed(2)}ms`);
            console.log(`   - ÂÆåÊàêÂêéÈáçÂêØËäÇÊãçÂô®: ${shouldRestartMetronome}`);

            // Êí≠Êîæcount-inÔºå‰ΩÜ‰∏çÁî±ÂÜÖÈÉ®Ëá™Âä®ÂêØÂä®Êí≠ÊîæÔºõÁî±ÂõûË∞ÉÁªü‰∏ÄË∞ÉÂ∫¶
            playCountIn(progression, {
                autoStart: false,
                onFinish: ({ playbackStartAt }) => {
                    if (shouldRestartMetronome) {
                        window.metronomeStartTime = performance.now();
                        startMetronome();
                    } else {
                    }
                    playIntervalProgression(progression, playbackStartAt);
                }
            });
        }

        /**
         * üéµ Êí≠Êîæcount-inÔºàÊâìÊãçÂ≠êÔºâ
         * @param {Object} progression - Èü≥Á®ãËøõË°åÊï∞ÊçÆ
         */
        function playCountIn(progression, options = {}) {

            const { autoStart = true, onFinish = null } = options;

            // üéµ ‰øÆÂ§çÔºö‰ΩøÁî®ÂΩìÂâçËäÇÊãçÂô®ÁöÑtempoËÄå‰∏çÊòØÁîüÊàêÊó∂ÁöÑtempo
            const headerInput = document.getElementById('headerMetronomeBpm');
            const currentTempo = parseInt(headerInput ? headerInput.value : 60) || 60;
            const tempo = currentTempo;
            const timeSignature = progression.timeSignature || { beats: 4, beatType: 4 };
            const beatDuration = 60 / tempo; // ÊØèÊãçÁöÑÁßíÊï∞

            // Ê†πÊçÆÊãçÂè∑Á°ÆÂÆöcount-inÁöÑÊãçÊï∞
            let countInBeats, actualBeatDuration;

            if (timeSignature.beats === 6 && timeSignature.beatType === 8) {
                // 6/8ÊãçÔºöÊÑüÂèó‰∏∫2‰∏™Â§ßÊãçÔºåÊØèÊãç‰∏∫ÈôÑÁÇπÂõõÂàÜÈü≥Á¨¶
                countInBeats = 2;
                actualBeatDuration = beatDuration * 3; // 3‰∏™ÂÖ´ÂàÜÈü≥Á¨¶ = 1‰∏™ÈôÑÁÇπÂõõÂàÜÈü≥Á¨¶
            } else if (timeSignature.beats === 9 && timeSignature.beatType === 8) {
                // 9/8ÊãçÔºöÊÑüÂèó‰∏∫3‰∏™Â§ßÊãç
                countInBeats = 3;
                actualBeatDuration = beatDuration * 3;
            } else if (timeSignature.beats === 12 && timeSignature.beatType === 8) {
                // 12/8ÊãçÔºöÊÑüÂèó‰∏∫4‰∏™Â§ßÊãç
                countInBeats = 4;
                actualBeatDuration = beatDuration * 3;
            } else {
                // ÂÖ∂‰ªñÊãçÂè∑ÔºöÊåâÂéüÂßãÊãçÊï∞
                countInBeats = timeSignature.beats;
                actualBeatDuration = beatDuration;
            }

            if (!window.intervalAudioCtx) {
                console.error('‚ùå AudioContext‰∏çÂèØÁî®');
                return;
            }

            // ‰ª•AudioContextÊó∂Èó¥‰∏∫Âü∫ÂáÜÔºåÈÅøÂÖçsetTimeoutÊºÇÁßª
            const baseTime = window.intervalAudioCtx.currentTime + 0.1;
            let currentTime = baseTime;

            // ÂàùÂßãÂåñÈááÊ†∑Âô®ÔºàËã•ÂèØÁî®Ôºâ
            try {
                if (!window.__icSamplePlayer && window.ICSamplePlayer) {
                    window.__icSamplePlayer = new ICSamplePlayer({ rootPath: 'assets/samples/piano-ogg' });
                    window.__icSamplePlayer.load();
                }
            } catch (_) {}

            // Êí≠ÊîæÊØè‰∏ÄÊãçÁöÑclickÂ£∞
            for (let beat = 1; beat <= countInBeats; beat++) {
                // Á¨¨‰∏ÄÊãçÈü≥Ë∞ÉÊõ¥È´òÔºåÂÖ∂‰ªñÊãçÈü≥Ë∞ÉËæÉ‰Ωé
                const frequency = beat === 1 ? 800 : 600;
                const duration = 0.1; // clickÂ£∞ÁöÑÊåÅÁª≠Êó∂Èó¥
                const beatTime = currentTime + (beat - 1) * actualBeatDuration;


                // Áõ¥Êé•Ë∞ÉÂ∫¶clickÂ£∞Âà∞AudioContext
                playClickSound(frequency, beatTime, duration);
            }

            // count-inÁªìÊùüÂêéÁöÑÁ≤æÁ°ÆÊí≠ÊîæÊó∂Èó¥ÔºàÂä†ÂÖ•Â∞ëÈáèË£ïÈáè‰ª•Á°Æ‰øùclickÂ∞æÈü≥ÁªìÊùüÔºâ
            const totalCountInDuration = countInBeats * actualBeatDuration;
            const playbackStartAt = baseTime + totalCountInDuration + 0.05;
            const delayMs = Math.max(0, (playbackStartAt - window.intervalAudioCtx.currentTime) * 1000);
            setTimeout(() => {
                if (window.isPlayingInterval) { // Á°Æ‰øùËøòÂú®Êí≠ÊîæÁä∂ÊÄÅ
                    if (typeof onFinish === 'function') {
                        try { onFinish({ playbackStartAt, countInBeats, actualBeatDuration }); } catch (e) { console.warn('onFinishÂõûË∞ÉÂºÇÂ∏∏:', e); }
                    }
                    if (autoStart) {
                        playIntervalProgression(progression, playbackStartAt);
                    }
                }
            }, delayMs);
        }

        /**
         * üéµ Êí≠ÊîæclickÂ£∞
         * @param {number} frequency - È¢ëÁéá
         * @param {number} startTime - ÂºÄÂßãÊó∂Èó¥
         * @param {number} duration - ÊåÅÁª≠Êó∂Èó¥
         */
        function playClickSound(frequency, startTime, duration) {
            try {
                const oscillator = window.intervalAudioCtx.createOscillator();
                const gainNode = window.intervalAudioCtx.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(window.intervalAudioCtx.destination);

                oscillator.frequency.setValueAtTime(frequency, startTime);
                oscillator.type = 'square'; // ÊñπÊ≥¢‰∫ßÁîüÊõ¥Ê∏ÖËÑÜÁöÑclickÂ£∞

                // Èü≥ÈáèÂåÖÁªúÔºöÂø´ÈÄüËµ∑ÂßãÔºåÂø´ÈÄüË°∞Âáè
                gainNode.gain.setValueAtTime(0, startTime);
                gainNode.gain.linearRampToValueAtTime(0.3, startTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, startTime + duration);

                oscillator.start(startTime);
                oscillator.stop(startTime + duration);

                // ‰øùÂ≠òÂà∞Ë∞ÉÂ∫¶ÂàóË°®Áî®‰∫éÂÅúÊ≠¢
                if (!window.intervalScheduledSounds) {
                    window.intervalScheduledSounds = [];
                }
                window.intervalScheduledSounds.push({ oscillator, gainNode });

            } catch (error) {
                console.error('‚ùå Êí≠ÊîæclickÂ£∞Â§±Ë¥•:', error);
            }
        }

        function playIntervalProgression(progression, audioStartAt = null) {
            if (!progression || !progression.measures) {
                console.warn('‚ö†Ô∏è Êó†ÊïàÁöÑÈü≥Á®ãËøõË°åÊï∞ÊçÆ');
                window.isPlayingInterval = false;
                updatePlayButton();
                return;
            }

            // üéØ ËØ¶ÁªÜÈ™åËØÅÊí≠ÊîæÊï∞ÊçÆ

            // È™åËØÅÊØè‰∏™Â∞èËäÇÁöÑÊï∞ÊçÆÂÆåÊï¥ÊÄß
            let hasValidNotes = false;
            progression.measures.forEach((measure, measureIndex) => {
                console.log(`Â∞èËäÇ ${measureIndex + 1}:`, {
                    lowerVoiceCount: measure.lowerVoice?.length || 0,
                    upperVoiceCount: measure.upperVoice?.length || 0
                });

                if (measure.lowerVoice && measure.upperVoice) {
                    measure.lowerVoice.forEach((note, noteIndex) => {
                        const upperNote = measure.upperVoice[noteIndex];
                        if (note && upperNote) {
                            console.log(`  Èü≥Á¨¶${noteIndex + 1}:`, {
                                lower: { type: note.type, pitch: note.pitch, duration: note.duration },
                                upper: { type: upperNote.type, pitch: upperNote.pitch, duration: upperNote.duration }
                            });
                            if (note.type === 'note' && upperNote.type === 'note' && note.pitch && upperNote.pitch) {
                                hasValidNotes = true;
                            }
                        }
                    });
                }
            });

            if (!hasValidNotes) {
                console.error('‚ùå Êí≠ÊîæÊï∞ÊçÆ‰∏≠Ê≤°ÊúâÊâæÂà∞ÊúâÊïàÁöÑÈü≥Á¨¶');
                alert('Êí≠ÊîæÊï∞ÊçÆ‰∏çÂÆåÊï¥ÔºåËØ∑ÈáçÊñ∞ÁîüÊàêÈü≥Á®ã');
                window.isPlayingInterval = false;
                updatePlayButton();
                return;
            }

            // üéµ ‰øÆÂ§çÔºö‰ΩøÁî®ÂΩìÂâçËäÇÊãçÂô®ÁöÑtempoËÄå‰∏çÊòØÁîüÊàêÊó∂ÁöÑtempo
            const headerInput = document.getElementById('headerMetronomeBpm');
            const currentTempo = parseInt(headerInput ? headerInput.value : 60) || 60;
            const tempo = currentTempo;
            const beatDuration = 60 / tempo; // ÊØèÊãçÁöÑÁßíÊï∞
            const timeSignature = progression.timeSignature || { beats: 4, beatType: 4 };

            // Ëã•Êèê‰æõ‰∫ÜÁªùÂØπAudioContextËµ∑ÂßãÊó∂Èó¥ÔºåÂàô‰∏•Ê†ºÂØπÈΩêÔºõÂê¶ÂàôÈááÁî®ÂΩìÂâçÊó∂Èó¥+0.1s
            let currentTime = audioStartAt ? Math.max(audioStartAt, window.intervalAudioCtx.currentTime + 0.02)
                                           : window.intervalAudioCtx.currentTime + 0.1; // Á®çÂæÆÂª∂ËøüÂºÄÂßã
            let totalPlaybackDuration = 0;

            progression.measures.forEach((measure, measureIndex) => {

                // Êí≠ÊîæÂ∞èËäÇ‰∏≠ÁöÑÊØè‰∏™Èü≥Á¨¶
                for (let i = 0; i < measure.lowerVoice.length; i++) {
                    const lowerNote = measure.lowerVoice[i];
                    const upperNote = measure.upperVoice[i];


                    if (lowerNote.type === 'note' && upperNote.type === 'note') {
                        // Ê£ÄÊü•Èü≥È´òÂ≠óÊÆµ
                        if (!lowerNote.pitch || !upperNote.pitch) {
                            console.error(`‚ùå Èü≥È´òÁº∫Â§±: lower.pitch=${lowerNote.pitch}, upper.pitch=${upperNote.pitch}`);
                            continue;
                        }

                        // ËÆ°ÁÆóÈü≥Á¨¶ÊåÅÁª≠Êó∂Èó¥
                        const noteDuration = getNoteDurationInSeconds(lowerNote.duration, beatDuration);

                        // Êí≠ÊîæÈü≥Á®ãÔºàÂíåÂº¶Ôºâ
                        playIntervalChord([lowerNote.pitch, upperNote.pitch], currentTime, noteDuration);

                        currentTime += noteDuration;
                        totalPlaybackDuration += noteDuration;
                    } else if (lowerNote.type === 'rest') {
                        // ‰ºëÊ≠¢Á¨¶ÔºöÂè™Êé®ËøõÊó∂Èó¥Ôºå‰∏çÊí≠ÊîæÂ£∞Èü≥
                        const restDuration = getNoteDurationInSeconds(lowerNote.duration, beatDuration);
                        currentTime += restDuration;
                        totalPlaybackDuration += restDuration;
                    }
                }
            });


            // üéØ ÊîπËøõÊí≠ÊîæÁªìÊùüÂõûË∞ÉÔºåÊ∑ªÂä†Ê∏ÖÁêÜÈÄªËæë
            const playbackEndTime = (totalPlaybackDuration + 0.5) * 1000; // Â¢ûÂä†0.5ÁßíÁºìÂÜ≤Êó∂Èó¥
            setTimeout(() => {
                if (window.isPlayingInterval) {
                    window.isPlayingInterval = false;
                    // üéµ Ê∏ÖÈô§Êí≠ÊîæÁä∂ÊÄÅÂèòÈáè
                    window.intervalPlaybackStartTime = null;
                    window.intervalPlaybackTempo = 60;
                    window.intervalPlaybackTimeSignature = { beats: 4, beatType: 4 };

                    // Ê∏ÖÁêÜË∞ÉÂ∫¶ÁöÑÈü≥È¢ë
                    if (window.intervalScheduledSounds) {
                        window.intervalScheduledSounds = [];
                    }
                    updatePlayButton();
                }
            }, playbackEndTime);
        }

        function playIntervalChord(pitches, startTime, duration) {
            if (!window.intervalAudioCtx) {
                console.error('‚ùå AudioContext‰∏çÂèØÁî®');
                return;
            }


            pitches.forEach((pitch, index) => {
                const frequency = pitchToFrequency(pitch);
                if (frequency) {
                    try {
                        if (window.__icSamplePlayer && window.__icSamplePlayer.ready) {
                            const midi = Math.round(69 + 12 * Math.log2(frequency / 440));
                            const playResult = window.__icSamplePlayer.scheduleAtExternalContext(window.intervalAudioCtx, startTime, midi, duration, 0.8);
                            // ‰øùÂ≠òËøîÂõûÂÄº‰ª•‰æøÂÅúÊ≠¢Êó∂‰ΩøÁî®
                            if (playResult) {
                                if (!window.intervalScheduledSounds) window.intervalScheduledSounds = [];
                                window.intervalScheduledSounds.push(playResult);
                            }
                        } else {
                            const oscillator = window.intervalAudioCtx.createOscillator();
                            const gainNode = window.intervalAudioCtx.createGain();
                            oscillator.connect(gainNode);
                            gainNode.connect(window.intervalAudioCtx.destination);
                            oscillator.frequency.setValueAtTime(frequency, startTime);
                            oscillator.type = 'sine';
                            const volume = 0.15;
                            gainNode.gain.setValueAtTime(0, startTime);
                            gainNode.gain.linearRampToValueAtTime(volume, startTime + 0.02);
                            gainNode.gain.setValueAtTime(volume * 0.8, startTime + duration - 0.05);
                            gainNode.gain.linearRampToValueAtTime(0, startTime + duration);
                            oscillator.start(startTime);
                            oscillator.stop(startTime + duration);
                            if (!window.intervalScheduledSounds) window.intervalScheduledSounds = [];
                            window.intervalScheduledSounds.push({ oscillator, gainNode });
                        }
                    } catch (error) {
                        console.error(`‚ùå Êí≠ÊîæÈü≥Á¨¶ ${pitch} Â§±Ë¥•:`, error);
                    }
                } else {
                    console.warn(`‚ö†Ô∏è Êó†Ê≥ïËß£ÊûêÈü≥È´ò: ${pitch}`);
                }
            });
        }

        function pitchToFrequency(pitch) {
            // üéØ Â¢ûÂº∫Ë∞ÉËØïÂíåÈîôËØØÂ§ÑÁêÜ

            if (!pitch || typeof pitch !== 'string') {
                console.error(`‚ùå Êó†ÊïàÈü≥È´òÊ†ºÂºè: ${pitch}`);
                return null;
            }

            // Ëß£ÊûêÈü≥È´ò (Â¶Ç "C4", "F#5")
            const match = pitch.match(/^([A-G])([#b]?)(\d+)$/);
            if (!match) {
                console.error(`‚ùå Èü≥È´òËß£ÊûêÂ§±Ë¥•: "${pitch}" ‰∏çÂåπÈÖçÈ¢ÑÊúüÊ†ºÂºè`);
                return null;
            }

            const [, note, accidental, octave] = match;
            const octaveNum = parseInt(octave);

            // C4 = MIDI 60 = 261.63 Hz
            const noteMap = { 'C': 0, 'D': 2, 'E': 4, 'F': 5, 'G': 7, 'A': 9, 'B': 11 };
            let midiNote = noteMap[note] + (octaveNum * 12) + 12; // C0 = MIDI 12

            if (accidental === '#') midiNote += 1;
            else if (accidental === 'b') midiNote -= 1;

            // MIDI note to frequency: f = 440 * 2^((n-69)/12)
            const frequency = 440 * Math.pow(2, (midiNote - 69) / 12);

            // üéØ ‰øÆÂ§çÔºöÊ∑ªÂä†È¢ëÁéáËåÉÂõ¥È™åËØÅ
            if (frequency < 20 || frequency > 20000) {
                console.warn(`‚ö†Ô∏è È¢ëÁéáË∂ÖÂá∫‰∫∫ËÄ≥Âê¨ËßâËåÉÂõ¥: ${frequency.toFixed(2)}Hz`);
            }

            return frequency;
        }

        // üéØ Ê∑ªÂä†Êí≠ÊîæÊµãËØïÂáΩÊï∞
        function testAudioPlayback() {
            console.log('üß™ ÊµãËØïÈü≥È¢ëÊí≠ÊîæÂäüËÉΩ');
            try {
                const testFreq = pitchToFrequency('C4');
                console.log('üß™ ÊµãËØïÈ¢ëÁéá:', testFreq);

                if (window.intervalAudioCtx && testFreq) {
                    const osc = window.intervalAudioCtx.createOscillator();
                    const gain = window.intervalAudioCtx.createGain();

                    osc.connect(gain);
                    gain.connect(window.intervalAudioCtx.destination);

                    osc.frequency.value = testFreq;
                    gain.gain.value = 0.1;

                    osc.start();
                    osc.stop(window.intervalAudioCtx.currentTime + 0.5);

                    console.log('üß™ ÊµãËØïÈü≥Á¨¶Â∑≤Êí≠Êîæ');
                    return true;
                }
            } catch (error) {
                console.error('‚ùå Èü≥È¢ëÊµãËØïÂ§±Ë¥•:', error);
                return false;
            }
        }

        // üéØ Ê∑ªÂä†Êí≠ÊîæÊµãËØïÂäüËÉΩ
        function testPlaybackSystem() {
            console.log('üß™ ÊµãËØïÊí≠ÊîæÁ≥ªÁªü...');

            // ÂàõÂª∫ÁÆÄÂçïÁöÑÊµãËØïÊï∞ÊçÆ
            const testProgression = {
                measures: [{
                    lowerVoice: [
                        { type: 'note', pitch: 'C4', duration: 1.0 },
                        { type: 'note', pitch: 'D4', duration: 1.0 }
                    ],
                    upperVoice: [
                        { type: 'note', pitch: 'E4', duration: 1.0 },
                        { type: 'note', pitch: 'F4', duration: 1.0 }
                    ]
                }],
                tempo: 120,
                timeSignature: { beats: 4, beatType: 4 }
            };

            // ‰øùÂ≠òÊµãËØïÊï∞ÊçÆ
            window.currentIntervalProgression = testProgression;
            console.log('üß™ ÊµãËØïÊï∞ÊçÆÂ∑≤‰øùÂ≠ò');

            // Â∞ùËØïÊí≠Êîæ
            if (window.intervalAudioCtx) {
                directPlayTest();
            } else {
                console.log('üß™ ÂàùÂßãÂåñÈü≥È¢ë‰∏ä‰∏ãÊñáÂêéÂÜçËØïÊí≠Êîæ...');
                directPlayTest();
            }
        }

        // ‰∏∫Ë∞ÉËØïÊ∑ªÂä†ÂÖ®Â±ÄÂáΩÊï∞
        window.testPlaybackSystem = testPlaybackSystem;
        window.testAudioPlayback = testAudioPlayback;

        function getNoteDurationInSeconds(duration, beatDuration) {
            // üéØ ‰øÆÂ§çÔºöÂ§ÑÁêÜÊï∞Â≠óÁ±ªÂûãÁöÑduration
            let durationValue;
            if (typeof duration === 'number') {
                durationValue = duration;
            } else {
                const durationMap = {
                    'whole': 4.0,
                    'half.': 3.0,  // ÈôÑÁÇπ‰∫åÂàÜÈü≥Á¨¶
                    'half': 2.0,
                    'quarter.': 1.5,  // ÈôÑÁÇπÂõõÂàÜÈü≥Á¨¶
                    'quarter': 1.0,
                    'eighth': 0.5,
                    '16th': 0.25,
                    'triplet': 2/3  // üéØ ‰øÆÂ§çÔºöÂõõÂàÜ‰∏âËøûÈü≥ÊØè‰∏™Èü≥Á¨¶ = 2/3Êãç
                };
                durationValue = durationMap[duration] || 1.0;
            }

            const result = durationValue * beatDuration;
            return result;
        }

        // üîß È°µÈù¢Âç∏ËΩΩÊó∂Ê∏ÖÁêÜV4.0Ê∏≤ÊüìÂô®ËµÑÊ∫ê
        window.addEventListener('beforeunload', function() {
            if (window.intervalRenderer && typeof window.intervalRenderer.clear === 'function') {
                try {
                    window.intervalRenderer.clear();
                } catch (cleanupError) {
                    console.warn('‚ö†Ô∏è V4.0Ê∏≤ÊüìÂô®Ê∏ÖÁêÜÊó∂Âá∫Èîô:', cleanupError);
                }
            }
        });


        // üéØ ÈÄöÁî®ÂºπÁ™óÂ§ñÈÉ®ÁÇπÂáªÂÖ≥Èó≠ÂäüËÉΩ
        function initializeModalClickOutsideToClose() {
            const modalIds = [
                'intervalTypeModal',
                'rhythmModal',
                'articulationModal',
                'keySignatureModal',
                'timeSignatureModal',
                'intervalModal',
                'clefModal'
            ];

            modalIds.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.addEventListener('click', function(event) {
                        // Âè™ÊúâÂΩìÁÇπÂáªÁöÑÊòØÂºπÁ™óËÉåÊôØÔºàmodalÂÆπÂô®Êú¨Ë∫´ÔºâÊó∂ÊâçÂÖ≥Èó≠
                        if (event.target === modal) {

                            // Ê†πÊçÆÂºπÁ™óÁ±ªÂûãË∞ÉÁî®Áõ∏Â∫îÁöÑÂÖ≥Èó≠ÂáΩÊï∞
                            switch(modalId) {
                                case 'intervalTypeModal':
                                    if (typeof closeIntervalTypeSettings === 'function') {
                                        closeIntervalTypeSettings();
                                    }
                                    break;
                                case 'rhythmModal':
                                    if (typeof saveRhythmSettings === 'function') {
                                        console.log('üíæ Â§ñÈÉ®ÁÇπÂáªÔºöËá™Âä®‰øùÂ≠òËäÇÂ•èËÆæÁΩÆ');
                                        saveRhythmSettings();
                                    } else if (typeof closeRhythmSettings === 'function') {
                                        closeRhythmSettings();
                                    }
                                    break;
                                case 'articulationModal':
                                    if (typeof closeArticulationSettings === 'function') {
                                        closeArticulationSettings();
                                    }
                                    break;
                                case 'keySignatureModal':
                                    if (typeof closeKeySettings === 'function') {
                                        closeKeySettings();
                                    }
                                    break;
                                case 'timeSignatureModal':
                                    if (typeof saveTimeSignatureSettings === 'function') {
                                        console.log('üíæ Â§ñÈÉ®ÁÇπÂáªÔºöËá™Âä®‰øùÂ≠òÊãçÂè∑ËÆæÁΩÆ');
                                        saveTimeSignatureSettings();
                                    } else if (typeof closeTimeSignatureSettings === 'function') {
                                        closeTimeSignatureSettings();
                                    }
                                    break;
                                case 'intervalModal':
                                    if (typeof closeIntervalSettings === 'function') {
                                        closeIntervalSettings();
                                    }
                                    break;
                                case 'clefModal':
                                    if (typeof closeClefSettings === 'function') {
                                        closeClefSettings();
                                    }
                                    break;
                                default:
                                    // ÈÄöÁî®ÂÖ≥Èó≠ÊñπÊ≥ï
                                    modal.style.display = 'none';
                            }
                        }
                    });
                }
            });
        }

        // Âú®È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            initializeModalClickOutsideToClose();
        });
    </script>

    <!-- Èü≥Á®ãÂÆπÂô®ÁÇπÂáªÁîüÊàêÂäüËÉΩ -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const scoreContainer = document.getElementById('score');

            if (scoreContainer) {
                // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂ÁõëÂê¨Âô®
                scoreContainer.addEventListener('click', function(event) {
                    // Ê£ÄÊü•ÁÇπÂáªÁöÑ‰∏çÊòØÊåâÈíÆÊàñÂÖ∂‰ªñ‰∫§‰∫íÂÖÉÁ¥†
                    const targetElement = event.target;
                    const isInteractiveElement = targetElement.tagName === 'BUTTON' ||
                                                 targetElement.tagName === 'A' ||
                                                 targetElement.closest('button') ||
                                                 targetElement.closest('a');

                    // Â¶ÇÊûúÁÇπÂáªÁöÑ‰∏çÊòØ‰∫§‰∫íÂÖÉÁ¥†ÔºåËß¶ÂèëÁîüÊàê
                    if (!isInteractiveElement && typeof generateIntervals === 'function') {
                        console.log('üñ±Ô∏è ÂÆπÂô®ÁÇπÂáªËß¶ÂèëÁîüÊàêÈü≥Á®ã');
                        generateIntervals();
                    }
                });

                // Ê∑ªÂä†ÊåáÈíàÊ†∑ÂºèÊèêÁ§∫ÔºàÂèØÁÇπÂáªÔºâ
                scoreContainer.style.cursor = 'pointer';

                console.log('‚úÖ Èü≥Á®ãÂÆπÂô®ÁÇπÂáªÁîüÊàêÂäüËÉΩÂ∑≤ÂêØÁî®');
            } else {
                console.warn('‚ö†Ô∏è Êú™ÊâæÂà∞ score ÂÆπÂô®ÔºåÊó†Ê≥ïÂêØÁî®ÁÇπÂáªÁîüÊàêÂäüËÉΩ');
            }
        });

        // ‚å®Ô∏è ÂÖ®Â±ÄÈîÆÁõòÂø´Êç∑ÈîÆ
        document.addEventListener('keydown', function(e) {
            // Â¶ÇÊûúÂú®ËæìÂÖ•Ê°Ü„ÄÅÊñáÊú¨Ê°ÜÊàñÊ®°ÊÄÅÊ°ÜËæìÂÖ•‰∏≠Ôºå‰∏çËß¶ÂèëÂø´Êç∑ÈîÆ
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                return;
            }

            // Ê£ÄÊü•ÊòØÂê¶ÊúâÊ®°ÊÄÅÊ°ÜÊâìÂºÄÔºàÈÅøÂÖçÂú®ËÆæÁΩÆ‰∏≠Ëß¶ÂèëÔºâ
            const hasOpenModal = document.querySelector('.modal:not([style*="display: none"])');
            if (hasOpenModal) {
                return;
            }

            const key = e.key.toLowerCase();

            switch(key) {
                case 'p':
                    // Êí≠Êîæ/ÊöÇÂÅúÊí≠Êîæ
                    e.preventDefault();
                    if (typeof directPlayTest === 'function') {
                        directPlayTest();
                        console.log('‚å®Ô∏è Âø´Êç∑ÈîÆ: P - Êí≠Êîæ/ÊöÇÂÅú');
                    }
                    break;

                case 'arrowleft':
                    // ‰∏ä‰∏ÄÊù°
                    e.preventDefault();
                    if (typeof previousInterval === 'function') {
                        previousInterval();
                        console.log('‚å®Ô∏è Âø´Êç∑ÈîÆ: ‚Üê - ‰∏ä‰∏ÄÊù°');
                    }
                    break;

                case 'arrowright':
                    // ‰∏ã‰∏ÄÊù°
                    e.preventDefault();
                    if (typeof nextInterval === 'function') {
                        nextInterval();
                        console.log('‚å®Ô∏è Âø´Êç∑ÈîÆ: ‚Üí - ‰∏ã‰∏ÄÊù°');
                    }
                    break;

                case ' ':
                    // ÁîüÊàêÔºàÁ©∫Ê†ºÈîÆÔºâ
                    e.preventDefault();
                    if (typeof generateIntervals === 'function') {
                        generateIntervals();
                        console.log('‚å®Ô∏è Âø´Êç∑ÈîÆ: Space - ÁîüÊàêÈü≥Á®ã');
                    }
                    break;

                case 'h':
                    // ÈöêËóè/ÊòæÁ§∫
                    e.preventDefault();
                    if (typeof toggleIntervalVisibility === 'function') {
                        toggleIntervalVisibility();
                        console.log('‚å®Ô∏è Âø´Êç∑ÈîÆ: H - ÈöêËóè/ÊòæÁ§∫');
                    }
                    break;

                case 'c':
                    // ËäÇÊãçÂô®ÂºÄÂÖ≥
                    e.preventDefault();
                    if (typeof toggleMetronome === 'function') {
                        toggleMetronome();
                        console.log('‚å®Ô∏è Âø´Êç∑ÈîÆ: C - ËäÇÊãçÂô®ÂºÄÂÖ≥');
                    }
                    break;
            }
        });

        console.log('‚å®Ô∏è Èü≥Á®ãËßÜÂ•èÂ∑•ÂÖ∑Âø´Êç∑ÈîÆÂ∑≤ÂêØÁî®: P=Êí≠Êîæ ‚Üê‚Üí=ÂØºËà™ Space=ÁîüÊàê H=ÈöêËóè C=ËäÇÊãçÂô®');
    </script>

    <!-- üõ°Ô∏è ËØïÁî®‰øùÊä§Á≥ªÁªüËÑöÊú¨ -->
    <script src="/js/trial-limiter.js?v=20250909"></script>
    <script src="/js/advanced-trial-protection.js?v=20250920"></script>
    <script src="/js/melody-counter-system.js?v=20250920"></script>
    <script src="/js/integrated-trial-manager.js?v=20250920"></script>

</body></html>
