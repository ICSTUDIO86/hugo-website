<!DOCTYPE html>
<!-- saved from url=(0269)file:///Users/igorchen/Downloads/IC%20Studio/IC%20%E8%A7%86%E5%A5%8F%E5%B7%A5%E5%85%B7%20%E7%AC%AC%E4%B8%80%E7%89%88%20(%E5%B7%B2%E4%B8%8A%E6%9E%B6)%20%E9%9F%B3%E7%A8%8B%E4%BF%AE%E5%A4%8D%E4%B8%AD%202/%E5%92%8C%E5%BC%A6%E8%A7%86%E5%A5%8F%E7%94%9F%E6%88%90%E5%99%A8.html -->
<html lang="zh-CN" data-theme="light"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IC 视奏工具</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com/">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="">
    <link href="./IC 和弦视奏工具_files/css2" rel="stylesheet">

    <!-- OpenSheetMusicDisplay -->
    <script src="./IC 和弦视奏工具_files/opensheetmusicdisplay.min.js"></script>

    <!-- 🎹 钢琴音数生成引擎 -->
    <script src="./IC 和弦视奏工具_files/piano-note-count-engine.js"></script>

    <!-- 删除SpessaSynth - 改用更简单的Web Audio API方案 -->

    <link rel="stylesheet" href="./IC 和弦视奏工具_files/apple-ui-styles-chord.css">
    <script src="assets/js/sample-player.js?v=6"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function(){
        try {
          if (!window.__icSamplePlayer && window.ICSamplePlayer) {
            window.__icSamplePlayer = new ICSamplePlayer({ rootPath: 'assets/samples/piano-ogg-full' });
            window.__icSamplePlayer.load();
          }
        } catch(e) { console.warn('采样器初始化失败:', e); }
      });
    </script>
    <link rel="stylesheet" href="./IC 和弦视奏工具_files/chord-responsive-styles.css">

</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="header-text">
                    <h1 data-i18n="app.title">IC Studio - 和弦视奏生成器</h1>
                    <p data-i18n="app.subtitle">专业级乐谱渲染与音乐理论工具</p>
                </div>
                <div class="header-controls">
                    <div class="function-selector">
                        <button class="function-btn" id="functionBtn" onclick="toggleFunctionSelector()">
                            🎹 <span id="currentFunction" data-i18n="app.chordMode">和弦视奏</span>
                        </button>
                        <div class="function-menu" id="functionMenu">
                            <div class="function-option" onclick="switchFunction('melody')">
                                <span class="function-icon">🎵</span>
                                <span data-i18n="app.melodyMode">旋律视奏</span>
                            </div>
                            <div class="function-option" onclick="switchFunction('interval')">
                                <span class="function-icon">🎼</span>
                                <span data-i18n="app.intervalMode">音程视奏</span>
                            </div>
                            <div class="function-option" onclick="switchFunction('chord')">
                                <span class="function-icon">🎹</span>
                                <span data-i18n="app.chordMode">和弦视奏</span>
                            </div>
                        </div>
                    </div>
                    <div class="settings-dropdown">
                        <button class="settings-btn" id="settingsBtn" onclick="toggleSettings()">
                            ⚙️ <span data-i18n="settings.title">设置</span>
                        </button>
                        <div class="settings-menu" id="settingsMenu">
                            <!-- 主题设置 -->
                            <div class="settings-section">
                                <div class="settings-section-title" data-i18n="settings.theme">主题</div>
                                <div class="theme-options">
                                    <div class="theme-option" onclick="setTheme('light')">
                                        <span class="theme-icon">☀️</span>
                                        <span data-i18n="settings.lightMode">浅色模式</span>
                                    </div>
                                    <div class="theme-option" onclick="setTheme('dark')">
                                        <span class="theme-icon">🌙</span>
                                        <span data-i18n="settings.darkMode">深色模式</span>
                                    </div>
                                </div>
                            </div>

                            <!-- 语言设置 -->
                            <div class="settings-section">
                                <div class="settings-section-title" data-i18n="settings.language">语言</div>
                                <div class="language-options">
                                    <div class="language-option" onclick="switchLanguage('zh-CN')">
                                        简体中文
                                    </div>
                                    <div class="language-option" onclick="switchLanguage('zh-TW')">
                                        繁體中文
                                    </div>
                                    <div class="language-option" onclick="switchLanguage('en')">
                                        English
                                    </div>
                                </div>
                            </div>


                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="control-row">
                <div class="control-group">
                    <label data-i18n="controls.chordType">和弦类型</label>
                    <button class="btn-secondary" onclick="openChordTypeSettings()" id="chordTypeSettingsBtn" data-i18n="controls.chordTypeSettings">和弦类型设置</button>
                </div>

                <div class="control-group">
                    <label data-i18n="controls.harmonyMode">和声模式</label>
                    <div class="harmony-mode-toggle" style="display: flex; align-items: center; gap: 10px;">
                        <label class="switch" style="position: relative; display: inline-block; width: 60px; height: 34px;">
                            <input type="checkbox" id="functionalHarmonyToggle" onchange="toggleFunctionalHarmony()" style="opacity: 0; width: 0; height: 0;">
                            <span class="slider" style="position: absolute; cursor: pointer; inset: 0px; background-color: rgb(255, 149, 0); transition: 0.4s; border-radius: 34px;">
                                <span class="slider-button" style="position: absolute; content: &quot;&quot;; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: 0.4s; border-radius: 50%; transform: translateX(26px);"></span>
                            </span>
                        </label>
                        <span id="harmonyModeLabel" data-i18n="controls.randomMode" style="font-size: 14px; color: var(--text-color);">功能和声</span>
                    </div>

                    <div class="instrument-mode-section" style="margin-top: 12px;">
                        <label data-i18n="controls.instrumentMode" style="display: block; margin-bottom: 6px; font-size: 14px; font-weight: 500;">乐器模式</label>
                        <div class="instrument-mode-toggle" style="display: flex; align-items: center; gap: 10px;">
                            <label class="switch" style="position: relative; display: inline-block; width: 60px; height: 34px;">
                                <input type="checkbox" id="instrumentModeToggle" onchange="toggleInstrumentMode()" style="opacity: 0; width: 0; height: 0;">
                                <span class="slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: 0.4s; border-radius: 34px;">
                                    <span class="slider-button" style="position: absolute; content: '' ; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: 0.4s; border-radius: 50%; transform: translateX(0px);"></span>
                                </span>
                            </label>
                            <span id="instrumentModeLabel" data-i18n="controls.guitarMode" style="font-size: 14px; color: var(--text-color);">吉他和声</span>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <label data-i18n="controls.measures">小节数</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="measures-2" name="measures" value="2">
                            <label for="measures-2" data-i18n="controls.measures2">2小节</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="measures-4" name="measures" value="4" checked="">
                            <label for="measures-4" data-i18n="controls.measures4">4小节</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="measures-8" name="measures" value="8">
                            <label for="measures-8" data-i18n="controls.measures8">8小节</label>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <label data-i18n="controls.key">调号</label>
                    <button class="btn-secondary" onclick="openKeySignatureSettings()" id="keySettingsBtn" data-i18n="controls.KeySettings">调号设置</button>
                </div>

                <div class="control-group" style="display: none;">
                    <label data-i18n="controls.time">拍号</label>
                    <button class="btn-secondary" onclick="openTimeSignatureSettings()" id="timeSignatureSettingsBtn" data-i18n="controls.timeSettings">拍号设置</button>
                </div>

                <!-- 🔧 移除 (2025-10-02): 钢琴模式不需要谱号设置按钮，固定使用大谱表 -->
                <!-- <div class="control-group" id="clefControlGroup">
                    <label data-i18n="controls.clef">谱号</label>
                    <button class="btn-secondary" onclick="openClefSettings()" id="clefSettingsBtn" data-i18n="controls.clefSettings">
                        谱号设置
                    </button>
                </div> -->
            </div>

            <!-- 新增：音域设置 -->
            <!-- 🎸 吉他模式音域设置 -->
            <div id="guitarRangeSettings" style="display: block;">
            <div class="control-row">
                <div class="control-group">
                    <label for="rangeMin" data-i18n="controls.rangeMin">最低音</label>
                    <select id="rangeMin">
                        <option value="33">A1</option>
                        <option value="35">B1</option>
                        <option value="36">C2</option>
                        <option value="38">D2</option>
                        <option value="40">E2</option>
                        <option value="41">F2</option>
                        <option value="43">G2</option>
                        <option value="45">A2</option>
                        <option value="47">B2</option>
                        <option value="48">C3</option>
                        <option value="50">D3</option>
                        <option value="52">E3</option>
                        <option value="53">F3</option>
                        <option value="55">G3</option>
                        <option value="57">A3</option>
                        <option value="59">B3</option>
                        <option value="60" selected="">C4</option>
                        <option value="62">D4</option>
                        <option value="64">E4</option>
                        <option value="65">F4</option>
                        <option value="67">G4</option>
                        <option value="69">A4</option>
                        <option value="71">B4</option>
                        <option value="72">C5</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="rangeMax" data-i18n="controls.rangeMax">最高音</label>
                    <select id="rangeMax">
                        <option value="48">C3</option>
                        <option value="50">D3</option>
                        <option value="52">E3</option>
                        <option value="53">F3</option>
                        <option value="55">G3</option>
                        <option value="57">A3</option>
                        <option value="59">B3</option>
                        <option value="60">C4</option>
                        <option value="62">D4</option>
                        <option value="64">E4</option>
                        <option value="65">F4</option>
                        <option value="67">G4</option>
                        <option value="69">A4</option>
                        <option value="71">B4</option>
                        <option value="72">C5</option>
                        <option value="74">D5</option>
                        <option value="76">E5</option>
                        <option value="77">F5</option>
                        <option value="79">G5</option>
                        <option value="81">A5</option>
                        <option value="82">B5</option>
                        <option value="83">C6</option>
                        <option value="84">D6</option>
                        <option value="88" selected="">E6</option>
                    </select>
                </div>

                <!-- 🎼 显示控制开关 - 紧凑布局 -->
                <!-- 🎼 显示控制开关 - 紧凑布局，减少间距 -->
                <div class="control-group" style="flex: none; width: 140px; margin-right: 4px;">
                    <label data-i18n="controls.staff">五线谱</label>
                    <div class="toggle-container">
                        <input type="checkbox" id="staffDisplayToggle" checked="" class="toggle-input">
                        <label for="staffDisplayToggle" class="toggle-slider">
                            <span class="toggle-button"></span>
                        </label>
                    </div>
                </div>

                <div class="control-group" style="flex: none; width: 140px; margin-right: 0px;">
                    <label data-i18n="controls.chordSymbols">和弦代号</label>
                    <div class="toggle-container">
                        <input type="checkbox" id="chordSymbolsToggle" checked="" class="toggle-input">
                        <label for="chordSymbolsToggle" class="toggle-slider">
                            <span class="toggle-button"></span>
                        </label>
                    </div>
                </div>

                <div class="control-group metronome-group" style="flex: none; width: 160px;">
                    <label for="headerMetronomeBpm" data-i18n="controls.metronome">节拍器</label>
                    <div class="metronome-control">
                        <input type="number" id="headerMetronomeBpm" min="1" max="999" value="60" class="bpm-input-control">
                        <button class="metronome-play-btn" id="headerMetronomeBtn" onclick="toggleMetronome()" title="开始/停止节拍器">
                            🎵
                        </button>
                        <div class="metronome-beat-indicator" id="headerBeatIndicator"></div>
                    </div>
                </div>
            </div>
            </div>

            <!-- 🎹 钢琴模式音域设置 -->
            <div id="pianoRangeSettings" style="display: none;">
                <div class="control-row">
                    <div class="control-group">
                        <label data-i18n="piano.bassClefRange">低音谱号音域设置</label>
                        <button class="btn-secondary" onclick="openBassClefRangeModal()">
                            <span id="bassClefRangeDisplay">(E2-E4)</span>
                        </button>
                    </div>
                    <div class="control-group">
                        <label data-i18n="piano.trebleClefRange">高音谱号音域设置</label>
                        <button class="btn-secondary" onclick="openTrebleClefRangeModal()">
                            <span id="trebleClefRangeDisplay">(C4-E6)</span>
                        </button>
                    </div>

                    <!-- 🎼 显示控制开关 - 保持与吉他模式一致的布局 -->
                    <div class="control-group" style="flex: none; width: 140px; margin-right: 4px;">
                        <label data-i18n="controls.staff">五线谱</label>
                        <div class="toggle-container">
                            <input type="checkbox" id="staffDisplayToggle" checked="" class="toggle-input">
                            <label for="staffDisplayToggle" class="toggle-slider">
                                <span class="toggle-button"></span>
                            </label>
                        </div>
                    </div>

                    <div class="control-group" style="flex: none; width: 140px; margin-right: 0px;">
                        <label data-i18n="controls.chordSymbols">和弦代号</label>
                        <div class="toggle-container">
                            <input type="checkbox" id="chordSymbolsToggle" checked="" class="toggle-input">
                            <label for="chordSymbolsToggle" class="toggle-slider">
                                <span class="toggle-button"></span>
                            </label>
                        </div>
                    </div>

                    <div class="control-group metronome-group" style="flex: none; width: 160px;">
                        <label for="headerMetronomeBpm" data-i18n="controls.metronome">节拍器</label>
                        <div class="metronome-control">
                            <input type="number" id="headerMetronomeBpm" min="1" max="999" value="60" class="bpm-input-control">
                            <button class="metronome-play-btn" id="headerMetronomeBtn" onclick="toggleMetronome()" title="开始/停止节拍器">
                                🎵
                            </button>
                            <div class="metronome-beat-indicator" id="headerBeatIndicator"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="control-row">
                <div class="buttons">
                    <button id="generateChordsBtn" class="btn-primary" data-i18n="controls.generate">生成和弦</button>
                    <div class="button-group">
                        <button class="btn-secondary" onclick="previousChords()" data-i18n="controls.previous">上一条</button>
                        <button class="btn-secondary" onclick="nextChords()" data-i18n="controls.next">下一条</button>
                    </div>
                    <div class="button-group">
                        <button class="btn-secondary" id="playMelodyBtn" onclick="directPlayTest()" data-i18n="controls.play">播放</button>
                        <button class="melody-visibility-btn" id="melodyVisibilityBtn" onclick="toggleMelodyVisibility()" title="隐藏/显示和弦">
                            👀
                        </button>
                        
                    </div>
                    <div class="button-group" style="display: none;">
                        <button class="btn-secondary" onclick="openRhythmSettings()" data-i18n="controls.rhythm">节奏设置</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="score-container">
            <div id="score" title="点击生成新和弦" style="cursor: pointer;">
                <div class="empty-score-message">
                    <p data-i18n="score.empty">点击生成和弦开始练习</p>
                </div>
            </div>
        </div>

        <!-- 功能分析面板 -->
        <div class="analysis-panel" id="analysisPanel" style="display: none;">
            <div class="analysis-header">
                <h3>🎼 和弦功能分析</h3>
                <button class="toggle-btn" onclick="toggleAnalysisPanel()">收起</button>
            </div>
            <div class="analysis-content" id="analysisContent">
                <!-- 分析内容将通过JavaScript动态添加 -->
            </div>
        </div>

        <!-- Copyright Information -->
        <div style="
            padding: 5px 0;
            text-align: center;
            font-size: 14px;
            color: var(--neutral-dark);
            opacity: 0.7;
            border-top: 1px solid var(--border-color);
            margin-top: 7.5px;
        ">
            <p style="margin: 0; line-height: 1.5;">
                <strong>IC Studio 视奏工具</strong> - 专业级和弦视奏生成器
            </p>
            <p style="margin: 8px 0 0 0; font-size: 13px; opacity: 0.8;">
                Copyright © 2025. All rights reserved. Igor Chen -
                <a href="https://icstudio.club/" target="_blank" style="color: var(--primary-orange); text-decoration: none;">icstudio.club</a>
            </p>
        </div>

    </div>

    <!-- 和弦类型设置弹窗 -->
    <div id="chordTypeModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="modal.chordType.title">和弦类型设置</h3>
                <button class="close-btn" onclick="closeChordTypeSettings()">×</button>
            </div>
            <div class="modal-body">
                <div class="chord-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="modal.chordType.triads">三和弦</h4>
                        <button class="btn-select-all" onclick="selectAllBasicChords()" style="padding: 5px 10px; font-size: 12px; background: #FF9500; color: white; border: none; border-radius: 4px; cursor: pointer;" data-i18n="button.selectAll">全选</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="chord-major" value="major" checked="">
                            <span data-i18n="chord.major">大三和弦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="chord-minor" value="minor" checked="">
                            <span data-i18n="chord.minor">小三和弦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="chord-diminished" value="diminished">
                            <span data-i18n="chord.diminished">减三和弦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="chord-augmented" value="augmented">
                            <span data-i18n="chord.augmented">增三和弦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="chord-sus" value="sus">
                            <span data-i18n="chord.sus">挂和弦 (sus2/sus4)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="chord-triad-inversion" value="triad-inversion">
                            <span data-i18n="chord.triadInversion">包含转位</span>
                        </label>
                    </div>
                </div>

                <div class="chord-section" style="margin-top: 20px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="modal.chordType.seventhChords">七和弦</h4>
                        <button class="btn-select-all" onclick="selectAllSeventhChords()" style="padding: 5px 10px; font-size: 12px; background: #FF9500; color: white; border: none; border-radius: 4px; cursor: pointer;" data-i18n="button.selectAll">全选</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="chord-major7" value="major7">
                            <span data-i18n="chord.major7">大七和弦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="chord-minor7" value="minor7">
                            <span data-i18n="chord.minor7">小七和弦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="chord-dominant7" value="dominant7">
                            <span data-i18n="chord.dominant7">属七和弦</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="chord-minor7b5" value="minor7b5">
                            <span data-i18n="chord.minor7b5">半减七和弦 (m7♭5)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="chord-7sus" value="7sus">
                            <span data-i18n="chord.7sus">七挂和弦 (7sus2/7sus4)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="chord-seventh-inversion" value="seventh-inversion">
                            <span data-i18n="chord.seventhInversion">包含转位</span>
                        </label>
                    </div>
                </div>

                <!-- 高级设置区域 -->
                <div id="chordAdvancedSettings" style="display: none; margin-top: 20px; padding: 20px; background: var(--info-bg); border-radius: 8px; border: 2px solid var(--info-border);">
                    <h4 style="margin-bottom: 15px; color: var(--heading-text);" data-i18n="modal.chordType.advancedSettings">高级设置</h4>

                    <!-- 🎸 吉他模式高级设置 -->
                    <div id="guitarAdvancedSettings" style="display: block;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                            <h5 style="margin: 0; font-size: 14px; color: #666;" data-i18n="modal.chordType.voicingTypes">Voicing 类型选择</h5>
                            <button class="btn-select-all" onclick="toggleSelectAllVoicings()" style="padding: 5px 10px; font-size: 12px; background: #FF9500; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                <span id="voicingSelectAllText" data-i18n="button.selectAll">全选</span>
                            </button>
                        </div>
                        <div class="checkbox-grid">
                            <label class="checkbox-item">
                                <input type="checkbox" id="voicing-close" value="close" checked="">
                                <span data-i18n="voicing.close">密集排列 (Close)</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="voicing-drop2" value="drop2">
                                <span data-i18n="voicing.drop2">Drop 2 Voicing</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="voicing-drop3" value="drop3">
                                <span data-i18n="voicing.drop3">Drop 3 Voicing</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="voicing-shell" value="shell">
                                <span data-i18n="voicing.shell">Shell Voicing</span>
                            </label>
                        </div>

                        <div class="voicing-info">
                            <h5 data-i18n="voicing.description.title">功能说明：</h5>
                            <ul>
                                <li><strong>Close Voicing:</strong> <span data-i18n="voicing.description.close">和弦各音尽量紧密排列在一起、音程间距较小的和声配置（三音）</span></li>
                                <li><strong>Drop 2:</strong> <span data-i18n="voicing.description.drop2">将密集排列和声的第二高的音符降低一个八度（三音）</span></li>
                                <li><strong>Drop 3:</strong> <span data-i18n="voicing.description.drop3">将密集排列和声的第三高的音符降低一个八度（四音）</span></li>
                                <li><strong>Shell Voicing:</strong> <span data-i18n="voicing.description.shell">只保留和弦的 根音、三度、七度（省略五度等音）的简化和声配置（三音）</span></li>
                            </ul>
                        </div>
                    </div>

                    <!-- 🎹 钢琴模式高级设置 -->
                    <div id="pianoAdvancedSettings" style="display: none;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                            <h5 style="margin: 0; font-size: 14px; color: #666;" data-i18n="modal.chordType.pianoNoteCount">和声音数选择</h5>
                            <button class="btn-select-all" onclick="toggleSelectAllNoteCounts()" style="padding: 5px 10px; font-size: 12px; background: #FF9500; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                <span id="noteCountSelectAllText" data-i18n="button.selectAll">全选</span>
                            </button>
                        </div>
                        <!-- 🔧 修复 (2025-10-01): 移除2音、8音、9音，只保留3-7音 -->
                        <div class="checkbox-grid">
                            <label class="checkbox-item">
                                <input type="checkbox" id="notecount-3" value="3">
                                <span data-i18n="piano.noteCount.3">3音</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="notecount-4" value="4" checked="">
                                <span data-i18n="piano.noteCount.4">4音</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="notecount-5" value="5">
                                <span data-i18n="piano.noteCount.5">5音</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="notecount-6" value="6">
                                <span data-i18n="piano.noteCount.6">6音</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="notecount-7" value="7">
                                <span data-i18n="piano.noteCount.7">7音</span>
                            </label>
                        </div>

                        <div class="voicing-info">
                            <h5 data-i18n="piano.noteCount.description.title">钢琴模式说明：</h5>
                            <ul>
                                <li data-i18n="piano.noteCount.description.bass">低音谱号：最低音始终是根音，落在低音谱号音域范围内</li>
                                <li data-i18n="piano.noteCount.description.treble">高音谱号：其余音符（至少2个）放在高音谱号音域，排列顺序随机</li>
                                <li data-i18n="piano.noteCount.description.priority">优先音：三音、七音、sus音、tension音优先选择（尽量不重复）</li>
                                <li data-i18n="piano.noteCount.description.optional">可选音：五音在音数较多时加入，根音和五音可以重复</li>
                            </ul>
                        </div>

                        <!-- 🎵 Tension Note 开关 (2025-10-01新增) -->
                        <div style="margin-top: 15px;">
                            <label class="checkbox-item">
                                <input type="checkbox" id="tension-note-toggle" value="tension">
                                <span data-i18n="piano.tensionNote">🎵 Tension Note (加色音)</span>
                            </label>
                        </div>

                        <div class="voicing-info">
                            <p style="margin: 0; font-size: 12px; line-height: 1.5;">
                                在4-7音配置中智能添加9th、11th、13th等加色音<br>
                                <span style="opacity: 0.7;">基于爵士和声理论，避免禁忌音/冲突音</span>
                            </p>
                        </div>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-secondary" onclick="toggleChordAdvancedSettings()" id="chordAdvancedBtn" data-i18n="button.advanced">高级设置</button>
                    <button class="btn-primary" onclick="saveChordTypeSettings()" data-i18n="button.save">保存设置</button>
                    <button class="btn-secondary" onclick="closeChordTypeSettings()" data-i18n="button.cancel">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 节奏设置弹窗 -->
    <div id="rhythmModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="modal.rhythm.title">节奏设置</h3>
                <button class="close-btn" onclick="closeRhythmSettings()">×</button>
            </div>
            <div class="modal-body">
                <div class="rhythm-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="modal.rhythm.basicUnit">基本节奏单位</h4>
                        <button class="btn-select-all" onclick="selectAllRhythms()" style="padding: 5px 10px; font-size: 12px; background: #FF9500; color: white; border: none; border-radius: 4px; cursor: pointer;" data-i18n="button.selectAll">全选</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="rhythm-whole" value="whole">
                            <span data-i18n="rhythm.whole">全音符</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="rhythm-half" value="half" checked="">
                            <span data-i18n="rhythm.half">二分音符</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="rhythm-quarter" value="quarter" checked="">
                            <span data-i18n="rhythm.quarter">四分音符</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="rhythm-eighth" value="eighth">
                            <span data-i18n="rhythm.eighth">八分音符</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="rhythm-sixteenth" value="sixteenth">
                            <span data-i18n="rhythm.sixteenth">十六分音符</span>
                        </label>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveRhythmSettings()" data-i18n="button.save">保存设置</button>
                    <button class="btn-secondary" onclick="closeRhythmSettings()" data-i18n="button.cancel">取消</button>
                </div>
            </div>
        </div>
    </div>


    <!-- 调号设置弹窗 -->
    <div id="keySignatureModal" class="modal" style="display: none;" onclick="if(event.target===this) saveKeySettings()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 data-i18n="modal.keySignature.title">调号设置</h3>
                <button class="close-btn" onclick="closeKeySettings()">×</button>
            </div>
            <div class="modal-body">
                <div class="key-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="modal.keySignature.major">大调 (Major)</h4>
                        <button class="btn-select-all" onclick="selectAllMajorKeys()" style="padding: 5px 10px; font-size: 12px; background: #FF9500; color: white; border: none; border-radius: 4px; cursor: pointer;" data-i18n="button.selectAllMajor">全选</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-C-major" value="C-major" checked="">
                            <span data-i18n="key.C-major">C 大调</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-G-major" value="G-major">
                            <span data-i18n="key.G-major">G 大调 (1#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-D-major" value="D-major">
                            <span data-i18n="key.D-major">D 大调 (2#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-A-major" value="A-major">
                            <span data-i18n="key.A-major">A 大调 (3#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-E-major" value="E-major">
                            <span data-i18n="key.E-major">E 大调 (4#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-B-major" value="B-major">
                            <span data-i18n="key.B-major">B 大调 (5#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Fs-major" value="F#-major">
                            <span data-i18n="key.Fs-major">F# 大调 (6#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-F-major" value="F-major">
                            <span data-i18n="key.F-major">F 大调 (1b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Bb-major" value="Bb-major">
                            <span data-i18n="key.Bb-major">Bb 大调 (2b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Eb-major" value="Eb-major">
                            <span data-i18n="key.Eb-major">Eb 大调 (3b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Ab-major" value="Ab-major">
                            <span data-i18n="key.Ab-major">Ab 大调 (4b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Db-major" value="Db-major">
                            <span data-i18n="key.Db-major">Db 大调 (5b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-Gb-major" value="Gb-major">
                            <span data-i18n="key.Gb-major">Gb 大调 (6b)</span>
                        </label>
                    </div>
                </div>

                <div class="key-section" style="margin-top: 20px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="modal.keySignature.minor">小调 (Minor)</h4>
                        <button class="btn-select-all" onclick="selectAllMinorKeys()" style="padding: 5px 10px; font-size: 12px; background: #FF9500; color: white; border: none; border-radius: 4px; cursor: pointer;" data-i18n="button.selectAllMinor">全选</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-a-minor" value="a-minor" checked="">
                            <span data-i18n="key.a-minor">A 小调</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-e-minor" value="e-minor">
                            <span data-i18n="key.e-minor">E 小调 (1#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-b-minor" value="b-minor">
                            <span data-i18n="key.b-minor">B 小调 (2#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-fs-minor" value="f#-minor">
                            <span data-i18n="key.fs-minor">F# 小调 (3#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-cs-minor" value="c#-minor">
                            <span data-i18n="key.cs-minor">C# 小调 (4#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-gs-minor" value="g#-minor">
                            <span data-i18n="key.gs-minor">G# 小调 (5#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-ds-minor" value="d#-minor">
                            <span data-i18n="key.ds-minor">D# 小调 (6#)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-d-minor" value="d-minor">
                            <span data-i18n="key.d-minor">D 小调 (1b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-g-minor" value="g-minor">
                            <span data-i18n="key.g-minor">G 小调 (2b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-c-minor" value="c-minor">
                            <span data-i18n="key.c-minor">C 小调 (3b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-f-minor" value="f-minor">
                            <span data-i18n="key.f-minor">F 小调 (4b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-bb-minor" value="bb-minor">
                            <span data-i18n="key.bb-minor">Bb 小调 (5b)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="key-eb-minor" value="eb-minor">
                            <span data-i18n="key.eb-minor">Eb 小调 (6b)</span>
                        </label>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveKeySettings()" data-i18n="button.save">保存设置</button>
                    <button class="btn-secondary" onclick="closeKeySettings()" data-i18n="button.cancel">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 拍号设置弹窗 -->
    <div id="timeSignatureModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="modal.timeSignature.title">拍号设置</h3>
                <button class="close-btn" onclick="closeTimeSignatureSettings()">×</button>
            </div>
            <div class="modal-body">
                <div class="time-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="modal.timeSignature.selection">拍号选择</h4>
                        <button class="btn-select-all" onclick="selectAllTimeSignatures()" style="padding: 5px 10px; font-size: 12px; background: #FF9500; color: white; border: none; border-radius: 4px; cursor: pointer;" data-i18n="button.selectAll">全选</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="time-4-4" value="4/4" checked="">
                            <span>4/4</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="time-3-4" value="3/4">
                            <span>3/4</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="time-2-4" value="2/4">
                            <span>2/4</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="time-6-8" value="6/8">
                            <span>6/8</span>
                        </label>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveTimeSignatureSettings()" data-i18n="button.save">保存设置</button>
                    <button class="btn-secondary" onclick="closeTimeSignatureSettings()" data-i18n="button.cancel">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 谱号设置弹窗 -->
    <div id="clefModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="modal.clef.title">谱号设置</h3>
                <button class="close-btn" onclick="closeClefSettings()">×</button>
            </div>
            <div class="modal-body">
                <div class="clef-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 data-i18n="modal.clef.selection">谱号选择</h4>
                        <button class="btn-select-all" onclick="selectAllClefs()" style="padding: 5px 10px; font-size: 12px; background: #FF9500; color: white; border: none; border-radius: 4px; cursor: pointer;" data-i18n="button.selectAll">全选</button>
                    </div>
                    <div class="checkbox-grid">
                        <label class="checkbox-item">
                            <input type="checkbox" id="clef-grand_staff" value="grand_staff" checked="">
                            <span data-i18n="clef.grand_staff">大谱表</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="clef-treble" value="treble">
                            <span data-i18n="clef.treble">高音谱号</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="clef-bass" value="bass">
                            <span data-i18n="clef.bass">低音谱号</span>
                        </label>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveClefSettings()" data-i18n="button.save">保存设置</button>
                    <button class="btn-secondary" onclick="closeClefSettings()" data-i18n="button.cancel">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 🎹 低音谱号音域设置弹窗 -->
    <div id="bassClefRangeModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="modal.bassClefRange.title">低音谱号音域设置</h3>
                <button class="close-btn" onclick="closeBassClefRangeModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="range-section">
                    <div class="control-group">
                        <label for="bassClefRangeMin" data-i18n="piano.bassClefMin">最低音</label>
                        <select id="bassClefRangeMin">
                            <option value="28">E1</option>
                            <option value="33">A1</option>
                            <option value="35">B1</option>
                            <option value="36">C2</option>
                            <option value="38">D2</option>
                            <option value="40" selected="">E2</option>
                            <option value="41">F2</option>
                            <option value="43">G2</option>
                            <option value="45">A2</option>
                            <option value="47">B2</option>
                            <option value="48">C3</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="bassClefRangeMax" data-i18n="piano.bassClefMax">最高音</label>
                        <select id="bassClefRangeMax">
                            <option value="36">C2</option>
                            <option value="38">D2</option>
                            <option value="40">E2</option>
                            <option value="41">F2</option>
                            <option value="43">G2</option>
                            <option value="45">A2</option>
                            <option value="47">B2</option>
                            <option value="48">C3</option>
                            <option value="50">D3</option>
                            <option value="52">E3</option>
                            <option value="53">F3</option>
                            <option value="55">G3</option>
                            <option value="57">A3</option>
                            <option value="59">B3</option>
                            <option value="60">C4</option>
                            <option value="62">D4</option>
                            <option value="64" selected="">E4</option>
                        </select>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveBassClefRange()" data-i18n="button.save">保存设置</button>
                    <button class="btn-secondary" onclick="closeBassClefRangeModal()" data-i18n="button.cancel">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 🎹 高音谱号音域设置弹窗 -->
    <div id="trebleClefRangeModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="modal.trebleClefRange.title">高音谱号音域设置</h3>
                <button class="close-btn" onclick="closeTrebleClefRangeModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="range-section">
                    <div class="control-group">
                        <label for="trebleClefRangeMin" data-i18n="piano.trebleClefMin">最低音</label>
                        <select id="trebleClefRangeMin">
                            <option value="55">G3</option>
                            <option value="57">A3</option>
                            <option value="59">B3</option>
                            <option value="60" selected="">C4</option>
                            <option value="62">D4</option>
                            <option value="64">E4</option>
                            <option value="65">F4</option>
                            <option value="67">G4</option>
                            <option value="69">A4</option>
                            <option value="71">B4</option>
                            <option value="72">C5</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="trebleClefRangeMax" data-i18n="piano.trebleClefMax">最高音</label>
                        <select id="trebleClefRangeMax">
                            <option value="72">C5</option>
                            <option value="74">D5</option>
                            <option value="76">E5</option>
                            <option value="77">F5</option>
                            <option value="79">G5</option>
                            <option value="81">A5</option>
                            <option value="83">B5</option>
                            <option value="84">C6</option>
                            <option value="86">D6</option>
                            <option value="88" selected="">E6</option>
                            <option value="89">F6</option>
                            <option value="91">G6</option>
                            <option value="93">A6</option>
                        </select>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button class="btn-primary" onclick="saveTrebleClefRange()" data-i18n="button.save">保存设置</button>
                    <button class="btn-secondary" onclick="closeTrebleClefRangeModal()" data-i18n="button.cancel">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 🎯 通用弹窗外部点击关闭功能 -->
    <script>
        // ============================================================
        // 多语言系统 (Multi-language System)
        // ============================================================
        // ✅ translations 对象已在 chord-sight-reading.js 中定义
        // 移除此处重复声明以避免 SyntaxError: Identifier 'translations' has already been declared

        // ============================================================
        // UI控制函数 (UI Control Functions)
        // ============================================================

        // 设置菜单控制
        function toggleSettings() {
            const settingsMenu = document.getElementById('settingsMenu');
            const isVisible = settingsMenu.classList.contains('show');

            if (isVisible) {
                closeSettings();
            } else {
                openSettings();
            }
        }

        function openSettings() {
            const settingsMenu = document.getElementById('settingsMenu');
            settingsMenu.classList.add('show');

            // 添加点击外部区域关闭菜单的监听器
            setTimeout(() => {
                document.addEventListener('click', handleClickOutside);
            }, 10);
        }

        function closeSettings() {
            const settingsMenu = document.getElementById('settingsMenu');
            settingsMenu.classList.remove('show');

            // 移除点击外部区域的监听器
            document.removeEventListener('click', handleClickOutside);
        }

        // 功能选择器控制
        function toggleFunctionSelector() {
            const functionMenu = document.getElementById('functionMenu');
            const isVisible = functionMenu.classList.contains('show');

            if (isVisible) {
                closeFunctionSelector();
            } else {
                openFunctionSelector();
            }
        }

        function openFunctionSelector() {
            const functionMenu = document.getElementById('functionMenu');
            functionMenu.classList.add('show');

            // 添加点击外部区域关闭菜单的监听器
            setTimeout(() => {
                document.addEventListener('click', handleFunctionClickOutside);
            }, 10);
        }

        function closeFunctionSelector() {
            const functionMenu = document.getElementById('functionMenu');
            functionMenu.classList.remove('show');

            // 移除点击外部区域的监听器
            document.removeEventListener('click', handleFunctionClickOutside);
        }

        // 处理点击外部区域关闭功能菜单
        function handleFunctionClickOutside(event) {
            const functionSelector = document.querySelector('.function-selector');

            if (functionSelector && !functionSelector.contains(event.target)) {
                closeFunctionSelector();
            }
        }

        // 切换功能
        function switchFunction(mode) {
            if (mode === 'melody') {
                // 导航到旋律视奏页面
                window.location.href = 'IC 旋律视奏工具.html';
            } else if (mode === 'interval') {
                // 导航到音程视奏页面
                window.location.href = 'IC 音程视奏工具.html';
            } else if (mode === 'chord') {
                // 已经在和弦视奏页面
                closeFunctionSelector();
                console.log('已在和弦视奏模式');
            }
        }

        // 处理点击外部区域关闭设置菜单
        function handleClickOutside(event) {
            const settingsDropdown = document.querySelector('.settings-dropdown');

            if (settingsDropdown && !settingsDropdown.contains(event.target)) {
                closeSettings();
            }
        }

        // 🎯 通用弹窗外部点击关闭功能
        function initializeModalClickOutsideToClose() {
            const modalIds = [
                'chordTypeModal',
                'rhythmModal',
                'keySignatureModal',
                'timeSignatureModal',
                'clefModal',
                'bassClefRangeModal',
                'trebleClefRangeModal'
            ];

            modalIds.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.addEventListener('click', function(event) {
                        // 只有当点击的是弹窗背景（modal容器本身）时才关闭
                        if (event.target === modal) {
                            console.log(`🎯 点击外部区域关闭弹窗: ${modalId}`);

                            // 根据弹窗类型调用相应的关闭函数
                            switch(modalId) {
                                case 'chordTypeModal':
                                    if (typeof closeChordTypeSettings === 'function') {
                                        closeChordTypeSettings();
                                    }
                                    break;
                                case 'rhythmModal':
                                    if (typeof closeRhythmSettings === 'function') {
                                        closeRhythmSettings();
                                    }
                                    break;
                                case 'keySignatureModal':
                                    if (typeof saveKeySettings === 'function') {
                                        saveKeySettings(); // 外部点击时保存设置并关闭
                                    }
                                    break;
                                case 'timeSignatureModal':
                                    if (typeof closeTimeSignatureSettings === 'function') {
                                        closeTimeSignatureSettings();
                                    }
                                    break;
                                case 'clefModal':
                                    if (typeof closeClefSettings === 'function') {
                                        closeClefSettings();
                                    }
                                    break;
                                case 'bassClefRangeModal':
                                    if (typeof saveBassClefRange === 'function') {
                                        saveBassClefRange(); // 外部点击时保存设置并关闭
                                    }
                                    break;
                                case 'trebleClefRangeModal':
                                    if (typeof saveTrebleClefRange === 'function') {
                                        saveTrebleClefRange(); // 外部点击时保存设置并关闭
                                    }
                                    break;
                                default:
                                    // 通用关闭方法
                                    modal.style.display = 'none';
                            }
                        }
                    });
                    console.log(`✅ 已为 ${modalId} 添加外部点击关闭功能`);
                }
            });
        }

        // 🎯 功能菜单和设置菜单外部点击关闭功能
        function initializeMenuClickOutsideToClose() {
            document.addEventListener('click', function(event) {
                // 处理功能选择器菜单
                const functionMenu = document.getElementById('functionMenu');
                const functionBtn = document.getElementById('functionBtn');

                if (functionMenu && functionMenu.classList.contains('show')) {
                    // 如果点击的不是菜单本身或触发按钮，则关闭菜单
                    if (!functionMenu.contains(event.target) && !functionBtn.contains(event.target)) {
                        functionMenu.classList.remove('show');
                        console.log('🎯 点击外部区域关闭功能菜单');
                    }
                }

                // 处理设置菜单
                const settingsMenu = document.getElementById('settingsMenu');
                const settingsBtn = document.getElementById('settingsBtn');

                if (settingsMenu && settingsMenu.classList.contains('show')) {
                    // 如果点击的不是菜单本身或触发按钮，则关闭菜单
                    if (!settingsMenu.contains(event.target) && !settingsBtn.contains(event.target)) {
                        settingsMenu.classList.remove('show');
                        console.log('🎯 点击外部区域关闭设置菜单');
                    }
                }
            });
        }

        // 在页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeModalClickOutsideToClose();
            initializeMenuClickOutsideToClose();
            console.log('🎯 弹窗外部点击关闭功能已初始化');
            console.log('🎯 菜单外部点击关闭功能已初始化');
        });
    </script>

    <!-- 和弦生成器模块 -->
    <script src="./IC 和弦视奏工具_files/harmony-theory.js"></script>
    <script src="./IC 和弦视奏工具_files/enhanced-harmony.js"></script>
    <script src="./IC 和弦视奏工具_files/chord-progressions.js"></script>
    <script src="./IC 和弦视奏工具_files/jazz-harmony.js"></script>
    <script src="./IC 和弦视奏工具_files/voicing-engine.js"></script>
    <script src="./IC 和弦视奏工具_files/drop-voicing-simple.js"></script> <!-- 🎯 极简Drop2/Drop3实现 (2025-10-03) -->
    <script src="./IC 和弦视奏工具_files/voice-leading.js"></script>

    <!-- 🎵 独立小调拼写系统 - 完全独立模块，解决八度和变体音问题 -->
    <script src="./IC 和弦视奏工具_files/minor-key-spelling.js"></script>
    <script src="./IC 和弦视奏工具_files/minor-scale-alterations.js"></script>

    <!-- 🌐 国际化（i18n）系统 - 多语言支持 (2025-10-04) -->
    <script src="./IC 和弦视奏工具_files/i18n.js"></script>

    <script src="./IC 和弦视奏工具_files/chord-sight-reading.js"></script>

    <!-- 钢琴独立生成系统 -->
    <script src="./IC 和弦视奏工具_files/piano-settings-manager.js"></script>
    <script src="./IC 和弦视奏工具_files/piano-harmony-engine.js"></script>
    <script src="./IC 和弦视奏工具_files/piano-voicing-engine.js"></script>
    <script src="./IC 和弦视奏工具_files/piano-chord-progression-generator.js"></script>
    <script src="./IC 和弦视奏工具_files/piano-chord-generator.js"></script>

    <!-- 吉他独立转位系统 - 安全模式实现 -->
    <script src="./IC 和弦视奏工具_files/enhanced-voicing-settings.js"></script>
    <!-- 使用新的安全独立voicing控制，不修改原VoicingEngine -->
    <!-- <script src="chords-generator/safe-independent-voicing.js"></script> -->
    <!-- 注：文件不存在，避免404错误 (2025-10-02清理) -->
    <!-- 旧的扩展系统已禁用，避免自动修改VoicingEngine原型 -->
    <!-- <script src="chords-generator/independent-voicing-extensions.js"></script> -->
    <!-- <script src="chords-generator/independent-voicing-generator.js"></script> -->
    <!-- <script src="chords-generator/independent-voicing-test.js"></script> -->

    <!-- Voicing修复验证脚本 -->
    <script src="file:///Users/igorchen/Downloads/IC%20Studio/IC%20%E8%A7%86%E5%A5%8F%E5%B7%A5%E5%85%B7%20%E7%AC%AC%E4%B8%80%E7%89%88%20(%E5%B7%B2%E4%B8%8A%E6%9E%B6)%20%E9%9F%B3%E7%A8%8B%E4%BF%AE%E5%A4%8D%E4%B8%AD%202/chords-generator/voicing-fix-verification.js"></script>

    <!-- 依赖性测试脚本 -->
    <script src="file:///Users/igorchen/Downloads/IC%20Studio/IC%20%E8%A7%86%E5%A5%8F%E5%B7%A5%E5%85%B7%20%E7%AC%AC%E4%B8%80%E7%89%88%20(%E5%B7%B2%E4%B8%8A%E6%9E%B6)%20%E9%9F%B3%E7%A8%8B%E4%BF%AE%E5%A4%8D%E4%B8%AD%202/chords-generator/dependency-test.js"></script>

    <!-- 独立转位控制使用指南 -->
    <script src="file:///Users/igorchen/Downloads/IC%20Studio/IC%20%E8%A7%86%E5%A5%8F%E5%B7%A5%E5%85%B7%20%E7%AC%AC%E4%B8%80%E7%89%88%20(%E5%B7%B2%E4%B8%8A%E6%9E%B6)%20%E9%9F%B3%E7%A8%8B%E4%BF%AE%E5%A4%8D%E4%B8%AD%202/chords-generator/independent-voicing-guide.js"></script>

    <!-- 当前系统影响测试 -->
    <script src="file:///Users/igorchen/Downloads/IC%20Studio/IC%20%E8%A7%86%E5%A5%8F%E5%B7%A5%E5%85%B7%20%E7%AC%AC%E4%B8%80%E7%89%88%20(%E5%B7%B2%E4%B8%8A%E6%9E%B6)%20%E9%9F%B3%E7%A8%8B%E4%BF%AE%E5%A4%8D%E4%B8%AD%202/chords-generator/current-system-impact-test.js"></script>

    <!-- 底层逻辑修改验证测试 -->
    <script src="file:///Users/igorchen/Downloads/IC%20Studio/IC%20%E8%A7%86%E5%A5%8F%E5%B7%A5%E5%85%B7%20%E7%AC%AC%E4%B8%80%E7%89%88%20(%E5%B7%B2%E4%B8%8A%E6%9E%B6)%20%E9%9F%B3%E7%A8%8B%E4%BF%AE%E5%A4%8D%E4%B8%AD%202/chords-generator/bottom-logic-modification-test.js"></script>

    <!-- 快速七和弦测试 -->
    <script src="file:///Users/igorchen/Downloads/IC%20Studio/IC%20%E8%A7%86%E5%A5%8F%E5%B7%A5%E5%85%B7%20%E7%AC%AC%E4%B8%80%E7%89%88%20(%E5%B7%B2%E4%B8%8A%E6%9E%B6)%20%E9%9F%B3%E7%A8%8B%E4%BF%AE%E5%A4%8D%E4%B8%AD%202/chords-generator/quick-seventh-chord-test.js"></script>

    <!-- Drop2/Drop3原位保护测试 (2025-10-02) -->
    <script src="./IC 和弦视奏工具_files/test-drop-root-position.js"></script>

    <!-- Drop2/Drop3正确实现 (2025-10-02修复) -->
    <script src="./IC 和弦视奏工具_files/DROP-VOICING-FIX.js"></script>

    <!-- 和弦代号诊断工具 (2025-10-02) -->
    <script src="./IC 和弦视奏工具_files/chord-analysis-diagnosis.js"></script>

    <!-- 和弦显示监控工具 (2025-10-02) -->
    <script src="./IC 和弦视奏工具_files/chord-display-monitor.js"></script>

    <!-- 增强功能和声系统初始化 -->
    <script>
        // ============ 主题切换功能 ============
        let currentTheme = localStorage.getItem('preferredTheme') || 'light';

        // 主题图标映射
        const themeIcons = {
            'light': '🌙', // 在light模式显示月亮图标，点击切换到dark
            'dark': '☀️'   // 在dark模式显示太阳图标，点击切换到light
        };

        // 切换主题 (保留向后兼容性)
        function toggleTheme() {
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            setTheme(newTheme);
        }

        // 设置主题 (新版本，用于设置菜单)
        function setTheme(theme) {
            currentTheme = theme;
            localStorage.setItem('preferredTheme', theme);

            // 设置HTML的data-theme属性
            document.documentElement.setAttribute('data-theme', theme);

            // 触发统一同步系统 (同标签页内实时同步)
            if (window.ICStudioSync) {
                window.ICStudioSync.syncTheme(theme, 'chord-tool');
            }

            // 关闭设置菜单
            if (typeof closeSettings === 'function') {
                closeSettings();
            }

            console.log(`🎨 和弦视奏工具主题已设置为: ${theme}`);
        }

        // 初始化主题
        function initializeTheme() {
            document.documentElement.setAttribute('data-theme', currentTheme);
            console.log(`🎨 和弦视奏工具主题初始化: ${currentTheme}`);
        }

        // ============ 翻译功能 ============
        // 注意：使用 chord-sight-reading.js 中定义的 translations 变量

        // 语言切换相关变量
        let currentLanguage = localStorage.getItem('preferredLanguage') || 'en';

        // 翻译函数
        function applyTranslations() {
            // 🔧 使用 I18n 系统 (2025-10-04)
            if (window.I18n && window.I18n.applyLanguage) {
                window.I18n.applyLanguage(currentLanguage);
            } else {
                console.warn('⚠️ I18n系统未加载，无法应用翻译');
            }
        }

        // 全局翻译函数（供弹窗调用）
        window.translatePage = function() {
            applyTranslations();
        };

        // 翻译函数 - 获取指定键的翻译文本
        function translate(key) {
            // 🔧 使用 I18n 系统 (2025-10-04)
            if (window.I18n && window.I18n.t) {
                return window.I18n.t(key, currentLanguage);
            }
            // 如果I18n未加载，返回键名作为后备
            return key;
        }

        // 更新动态控件文本翻译
        function updateDynamicControlsTranslation() {
            // 更新和声模式标签
            const harmonyModeLabel = document.getElementById('harmonyModeLabel');
            if (harmonyModeLabel) {
                const toggle = document.getElementById('functionalHarmonyToggle');
                if (toggle && toggle.checked) {
                    harmonyModeLabel.textContent = translate('controls.functionalMode');
                } else {
                    harmonyModeLabel.textContent = translate('controls.randomMode');
                }
            }

            // 更新乐器模式标签
            const instrumentModeLabel = document.getElementById('instrumentModeLabel');
            if (instrumentModeLabel) {
                const toggle = document.getElementById('instrumentModeToggle');
                if (toggle && toggle.checked) {
                    instrumentModeLabel.textContent = translate('controls.pianoMode');
                } else {
                    instrumentModeLabel.textContent = translate('controls.guitarMode');
                }
            }

            // 更新高级设置按钮文本
            const advancedBtn = document.getElementById('chordAdvancedBtn');
            const advancedDiv = document.getElementById('chordAdvancedSettings');
            if (advancedBtn && advancedDiv) {
                const isVisible = advancedDiv.style.display !== 'none';
                if (isVisible) {
                    advancedBtn.textContent = translate('button.hideAdvanced');
                } else {
                    advancedBtn.textContent = translate('button.showAdvanced');
                }
            }

            // 更新和弦代号按钮标题
            const chordSymbolBtn = document.getElementById('chordSymbolBtn');
            if (chordSymbolBtn) {
                if (chordSymbolsVisible) {
                    chordSymbolBtn.title = translate('controls.chordSymbolsHide');
                } else {
                    chordSymbolBtn.title = translate('controls.chordSymbolsShow');
                }
            }
        }

        // 高级设置切换函数
        function toggleChordAdvancedSettings() {
            const advancedDiv = document.getElementById('chordAdvancedSettings');
            const btn = document.getElementById('chordAdvancedBtn');

            if (advancedDiv && btn) {
                const isVisible = advancedDiv.style.display !== 'none';

                if (isVisible) {
                    advancedDiv.style.display = 'none';
                    btn.textContent = translate('button.showAdvanced');
                } else {
                    advancedDiv.style.display = 'block';
                    btn.textContent = translate('button.hideAdvanced');
                }
            }
        }

        // 语言切换函数
        function switchLanguage(language) {
            currentLanguage = language;
            localStorage.setItem('preferredLanguage', language);
            applyTranslations();

            // 触发统一同步系统 (同标签页内实时同步)
            if (window.ICStudioSync) {
                window.ICStudioSync.syncLanguage(language, 'chord-tool');
            }

            // 关闭设置菜单
            if (typeof closeSettings === 'function') {
                closeSettings();
            }

            console.log(`🌐 和弦视奏工具语言已切换为: ${language}`);
        }

        // 设置菜单控制系统 - 统一实现
        function toggleSettings() {
            const settingsMenu = document.getElementById('settingsMenu');
            const isVisible = settingsMenu.classList.contains('show');

            if (isVisible) {
                closeSettings();
            } else {
                openSettings();
            }
        }

        function openSettings() {
            const settingsMenu = document.getElementById('settingsMenu');
            settingsMenu.classList.add('show');

            // 添加点击外部区域关闭菜单的监听器
            setTimeout(() => {
                document.addEventListener('click', handleClickOutside);
            }, 10);
        }

        function closeSettings() {
            const settingsMenu = document.getElementById('settingsMenu');
            settingsMenu.classList.remove('show');

            // 移除点击外部区域的监听器
            document.removeEventListener('click', handleClickOutside);
        }

        // 处理点击外部区域关闭设置菜单
        function handleClickOutside(event) {
            const settingsDropdown = document.querySelector('.settings-dropdown');

            if (settingsDropdown && !settingsDropdown.contains(event.target)) {
                closeSettings();
            }
        }

        // 页面加载时初始化主题和翻译
        document.addEventListener('DOMContentLoaded', function() {
            initializeTheme();
            applyTranslations();
            console.log('🎨🌐 和弦视奏工具主题和翻译功能已初始化');

            // ============ 跨工具同步监听机制 ============
            // 监听其他工具对localStorage的修改
            window.addEventListener('storage', function(e) {
                if (e.key === 'preferredTheme' && e.newValue !== currentTheme) {
                    console.log(`🔄 和弦视奏工具检测到主题变化: ${currentTheme} → ${e.newValue}`);
                    currentTheme = e.newValue;
                    document.documentElement.setAttribute('data-theme', currentTheme);
                    console.log(`🎨 和弦视奏工具主题已同步为: ${currentTheme}`);
                }

                if (e.key === 'preferredLanguage' && e.newValue !== currentLanguage) {
                    console.log(`🔄 和弦视奏工具检测到语言变化: ${currentLanguage} → ${e.newValue}`);
                    currentLanguage = e.newValue;
                    applyTranslations();
                    console.log(`🌐 和弦视奏工具语言已同步为: ${currentLanguage}`);
                }
            });

            console.log('🔗 和弦视奏工具localStorage跨工具同步监听已启用');

            // ============ 统一同步系统 ============
            // 创建全局同步函数，支持同标签页内实时同步
            window.ICStudioSync = window.ICStudioSync || {
                tools: new Set(),

                // 注册工具
                registerTool: function(toolName, callbacks) {
                    this.tools.add({
                        name: toolName,
                        onThemeChange: callbacks.onThemeChange,
                        onLanguageChange: callbacks.onLanguageChange
                    });
                    console.log(`🔗 ${toolName} 已注册到统一同步系统`);
                },

                // 同步主题到所有工具
                syncTheme: function(newTheme, fromTool) {
                    console.log(`🔄 统一同步系统: 同步主题 ${newTheme} (来源: ${fromTool})`);
                    this.tools.forEach(tool => {
                        if (tool.name !== fromTool && tool.onThemeChange) {
                            try {
                                tool.onThemeChange(newTheme);
                            } catch (error) {
                                console.warn(`⚠️ ${tool.name} 主题同步失败:`, error);
                            }
                        }
                    });
                },

                // 同步语言到所有工具
                syncLanguage: function(newLanguage, fromTool) {
                    console.log(`🔄 统一同步系统: 同步语言 ${newLanguage} (来源: ${fromTool})`);
                    this.tools.forEach(tool => {
                        if (tool.name !== fromTool && tool.onLanguageChange) {
                            try {
                                tool.onLanguageChange(newLanguage);
                            } catch (error) {
                                console.warn(`⚠️ ${tool.name} 语言同步失败:`, error);
                            }
                        }
                    });
                }
            };

            // 注册和弦工具到统一同步系统
            window.ICStudioSync.registerTool('chord-tool', {
                onThemeChange: function(newTheme) {
                    if (currentTheme !== newTheme) {
                        console.log(`🎨 和弦工具接收主题同步: ${currentTheme} → ${newTheme}`);
                        currentTheme = newTheme;
                        document.documentElement.setAttribute('data-theme', currentTheme);
                    }
                },
                onLanguageChange: function(newLanguage) {
                    if (currentLanguage !== newLanguage) {
                        console.log(`🌐 和弦工具接收语言同步: ${currentLanguage} → ${newLanguage}`);
                        currentLanguage = newLanguage;
                        applyTranslations();
                    }
                }
            });
        });

        // 页面加载完成后初始化增强功能和声系统
        // ====== 节拍器功能 ======
        // 节拍器相关变量 (检查是否已声明)
        if (typeof metronomeInterval === 'undefined') {
            var metronomeInterval = null;
        }
        let metronomeAudioContext = null;
        let isMetronomeRunning = false;
        let metronomeTempo = 60; // 默认60 BPM

        // 初始化节拍器音频
        function initializeMetronomeAudio() {
            try {
                metronomeAudioContext = new (window.AudioContext || window.webkitAudioContext)();
                console.log('🎵 节拍器音频初始化成功');
                return true;
            } catch (error) {
                console.error('❌ 节拍器音频初始化失败:', error);
                return false;
            }
        }

        // 播放节拍器声音
        function playMetronomeSound() {
            if (!metronomeAudioContext) {
                if (!initializeMetronomeAudio()) return;
            }

            try {
                // 恢复音频上下文（用户交互后）
                if (metronomeAudioContext.state === 'suspended') {
                    metronomeAudioContext.resume();
                }

                const oscillator = metronomeAudioContext.createOscillator();
                const gainNode = metronomeAudioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(metronomeAudioContext.destination);

                // 使用方波和自然音高 (参考NiceChord节拍器)
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(523.25, metronomeAudioContext.currentTime); // C5音高

                // 设置自然的音量包络 (更好的release time)
                gainNode.gain.setValueAtTime(0.25, metronomeAudioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, metronomeAudioContext.currentTime + 0.05);

                oscillator.start(metronomeAudioContext.currentTime);
                oscillator.stop(metronomeAudioContext.currentTime + 0.05);

                // 视觉反馈 - 更新header指示器
                const headerIndicator = document.getElementById('headerBeatIndicator');

                if (headerIndicator) {
                    headerIndicator.classList.add('beat');
                    setTimeout(() => {
                        headerIndicator.classList.remove('beat');
                    }, 150);
                }

            } catch (error) {
                console.error('❌ 节拍器声音播放失败:', error);
            }
        }

        // 开启/停止节拍器
        function toggleMetronome() {
            const btn = document.getElementById('headerMetronomeBtn');
            const bpmInput = document.getElementById('headerMetronomeBpm');

            if (isMetronomeRunning) {
                // 停止节拍器
                stopMetronome();
            } else {
                // 启动节拍器
                metronomeTempo = parseInt(bpmInput.value) || 60;
                startMetronome();
            }
        }

        // 启动节拍器
        function startMetronome() {
            if (isMetronomeRunning) return;

            const btn = document.getElementById('headerMetronomeBtn');
            const interval = 60000 / metronomeTempo; // 计算间隔时间（毫秒）

            isMetronomeRunning = true;
            btn.textContent = '🎵';
            btn.title = '停止节拍器';

            // 立即播放第一声
            playMetronomeSound();

            // 设置定时器
            metronomeInterval = setInterval(() => {
                playMetronomeSound();
            }, interval);

            console.log(`🎵 节拍器已启动: ${metronomeTempo} BPM`);
        }

        // 停止节拍器
        function stopMetronome() {
            if (!isMetronomeRunning) return;

            const btn = document.getElementById('headerMetronomeBtn');

            isMetronomeRunning = false;
            btn.textContent = '🎵';
            btn.title = '开始节拍器';

            if (metronomeInterval) {
                clearInterval(metronomeInterval);
                metronomeInterval = null;
            }

            console.log('🔇 节拍器已停止');
        }

        // 更新节拍器速度
        function updateMetronomeTempo() {
            const bpmInput = document.getElementById('headerMetronomeBpm');
            metronomeTempo = parseInt(bpmInput.value) || 60;

            if (isMetronomeRunning) {
                // 如果节拍器正在运行，重新启动以应用新速度
                stopMetronome();
                startMetronome();
            }
        }

        // 功能和声开关切换
        function toggleFunctionalHarmony() {
            const toggle = document.getElementById('functionalHarmonyToggle');
            const label = document.getElementById('harmonyModeLabel');
            const slider = toggle.nextElementSibling;
            const sliderButton = slider.querySelector('.slider-button');
            const keySettingsBtn = document.getElementById('keySettingsBtn');
            const keySettingsGroup = keySettingsBtn ? keySettingsBtn.parentElement : null;

            if (toggle.checked) {
                // 启用功能和声模式
                chordSettings.useFunctionalHarmony = true;
                label.textContent = translate('controls.functionalMode');
                slider.style.backgroundColor = '#FF9500';
                if (sliderButton) {
                    sliderButton.style.transform = 'translateX(26px)';
                }

                // 显示调号设置
                if (keySettingsGroup) {
                    keySettingsGroup.style.removeProperty('display');
                }
                console.log('🎼 已启用功能和声模式');
            } else {
                // 启用完全随机模式
                chordSettings.useFunctionalHarmony = false;
                label.textContent = translate('controls.pureRandomMode');
                slider.style.backgroundColor = '#ccc';
                if (sliderButton) {
                    sliderButton.style.transform = 'translateX(0px)';
                }

                // 隐藏调号设置，显示固定C大调说明
                if (keySettingsGroup) {
                    keySettingsGroup.style.display = 'none';
                }
                console.log('🎲 已启用完全随机模式（固定C大调）');
            }
        }

        // 乐器模式切换
        function toggleInstrumentMode() {
            const toggle = document.getElementById('instrumentModeToggle');
            const label = document.getElementById('instrumentModeLabel');
            const slider = toggle.nextElementSibling;
            const sliderButton = slider.querySelector('.slider-button');

            if (toggle.checked) {
                // 启用钢琴模式
                label.textContent = translate('controls.pianoMode');
                // 🔧 修复 (2025-10-01): 改为橙色 #FF9500，与页面整体风格一致
                slider.style.backgroundColor = '#FF9500'; // 橙色表示钢琴
                if (sliderButton) {
                    sliderButton.style.transform = 'translateX(26px)';
                }
                console.log('🎹 钢琴和声模式已选择');

                // 🎹 钢琴模式：切换高级设置UI（音数选择器）
                const pianoAdvancedSettings = document.getElementById('pianoAdvancedSettings');
                const guitarAdvancedSettings = document.getElementById('guitarAdvancedSettings');
                if (pianoAdvancedSettings && guitarAdvancedSettings) {
                    pianoAdvancedSettings.style.display = 'block';
                    guitarAdvancedSettings.style.display = 'none';
                    console.log('🎹 钢琴模式：切换到音数选择器UI');

                    // 🎯 同步钢琴音数checkbox状态
                    setTimeout(() => {
                        const enabledCounts = window.pianoSettings?.enabledNoteCounts || [4];
                        console.log('🎯 同步钢琴音数checkbox (切换模式时):', enabledCounts);

                        // 🔧 修复 (2025-10-01): 只处理3-7音
                        // 先取消所有勾选
                        for (let i = 3; i <= 7; i++) {
                            const checkbox = document.getElementById(`notecount-${i}`);
                            if (checkbox) checkbox.checked = false;
                        }

                        // 然后勾选enabledNoteCounts中的音数
                        enabledCounts.forEach(count => {
                            const checkbox = document.getElementById(`notecount-${count}`);
                            if (checkbox) {
                                checkbox.checked = true;
                                console.log(`  ✅ 已勾选${count}音`);
                            }
                        });
                    }, 50);
                }

                // 🎹 钢琴模式：切换音域设置UI（双谱号音域按钮）
                const pianoRangeSettings = document.getElementById('pianoRangeSettings');
                const guitarRangeSettings = document.getElementById('guitarRangeSettings');
                if (pianoRangeSettings && guitarRangeSettings) {
                    pianoRangeSettings.style.display = 'block';
                    guitarRangeSettings.style.display = 'none';
                    console.log('🎹 钢琴模式：切换到双谱号音域设置UI');
                }

                // 🎼 钢琴模式UI适配：显示谱号设置控件
                const clefControlGroup = document.getElementById('clefControlGroup');
                if (clefControlGroup) {
                    clefControlGroup.style.visibility = 'visible';
                    clefControlGroup.style.height = 'auto';
                    clefControlGroup.style.overflow = 'visible';
                    clefControlGroup.style.margin = '';
                    clefControlGroup.style.padding = '';
                    clefControlGroup.style.removeProperty('display'); // 恢复CSS类的原始flex属性
                    console.log('🎹 钢琴模式：显示谱号设置控件（只有大谱表和高音谱号）');
                } else {
                    console.log('🎹 钢琴模式：谱号设置控件未找到');
                }

                // 🎼 钢琴模式：智能默认谱号设置
                applyIntelligentClefDefaults('piano');

                // 检查钢琴生成器是否可用
                if (typeof pianoChordGenerator !== 'undefined' && pianoChordGenerator && pianoChordGenerator.isInitialized) {
                    console.log('🎹 钢琴生成器已就绪');
                } else {
                    console.log('🎹 钢琴生成器正在初始化...');
                }
            } else {
                // 启用吉他模式（默认）
                label.textContent = translate('controls.guitarMode');
                slider.style.backgroundColor = '#ccc'; // 灰色默认状态，与和声模式一致
                if (sliderButton) {
                    sliderButton.style.transform = 'translateX(0px)';
                }
                console.log('🎸 吉他和声模式已选择（默认）');

                // 🎸 吉他模式：切换高级设置UI（voicing选择器）
                const pianoAdvancedSettings = document.getElementById('pianoAdvancedSettings');
                const guitarAdvancedSettings = document.getElementById('guitarAdvancedSettings');
                if (pianoAdvancedSettings && guitarAdvancedSettings) {
                    pianoAdvancedSettings.style.display = 'none';
                    guitarAdvancedSettings.style.display = 'block';
                    console.log('🎸 吉他模式：切换到Voicing选择器UI');
                }

                // 🎸 吉他模式：切换音域设置UI（统一音域选择器）
                const pianoRangeSettings = document.getElementById('pianoRangeSettings');
                const guitarRangeSettings = document.getElementById('guitarRangeSettings');
                if (pianoRangeSettings && guitarRangeSettings) {
                    pianoRangeSettings.style.display = 'none';
                    guitarRangeSettings.style.display = 'block';
                    console.log('🎸 吉他模式：切换到统一音域设置UI');
                }

                // 🎼 吉他模式：隐藏谱号设置控件
                const clefControlGroup = document.getElementById('clefControlGroup');
                if (clefControlGroup) {
                    clefControlGroup.style.visibility = 'hidden';
                    clefControlGroup.style.height = '0';
                    clefControlGroup.style.overflow = 'hidden';
                    clefControlGroup.style.margin = '0';
                    clefControlGroup.style.padding = '0';
                    console.log('🎸 吉他模式：隐藏谱号设置控件（吉他只使用高音谱号）');
                } else {
                    console.log('🎸 吉他模式：谱号设置控件未找到');
                }

                // 🎼 吉他模式：强制使用高音谱号
                if (window.chordSettings) {
                    window.chordSettings.clefs = ['treble'];
                    console.log('🎸 吉他模式：强制使用高音谱号');
                }
            }
        }

        // 🎼 智能默认谱号设置系统
        function applyIntelligentClefDefaults(mode) {
            if (!window.chordSettings) {
                console.warn('⚠️ chordSettings 未初始化，无法设置智能默认谱号');
                return;
            }

            console.log(`🎯 应用 ${mode} 模式的智能默认谱号设置`);

            // 定义模式特定的默认谱号
            const modeDefaults = {
                piano: {
                    primary: ['grand_staff'],           // 钢琴首选：大谱表
                    secondary: ['treble'],              // 备选：高音谱号（钢琴模式不使用低音谱号）
                    allowedClefs: ['grand_staff', 'treble'], // 钢琴模式允许的谱号
                    description: '钢琴模式优选大谱表，也可选择高音谱号'
                },
                guitar: {
                    primary: ['treble'],                // 吉他首选：高音谱号
                    secondary: ['treble'],              // 吉他模式只用高音谱号
                    allowedClefs: ['treble'],           // 吉他模式只允许高音谱号
                    description: '吉他模式固定使用高音谱号'
                }
            };

            const defaults = modeDefaults[mode];
            if (!defaults) {
                console.warn(`⚠️ 未知模式: ${mode}`);
                return;
            }

            // 🎹 钢琴模式：总是优先设置为大谱表
            if (mode === 'piano') {
                window.chordSettings.clefs = ['grand_staff'];
                console.log(`🎹 钢琴模式：自动设置为大谱表`);
                console.log(`📝 说明: ${defaults.description}`);
                // 更新UI显示
                updateClefSettingsDisplay();
            } else {
                // 其他模式：检查用户是否已有谱号设置
                const hasUserClefs = window.chordSettings.clefs &&
                                    window.chordSettings.clefs.length > 0;

                if (!hasUserClefs) {
                    // 🎯 首次使用：应用模式默认设置
                    window.chordSettings.clefs = [...defaults.primary];
                    console.log(`🎼 ${mode}模式首次使用，设置默认谱号: ${defaults.primary.join(', ')}`);
                    console.log(`📝 说明: ${defaults.description}`);

                    // 更新UI显示
                    updateClefSettingsDisplay();
                } else {
                    // 🔄 已有设置：验证并过滤不兼容的谱号
                    const currentClefs = window.chordSettings.clefs;
                    const allowedClefs = defaults.allowedClefs;

                    // 过滤出当前模式允许的谱号
                    const filteredClefs = currentClefs.filter(clef => allowedClefs.includes(clef));

                    if (filteredClefs.length === 0) {
                        // 如果没有兼容的谱号，使用默认设置
                        window.chordSettings.clefs = [...defaults.primary];
                        console.log(`🔧 ${mode}模式：无兼容谱号，使用默认设置: ${defaults.primary.join(', ')}`);
                        updateClefSettingsDisplay();
                    } else if (filteredClefs.length !== currentClefs.length) {
                        // 如果有不兼容的谱号被过滤掉
                        const removedClefs = currentClefs.filter(clef => !allowedClefs.includes(clef));
                        window.chordSettings.clefs = filteredClefs;
                        console.log(`🔧 ${mode}模式：移除不兼容谱号 [${removedClefs.join(', ')}]，保留 [${filteredClefs.join(', ')}]`);
                        updateClefSettingsDisplay();
                    } else {
                        // 所有谱号都兼容
                        console.log(`✅ ${mode}模式：保持用户设置 ${currentClefs.join(', ')}`);
                    }
                }
            }

            // 保存模式偏好（用于下次启动）
            if (!window.chordSettings.modePreferences) {
                window.chordSettings.modePreferences = {};
            }
            window.chordSettings.modePreferences[mode] = {
                lastUsedClefs: [...(window.chordSettings.clefs || [])],
                timestamp: new Date().toISOString()
            };

            console.log(`🎯 ${mode}模式智能默认设置完成`);
        }

        // 🎹 钢琴模式：音数选择全选/取消全选
        function toggleSelectAllNoteCounts() {
            const checkboxes = document.querySelectorAll('#pianoAdvancedSettings input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            const text = document.getElementById('noteCountSelectAllText');

            checkboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
            });

            if (text) {
                text.textContent = allChecked ? translate('button.selectAll') : translate('button.unselectAll');
            }

            console.log(`🎹 音数选择: ${allChecked ? '取消全选' : '全选'}`);
        }

        // 🎸 吉他模式：voicing选择全选/取消全选
        function toggleSelectAllVoicings() {
            const checkboxes = document.querySelectorAll('#guitarAdvancedSettings input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            const text = document.getElementById('voicingSelectAllText');

            checkboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
            });

            if (text) {
                text.textContent = allChecked ? translate('button.selectAll') : translate('button.unselectAll');
            }

            console.log(`🎸 Voicing选择: ${allChecked ? '取消全选' : '全选'}`);
        }

        // 🎼 更新谱号设置显示（辅助函数）
        function updateClefSettingsDisplay() {
            // 如果谱号设置弹窗当前可见，更新复选框状态
            const clefModal = document.getElementById('clefModal');
            if (clefModal && clefModal.style.display !== 'none') {
                const checkboxes = clefModal.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    const clefType = checkbox.value;
                    checkbox.checked = window.chordSettings.clefs &&
                                     window.chordSettings.clefs.includes(clefType);
                });
                console.log('🎼 已更新谱号设置弹窗显示状态');
            }
        }

        // 🎼 五线谱显示/隐藏控制
        function toggleStaffDisplay() {
            applyStaffDisplayState();
        }

        // 应用五线谱显示状态 - 简化直接的方法
        function applyStaffDisplayState() {
            // 🔧 修复 (2025-10-01): 使用querySelector获取第一个toggle（支持多个toggle）
            const toggle = document.querySelector('input[id="staffDisplayToggle"]');
            const scoreContainer = document.getElementById('score'); // 修复：正确的ID是'score'

            if (toggle && scoreContainer) {
                const svg = scoreContainer.querySelector('svg');
                if (svg) {
                    console.log(`🎼 应用五线谱显示状态: ${toggle.checked ? '显示' : '隐藏'}`);

                    if (toggle.checked) {
                        // 显示五线谱 - 恢复所有五线谱元素和小节数
                        const staffElements = svg.querySelectorAll([
                            '.vf-clef',           // 谱号
                            '.vf-timesignature',  // 拍号
                            '.vf-stavenote',      // 音符
                            '.vf-note',           // 音符
                            '.vf-notehead',       // 音符头
                            '.vf-stem',           // 符杆
                            '.vf-flag',           // 符尾
                            '.vf-beam',           // 连音线
                            'path',               // 五线谱线条
                            'line',               // 谱线
                            'rect'                // 小节线
                        ].join(', '));

                        // 显示五线谱元素
                        staffElements.forEach(el => {
                            el.style.display = '';
                            el.style.visibility = 'visible';
                            el.style.opacity = '1';
                        });

                        // 恢复文本元素（小节数总是显示，和弦代号根据开关状态）
                        const allTextElements = svg.querySelectorAll('text');
                        let restoredMeasureNumbers = 0;
                        let restoredChordSymbols = 0;

                        allTextElements.forEach(textEl => {
                            if (isChordSymbolElement(textEl)) {
                                // 和弦代号：根据和弦代号开关状态决定是否显示
                                if (window.displaySettings.chordSymbolsVisible) {
                                    textEl.style.display = '';
                                    textEl.style.visibility = 'visible';
                                    textEl.style.opacity = '1';
                                    restoredChordSymbols++;
                                } else {
                                    // 和弦代号开关关闭时，保持隐藏
                                    textEl.style.display = 'none';
                                    textEl.style.visibility = 'hidden';
                                    textEl.style.opacity = '0';
                                }
                            } else {
                                // 小节数和其他文本：总是显示
                                textEl.style.display = '';
                                textEl.style.visibility = 'visible';
                                textEl.style.opacity = '1';
                                restoredMeasureNumbers++;
                            }
                        });

                        console.log(`🎼 ✅ 显示了五线谱 (${staffElements.length}个元素) 和小节数 (${restoredMeasureNumbers}个)，和弦代号 (${restoredChordSymbols}个，根据开关状态)`);
                    } else {
                        // 隐藏五线谱和小节数，但保留和弦代号
                        const staffElements = svg.querySelectorAll([
                            '.vf-clef',           // 谱号
                            '.vf-timesignature',  // 拍号
                            '.vf-stavenote',      // 音符
                            '.vf-note',           // 音符
                            '.vf-notehead',       // 音符头
                            '.vf-stem',           // 符杆
                            '.vf-flag',           // 符尾
                            '.vf-beam',           // 连音线
                            'path',               // 五线谱线条
                            'line',               // 谱线
                            'rect'                // 小节线
                        ].join(', '));

                        // 隐藏五线谱元素
                        staffElements.forEach(el => {
                            el.style.display = 'none';
                            el.style.visibility = 'hidden';
                            el.style.opacity = '0';
                        });

                        // 隐藏小节数但保留和弦代号
                        const allTextElements = svg.querySelectorAll('text');
                        let hiddenMeasureNumbers = 0;
                        let preservedChordSymbols = 0;

                        allTextElements.forEach(textEl => {
                            if (isChordSymbolElement(textEl)) {
                                // 和弦代号：根据和弦代号开关状态决定是否显示
                                if (window.displaySettings.chordSymbolsVisible) {
                                    textEl.style.display = '';
                                    textEl.style.visibility = 'visible';
                                    textEl.style.opacity = '1';
                                    preservedChordSymbols++;
                                } else {
                                    // 和弦代号开关关闭时，保持隐藏
                                    textEl.style.display = 'none';
                                    textEl.style.visibility = 'hidden';
                                    textEl.style.opacity = '0';
                                }
                            } else {
                                // 隐藏其他文本元素（包括小节数）
                                textEl.style.display = 'none';
                                textEl.style.visibility = 'hidden';
                                textEl.style.opacity = '0';
                                hiddenMeasureNumbers++;
                            }
                        });

                        console.log(`🎼 ✅ 隐藏了五线谱 (${staffElements.length}个元素) 和小节数 (${hiddenMeasureNumbers}个)，保留和弦代号 (${preservedChordSymbols}个)`);
                    }
                } else {
                    console.warn('⚠️ 未找到SVG元素，无法应用五线谱显示控制');
                }
            } else {
                console.warn('⚠️ 未找到toggle或scoreContainer元素');
                console.log('toggle:', toggle);
                console.log('scoreContainer:', scoreContainer);
            }
        }

        // 检查元素是否是和弦代号 - 基于你的智能识别系统设计
        function isChordSymbolElement(element) {
            if (element.tagName !== 'text') return false;

            const content = element.textContent?.trim();
            if (!content) return false;

            // 智能和弦代号识别系统（参照你的设计）
            const isChordSymbol = (
                content.match(/^[A-G][#b]?/) ||           // 根音 (A-G开头)
                content.includes('maj') ||                // 和弦类型关键词
                content.includes('min') ||
                content.includes('dim') ||
                content.includes('aug') ||
                content.includes('sus') ||
                content.match(/\b[79](sus)?[24]?\b/) ||   // 数字和弦标记
                content.match(/\b(11|13)\b/) ||
                content.match(/\badd[69]\b/) ||
                content.includes('°') ||                  // 特殊符号
                content.includes('ø') ||
                content.includes('+') ||
                content.includes('Δ') ||
                content.includes('/') && content.match(/[A-G].*\/.*[A-G]/) || // 分数和弦
                content.match(/^(maj|min|dim|aug)\d*$/) ||
                content.match(/^[IVX]+[°+]?$/)           // 罗马数字和弦标记
            );

            // 排除机制（参照你的设计）
            const isNotChordSymbol = (
                content.match(/^\d+$/) ||        // 纯数字（小节号）
                content.match(/^[pmf]+$/) ||     // 力度记号
                content.length > 10 ||           // 过长文本
                content.includes('measure') ||   // 小节相关
                content.includes('staff') ||     // 谱线相关
                content.includes('key') ||       // 调号相关
                content.includes('time')         // 拍号相关
            );

            return isChordSymbol && !isNotChordSymbol;
        }

        // 🌍 全局状态记录 - 用于防闪烁和持久化隐藏
        window.displaySettings = {
            staffVisible: true,     // 默认显示五线谱
            chordSymbolsVisible: true,  // 默认显示和弦代号

            // 更新状态的方法
            updateStaffState: function(visible) {
                this.staffVisible = visible;
                console.log(`🌍 全局状态更新: 五线谱=${visible ? '显示' : '隐藏'}`);
            },
            updateChordState: function(visible) {
                this.chordSymbolsVisible = visible;
                console.log(`🌍 全局状态更新: 和弦代号=${visible ? '显示' : '隐藏'}`);
            }
        };

        // 将函数添加到全局window对象，便于其他模块调用
        window.applyStaffDisplayState = applyStaffDisplayState;
        window.applyChordSymbolsState = applyChordSymbolsState;
        window.isChordSymbolElement = isChordSymbolElement;

        // 🧪 手动测试函数 - 用户可以在控制台中直接调用
        window.testStaffToggle = function() {
            console.log('🧪 手动测试五线谱开关');
            const toggle = document.getElementById('staffDisplayToggle');
            const svg = document.querySelector('#score svg'); // 修复：正确的容器ID
            console.log('开关元素:', toggle);
            console.log('SVG元素:', svg);
            console.log('开关状态:', toggle ? toggle.checked : 'null');
            if (toggle && svg) {
                applyStaffDisplayState();
            } else {
                console.error('❌ 测试失败：找不到必要元素');
            }
        };

        window.testChordToggle = function() {
            console.log('🧪 手动测试和弦代号开关');
            const toggle = document.getElementById('chordSymbolsToggle');
            const svg = document.querySelector('#score svg'); // 修复：正确的容器ID
            console.log('开关元素:', toggle);
            console.log('SVG元素:', svg);
            console.log('开关状态:', toggle ? toggle.checked : 'null');
            if (toggle && svg) {
                applyChordSymbolsState();
            } else {
                console.error('❌ 测试失败：找不到必要元素');
            }
        };

        // 🎼 和弦代号显示/隐藏控制
        function toggleChordSymbols() {
            applyChordSymbolsState();
        }

        // 应用和弦代号显示状态 - 简化测试方法
        function applyChordSymbolsState() {
            // 🔧 修复 (2025-10-01): 使用querySelector获取第一个toggle（支持多个toggle）
            const toggle = document.querySelector('input[id="chordSymbolsToggle"]');
            const scoreContainer = document.getElementById('score'); // 修复：正确的ID是'score'

            if (toggle && scoreContainer) {
                const svg = scoreContainer.querySelector('svg');
                if (svg) {
                    console.log(`🎵 应用和弦代号显示状态: ${toggle.checked ? '显示' : '隐藏'}`);

                    // 智能识别和弦代号文本，排除小节数
                    const allTextElements = svg.querySelectorAll('text, .vf-text');
                    let chordCount = 0;
                    let measureCount = 0;
                    let debugInfo = [];

                    allTextElements.forEach((text, index) => {
                        const content = text.textContent?.trim();
                        // 修复：正确获取SVG元素的class属性
                        const className = (text.className && text.className.baseVal) || text.getAttribute('class') || '';

                        // 检查是否是小节号（纯数字）
                        const isMeasureNumber = content.match(/^\d+$/);

                        if (isMeasureNumber) {
                            // 保留小节号，不隐藏
                            measureCount++;
                            debugInfo.push(`${index+1}: "${content}" [小节号-保留]`);
                        } else if (isChordSymbolElement(text) || (className && className.includes && className.includes('vf-text'))) {
                            // 处理和弦代号
                            chordCount++;
                            debugInfo.push(`${index+1}: "${content}" [和弦代号-处理] (class: "${className}")`);

                            if (toggle.checked) {
                                text.style.display = '';
                                text.style.visibility = 'visible';
                                text.style.opacity = '1';
                            } else {
                                text.style.display = 'none';
                                text.style.visibility = 'hidden';
                                text.style.opacity = '0';
                            }
                        } else {
                            // 其他文本元素，保留不处理
                            debugInfo.push(`${index+1}: "${content}" [其他文本-保留] (class: "${className}")`);
                        }
                    });

                    console.log(`🎵 ✅ 处理了${chordCount}个和弦代号，保留了${measureCount}个小节号`);
                    console.log(`🎵 📋 详细信息:`, debugInfo.slice(0, 10)); // 只显示前10个避免日志过长

                    if (chordCount === 0) {
                        console.log(`🎵 ⚠️ 未找到和弦代号，总共有${allTextElements.length}个文本元素`);
                    }
                } else {
                    console.warn('⚠️ 未找到SVG元素，无法应用和弦代号显示控制');
                }
            } else {
                console.warn('⚠️ 未找到toggle或scoreContainer元素');
                console.log('toggle:', toggle);
                console.log('scoreContainer:', scoreContainer);
            }
        }

        // 初始化功能和声开关
        function initializeFunctionalHarmonyToggle(retryCount = 0) {
            const maxRetries = 50; // 最多重试50次（5秒）

            // 检查chordSettings是否已定义
            if (typeof chordSettings === 'undefined') {
                if (retryCount < maxRetries) {
                    console.warn(`⚠️ chordSettings未定义，延迟初始化功能和声开关 (${retryCount + 1}/${maxRetries})`);
                    setTimeout(() => initializeFunctionalHarmonyToggle(retryCount + 1), 100);
                } else {
                    console.error('❌ 功能和声开关初始化失败：chordSettings在5秒内未定义，停止重试');
                }
                return;
            }

            const toggle = document.getElementById('functionalHarmonyToggle');
            const label = document.getElementById('harmonyModeLabel');

            // 设置初始状态 - 默认启用功能和声模式
            chordSettings.useFunctionalHarmony = chordSettings.useFunctionalHarmony !== undefined ? chordSettings.useFunctionalHarmony : true;
            toggle.checked = chordSettings.useFunctionalHarmony;

            // 初始化显示状态
            const slider = toggle.nextElementSibling;
            const sliderButton = slider ? slider.querySelector('.slider-button') : null;

            if (chordSettings.useFunctionalHarmony) {
                label.textContent = translate('controls.functionalMode');
                if (slider) slider.style.backgroundColor = '#FF9500';
                if (sliderButton) sliderButton.style.transform = 'translateX(26px)';
            } else {
                label.textContent = translate('controls.randomMode');
                if (slider) slider.style.backgroundColor = '#ccc';
                if (sliderButton) sliderButton.style.transform = 'translateX(0px)';
            }

            // 初始化时应用当前状态的UI设置
            toggleFunctionalHarmony();

            console.log('🎯 功能和声开关已初始化，默认状态：', chordSettings.useFunctionalHarmony ? '功能和声模式' : '完全随机模式');
        }

        // 初始化乐器模式开关
        function initializeInstrumentModeToggle(retryCount = 0, forceReset = false) {
            const maxRetries = 50; // 最多重试50次（5秒）

            // 检查chordSettings是否已定义
            if (typeof chordSettings === 'undefined') {
                if (retryCount < maxRetries) {
                    console.warn(`⚠️ chordSettings未定义，延迟初始化乐器模式开关 (${retryCount + 1}/${maxRetries})`);
                    setTimeout(() => initializeInstrumentModeToggle(retryCount + 1, forceReset), 100);
                } else {
                    console.error('❌ 乐器模式开关初始化失败：chordSettings在5秒内未定义，停止重试');
                }
                return;
            }

            const toggle = document.getElementById('instrumentModeToggle');
            const label = document.getElementById('instrumentModeLabel');
            const slider = toggle.nextElementSibling;
            const sliderButton = slider.querySelector('.slider-button');
            const clefControlGroup = document.getElementById('clefControlGroup');

            // 🎯 智能初始化：只在首次初始化或强制重置时设置默认状态
            const currentState = toggle.checked;
            const isFirstInit = (currentState === null || currentState === undefined || retryCount === 0);

            if (forceReset || isFirstInit) {
                // 首次初始化或强制重置：设置为默认状态（吉他模式）
                toggle.checked = false;
                label.textContent = '吉他和声';
                slider.style.backgroundColor = '#ccc';
                if (sliderButton) {
                    sliderButton.style.transform = 'translateX(0px)';
                }
                console.log('🎯 乐器模式开关初始化为默认状态（吉他模式）');
            } else {
                // 已有状态：保持现有状态
                console.log(`🛡️ 乐器模式开关保持现有状态: ${toggle.checked ? '钢琴模式' : '吉他模式'}`);
                // 确保UI与状态同步
                if (toggle.checked) {
                    label.textContent = '钢琴和声';
                    // 🔧 修复 (2025-10-01): 改为橙色 #FF9500
                    slider.style.backgroundColor = '#FF9500';
                    if (sliderButton) {
                        sliderButton.style.transform = 'translateX(26px)';
                    }
                } else {
                    label.textContent = '吉他和声';
                    slider.style.backgroundColor = '#ccc';
                    if (sliderButton) {
                        sliderButton.style.transform = 'translateX(0px)';
                    }
                }
            }

            // 🎸 吉他模式：隐藏谱号选择控件（仅钢琴模式需要）
            if (clefControlGroup) {
                clefControlGroup.style.visibility = 'hidden';
                clefControlGroup.style.height = '0';
                clefControlGroup.style.overflow = 'hidden';
                clefControlGroup.style.margin = '0';
                clefControlGroup.style.padding = '0';
            }

            console.log('🎯 乐器模式开关已初始化（吉他模式） - 谱号选择已隐藏');
        }

        // 监听BPM输入变化
        document.addEventListener('DOMContentLoaded', function() {
            const bpmInput = document.getElementById('headerMetronomeBpm');
            if (bpmInput) {
                bpmInput.addEventListener('change', updateMetronomeTempo);
                bpmInput.addEventListener('input', updateMetronomeTempo);
            }

            // 监听临时记号滑块变化
            const accidentalSlider = document.getElementById('accidentalRate');
            const accidentalValue = document.getElementById('accidentalRateValue');

            if (accidentalSlider && accidentalValue) {
                accidentalSlider.addEventListener('input', function() {
                    accidentalValue.textContent = this.value + '%';
                });
            }

            // 🎼 初始化五线谱显示/隐藏开关 - 修复：支持多个toggle（吉他+钢琴模式）
            // 🔧 修复 (2025-10-01): 使用querySelectorAll选择所有ID为staffDisplayToggle的元素
            // 原因：吉他模式和钢琴模式各有一组toggle，需要为它们都绑定事件
            const staffDisplayToggles = document.querySelectorAll('input[id="staffDisplayToggle"]');
            if (staffDisplayToggles.length > 0) {
                console.log(`🔍 找到${staffDisplayToggles.length}个五线谱开关元素`);
                staffDisplayToggles.forEach((toggle, index) => {
                    toggle.addEventListener('change', function() {
                        console.log(`🎼 五线谱开关${index + 1}变化: ${this.checked ? '显示' : '隐藏'}`);
                        console.log('🔍 立即调用 applyStaffDisplayState()');

                        // 更新全局状态
                        window.displaySettings.updateStaffState(this.checked);

                        // 同步所有toggle的状态
                        staffDisplayToggles.forEach(t => {
                            if (t !== this) t.checked = this.checked;
                        });

                        applyStaffDisplayState();
                    });
                    console.log(`✅ 五线谱开关${index + 1}事件监听器已绑定`);
                });

                // 立即测试当前状态并初始化全局状态（使用第一个toggle的状态）
                console.log('🔍 当前五线谱开关状态:', staffDisplayToggles[0].checked);
                window.displaySettings.updateStaffState(staffDisplayToggles[0].checked);
            } else {
                console.error('❌ 未找到五线谱开关元素 staffDisplayToggle');
            }

            // 🎵 初始化和弦代号显示/隐藏开关 - 修复：支持多个toggle（吉他+钢琴模式）
            // 🔧 修复 (2025-10-01): 使用querySelectorAll选择所有ID为chordSymbolsToggle的元素
            const chordSymbolsToggles = document.querySelectorAll('input[id="chordSymbolsToggle"]');
            if (chordSymbolsToggles.length > 0) {
                console.log(`🔍 找到${chordSymbolsToggles.length}个和弦代号开关元素`);
                chordSymbolsToggles.forEach((toggle, index) => {
                    toggle.addEventListener('change', function() {
                        console.log(`🎵 和弦代号开关${index + 1}变化: ${this.checked ? '显示' : '隐藏'}`);
                        console.log('🔍 立即调用 applyChordSymbolsState()');

                        // 更新全局状态
                        window.displaySettings.updateChordState(this.checked);

                        // 同步所有toggle的状态
                        chordSymbolsToggles.forEach(t => {
                            if (t !== this) t.checked = this.checked;
                        });

                        applyChordSymbolsState();
                    });
                    console.log(`✅ 和弦代号开关${index + 1}事件监听器已绑定`);
                });

                // 立即测试当前状态并初始化全局状态（使用第一个toggle的状态）
                console.log('🔍 当前和弦代号开关状态:', chordSymbolsToggles[0].checked);
                window.displaySettings.updateChordState(chordSymbolsToggles[0].checked);
            } else {
                console.error('❌ 未找到和弦代号开关元素 chordSymbolsToggle');
            }

            // 改进的模块加载和初始化策略
            function initializeSystem() {
                console.log('🔄 开始HTML系统初始化检查...');

                // 检查关键类是否可用
                const requiredClasses = ['HarmonyTheory', 'ChordProgressionGenerator'];
                const missingClasses = requiredClasses.filter(className => typeof window[className] === 'undefined');

                if (missingClasses.length > 0) {
                    console.warn('⚠️ 等待模块加载:', missingClasses.join(', '));
                    return false;
                }

                try {
                    // 检查JS模块是否已经完成初始化
                    const jsInitialized = (
                        typeof window.harmonyTheory !== 'undefined' &&
                        window.harmonyTheory !== null &&
                        typeof window.chordProgressionGenerator !== 'undefined' &&
                        window.chordProgressionGenerator !== null
                    );

                    if (jsInitialized) {
                        console.log('✅ 检测到JS模块已初始化，跳过重复初始化');
                    } else {
                        console.log('🔧 JS模块未完整初始化，进行HTML补充初始化');

                        // 确保chordSettings存在
                        if (typeof chordSettings === 'undefined' || !chordSettings) {
                            window.chordSettings = {
                                chordTypes: ['major', 'minor'],
                                keys: ['C-major', 'a-minor'],
                                timeSignatures: ['4/4'],
                                clefs: ['treble'],
                                rhythms: ['half', 'quarter'],
                                includeTriadInversions: false,
                                includeSeventhInversions: false,
                                complexity: 'medium',
                                voicingTypes: ['close'],
                                useFunctionalHarmony: true  // 🔧 修复：默认为功能和声模式，而非随机模式
                            };
                            console.log('✅ chordSettings已初始化（默认功能和声模式）');
                        } else {
                            // 🔧 如果chordSettings已存在，只填充缺失的属性，不覆盖已有设置
                            const defaults = {
                                chordTypes: ['major', 'minor'],
                                keys: ['C-major', 'a-minor'],
                                timeSignatures: ['4/4'],
                                clefs: ['treble'],
                                rhythms: ['half', 'quarter'],
                                includeTriadInversions: false,
                                includeSeventhInversions: false,
                                complexity: 'medium',
                                voicingTypes: ['close'],
                                useFunctionalHarmony: true
                            };
                            Object.keys(defaults).forEach(key => {
                                if (window.chordSettings[key] === undefined) {
                                    window.chordSettings[key] = defaults[key];
                                }
                            });
                            console.log('✅ chordSettings已补全缺失属性（保留现有设置）');
                        }

                        // 🎹 初始化钢琴专用设置对象
                        if (typeof pianoSettings === 'undefined' || !pianoSettings) {
                            window.pianoSettings = {
                                // 音数选择（2-9个音符）
                                enabledNoteCounts: [4],  // 默认选中4音

                                // 低音谱号音域设置（默认E2-E4）
                                bassClefRangeMin: 40,  // E2 (MIDI 40)
                                bassClefRangeMax: 64,  // E4 (MIDI 64)

                                // 高音谱号音域设置（默认C4-E6）
                                trebleClefRangeMin: 60,  // C4 (MIDI 60)
                                trebleClefRangeMax: 88,  // E6 (MIDI 88)

                                // 音符分配规则
                                noteDistribution: {
                                    // 低音谱号：最低音总是根音
                                    bassClefAlwaysRoot: true,

                                    // 高音谱号：剩余音符（最少2个）
                                    trebleClefMinNotes: 2,

                                    // 音符优先级系统
                                    priorityNotes: ['third', 'seventh', 'sus', 'tension'],  // 优先音
                                    optionalNotes: ['fifth'],  // 可选音
                                    duplicableNotes: ['root', 'fifth'],  // 可重复音

                                    // 优先音不强制必须包含
                                    priorityNotesRequired: false
                                },

                                // 音符随机排列（高音谱号内）
                                randomArrangement: true,

                                // 音符拼写规则（继承调性）
                                inheritKeySignatureSpelling: true
                            };
                            console.log('✅ pianoSettings已初始化（钢琴专用设置对象）');

                            // 🎯 同步UI checkbox状态（确保4音被勾选）
                            setTimeout(() => {
                                const enabledCounts = window.pianoSettings.enabledNoteCounts || [4];
                                console.log('🎯 同步钢琴音数checkbox状态:', enabledCounts);

                                // 🔧 修复 (2025-10-01): 只处理3-7音
                                // 先取消所有勾选
                                for (let i = 3; i <= 7; i++) {
                                    const checkbox = document.getElementById(`notecount-${i}`);
                                    if (checkbox) {
                                        checkbox.checked = false;
                                    }
                                }

                                // 然后勾选enabledNoteCounts中的音数
                                enabledCounts.forEach(count => {
                                    const checkbox = document.getElementById(`notecount-${count}`);
                                    if (checkbox) {
                                        checkbox.checked = true;
                                        console.log(`  ✅ 已勾选${count}音`);
                                    }
                                });
                            }, 100);
                        }

                        // 如果还没有初始化 harmonyTheory，在这里初始化
                        if (typeof harmonyTheory === 'undefined' || !harmonyTheory) {
                            window.harmonyTheory = new HarmonyTheory();
                            console.log('✅ harmonyTheory已初始化（HTML补充）');
                        }

                        // 初始化增强功能和声系统（如果可用）
                        if (typeof EnhancedHarmony !== 'undefined' && (typeof enhancedHarmony === 'undefined' || !enhancedHarmony)) {
                            window.enhancedHarmony = new EnhancedHarmony(window.harmonyTheory || harmonyTheory);
                            console.log('✅ 增强功能和声系统初始化完成（HTML补充）');
                        }

                        // 初始化和弦进行生成器（关键步骤）
                        if (typeof ChordProgressionGenerator !== 'undefined' && (typeof chordProgressionGenerator === 'undefined' || !chordProgressionGenerator)) {
                            window.chordProgressionGenerator = new ChordProgressionGenerator(window.harmonyTheory || harmonyTheory);
                            console.log('✅ 和弦进行生成器已初始化（HTML补充）');
                        }
                    }

                    // 总是初始化UI开关（确保 chordSettings 已定义）
                    initializeFunctionalHarmonyToggle();
                    initializeInstrumentModeToggle();

                    // 总是强制绑定生成和弦按钮的事件监听器
                    bindGenerateButtonEvent();

                    // 确保页面翻译正确应用
                    applyTranslations();
                    updateDynamicControlsTranslation(); // 初始化动态控件翻译
                    console.log('✅ 页面翻译已初始化');

                    // 初始化调号显示状态
                    if (window.chordSettings && window.chordSettings.keys) {
                        updateKeySettingsDisplay(window.chordSettings.keys);
                    }

                    return true;
                } catch (error) {
                    console.error('❌ 系统初始化失败:', error);
                    return false;
                }
            }

            // 简化的按钮事件绑定
            function bindGenerateButtonEvent() {
                const generateBtn = document.getElementById('generateChordsBtn');
                if (!generateBtn) {
                    console.error('❌ 生成和弦按钮不存在');
                    return false;
                }

                console.log('🔍 开始绑定生成和弦按钮事件...');

                // 移除可能已存在的事件监听器
                const newBtn = generateBtn.cloneNode(true);
                generateBtn.parentNode.replaceChild(newBtn, generateBtn);

                // 重新获取按钮引用
                const btn = document.getElementById('generateChordsBtn');

                // 直接绑定点击事件，在事件内部检查函数可用性
                btn.addEventListener('click', function(event) {
                    console.log('🎯 生成和弦按钮被点击');
                    event.preventDefault();
                    event.stopPropagation();

                    try {
                        // 🎹 检测钢琴模式
                        const instrumentToggle = document.getElementById('instrumentModeToggle');
                        const isPianoMode = instrumentToggle && instrumentToggle.checked;

                        if (isPianoMode) {
                            // 🎹 钢琴模式：使用PianoNoteCountEngine
                            console.log('🎹 钢琴模式：使用音数生成引擎');

                            if (typeof generatePianoChords === 'function') {
                                generatePianoChords();
                                console.log('✅ 钢琴和弦生成完成');
                            } else {
                                console.error('❌ generatePianoChords 函数不可用');
                                alert('钢琴生成器未加载，请刷新页面重试');
                            }
                            return;
                        }

                        // 🎸 吉他模式：使用传统VoicingEngine
                        // 在点击时检查函数是否可用
                        if (typeof generateChords === 'function') {
                            console.log('🎸 调用 generateChords 函数');
                            generateChords();
                            console.log('✅ generateChords 函数调用完成');
                        } else if (typeof window.generateChords === 'function') {
                            console.log('🎸 调用 window.generateChords 函数');
                            window.generateChords();
                            console.log('✅ window.generateChords 函数调用完成');
                        } else {
                            // 如果函数不可用，尝试手动触发初始化
                            console.warn('⚠️ generateChords 函数不可用，尝试手动初始化');
                            if (typeof initializeMusicTheory === 'function') {
                                initializeMusicTheory();
                                setTimeout(() => {
                                    if (typeof generateChords === 'function') {
                                        generateChords();
                                    } else {
                                        alert('系统初始化失败，请刷新页面重试');
                                    }
                                }, 500);
                            } else {
                                alert('和弦生成器未正确加载，请刷新页面重试');
                            }
                        }
                    } catch (error) {
                        console.error('❌ 生成和弦时出错:', error);
                        alert('生成和弦时出错: ' + error.message);
                    }
                });

                console.log('✅ 生成和弦按钮事件监听器已绑定');
                return true;
            }

            // 重试机制
            let initRetryCount = 0;
            const maxInitRetries = 20; // 最多重试20次（2秒）

            function attemptInitialization() {
                if (initializeSystem()) {
                    console.log('✅ 系统初始化成功');
                    return;
                }

                initRetryCount++;
                if (initRetryCount < maxInitRetries) {
                    console.log(`🔄 重试系统初始化 (${initRetryCount}/${maxInitRetries})`);
                    setTimeout(attemptInitialization, 100);
                } else {
                    console.error('❌ 系统初始化失败，已达到最大重试次数');
                    // 即使失败也要绑定按钮，以防万一
                    bindGenerateButtonEvent();
                }
            }

            // 立即开始初始化
            attemptInitialization();

            // 🔍 调试监控：追踪Toggle状态变化
            console.log('🔍 启动Toggle状态监控系统...');

            // 监控instrumentModeToggle状态变化
            const instrumentToggle = document.getElementById('instrumentModeToggle');
            if (instrumentToggle) {
                let lastInstrumentState = instrumentToggle.checked;
                console.log(`🔍 初始instrumentToggle状态: ${lastInstrumentState ? '钢琴模式' : '吉他模式'}`);

                setInterval(() => {
                    if (instrumentToggle.checked !== lastInstrumentState) {
                        console.warn(`🔄 检测到instrumentToggle状态变化: ${lastInstrumentState ? '钢琴' : '吉他'} → ${instrumentToggle.checked ? '钢琴' : '吉他'}`);
                        console.trace('📍 状态变化调用栈');
                        lastInstrumentState = instrumentToggle.checked;
                    }
                }, 100);
            } else {
                console.error('❌ 监控失败: 未找到instrumentModeToggle元素');
            }

            // 监控functionalHarmonyToggle状态变化
            const functionalToggle = document.getElementById('functionalHarmonyToggle');
            if (functionalToggle) {
                let lastFunctionalState = functionalToggle.checked;
                console.log(`🔍 初始functionalHarmonyToggle状态: ${lastFunctionalState ? '功能和声模式' : '随机模式'}`);

                setInterval(() => {
                    if (functionalToggle.checked !== lastFunctionalState) {
                        console.warn(`🔄 检测到functionalHarmonyToggle状态变化: ${lastFunctionalState ? '功能和声' : '随机'} → ${functionalToggle.checked ? '功能和声' : '随机'}`);
                        console.trace('📍 状态变化调用栈');
                        lastFunctionalState = functionalToggle.checked;
                    }
                }, 100);
            } else {
                console.error('❌ 监控失败: 未找到functionalHarmonyToggle元素');
            }

            console.log('✅ Toggle状态监控系统已启动（每100ms检查一次）');
        });

        // ============ 弹窗管理函数 ============

        // 打开和弦类型设置弹窗


        // 打开节奏设置弹窗
        function openRhythmSettings() {
            const modal = document.getElementById('rhythmModal');
            if (modal) {
                modal.style.display = 'block';
                // 应用翻译到弹窗内容
                applyTranslations();
                console.log('✅ 节奏设置弹窗已打开并应用翻译');
            }
        }

        // 关闭节奏设置弹窗
        function closeRhythmSettings() {
            const modal = document.getElementById('rhythmModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // 打开调号设置弹窗
        function openKeySignatureSettings() {
            const modal = document.getElementById('keySignatureModal');
            if (modal) {
                modal.style.display = 'block';
                // 加载当前调号设置到UI
                loadCurrentKeySettings();
                // 应用翻译到弹窗内容
                applyTranslations();
                console.log('✅ 调号设置弹窗已打开并应用翻译');
            }
        }

        // 加载当前调号设置到UI
        function loadCurrentKeySettings() {
            // 首先清除所有checkbox的选中状态
            const allCheckboxes = document.querySelectorAll('#keySignatureModal input[type="checkbox"]');
            allCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });

            // 如果有保存的调号设置，则选中对应的checkbox
            if (window.chordSettings && window.chordSettings.keys) {
                window.chordSettings.keys.forEach(key => {
                    const checkbox = document.querySelector(`#keySignatureModal input[value="${key}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        console.log(`🎯 已选中调号: ${key}`);
                    }
                });
            } else {
                // 如果没有保存的设置，默认选中C大调
                const defaultCheckbox = document.querySelector('#keySignatureModal input[value="C-major"]');
                if (defaultCheckbox) {
                    defaultCheckbox.checked = true;
                    console.log('🎯 默认选中C大调');
                }
            }
        }

        // 关闭调号设置弹窗
        function closeKeySignatureSettings() {
            const modal = document.getElementById('keySignatureModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // 为了兼容HTML中的函数调用，添加别名函数
        function closeKeySettings() {
            closeKeySignatureSettings();
        }

        // 打开拍号设置弹窗
        function openTimeSignatureSettings() {
            const modal = document.getElementById('timeSignatureModal');
            if (modal) {
                modal.style.display = 'block';
                // 应用翻译到弹窗内容
                applyTranslations();
                console.log('✅ 拍号设置弹窗已打开并应用翻译');
            }
        }

        // 关闭拍号设置弹窗
        function closeTimeSignatureSettings() {
            const modal = document.getElementById('timeSignatureModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // 打开谱号设置弹窗
        function openClefSettings() {
            const modal = document.getElementById('clefModal');
            if (modal) {
                modal.style.display = 'block';

                // 🎼 根据当前模式调整可用选项
                const instrumentToggle = document.getElementById('instrumentModeToggle');
                const isPianoMode = instrumentToggle && instrumentToggle.checked;

                // 获取低音谱号选项
                const bassClefInput = modal.querySelector('input[value="bass"]');
                const bassClefItem = bassClefInput ? bassClefInput.closest('label.checkbox-item') : null;

                if (isPianoMode) {
                    // 钢琴模式：隐藏低音谱号选项
                    if (bassClefItem) {
                        bassClefItem.style.display = 'none';
                        console.log('🎹 钢琴模式：隐藏低音谱号选项（只显示大谱表和高音谱号）');
                    }
                } else {
                    // 吉他模式：这个函数本来就不应该被调用，但为了安全起见
                    console.log('🎸 吉他模式：谱号设置不应该在吉他模式下打开');
                    modal.style.display = 'none';
                    return;
                }

                // 应用翻译到弹窗内容
                applyTranslations();
                console.log('✅ 谱号设置弹窗已打开并应用翻译');
            }
        }

        // 关闭谱号设置弹窗
        function closeClefSettings() {
            const modal = document.getElementById('clefModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // 🎹 打开低音谱号音域设置弹窗
        function openBassClefRangeModal() {
            const modal = document.getElementById('bassClefRangeModal');
            if (modal) {
                // 从系统设置中读取当前值并同步到UI
                if (window.pianoSettings) {
                    const minSelect = document.getElementById('bassClefRangeMin');
                    const maxSelect = document.getElementById('bassClefRangeMax');

                    if (minSelect) minSelect.value = window.pianoSettings.bassClefRangeMin || 43;
                    if (maxSelect) maxSelect.value = window.pianoSettings.bassClefRangeMax || 64;

                    console.log(`🎹 已同步低音谱号音域到UI: ${window.pianoSettings.bassClefRangeMin}-${window.pianoSettings.bassClefRangeMax}`);
                }

                modal.style.display = 'block';
                applyTranslations();
                console.log('🎹 低音谱号音域设置弹窗已打开');
            }
        }

        // 🎹 关闭低音谱号音域设置弹窗
        function closeBassClefRangeModal() {
            const modal = document.getElementById('bassClefRangeModal');
            if (modal) {
                modal.style.display = 'none';
                console.log('🎹 低音谱号音域设置弹窗已关闭');
            }
        }

        // 🎹 保存低音谱号音域设置
        function saveBassClefRange() {
            const rangeMin = document.getElementById('bassClefRangeMin').value;
            const rangeMax = document.getElementById('bassClefRangeMax').value;

            // 保存到全局设置对象（将在后续阶段实现）
            if (!window.pianoSettings) {
                window.pianoSettings = {};
            }
            window.pianoSettings.bassClefRangeMin = parseInt(rangeMin);
            window.pianoSettings.bassClefRangeMax = parseInt(rangeMax);

            // 更新按钮显示
            const midiToNoteName = (midi) => {
                const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                const octave = Math.floor(midi / 12) - 1;
                const noteName = notes[midi % 12];
                return `${noteName}${octave}`;
            };

            const displayText = `(${midiToNoteName(rangeMin)}-${midiToNoteName(rangeMax)})`;
            document.getElementById('bassClefRangeDisplay').textContent = displayText;

            console.log(`🎹 低音谱号音域已保存: ${displayText}`);
            closeBassClefRangeModal();
        }

        // 🎹 打开高音谱号音域设置弹窗
        function openTrebleClefRangeModal() {
            const modal = document.getElementById('trebleClefRangeModal');
            if (modal) {
                // 从系统设置中读取当前值并同步到UI
                if (window.pianoSettings) {
                    const minSelect = document.getElementById('trebleClefRangeMin');
                    const maxSelect = document.getElementById('trebleClefRangeMax');

                    if (minSelect) minSelect.value = window.pianoSettings.trebleClefRangeMin || 55;
                    if (maxSelect) maxSelect.value = window.pianoSettings.trebleClefRangeMax || 88;

                    console.log(`🎹 已同步高音谱号音域到UI: ${window.pianoSettings.trebleClefRangeMin}-${window.pianoSettings.trebleClefRangeMax}`);
                }

                modal.style.display = 'block';
                applyTranslations();
                console.log('🎹 高音谱号音域设置弹窗已打开');
            }
        }

        // 🎹 关闭高音谱号音域设置弹窗
        function closeTrebleClefRangeModal() {
            const modal = document.getElementById('trebleClefRangeModal');
            if (modal) {
                modal.style.display = 'none';
                console.log('🎹 高音谱号音域设置弹窗已关闭');
            }
        }

        // 🎹 保存高音谱号音域设置
        function saveTrebleClefRange() {
            const rangeMin = document.getElementById('trebleClefRangeMin').value;
            const rangeMax = document.getElementById('trebleClefRangeMax').value;

            // 保存到全局设置对象（将在后续阶段实现）
            if (!window.pianoSettings) {
                window.pianoSettings = {};
            }
            window.pianoSettings.trebleClefRangeMin = parseInt(rangeMin);
            window.pianoSettings.trebleClefRangeMax = parseInt(rangeMax);

            // 更新按钮显示
            const midiToNoteName = (midi) => {
                const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                const octave = Math.floor(midi / 12) - 1;
                const noteName = notes[midi % 12];
                return `${noteName}${octave}`;
            };

            const displayText = `(${midiToNoteName(rangeMin)}-${midiToNoteName(rangeMax)})`;
            document.getElementById('trebleClefRangeDisplay').textContent = displayText;

            console.log(`🎹 高音谱号音域已保存: ${displayText}`);
            closeTrebleClefRangeModal();
        }

        // 🎹 钢琴设置管理函数

        /**
         * 从UI读取钢琴音数选择
         * @returns {Array<number>} 选中的音数数组
         */
        function getPianoNoteCountsFromUI() {
            const noteCounts = [];
            console.log('🔍 开始读取钢琴音数checkbox状态:');
            // 🔧 修复 (2025-10-01): 只处理3-7音
            for (let i = 3; i <= 7; i++) {
                const checkbox = document.getElementById(`notecount-${i}`);
                if (checkbox) {
                    console.log(`  notecount-${i}: ${checkbox.checked ? '✅ 已勾选' : '☐ 未勾选'}`);
                    if (checkbox.checked) {
                        noteCounts.push(i);
                    }
                } else {
                    console.log(`  notecount-${i}: ❌ 元素未找到`);
                }
            }
            console.log(`🔍 最终读取到的音数: [${noteCounts.join(', ')}]`);
            return noteCounts;
        }

        /**
         * 更新pianoSettings从UI
         */
        function updatePianoSettingsFromUI() {
            if (!window.pianoSettings) {
                console.warn('⚠️ pianoSettings未初始化');
                return;
            }

            // 🔍 诊断：显示更新前的音数设置（2025-10-01）
            console.log('🔍 [updatePianoSettingsFromUI] 更新前 window.pianoSettings.enabledNoteCounts:',
                        JSON.stringify(window.pianoSettings.enabledNoteCounts));

            // 更新音数选择
            const noteCountsFromUI = getPianoNoteCountsFromUI();
            console.log('🔍 [updatePianoSettingsFromUI] 从UI读取的音数:', JSON.stringify(noteCountsFromUI));

            window.pianoSettings.enabledNoteCounts = noteCountsFromUI;

            console.log('🔍 [updatePianoSettingsFromUI] 更新后 window.pianoSettings.enabledNoteCounts:',
                        JSON.stringify(window.pianoSettings.enabledNoteCounts));

            // 🎹 从UI控件读取音域设置（2025-10-01修复）
            // 确保使用最新的音域设置值
            const bassMinSelect = document.getElementById('bassClefRangeMin');
            const bassMaxSelect = document.getElementById('bassClefRangeMax');
            const trebleMinSelect = document.getElementById('trebleClefRangeMin');
            const trebleMaxSelect = document.getElementById('trebleClefRangeMax');

            if (bassMinSelect && bassMinSelect.value) {
                window.pianoSettings.bassClefRangeMin = parseInt(bassMinSelect.value);
            }
            if (bassMaxSelect && bassMaxSelect.value) {
                window.pianoSettings.bassClefRangeMax = parseInt(bassMaxSelect.value);
            }
            if (trebleMinSelect && trebleMinSelect.value) {
                window.pianoSettings.trebleClefRangeMin = parseInt(trebleMinSelect.value);
            }
            if (trebleMaxSelect && trebleMaxSelect.value) {
                window.pianoSettings.trebleClefRangeMax = parseInt(trebleMaxSelect.value);
            }

            console.log('🎹 钢琴设置已更新:', {
                enabledNoteCounts: window.pianoSettings.enabledNoteCounts,
                bassClefRange: `${window.pianoSettings.bassClefRangeMin}-${window.pianoSettings.bassClefRangeMax}`,
                trebleClefRange: `${window.pianoSettings.trebleClefRangeMin}-${window.pianoSettings.trebleClefRangeMax}`
            });
        }

        /**
         * 验证钢琴设置有效性
         * @returns {Object} {valid: boolean, errors: Array<string>}
         */
        function validatePianoSettings() {
            const errors = [];

            if (!window.pianoSettings) {
                errors.push('pianoSettings未初始化');
                return { valid: false, errors };
            }

            // 验证音数选择
            if (!window.pianoSettings.enabledNoteCounts || window.pianoSettings.enabledNoteCounts.length === 0) {
                errors.push('未选择任何音数');
            }

            // 验证低音谱号音域
            if (window.pianoSettings.bassClefRangeMin >= window.pianoSettings.bassClefRangeMax) {
                errors.push('低音谱号音域范围无效');
            }

            // 验证高音谱号音域
            if (window.pianoSettings.trebleClefRangeMin >= window.pianoSettings.trebleClefRangeMax) {
                errors.push('高音谱号音域范围无效');
            }

            // 验证音数与音域的兼容性
            const maxNoteCount = Math.max(...window.pianoSettings.enabledNoteCounts);
            const trebleClefMinNotes = window.pianoSettings.noteDistribution.trebleClefMinNotes;

            if (maxNoteCount < trebleClefMinNotes + 1) {  // +1 for bass clef root note
                errors.push(`最大音数(${maxNoteCount})小于最小要求(${trebleClefMinNotes + 1})`);
            }

            return {
                valid: errors.length === 0,
                errors
            };
        }

        /**
         * 获取钢琴当前设置摘要
         * @returns {string} 设置摘要字符串
         */
        function getPianoSettingsSummary() {
            if (!window.pianoSettings) {
                return '钢琴设置未初始化';
            }

            const midiToNoteName = (midi) => {
                const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                const octave = Math.floor(midi / 12) - 1;
                const noteName = notes[midi % 12];
                return `${noteName}${octave}`;
            };

            return `
🎹 钢琴和声生成设置:
  音数选择: ${window.pianoSettings.enabledNoteCounts.join(', ')}音
  低音谱号: ${midiToNoteName(window.pianoSettings.bassClefRangeMin)}-${midiToNoteName(window.pianoSettings.bassClefRangeMax)}
  高音谱号: ${midiToNoteName(window.pianoSettings.trebleClefRangeMin)}-${midiToNoteName(window.pianoSettings.trebleClefRangeMax)}
  音符分配: 低音谱号(根音) + 高音谱号(≥${window.pianoSettings.noteDistribution.trebleClefMinNotes}音)
  优先音符: ${window.pianoSettings.noteDistribution.priorityNotes.join(', ')}
            `.trim();
        }

        /**
         * 🎹 钢琴和弦生成主函数
         * 使用PianoNoteCountEngine生成基于音数选择的钢琴和声
         */
        function generatePianoChords() {
            console.log('🎹 ========== 开始生成钢琴和弦 ==========');

            try {
                // 🔧 2025-10-01 修复：移除updatePianoSettingsFromUI()调用
                // 问题：用户在弹窗中保存设置后，此处重新从UI读取会覆盖已保存的设置
                // 原因：弹窗关闭后UI checkbox状态可能与保存的设置不同步
                // 解决：依赖弹窗保存的window.pianoSettings，不在生成时重新读取UI
                // 旧代码：updatePianoSettingsFromUI();

                // 🔍 诊断：显示当前使用的音数设置
                console.log('🎹 当前 window.pianoSettings.enabledNoteCounts:',
                           JSON.stringify(window.pianoSettings?.enabledNoteCounts));

                // 2. 验证设置
                const validation = validatePianoSettings();
                if (!validation.valid) {
                    console.error('❌ 钢琴设置验证失败:', validation.errors);
                    alert('设置错误：\n' + validation.errors.join('\n'));
                    return;
                }

                console.log(getPianoSettingsSummary());

                // 3. 初始化钢琴引擎
                if (typeof PianoNoteCountEngine === 'undefined') {
                    throw new Error('PianoNoteCountEngine 未加载');
                }

                if (!window.harmonyTheory) {
                    throw new Error('HarmonyTheory 未初始化');
                }

                const pianoEngine = new PianoNoteCountEngine(window.harmonyTheory);
                console.log('✅ 钢琴引擎初始化成功');

                // 4. 读取用户设置
                const measures = parseInt(document.querySelector('input[name="measures"]:checked')?.value || '4');

                // 检查是否启用功能和声模式（提前检查，用于调号选择）
                const functionalHarmonyToggle = document.getElementById('functionalHarmonyToggle');
                const useFunctionalHarmony = functionalHarmonyToggle ? functionalHarmonyToggle.checked : false;

                // 🎯 智能调号选择：功能和声模式使用第一个调号，随机模式随机选择
                let key = 'C-major'; // 默认调号
                if (window.chordSettings && window.chordSettings.keys && window.chordSettings.keys.length > 0) {
                    if (useFunctionalHarmony) {
                        // 功能和声模式：使用第一个选中的调号（用户明确选择的调性）
                        key = window.chordSettings.keys[0];
                        console.log(`🎼 功能和声模式 - 使用第一个选中调号: ${key}`);
                    } else {
                        // 随机模式：从可用调号中随机选择
                        const randomIndex = Math.floor(Math.random() * window.chordSettings.keys.length);
                        key = window.chordSettings.keys[randomIndex];
                        console.log(`🎲 随机模式 - 随机选择调号: ${key} (从${window.chordSettings.keys.length}个可用调号中选择)`);
                    }
                } else {
                    console.log(`🎹 使用默认调号: ${key}`);
                }

                console.log(`🎹 小节数: ${measures}, 调性: ${key}`);

                // 5. 🎵 集成和弦进行生成系统 - 支持随机模式和功能和声模式
                console.log('🎵 开始生成和弦进行...');

                // 🔍 诊断：检查和弦类型设置
                console.log('\n🔍 ========== 钢琴模式完整设置诊断 ==========');
                console.log('🎯 window.chordSettings.chordTypes:', window.chordSettings.chordTypes);
                console.log('🎯 是否为数组:', Array.isArray(window.chordSettings.chordTypes));
                console.log('🎯 数组长度:', window.chordSettings.chordTypes ? window.chordSettings.chordTypes.length : 'undefined');
                console.log('🎯 包含7和弦:', window.chordSettings.chordTypes ? window.chordSettings.chordTypes.filter(t => t.includes('7')).length : 0);
                console.log('🎯 包含3和弦:', window.chordSettings.chordTypes ? window.chordSettings.chordTypes.filter(t => ['major', 'minor', 'diminished', 'augmented'].includes(t)).length : 0);
                console.log('🎯 完整的chordSettings:', JSON.stringify(window.chordSettings, null, 2));
                console.log('\n🎹 window.pianoSettings.enabledNoteCounts:', window.pianoSettings?.enabledNoteCounts);
                console.log('🎹 是否为数组:', Array.isArray(window.pianoSettings?.enabledNoteCounts));
                console.log('🎹 数组长度:', window.pianoSettings?.enabledNoteCounts ? window.pianoSettings.enabledNoteCounts.length : 'undefined');
                console.log('🎹 完整的pianoSettings:', JSON.stringify(window.pianoSettings, null, 2));
                console.log('========== 诊断结束 ==========\n');

                // 调用对应的和弦进行生成函数
                let chordProgression;
                if (useFunctionalHarmony) {
                    console.log('🎼 使用功能和声模式生成和弦进行');
                    chordProgression = window.generateFunctionalProgression(key, measures);
                } else {
                    console.log('🎲 使用随机模式生成和弦进行');
                    chordProgression = window.generateDiverseProgression(key, measures);
                }

                if (!chordProgression || chordProgression.length === 0) {
                    throw new Error('和弦进行生成失败');
                }

                console.log(`✅ 生成了${chordProgression.length}个和弦:`, chordProgression.map(c => `${c.root}${c.type}`).join(', '));

                // 🔍 诊断：检查功能和声转位信息是否存在
                console.log('\n🔍 ========== 功能和声转位诊断 ==========');
                console.log(`功能和声模式: ${useFunctionalHarmony ? '开启' : '关闭'}`);
                chordProgression.forEach((chord, i) => {
                    console.log(`第${i+1}小节: ${chord.root}${chord.type}`);
                    console.log(`  - inversion: ${chord.inversion !== undefined ? chord.inversion : '未定义'}`);
                    console.log(`  - inversionReason: ${chord.inversionReason || '无'}`);
                    console.log(`  - forcedBassNote: ${chord.forcedBassNote || '无'}`);
                });
                console.log('========================================\n');

                // 6. 🎹 为每个和弦生成钢琴voicing（启用Voice Leading）
                // 🔧 修复 (2025-10-02 尝试5): 改用while循环，确保生成足够的小节数
                // 🔧 修复 (2025-10-06): 添加外层多样性检查循环

                const generatedChords = [];
                let prevBassMidi = null;  // 记录前一个和弦的低音MIDI值
                let chordIndex = 0;  // 当前尝试的和弦进行索引
                let successfulCount = 0;  // 成功生成的和弦数量

                // 🔧 新增 (2025-10-06): 和弦多样性检测 - 仅钢琴模式6/7音配置
                const userWantsSingleNoteCount = window.pianoSettings.enabledNoteCounts.length === 1;
                const singleNoteCountValue = userWantsSingleNoteCount ? window.pianoSettings.enabledNoteCounts[0] : null;
                const needsDiversityCheck = userWantsSingleNoteCount && (singleNoteCountValue === 6 || singleNoteCountValue === 7);

                let generatedChordNames = [];  // 记录已生成的和弦名称
                let attemptsSinceLastSuccess = 0;  // 自上次成功后的尝试次数
                let progressionRegenerationCount = 0;  // 和弦进行重新生成次数
                const maxProgressionRegenerations = 3;  // 最多重新生成3次
                const maxAttemptsBeforeRegeneration = chordProgression.length * 3;  // 最大尝试次数

                // 🔧 新增 (2025-10-06): 外层多样性检查
                let diversityRetryCount = 0;
                const maxDiversityRetries = 3;
                let finalGeneratedChords = [];

                if (needsDiversityCheck) {
                    console.log(`🎯 启用和弦多样性检测 (${singleNoteCountValue}音配置)`);
                    console.log(`  - 策略: 生成完成后检查多样性`);
                    console.log(`  - 如果重复太多，最多重新生成${maxDiversityRetries}次`);
                }

                // 外层循环：多样性检查
                while (diversityRetryCount <= maxDiversityRetries) {
                    // 重置内层循环的状态
                    generatedChords.length = 0;
                    generatedChordNames.length = 0;
                    successfulCount = 0;
                    chordIndex = 0;
                    prevBassMidi = null;
                    attemptsSinceLastSuccess = 0;
                    progressionRegenerationCount = 0;

                    // 🔧 修复 (2025-10-06): 将变量声明移到循环外，防止作用域错误
                    // 这些变量需要在卡住检测代码中访问，所以必须在try块外定义
                    const originalNoteCounts = [...window.pianoSettings.enabledNoteCounts];
                    const userWantsSingleNoteCount = originalNoteCounts.length === 1;
                    const singleNoteCountValue = userWantsSingleNoteCount ? originalNoteCounts[0] : null;

                    // 内层循环：生成和弦
                    while (successfulCount < measures) {
                    // 🔧 修复 (2025-10-06): 检测是否卡住（尝试太多次仍无进展）
                    // 🔧 修复 (2025-10-06): 移除needsDiversityCheck条件，防止多音数配置卡死
                    if (attemptsSinceLastSuccess > maxAttemptsBeforeRegeneration) {
                        console.warn(`⚠️ 检测到生成卡住: 尝试了${attemptsSinceLastSuccess}次，仍未生成新和弦`);

                        if (progressionRegenerationCount >= maxProgressionRegenerations) {
                            console.error(`❌ 已重新生成${maxProgressionRegenerations}次和弦进行，仍然卡住`);

                            // 🔧 修复 (2025-10-06): 动态生成错误信息，适用于单一和多音数模式
                            const noteCountDesc = userWantsSingleNoteCount
                                ? `${singleNoteCountValue}音配置`
                                : `多音数配置 [${originalNoteCounts.join(', ')}]`;

                            throw new Error(`无法生成足够的和弦（${noteCountDesc}），请尝试：\n1. 扩大音域范围\n2. 选择更多和弦类型\n3. 减少生成的小节数`);
                        }

                        console.warn(`🔄 重新生成和弦进行（第${progressionRegenerationCount + 1}次）`);

                        // 重新生成和弦进行
                        if (useFunctionalHarmony) {
                            chordProgression = window.generateFunctionalProgression(key, measures);
                        } else {
                            chordProgression = window.generateDiverseProgression(key, measures);
                        }

                        console.log(`✅ 新和弦进行: ${chordProgression.map(c => `${c.root}${c.type}`).join(', ')}`);

                        // 重置状态，但保留已生成的和弦（不从头开始）
                        chordIndex = 0;
                        attemptsSinceLastSuccess = 0;
                        progressionRegenerationCount++;
                        continue;  // 跳过本次循环，使用新的和弦进行
                    }

                    attemptsSinceLastSuccess++;  // 记录尝试次数

                    // 从和弦进行中循环选择和弦（如果到达末尾，从头开始）
                    const chord = chordProgression[chordIndex % chordProgression.length];
                    chordIndex++;

                    console.log(`🎹 生成第${successfulCount + 1}/${measures}小节 (尝试和弦: ${chord.root}${chord.type})`);

                    try {
                        let result = null;
                        let generatedSuccessfully = false;

                        // 🔧 修复 (2025-10-02 尝试5): 智能降级策略
                        // 问题：用户只勾选7音时，系统自动降级到6音/5音，违背用户意图
                        // 解决：检测用户是否只勾选了一个音数，如果是则不降级，失败时跳过该和弦
                        // 🔧 修复 (2025-10-06): originalNoteCounts和userWantsSingleNoteCount已在循环外定义
                        const fallbackSequence = [];

                        // 🔍 诊断：显示用户实际勾选的音数
                        console.log(`🔍 用户勾选的音数配置: [${originalNoteCounts.join(', ')}] (数量: ${originalNoteCounts.length})`);
                        console.log(`🔍 是否单一音数模式: ${userWantsSingleNoteCount}`);

                        // 构建fallback序列：
                        // - 用户只勾选一个音数：只尝试该音数，不降级
                        // - 用户勾选多个音数：随机选择一个作为首选，其他作为fallback
                        if (userWantsSingleNoteCount) {
                            // 🎯 单一音数模式：不降级，失败时跳过
                            fallbackSequence.push(originalNoteCounts[0]);
                            console.log(`🎯 单一音数模式：只尝试 ${originalNoteCounts[0]}音，失败时跳过和弦`);
                        } else {
                            // 🔄 多音数模式：随机选择 + fallback
                            // 🔧 修复 (2025-10-06): 使用用户勾选的音数，随机选择首选项

                            // 1. 随机打乱用户勾选的音数
                            const shuffledNoteCounts = [...originalNoteCounts].sort(() => Math.random() - 0.5);

                            // 2. 将打乱后的音数作为fallback序列
                            fallbackSequence.push(...shuffledNoteCounts);

                            console.log(`🔄 多音数模式：随机选择首选音数，fallback = [${fallbackSequence.join(' → ')}]`);
                            console.log(`   用户勾选: [${originalNoteCounts.join(', ')}]`);
                        }

                        // 尝试每个音数配置
                        for (let attemptIndex = 0; attemptIndex < fallbackSequence.length; attemptIndex++) {
                            const attemptNoteCount = fallbackSequence[attemptIndex];

                            // 临时修改settings，只允许当前尝试的音数
                            const attemptSettings = {
                                ...window.pianoSettings,
                                enabledNoteCounts: [attemptNoteCount]
                            };

                            console.log(`\n🔄 尝试 ${attemptIndex + 1}/${fallbackSequence.length}: ${attemptNoteCount}音配置`);

                            try {
                                // 🔧 修复 (2025-10-02): 功能和声模式下不传递随机转位设置
                                // 原因：功能和声模式下，chord.inversion 已由 applyFunctionalInversions() 设置
                                // 传递随机转位设置会引起冲突，钢琴引擎应该只使用 chord.inversion
                                const inversionSettings = useFunctionalHarmony ? null : {
                                    includeTriadInversions: window.chordSettings.includeTriadInversions || false,
                                    includeSeventhInversions: window.chordSettings.includeSeventhInversions || false
                                };

                                // 🔧 新增 (2025-10-06): 检测连续重复，强制使用转位来增加变化
                                if (needsDiversityCheck && !useFunctionalHarmony && inversionSettings && successfulCount > 0) {
                                    const prevChordName = generatedChordNames[generatedChordNames.length - 1];
                                    const currentChordName = `${chord.root}${chord.type}`;

                                    if (prevChordName === currentChordName) {
                                        // 连续重复！强制使用转位
                                        const hasInversionsEnabled = inversionSettings.includeTriadInversions || inversionSettings.includeSeventhInversions;

                                        if (hasInversionsEnabled) {
                                            inversionSettings.forceInversion = true;
                                            inversionSettings.minInversion = 1;  // 至少第一转位
                                            console.log(`🎯 检测到连续重复: ${prevChordName} → ${currentChordName}`);
                                            console.log(`   强制使用转位来增加变化（minInversion=1）`);
                                        } else {
                                            console.log(`⚠️ 检测到连续重复但转位未启用: ${currentChordName}`);
                                        }
                                    }
                                }

                                // 🔍 诊断：显示转位设置来源
                                if (useFunctionalHarmony) {
                                    console.log(`🎼 功能和声模式：inversionSettings = null（使用 chord.inversion）`);
                                } else {
                                    console.log(`🎲 随机模式：inversionSettings =`, inversionSettings);
                                }

                                // 🎯 第三转位约束检查（仅随机模式）
                                // 🔧 修复 (2025-10-02): 只在随机模式下执行（inversionSettings 不为 null）
                                // 音乐理论："Third inversion will sound ambiguous if it is not preceded by a root-position voicing of the same chord"
                                if (!useFunctionalHarmony && inversionSettings) {
                                    const hasTensions = chord.is69Voicing || chord.failed69Conversion;
                                    const isSeventhChord = chord.type.includes('7') ||
                                                          chord.type.includes('9') ||
                                                          chord.type.includes('11') ||
                                                          chord.type.includes('13');
                                    const needsThirdInversionCheck = isSeventhChord || hasTensions;

                                    if (needsThirdInversionCheck && successfulCount > 0) {
                                        const prevChord = generatedChords[successfulCount - 1];
                                        const isSameChord = prevChord.chordInfo.root === chord.root &&
                                                            prevChord.chordInfo.type === chord.type;
                                        const prevWasRootPosition = !prevChord.inversionIndex || prevChord.inversionIndex === 0;

                                        if (!isSameChord || !prevWasRootPosition) {
                                            // 禁止第三转位：最大转位设置为2
                                            inversionSettings.maxInversion = 2;
                                            console.log(`🎯 第三转位约束: ${chord.root}${chord.type} 最大转位=2 (七和弦/tension，前一和弦不符合条件)`);
                                        }
                                    }
                                } else if (useFunctionalHarmony) {
                                    console.log(`🎼 功能和声模式：第三转位约束由 applySeventhChordThirdInversion() 处理`);
                                }

                                result = pianoEngine.generatePianoChord(
                                    chord,
                                    attemptSettings,
                                    key,
                                    null,
                                    prevBassMidi,
                                    inversionSettings  // 🔧 新增参数 (2025-10-02)
                                );

                                // 验证结果
                                const resultValidation = pianoEngine.validateResult(result, attemptSettings);
                                if (resultValidation.valid) {
                                    generatedSuccessfully = true;
                                    if (attemptIndex > 0) {
                                        // 🔧 修复 (2025-10-06): 移除对maxNoteCount的引用（变量不存在）
                                        console.warn(`✅ Fallback成功: ${chord.root}${chord.type} 使用${attemptNoteCount}音配置（尝试${attemptIndex + 1}/${fallbackSequence.length}）`);
                                    } else {
                                        // 🔧 修复 (2025-10-06): 使用successfulCount替代i（变量不存在）
                                        console.log(`✅ 和弦 ${successfulCount + 1} 生成成功: ${attemptNoteCount}音配置`);
                                    }
                                    break;  // 成功，跳出尝试循环
                                } else {
                                    console.warn(`⚠️ ${attemptNoteCount}音配置验证失败:`, resultValidation.errors);
                                }
                            } catch (attemptError) {
                                console.warn(`⚠️ ${attemptNoteCount}音配置生成失败: ${attemptError.message}`);
                                if (attemptIndex === fallbackSequence.length - 1) {
                                    // 🔧 修复 (2025-10-02 尝试5): 单一音数模式下跳过和弦，不抛出错误
                                    if (userWantsSingleNoteCount) {
                                        console.warn(`⏭️ 跳过和弦 ${chord.root}${chord.type}（用户只勾选了${originalNoteCounts[0]}音，无法满足约束）`);
                                        // 不抛出错误，继续下一个和弦
                                        break;  // 跳出尝试循环，进入下一个和弦
                                    } else {
                                        // 多音数模式：所有降级尝试都失败了，抛出错误
                                        throw new Error(`所有降级尝试失败: ${chord.root}${chord.type}`);
                                    }
                                }
                                // 继续尝试下一个音数
                            }
                        }

                        if (generatedSuccessfully && result) {
                            generatedChords.push(result);
                            successfulCount++;  // 🔧 修复 (2025-10-02 尝试5): 成功生成后增加计数

                            // 🔧 新增 (2025-10-06): 成功时重置尝试计数器
                            if (needsDiversityCheck) {
                                attemptsSinceLastSuccess = 0;  // 重置
                                const chordName = `${chord.root}${chord.type}`;
                                generatedChordNames.push(chordName);
                                console.log(`📝 成功生成: ${chordName} (总共${generatedChordNames.length}个，重置尝试计数器)`);
                            }

                            // 🔍 详细诊断系统（2025-10-01新增）
                            console.log(`\n🔍 ========== 小节${successfulCount}详细诊断 ==========`);
                            console.log(`🎵 和弦名称: ${chord.root}${chord.type}`);
                            console.log(`🎹 总音符数: ${result.noteCount}音`);

                            // 低音谱号诊断
                            console.log(`\n📍 低音谱号 (Bass Clef):`);
                            console.log(`  音符数量: ${result.bassClefNotes.length}音`);
                            if (result.bassClefNotes && result.bassClefNotes.length > 0) {
                                const bassNoteNames = result.bassClefNotes.map(midi => {
                                    const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                                    const octave = Math.floor(midi / 12) - 1;
                                    const noteIndex = midi % 12;
                                    return `${noteNames[noteIndex]}${octave}`;
                                });
                                const bassSpan = Math.max(...result.bassClefNotes) - Math.min(...result.bassClefNotes);
                                console.log(`  音符: ${bassNoteNames.join(', ')}`);
                                console.log(`  MIDI: ${result.bassClefNotes.join(', ')}`);
                                console.log(`  跨度: ${bassSpan}半音 (${Math.min(...result.bassClefNotes)} → ${Math.max(...result.bassClefNotes)})`);
                            }

                            // 高音谱号诊断
                            console.log(`\n📍 高音谱号 (Treble Clef):`);
                            console.log(`  音符数量: ${result.trebleClefNotes.length}音`);
                            if (result.trebleClefNotes && result.trebleClefNotes.length > 0) {
                                const trebleNoteNames = result.trebleClefNotes.map(midi => {
                                    const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                                    const octave = Math.floor(midi / 12) - 1;
                                    const noteIndex = midi % 12;
                                    return `${noteNames[noteIndex]}${octave}`;
                                });
                                const trebleSpan = Math.max(...result.trebleClefNotes) - Math.min(...result.trebleClefNotes);
                                const sortedTreble = [...result.trebleClefNotes].sort((a, b) => a - b);

                                // 计算相邻音符间距
                                const intervals = [];
                                for (let j = 1; j < sortedTreble.length; j++) {
                                    intervals.push(sortedTreble[j] - sortedTreble[j-1]);
                                }
                                const maxInterval = intervals.length > 0 ? Math.max(...intervals) : 0;
                                const avgInterval = intervals.length > 0 ? (intervals.reduce((a,b) => a+b, 0) / intervals.length).toFixed(1) : 0;

                                console.log(`  音符: ${trebleNoteNames.join(', ')}`);
                                console.log(`  MIDI: ${result.trebleClefNotes.join(', ')}`);
                                console.log(`  跨度: ${trebleSpan}半音 (${Math.min(...result.trebleClefNotes)} → ${Math.max(...result.trebleClefNotes)})`);
                                console.log(`  最大间距: ${maxInterval}半音`);
                                console.log(`  平均间距: ${avgInterval}半音`);

                                // Close Voicing判断
                                if (trebleSpan <= 12) {
                                    console.log(`  ✅ Close Voicing (所有音符在一个八度内)`);
                                } else {
                                    console.log(`  ⚠️ 非Close Voicing (跨度超过一个八度)`);
                                }
                            }

                            // 全局统计
                            console.log(`\n📊 整体统计:`);
                            const allNotes = [...result.bassClefNotes, ...result.trebleClefNotes];
                            const globalSpan = Math.max(...allNotes) - Math.min(...allNotes);
                            console.log(`  全局跨度: ${globalSpan}半音`);
                            console.log(`  音域范围: MIDI ${Math.min(...allNotes)} (${(() => {
                                const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                                const midi = Math.min(...allNotes);
                                const octave = Math.floor(midi / 12) - 1;
                                const noteIndex = midi % 12;
                                return `${noteNames[noteIndex]}${octave}`;
                            })()}) → MIDI ${Math.max(...allNotes)} (${(() => {
                                const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                                const midi = Math.max(...allNotes);
                                const octave = Math.floor(midi / 12) - 1;
                                const noteIndex = midi % 12;
                                return `${noteNames[noteIndex]}${octave}`;
                            })()})`);
                            console.log(`========== 诊断结束 ==========\n`);

                            // 🎼 更新prevBassMidi为当前和弦的最低音（用于下一个和弦的Voice Leading）
                            if (result.bassClefNotes && result.bassClefNotes.length > 0) {
                                prevBassMidi = Math.min(...result.bassClefNotes);
                                console.log(`🎼 更新低音参考: MIDI ${prevBassMidi}`);
                            }
                        }
                    } catch (error) {
                        // 🔧 修复 (2025-10-02): 降级策略失败后的异常处理
                        console.error(`❌ 和弦 (${chord.root}${chord.type}) 所有降级尝试失败`);
                        console.error(`   原因: ${error.message}`);
                        console.error(`   💡 此和弦在所有音数配置下都无法满足12半音约束，已跳过`);
                        // 🔧 修复 (2025-10-02 尝试5): 不增加successfulCount，继续尝试下一个和弦
                        // while循环会自动选择下一个和弦，直到成功生成足够数量
                    }
                }
                    // 内层循环结束

                    // 🔧 新增 (2025-10-06): 检查生成的和弦多样性
                    if (needsDiversityCheck && generatedChordNames.length > 0) {
                        const uniqueChords = new Set(generatedChordNames);
                        const diversityRatio = uniqueChords.size / generatedChordNames.length;

                        console.log(`\n🔍 ========== 和弦多样性检查 ==========`);
                        console.log(`  生成的和弦: [${generatedChordNames.join(', ')}]`);
                        console.log(`  唯一和弦数: ${uniqueChords.size}`);
                        console.log(`  总和弦数: ${generatedChordNames.length}`);
                        console.log(`  多样性比例: ${(diversityRatio * 100).toFixed(1)}%`);

                        // 判断标准：至少50%的和弦是不同的
                        const isDiverse = uniqueChords.size >= 2 && diversityRatio >= 0.5;

                        if (isDiverse || diversityRetryCount >= maxDiversityRetries) {
                            console.log(`✅ 多样性检查通过 (重试${diversityRetryCount}次)`);
                            finalGeneratedChords = generatedChords;
                            break;  // 退出外层循环
                        } else {
                            console.warn(`⚠️ 多样性不足（第${diversityRetryCount + 1}次尝试）`);
                            console.warn(`   唯一和弦只有${uniqueChords.size}种: ${Array.from(uniqueChords).join(', ')}`);

                            // 重新生成和弦进行
                            if (useFunctionalHarmony) {
                                chordProgression = window.generateFunctionalProgression(key, measures);
                            } else {
                                chordProgression = window.generateDiverseProgression(key, measures);
                            }

                            console.log(`🔄 重新生成和弦进行: ${chordProgression.map(c => `${c.root}${c.type}`).join(', ')}`);
                            diversityRetryCount++;
                            continue;  // 继续外层循环
                        }
                    } else {
                        // 不需要多样性检查，直接使用结果
                        finalGeneratedChords = generatedChords;
                        break;
                    }
                }
                // 外层循环结束

                console.log(`\n✅ ========== 和弦生成完成 ==========`);
                console.log(`  目标小节数: ${measures}`);
                console.log(`  成功生成: ${successfulCount}小节`);
                console.log(`  尝试和弦总数: ${chordIndex}`);
                console.log(`========================================\n`);

                console.log('🎹 钢琴和弦进行生成完成:', finalGeneratedChords);

                // 6. 🎵 Phase 4: 渲染MusicXML大谱表
                console.log('\n🎼 ========== Phase 4: 开始渲染大谱表MusicXML ==========');

                // 6.1 将钢琴引擎输出转换为标准和弦对象格式
                const pianoChordProgression = finalGeneratedChords.map((result, index) => {
                    console.log(`🎹 转换第${index + 1}小节为标准格式:`, result);

                    // 🔍 诊断日志 (2025-10-02): 详细显示和弦信息
                    console.log(`🔍 和弦诊断信息:`);
                    console.log(`  - chordInfo.type: ${result.chordInfo.type}`);
                    console.log(`  - chordInfo.is69Voicing: ${result.chordInfo.is69Voicing}`);
                    console.log(`  - tensions数组: ${JSON.stringify(result.tensions)}`);
                    console.log(`  - tensions长度: ${result.tensions ? result.tensions.length : 'undefined'}`);

                    // 🎵 检测tensions并更新和弦类型（2025-10-02新增：支持add2/6/6/9和弦代号显示）
                    let displayType = result.chordInfo.type;

                    // 🎵 优先检查6/9和弦（2025-10-02新增）
                    if (result.chordInfo.is69Voicing) {
                        displayType = '6/9';
                        console.log(`🎵 检测到6/9和弦标记: ${result.chordInfo.root}maj7 → ${result.chordInfo.root}6/9`);
                    } else if (result.tensions && result.tensions.length > 0) {
                        const tensions = result.tensions;
                        console.log(`🎵 检测到tensions: ${tensions.join(', ')}`);

                        // 判断是三和弦还是七和弦
                        const isTriad = !result.chordInfo.type.includes('7') &&
                                       !result.chordInfo.type.includes('9') &&
                                       !result.chordInfo.type.includes('11') &&
                                       !result.chordInfo.type.includes('13');

                        if (isTriad) {
                            // 三和弦：添加add2或6后缀
                            if (tensions.includes('13')) {
                                // 6和弦（13th = 大六度）
                                if (result.chordInfo.type === 'major') {
                                    displayType = '6';
                                } else if (result.chordInfo.type === 'minor') {
                                    displayType = 'm6';
                                } else {
                                    displayType = result.chordInfo.type + '6';
                                }
                                console.log(`  ✅ 三和弦+13音 → 6和弦: ${displayType}`);
                            } else if (tensions.includes('9')) {
                                // add2和弦（9th = 大二度）
                                if (result.chordInfo.type === 'major') {
                                    displayType = 'add2';
                                } else if (result.chordInfo.type === 'minor') {
                                    displayType = 'madd2';
                                } else {
                                    displayType = result.chordInfo.type + 'add2';
                                }
                                console.log(`  ✅ 三和弦+9音 → add2和弦: ${displayType}`);
                            }
                        } else {
                            // 🔧 修复 (2025-10-02): 七和弦需要区分正常tension和6/9转换失败
                            // major7和弦添加tension后，仍然显示为maj7（不显示为maj9等）
                            // 但6/9转换失败时（七音被跳过），应该显示为add2/6
                            if (result.chordInfo.type === 'major7' || result.chordInfo.type === 'maj7') {
                                // 检查是否为6/9转换失败（七音已被跳过）
                                if (result.chordInfo.failed69Conversion) {
                                    // 6/9转换失败：七音已被跳过，只有tensions
                                    if (tensions.includes('9') && tensions.includes('13')) {
                                        // 同时有9和13但验证失败 → 可能是6add9
                                        displayType = '6add9';
                                        console.log(`  ⚠️ 6/9转换失败但有9+13 → 6add9和弦: ${displayType}`);
                                    } else if (tensions.includes('13') && !tensions.includes('9')) {
                                        // 只有13th → 6和弦
                                        displayType = '6';
                                        console.log(`  ⚠️ 6/9转换失败+仅13音 → 6和弦: ${displayType}`);
                                    } else if (tensions.includes('9') && !tensions.includes('13')) {
                                        // 只有9th → add2和弦
                                        displayType = 'add2';
                                        console.log(`  ⚠️ 6/9转换失败+仅9音 → add2和弦: ${displayType}`);
                                    }
                                } else {
                                    // 正常的major7和弦 + tensions → 保持为maj7
                                    console.log(`  ✅ major7和弦添加tensions后保持显示为maj7`);
                                    // displayType已经是'major7'，不需要修改
                                }
                            } else {
                                // 其他七和弦：tensions已经包含在原type中（如maj9, m11等）
                                console.log(`  ℹ️ 七和弦tensions保持原type: ${displayType}`);
                            }
                        }
                    }

                    // 🎼 创建兼容现有MusicXML系统的和弦对象
                    const formattedChord = {
                        root: result.chordInfo.root,
                        type: displayType,  // 🔧 修改：使用更新后的displayType
                        quality: result.chordInfo.quality,
                        // 🎹 钢琴专用标记：包含双谱表MIDI数据
                        isPianoMode: true,
                        pianoData: {
                            bassClefMidi: result.bassClefNotes,
                            trebleClefMidi: result.trebleClefNotes,
                            noteCount: result.noteCount
                        },
                        // 创建兼容voicing对象供MusicXML系统使用
                        voicing: {
                            type: `piano-${result.noteCount}notes`,
                            midiNotes: result.allNotes, // 所有音符按音高排序
                            notes: result.allNotes.map(midi => {
                                // 简单的MIDI到音符名称转换（后续由midiToPitchInfo精确处理）
                                const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                                const octave = Math.floor(midi / 12) - 1;
                                const noteIndex = midi % 12;
                                return noteNames[noteIndex] + octave;
                            })
                        }
                    };

                    console.log(`✅ 第${index + 1}小节转换完成:`, formattedChord);
                    return formattedChord;
                });

                // 6.2 构建完整的和弦对象供displayChords使用

                // 🎯 安全地构造keyInfo对象（增强方案：直接构造，不依赖查找）
                // 🔧 修复 (2025-10-01): 钢琴模式拼写问题 - 确保keyInfo正确传递
                let keyInfo;

                // 尝试从harmonyTheory.keys查找
                if (window.harmonyTheory && window.harmonyTheory.keys && window.harmonyTheory.keys[key]) {
                    keyInfo = window.harmonyTheory.keys[key];
                    console.log(`✅ 从harmonyTheory.keys查找到keyInfo:`, keyInfo);
                } else {
                    // 查找失败，手动构造keyInfo对象
                    console.warn(`⚠️ harmonyTheory.keys[${key}]查找失败，手动构造keyInfo`);

                    // 解析key字符串（如 "C-major", "a-minor", "Eb-major"）
                    const [tonicStr, modeStr] = key.split('-');
                    const mode = modeStr || 'major';

                    // 手动构造keyInfo（参考harmony-theory.js的keys对象结构）
                    const sharpKeys = {
                        'G': 1, 'D': 2, 'A': 3, 'E': 4, 'B': 5, 'F#': 6, 'C#': 7
                    };
                    const flatKeys = {
                        'F': 1, 'Bb': 2, 'Eb': 3, 'Ab': 4, 'Db': 5, 'Gb': 6, 'Cb': 7
                    };

                    let sharps = 0;
                    let flats = 0;
                    let tonic = tonicStr;

                    if (mode === 'major') {
                        if (sharpKeys[tonicStr]) {
                            sharps = sharpKeys[tonicStr];
                        } else if (flatKeys[tonicStr]) {
                            flats = flatKeys[tonicStr];
                        }
                    } else if (mode === 'minor') {
                        // 小调的升降号数量（相对大调-3个升号或+3个降号）
                        const minorSharpKeys = {
                            'e': 1, 'b': 2, 'f#': 3, 'c#': 4, 'g#': 5, 'd#': 6, 'a#': 7
                        };
                        const minorFlatKeys = {
                            'd': 1, 'g': 2, 'c': 3, 'f': 4, 'bb': 5, 'eb': 6, 'ab': 7
                        };

                        const tonicLower = tonicStr.toLowerCase();
                        if (minorSharpKeys[tonicLower]) {
                            sharps = minorSharpKeys[tonicLower];
                        } else if (minorFlatKeys[tonicLower]) {
                            flats = minorFlatKeys[tonicLower];
                        }

                        // 调整tonic为首字母小写（小调惯例）
                        tonic = tonicStr.charAt(0).toLowerCase() + tonicStr.slice(1);
                    }

                    keyInfo = {
                        tonic: tonic,
                        mode: mode,
                        sharps: sharps,
                        flats: flats
                    };

                    console.log(`🔧 手动构造keyInfo:`, keyInfo);
                }

                console.log(`🎯 最终使用的keyInfo:`, keyInfo, `(基于调号: ${key})`);

                // 🔍 诊断：验证Fb/Cb规则是否应该触发
                if (keyInfo.flats >= 6) {
                    console.log(`🎵 诊断：调号有${keyInfo.flats}个降号，应该使用Fb和Cb`);
                } else if (keyInfo.mode === 'minor' && keyInfo.tonic === 'Db') {
                    console.log(`🎵 诊断：db小调特殊情况，应该使用Fb`);
                } else {
                    console.log(`🎵 诊断：调号${keyInfo.tonic}-${keyInfo.mode}有${keyInfo.flats}个降号/${keyInfo.sharps}个升号，应该使用E和B`);
                }

                const chordsObject = {
                    progression: pianoChordProgression,
                    measures: pianoChordProgression.length,
                    key: 'C-major', // 保持安全的默认值
                    keyInfo: keyInfo, // 🎯 新增：直接传递构造好的keyInfo对象
                    timestamp: Date.now(),
                    isPianoMode: true // 🎹 标记为钢琴模式
                };

                console.log('🎹 钢琴和弦对象:', chordsObject);
                console.log('🔍 诊断：chordsObject.keyInfo确认:', chordsObject.keyInfo);

                // 🔧 修复 (2025-10-01): 添加到历史记录（使上一条/下一条功能正常工作）
                if (typeof window.currentChords !== 'undefined') {
                    window.currentChords = chordsObject;
                }
                if (typeof window.chordsHistory !== 'undefined' && typeof window.currentChordsIndex !== 'undefined') {
                    window.chordsHistory.push(chordsObject);
                    window.currentChordsIndex = window.chordsHistory.length - 1;
                    console.log(`📋 已添加到历史记录 (索引: ${window.currentChordsIndex}, 总数: ${window.chordsHistory.length})`);
                }

                // 6.3 调用displayChords渲染到五线谱
                // displayChords会自动检测钢琴模式并使用大谱表渲染
                console.log('🎼 调用displayChords渲染大谱表...');
                displayChords(chordsObject);

                console.log('✅ 钢琴大谱表渲染完成');

            } catch (error) {
                console.error('❌ 钢琴和弦生成失败:', error);
                alert(`生成失败：${error.message}\n请查看控制台了解详情`);
            }

            console.log('🎹 ========== 钢琴和弦生成结束 ==========');
        }

        // 保存设置的函数（简化版本）

        function saveRhythmSettings() {
            console.log('💾 保存节奏设置...');
            // 这里可以添加实际的保存逻辑

            // 🔧 2025-10-01 修复：更新动态控件翻译
            updateDynamicControlsTranslation();
            console.log('🔄 已更新动态控件翻译');

            closeRhythmSettings();
            console.log('✅ 节奏设置已保存，弹窗已关闭');
        }

        function saveKeySettings() {
            console.log('💾 保存调号设置...');

            // 🔍 诊断：记录保存前的功能和声状态
            const functionalToggleBefore = document.getElementById('functionalHarmonyToggle');
            const stateBefore = {
                toggleExists: !!functionalToggleBefore,
                toggleChecked: functionalToggleBefore ? functionalToggleBefore.checked : null,
                chordSettingsExists: typeof window.chordSettings !== 'undefined',
                useFunctionalHarmony: window.chordSettings ? window.chordSettings.useFunctionalHarmony : null
            };
            console.log('🔍 保存前状态:', stateBefore);

            // 获取所有选中的调号
            const selectedKeys = [];
            const keyCheckboxes = document.querySelectorAll('#keySignatureModal input[type="checkbox"]:checked');

            console.log(`🔍 找到${keyCheckboxes.length}个选中的调号checkbox`);
            keyCheckboxes.forEach(checkbox => {
                selectedKeys.push(checkbox.value);
                console.log(`  ✅ 选中调号: ${checkbox.value}`);
            });

            console.log(`🎯 总共收集了${selectedKeys.length}个调号:`, selectedKeys);

            // 保存到全局设置 (使用正确的keys字段)
            if (typeof window.chordSettings !== 'undefined') {
                // 🔧 2025-09-30 修复：保存调号设置时保留功能和声模式状态
                // 问题：只更新keys可能不会保留其他设置
                // 解决：明确保留 useFunctionalHarmony 的当前值
                const currentFunctionalState = window.chordSettings.useFunctionalHarmony;
                window.chordSettings.keys = selectedKeys;
                // 确保功能和声状态不被改变
                window.chordSettings.useFunctionalHarmony = currentFunctionalState;
                console.log('🎯 已保存调号设置到 chordSettings.keys:', selectedKeys);
                console.log('🔒 功能和声状态保持不变:', currentFunctionalState);
            } else {
                // 🔧 修复：如果chordSettings不存在，创建一个带默认值的对象
                // 重要：不要覆盖已存在的chordSettings！
                if (!window.chordSettings) {
                    window.chordSettings = {
                        keys: selectedKeys,
                        useFunctionalHarmony: true  // 保留默认的功能和声模式状态
                    };
                } else {
                    window.chordSettings.keys = selectedKeys;
                }
                console.log('🎯 已创建并保存调号设置到 chordSettings.keys:', selectedKeys);
            }

            // 更新显示状态
            updateKeySettingsDisplay(selectedKeys);

            closeKeySignatureSettings();

            // 🔍 诊断：记录保存后的功能和声状态
            const functionalToggleAfter = document.getElementById('functionalHarmonyToggle');
            const stateAfter = {
                toggleExists: !!functionalToggleAfter,
                toggleChecked: functionalToggleAfter ? functionalToggleAfter.checked : null,
                chordSettingsExists: typeof window.chordSettings !== 'undefined',
                useFunctionalHarmony: window.chordSettings ? window.chordSettings.useFunctionalHarmony : null
            };
            console.log('🔍 保存后状态:', stateAfter);

            // 🚨 检测状态变化
            if (stateBefore.toggleChecked !== stateAfter.toggleChecked) {
                console.warn('🚨 警告：功能和声toggle状态发生了变化！');
                console.warn(`   - 变化前: ${stateBefore.toggleChecked}`);
                console.warn(`   - 变化后: ${stateAfter.toggleChecked}`);
            }
            if (stateBefore.useFunctionalHarmony !== stateAfter.useFunctionalHarmony) {
                console.warn('🚨 警告：chordSettings.useFunctionalHarmony发生了变化！');
                console.warn(`   - 变化前: ${stateBefore.useFunctionalHarmony}`);
                console.warn(`   - 变化后: ${stateAfter.useFunctionalHarmony}`);
            }

            // 🔧 2025-09-30 修复：更新动态控件翻译，确保label文字与toggle状态同步
            // 问题：applyTranslations()会将harmonyModeLabel重置为data-i18n的默认值"随机模式"
            // 解决：调用updateDynamicControlsTranslation()根据toggle实际状态更新文字
            updateDynamicControlsTranslation();
            console.log('🔄 已更新动态控件翻译，确保功能和声label文字正确');

            console.log('✅ 调号设置已保存，弹窗已关闭');
        }

        function updateKeySettingsDisplay(selectedKeys) {
            const keyBtn = document.getElementById('keySettingsBtn');
            if (keyBtn) {
                // 始终显示固定的"调号设置"文本，不显示具体数量
                keyBtn.textContent = translate('controls.KeySettings');
                console.log(`🎯 调号按钮保持固定显示: ${translate('controls.KeySettings')} (已选择${selectedKeys ? selectedKeys.length : 0}个调号)`);
            }
        }

        function saveTimeSignatureSettings() {
            console.log('💾 保存拍号设置...');
            // 这里可以添加实际的保存逻辑

            // 🔧 2025-10-01 修复：更新动态控件翻译
            updateDynamicControlsTranslation();
            console.log('🔄 已更新动态控件翻译');

            closeTimeSignatureSettings();
            console.log('✅ 拍号设置已保存，弹窗已关闭');
        }

        function saveClefSettings() {
            console.log('💾 保存谱号设置...');
            // 这里可以添加实际的保存逻辑

            // 🔧 2025-10-01 修复：更新动态控件翻译
            updateDynamicControlsTranslation();
            console.log('🔄 已更新动态控件翻译');

            closeClefSettings();
            console.log('✅ 谱号设置已保存，弹窗已关闭');
        }

        // 增强翻译应用功能
        function applyTranslationsToModals() {
            // 🔧 使用 I18n 系统 (2025-10-04)
            // 强制重新应用翻译到所有模态框
            if (window.I18n && window.I18n.applyLanguage) {
                window.I18n.applyLanguage(currentLanguage);
                console.log('🌐 模态框翻译已通过I18n系统重新应用');
            } else {
                console.warn('⚠️ I18n系统未加载，无法应用模态框翻译');
            }
        }

        // 重写语言切换函数以确保模态框翻译
        function switchLanguage(language) {
            currentLanguage = language;
            localStorage.setItem('preferredLanguage', language);
            applyTranslations();
            applyTranslationsToModals(); // 额外应用模态框翻译
            updateDynamicControlsTranslation(); // 更新动态控件翻译

            // 触发统一同步系统 (同标签页内实时同步)
            if (window.ICStudioSync) {
                window.ICStudioSync.syncLanguage(language, 'chord-tool');
            }

            // 关闭设置菜单
            if (typeof closeSettings === 'function') {
                closeSettings();
            }

            console.log(`🌐 和弦视奏工具语言已切换为: ${language}，模态框翻译已更新`);
        }

        // ⌨️ 全局键盘快捷键
        document.addEventListener('keydown', function(e) {
            // 如果在输入框、文本框或模态框输入中，不触发快捷键
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                return;
            }

            // 检查是否有模态框打开（避免在设置中触发）
            const hasOpenModal = document.querySelector('.modal:not([style*="display: none"])');
            if (hasOpenModal) {
                return;
            }

            const key = e.key.toLowerCase();

            switch(key) {
                case 'p':
                    // 播放/暂停播放
                    e.preventDefault();
                    if (typeof directPlayTest === 'function') {
                        directPlayTest();
                        console.log('⌨️ 快捷键: P - 播放/暂停');
                    }
                    break;

                case 'arrowleft':
                    // 上一条
                    e.preventDefault();
                    if (typeof previousChords === 'function') {
                        previousChords();
                        console.log('⌨️ 快捷键: ← - 上一条');
                    }
                    break;

                case 'arrowright':
                    // 下一条
                    e.preventDefault();
                    if (typeof nextChords === 'function') {
                        nextChords();
                        console.log('⌨️ 快捷键: → - 下一条');
                    }
                    break;

                case ' ':
                    // 生成（空格键）
                    e.preventDefault();
                    const generateBtn = document.getElementById('generateChordsBtn');
                    if (generateBtn) {
                        generateBtn.click();
                        console.log('⌨️ 快捷键: Space - 生成和弦');
                    }
                    break;

                case 'h':
                    // 隐藏/显示
                    e.preventDefault();
                    if (typeof toggleMelodyVisibility === 'function') {
                        toggleMelodyVisibility();
                        console.log('⌨️ 快捷键: H - 隐藏/显示');
                    }
                    break;

                case 'c':
                    // 节拍器开关
                    e.preventDefault();
                    if (typeof toggleMetronome === 'function') {
                        toggleMetronome();
                        console.log('⌨️ 快捷键: C - 节拍器开关');
                    }
                    break;
            }
        });

        console.log('⌨️ 和弦视奏工具快捷键已启用: P=播放 ←→=导航 Space=生成 H=隐藏 C=节拍器');

    </script>

    <!-- 🛡️ 试用保护系统脚本 -->
    <script src="/js/trial-limiter.js?v=20250909"></script>
    <script src="/js/advanced-trial-protection.js?v=20250920"></script>
    <script src="/js/melody-counter-system.js?v=20250920"></script>
    <script src="/js/integrated-trial-manager.js?v=20250920"></script>

</body></html>
