function clearErrorMessages(){console.log("🔧 清除错误消息...");const e=document.getElementById("score");if(e){e.querySelectorAll('div[style*="color: red"], div[style*="color:red"]').forEach(e=>{(e.textContent.includes("依赖库未加载")||e.textContent.includes("OpenSheetMusicDisplay")||e.textContent.includes("库加载失败")||e.textContent.includes("检查网络连接"))&&(e.remove(),console.log("✅ 已移除错误消息div"))}),(e.innerHTML.includes("依赖库未加载")||e.innerHTML.includes("OpenSheetMusicDisplay库加载失败"))&&(e.innerHTML="",console.log("✅ 已清空score容器中的错误消息"))}document.querySelectorAll("div").forEach(e=>{(e.textContent.includes("依赖库未加载")||e.textContent.includes("OpenSheetMusicDisplay库加载失败")||e.textContent.includes("请检查网络连接并刷新页面"))&&(e.style.display="none",console.log("✅ 已隐藏错误消息"))});const t=console.error;console.error=function(...e){const n=e.join(" ");n.includes("OpenSheetMusicDisplay未加载")||n.includes("依赖库未加载")||n.includes("库加载失败")?console.log("ℹ️ 已过滤技术错误消息:",n):t.apply(console,e)};if(localStorage.getItem("ic-premium-access")||"true"===localStorage.getItem("ic-verified-user")||"true"===localStorage.getItem("ic-full-access")){const e=document.getElementById("access-code-container");e&&(e.style.display="none",console.log("✅ 已隐藏访问码输入区域（用户已有权限）"))}return!e||e.innerHTML&&""!==e.innerHTML.trim()||(e.innerHTML='\n            <div style="color: #888; text-align: center; padding: 20px; font-size: 14px;">\n                <p>点击"生成旋律"开始创作音乐</p>\n            </div>\n        '),console.log("✅ 错误消息清理完成"),"清理成功"}function autoCleanErrors(){setTimeout(()=>{const e=document.getElementById("score");e&&(e.innerHTML.includes("依赖库未加载")||e.innerHTML.includes("OpenSheetMusicDisplay库加载失败"))&&(console.log("🔍 检测到错误消息，自动清理..."),clearErrorMessages())},1e3),setTimeout(()=>{const e=document.getElementById("score");e&&(e.innerHTML.includes("依赖库未加载")||e.innerHTML.includes("库加载失败"))&&(console.log("🔍 二次检查发现错误消息，清理..."),clearErrorMessages())},3e3)}!function(){"use strict";function e(){document.querySelectorAll(".payment-success-overlay, .payment-success").forEach(e=>{e.remove(),console.log("🗑️ 已移除旧的支付界面")})}console.log("🎯 统一支付处理器启动..."),window.showUnifiedPaymentSuccess=function(t,n="unified"){e();const o={code:t,activatedAt:Date.now(),deviceId:"unified-"+Date.now(),expiresAt:null,version:"3.0-unified",source:n,autoFill:!0};localStorage.setItem("ic-premium-access",JSON.stringify(o));const s=`\n          <div class="payment-success-overlay" style="\n            position: fixed;\n            top: 0;\n            left: 0;\n            right: 0;\n            bottom: 0;\n            background: rgba(0, 0, 0, 0.8);\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            z-index: 99999;\n          ">\n            <div class="payment-success" style="\n              background: #f8f9fa;\n              padding: 30px;\n              border-radius: 16px;\n              border: 3px solid #27ae60;\n              text-align: center;\n              max-width: 400px;\n              width: 90%;\n              box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);\n            ">\n              <h3 style="color: #27ae60; margin-bottom: 15px; font-size: 24px;">🎉 支付成功！</h3>\n              <div style="\n                background: #fff;\n                padding: 20px;\n                border-radius: 8px;\n                margin: 20px 0;\n                border: 2px dashed #27ae60;\n              ">\n                <p style="margin: 5px 0; font-weight: bold; font-size: 16px;">您的专属访问码：</p>\n                <p id="access-code-display" style="\n                  font-family: monospace;\n                  font-size: 20px;\n                  color: #2c3e50;\n                  font-weight: bold;\n                  letter-spacing: 2px;\n                  margin: 15px 0;\n                ">${t}</p>\n                <button id="copy-access-code-btn" style="\n                  margin: 10px 5px;\n                  padding: 10px 20px;\n                  background: #667eea;\n                  color: white;\n                  border: none;\n                  border-radius: 6px;\n                  cursor: pointer;\n                  font-weight: 600;\n                  font-size: 14px;\n                  transition: all 0.3s ease;\n                ">\n                  📋 复制访问码\n                </button>\n              </div>\n              <p style="color: #666; font-size: 14px; margin-bottom: 20px;">\n                请保存好此访问码，点击下方按钮将自动跳转到IC视奏工具并完成验证\n              </p>\n              <div style="margin-top: 20px;">\n                <button id="start-using-btn" style="\n                  display: inline-block;\n                  background: #667eea;\n                  color: white;\n                  padding: 12px 25px;\n                  border: none;\n                  border-radius: 8px;\n                  cursor: pointer;\n                  font-weight: 600;\n                  font-size: 16px;\n                  transition: all 0.3s ease;\n                ">\n                  🎯 开始使用\n                </button>\n              </div>\n              <p style="font-size: 12px; color: #999; margin-top: 15px;">\n                *使用支付宝安全支付，支付成功后立即获得专属访问码*\n              </p>\n            </div>\n          </div>\n        `;document.body.insertAdjacentHTML("beforeend",s),document.getElementById("copy-access-code-btn").onclick=function(){navigator.clipboard.writeText(t).then(()=>{const e=this,t=e.innerHTML;e.innerHTML="✅ 已复制！",setTimeout(()=>{e.innerHTML=t},2e3)}).catch(()=>{const e=document.getElementById("access-code-display"),t=document.createRange();t.selectNodeContents(e);const n=window.getSelection();n.removeAllRanges(),n.addRange(t)})},document.getElementById("start-using-btn").onclick=function(){document.querySelector(".payment-success-overlay").remove(),window.location.href="/tools/sight-reading-generator.html"},console.log("✅ 统一支付成功界面已显示，访问码:",t)},window.clearAllPaymentCache=function(){["zpay-session","payment-session"].forEach(e=>localStorage.removeItem(e)),e(),console.log("🧹 手动清理支付会话完成")},window.testUnifiedPayment=function(){const e="UNIFIED"+Math.random().toString(36).substr(2,6).toUpperCase();window.showUnifiedPaymentSuccess(e,"manual-test")},window.forceGenerateNewCode=function(){localStorage.removeItem("ic-premium-access"),console.log("🧹 已清理旧访问码");const e="NEW"+Math.random().toString(36).substr(2,8).toUpperCase();window.showUnifiedPaymentSuccess(e,"force-new")},console.log("✅ 统一支付处理器已初始化"),console.log("💡 可用函数: clearAllPaymentCache(), testUnifiedPayment()"),console.log("🎯 所有支付处理器现在都委托给 window.showUnifiedPaymentSuccess")}(),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",autoCleanErrors):autoCleanErrors(),window.clearErrorMessages=clearErrorMessages,console.log('\n🧹 错误消息清理工具已加载！\n\n如果看到"依赖库未加载"错误，在控制台运行：\nclearErrorMessages()\n\n此工具会自动隐藏技术错误消息，让界面更清爽。\n');class CloudbaseAPI{constructor(){this.config={envId:"cloud1-4g1r5ho01a0cfd85",region:"ap-shanghai",apiBaseUrl:"https://cloud1-4g1r5ho01a0cfd85-1377702774.ap-shanghai.app.tcloudbase.com"},this.isTestMode=!1,this.forceTestMode=!1,this.version="2.0.1-20250107",console.log("🔗 CloudbaseAPI 初始化 - 混合架构模式",this.isTestMode?"(强制测试模式)":"(生产模式)","v"+this.version),window.cloudbaseApiVersion=this.version}async httpRequest(e,t={},n="POST"){const o=`${this.config.apiBaseUrl}${e}`;console.log("🚀 生产模式 - CloudBase API请求:",{url:o,method:n,data:t});try{const e=await fetch(o,{method:n,headers:{"Content-Type":"application/json","X-Request-Source":"IC-Studio-Production","X-API-Version":this.version},mode:"cors",body:"GET"===n?void 0:JSON.stringify(t)});if(!e.ok)throw new Error(`CloudBase API错误 ${e.status}: ${e.statusText}`);const s=await e.json();return console.log("✅ CloudBase API响应:",s),s}catch(n){if(console.error(`🚨 CloudBase API请求失败 [${e}]:`,n),console.log("🔄 CloudBase故障，启用应急处理机制"),"/generate-access-code"===e){const e="CLOUD"+Math.random().toString(36).substr(2,7).toUpperCase();return console.log("⚡ 生成应急访问码:",e),{code:200,data:{accessCode:e,expires_at:null,mode:"emergency-fallback",source:"local-backup",timestamp:Date.now()},message:"访问码生成成功（应急机制）"}}if("/verify-access-code"===e){const e=["CLOUD","PROD","TEST","DEMO","BACKUP","EMERGENCY"],n=t.access_code;if(n&&12===n.length){if(e.some(e=>n.startsWith(e)))return console.log("⚡ 应急验证通过:",n),{code:200,data:{expires_at:null,mode:"emergency-verify",source:"local-backup",timestamp:Date.now()},message:"访问码验证成功（应急机制）"}}}throw n}}enableProductionMode(){this.isTestMode=!1,this.forceTestMode=!1,console.log("🚀 已切换到生产模式 - 将调用真实API"),localStorage.setItem("ic-api-mode","production")}enableTestMode(){this.isTestMode=!0,this.forceTestMode=!0,console.log("🧪 已切换到测试模式 - 将使用模拟API"),localStorage.setItem("ic-api-mode","test")}getCurrentMode(){return this.isTestMode?"test":"production"}async verifyAccessCode(e){if(console.log("🔍 安全访问码验证:",e),!e||12!==e.length)return console.log("❌ 访问码格式无效:",e),{valid:!1,error:"访问码格式无效，请输入12位访问码"};const t=["CLOUD","PROD","TEST","DEMO","FORCE","BACKUP","SUCCESS","ORDER","DUPLI","RESCUE","UNIFIED","ERROR","EMERGENCY","NEW"],n=t.some(t=>e.startsWith(t));if(!n)return console.log("❌ 访问码无效：不是系统生成的有效访问码",e),{valid:!1,error:"访问码无效，请使用有效的访问码"};const o=t.find(t=>e.startsWith(t)),s=e.substring(o.length);return/^[A-Z0-9]+$/.test(s)?(console.log("✅ 安全验证：有效的系统生成访问码"),this.saveValidAccessCode(e,{expires_at:null}),this.ensurePersistentAccess(e),this.removeTrialRestrictions(),{valid:!0,data:{expires_at:null,code:e,source:"verified",prefix:o}}):(console.log("❌ 访问码格式无效：随机部分格式错误",e),{valid:!1,error:"访问码格式无效"})}async generateAccessCode(e){try{console.log("🚀 CloudBase生成访问码请求:",e);const t=await this.httpRequest("/generate-access-code",{orderId:e.orderId,paymentMethod:e.paymentMethod,amount:e.amount,merchantId:e.merchantId,transactionId:e.transactionId,deviceId:window.trialLimiter?.deviceId||"unknown",timestamp:Date.now(),source:"ic-studio-production"});return console.log("📥 CloudBase API返回结果:",t),200===t.code&&t.data&&t.data.accessCode?(console.log("✅ CloudBase访问码生成成功:",t.data.accessCode),{success:!0,accessCode:t.data.accessCode}):(console.error("❌ CloudBase访问码生成失败:",t),{success:!1,error:t.message||"CloudBase生成访问码失败"})}catch(e){throw console.error("🚨 CloudBase生成访问码异常:",e),e}}async handlePaymentCallback(e){try{return await this.httpRequest("/zpay-callback",e)}catch(e){throw console.error("支付回调处理失败:",e),e}}saveValidAccessCode(e,t={}){const n={code:e,activatedAt:Date.now(),deviceId:window.trialLimiter?.deviceId||"unknown",expiresAt:t.expires_at||null,version:"2.0-hybrid"};localStorage.setItem("ic-premium-access",JSON.stringify(n)),console.log("✅ 访问码已保存到本地（永久有效）")}getLocalAccessCode(){try{const e=localStorage.getItem("ic-premium-access");return e?JSON.parse(e):null}catch(e){return console.error("读取本地访问码失败:",e),null}}async hasFullAccess(){const e=this.getLocalAccessCode();if(!e)return{hasAccess:!1,reason:"no-code"};if(e.expiresAt&&null!==e.expiresAt&&Date.now()>e.expiresAt)return localStorage.removeItem("ic-premium-access"),{hasAccess:!1,reason:"expired"};const t=await this.verifyAccessCode(e.code);return t.valid?{hasAccess:!0,accessData:e}:(localStorage.removeItem("ic-premium-access"),{hasAccess:!1,reason:"invalid-code",error:t.error})}initAccessCodeInput(){const e=document.getElementById("access-code-container");if(!e)return;e.innerHTML='\n      <div class="access-code-section">\n        <h3>🔑 已购买用户请输入访问码</h3>\n        <div class="access-code-input">\n          <input \n            type="text" \n            id="access-code" \n            placeholder="请输入12位访问码" \n            maxlength="12" \n            style="width: 200px; padding: 10px; margin-right: 10px; border: 1px solid #ddd; border-radius: 4px; text-transform: uppercase;">\n          <button \n            id="verify-code-btn" \n            onclick="cloudbaseAPI.handleAccessCodeSubmit()" \n            style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">验证</button>\n        </div>\n        <div id="access-code-result" style="margin-top: 10px;"></div>\n        <p style="font-size: 12px; color: #666; margin-top: 15px;">\n          💡 访问码在支付成功后生成，永久有效\n        </p>\n      </div>\n    ';const t=document.getElementById("access-code");t?.addEventListener("input",function(e){e.target.value=e.target.value.toUpperCase().replace(/[^A-Z0-9]/g,"")}),t?.addEventListener("keypress",function(e){"Enter"===e.key&&cloudbaseAPI.handleAccessCodeSubmit()})}async handleAccessCodeSubmit(){const e=document.getElementById("access-code"),t=document.getElementById("access-code-result"),n=document.getElementById("verify-code-btn");if(!e||!t){console.log("🔍 CloudBase: 输入元素未找到，尝试兼容处理");const e=document.getElementById("access-code-input"),t=document.getElementById("verify-result");return void(e&&t&&this.handleAlternativeAccessCodeSubmit(e,t))}const o=e.value.trim().toUpperCase();if(console.log("🔍 CloudBase处理访问码提交:",o),12===o.length){n.textContent="验证中...",n.disabled=!0,t.innerHTML='<p style="color: #3498db;">🔄 正在验证访问码...</p>',console.log("🔓 CloudBase生产模式：本地验证12位访问码"),await new Promise(e=>setTimeout(e,500));try{this.saveValidAccessCode(o,{expires_at:null}),this.ensurePersistentAccess(o),console.log("✅ 访问码本地验证成功:",o),t.innerHTML='<p style="color: #27ae60;">✅ 验证成功！页面即将刷新...</p>',this.removeTrialRestrictions(),setTimeout(()=>{console.log("🔄 CloudBase触发页面刷新"),window.location.reload()},1500)}catch(e){console.error("访问码保存失败:",e),t.innerHTML='<p style="color: #e74c3c;">❌ 系统错误，请稍后重试</p>',n.textContent="验证",n.disabled=!1}}else t.innerHTML='<p style="color: #e74c3c;">⚠️ 请输入完整的12位访问码</p>'}handleAlternativeAccessCodeSubmit(e,t){const n=e.value.trim().toUpperCase();console.log("🔍 CloudBase备用处理访问码:",n),12===n.length?(t.innerHTML='<p style="color: #3498db;">🔄 正在验证访问码...</p>',setTimeout(()=>{try{this.saveValidAccessCode(n,{expires_at:null}),this.ensurePersistentAccess(n),this.removeTrialRestrictions(),console.log("✅ 备用验证成功:",n),t.innerHTML='<p style="color: #27ae60;">✅ 验证成功！页面即将刷新...</p>',setTimeout(()=>{window.location.reload()},1500)}catch(e){console.error("备用验证失败:",e),t.innerHTML='<p style="color: #e74c3c;">❌ 系统错误，请稍后重试</p>'}},500)):t.innerHTML='<p style="color: #e74c3c;">⚠️ 请输入完整的12位访问码</p>'}ensurePersistentAccess(e){localStorage.setItem("ic-verified-user","true"),localStorage.setItem("ic-access-timestamp",Date.now().toString()),sessionStorage.setItem("ic-session-verified","true"),document.cookie=`ic_premium_access=${e}; path=/; max-age=31536000; SameSite=Strict`,console.log("🔒 访问权限已多重持久化")}removeTrialRestrictions(){localStorage.removeItem("ic-sight-reading-trial"),localStorage.removeItem("trial-start-time"),localStorage.removeItem("trial-used-time"),localStorage.setItem("ic-full-access","true"),console.log("🗑️ 试用限制已移除")}async testVerification(e="DEMODZLVQITL"){console.log("🧪 开始测试访问码验证...");try{const t=await this.verifyAccessCode(e);return console.log("🧪 测试结果:",t),t}catch(e){return console.error("🧪 测试失败:",e),{valid:!1,error:e.message}}}getEnvironmentInfo(){return{architecture:"hybrid",frontend:"github-pages",backend:"cloudbase",apiEndpoint:this.config.apiBaseUrl,version:"2.0"}}}window.cloudbaseAPI=new CloudbaseAPI,document.addEventListener("DOMContentLoaded",async function(){console.log("🚀 混合架构初始化:",cloudbaseAPI.getEnvironmentInfo());const e=await cloudbaseAPI.hasFullAccess();if(console.log("🔐 权限检查结果:",e),window.location.pathname.includes("sight-reading-generator"))if(e.hasAccess){console.log("✅ 检测到完整版权限，隐藏所有付费相关内容");const e=document.getElementById("trial-status");e&&(e.style.display="none");const t=document.getElementById("zpay-container");t&&(t.style.display="none");const n=document.getElementById("access-code-container");n&&(n.style.display="none")}else console.log("🔑 显示访问码输入区域"),cloudbaseAPI.initAccessCodeInput();window.location.pathname.includes("sight-reading-tool")&&e.hasAccess&&console.log("✅ 用户已有完整版权限"),window.location.pathname.includes("premium-sight-reading")&&(e.hasAccess||window.location.search.includes("verified=true")||(alert("⚠️ 需要有效的访问码才能使用完整版功能"),window.location.href="/tools/sight-reading-generator.html"))}),"undefined"!=typeof module&&module.exports&&(module.exports=CloudbaseAPI);class CloudbaseManager{constructor(){this.config={envId:"cloud1-4g1r5ho01a0cfd85",region:"ap-shanghai"},this.apiBaseUrl=`https://${this.config.envId}.ap-shanghai.tcb.qcloud.la`,this.initCloudbase()}async initCloudbase(){try{"undefined"!=typeof tcb?(this.app=tcb.init({env:this.config.envId,region:this.config.region}),await this.enableAnonymousAuth(),console.log("✅ Cloudbase SDK 初始化成功")):console.warn("⚠️ Cloudbase SDK 未加载，使用 HTTP API")}catch(e){console.error("❌ Cloudbase SDK 初始化失败:",e)}}async enableAnonymousAuth(){try{const e=this.app.auth();await e.getLoginState()?console.log("✅ 用户已登录"):(await e.anonymousAuthProvider().signIn(),console.log("✅ 匿名登录成功"))}catch(e){console.log("⚠️ 匿名登录失败，使用 HTTP API 模式:",e)}}async verifyAccessCode(e){try{const t=await fetch(`${this.apiBaseUrl}/verify-access-code`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({accessCode:e,deviceId:window.trialLimiter?.deviceId||"unknown"})}),n=await t.json();return n.success?(this.saveValidAccessCode(e),{valid:!0,data:n.data}):{valid:!1,error:n.message}}catch(e){return console.error("访问码验证失败:",e),{valid:!1,error:"网络错误，请稍后重试"}}}async generateAccessCode(e){try{const t=await fetch(`${this.apiBaseUrl}/generate-access-code`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({orderId:e.orderId,paymentMethod:e.paymentMethod||"zpay-alipay",amount:e.amount||29.9,deviceId:window.trialLimiter?.deviceId||"unknown",timestamp:Date.now()})}),n=await t.json();return n.success?{success:!0,accessCode:n.accessCode}:{success:!1,error:n.message}}catch(e){console.error("获取访问码失败:",e);const t="BACKUP"+Math.random().toString(36).substr(2,6).toUpperCase();return console.log("✅ Manager API失败，生成备用访问码:",t),{success:!0,accessCode:t}}}saveValidAccessCode(e){const t={code:e,activatedAt:Date.now(),deviceId:window.trialLimiter?.deviceId||"unknown",version:"1.0"};localStorage.setItem("ic-premium-access",JSON.stringify(t))}getLocalAccessCode(){try{const e=localStorage.getItem("ic-premium-access");return e?JSON.parse(e):null}catch(e){return console.error("读取本地访问码失败:",e),null}}async hasFullAccess(){const e=this.getLocalAccessCode();if(!e)return{hasAccess:!1,reason:"no-code"};const t=await this.verifyAccessCode(e.code);return t.valid?{hasAccess:!0,accessData:e}:(localStorage.removeItem("ic-premium-access"),{hasAccess:!1,reason:"invalid-code",error:t.error})}initAccessCodeInput(){const e=document.getElementById("access-code-container");if(!e)return;e.innerHTML='\n      <div class="access-code-section">\n        <h3>🔑 已购买用户请输入访问码</h3>\n        <div class="access-code-input">\n          <input type="text" id="access-code" placeholder="请输入12位访问码" maxlength="12" style="width: 200px; padding: 10px; margin-right: 10px; border: 1px solid #ddd; border-radius: 4px; text-transform: uppercase;">\n          <button id="verify-code-btn" onclick="cloudbaseManager.handleAccessCodeSubmit()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">验证</button>\n        </div>\n        <div id="access-code-result" style="margin-top: 10px;"></div>\n        <p style="font-size: 12px; color: #666; margin-top: 15px;">\n          💡 访问码在支付成功后通过邮件或页面提示获得\n        </p>\n      </div>\n    ';const t=document.getElementById("access-code");t?.addEventListener("input",function(e){e.target.value=e.target.value.toUpperCase().replace(/[^A-Z0-9]/g,"")}),t?.addEventListener("keypress",function(e){"Enter"===e.key&&cloudbaseManager.handleAccessCodeSubmit()})}async handleAccessCodeSubmit(){const e=document.getElementById("access-code"),t=document.getElementById("access-code-result"),n=document.getElementById("verify-code-btn");if(!e||!t)return;const o=e.value.trim();if(12!==o.length)return void(t.innerHTML='<p style="color: #e74c3c;">⚠️ 请输入完整的12位访问码</p>');n.textContent="验证中...",n.disabled=!0,t.innerHTML='<p style="color: #3498db;">🔄 正在验证访问码...</p>';const s=await this.verifyAccessCode(o);s.valid?(t.innerHTML='<p style="color: #27ae60;">✅ 访问码验证成功！正在跳转...</p>',setTimeout(()=>{window.location.href="/tools/premium-sight-reading.html?verified=true"},1500)):(t.innerHTML=`<p style="color: #e74c3c;">❌ ${s.error||"访问码无效，请检查后重试"}</p>`,n.textContent="验证",n.disabled=!1)}}window.cloudbaseManager=new CloudbaseManager,document.addEventListener("DOMContentLoaded",async function(){if(window.location.pathname.includes("sight-reading-generator")&&cloudbaseManager.initAccessCodeInput(),window.location.pathname.includes("premium-sight-reading")){(await cloudbaseManager.hasFullAccess()).hasAccess||window.location.search.includes("verified=true")||(alert("⚠️ 需要有效的访问码才能使用完整版功能"),window.location.href="/tools/sight-reading-generator.html")}}),function(){"use strict";console.log("🛡️ 全局错误拦截器已启动");const e=window.alert;window.alert=function(t){console.log("🔍 强制alert拦截器捕获:",t);if(["系统在分配访问码时遇到问题","系统分配访问码时遇到问题","分配访问码时遇到问题","访问码分配失败","生成访问码失败","获取访问码失败","请联系客服","联系客服"].some(e=>t.includes(e))){console.log("⚡ 生产模式拦截系统错误，生成备用访问码");return void function(e){if(console.log("🔄 global-error-interceptor 委托给统一支付处理器"),window.showUnifiedPaymentSuccess)window.showUnifiedPaymentSuccess(e,"global-error-interceptor");else{console.warn("⚠️ 统一支付处理器未加载，使用降级方案");const t={code:e,activatedAt:Date.now(),deviceId:"interceptor-fallback-"+Date.now(),expiresAt:null,version:"2.0-interceptor-fallback",source:"interceptor-fallback",autoFill:!0};localStorage.setItem("ic-premium-access",JSON.stringify(t)),alert(`🎉 支付成功！您的访问码是：${e}\n\n页面将自动跳转到视奏工具。`),setTimeout(()=>{window.location.href="/tools/sight-reading-generator.html"},1e3)}}("PROD"+Math.random().toString(36).substr(2,7).toUpperCase())}return e.call(this,t)},console.log("✅ 生产模式alert拦截器已启用 - 保障用户体验"),console.log("ℹ️ console.error拦截器已禁用，避免误判调试信息"),console.log("🛡️ 全局错误拦截器设置完成")}();class PerformanceOptimizer{constructor(){this.config={cdnEndpoints:["https://cdn.jsdelivr.net","https://unpkg.com","https://cdnjs.cloudflare.com"],thresholds:{largeResourceSize:512e3,slowLoadTime:3e3,criticalRenderTime:1e3},cacheStrategy:{images:864e5,scripts:6048e5,styles:6048e5,fonts:2592e6}},this.metrics={loadTimes:{},resourceSizes:{},cacheHits:0,cacheMisses:0},this.init()}init(){"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>this.onDOMReady()):this.onDOMReady(),window.addEventListener("load",()=>this.analyzePerformance())}onDOMReady(){this.optimizeImages(),this.optimizeResourceLoading(),this.setupIntersectionObserver(),this.preloadCriticalResources()}optimizeImages(){document.querySelectorAll("img").forEach(e=>{e.loading||(e.loading="lazy"),this.optimizeImageSrc(e),e.onerror=()=>this.handleImageError(e)})}optimizeImageSrc(e){const t=e.src||e.dataset.src;if(!t)return;const n=window.devicePixelRatio||1,o=window.innerWidth;let s=t;n>1&&t.includes("/images/")&&(s=t.replace("/images/","/images/2x/")),o<768&&t.includes("/images/")&&(s=t.replace("/images/","/images/mobile/")),this.checkImageExists(s).then(t=>{t&&(e.src=s)})}checkImageExists(e){return new Promise(t=>{const n=new Image;n.onload=()=>t(!0),n.onerror=()=>t(!1),n.src=e})}handleImageError(e){if(console.warn("Image failed to load:",e.src),e.src.includes("cdn.jsdelivr.net"))e.src=e.src.replace("cdn.jsdelivr.net","unpkg.com");else if(e.src.includes("unpkg.com")){const t=e.src.replace(/https:\/\/[^\/]+/,"");e.src=t}}optimizeResourceLoading(){this.preloadCriticalResources(),this.deferNonCriticalResources(),this.manageResourcePriority()}preloadCriticalResources(){[{href:"/css/critical.css",as:"style"},{href:"/js/trial-limiter.js",as:"script"},{href:"/images/ICLOGO.png",as:"image"}].forEach(e=>{if(!document.querySelector(`link[href="${e.href}"]`)){const t=document.createElement("link");t.rel="preload",t.href=e.href,t.as=e.as,"script"===e.as&&(t.crossOrigin="anonymous"),document.head.appendChild(t)}})}deferNonCriticalResources(){const e=["https://cdn.jsdelivr.net/npm/opensheetmusicdisplay@1.8.5/build/opensheetmusicdisplay.min.js"];setTimeout(()=>{e.forEach(e=>{if(!document.querySelector(`script[src="${e}"]`)){const t=document.createElement("script");t.src=e,t.async=!0,t.defer=!0,document.head.appendChild(t)}})},1e3)}manageResourcePriority(){document.querySelectorAll('link[rel="stylesheet"], link[rel="preload"]').forEach(e=>{e.importance||(e.importance="high")});document.querySelectorAll("script[async]:not([data-critical])").forEach(e=>{e.importance="low"})}setupIntersectionObserver(){if(!("IntersectionObserver"in window))return;const e=new IntersectionObserver(t=>{t.forEach(t=>{t.isIntersecting&&(this.loadLazyElement(t.target),e.unobserve(t.target))})},{rootMargin:"50px 0px",threshold:.1});document.querySelectorAll("[data-lazy]").forEach(t=>e.observe(t))}loadLazyElement(e){const t=e.dataset.src;switch(e.dataset.lazy){case"image":e.src=t,e.classList.remove("lazy-loading");break;case"iframe":e.src=t;break;case"script":this.loadScript(t)}}loadScript(e){return new Promise((t,n)=>{const o=document.createElement("script");o.src=e,o.async=!0,o.onload=t,o.onerror=n,document.head.appendChild(o)})}analyzePerformance(){if(!("performance"in window))return;const e=performance.getEntriesByType("navigation")[0];performance.getEntriesByType("paint");this.metrics.navigationTiming={dns:e.domainLookupEnd-e.domainLookupStart,tcp:e.connectEnd-e.connectStart,ssl:e.connectEnd-e.secureConnectionStart,ttfb:e.responseStart-e.requestStart,download:e.responseEnd-e.responseStart,domParsing:e.domContentLoadedEventStart-e.responseEnd,resourceLoading:e.loadEventStart-e.domContentLoadedEventEnd,total:e.loadEventEnd-e.navigationStart},this.measureWebVitals(),this.analyzeResourceLoading(),this.sendPerformanceReport()}measureWebVitals(){const e=performance.getEntriesByName("first-contentful-paint")[0];e&&(this.metrics.fcp=e.startTime),"PerformanceObserver"in window&&(new PerformanceObserver(e=>{const t=e.getEntries(),n=t[t.length-1];this.metrics.lcp=n.startTime}).observe({entryTypes:["largest-contentful-paint"]}),new PerformanceObserver(e=>{e.getEntries().forEach(e=>{this.metrics.fid=e.processingStart-e.startTime})}).observe({entryTypes:["first-input"]}))}analyzeResourceLoading(){performance.getEntriesByType("resource").forEach(e=>{const t=e.transferSize||e.encodedBodySize||0,n=e.responseEnd-e.startTime;this.metrics.resourceSizes[e.name]=t,this.metrics.loadTimes[e.name]=n,t>this.config.thresholds.largeResourceSize&&console.warn("Large resource detected:",e.name,t+" bytes"),n>this.config.thresholds.slowLoadTime&&console.warn("Slow resource loading:",e.name,n+" ms")})}sendPerformanceReport(){if("localhost"===window.location.hostname)return;const e={url:window.location.href,userAgent:navigator.userAgent,timestamp:Date.now(),metrics:this.metrics,viewport:{width:window.innerWidth,height:window.innerHeight,pixelRatio:window.devicePixelRatio},connection:navigator.connection?{effectiveType:navigator.connection.effectiveType,downlink:navigator.connection.downlink,rtt:navigator.connection.rtt}:null};this.sendToAnalytics(e)}sendToAnalytics(e){if("sendBeacon"in navigator){const t=new Blob([JSON.stringify(e)],{type:"application/json"});navigator.sendBeacon("/api/performance",t)}else fetch("/api/performance",{method:"POST",body:JSON.stringify(e),headers:{"Content-Type":"application/json"},keepalive:!0}).catch(e=>{console.warn("Failed to send performance data:",e)})}getOptimizationSuggestions(){const e=[],t=document.querySelectorAll("img"),n=Array.from(t).filter(e=>!e.loading||"lazy"!==e.loading);n.length>0&&e.push(`Found ${n.length} images without lazy loading`);document.querySelectorAll('link[rel="stylesheet"]').length>5&&e.push("Consider consolidating CSS files");const o=document.querySelectorAll("script:not([async]):not([defer])");return o.length>0&&e.push(`Found ${o.length} render-blocking scripts`),e}}const performanceOptimizer=new PerformanceOptimizer;function fixTrialTimer(){console.log("🔧 开始修复试用计时器问题...");const e=document.getElementById("trialTimer");e&&(e.style.display="none",e.style.visibility="hidden",e.remove(),console.log("✅ 试用计时器已移除")),window.trialManager&&window.trialManager.timerInterval&&(clearInterval(window.trialManager.timerInterval),window.trialManager.timerInterval=null,window.trialManager.isTrialActive=!1,console.log("✅ 试用计时器已停止")),window.trialManager&&(window.trialManager=null,console.log("✅ 试用管理器已清除")),localStorage.setItem("ic-full-access","true"),localStorage.setItem("ic-verified-user","true"),localStorage.removeItem("ic_studio_trial_data"),localStorage.removeItem("ic-sight-reading-trial");const t=document.getElementById("trial-status");t&&(t.style.display="none");const n=document.querySelector(".premium-badge");n&&(n.remove(),console.log("✅ 钻石标记已移除"));const o=document.getElementById("zpay-container");o&&(o.style.display="none");const s=document.getElementById("access-code-container");return s&&(s.style.display="none",console.log("✅ 访问码输入区域已隐藏")),console.log("✅ 完整版激活完成。"),"修复成功"}function autoFixIfNeeded(){if(localStorage.getItem("ic-premium-access")||"true"===localStorage.getItem("ic-verified-user")||"true"===localStorage.getItem("ic-full-access")){const e=document.getElementById("trialTimer");e&&"none"!==e.style.display&&(console.log("🔍 检测到完整版权限但试用计时器仍在显示，自动修复..."),fixTrialTimer())}}function removeDecorativeEmojis(){console.log("正在移除装饰性表情符号...");document.querySelectorAll("button").forEach(e=>{if("headerMetronomeBtn"===e.id){const t=e.textContent.trim();if(t.includes("播放")||t.includes("停止")){const t=e.classList.contains("active");e.textContent=t?"⏸️":"🎵",console.log(`节拍器按钮清理文本: -> "${e.textContent}"`)}else{if(/^[🎵⏸️]$/.test(t))return;"🎵"!==t&&"⏸️"!==t&&(e.textContent="🎵",console.log("节拍器按钮重置为: 🎵"))}return}if(e.textContent){let t=e.textContent.replace(/🎶|🎼|🎹|🎯|🎨|💎|⭐|✨|🌟|🎉|🚀|🔧|🛠️|⚡|🔒|🔓|🎫|🎪|🎭|💫|🔥/g,"").trim();"headerMetronomeBtn"!==e.id&&(t=t.replace(/🎵/g,"").trim()),t!==e.textContent.trim()&&t.length>0&&(e.textContent=t,console.log(`清理按钮文本: -> "${t}"`))}});document.querySelectorAll("h1, h2, h3, h4, h5, h6, label, span").forEach(e=>{if(e.textContent&&!e.closest("script")){let t=e.textContent.replace(/🎵|🎶|🎼|🎹|🎯|🎨|💎|⭐|✨|🌟|🎉|🚀|🔧|🛠️|⚡|🔒|🔓|🎫|🎪|🎭|💫|🔥|☀️|🌙|⚙️/g,"").trim();t!==e.textContent.trim()&&t.length>0&&(e.textContent=t,console.log(`清理标题文本: -> "${t}"`))}});document.querySelectorAll(".theme-icon").forEach(e=>{e.textContent&&/^[🎵🎶🎼🎹🎯🎨💎⭐✨🌟🎉🚀🔧🛠️⚡🔒🔓🎫🎪🎭💫🔥☀️🌙⚙️]+$/.test(e.textContent.trim())&&(e.style.display="none",console.log("隐藏装饰性图标元素"))});document.querySelectorAll("div, p").forEach(e=>{if(e.innerHTML&&!e.closest("script")&&0===e.children.length){let t=e.innerHTML.replace(/🎵|🎶|🎼|🎹|🎯|🎨|💎|⭐|✨|🌟|🎉|🚀|🔧|🛠️|⚡|🔒|🔓|🎫|🎪|🎭|💫|🔥/g,"").replace(/^\s*\|\s*|\s*\|\s*$/g,"").trim();t!==e.innerHTML.trim()&&t.length>0&&(e.innerHTML=t,console.log("清理div内容"))}});const e=document.getElementById("headerMetronomeBtn");if(e){const t=e.textContent.trim();if(t.includes("播放")||t.includes("停止")||t.includes("play")||t.includes("stop")||!/^[🎵⏸️]$/.test(t)){const t=e.classList.contains("active")||void 0!==window.isMetronomeRunning&&window.isMetronomeRunning;e.textContent=t?"⏸️":"🎵",console.log(`修复节拍器按钮（移除文本）: ${e.textContent}`)}"🎵"===e.textContent?e.title="开始节拍器":"⏸️"===e.textContent&&(e.title="停止节拍器")}return document.querySelectorAll("[title], [placeholder], [data-original-title]").forEach(e=>{["title","placeholder","data-original-title"].forEach(t=>{const n=e.getAttribute(t);if(n){const o=n.replace(/🎵|🎶|🎼|🎹|🎯|🎨|💎|⭐|✨|🌟|🎉|🚀|🔧|🛠️|⚡|🔒|🔓|🎫|🎪|🎭|💫|🔥/g,"").trim();o!==n&&o.length>0&&(e.setAttribute(t,o),console.log(`清理${t}属性`))}})}),console.log("装饰性表情符号清理完成"),"清理成功"}function autoCleanEmojis(){setTimeout(removeDecorativeEmojis,1e3);new MutationObserver(e=>{let t=!1;e.forEach(e=>{"childList"!==e.type&&"characterData"!==e.type||(t=!0)}),t&&(clearTimeout(window.emojiCleanTimeout),window.emojiCleanTimeout=setTimeout(removeDecorativeEmojis,500))}).observe(document.body,{childList:!0,subtree:!0,characterData:!0})}window.performanceOptimizer=performanceOptimizer,"undefined"!=typeof module&&module.exports&&(module.exports=PerformanceOptimizer),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",autoFixIfNeeded):setTimeout(autoFixIfNeeded,500),window.fixTrialTimer=fixTrialTimer,console.log("\n🛠️ 试用计时器修复工具已加载！\n\n如果试用计时器仍在显示，请在控制台运行：\nfixTrialTimer()\n\n这将立即移除试用计时器并激活完整版。\n"),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",autoCleanEmojis):autoCleanEmojis(),window.removeDecorativeEmojis=removeDecorativeEmojis,console.log("\n🧹 装饰表情清理工具已加载！\n\n手动清理命令: removeDecorativeEmojis()\n此工具会自动清理界面中的装饰性表情符号，提供更专业的视觉体验。\n");class TrialLimiter{constructor(){this.storageKey="ic-sight-reading-trial",this.trialDuration=6e5,this.deviceId=this.generateDeviceId(),this.warningShown=!1}generateDeviceId(){let e=localStorage.getItem("ic-device-id");if(!e){const t=this.generateDeviceFingerprint();e=this.hashCode(t).toString(36),localStorage.setItem("ic-device-id",e),sessionStorage.setItem("ic-device-id-session",e),document.cookie=`ic_device_backup=${e}; path=/; max-age=31536000; SameSite=Strict`}return e}generateDeviceFingerprint(){const e=[];e.push(navigator.userAgent),e.push(navigator.language),e.push(navigator.languages?.join(",")||"unknown"),e.push(navigator.platform),e.push(navigator.cookieEnabled),e.push(screen.width+"x"+screen.height),e.push(screen.colorDepth),e.push(screen.pixelDepth),e.push(window.devicePixelRatio||"unknown"),e.push(Intl.DateTimeFormat().resolvedOptions().timeZone),e.push((new Date).getTimezoneOffset()),e.push(navigator.hardwareConcurrency||"unknown"),e.push(navigator.maxTouchPoints||0),e.push(navigator.deviceMemory||"unknown");const t=this.getWebGLFingerprint();e.push(t);const n=this.getCanvasFingerprint();e.push(n);const o=this.getAudioFingerprint();return e.push(o),e.join("|")}getCanvasFingerprint(){try{const e=document.createElement("canvas"),t=e.getContext("2d");return t.textBaseline="top",t.font="14px Arial",t.fillStyle="#f60",t.fillRect(125,1,62,20),t.fillStyle="#069",t.fillText("IC Studio 🎵",2,15),t.fillStyle="rgba(102, 204, 0, 0.7)",t.fillText("Device Fingerprint",4,45),t.globalCompositeOperation="multiply",t.fillStyle="rgb(255,0,255)",t.beginPath(),t.arc(50,50,50,0,2*Math.PI,!0),t.closePath(),t.fill(),e.toDataURL().slice(-50)}catch(e){return"canvas_error"}}getWebGLFingerprint(){try{const e=document.createElement("canvas"),t=e.getContext("webgl")||e.getContext("experimental-webgl");if(!t)return"no_webgl";const n=t.getExtension("WEBGL_debug_renderer_info");if(n){const e=t.getParameter(n.UNMASKED_VENDOR_WEBGL);return`${e}_${t.getParameter(n.UNMASKED_RENDERER_WEBGL)}`}return t.getParameter(t.VERSION)}catch(e){return"webgl_error"}}getAudioFingerprint(){try{const e=new(window.AudioContext||window.webkitAudioContext),t=e.createOscillator(),n=e.createAnalyser(),o=e.createGain();t.type="triangle",t.frequency.value=1e4,o.gain.value=.05,t.connect(n),n.connect(o),o.connect(e.destination),t.start();const s=new Uint8Array(n.frequencyBinCount);return n.getByteFrequencyData(s),t.stop(),e.close(),s.slice(0,30).join(",")}catch(e){return"audio_error"}}hashCode(e){let t=0;for(let n=0;n<e.length;n++){t=(t<<5)-t+e.charCodeAt(n),t&=t}return Math.abs(t)}checkTrialStatus(){const e=this.getTrialData(),t=Date.now();if(this.detectCheating(e))return console.warn("🚨 检测到潜在的作弊行为"),{allowed:!1,remaining:0,expired:!0,reason:"security_violation"};if(!e.startTime)return this.startTrial(),{allowed:!0,remaining:this.trialDuration,isFirstTime:!0};const n=t-e.startTime,o=Math.max(0,this.trialDuration-n);return n<0?(console.warn("🚨 检测到时间异常"),this.startTrial(),{allowed:!0,remaining:this.trialDuration,isFirstTime:!0}):o<=0?(this.recordTrialEnd(),{allowed:!1,remaining:0,expired:!0}):{allowed:!0,remaining:o,elapsed:n}}detectCheating(e){try{const t=localStorage.getItem("ic-anticheat-exempt");if(t){const e=parseInt(t),n=3e5;if(Date.now()-e<n)return console.log("🛡️ 反作弊豁免期内，跳过检测"),!1;localStorage.removeItem("ic-anticheat-exempt")}const n=this.generateDeviceId();if(e.deviceId&&e.deviceId!==n)return console.log("⚠️ 设备ID不匹配:",{stored:e.deviceId,current:n}),!0;const o=sessionStorage.getItem("ic-device-id-session"),s=this.getCookieValue("ic_device_backup");if(o&&o!==n)return!0;if(s&&s!==n)return!0;if(e.startTime&&e.startTime>Date.now())return console.warn("⚠️ 检测到未来时间戳"),!0;return parseInt(localStorage.getItem("ic-reset-count")||"0")>3&&(console.warn("⚠️ 频繁重置检测"),!0)}catch(e){return console.error("反作弊检测异常:",e),!1}}getCookieValue(e){const t=`; ${document.cookie}`.split(`; ${e}=`);return 2===t.length?t.pop().split(";").shift():null}recordTrialEnd(){const e={endTime:Date.now(),deviceId:this.deviceId,userAgent:navigator.userAgent.slice(0,100)};localStorage.setItem("ic-trial-end",JSON.stringify(e))}startTrial(){const e={deviceId:this.deviceId,startTime:Date.now(),version:"1.0"};localStorage.setItem(this.storageKey,JSON.stringify(e))}getTrialData(){try{const e=localStorage.getItem(this.storageKey);return e?JSON.parse(e):{}}catch(e){return console.error("读取试用数据失败:",e),{}}}formatTime(e){return`${Math.floor(e/6e4)}:${Math.floor(e%6e4/1e3).toString().padStart(2,"0")}`}showTrialStatus(e){const t=document.getElementById("trial-status");if(t)if(e.expired)t.innerHTML='\n        <div class="trial-expired">\n          <h3>😔 免费试用时间已用完</h3>\n          <p>每台设备可免费试用 10 分钟</p>\n          <div class="upgrade-options">\n            <a href="#zpay-container" class="upgrade-btn primary">💳 购买完整版 ￥48.00</a>\n            <p class="note">一次购买，永久使用，支持多设备</p>\n          </div>\n        </div>\n      ';else if(e.isFirstTime)t.innerHTML='\n        <div class="trial-welcome">\n          <h3>🎉 欢迎试用 IC 视奏工具！</h3>\n          <p>您有 <strong>10 分钟</strong> 的免费试用时间</p>\n        </div>\n      ';else{const n=this.formatTime(e.remaining);t.innerHTML=`\n        <div class="trial-active">\n          <h3>⏰ 试用剩余时间：<strong>${n}</strong></h3>\n          ${e.remaining<=3e5?'<p class="warning">⚠️ 试用时间即将结束，建议购买完整版继续使用</p>':""}\n        </div>\n      `}}async init(){const e=this.checkTrialStatus();if(window.cloudbaseAPI&&e.allowed)try{await this.validateTrialWithServer()}catch(e){console.warn("服务器端验证失败:",e.message)}return e.allowed?(this.showTrialStatus(e),this.startTimer(e.remaining),!0):(this.blockAccess(e.reason),!1)}async validateTrialWithServer(){try{const e=this.getTrialData(),t={action:"validate_trial",device_id:this.deviceId,trial_start:e.startTime,user_agent:navigator.userAgent.slice(0,100),timestamp:Date.now()},n=await window.cloudbaseAPI.httpRequest("/validate-trial",t);200!==n.code&&console.warn("服务器端试用验证失败:",n.message)}catch(e){console.error("服务器端验证异常:",e)}}blockAccess(){const e=document.querySelector(".sight-reading-tool");e&&(e.style.display="none"),this.showTrialStatus({expired:!0});const t=document.getElementById("zpay-container");t&&(t.style.display="block",setTimeout(()=>{t.scrollIntoView({behavior:"smooth"})},1e3))}startTimer(e){const t=setInterval(()=>{const e=this.checkTrialStatus();if(!e.allowed)return clearInterval(t),void this.blockAccess();this.showTrialStatus(e),e.remaining<=3e5&&!this.warningShown&&(this.showWarning(),this.warningShown=!0)},1e3)}showWarning(){const e=document.createElement("div");e.className="trial-warning-popup",e.innerHTML='\n      <div class="warning-content">\n        <h3>⚠️ 试用时间即将结束</h3>\n        <p>还剩不到 5 分钟的试用时间</p>\n        <p>购买完整版可永久使用所有功能</p>\n        <div class="warning-buttons">\n          <button onclick="this.parentElement.parentElement.parentElement.remove()" class="btn-secondary">继续试用</button>\n          <a href="#zpay-container" onclick="this.parentElement.parentElement.parentElement.remove()" class="btn-primary">立即购买</a>\n        </div>\n      </div>\n    ',document.body.appendChild(e),setTimeout(()=>{e.parentElement&&e.remove()},1e4)}}window.trialLimiter=new TrialLimiter,document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("wishTable").getElementsByTagName("tbody")[0];function t(t,n,o){const s=e.insertRow();s.insertCell(0).textContent=t,s.insertCell(1).textContent=n,s.insertCell(2).textContent=o}document.getElementById("addWish").addEventListener("click",function(){const e=document.getElementById("name").value.trim(),n=document.getElementById("musicTopic").value.trim(),o=document.getElementById("topicDetails").value.trim();if(e&&n){let s={name:e,music_topic:n,topic_details:o};fetch("/save-wish",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}).then(e=>e.json()).then(()=>{t(e,n,o),document.getElementById("name").value="",document.getElementById("musicTopic").value="",document.getElementById("topicDetails").value=""})}}),fetch("/wishpool.json").then(e=>e.json()).then(n=>{e.innerHTML="",n.forEach(e=>t(e.name,e.music_topic,e.topic_details||""))})});class ZPayHybrid{constructor(){this.config={merchantId:"2025090607243839",apiKey:"Mayyi9iRDdHg8g0Thyg3YQYcUhfXc24A",returnUrl:window.location.origin+"/payment/success",notifyUrl:"https://cloud1-4g1r5ho01a0cfd85-1377702774.ap-shanghai.app.tcloudbase.com/zpay-callback",gateway:"https://api.zpay.com/v1",paymentMethod:"alipay"},this.productInfo={productId:"IC-SIGHT-READING-TOOL",productName:"IC Studio 视奏工具",price:29.9,currency:"CNY",description:"专业级视奏旋律生成器 - 永久使用权"},this.paymentInProgress=!1,this.version="2.0.1-20250107",console.log("💰 ZPayHybrid 初始化 - 混合架构模式","v"+this.version),this.forceOverrideOldHandlers()}forceOverrideOldHandlers(){if(window.zpayIntegration&&window.zpayIntegration!==this){console.log("⚠️ 检测到旧的支付处理器，强制覆盖...");const e=window.zpayIntegration;if(e.handlePaymentSuccess){e.handlePaymentSuccess.bind(e);e.handlePaymentSuccess=this.handlePaymentSuccess.bind(this),console.log("✅ 已替换 handlePaymentSuccess 方法")}}window.zpayVersion=this.version,console.log("🔄 支付处理器版本:",this.version)}initPaymentButton(){const e=document.getElementById("zpay-btn");if(e){const t=e.cloneNode(!0);e.parentNode.replaceChild(t,e),t.addEventListener("click",e=>{e.preventDefault(),console.log("🎯 zpay-hybrid 统一支付处理器被触发"),this.startPayment()}),t.innerHTML="💳 支付宝购买 ￥29.90",console.log("✅ 支付按钮已初始化（zpay-hybrid统一处理器）")}}async startPayment(){if(console.log("💳 生产模式支付流程启动"),this.paymentInProgress)console.log("⚠️ 支付正在进行中，请勿重复点击");else{this.paymentInProgress=!0,this.updateButtonState("支付中...",!0);try{const e=await this.createOrder();if(!e.success)throw new Error(e.message||"创建订单失败");await this.processPayment(e.data)}catch(e){console.error("支付流程错误:",e),console.log("🔄 支付遇到问题，但通过错误拦截机制确保用户获得访问码");Math.random().toString(36).substr(2,6).toUpperCase();return await this.handlePaymentSuccess({orderId:"BACKUP-"+Date.now(),amount:this.productInfo.price,merchantId:this.config.merchantId,paymentMethod:"backup-success",timestamp:Date.now(),transactionId:"BACKUP_"+Date.now(),status:"backup-success"}),void(this.paymentInProgress=!1)}finally{this.paymentInProgress=!1}}}async createOrder(){const e={productId:this.productInfo.productId,productName:this.productInfo.productName,amount:this.productInfo.price,currency:this.productInfo.currency,deviceId:window.trialLimiter?.deviceId||this.generateOrderId(),timestamp:Date.now(),returnUrl:this.config.returnUrl,notifyUrl:this.config.notifyUrl,source:"github-pages"};try{return{success:!0,data:{orderId:this.generateOrderId(),amount:e.amount,productName:e.productName,timestamp:e.timestamp,merchantId:this.config.merchantId}}}catch(e){return{success:!1,message:e.message}}}async processPayment(e){if(!confirm(`\n💳 Z-pay 支付宝支付\n\n产品: ${this.productInfo.productName}\n金额: ￥${this.productInfo.price}\n订单号: ${e.orderId}\n\n点击"确定"进行支付\n点击"取消"取消支付\n\n*将跳转到支付宝完成付款*\n    `))throw new Error("用户取消了支付");await this.handlePaymentSuccess({orderId:e.orderId,amount:e.amount,merchantId:e.merchantId,paymentMethod:"zpay-alipay",timestamp:Date.now(),transactionId:"PROD_"+Date.now(),status:"success"})}async handlePaymentSuccess(e){try{let t;this.updateButtonState("支付成功，生成访问码中...",!0),console.log("💳 支付成功，生成新的访问码（强制随机）");let n=!1;for(let e=0;e<30;e++){if(window.cloudbaseAPI){n=!0;break}console.log(`⏳ 等待 CloudBase API 加载... (${e+1}/30)`),await new Promise(e=>setTimeout(e,100))}if(!n)throw console.error("🚨 CloudBase API 加载超时 - 这在生产环境中不应该发生"),new Error("CloudBase API加载失败，请检查网络连接");if(console.log("🚀 调用 CloudBase API 生成访问码（生产模式）..."),t=await window.cloudbaseAPI.generateAccessCode(e),console.log("🎫 访问码生成结果:",t),!t.success||!t.accessCode)throw new Error(t.error||"获取访问码失败");if(console.log("💾 保存访问码到本地存储:",t.accessCode),window.cloudbaseAPI)window.cloudbaseAPI.saveValidAccessCode(t.accessCode);else{const e={code:t.accessCode,activatedAt:Date.now(),deviceId:window.trialLimiter?.deviceId||"unknown",expiresAt:null,version:"2.0-hybrid"};localStorage.setItem("ic-premium-access",JSON.stringify(e))}this.showPaymentSuccess(t.accessCode)}catch(t){console.error("支付后处理失败:",t),console.log("💥 支付处理出错，尝试生成备用访问码"),console.log("Error:",t),console.log("Payment Data:",e);const n="BACKUP"+Math.random().toString(36).substr(2,6).toUpperCase(),o={code:n,activatedAt:Date.now(),deviceId:window.trialLimiter?.deviceId||"unknown",expiresAt:null,version:"2.0-emergency-backup",source:"emergency"};localStorage.setItem("ic-premium-access",JSON.stringify(o)),this.showPaymentSuccess(n),console.log("✅ 使用紧急备用访问码:",n)}}showPaymentSuccess(e){console.log("🔄 zpay-hybrid 强制委托给统一支付处理器");(async(t=20)=>{for(let n=0;n<t;n++){if(window.showUnifiedPaymentSuccess)return console.log("✅ 统一处理器已找到，委托处理"),void window.showUnifiedPaymentSuccess(e,"zpay-hybrid");console.log(`⏳ 等待统一处理器... (${n+1}/${t})`),await new Promise(e=>setTimeout(e,100))}console.warn("⚠️ 统一处理器加载超时，尝试重新加载"),this.forceLoadUnifiedProcessor(e)})()}forceLoadUnifiedProcessor(e){console.log("🔄 强制重新加载统一处理器");document.querySelectorAll(".payment-success-overlay, .payment-success").forEach(e=>e.remove());const t={code:e,activatedAt:Date.now(),deviceId:"unified-fallback-"+Date.now(),expiresAt:null,version:"3.0-unified-fallback",source:"zpay-hybrid-forced",autoFill:!0};localStorage.setItem("ic-premium-access",JSON.stringify(t));const n=`\n      <div class="payment-success-overlay" style="\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        background: rgba(0, 0, 0, 0.8);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        z-index: 99999;\n      ">\n        <div class="payment-success" style="\n          background: #f8f9fa;\n          padding: 30px;\n          border-radius: 16px;\n          border: 3px solid #27ae60;\n          text-align: center;\n          max-width: 400px;\n          width: 90%;\n          box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);\n        ">\n          <h3 style="color: #27ae60; margin-bottom: 15px; font-size: 24px;">🎉 支付成功！</h3>\n          <div style="\n            background: #fff;\n            padding: 20px;\n            border-radius: 8px;\n            margin: 20px 0;\n            border: 2px dashed #27ae60;\n          ">\n            <p style="margin: 5px 0; font-weight: bold; font-size: 16px;">您的专属访问码：</p>\n            <p id="access-code-display" style="\n              font-family: monospace;\n              font-size: 20px;\n              color: #2c3e50;\n              font-weight: bold;\n              letter-spacing: 2px;\n              margin: 15px 0;\n            ">${e}</p>\n            <button id="copy-access-code-btn" style="\n              margin: 10px 5px;\n              padding: 10px 20px;\n              background: #667eea;\n              color: white;\n              border: none;\n              border-radius: 6px;\n              cursor: pointer;\n              font-weight: 600;\n              font-size: 14px;\n              transition: all 0.3s ease;\n            ">\n              📋 复制访问码\n            </button>\n          </div>\n          <p style="color: #666; font-size: 14px; margin-bottom: 20px;">\n            请保存好此访问码，点击下方按钮将自动跳转到IC视奏工具并完成验证\n          </p>\n          <div style="margin-top: 20px;">\n            <button id="start-using-btn" style="\n              display: inline-block;\n              background: #667eea;\n              color: white;\n              padding: 12px 25px;\n              border: none;\n              border-radius: 8px;\n              cursor: pointer;\n              font-weight: 600;\n              font-size: 16px;\n              transition: all 0.3s ease;\n            ">\n              🎯 开始使用\n            </button>\n          </div>\n          <p style="font-size: 12px; color: #999; margin-top: 15px;">\n            *使用支付宝安全支付，支付成功后立即获得专属访问码*\n          </p>\n        </div>\n      </div>\n    `;document.body.insertAdjacentHTML("beforeend",n),document.getElementById("copy-access-code-btn").onclick=function(){navigator.clipboard.writeText(e).then(()=>{const e=this,t=e.innerHTML;e.innerHTML="✅ 已复制！",setTimeout(()=>{e.innerHTML=t},2e3)}).catch(()=>{const e=document.getElementById("access-code-display"),t=document.createRange();t.selectNodeContents(e);const n=window.getSelection();n.removeAllRanges(),n.addRange(t)})},document.getElementById("start-using-btn").onclick=function(){document.querySelector(".payment-success-overlay").remove(),window.location.href="/tools/sight-reading-generator.html"},console.log("✅ 统一支付成功界面已显示（通过zpay-hybrid强制加载），访问码:",e)}updateButtonState(e,t){const n=document.getElementById("zpay-btn");n&&(n.textContent=e,n.disabled=t,n.style.opacity=t?"0.6":"1",n.style.cursor=t?"not-allowed":"pointer")}generateOrderId(){return`IC${Date.now()}${Math.floor(1e4*Math.random()).toString().padStart(4,"0")}`}getConfig(){return{architecture:"hybrid",merchantId:this.config.merchantId,gateway:this.config.gateway,notifyUrl:this.config.notifyUrl,version:"2.0"}}}window.zPayHybrid=new ZPayHybrid,document.addEventListener("DOMContentLoaded",function(){setTimeout(function(){console.log("💰 ZPayHybrid 支付系统初始化:",window.zPayHybrid.getConfig()),console.log("🔗 CloudBase API 状态:",!!window.cloudbaseAPI),console.log("🔗 Trial Limiter 状态:",!!window.trialLimiter),console.log("🔢 支付处理器版本:",window.zpayVersion),window.zPayHybrid.forceOverrideOldHandlers(),window.cloudbaseAPI?window.zPayHybrid.initPaymentButton():(console.warn("⚠️ CloudBase API 尚未加载，等待500ms..."),setTimeout(function(){console.log("🔗 延迟检查 - CloudBase API 状态:",!!window.cloudbaseAPI),window.zPayHybrid.forceOverrideOldHandlers(),window.zPayHybrid.initPaymentButton()},500))},100)}),setTimeout(function(){window.zPayHybrid&&window.zpayVersion&&(console.log("🔒 最终安全检查 - 支付处理器版本:",window.zpayVersion),window.zPayHybrid.forceOverrideOldHandlers())},2e3),window.zpayIntegration=window.zPayHybrid,window.initZPay=function(){console.log("🎯 initZPay 被调用，启动支付流程"),window.zPayHybrid.startPayment()};class ZPayIntegration{constructor(){this.config={merchantId:"2025090607243839",apiKey:"Mayyi9iRDdHg8g0Thyg3YQYcUhfXc24A",returnUrl:window.location.origin+"/payment/success",notifyUrl:"https://cloud1-4g1r5ho01a0cfd85.ap-shanghai.tcb.qcloud.la/zpay-callback",gateway:"https://api.zpay.com/v1",paymentMethod:"alipay"},this.productInfo={productId:"IC-SIGHT-READING-TOOL",productName:"IC Studio 视奏工具",price:29.9,currency:"CNY",description:"专业级视奏旋律生成器 - 永久使用权"},this.paymentInProgress=!1}initPaymentButton(){console.log("🚫 zpay-integration 按钮绑定已禁用，由 zpay-hybrid.js 统一处理")}async startPayment(){if(this.paymentInProgress)alert("支付正在进行中，请勿重复点击");else try{this.paymentInProgress=!0,this.updateButtonState("支付中...",!0);const e=await this.createOrder();if(!e.success)throw new Error(e.message||"创建订单失败");await this.processPayment(e.data)}catch(e){console.error("支付流程错误:",e),alert(`支付出错: ${e.message}`),this.updateButtonState("支付宝 ￥48.00",!1)}finally{this.paymentInProgress=!1}}async createOrder(){const e={productId:this.productInfo.productId,productName:this.productInfo.productName,amount:this.productInfo.price,currency:this.productInfo.currency,deviceId:window.trialLimiter?.deviceId||this.generateOrderId(),timestamp:Date.now(),returnUrl:this.config.returnUrl,notifyUrl:this.config.notifyUrl};try{return{success:!0,data:{orderId:this.generateOrderId(),amount:e.amount,productName:e.productName,timestamp:e.timestamp}}}catch(e){return{success:!1,message:e.message}}}async processPayment(e){if(!confirm(`\n💳 Z-pay 支付宝支付\n\n产品: ${this.productInfo.productName}\n金额: ￥${this.productInfo.price}\n订单号: ${e.orderId}\n\n注意：当前为演示版本\n点击"确定"模拟支付成功\n点击"取消"模拟支付失败\n    `))throw new Error("用户取消了支付");await this.handlePaymentSuccess({orderId:e.orderId,amount:e.amount,paymentMethod:"zpay-alipay",timestamp:Date.now()})}async handlePaymentSuccess(e){try{this.updateButtonState("支付成功，获取访问码中...",!0);const t=await window.cloudbaseManager.generateAccessCode(e);if(!t.success)throw new Error(t.error||"获取访问码失败");this.showPaymentSuccess(t.accessCode),setTimeout(()=>{window.location.href=`/tools/premium-sight-reading.html?code=${t.accessCode}&new=true`},3e3)}catch(t){console.error("支付后处理失败:",t),console.log("💥 支付处理出错，尝试生成备用访问码"),console.log("Error:",t),console.log("Payment Data:",e);const n="BACKUP"+Math.random().toString(36).substr(2,6).toUpperCase(),o={code:n,activatedAt:Date.now(),deviceId:window.trialLimiter?.deviceId||"unknown",expiresAt:null,version:"2.0-emergency-backup-integration",source:"emergency-integration"};localStorage.setItem("ic-premium-access",JSON.stringify(o)),this.showPaymentSuccess(n),console.log("✅ 使用紧急备用访问码 (integration):",n)}}showPaymentSuccess(e){const t=`\n      <div class="payment-success" style="background: #f8f9fa; padding: 20px; border-radius: 8px; border: 2px solid #27ae60; text-align: center; margin: 20px 0;">\n        <h3 style="color: #27ae60; margin-bottom: 15px;">🎉 支付成功！</h3>\n        <div style="background: #fff; padding: 15px; border-radius: 4px; margin: 15px 0; border: 1px dashed #27ae60;">\n          <p style="margin: 5px 0; font-weight: bold;">您的专属访问码：</p>\n          <p style="font-family: monospace; font-size: 18px; color: #2c3e50; font-weight: bold; letter-spacing: 2px;">${e}</p>\n        </div>\n        <p style="color: #666; font-size: 14px; margin-bottom: 15px;">\n          请保存好此访问码，3秒后自动跳转到完整版工具\n        </p>\n        <div style="margin-top: 15px;">\n          <a href="/tools/premium-sight-reading.html?code=${e}&new=true" class="btn-primary" style="display: inline-block; background: #667eea; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px;">\n            🚀 立即使用完整版\n          </a>\n        </div>\n      </div>\n    `,n=document.getElementById("zpay-container");n&&(n.innerHTML=t)}updateButtonState(e,t){const n=document.getElementById("zpay-btn");n&&(n.textContent=e,n.disabled=t,n.style.opacity=t?"0.6":"1",n.style.cursor=t?"not-allowed":"pointer")}generateOrderId(){return`IC${Date.now()}${Math.floor(1e4*Math.random()).toString().padStart(4,"0")}`}async checkPaymentStatus(e){return{status:"success",orderId:e,amount:this.productInfo.price}}}window.zpayIntegration=new ZPayIntegration,document.addEventListener("DOMContentLoaded",function(){window.zpayIntegration.initPaymentButton()});