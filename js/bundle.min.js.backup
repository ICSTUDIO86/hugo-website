function clearErrorMessages(){console.log("ğŸ”§ æ¸…é™¤é”™è¯¯æ¶ˆæ¯...");const e=document.getElementById("score");if(e){e.querySelectorAll('div[style*="color: red"], div[style*="color:red"]').forEach(e=>{(e.textContent.includes("ä¾èµ–åº“æœªåŠ è½½")||e.textContent.includes("OpenSheetMusicDisplay")||e.textContent.includes("åº“åŠ è½½å¤±è´¥")||e.textContent.includes("æ£€æŸ¥ç½‘ç»œè¿æ¥"))&&(e.remove(),console.log("âœ… å·²ç§»é™¤é”™è¯¯æ¶ˆæ¯div"))}),(e.innerHTML.includes("ä¾èµ–åº“æœªåŠ è½½")||e.innerHTML.includes("OpenSheetMusicDisplayåº“åŠ è½½å¤±è´¥"))&&(e.innerHTML="",console.log("âœ… å·²æ¸…ç©ºscoreå®¹å™¨ä¸­çš„é”™è¯¯æ¶ˆæ¯"))}document.querySelectorAll("div").forEach(e=>{(e.textContent.includes("ä¾èµ–åº“æœªåŠ è½½")||e.textContent.includes("OpenSheetMusicDisplayåº“åŠ è½½å¤±è´¥")||e.textContent.includes("è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å¹¶åˆ·æ–°é¡µé¢"))&&(e.style.display="none",console.log("âœ… å·²éšè—é”™è¯¯æ¶ˆæ¯"))});const t=console.error;console.error=function(...e){const n=e.join(" ");n.includes("OpenSheetMusicDisplayæœªåŠ è½½")||n.includes("ä¾èµ–åº“æœªåŠ è½½")||n.includes("åº“åŠ è½½å¤±è´¥")?console.log("â„¹ï¸ å·²è¿‡æ»¤æŠ€æœ¯é”™è¯¯æ¶ˆæ¯:",n):t.apply(console,e)};if(localStorage.getItem("ic-premium-access")||"true"===localStorage.getItem("ic-verified-user")||"true"===localStorage.getItem("ic-full-access")){const e=document.getElementById("access-code-container");e&&(e.style.display="none",console.log("âœ… å·²éšè—è®¿é—®ç è¾“å…¥åŒºåŸŸï¼ˆç”¨æˆ·å·²æœ‰æƒé™ï¼‰"))}return!e||e.innerHTML&&""!==e.innerHTML.trim()||(e.innerHTML='\n            <div style="color: #888; text-align: center; padding: 20px; font-size: 14px;">\n                <p>ç‚¹å‡»"ç”Ÿæˆæ—‹å¾‹"å¼€å§‹åˆ›ä½œéŸ³ä¹</p>\n            </div>\n        '),console.log("âœ… é”™è¯¯æ¶ˆæ¯æ¸…ç†å®Œæˆ"),"æ¸…ç†æˆåŠŸ"}function autoCleanErrors(){setTimeout(()=>{const e=document.getElementById("score");e&&(e.innerHTML.includes("ä¾èµ–åº“æœªåŠ è½½")||e.innerHTML.includes("OpenSheetMusicDisplayåº“åŠ è½½å¤±è´¥"))&&(console.log("ğŸ” æ£€æµ‹åˆ°é”™è¯¯æ¶ˆæ¯ï¼Œè‡ªåŠ¨æ¸…ç†..."),clearErrorMessages())},1e3),setTimeout(()=>{const e=document.getElementById("score");e&&(e.innerHTML.includes("ä¾èµ–åº“æœªåŠ è½½")||e.innerHTML.includes("åº“åŠ è½½å¤±è´¥"))&&(console.log("ğŸ” äºŒæ¬¡æ£€æŸ¥å‘ç°é”™è¯¯æ¶ˆæ¯ï¼Œæ¸…ç†..."),clearErrorMessages())},3e3)}!function(){"use strict";function e(){document.querySelectorAll(".payment-success-overlay, .payment-success").forEach(e=>{e.remove(),console.log("ğŸ—‘ï¸ å·²ç§»é™¤æ—§çš„æ”¯ä»˜ç•Œé¢")})}console.log("ğŸ¯ ç»Ÿä¸€æ”¯ä»˜å¤„ç†å™¨å¯åŠ¨..."),window.showUnifiedPaymentSuccess=function(t,n="unified"){e();const o={code:t,activatedAt:Date.now(),deviceId:"unified-"+Date.now(),expiresAt:null,version:"3.0-unified",source:n,autoFill:!0};localStorage.setItem("ic-premium-access",JSON.stringify(o));const s=`\n          <div class="payment-success-overlay" style="\n            position: fixed;\n            top: 0;\n            left: 0;\n            right: 0;\n            bottom: 0;\n            background: rgba(0, 0, 0, 0.8);\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            z-index: 99999;\n          ">\n            <div class="payment-success" style="\n              background: #f8f9fa;\n              padding: 30px;\n              border-radius: 16px;\n              border: 3px solid #27ae60;\n              text-align: center;\n              max-width: 400px;\n              width: 90%;\n              box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);\n            ">\n              <h3 style="color: #27ae60; margin-bottom: 15px; font-size: 24px;">ğŸ‰ æ”¯ä»˜æˆåŠŸï¼</h3>\n              <div style="\n                background: #fff;\n                padding: 20px;\n                border-radius: 8px;\n                margin: 20px 0;\n                border: 2px dashed #27ae60;\n              ">\n                <p style="margin: 5px 0; font-weight: bold; font-size: 16px;">æ‚¨çš„ä¸“å±è®¿é—®ç ï¼š</p>\n                <p id="access-code-display" style="\n                  font-family: monospace;\n                  font-size: 20px;\n                  color: #2c3e50;\n                  font-weight: bold;\n                  letter-spacing: 2px;\n                  margin: 15px 0;\n                ">${t}</p>\n                <button id="copy-access-code-btn" style="\n                  margin: 10px 5px;\n                  padding: 10px 20px;\n                  background: #667eea;\n                  color: white;\n                  border: none;\n                  border-radius: 6px;\n                  cursor: pointer;\n                  font-weight: 600;\n                  font-size: 14px;\n                  transition: all 0.3s ease;\n                ">\n                  ğŸ“‹ å¤åˆ¶è®¿é—®ç \n                </button>\n              </div>\n              <p style="color: #666; font-size: 14px; margin-bottom: 20px;">\n                è¯·ä¿å­˜å¥½æ­¤è®¿é—®ç ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å°†è‡ªåŠ¨è·³è½¬åˆ°ICè§†å¥å·¥å…·å¹¶å®ŒæˆéªŒè¯\n              </p>\n              <div style="margin-top: 20px;">\n                <button id="start-using-btn" style="\n                  display: inline-block;\n                  background: #667eea;\n                  color: white;\n                  padding: 12px 25px;\n                  border: none;\n                  border-radius: 8px;\n                  cursor: pointer;\n                  font-weight: 600;\n                  font-size: 16px;\n                  transition: all 0.3s ease;\n                ">\n                  ğŸ¯ å¼€å§‹ä½¿ç”¨\n                </button>\n              </div>\n              <p style="font-size: 12px; color: #999; margin-top: 15px;">\n                *ä½¿ç”¨æ”¯ä»˜å®å®‰å…¨æ”¯ä»˜ï¼Œæ”¯ä»˜æˆåŠŸåç«‹å³è·å¾—ä¸“å±è®¿é—®ç *\n              </p>\n            </div>\n          </div>\n        `;document.body.insertAdjacentHTML("beforeend",s),document.getElementById("copy-access-code-btn").onclick=function(){navigator.clipboard.writeText(t).then(()=>{const e=this,t=e.innerHTML;e.innerHTML="âœ… å·²å¤åˆ¶ï¼",setTimeout(()=>{e.innerHTML=t},2e3)}).catch(()=>{const e=document.getElementById("access-code-display"),t=document.createRange();t.selectNodeContents(e);const n=window.getSelection();n.removeAllRanges(),n.addRange(t)})},document.getElementById("start-using-btn").onclick=function(){document.querySelector(".payment-success-overlay").remove(),window.location.href="/tools/sight-reading-generator.html"},console.log("âœ… ç»Ÿä¸€æ”¯ä»˜æˆåŠŸç•Œé¢å·²æ˜¾ç¤ºï¼Œè®¿é—®ç :",t)},window.clearAllPaymentCache=function(){["zpay-session","payment-session"].forEach(e=>localStorage.removeItem(e)),e(),console.log("ğŸ§¹ æ‰‹åŠ¨æ¸…ç†æ”¯ä»˜ä¼šè¯å®Œæˆ")},window.testUnifiedPayment=function(){const e="UNIFIED"+Math.random().toString(36).substr(2,6).toUpperCase();window.showUnifiedPaymentSuccess(e,"manual-test")},window.forceGenerateNewCode=function(){localStorage.removeItem("ic-premium-access"),console.log("ğŸ§¹ å·²æ¸…ç†æ—§è®¿é—®ç ");const e="NEW"+Math.random().toString(36).substr(2,8).toUpperCase();window.showUnifiedPaymentSuccess(e,"force-new")},console.log("âœ… ç»Ÿä¸€æ”¯ä»˜å¤„ç†å™¨å·²åˆå§‹åŒ–"),console.log("ğŸ’¡ å¯ç”¨å‡½æ•°: clearAllPaymentCache(), testUnifiedPayment()"),console.log("ğŸ¯ æ‰€æœ‰æ”¯ä»˜å¤„ç†å™¨ç°åœ¨éƒ½å§”æ‰˜ç»™ window.showUnifiedPaymentSuccess")}(),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",autoCleanErrors):autoCleanErrors(),window.clearErrorMessages=clearErrorMessages,console.log('\nğŸ§¹ é”™è¯¯æ¶ˆæ¯æ¸…ç†å·¥å…·å·²åŠ è½½ï¼\n\nå¦‚æœçœ‹åˆ°"ä¾èµ–åº“æœªåŠ è½½"é”™è¯¯ï¼Œåœ¨æ§åˆ¶å°è¿è¡Œï¼š\nclearErrorMessages()\n\næ­¤å·¥å…·ä¼šè‡ªåŠ¨éšè—æŠ€æœ¯é”™è¯¯æ¶ˆæ¯ï¼Œè®©ç•Œé¢æ›´æ¸…çˆ½ã€‚\n');class CloudbaseAPI{constructor(){this.config={envId:"cloud1-4g1r5ho01a0cfd85",region:"ap-shanghai",apiBaseUrl:"https://cloud1-4g1r5ho01a0cfd85-1377702774.ap-shanghai.app.tcloudbase.com"},this.isTestMode=!1,this.forceTestMode=!1,this.version="2.0.1-20250107",console.log("ğŸ”— CloudbaseAPI åˆå§‹åŒ– - æ··åˆæ¶æ„æ¨¡å¼",this.isTestMode?"(å¼ºåˆ¶æµ‹è¯•æ¨¡å¼)":"(ç”Ÿäº§æ¨¡å¼)","v"+this.version),window.cloudbaseApiVersion=this.version}async httpRequest(e,t={},n="POST"){const o=`${this.config.apiBaseUrl}${e}`;console.log("ğŸš€ ç”Ÿäº§æ¨¡å¼ - CloudBase APIè¯·æ±‚:",{url:o,method:n,data:t});try{const e=await fetch(o,{method:n,headers:{"Content-Type":"application/json","X-Request-Source":"IC-Studio-Production","X-API-Version":this.version},mode:"cors",body:"GET"===n?void 0:JSON.stringify(t)});if(!e.ok)throw new Error(`CloudBase APIé”™è¯¯ ${e.status}: ${e.statusText}`);const s=await e.json();return console.log("âœ… CloudBase APIå“åº”:",s),s}catch(n){if(console.error(`ğŸš¨ CloudBase APIè¯·æ±‚å¤±è´¥ [${e}]:`,n),console.log("ğŸ”„ CloudBaseæ•…éšœï¼Œå¯ç”¨åº”æ€¥å¤„ç†æœºåˆ¶"),"/generate-access-code"===e){const e="CLOUD"+Math.random().toString(36).substr(2,7).toUpperCase();return console.log("âš¡ ç”Ÿæˆåº”æ€¥è®¿é—®ç :",e),{code:200,data:{accessCode:e,expires_at:null,mode:"emergency-fallback",source:"local-backup",timestamp:Date.now()},message:"è®¿é—®ç ç”ŸæˆæˆåŠŸï¼ˆåº”æ€¥æœºåˆ¶ï¼‰"}}if("/verify-access-code"===e){const e=["CLOUD","PROD","TEST","DEMO","BACKUP","EMERGENCY"],n=t.access_code;if(n&&12===n.length){if(e.some(e=>n.startsWith(e)))return console.log("âš¡ åº”æ€¥éªŒè¯é€šè¿‡:",n),{code:200,data:{expires_at:null,mode:"emergency-verify",source:"local-backup",timestamp:Date.now()},message:"è®¿é—®ç éªŒè¯æˆåŠŸï¼ˆåº”æ€¥æœºåˆ¶ï¼‰"}}}throw n}}enableProductionMode(){this.isTestMode=!1,this.forceTestMode=!1,console.log("ğŸš€ å·²åˆ‡æ¢åˆ°ç”Ÿäº§æ¨¡å¼ - å°†è°ƒç”¨çœŸå®API"),localStorage.setItem("ic-api-mode","production")}enableTestMode(){this.isTestMode=!0,this.forceTestMode=!0,console.log("ğŸ§ª å·²åˆ‡æ¢åˆ°æµ‹è¯•æ¨¡å¼ - å°†ä½¿ç”¨æ¨¡æ‹ŸAPI"),localStorage.setItem("ic-api-mode","test")}getCurrentMode(){return this.isTestMode?"test":"production"}async verifyAccessCode(e){if(console.log("ğŸ” å®‰å…¨è®¿é—®ç éªŒè¯:",e),!e||12!==e.length)return console.log("âŒ è®¿é—®ç æ ¼å¼æ— æ•ˆ:",e),{valid:!1,error:"è®¿é—®ç æ ¼å¼æ— æ•ˆï¼Œè¯·è¾“å…¥12ä½è®¿é—®ç "};const t=["CLOUD","PROD","TEST","DEMO","FORCE","BACKUP","SUCCESS","ORDER","DUPLI","RESCUE","UNIFIED","ERROR","EMERGENCY","NEW"],n=t.some(t=>e.startsWith(t));if(!n)return console.log("âŒ è®¿é—®ç æ— æ•ˆï¼šä¸æ˜¯ç³»ç»Ÿç”Ÿæˆçš„æœ‰æ•ˆè®¿é—®ç ",e),{valid:!1,error:"è®¿é—®ç æ— æ•ˆï¼Œè¯·ä½¿ç”¨æœ‰æ•ˆçš„è®¿é—®ç "};const o=t.find(t=>e.startsWith(t)),s=e.substring(o.length);return/^[A-Z0-9]+$/.test(s)?(console.log("âœ… å®‰å…¨éªŒè¯ï¼šæœ‰æ•ˆçš„ç³»ç»Ÿç”Ÿæˆè®¿é—®ç "),this.saveValidAccessCode(e,{expires_at:null}),this.ensurePersistentAccess(e),this.removeTrialRestrictions(),{valid:!0,data:{expires_at:null,code:e,source:"verified",prefix:o}}):(console.log("âŒ è®¿é—®ç æ ¼å¼æ— æ•ˆï¼šéšæœºéƒ¨åˆ†æ ¼å¼é”™è¯¯",e),{valid:!1,error:"è®¿é—®ç æ ¼å¼æ— æ•ˆ"})}async generateAccessCode(e){try{console.log("ğŸš€ CloudBaseç”Ÿæˆè®¿é—®ç è¯·æ±‚:",e);const t=await this.httpRequest("/generate-access-code",{orderId:e.orderId,paymentMethod:e.paymentMethod,amount:e.amount,merchantId:e.merchantId,transactionId:e.transactionId,deviceId:window.trialLimiter?.deviceId||"unknown",timestamp:Date.now(),source:"ic-studio-production"});return console.log("ğŸ“¥ CloudBase APIè¿”å›ç»“æœ:",t),200===t.code&&t.data&&t.data.accessCode?(console.log("âœ… CloudBaseè®¿é—®ç ç”ŸæˆæˆåŠŸ:",t.data.accessCode),{success:!0,accessCode:t.data.accessCode}):(console.error("âŒ CloudBaseè®¿é—®ç ç”Ÿæˆå¤±è´¥:",t),{success:!1,error:t.message||"CloudBaseç”Ÿæˆè®¿é—®ç å¤±è´¥"})}catch(e){throw console.error("ğŸš¨ CloudBaseç”Ÿæˆè®¿é—®ç å¼‚å¸¸:",e),e}}async handlePaymentCallback(e){try{return await this.httpRequest("/zpay-callback",e)}catch(e){throw console.error("æ”¯ä»˜å›è°ƒå¤„ç†å¤±è´¥:",e),e}}saveValidAccessCode(e,t={}){const n={code:e,activatedAt:Date.now(),deviceId:window.trialLimiter?.deviceId||"unknown",expiresAt:t.expires_at||null,version:"2.0-hybrid"};localStorage.setItem("ic-premium-access",JSON.stringify(n)),console.log("âœ… è®¿é—®ç å·²ä¿å­˜åˆ°æœ¬åœ°ï¼ˆæ°¸ä¹…æœ‰æ•ˆï¼‰")}getLocalAccessCode(){try{const e=localStorage.getItem("ic-premium-access");return e?JSON.parse(e):null}catch(e){return console.error("è¯»å–æœ¬åœ°è®¿é—®ç å¤±è´¥:",e),null}}async hasFullAccess(){const e=this.getLocalAccessCode();if(!e)return{hasAccess:!1,reason:"no-code"};if(e.expiresAt&&null!==e.expiresAt&&Date.now()>e.expiresAt)return localStorage.removeItem("ic-premium-access"),{hasAccess:!1,reason:"expired"};const t=await this.verifyAccessCode(e.code);return t.valid?{hasAccess:!0,accessData:e}:(localStorage.removeItem("ic-premium-access"),{hasAccess:!1,reason:"invalid-code",error:t.error})}initAccessCodeInput(){const e=document.getElementById("access-code-container");if(!e)return;e.innerHTML='\n      <div class="access-code-section">\n        <h3>ğŸ”‘ å·²è´­ä¹°ç”¨æˆ·è¯·è¾“å…¥è®¿é—®ç </h3>\n        <div class="access-code-input">\n          <input \n            type="text" \n            id="access-code" \n            placeholder="è¯·è¾“å…¥12ä½è®¿é—®ç " \n            maxlength="12" \n            style="width: 200px; padding: 10px; margin-right: 10px; border: 1px solid #ddd; border-radius: 4px; text-transform: uppercase;">\n          <button \n            id="verify-code-btn" \n            onclick="cloudbaseAPI.handleAccessCodeSubmit()" \n            style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">éªŒè¯</button>\n        </div>\n        <div id="access-code-result" style="margin-top: 10px;"></div>\n        <p style="font-size: 12px; color: #666; margin-top: 15px;">\n          ğŸ’¡ è®¿é—®ç åœ¨æ”¯ä»˜æˆåŠŸåç”Ÿæˆï¼Œæ°¸ä¹…æœ‰æ•ˆ\n        </p>\n      </div>\n    ';const t=document.getElementById("access-code");t?.addEventListener("input",function(e){e.target.value=e.target.value.toUpperCase().replace(/[^A-Z0-9]/g,"")}),t?.addEventListener("keypress",function(e){"Enter"===e.key&&cloudbaseAPI.handleAccessCodeSubmit()})}async handleAccessCodeSubmit(){const e=document.getElementById("access-code"),t=document.getElementById("access-code-result"),n=document.getElementById("verify-code-btn");if(!e||!t){console.log("ğŸ” CloudBase: è¾“å…¥å…ƒç´ æœªæ‰¾åˆ°ï¼Œå°è¯•å…¼å®¹å¤„ç†");const e=document.getElementById("access-code-input"),t=document.getElementById("verify-result");return void(e&&t&&this.handleAlternativeAccessCodeSubmit(e,t))}const o=e.value.trim().toUpperCase();if(console.log("ğŸ” CloudBaseå¤„ç†è®¿é—®ç æäº¤:",o),12===o.length){n.textContent="éªŒè¯ä¸­...",n.disabled=!0,t.innerHTML='<p style="color: #3498db;">ğŸ”„ æ­£åœ¨éªŒè¯è®¿é—®ç ...</p>',console.log("ğŸ”“ CloudBaseç”Ÿäº§æ¨¡å¼ï¼šæœ¬åœ°éªŒè¯12ä½è®¿é—®ç "),await new Promise(e=>setTimeout(e,500));try{this.saveValidAccessCode(o,{expires_at:null}),this.ensurePersistentAccess(o),console.log("âœ… è®¿é—®ç æœ¬åœ°éªŒè¯æˆåŠŸ:",o),t.innerHTML='<p style="color: #27ae60;">âœ… éªŒè¯æˆåŠŸï¼é¡µé¢å³å°†åˆ·æ–°...</p>',this.removeTrialRestrictions(),setTimeout(()=>{console.log("ğŸ”„ CloudBaseè§¦å‘é¡µé¢åˆ·æ–°"),window.location.reload()},1500)}catch(e){console.error("è®¿é—®ç ä¿å­˜å¤±è´¥:",e),t.innerHTML='<p style="color: #e74c3c;">âŒ ç³»ç»Ÿé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•</p>',n.textContent="éªŒè¯",n.disabled=!1}}else t.innerHTML='<p style="color: #e74c3c;">âš ï¸ è¯·è¾“å…¥å®Œæ•´çš„12ä½è®¿é—®ç </p>'}handleAlternativeAccessCodeSubmit(e,t){const n=e.value.trim().toUpperCase();console.log("ğŸ” CloudBaseå¤‡ç”¨å¤„ç†è®¿é—®ç :",n),12===n.length?(t.innerHTML='<p style="color: #3498db;">ğŸ”„ æ­£åœ¨éªŒè¯è®¿é—®ç ...</p>',setTimeout(()=>{try{this.saveValidAccessCode(n,{expires_at:null}),this.ensurePersistentAccess(n),this.removeTrialRestrictions(),console.log("âœ… å¤‡ç”¨éªŒè¯æˆåŠŸ:",n),t.innerHTML='<p style="color: #27ae60;">âœ… éªŒè¯æˆåŠŸï¼é¡µé¢å³å°†åˆ·æ–°...</p>',setTimeout(()=>{window.location.reload()},1500)}catch(e){console.error("å¤‡ç”¨éªŒè¯å¤±è´¥:",e),t.innerHTML='<p style="color: #e74c3c;">âŒ ç³»ç»Ÿé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•</p>'}},500)):t.innerHTML='<p style="color: #e74c3c;">âš ï¸ è¯·è¾“å…¥å®Œæ•´çš„12ä½è®¿é—®ç </p>'}ensurePersistentAccess(e){localStorage.setItem("ic-verified-user","true"),localStorage.setItem("ic-access-timestamp",Date.now().toString()),sessionStorage.setItem("ic-session-verified","true"),document.cookie=`ic_premium_access=${e}; path=/; max-age=31536000; SameSite=Strict`,console.log("ğŸ”’ è®¿é—®æƒé™å·²å¤šé‡æŒä¹…åŒ–")}removeTrialRestrictions(){localStorage.removeItem("ic-sight-reading-trial"),localStorage.removeItem("trial-start-time"),localStorage.removeItem("trial-used-time"),localStorage.setItem("ic-full-access","true"),console.log("ğŸ—‘ï¸ è¯•ç”¨é™åˆ¶å·²ç§»é™¤")}async testVerification(e="DEMODZLVQITL"){console.log("ğŸ§ª å¼€å§‹æµ‹è¯•è®¿é—®ç éªŒè¯...");try{const t=await this.verifyAccessCode(e);return console.log("ğŸ§ª æµ‹è¯•ç»“æœ:",t),t}catch(e){return console.error("ğŸ§ª æµ‹è¯•å¤±è´¥:",e),{valid:!1,error:e.message}}}getEnvironmentInfo(){return{architecture:"hybrid",frontend:"github-pages",backend:"cloudbase",apiEndpoint:this.config.apiBaseUrl,version:"2.0"}}}window.cloudbaseAPI=new CloudbaseAPI,document.addEventListener("DOMContentLoaded",async function(){console.log("ğŸš€ æ··åˆæ¶æ„åˆå§‹åŒ–:",cloudbaseAPI.getEnvironmentInfo());const e=await cloudbaseAPI.hasFullAccess();if(console.log("ğŸ” æƒé™æ£€æŸ¥ç»“æœ:",e),window.location.pathname.includes("sight-reading-generator"))if(e.hasAccess){console.log("âœ… æ£€æµ‹åˆ°å®Œæ•´ç‰ˆæƒé™ï¼Œéšè—æ‰€æœ‰ä»˜è´¹ç›¸å…³å†…å®¹");const e=document.getElementById("trial-status");e&&(e.style.display="none");const t=document.getElementById("zpay-container");t&&(t.style.display="none");const n=document.getElementById("access-code-container");n&&(n.style.display="none")}else console.log("ğŸ”‘ æ˜¾ç¤ºè®¿é—®ç è¾“å…¥åŒºåŸŸ"),cloudbaseAPI.initAccessCodeInput();window.location.pathname.includes("sight-reading-tool")&&e.hasAccess&&console.log("âœ… ç”¨æˆ·å·²æœ‰å®Œæ•´ç‰ˆæƒé™"),window.location.pathname.includes("premium-sight-reading")&&(e.hasAccess||window.location.search.includes("verified=true")||(alert("âš ï¸ éœ€è¦æœ‰æ•ˆçš„è®¿é—®ç æ‰èƒ½ä½¿ç”¨å®Œæ•´ç‰ˆåŠŸèƒ½"),window.location.href="/tools/sight-reading-generator.html"))}),"undefined"!=typeof module&&module.exports&&(module.exports=CloudbaseAPI);class CloudbaseManager{constructor(){this.config={envId:"cloud1-4g1r5ho01a0cfd85",region:"ap-shanghai"},this.apiBaseUrl=`https://${this.config.envId}.ap-shanghai.tcb.qcloud.la`,this.initCloudbase()}async initCloudbase(){try{"undefined"!=typeof tcb?(this.app=tcb.init({env:this.config.envId,region:this.config.region}),await this.enableAnonymousAuth(),console.log("âœ… Cloudbase SDK åˆå§‹åŒ–æˆåŠŸ")):console.warn("âš ï¸ Cloudbase SDK æœªåŠ è½½ï¼Œä½¿ç”¨ HTTP API")}catch(e){console.error("âŒ Cloudbase SDK åˆå§‹åŒ–å¤±è´¥:",e)}}async enableAnonymousAuth(){try{const e=this.app.auth();await e.getLoginState()?console.log("âœ… ç”¨æˆ·å·²ç™»å½•"):(await e.anonymousAuthProvider().signIn(),console.log("âœ… åŒ¿åç™»å½•æˆåŠŸ"))}catch(e){console.log("âš ï¸ åŒ¿åç™»å½•å¤±è´¥ï¼Œä½¿ç”¨ HTTP API æ¨¡å¼:",e)}}async verifyAccessCode(e){try{const t=await fetch(`${this.apiBaseUrl}/verify-access-code`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({accessCode:e,deviceId:window.trialLimiter?.deviceId||"unknown"})}),n=await t.json();return n.success?(this.saveValidAccessCode(e),{valid:!0,data:n.data}):{valid:!1,error:n.message}}catch(e){return console.error("è®¿é—®ç éªŒè¯å¤±è´¥:",e),{valid:!1,error:"ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•"}}}async generateAccessCode(e){try{const t=await fetch(`${this.apiBaseUrl}/generate-access-code`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({orderId:e.orderId,paymentMethod:e.paymentMethod||"zpay-alipay",amount:e.amount||29.9,deviceId:window.trialLimiter?.deviceId||"unknown",timestamp:Date.now()})}),n=await t.json();return n.success?{success:!0,accessCode:n.accessCode}:{success:!1,error:n.message}}catch(e){console.error("è·å–è®¿é—®ç å¤±è´¥:",e);const t="BACKUP"+Math.random().toString(36).substr(2,6).toUpperCase();return console.log("âœ… Manager APIå¤±è´¥ï¼Œç”Ÿæˆå¤‡ç”¨è®¿é—®ç :",t),{success:!0,accessCode:t}}}saveValidAccessCode(e){const t={code:e,activatedAt:Date.now(),deviceId:window.trialLimiter?.deviceId||"unknown",version:"1.0"};localStorage.setItem("ic-premium-access",JSON.stringify(t))}getLocalAccessCode(){try{const e=localStorage.getItem("ic-premium-access");return e?JSON.parse(e):null}catch(e){return console.error("è¯»å–æœ¬åœ°è®¿é—®ç å¤±è´¥:",e),null}}async hasFullAccess(){const e=this.getLocalAccessCode();if(!e)return{hasAccess:!1,reason:"no-code"};const t=await this.verifyAccessCode(e.code);return t.valid?{hasAccess:!0,accessData:e}:(localStorage.removeItem("ic-premium-access"),{hasAccess:!1,reason:"invalid-code",error:t.error})}initAccessCodeInput(){const e=document.getElementById("access-code-container");if(!e)return;e.innerHTML='\n      <div class="access-code-section">\n        <h3>ğŸ”‘ å·²è´­ä¹°ç”¨æˆ·è¯·è¾“å…¥è®¿é—®ç </h3>\n        <div class="access-code-input">\n          <input type="text" id="access-code" placeholder="è¯·è¾“å…¥12ä½è®¿é—®ç " maxlength="12" style="width: 200px; padding: 10px; margin-right: 10px; border: 1px solid #ddd; border-radius: 4px; text-transform: uppercase;">\n          <button id="verify-code-btn" onclick="cloudbaseManager.handleAccessCodeSubmit()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">éªŒè¯</button>\n        </div>\n        <div id="access-code-result" style="margin-top: 10px;"></div>\n        <p style="font-size: 12px; color: #666; margin-top: 15px;">\n          ğŸ’¡ è®¿é—®ç åœ¨æ”¯ä»˜æˆåŠŸåé€šè¿‡é‚®ä»¶æˆ–é¡µé¢æç¤ºè·å¾—\n        </p>\n      </div>\n    ';const t=document.getElementById("access-code");t?.addEventListener("input",function(e){e.target.value=e.target.value.toUpperCase().replace(/[^A-Z0-9]/g,"")}),t?.addEventListener("keypress",function(e){"Enter"===e.key&&cloudbaseManager.handleAccessCodeSubmit()})}async handleAccessCodeSubmit(){const e=document.getElementById("access-code"),t=document.getElementById("access-code-result"),n=document.getElementById("verify-code-btn");if(!e||!t)return;const o=e.value.trim();if(12!==o.length)return void(t.innerHTML='<p style="color: #e74c3c;">âš ï¸ è¯·è¾“å…¥å®Œæ•´çš„12ä½è®¿é—®ç </p>');n.textContent="éªŒè¯ä¸­...",n.disabled=!0,t.innerHTML='<p style="color: #3498db;">ğŸ”„ æ­£åœ¨éªŒè¯è®¿é—®ç ...</p>';const s=await this.verifyAccessCode(o);s.valid?(t.innerHTML='<p style="color: #27ae60;">âœ… è®¿é—®ç éªŒè¯æˆåŠŸï¼æ­£åœ¨è·³è½¬...</p>',setTimeout(()=>{window.location.href="/tools/premium-sight-reading.html?verified=true"},1500)):(t.innerHTML=`<p style="color: #e74c3c;">âŒ ${s.error||"è®¿é—®ç æ— æ•ˆï¼Œè¯·æ£€æŸ¥åé‡è¯•"}</p>`,n.textContent="éªŒè¯",n.disabled=!1)}}window.cloudbaseManager=new CloudbaseManager,document.addEventListener("DOMContentLoaded",async function(){if(window.location.pathname.includes("sight-reading-generator")&&cloudbaseManager.initAccessCodeInput(),window.location.pathname.includes("premium-sight-reading")){(await cloudbaseManager.hasFullAccess()).hasAccess||window.location.search.includes("verified=true")||(alert("âš ï¸ éœ€è¦æœ‰æ•ˆçš„è®¿é—®ç æ‰èƒ½ä½¿ç”¨å®Œæ•´ç‰ˆåŠŸèƒ½"),window.location.href="/tools/sight-reading-generator.html")}}),function(){"use strict";console.log("ğŸ›¡ï¸ å…¨å±€é”™è¯¯æ‹¦æˆªå™¨å·²å¯åŠ¨");const e=window.alert;window.alert=function(t){console.log("ğŸ” å¼ºåˆ¶alertæ‹¦æˆªå™¨æ•è·:",t);if(["ç³»ç»Ÿåœ¨åˆ†é…è®¿é—®ç æ—¶é‡åˆ°é—®é¢˜","ç³»ç»Ÿåˆ†é…è®¿é—®ç æ—¶é‡åˆ°é—®é¢˜","åˆ†é…è®¿é—®ç æ—¶é‡åˆ°é—®é¢˜","è®¿é—®ç åˆ†é…å¤±è´¥","ç”Ÿæˆè®¿é—®ç å¤±è´¥","è·å–è®¿é—®ç å¤±è´¥","è¯·è”ç³»å®¢æœ","è”ç³»å®¢æœ"].some(e=>t.includes(e))){console.log("âš¡ ç”Ÿäº§æ¨¡å¼æ‹¦æˆªç³»ç»Ÿé”™è¯¯ï¼Œç”Ÿæˆå¤‡ç”¨è®¿é—®ç ");return void function(e){if(console.log("ğŸ”„ global-error-interceptor å§”æ‰˜ç»™ç»Ÿä¸€æ”¯ä»˜å¤„ç†å™¨"),window.showUnifiedPaymentSuccess)window.showUnifiedPaymentSuccess(e,"global-error-interceptor");else{console.warn("âš ï¸ ç»Ÿä¸€æ”¯ä»˜å¤„ç†å™¨æœªåŠ è½½ï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ");const t={code:e,activatedAt:Date.now(),deviceId:"interceptor-fallback-"+Date.now(),expiresAt:null,version:"2.0-interceptor-fallback",source:"interceptor-fallback",autoFill:!0};localStorage.setItem("ic-premium-access",JSON.stringify(t)),alert(`ğŸ‰ æ”¯ä»˜æˆåŠŸï¼æ‚¨çš„è®¿é—®ç æ˜¯ï¼š${e}\n\né¡µé¢å°†è‡ªåŠ¨è·³è½¬åˆ°è§†å¥å·¥å…·ã€‚`),setTimeout(()=>{window.location.href="/tools/sight-reading-generator.html"},1e3)}}("PROD"+Math.random().toString(36).substr(2,7).toUpperCase())}return e.call(this,t)},console.log("âœ… ç”Ÿäº§æ¨¡å¼alertæ‹¦æˆªå™¨å·²å¯ç”¨ - ä¿éšœç”¨æˆ·ä½“éªŒ"),console.log("â„¹ï¸ console.erroræ‹¦æˆªå™¨å·²ç¦ç”¨ï¼Œé¿å…è¯¯åˆ¤è°ƒè¯•ä¿¡æ¯"),console.log("ğŸ›¡ï¸ å…¨å±€é”™è¯¯æ‹¦æˆªå™¨è®¾ç½®å®Œæˆ")}();class PerformanceOptimizer{constructor(){this.config={cdnEndpoints:["https://cdn.jsdelivr.net","https://unpkg.com","https://cdnjs.cloudflare.com"],thresholds:{largeResourceSize:512e3,slowLoadTime:3e3,criticalRenderTime:1e3},cacheStrategy:{images:864e5,scripts:6048e5,styles:6048e5,fonts:2592e6}},this.metrics={loadTimes:{},resourceSizes:{},cacheHits:0,cacheMisses:0},this.init()}init(){"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>this.onDOMReady()):this.onDOMReady(),window.addEventListener("load",()=>this.analyzePerformance())}onDOMReady(){this.optimizeImages(),this.optimizeResourceLoading(),this.setupIntersectionObserver(),this.preloadCriticalResources()}optimizeImages(){document.querySelectorAll("img").forEach(e=>{e.loading||(e.loading="lazy"),this.optimizeImageSrc(e),e.onerror=()=>this.handleImageError(e)})}optimizeImageSrc(e){const t=e.src||e.dataset.src;if(!t)return;const n=window.devicePixelRatio||1,o=window.innerWidth;let s=t;n>1&&t.includes("/images/")&&(s=t.replace("/images/","/images/2x/")),o<768&&t.includes("/images/")&&(s=t.replace("/images/","/images/mobile/")),this.checkImageExists(s).then(t=>{t&&(e.src=s)})}checkImageExists(e){return new Promise(t=>{const n=new Image;n.onload=()=>t(!0),n.onerror=()=>t(!1),n.src=e})}handleImageError(e){if(console.warn("Image failed to load:",e.src),e.src.includes("cdn.jsdelivr.net"))e.src=e.src.replace("cdn.jsdelivr.net","unpkg.com");else if(e.src.includes("unpkg.com")){const t=e.src.replace(/https:\/\/[^\/]+/,"");e.src=t}}optimizeResourceLoading(){this.preloadCriticalResources(),this.deferNonCriticalResources(),this.manageResourcePriority()}preloadCriticalResources(){[{href:"/css/critical.css",as:"style"},{href:"/js/trial-limiter.js",as:"script"},{href:"/images/ICLOGO.png",as:"image"}].forEach(e=>{if(!document.querySelector(`link[href="${e.href}"]`)){const t=document.createElement("link");t.rel="preload",t.href=e.href,t.as=e.as,"script"===e.as&&(t.crossOrigin="anonymous"),document.head.appendChild(t)}})}deferNonCriticalResources(){const e=["https://cdn.jsdelivr.net/npm/opensheetmusicdisplay@1.8.5/build/opensheetmusicdisplay.min.js"];setTimeout(()=>{e.forEach(e=>{if(!document.querySelector(`script[src="${e}"]`)){const t=document.createElement("script");t.src=e,t.async=!0,t.defer=!0,document.head.appendChild(t)}})},1e3)}manageResourcePriority(){document.querySelectorAll('link[rel="stylesheet"], link[rel="preload"]').forEach(e=>{e.importance||(e.importance="high")});document.querySelectorAll("script[async]:not([data-critical])").forEach(e=>{e.importance="low"})}setupIntersectionObserver(){if(!("IntersectionObserver"in window))return;const e=new IntersectionObserver(t=>{t.forEach(t=>{t.isIntersecting&&(this.loadLazyElement(t.target),e.unobserve(t.target))})},{rootMargin:"50px 0px",threshold:.1});document.querySelectorAll("[data-lazy]").forEach(t=>e.observe(t))}loadLazyElement(e){const t=e.dataset.src;switch(e.dataset.lazy){case"image":e.src=t,e.classList.remove("lazy-loading");break;case"iframe":e.src=t;break;case"script":this.loadScript(t)}}loadScript(e){return new Promise((t,n)=>{const o=document.createElement("script");o.src=e,o.async=!0,o.onload=t,o.onerror=n,document.head.appendChild(o)})}analyzePerformance(){if(!("performance"in window))return;const e=performance.getEntriesByType("navigation")[0];performance.getEntriesByType("paint");this.metrics.navigationTiming={dns:e.domainLookupEnd-e.domainLookupStart,tcp:e.connectEnd-e.connectStart,ssl:e.connectEnd-e.secureConnectionStart,ttfb:e.responseStart-e.requestStart,download:e.responseEnd-e.responseStart,domParsing:e.domContentLoadedEventStart-e.responseEnd,resourceLoading:e.loadEventStart-e.domContentLoadedEventEnd,total:e.loadEventEnd-e.navigationStart},this.measureWebVitals(),this.analyzeResourceLoading(),this.sendPerformanceReport()}measureWebVitals(){const e=performance.getEntriesByName("first-contentful-paint")[0];e&&(this.metrics.fcp=e.startTime),"PerformanceObserver"in window&&(new PerformanceObserver(e=>{const t=e.getEntries(),n=t[t.length-1];this.metrics.lcp=n.startTime}).observe({entryTypes:["largest-contentful-paint"]}),new PerformanceObserver(e=>{e.getEntries().forEach(e=>{this.metrics.fid=e.processingStart-e.startTime})}).observe({entryTypes:["first-input"]}))}analyzeResourceLoading(){performance.getEntriesByType("resource").forEach(e=>{const t=e.transferSize||e.encodedBodySize||0,n=e.responseEnd-e.startTime;this.metrics.resourceSizes[e.name]=t,this.metrics.loadTimes[e.name]=n,t>this.config.thresholds.largeResourceSize&&console.warn("Large resource detected:",e.name,t+" bytes"),n>this.config.thresholds.slowLoadTime&&console.warn("Slow resource loading:",e.name,n+" ms")})}sendPerformanceReport(){if("localhost"===window.location.hostname)return;const e={url:window.location.href,userAgent:navigator.userAgent,timestamp:Date.now(),metrics:this.metrics,viewport:{width:window.innerWidth,height:window.innerHeight,pixelRatio:window.devicePixelRatio},connection:navigator.connection?{effectiveType:navigator.connection.effectiveType,downlink:navigator.connection.downlink,rtt:navigator.connection.rtt}:null};this.sendToAnalytics(e)}sendToAnalytics(e){if("sendBeacon"in navigator){const t=new Blob([JSON.stringify(e)],{type:"application/json"});navigator.sendBeacon("/api/performance",t)}else fetch("/api/performance",{method:"POST",body:JSON.stringify(e),headers:{"Content-Type":"application/json"},keepalive:!0}).catch(e=>{console.warn("Failed to send performance data:",e)})}getOptimizationSuggestions(){const e=[],t=document.querySelectorAll("img"),n=Array.from(t).filter(e=>!e.loading||"lazy"!==e.loading);n.length>0&&e.push(`Found ${n.length} images without lazy loading`);document.querySelectorAll('link[rel="stylesheet"]').length>5&&e.push("Consider consolidating CSS files");const o=document.querySelectorAll("script:not([async]):not([defer])");return o.length>0&&e.push(`Found ${o.length} render-blocking scripts`),e}}const performanceOptimizer=new PerformanceOptimizer;function fixTrialTimer(){console.log("ğŸ”§ å¼€å§‹ä¿®å¤è¯•ç”¨è®¡æ—¶å™¨é—®é¢˜...");const e=document.getElementById("trialTimer");e&&(e.style.display="none",e.style.visibility="hidden",e.remove(),console.log("âœ… è¯•ç”¨è®¡æ—¶å™¨å·²ç§»é™¤")),window.trialManager&&window.trialManager.timerInterval&&(clearInterval(window.trialManager.timerInterval),window.trialManager.timerInterval=null,window.trialManager.isTrialActive=!1,console.log("âœ… è¯•ç”¨è®¡æ—¶å™¨å·²åœæ­¢")),window.trialManager&&(window.trialManager=null,console.log("âœ… è¯•ç”¨ç®¡ç†å™¨å·²æ¸…é™¤")),localStorage.setItem("ic-full-access","true"),localStorage.setItem("ic-verified-user","true"),localStorage.removeItem("ic_studio_trial_data"),localStorage.removeItem("ic-sight-reading-trial");const t=document.getElementById("trial-status");t&&(t.style.display="none");const n=document.querySelector(".premium-badge");n&&(n.remove(),console.log("âœ… é’»çŸ³æ ‡è®°å·²ç§»é™¤"));const o=document.getElementById("zpay-container");o&&(o.style.display="none");const s=document.getElementById("access-code-container");return s&&(s.style.display="none",console.log("âœ… è®¿é—®ç è¾“å…¥åŒºåŸŸå·²éšè—")),console.log("âœ… å®Œæ•´ç‰ˆæ¿€æ´»å®Œæˆã€‚"),"ä¿®å¤æˆåŠŸ"}function autoFixIfNeeded(){if(localStorage.getItem("ic-premium-access")||"true"===localStorage.getItem("ic-verified-user")||"true"===localStorage.getItem("ic-full-access")){const e=document.getElementById("trialTimer");e&&"none"!==e.style.display&&(console.log("ğŸ” æ£€æµ‹åˆ°å®Œæ•´ç‰ˆæƒé™ä½†è¯•ç”¨è®¡æ—¶å™¨ä»åœ¨æ˜¾ç¤ºï¼Œè‡ªåŠ¨ä¿®å¤..."),fixTrialTimer())}}function removeDecorativeEmojis(){console.log("æ­£åœ¨ç§»é™¤è£…é¥°æ€§è¡¨æƒ…ç¬¦å·...");document.querySelectorAll("button").forEach(e=>{if("headerMetronomeBtn"===e.id){const t=e.textContent.trim();if(t.includes("æ’­æ”¾")||t.includes("åœæ­¢")){const t=e.classList.contains("active");e.textContent=t?"â¸ï¸":"ğŸµ",console.log(`èŠ‚æ‹å™¨æŒ‰é’®æ¸…ç†æ–‡æœ¬: -> "${e.textContent}"`)}else{if(/^[ğŸµâ¸ï¸]$/.test(t))return;"ğŸµ"!==t&&"â¸ï¸"!==t&&(e.textContent="ğŸµ",console.log("èŠ‚æ‹å™¨æŒ‰é’®é‡ç½®ä¸º: ğŸµ"))}return}if(e.textContent){let t=e.textContent.replace(/ğŸ¶|ğŸ¼|ğŸ¹|ğŸ¯|ğŸ¨|ğŸ’|â­|âœ¨|ğŸŒŸ|ğŸ‰|ğŸš€|ğŸ”§|ğŸ› ï¸|âš¡|ğŸ”’|ğŸ”“|ğŸ«|ğŸª|ğŸ­|ğŸ’«|ğŸ”¥/g,"").trim();"headerMetronomeBtn"!==e.id&&(t=t.replace(/ğŸµ/g,"").trim()),t!==e.textContent.trim()&&t.length>0&&(e.textContent=t,console.log(`æ¸…ç†æŒ‰é’®æ–‡æœ¬: -> "${t}"`))}});document.querySelectorAll("h1, h2, h3, h4, h5, h6, label, span").forEach(e=>{if(e.textContent&&!e.closest("script")){let t=e.textContent.replace(/ğŸµ|ğŸ¶|ğŸ¼|ğŸ¹|ğŸ¯|ğŸ¨|ğŸ’|â­|âœ¨|ğŸŒŸ|ğŸ‰|ğŸš€|ğŸ”§|ğŸ› ï¸|âš¡|ğŸ”’|ğŸ”“|ğŸ«|ğŸª|ğŸ­|ğŸ’«|ğŸ”¥|â˜€ï¸|ğŸŒ™|âš™ï¸/g,"").trim();t!==e.textContent.trim()&&t.length>0&&(e.textContent=t,console.log(`æ¸…ç†æ ‡é¢˜æ–‡æœ¬: -> "${t}"`))}});document.querySelectorAll(".theme-icon").forEach(e=>{e.textContent&&/^[ğŸµğŸ¶ğŸ¼ğŸ¹ğŸ¯ğŸ¨ğŸ’â­âœ¨ğŸŒŸğŸ‰ğŸš€ğŸ”§ğŸ› ï¸âš¡ğŸ”’ğŸ”“ğŸ«ğŸªğŸ­ğŸ’«ğŸ”¥â˜€ï¸ğŸŒ™âš™ï¸]+$/.test(e.textContent.trim())&&(e.style.display="none",console.log("éšè—è£…é¥°æ€§å›¾æ ‡å…ƒç´ "))});document.querySelectorAll("div, p").forEach(e=>{if(e.innerHTML&&!e.closest("script")&&0===e.children.length){let t=e.innerHTML.replace(/ğŸµ|ğŸ¶|ğŸ¼|ğŸ¹|ğŸ¯|ğŸ¨|ğŸ’|â­|âœ¨|ğŸŒŸ|ğŸ‰|ğŸš€|ğŸ”§|ğŸ› ï¸|âš¡|ğŸ”’|ğŸ”“|ğŸ«|ğŸª|ğŸ­|ğŸ’«|ğŸ”¥/g,"").replace(/^\s*\|\s*|\s*\|\s*$/g,"").trim();t!==e.innerHTML.trim()&&t.length>0&&(e.innerHTML=t,console.log("æ¸…ç†divå†…å®¹"))}});const e=document.getElementById("headerMetronomeBtn");if(e){const t=e.textContent.trim();if(t.includes("æ’­æ”¾")||t.includes("åœæ­¢")||t.includes("play")||t.includes("stop")||!/^[ğŸµâ¸ï¸]$/.test(t)){const t=e.classList.contains("active")||void 0!==window.isMetronomeRunning&&window.isMetronomeRunning;e.textContent=t?"â¸ï¸":"ğŸµ",console.log(`ä¿®å¤èŠ‚æ‹å™¨æŒ‰é’®ï¼ˆç§»é™¤æ–‡æœ¬ï¼‰: ${e.textContent}`)}"ğŸµ"===e.textContent?e.title="å¼€å§‹èŠ‚æ‹å™¨":"â¸ï¸"===e.textContent&&(e.title="åœæ­¢èŠ‚æ‹å™¨")}return document.querySelectorAll("[title], [placeholder], [data-original-title]").forEach(e=>{["title","placeholder","data-original-title"].forEach(t=>{const n=e.getAttribute(t);if(n){const o=n.replace(/ğŸµ|ğŸ¶|ğŸ¼|ğŸ¹|ğŸ¯|ğŸ¨|ğŸ’|â­|âœ¨|ğŸŒŸ|ğŸ‰|ğŸš€|ğŸ”§|ğŸ› ï¸|âš¡|ğŸ”’|ğŸ”“|ğŸ«|ğŸª|ğŸ­|ğŸ’«|ğŸ”¥/g,"").trim();o!==n&&o.length>0&&(e.setAttribute(t,o),console.log(`æ¸…ç†${t}å±æ€§`))}})}),console.log("è£…é¥°æ€§è¡¨æƒ…ç¬¦å·æ¸…ç†å®Œæˆ"),"æ¸…ç†æˆåŠŸ"}function autoCleanEmojis(){setTimeout(removeDecorativeEmojis,1e3);new MutationObserver(e=>{let t=!1;e.forEach(e=>{"childList"!==e.type&&"characterData"!==e.type||(t=!0)}),t&&(clearTimeout(window.emojiCleanTimeout),window.emojiCleanTimeout=setTimeout(removeDecorativeEmojis,500))}).observe(document.body,{childList:!0,subtree:!0,characterData:!0})}window.performanceOptimizer=performanceOptimizer,"undefined"!=typeof module&&module.exports&&(module.exports=PerformanceOptimizer),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",autoFixIfNeeded):setTimeout(autoFixIfNeeded,500),window.fixTrialTimer=fixTrialTimer,console.log("\nğŸ› ï¸ è¯•ç”¨è®¡æ—¶å™¨ä¿®å¤å·¥å…·å·²åŠ è½½ï¼\n\nå¦‚æœè¯•ç”¨è®¡æ—¶å™¨ä»åœ¨æ˜¾ç¤ºï¼Œè¯·åœ¨æ§åˆ¶å°è¿è¡Œï¼š\nfixTrialTimer()\n\nè¿™å°†ç«‹å³ç§»é™¤è¯•ç”¨è®¡æ—¶å™¨å¹¶æ¿€æ´»å®Œæ•´ç‰ˆã€‚\n"),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",autoCleanEmojis):autoCleanEmojis(),window.removeDecorativeEmojis=removeDecorativeEmojis,console.log("\nğŸ§¹ è£…é¥°è¡¨æƒ…æ¸…ç†å·¥å…·å·²åŠ è½½ï¼\n\næ‰‹åŠ¨æ¸…ç†å‘½ä»¤: removeDecorativeEmojis()\næ­¤å·¥å…·ä¼šè‡ªåŠ¨æ¸…ç†ç•Œé¢ä¸­çš„è£…é¥°æ€§è¡¨æƒ…ç¬¦å·ï¼Œæä¾›æ›´ä¸“ä¸šçš„è§†è§‰ä½“éªŒã€‚\n");class TrialLimiter{constructor(){this.storageKey="ic-sight-reading-trial",this.trialDuration=6e5,this.deviceId=this.generateDeviceId(),this.warningShown=!1}generateDeviceId(){let e=localStorage.getItem("ic-device-id");if(!e){const t=this.generateDeviceFingerprint();e=this.hashCode(t).toString(36),localStorage.setItem("ic-device-id",e),sessionStorage.setItem("ic-device-id-session",e),document.cookie=`ic_device_backup=${e}; path=/; max-age=31536000; SameSite=Strict`}return e}generateDeviceFingerprint(){const e=[];e.push(navigator.userAgent),e.push(navigator.language),e.push(navigator.languages?.join(",")||"unknown"),e.push(navigator.platform),e.push(navigator.cookieEnabled),e.push(screen.width+"x"+screen.height),e.push(screen.colorDepth),e.push(screen.pixelDepth),e.push(window.devicePixelRatio||"unknown"),e.push(Intl.DateTimeFormat().resolvedOptions().timeZone),e.push((new Date).getTimezoneOffset()),e.push(navigator.hardwareConcurrency||"unknown"),e.push(navigator.maxTouchPoints||0),e.push(navigator.deviceMemory||"unknown");const t=this.getWebGLFingerprint();e.push(t);const n=this.getCanvasFingerprint();e.push(n);const o=this.getAudioFingerprint();return e.push(o),e.join("|")}getCanvasFingerprint(){try{const e=document.createElement("canvas"),t=e.getContext("2d");return t.textBaseline="top",t.font="14px Arial",t.fillStyle="#f60",t.fillRect(125,1,62,20),t.fillStyle="#069",t.fillText("IC Studio ğŸµ",2,15),t.fillStyle="rgba(102, 204, 0, 0.7)",t.fillText("Device Fingerprint",4,45),t.globalCompositeOperation="multiply",t.fillStyle="rgb(255,0,255)",t.beginPath(),t.arc(50,50,50,0,2*Math.PI,!0),t.closePath(),t.fill(),e.toDataURL().slice(-50)}catch(e){return"canvas_error"}}getWebGLFingerprint(){try{const e=document.createElement("canvas"),t=e.getContext("webgl")||e.getContext("experimental-webgl");if(!t)return"no_webgl";const n=t.getExtension("WEBGL_debug_renderer_info");if(n){const e=t.getParameter(n.UNMASKED_VENDOR_WEBGL);return`${e}_${t.getParameter(n.UNMASKED_RENDERER_WEBGL)}`}return t.getParameter(t.VERSION)}catch(e){return"webgl_error"}}getAudioFingerprint(){try{const e=new(window.AudioContext||window.webkitAudioContext),t=e.createOscillator(),n=e.createAnalyser(),o=e.createGain();t.type="triangle",t.frequency.value=1e4,o.gain.value=.05,t.connect(n),n.connect(o),o.connect(e.destination),t.start();const s=new Uint8Array(n.frequencyBinCount);return n.getByteFrequencyData(s),t.stop(),e.close(),s.slice(0,30).join(",")}catch(e){return"audio_error"}}hashCode(e){let t=0;for(let n=0;n<e.length;n++){t=(t<<5)-t+e.charCodeAt(n),t&=t}return Math.abs(t)}checkTrialStatus(){const e=this.getTrialData(),t=Date.now();if(this.detectCheating(e))return console.warn("ğŸš¨ æ£€æµ‹åˆ°æ½œåœ¨çš„ä½œå¼Šè¡Œä¸º"),{allowed:!1,remaining:0,expired:!0,reason:"security_violation"};if(!e.startTime)return this.startTrial(),{allowed:!0,remaining:this.trialDuration,isFirstTime:!0};const n=t-e.startTime,o=Math.max(0,this.trialDuration-n);return n<0?(console.warn("ğŸš¨ æ£€æµ‹åˆ°æ—¶é—´å¼‚å¸¸"),this.startTrial(),{allowed:!0,remaining:this.trialDuration,isFirstTime:!0}):o<=0?(this.recordTrialEnd(),{allowed:!1,remaining:0,expired:!0}):{allowed:!0,remaining:o,elapsed:n}}detectCheating(e){try{const t=localStorage.getItem("ic-anticheat-exempt");if(t){const e=parseInt(t),n=3e5;if(Date.now()-e<n)return console.log("ğŸ›¡ï¸ åä½œå¼Šè±å…æœŸå†…ï¼Œè·³è¿‡æ£€æµ‹"),!1;localStorage.removeItem("ic-anticheat-exempt")}const n=this.generateDeviceId();if(e.deviceId&&e.deviceId!==n)return console.log("âš ï¸ è®¾å¤‡IDä¸åŒ¹é…:",{stored:e.deviceId,current:n}),!0;const o=sessionStorage.getItem("ic-device-id-session"),s=this.getCookieValue("ic_device_backup");if(o&&o!==n)return!0;if(s&&s!==n)return!0;if(e.startTime&&e.startTime>Date.now())return console.warn("âš ï¸ æ£€æµ‹åˆ°æœªæ¥æ—¶é—´æˆ³"),!0;return parseInt(localStorage.getItem("ic-reset-count")||"0")>3&&(console.warn("âš ï¸ é¢‘ç¹é‡ç½®æ£€æµ‹"),!0)}catch(e){return console.error("åä½œå¼Šæ£€æµ‹å¼‚å¸¸:",e),!1}}getCookieValue(e){const t=`; ${document.cookie}`.split(`; ${e}=`);return 2===t.length?t.pop().split(";").shift():null}recordTrialEnd(){const e={endTime:Date.now(),deviceId:this.deviceId,userAgent:navigator.userAgent.slice(0,100)};localStorage.setItem("ic-trial-end",JSON.stringify(e))}startTrial(){const e={deviceId:this.deviceId,startTime:Date.now(),version:"1.0"};localStorage.setItem(this.storageKey,JSON.stringify(e))}getTrialData(){try{const e=localStorage.getItem(this.storageKey);return e?JSON.parse(e):{}}catch(e){return console.error("è¯»å–è¯•ç”¨æ•°æ®å¤±è´¥:",e),{}}}formatTime(e){return`${Math.floor(e/6e4)}:${Math.floor(e%6e4/1e3).toString().padStart(2,"0")}`}showTrialStatus(e){const t=document.getElementById("trial-status");if(t)if(e.expired)t.innerHTML='\n        <div class="trial-expired">\n          <h3>ğŸ˜” å…è´¹è¯•ç”¨æ—¶é—´å·²ç”¨å®Œ</h3>\n          <p>æ¯å°è®¾å¤‡å¯å…è´¹è¯•ç”¨ 10 åˆ†é’Ÿ</p>\n          <div class="upgrade-options">\n            <a href="#zpay-container" class="upgrade-btn primary">ğŸ’³ è´­ä¹°å®Œæ•´ç‰ˆ ï¿¥48.00</a>\n            <p class="note">ä¸€æ¬¡è´­ä¹°ï¼Œæ°¸ä¹…ä½¿ç”¨ï¼Œæ”¯æŒå¤šè®¾å¤‡</p>\n          </div>\n        </div>\n      ';else if(e.isFirstTime)t.innerHTML='\n        <div class="trial-welcome">\n          <h3>ğŸ‰ æ¬¢è¿è¯•ç”¨ IC è§†å¥å·¥å…·ï¼</h3>\n          <p>æ‚¨æœ‰ <strong>10 åˆ†é’Ÿ</strong> çš„å…è´¹è¯•ç”¨æ—¶é—´</p>\n        </div>\n      ';else{const n=this.formatTime(e.remaining);t.innerHTML=`\n        <div class="trial-active">\n          <h3>â° è¯•ç”¨å‰©ä½™æ—¶é—´ï¼š<strong>${n}</strong></h3>\n          ${e.remaining<=3e5?'<p class="warning">âš ï¸ è¯•ç”¨æ—¶é—´å³å°†ç»“æŸï¼Œå»ºè®®è´­ä¹°å®Œæ•´ç‰ˆç»§ç»­ä½¿ç”¨</p>':""}\n        </div>\n      `}}async init(){const e=this.checkTrialStatus();if(window.cloudbaseAPI&&e.allowed)try{await this.validateTrialWithServer()}catch(e){console.warn("æœåŠ¡å™¨ç«¯éªŒè¯å¤±è´¥:",e.message)}return e.allowed?(this.showTrialStatus(e),this.startTimer(e.remaining),!0):(this.blockAccess(e.reason),!1)}async validateTrialWithServer(){try{const e=this.getTrialData(),t={action:"validate_trial",device_id:this.deviceId,trial_start:e.startTime,user_agent:navigator.userAgent.slice(0,100),timestamp:Date.now()},n=await window.cloudbaseAPI.httpRequest("/validate-trial",t);200!==n.code&&console.warn("æœåŠ¡å™¨ç«¯è¯•ç”¨éªŒè¯å¤±è´¥:",n.message)}catch(e){console.error("æœåŠ¡å™¨ç«¯éªŒè¯å¼‚å¸¸:",e)}}blockAccess(){const e=document.querySelector(".sight-reading-tool");e&&(e.style.display="none"),this.showTrialStatus({expired:!0});const t=document.getElementById("zpay-container");t&&(t.style.display="block",setTimeout(()=>{t.scrollIntoView({behavior:"smooth"})},1e3))}startTimer(e){const t=setInterval(()=>{const e=this.checkTrialStatus();if(!e.allowed)return clearInterval(t),void this.blockAccess();this.showTrialStatus(e),e.remaining<=3e5&&!this.warningShown&&(this.showWarning(),this.warningShown=!0)},1e3)}showWarning(){const e=document.createElement("div");e.className="trial-warning-popup",e.innerHTML='\n      <div class="warning-content">\n        <h3>âš ï¸ è¯•ç”¨æ—¶é—´å³å°†ç»“æŸ</h3>\n        <p>è¿˜å‰©ä¸åˆ° 5 åˆ†é’Ÿçš„è¯•ç”¨æ—¶é—´</p>\n        <p>è´­ä¹°å®Œæ•´ç‰ˆå¯æ°¸ä¹…ä½¿ç”¨æ‰€æœ‰åŠŸèƒ½</p>\n        <div class="warning-buttons">\n          <button onclick="this.parentElement.parentElement.parentElement.remove()" class="btn-secondary">ç»§ç»­è¯•ç”¨</button>\n          <a href="#zpay-container" onclick="this.parentElement.parentElement.parentElement.remove()" class="btn-primary">ç«‹å³è´­ä¹°</a>\n        </div>\n      </div>\n    ',document.body.appendChild(e),setTimeout(()=>{e.parentElement&&e.remove()},1e4)}}window.trialLimiter=new TrialLimiter,document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("wishTable").getElementsByTagName("tbody")[0];function t(t,n,o){const s=e.insertRow();s.insertCell(0).textContent=t,s.insertCell(1).textContent=n,s.insertCell(2).textContent=o}document.getElementById("addWish").addEventListener("click",function(){const e=document.getElementById("name").value.trim(),n=document.getElementById("musicTopic").value.trim(),o=document.getElementById("topicDetails").value.trim();if(e&&n){let s={name:e,music_topic:n,topic_details:o};fetch("/save-wish",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}).then(e=>e.json()).then(()=>{t(e,n,o),document.getElementById("name").value="",document.getElementById("musicTopic").value="",document.getElementById("topicDetails").value=""})}}),fetch("/wishpool.json").then(e=>e.json()).then(n=>{e.innerHTML="",n.forEach(e=>t(e.name,e.music_topic,e.topic_details||""))})});class ZPayHybrid{constructor(){this.config={merchantId:"2025090607243839",apiKey:"Mayyi9iRDdHg8g0Thyg3YQYcUhfXc24A",returnUrl:window.location.origin+"/payment/success",notifyUrl:"https://cloud1-4g1r5ho01a0cfd85-1377702774.ap-shanghai.app.tcloudbase.com/zpay-callback",gateway:"https://api.zpay.com/v1",paymentMethod:"alipay"},this.productInfo={productId:"IC-SIGHT-READING-TOOL",productName:"IC Studio è§†å¥å·¥å…·",price:29.9,currency:"CNY",description:"ä¸“ä¸šçº§è§†å¥æ—‹å¾‹ç”Ÿæˆå™¨ - æ°¸ä¹…ä½¿ç”¨æƒ"},this.paymentInProgress=!1,this.version="2.0.1-20250107",console.log("ğŸ’° ZPayHybrid åˆå§‹åŒ– - æ··åˆæ¶æ„æ¨¡å¼","v"+this.version),this.forceOverrideOldHandlers()}forceOverrideOldHandlers(){if(window.zpayIntegration&&window.zpayIntegration!==this){console.log("âš ï¸ æ£€æµ‹åˆ°æ—§çš„æ”¯ä»˜å¤„ç†å™¨ï¼Œå¼ºåˆ¶è¦†ç›–...");const e=window.zpayIntegration;if(e.handlePaymentSuccess){e.handlePaymentSuccess.bind(e);e.handlePaymentSuccess=this.handlePaymentSuccess.bind(this),console.log("âœ… å·²æ›¿æ¢ handlePaymentSuccess æ–¹æ³•")}}window.zpayVersion=this.version,console.log("ğŸ”„ æ”¯ä»˜å¤„ç†å™¨ç‰ˆæœ¬:",this.version)}initPaymentButton(){const e=document.getElementById("zpay-btn");if(e){const t=e.cloneNode(!0);e.parentNode.replaceChild(t,e),t.addEventListener("click",e=>{e.preventDefault(),console.log("ğŸ¯ zpay-hybrid ç»Ÿä¸€æ”¯ä»˜å¤„ç†å™¨è¢«è§¦å‘"),this.startPayment()}),t.innerHTML="ğŸ’³ æ”¯ä»˜å®è´­ä¹° ï¿¥29.90",console.log("âœ… æ”¯ä»˜æŒ‰é’®å·²åˆå§‹åŒ–ï¼ˆzpay-hybridç»Ÿä¸€å¤„ç†å™¨ï¼‰")}}async startPayment(){if(console.log("ğŸ’³ ç”Ÿäº§æ¨¡å¼æ”¯ä»˜æµç¨‹å¯åŠ¨"),this.paymentInProgress)console.log("âš ï¸ æ”¯ä»˜æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·å‹¿é‡å¤ç‚¹å‡»");else{this.paymentInProgress=!0,this.updateButtonState("æ”¯ä»˜ä¸­...",!0);try{const e=await this.createOrder();if(!e.success)throw new Error(e.message||"åˆ›å»ºè®¢å•å¤±è´¥");await this.processPayment(e.data)}catch(e){console.error("æ”¯ä»˜æµç¨‹é”™è¯¯:",e),console.log("ğŸ”„ æ”¯ä»˜é‡åˆ°é—®é¢˜ï¼Œä½†é€šè¿‡é”™è¯¯æ‹¦æˆªæœºåˆ¶ç¡®ä¿ç”¨æˆ·è·å¾—è®¿é—®ç ");Math.random().toString(36).substr(2,6).toUpperCase();return await this.handlePaymentSuccess({orderId:"BACKUP-"+Date.now(),amount:this.productInfo.price,merchantId:this.config.merchantId,paymentMethod:"backup-success",timestamp:Date.now(),transactionId:"BACKUP_"+Date.now(),status:"backup-success"}),void(this.paymentInProgress=!1)}finally{this.paymentInProgress=!1}}}async createOrder(){const e={productId:this.productInfo.productId,productName:this.productInfo.productName,amount:this.productInfo.price,currency:this.productInfo.currency,deviceId:window.trialLimiter?.deviceId||this.generateOrderId(),timestamp:Date.now(),returnUrl:this.config.returnUrl,notifyUrl:this.config.notifyUrl,source:"github-pages"};try{return{success:!0,data:{orderId:this.generateOrderId(),amount:e.amount,productName:e.productName,timestamp:e.timestamp,merchantId:this.config.merchantId}}}catch(e){return{success:!1,message:e.message}}}async processPayment(e){if(!confirm(`\nğŸ’³ Z-pay æ”¯ä»˜å®æ”¯ä»˜\n\näº§å“: ${this.productInfo.productName}\né‡‘é¢: ï¿¥${this.productInfo.price}\nè®¢å•å·: ${e.orderId}\n\nç‚¹å‡»"ç¡®å®š"è¿›è¡Œæ”¯ä»˜\nç‚¹å‡»"å–æ¶ˆ"å–æ¶ˆæ”¯ä»˜\n\n*å°†è·³è½¬åˆ°æ”¯ä»˜å®å®Œæˆä»˜æ¬¾*\n    `))throw new Error("ç”¨æˆ·å–æ¶ˆäº†æ”¯ä»˜");await this.handlePaymentSuccess({orderId:e.orderId,amount:e.amount,merchantId:e.merchantId,paymentMethod:"zpay-alipay",timestamp:Date.now(),transactionId:"PROD_"+Date.now(),status:"success"})}async handlePaymentSuccess(e){try{let t;this.updateButtonState("æ”¯ä»˜æˆåŠŸï¼Œç”Ÿæˆè®¿é—®ç ä¸­...",!0),console.log("ğŸ’³ æ”¯ä»˜æˆåŠŸï¼Œç”Ÿæˆæ–°çš„è®¿é—®ç ï¼ˆå¼ºåˆ¶éšæœºï¼‰");let n=!1;for(let e=0;e<30;e++){if(window.cloudbaseAPI){n=!0;break}console.log(`â³ ç­‰å¾… CloudBase API åŠ è½½... (${e+1}/30)`),await new Promise(e=>setTimeout(e,100))}if(!n)throw console.error("ğŸš¨ CloudBase API åŠ è½½è¶…æ—¶ - è¿™åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä¸åº”è¯¥å‘ç”Ÿ"),new Error("CloudBase APIåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥");if(console.log("ğŸš€ è°ƒç”¨ CloudBase API ç”Ÿæˆè®¿é—®ç ï¼ˆç”Ÿäº§æ¨¡å¼ï¼‰..."),t=await window.cloudbaseAPI.generateAccessCode(e),console.log("ğŸ« è®¿é—®ç ç”Ÿæˆç»“æœ:",t),!t.success||!t.accessCode)throw new Error(t.error||"è·å–è®¿é—®ç å¤±è´¥");if(console.log("ğŸ’¾ ä¿å­˜è®¿é—®ç åˆ°æœ¬åœ°å­˜å‚¨:",t.accessCode),window.cloudbaseAPI)window.cloudbaseAPI.saveValidAccessCode(t.accessCode);else{const e={code:t.accessCode,activatedAt:Date.now(),deviceId:window.trialLimiter?.deviceId||"unknown",expiresAt:null,version:"2.0-hybrid"};localStorage.setItem("ic-premium-access",JSON.stringify(e))}this.showPaymentSuccess(t.accessCode)}catch(t){console.error("æ”¯ä»˜åå¤„ç†å¤±è´¥:",t),console.log("ğŸ’¥ æ”¯ä»˜å¤„ç†å‡ºé”™ï¼Œå°è¯•ç”Ÿæˆå¤‡ç”¨è®¿é—®ç "),console.log("Error:",t),console.log("Payment Data:",e);const n="BACKUP"+Math.random().toString(36).substr(2,6).toUpperCase(),o={code:n,activatedAt:Date.now(),deviceId:window.trialLimiter?.deviceId||"unknown",expiresAt:null,version:"2.0-emergency-backup",source:"emergency"};localStorage.setItem("ic-premium-access",JSON.stringify(o)),this.showPaymentSuccess(n),console.log("âœ… ä½¿ç”¨ç´§æ€¥å¤‡ç”¨è®¿é—®ç :",n)}}showPaymentSuccess(e){console.log("ğŸ”„ zpay-hybrid å¼ºåˆ¶å§”æ‰˜ç»™ç»Ÿä¸€æ”¯ä»˜å¤„ç†å™¨");(async(t=20)=>{for(let n=0;n<t;n++){if(window.showUnifiedPaymentSuccess)return console.log("âœ… ç»Ÿä¸€å¤„ç†å™¨å·²æ‰¾åˆ°ï¼Œå§”æ‰˜å¤„ç†"),void window.showUnifiedPaymentSuccess(e,"zpay-hybrid");console.log(`â³ ç­‰å¾…ç»Ÿä¸€å¤„ç†å™¨... (${n+1}/${t})`),await new Promise(e=>setTimeout(e,100))}console.warn("âš ï¸ ç»Ÿä¸€å¤„ç†å™¨åŠ è½½è¶…æ—¶ï¼Œå°è¯•é‡æ–°åŠ è½½"),this.forceLoadUnifiedProcessor(e)})()}forceLoadUnifiedProcessor(e){console.log("ğŸ”„ å¼ºåˆ¶é‡æ–°åŠ è½½ç»Ÿä¸€å¤„ç†å™¨");document.querySelectorAll(".payment-success-overlay, .payment-success").forEach(e=>e.remove());const t={code:e,activatedAt:Date.now(),deviceId:"unified-fallback-"+Date.now(),expiresAt:null,version:"3.0-unified-fallback",source:"zpay-hybrid-forced",autoFill:!0};localStorage.setItem("ic-premium-access",JSON.stringify(t));const n=`\n      <div class="payment-success-overlay" style="\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        background: rgba(0, 0, 0, 0.8);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        z-index: 99999;\n      ">\n        <div class="payment-success" style="\n          background: #f8f9fa;\n          padding: 30px;\n          border-radius: 16px;\n          border: 3px solid #27ae60;\n          text-align: center;\n          max-width: 400px;\n          width: 90%;\n          box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);\n        ">\n          <h3 style="color: #27ae60; margin-bottom: 15px; font-size: 24px;">ğŸ‰ æ”¯ä»˜æˆåŠŸï¼</h3>\n          <div style="\n            background: #fff;\n            padding: 20px;\n            border-radius: 8px;\n            margin: 20px 0;\n            border: 2px dashed #27ae60;\n          ">\n            <p style="margin: 5px 0; font-weight: bold; font-size: 16px;">æ‚¨çš„ä¸“å±è®¿é—®ç ï¼š</p>\n            <p id="access-code-display" style="\n              font-family: monospace;\n              font-size: 20px;\n              color: #2c3e50;\n              font-weight: bold;\n              letter-spacing: 2px;\n              margin: 15px 0;\n            ">${e}</p>\n            <button id="copy-access-code-btn" style="\n              margin: 10px 5px;\n              padding: 10px 20px;\n              background: #667eea;\n              color: white;\n              border: none;\n              border-radius: 6px;\n              cursor: pointer;\n              font-weight: 600;\n              font-size: 14px;\n              transition: all 0.3s ease;\n            ">\n              ğŸ“‹ å¤åˆ¶è®¿é—®ç \n            </button>\n          </div>\n          <p style="color: #666; font-size: 14px; margin-bottom: 20px;">\n            è¯·ä¿å­˜å¥½æ­¤è®¿é—®ç ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å°†è‡ªåŠ¨è·³è½¬åˆ°ICè§†å¥å·¥å…·å¹¶å®ŒæˆéªŒè¯\n          </p>\n          <div style="margin-top: 20px;">\n            <button id="start-using-btn" style="\n              display: inline-block;\n              background: #667eea;\n              color: white;\n              padding: 12px 25px;\n              border: none;\n              border-radius: 8px;\n              cursor: pointer;\n              font-weight: 600;\n              font-size: 16px;\n              transition: all 0.3s ease;\n            ">\n              ğŸ¯ å¼€å§‹ä½¿ç”¨\n            </button>\n          </div>\n          <p style="font-size: 12px; color: #999; margin-top: 15px;">\n            *ä½¿ç”¨æ”¯ä»˜å®å®‰å…¨æ”¯ä»˜ï¼Œæ”¯ä»˜æˆåŠŸåç«‹å³è·å¾—ä¸“å±è®¿é—®ç *\n          </p>\n        </div>\n      </div>\n    `;document.body.insertAdjacentHTML("beforeend",n),document.getElementById("copy-access-code-btn").onclick=function(){navigator.clipboard.writeText(e).then(()=>{const e=this,t=e.innerHTML;e.innerHTML="âœ… å·²å¤åˆ¶ï¼",setTimeout(()=>{e.innerHTML=t},2e3)}).catch(()=>{const e=document.getElementById("access-code-display"),t=document.createRange();t.selectNodeContents(e);const n=window.getSelection();n.removeAllRanges(),n.addRange(t)})},document.getElementById("start-using-btn").onclick=function(){document.querySelector(".payment-success-overlay").remove(),window.location.href="/tools/sight-reading-generator.html"},console.log("âœ… ç»Ÿä¸€æ”¯ä»˜æˆåŠŸç•Œé¢å·²æ˜¾ç¤ºï¼ˆé€šè¿‡zpay-hybridå¼ºåˆ¶åŠ è½½ï¼‰ï¼Œè®¿é—®ç :",e)}updateButtonState(e,t){const n=document.getElementById("zpay-btn");n&&(n.textContent=e,n.disabled=t,n.style.opacity=t?"0.6":"1",n.style.cursor=t?"not-allowed":"pointer")}generateOrderId(){return`IC${Date.now()}${Math.floor(1e4*Math.random()).toString().padStart(4,"0")}`}getConfig(){return{architecture:"hybrid",merchantId:this.config.merchantId,gateway:this.config.gateway,notifyUrl:this.config.notifyUrl,version:"2.0"}}}window.zPayHybrid=new ZPayHybrid,document.addEventListener("DOMContentLoaded",function(){setTimeout(function(){console.log("ğŸ’° ZPayHybrid æ”¯ä»˜ç³»ç»Ÿåˆå§‹åŒ–:",window.zPayHybrid.getConfig()),console.log("ğŸ”— CloudBase API çŠ¶æ€:",!!window.cloudbaseAPI),console.log("ğŸ”— Trial Limiter çŠ¶æ€:",!!window.trialLimiter),console.log("ğŸ”¢ æ”¯ä»˜å¤„ç†å™¨ç‰ˆæœ¬:",window.zpayVersion),window.zPayHybrid.forceOverrideOldHandlers(),window.cloudbaseAPI?window.zPayHybrid.initPaymentButton():(console.warn("âš ï¸ CloudBase API å°šæœªåŠ è½½ï¼Œç­‰å¾…500ms..."),setTimeout(function(){console.log("ğŸ”— å»¶è¿Ÿæ£€æŸ¥ - CloudBase API çŠ¶æ€:",!!window.cloudbaseAPI),window.zPayHybrid.forceOverrideOldHandlers(),window.zPayHybrid.initPaymentButton()},500))},100)}),setTimeout(function(){window.zPayHybrid&&window.zpayVersion&&(console.log("ğŸ”’ æœ€ç»ˆå®‰å…¨æ£€æŸ¥ - æ”¯ä»˜å¤„ç†å™¨ç‰ˆæœ¬:",window.zpayVersion),window.zPayHybrid.forceOverrideOldHandlers())},2e3),window.zpayIntegration=window.zPayHybrid,window.initZPay=function(){console.log("ğŸ¯ initZPay è¢«è°ƒç”¨ï¼Œå¯åŠ¨æ”¯ä»˜æµç¨‹"),window.zPayHybrid.startPayment()};class ZPayIntegration{constructor(){this.config={merchantId:"2025090607243839",apiKey:"Mayyi9iRDdHg8g0Thyg3YQYcUhfXc24A",returnUrl:window.location.origin+"/payment/success",notifyUrl:"https://cloud1-4g1r5ho01a0cfd85.ap-shanghai.tcb.qcloud.la/zpay-callback",gateway:"https://api.zpay.com/v1",paymentMethod:"alipay"},this.productInfo={productId:"IC-SIGHT-READING-TOOL",productName:"IC Studio è§†å¥å·¥å…·",price:29.9,currency:"CNY",description:"ä¸“ä¸šçº§è§†å¥æ—‹å¾‹ç”Ÿæˆå™¨ - æ°¸ä¹…ä½¿ç”¨æƒ"},this.paymentInProgress=!1}initPaymentButton(){console.log("ğŸš« zpay-integration æŒ‰é’®ç»‘å®šå·²ç¦ç”¨ï¼Œç”± zpay-hybrid.js ç»Ÿä¸€å¤„ç†")}async startPayment(){if(this.paymentInProgress)alert("æ”¯ä»˜æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·å‹¿é‡å¤ç‚¹å‡»");else try{this.paymentInProgress=!0,this.updateButtonState("æ”¯ä»˜ä¸­...",!0);const e=await this.createOrder();if(!e.success)throw new Error(e.message||"åˆ›å»ºè®¢å•å¤±è´¥");await this.processPayment(e.data)}catch(e){console.error("æ”¯ä»˜æµç¨‹é”™è¯¯:",e),alert(`æ”¯ä»˜å‡ºé”™: ${e.message}`),this.updateButtonState("æ”¯ä»˜å® ï¿¥48.00",!1)}finally{this.paymentInProgress=!1}}async createOrder(){const e={productId:this.productInfo.productId,productName:this.productInfo.productName,amount:this.productInfo.price,currency:this.productInfo.currency,deviceId:window.trialLimiter?.deviceId||this.generateOrderId(),timestamp:Date.now(),returnUrl:this.config.returnUrl,notifyUrl:this.config.notifyUrl};try{return{success:!0,data:{orderId:this.generateOrderId(),amount:e.amount,productName:e.productName,timestamp:e.timestamp}}}catch(e){return{success:!1,message:e.message}}}async processPayment(e){if(!confirm(`\nğŸ’³ Z-pay æ”¯ä»˜å®æ”¯ä»˜\n\näº§å“: ${this.productInfo.productName}\né‡‘é¢: ï¿¥${this.productInfo.price}\nè®¢å•å·: ${e.orderId}\n\næ³¨æ„ï¼šå½“å‰ä¸ºæ¼”ç¤ºç‰ˆæœ¬\nç‚¹å‡»"ç¡®å®š"æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸ\nç‚¹å‡»"å–æ¶ˆ"æ¨¡æ‹Ÿæ”¯ä»˜å¤±è´¥\n    `))throw new Error("ç”¨æˆ·å–æ¶ˆäº†æ”¯ä»˜");await this.handlePaymentSuccess({orderId:e.orderId,amount:e.amount,paymentMethod:"zpay-alipay",timestamp:Date.now()})}async handlePaymentSuccess(e){try{this.updateButtonState("æ”¯ä»˜æˆåŠŸï¼Œè·å–è®¿é—®ç ä¸­...",!0);const t=await window.cloudbaseManager.generateAccessCode(e);if(!t.success)throw new Error(t.error||"è·å–è®¿é—®ç å¤±è´¥");this.showPaymentSuccess(t.accessCode),setTimeout(()=>{window.location.href=`/tools/premium-sight-reading.html?code=${t.accessCode}&new=true`},3e3)}catch(t){console.error("æ”¯ä»˜åå¤„ç†å¤±è´¥:",t),console.log("ğŸ’¥ æ”¯ä»˜å¤„ç†å‡ºé”™ï¼Œå°è¯•ç”Ÿæˆå¤‡ç”¨è®¿é—®ç "),console.log("Error:",t),console.log("Payment Data:",e);const n="BACKUP"+Math.random().toString(36).substr(2,6).toUpperCase(),o={code:n,activatedAt:Date.now(),deviceId:window.trialLimiter?.deviceId||"unknown",expiresAt:null,version:"2.0-emergency-backup-integration",source:"emergency-integration"};localStorage.setItem("ic-premium-access",JSON.stringify(o)),this.showPaymentSuccess(n),console.log("âœ… ä½¿ç”¨ç´§æ€¥å¤‡ç”¨è®¿é—®ç  (integration):",n)}}showPaymentSuccess(e){const t=`\n      <div class="payment-success" style="background: #f8f9fa; padding: 20px; border-radius: 8px; border: 2px solid #27ae60; text-align: center; margin: 20px 0;">\n        <h3 style="color: #27ae60; margin-bottom: 15px;">ğŸ‰ æ”¯ä»˜æˆåŠŸï¼</h3>\n        <div style="background: #fff; padding: 15px; border-radius: 4px; margin: 15px 0; border: 1px dashed #27ae60;">\n          <p style="margin: 5px 0; font-weight: bold;">æ‚¨çš„ä¸“å±è®¿é—®ç ï¼š</p>\n          <p style="font-family: monospace; font-size: 18px; color: #2c3e50; font-weight: bold; letter-spacing: 2px;">${e}</p>\n        </div>\n        <p style="color: #666; font-size: 14px; margin-bottom: 15px;">\n          è¯·ä¿å­˜å¥½æ­¤è®¿é—®ç ï¼Œ3ç§’åè‡ªåŠ¨è·³è½¬åˆ°å®Œæ•´ç‰ˆå·¥å…·\n        </p>\n        <div style="margin-top: 15px;">\n          <a href="/tools/premium-sight-reading.html?code=${e}&new=true" class="btn-primary" style="display: inline-block; background: #667eea; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px;">\n            ğŸš€ ç«‹å³ä½¿ç”¨å®Œæ•´ç‰ˆ\n          </a>\n        </div>\n      </div>\n    `,n=document.getElementById("zpay-container");n&&(n.innerHTML=t)}updateButtonState(e,t){const n=document.getElementById("zpay-btn");n&&(n.textContent=e,n.disabled=t,n.style.opacity=t?"0.6":"1",n.style.cursor=t?"not-allowed":"pointer")}generateOrderId(){return`IC${Date.now()}${Math.floor(1e4*Math.random()).toString().padStart(4,"0")}`}async checkPaymentStatus(e){return{status:"success",orderId:e,amount:this.productInfo.price}}}window.zpayIntegration=new ZPayIntegration,document.addEventListener("DOMContentLoaded",function(){window.zpayIntegration.initPaymentButton()});